b4w={};b4w.module={};b4w.register=function(module_id,fun){var module=b4w.module;if(module[module_id])throw new Error('Module "'+module_id+'" already registered');module[module_id]=fun};b4w.require=function(module_id){var module=b4w.module;var require=b4w.require;var mod=module[module_id];if(!mod)throw new Error('Module "'+module_id+'" not found');if(!mod._compiled){mod._compiled={};mod(mod._compiled,require)}return mod._compiled};
b4w.module_check=function(module_id){if(b4w.module[module_id])return true;else return false};if(typeof module=="object"&&module.exports)GLOBAL.b4w={module:{}};
b4w.module["__version"]=function(exports,require){var VERSION="v14.05.22";var TYPE="RELEASE";var DATE="22.05.2014 11:19:39";exports.version=function(){return VERSION};exports.type=function(){return TYPE};exports.date=date;function date(){if(TYPE=="DEBUG"){var d=new Date;var day=d.getDate();day=day<10?"0"+String(day):String(day);var month=d.getMonth()+1;month=month<10?"0"+String(month):String(month);var year=String(d.getFullYear());var hour=d.getHours();hour=hour<10?"0"+String(hour):String(hour);var minute=
d.getMinutes();minute=minute<10?"0"+String(minute):String(minute);var second=d.getSeconds();second=second<10?"0"+String(second):String(second);var date_str=day+"."+month+"."+year+" "+hour+":"+minute+":"+second;return date_str}else return DATE}exports.timestamp=function(){var ts=date();ts=ts.split(" ").join("").split(":").join("").split(".").join("");ts="?t="+ts;return ts}};if(typeof module=="object"&&module.exports)b4w.module["__version"](exports);b4w.module["__config"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");exports.P_LOW=1;exports.P_HIGH=2;exports.P_ULTRA=3;exports.context={alpha:true,antialias:false,premultipliedAlpha:true};exports.context_save=m_util.clone_object_r(exports.context);exports.defaults={alpha_sort:true,alpha_sort_threshold:0.1,min_format_version:3,max_fps:1E4,console_verbose:false,do_not_load_resources:false,use_min50:false,fps_measurement_interval:1.5,fps_callback_interval:10,
background_color:[0,0,0,0],all_objs_selectable:false,glow:true,lod_transition_interval:50,resolution_factor:1,texture_min_filter:3,show_hud_debug_info:false,depth_textures:true,shadows:"DEPTH",anaglyph_use:false,dof:true,reflections:true,reflect_multiplier:0.5,refractions:true,ssao:true,god_rays:true,bloom:true,motion_blur:true,compositing:true,antialiasing:true,smaa:false,wireframe_debug:false,foam:true,parallax:true,dynamic_grass:true,procedural_fog:true,water_dynamic:true,shore_smoothing:true,
shore_distance:true,max_bones:53,use_dds:true,precision:"highp",deferred_rendering:true,quality:exports.P_HIGH};exports.defaults_save=m_util.clone_object_r(exports.defaults);exports.animation={framerate:24};exports.controls={cam_trans_base_speed:[5,5,5,5],cam_zoom_base_speed:0.1,mouse_wheel_notch_multiplier:1/120};exports.assets={max_requests:15,prevent_caching:true,min50_available:false,dds_available:false};exports.assets_save=m_util.clone_object_r(exports.assets);exports.paths={shaders_dir:"../../shaders/",
shaders_include_dir:"include/",shader_texts_module:"shader_texts",built_in_data_module:"built_in_data",smaa_search_texture_path:"../common/smaa_search_texture.png",smaa_area_texture_path:"../common/smaa_area_texture.png"};exports.physics={enabled:true,uranium_path:"../common/uranium.js"};exports.physics_save=m_util.clone_object_r(exports.physics);exports.scenes={offscreen_tex_size:1*1024,shadow_tex_size:2*1024,grass_tex_size:2*512};exports.scenes_save=m_util.clone_object_r(exports.scenes);exports.sfx=
{webaudio:true,mix_mode:false};exports.sfx_save=m_util.clone_object_r(exports.sfx);exports.apply_quality=function(){var cfg_def=exports.defaults;var cfg_def_save=exports.defaults_save;var cfg_scs=exports.scenes;var cfg_scs_save=exports.scenes_save;var cfg_ldr=exports.assets;var cfg_ldr_save=exports.assets_save;var cfg_phy=exports.physics;var cfg_phy_save=exports.physics_save;switch(cfg_def.quality){case exports.P_ULTRA:cfg_def.shadows=cfg_def_save.shadows;cfg_def.shore_smoothing=cfg_def_save.shore_smoothing;
cfg_def.glow=cfg_def_save.glow;cfg_def.ssao=cfg_def_save.ssao;cfg_def.dof=cfg_def_save.dof;cfg_def.god_rays=cfg_def_save.god_rays;cfg_def.bloom=cfg_def_save.bloom;cfg_def.reflections=cfg_def_save.reflections;cfg_def.reflect_multiplier=1;cfg_def.refractions=cfg_def_save.refractions;cfg_def.foam=cfg_def_save.foam;cfg_def.parallax=cfg_def_save.parallax;cfg_def.dynamic_grass=cfg_def_save.dynamic_grass;cfg_def.procedural_fog=cfg_def_save.procedural_fog;cfg_def.resolution_factor=2;cfg_scs.offscreen_tex_size=
2*1024;cfg_scs.shadow_tex_size=4*1024;cfg_scs.grass_tex_size=4*512;cfg_def.texture_min_filter=cfg_def_save.texture_min_filter;cfg_def.use_min50=cfg_def_save.use_min50;cfg_def.max_bones=cfg_def_save.max_bones;cfg_def.precision=cfg_def_save.precision;cfg_def.water_dynamic=cfg_def_save.water_dynamic;cfg_def.shore_distance=cfg_def_save.shore_distance;cfg_def.antialiasing=cfg_def_save.antialiasing;cfg_def.smaa=true;cfg_def.compositing=cfg_def_save.compositing;cfg_def.motion_blur=cfg_def_save.motion_blur;
break;case exports.P_HIGH:cfg_def.shadows=cfg_def_save.shadows;cfg_def.shore_smoothing=cfg_def_save.shore_smoothing;cfg_def.glow=cfg_def_save.glow;cfg_def.ssao=cfg_def_save.ssao;cfg_def.dof=cfg_def_save.dof;cfg_def.god_rays=cfg_def_save.god_rays;cfg_def.bloom=cfg_def_save.bloom;cfg_def.reflections=cfg_def_save.reflections;cfg_def.reflect_multiplier=cfg_def_save.reflect_multiplier;cfg_def.refractions=cfg_def_save.refractions;cfg_def.foam=cfg_def_save.foam;cfg_def.parallax=cfg_def_save.parallax;cfg_def.dynamic_grass=
cfg_def_save.dynamic_grass;cfg_def.procedural_fog=cfg_def_save.procedural_fog;cfg_def.resolution_factor=cfg_def_save.resolution_factor;cfg_scs.offscreen_tex_size=cfg_scs_save.offscreen_tex_size;cfg_scs.shadow_tex_size=cfg_scs_save.shadow_tex_size;cfg_scs.grass_tex_size=cfg_scs_save.grass_tex_size;cfg_def.texture_min_filter=cfg_def_save.texture_min_filter;cfg_def.use_min50=cfg_def_save.use_min50;cfg_def.max_bones=cfg_def_save.max_bones;cfg_def.precision=cfg_def_save.precision;cfg_def.water_dynamic=
cfg_def_save.water_dynamic;cfg_def.shore_distance=cfg_def_save.shore_distance;cfg_def.antialiasing=cfg_def_save.antialiasing;cfg_def.smaa=cfg_def_save.smaa;cfg_def.compositing=cfg_def_save.compositing;cfg_def.motion_blur=cfg_def_save.motion_blur;break;case exports.P_LOW:cfg_def.shadows="NONE";cfg_def.shore_smoothing=false;cfg_def.glow=false;cfg_def.ssao=false;cfg_def.dof=false;cfg_def.god_rays=false;cfg_def.bloom=false;cfg_def.reflections=false;cfg_def.reflect_multiplier=0.5;cfg_def.refractions=false;
cfg_def.foam=false;cfg_def.parallax=false;cfg_def.dynamic_grass=false;cfg_def.procedural_fog=false;cfg_def.resolution_factor=cfg_def_save.resolution_factor;cfg_scs.offscreen_tex_size=cfg_scs_save.offscreen_tex_size/2;cfg_scs.shadow_tex_size=cfg_scs_save.shadow_tex_size/2;cfg_scs.grass_tex_size=cfg_scs_save.grass_tex_size/2;cfg_def.texture_min_filter=2;cfg_def.use_min50=true;cfg_def.max_bones=cfg_def_save.max_bones;cfg_def.precision="mediump";cfg_def.water_dynamic=false;cfg_def.shore_distance=false;
cfg_def.antialiasing=false;cfg_def.smaa=false;cfg_def.compositing=false;cfg_def.motion_blur=false;break}};exports.set=set;function set(prop,value){switch(prop){case "all_objs_selectable":exports.defaults.all_objs_selectable=value;break;case "alpha":exports.context.alpha=value;break;case "context_antialias":exports.context.antialias=value;break;case "alpha_sort":exports.defaults.alpha_sort=value;break;case "alpha_sort_threshold":exports.defaults.alpha_sort_threshold=value;break;case "anaglyph_use":exports.defaults.anaglyph_use=
value;break;case "animation_framerate":exports.animation.framerate=value;break;case "antialiasing":exports.defaults.antialiasing=value;break;case "assets_dds_available":exports.assets.dds_available=value;break;case "assets_min50_available":exports.assets.min50_available=value;break;case "background_color":exports.defaults.background_color=value;break;case "built_in_module_name":exports.paths.built_in_data_module=value;break;case "console_verbose":exports.defaults.console_verbose=value;break;case "quality":exports.defaults.quality=
value;break;case "do_not_load_resources":exports.defaults.do_not_load_resources=value;break;case "deferred_rendering":exports.defaults.deferred_rendering=value;break;case "glow":exports.defaults.glow=value;break;case "show_hud_debug_info":exports.defaults.show_hud_debug_info=value;break;case "sfx_mix_mode":exports.sfx.mix_mode=value;break;case "physics_enabled":exports.physics.enabled=value;break;case "physics_uranium_path":exports.physics.uranium_path=value;break;case "smaa_search_texture_path":exports.paths.smaa_search_texture_path=
value;break;case "smaa_area_texture_path":exports.paths.smaa_area_texture_path=value;break;case "smaa":exports.defaults.smaa=value;break;case "resolution_factor":exports.defaults.resolution_factor=value;break;case "precision":exports.defaults.precision=value;break;case "wireframe_debug":exports.defaults.wireframe_debug=value;break;default:m_print.error("B4W config set - property unknown: "+prop);break}}exports.get=function(prop){switch(prop){case "all_objs_selectable":return exports.defaults.all_objs_selectable;
case "alpha":return exports.context.alpha;case "context_antialias":return exports.context.antialias;case "alpha_sort":return exports.defaults.alpha_sort;case "alpha_sort_threshold":return exports.defaults.alpha_sort_threshold;case "anaglyph_use":return exports.defaults.anaglyph_use;case "animation_framerate":return exports.animation.framerate;case "antialiasing":return exports.defaults.antialiasing;case "assets_dds_available":return exports.assets.dds_available;case "assets_min50_available":return exports.assets.min50_available;
case "background_color":return exports.defaults.background_color;case "built_in_module_name":return exports.paths.built_in_data_module;case "console_verbose":return exports.defaults.console_verbose;case "quality":return exports.defaults.quality;case "do_not_load_resources":return exports.defaults.do_not_load_resources;case "deferred_rendering":return exports.defaults.deferred_rendering;case "glow":return exports.defaults.glow;case "show_hud_debug_info":return exports.defaults.show_hud_debug_info;
case "sfx_mix_mode":return exports.sfx.mix_mode;case "physics_enabled":return exports.physics.enabled;case "physics_uranium_path":return exports.physics.uranium_path;case "smaa":return exports.defaults.smaa;case "smaa_search_texture_path":return exports.paths.smaa_search_texture_path;case "smaa_area_texture_path":return exports.paths.smaa_area_texture_path;case "resolution_factor":return exports.defaults.resolution_factor;case "precision":return exports.defaults.precision;case "wireframe_debug":return exports.defaults.wireframe_debug;
default:m_print.error("B4W config get - property unknown: "+prop);break}};exports.reset=function(){exports.context=m_util.clone_object_r(exports.context_save);exports.defaults=m_util.clone_object_r(exports.defaults_save);exports.assets=m_util.clone_object_r(exports.assets_save);exports.physics=m_util.clone_object_r(exports.physics_save);exports.scenes=m_util.clone_object_r(exports.scenes_save);exports.sfx=m_util.clone_object_r(exports.sfx_save)}};b4w.module["__boundings"]=function(exports,require){var m_util=require("__util");var m_tsr=require("__tsr");var m_vec3=require("vec3");var _bb_corners_cache=new Float32Array(3*8);exports.copy_bb=function(bb_from,bb_to){bb_to.min_x=bb_from.min_x;bb_to.max_x=bb_from.max_x;bb_to.min_y=bb_from.min_y;bb_to.max_y=bb_from.max_y;bb_to.min_z=bb_from.min_z;bb_to.max_z=bb_from.max_z};exports.big_bounding_box=function(){return{max_x:1E12,min_x:-1E12,max_y:1E12,min_y:-1E12,max_z:1E12,min_z:-1E12}};exports.zero_bounding_box=
function(dest){if(!dest)dest={};dest.max_x=0;dest.min_x=0;dest.max_y=0;dest.min_y=0;dest.max_z=0;dest.min_z=0;return dest};exports.expand_bounding_box=function(bb,bb_exp){var max_x=bb.max_x;var max_y=bb.max_y;var max_z=bb.max_z;var min_x=bb.min_x;var min_y=bb.min_y;var min_z=bb.min_z;bb.max_x=Math.max(bb_exp.max_x,max_x);bb.max_y=Math.max(bb_exp.max_y,max_y);bb.max_z=Math.max(bb_exp.max_z,max_z);bb.min_x=Math.min(bb_exp.min_x,min_x);bb.min_y=Math.min(bb_exp.min_y,min_y);bb.min_z=Math.min(bb_exp.min_z,
min_z);return bb};exports.bb_from_coords=bb_from_coords;function bb_from_coords(coords,bb){var max_x=coords[0];var max_y=coords[1];var max_z=coords[2];var min_x=coords[0];var min_y=coords[1];var min_z=coords[2];for(var i=3;i<coords.length;i+=3){var x=coords[i];var y=coords[i+1];var z=coords[i+2];max_x=Math.max(max_x,x);max_y=Math.max(max_y,y);max_z=Math.max(max_z,z);min_x=Math.min(min_x,x);min_y=Math.min(min_y,y);min_z=Math.min(min_z,z)}bb.max_x=max_x;bb.max_y=max_y;bb.max_z=max_z;bb.min_x=min_x;
bb.min_y=min_y;bb.min_z=min_z;return bb}exports.bounding_box_transform=function(bb,matrix,bb_new){if(!bb_new)var bb_new=exports.zero_bounding_box();var bb_corners=extract_bb_corners(bb,_bb_corners_cache);m_util.positions_multiply_matrix(bb_corners,matrix,bb_corners);return bb_from_coords(bb_corners,bb_new)};function extract_bb_corners(bb,dest){if(!dest)var dest=new Float32Array(3*8);var max_x=bb.max_x;var max_y=bb.max_y;var max_z=bb.max_z;var min_x=bb.min_x;var min_y=bb.min_y;var min_z=bb.min_z;dest[0]=
min_x;dest[1]=min_y;dest[2]=min_z;dest[3]=max_x;dest[4]=min_y;dest[5]=min_z;dest[6]=max_x;dest[7]=max_y;dest[8]=min_z;dest[9]=min_x;dest[10]=max_y;dest[11]=min_z;dest[12]=min_x;dest[13]=min_y;dest[14]=max_z;dest[15]=max_x;dest[16]=min_y;dest[17]=max_z;dest[18]=max_x;dest[19]=max_y;dest[20]=max_z;dest[21]=min_x;dest[22]=max_y;dest[23]=max_z;return dest}exports.shrink_bounding_box=function(bb,bb_shrink,bb_new){if(!bb_new)var bb_new=exports.zero_bounding_box();var s_min_x=bb_shrink.min_x;var s_max_x=
bb_shrink.max_x;var s_min_y=bb_shrink.min_y;var s_max_y=bb_shrink.max_y;var s_min_z=bb_shrink.min_z;var s_max_z=bb_shrink.max_z;if(s_min_x>=bb.max_x||(s_max_x<=bb.min_x||(s_min_y>=bb.max_y||(s_max_y<=bb.min_y||(s_min_z>=bb.max_z||s_max_z<=bb.min_z))))){bb_new.min_x=-0.1;bb_new.max_x=0.1;bb_new.min_y=-0.1;bb_new.max_y=0.1;bb_new.min_z=-0.2;bb_new.max_z=-0.1;return bb_new}bb_new.min_x=Math.max(bb.min_x,s_min_x);bb_new.max_x=Math.min(bb.max_x,s_max_x);bb_new.min_y=Math.max(bb.min_y,s_min_y);bb_new.max_y=
Math.min(bb.max_y,s_max_y);bb_new.min_z=Math.max(bb.min_z,s_min_z);bb_new.max_z=Math.min(bb.max_z,s_max_z);return bb_new};exports.stretch_bounding_box=function(bb,factor,bb_new){if(!bb_new)var bb_new=exports.zero_bounding_box();var size_x=bb.max_x-bb.min_x;var size_y=bb.max_y-bb.min_y;var size_z=bb.max_z-bb.min_z;bb_new.min_x=bb.min_x-0.5*(factor-1)*size_x;bb_new.max_x=bb.max_x+0.5*(factor-1)*size_x;bb_new.min_y=bb.min_y-0.5*(factor-1)*size_y;bb_new.max_y=bb.max_y+0.5*(factor-1)*size_y;bb_new.min_z=
bb.min_z-0.5*(factor-1)*size_z;bb_new.max_z=bb.max_z+0.5*(factor-1)*size_z;return bb_new};exports.bounding_sphere_transform=function(bs,matrix,bs_new){if(!bs_new)var bs_new=exports.zero_bounding_sphere();m_vec3.transformMat4(bs.center,matrix,bs_new.center);bs_new.radius=bs.radius*m_util.matrix_to_scale(matrix);return bs_new};exports.bounding_ellipsoid_transform=function(be,tsr,be_new){if(!be_new)var be_new=exports.zero_bounding_ellipsoid();m_tsr.transform_vec3(tsr,be.center,be_new.center);m_vec3.copy(be.axis_x,
be_new.axis_x);m_vec3.copy(be.axis_y,be_new.axis_y);m_vec3.copy(be.axis_z,be_new.axis_z);m_tsr.transform_dir_vec3(be_new.axis_x,tsr,be_new.axis_x);m_tsr.transform_dir_vec3(be_new.axis_y,tsr,be_new.axis_y);m_tsr.transform_dir_vec3(be_new.axis_z,tsr,be_new.axis_z);return be_new};exports.zero_bounding_sphere=function(){return{center:[0,0,0],radius:0}};exports.zero_bounding_ellipsoid=function(){return{axis_x:new Float32Array(3),axis_y:new Float32Array(3),axis_z:new Float32Array(3),center:[0,0,0]}};exports.big_bounding_sphere=
function(){return{center:[0,0,0],radius:1E12}};exports.expand_bounding_sphere=function(bs,bs_exp){var v=m_vec3.subtract(bs_exp.center,bs.center,m_vec3.create());if(m_vec3.length(v)==0)m_vec3.set(1,0,0,v);var vn=m_vec3.normalize(v,m_vec3.create());var e1p=m_vec3.scale(vn,bs.radius,m_vec3.create());m_vec3.add(e1p,bs.center,e1p);var e1n=m_vec3.scale(vn,-bs.radius,m_vec3.create());m_vec3.add(e1n,bs.center,e1n);var e2p=m_vec3.scale(vn,bs_exp.radius,m_vec3.create());m_vec3.add(e2p,bs_exp.center,e2p);var e2n=
m_vec3.scale(vn,-bs_exp.radius,m_vec3.create());m_vec3.add(e2n,bs_exp.center,e2n);var min_max=find_min_max_extent([e1p,e1n,e2p,e2n],vn);var min=min_max[0];var max=min_max[1];bs.center=m_vec3.scale(m_vec3.add(min,max,m_vec3.create()),0.5,m_vec3.create());bs.radius=m_vec3.length(m_vec3.subtract(max,min,m_vec3.create()))/2};function find_min_max_extent(exts,dir){var dir_n=m_vec3.normalize(dir,m_vec3.create());var min=exts[0];var max=exts[0];for(var i=1;i<exts.length;i++){var proj=m_vec3.dot(exts[i],
dir_n);if(proj<m_vec3.dot(min,dir_n))min=exts[i];if(proj>m_vec3.dot(max,dir_n))max=exts[i]}return[min,max]}exports.create_bounding_capsule=function(radius,bounding_box){var max_y=bounding_box.max_y;var min_y=bounding_box.min_y;var height=Math.max(0,max_y-min_y-2*radius);var bcap_local={radius:radius,height:height,center:[0,(max_y+min_y)/2,0]};return bcap_local};exports.create_bounding_cylinder=function(radius,bounding_box){var max_y=bounding_box.max_y;var min_y=bounding_box.min_y;var height=Math.max(0,
max_y-min_y);var bcyl_local={radius:radius,height:height,center:[0,(max_y+min_y)/2,0]};return bcyl_local};exports.create_bounding_cone=function(radius,bounding_box){var max_y=bounding_box.max_y;var min_y=bounding_box.min_y;var height=Math.max(0,max_y-min_y);var bcon_local={radius:radius,height:height,center:[0,(max_y+min_y)/2,0]};return bcon_local};exports.check_bb_intersection=function(bb1,bb2){if(bb1.min_x>bb2.max_x||bb1.max_x<bb2.min_x)return false;else if(bb1.min_y>bb2.max_y||bb1.max_y<bb2.min_y)return false;
else if(bb1.min_z>bb2.max_z||bb1.max_z<bb2.min_z)return false;else return true};exports.recalculate_mesh_boundings=function(mesh){var max_x=0,max_y=0,max_z=0,min_x=0,min_y=0,min_z=0;var srad=0;var crad=0;for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];if(submesh["position"].length){max_x=min_x=submesh["position"][0];max_y=min_y=submesh["position"][1];max_z=min_z=submesh["position"][2];break}}for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];
var positions=submesh["position"];for(var j=0;j<positions.length/3;j++){var x=positions[3*j];var y=positions[3*j+1];var z=positions[3*j+2];max_x=Math.max(x,max_x);max_y=Math.max(y,max_y);max_z=Math.max(z,max_z);min_x=Math.min(x,min_x);min_y=Math.min(y,min_y);min_z=Math.min(z,min_z);srad=Math.max(Math.sqrt(x*x+y*y+z*z),srad);crad=Math.max(Math.sqrt(x*x+z*z),crad)}}mesh["b4w_bounding_box"]["max_x"]=max_x;mesh["b4w_bounding_box"]["min_x"]=min_x;mesh["b4w_bounding_box"]["max_y"]=max_y;mesh["b4w_bounding_box"]["min_y"]=
min_y;mesh["b4w_bounding_box"]["max_z"]=max_z;mesh["b4w_bounding_box"]["min_z"]=min_z;mesh["b4w_bounding_sphere_radius"]=srad;mesh["b4w_bounding_cylinder_radius"]=crad}};b4w.module["__compat"]=function(exports,require){var m_cfg=require("__config");var m_ext=require("__extensions");var m_print=require("__print");var m_util=require("__util");var VECTORS_RESERVED=50;exports.set_hardware_defaults=function(gl){var cfg_def_save=m_cfg.defaults_save;var cfg_def=m_cfg.defaults;var depth_tex_available=Boolean(m_ext.get_depth_texture());if(check_user_agent("Firefox/28.0")&&(check_user_agent("Linux")||check_user_agent("Macintosh"))){m_print.warn("Firefox 28 detected, applying depth hack");
depth_tex_available=false}cfg_def.deferred_rendering=cfg_def_save.deferred_rendering=cfg_def_save.deferred_rendering&&depth_tex_available;cfg_def.foam=cfg_def_save.foam=cfg_def_save.foam&&depth_tex_available;cfg_def.parallax=cfg_def_save.parallax=cfg_def_save.parallax&&depth_tex_available;cfg_def.dynamic_grass=cfg_def_save.dynamic_grass=cfg_def_save.dynamic_grass&&depth_tex_available;cfg_def.procedural_fog=cfg_def_save.procedural_fog=cfg_def_save.procedural_fog&&depth_tex_available;cfg_def.water_dynamic=
cfg_def_save.water_dynamic=cfg_def_save.water_dynamic&&depth_tex_available;cfg_def.shore_smoothing=cfg_def_save.shore_smoothing=cfg_def_save.shore_smoothing&&depth_tex_available;cfg_def.shore_distance=cfg_def_save.shore_distance=cfg_def_save.shore_distance&&depth_tex_available;cfg_def.use_dds=cfg_def_save.use_dds=Boolean(m_ext.get_s3tc());var max_vert_uniforms=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS);var num_supported=m_util.clamp(max_vert_uniforms,251,Infinity);cfg_def.max_bones=cfg_def_save.max_bones=
m_util.trunc((num_supported-VECTORS_RESERVED)/4);cfg_def.max_bones_no_blending=cfg_def_save.max_bones_no_blending=m_util.trunc((num_supported-VECTORS_RESERVED)/2);var high=gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER,gl.HIGH_FLOAT);var medium=gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER,gl.MEDIUM_FLOAT);if(high.precision===0)cfg_def.precision=cfg_def_save.precision="mediump"};function check_user_agent(str){var user_agent=navigator.userAgent;if(user_agent.indexOf(str)>-1)return true;else return false}
};b4w.module["__constraints"]=function(exports,require){var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("vec3");var m_quat=require("quat");var m_mat3=require("mat3");var m_mat4=require("mat4");var CONS_TYPE_STIFF_OBJ=1;var CONS_TYPE_STIFF_BONE=2;var CONS_TYPE_TRACK_OBJ=3;var CONS_TYPE_TRACK_POINT=4;var CONS_TYPE_FOLLOW_OBJ=5;var CONS_TYPE_FOLLOW_POINT=6;var CONS_TYPE_STIFF_TRANS_OBJ=7;var CONS_TYPE_COPY_TRANS_OBJ=8;var CONS_TYPE_SEMI_STIFF_OBJ=9;var CONS_TYPE_SEMI_STIFF_CAM_OBJ=
10;var CONS_TYPE_CHILD_OF=11;var CONS_TYPE_SEMI_SOFT_CAM_OBJ=12;var CONS_TYPE_STIFF_TRANS_ROT_OBJ=13;exports.CONS_TYPE_STIFF_OBJ=CONS_TYPE_STIFF_OBJ;exports.CONS_TYPE_STIFF_BONE=CONS_TYPE_STIFF_BONE;exports.CONS_TYPE_TRACK_OBJ=CONS_TYPE_TRACK_OBJ;exports.CONS_TYPE_TRACK_POINT=CONS_TYPE_TRACK_POINT;exports.CONS_TYPE_FOLLOW_OBJ=CONS_TYPE_FOLLOW_OBJ;exports.CONS_TYPE_FOLLOW_POINT=CONS_TYPE_FOLLOW_POINT;exports.CONS_TYPE_STIFF_TRANS_OBJ=CONS_TYPE_STIFF_TRANS_OBJ;exports.CONS_TYPE_COPY_TRANS_OBJ=CONS_TYPE_COPY_TRANS_OBJ;
exports.CONS_TYPE_SEMI_STIFF_OBJ=CONS_TYPE_SEMI_STIFF_OBJ;exports.CONS_TYPE_SEMI_STIFF_CAM_OBJ=CONS_TYPE_SEMI_STIFF_CAM_OBJ;exports.CONS_TYPE_CHILD_OF=CONS_TYPE_CHILD_OF;exports.CONS_TYPE_SEMI_SOFT_CAM_OBJ=CONS_TYPE_SEMI_SOFT_CAM_OBJ;exports.CONS_TYPE_STIFF_TRANS_ROT_OBJ=CONS_TYPE_STIFF_TRANS_ROT_OBJ;var _vec3_tmp=new Float32Array(3);var _vec3_tmp_2=new Float32Array(3);var _vec3_tmp_3=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _quat4_tmp2=new Float32Array(4);
var _tsr8_tmp=new Float32Array(16);var _tsr8_tmp2=new Float32Array(16);var _mat3_tmp=new Float32Array(9);var _mat3_tmp2=new Float32Array(9);var _tsr8_tmp=new Float32Array(8);var CONS_ROTATE_LIMIT=9*Math.PI/10;exports.append_stiff_obj=function(obj,obj_parent,offset,rotation_offset,scale_offset){var cons=init_cons(CONS_TYPE_STIFF_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.scale_offset=scale_offset||1;cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):
null;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_bone=function(obj,armobj,bone_name,offset,rotation_offset){var cons=init_cons(CONS_TYPE_STIFF_BONE);cons.obj_parent=armobj;cons.bone_name=bone_name;cons.offset=new Float32Array(offset);cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_semi_stiff_obj=function(obj,obj_parent,offset,rotation_offset){var cons=init_cons(CONS_TYPE_SEMI_STIFF_OBJ);
var quat=obj._render.quat;var p_quat=obj_parent._render.quat;cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.parent_prev_rotation=new Float32Array(p_quat);if(rotation_offset){m_quat.copy(rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_semi_stiff_cam_obj=function(obj,obj_parent,offset,rotation_offset,clamp_left,clamp_right,clamp_up,clamp_down){var cons=init_cons(CONS_TYPE_SEMI_STIFF_CAM_OBJ);var quat=obj._render.quat;
var p_quat=obj_parent._render.quat;cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.parent_prev_rotation=new Float32Array(p_quat);cons.clamp_left=clamp_left;cons.clamp_right=clamp_right;cons.clamp_up=clamp_up;cons.clamp_down=clamp_down;if(rotation_offset){m_quat.copy(rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_semi_soft_cam_obj=function(obj,obj_parent,offset){var cons=init_cons(CONS_TYPE_SEMI_SOFT_CAM_OBJ);
var quat=obj._render.quat;var p_quat=obj_parent._render.quat;cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_trans_rot_obj=function(obj,obj_parent,offset,rotation_offset,scale_offset){var cons=init_cons(CONS_TYPE_STIFF_TRANS_ROT_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.scale_offset=scale_offset||1;cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;apply_cons(obj,
cons);update_cons(obj,cons,0)};function init_cons(type){var cons={};cons.type=type;return cons}function apply_cons(obj,cons){if(obj._constraint&&obj._constraint.obj_parent)remove_parent_descendant(obj._constraint.obj_parent,obj);if(cons.obj_parent)assign_parent_descendant(cons.obj_parent,obj);obj._constraint=cons}function assign_parent_descendant(obj_parent,obj){if(obj_parent._descends.indexOf(obj)==-1)obj_parent._descends.push(obj);else throw"Descendant object override is forbidden";}function remove_parent_descendant(obj_parent,
obj){var ind=obj_parent._descends.indexOf(obj);if(ind!=-1)obj_parent._descends.splice(ind,1);else throw"No descendant object";}exports.append_track_obj=function(obj,obj_parent){var cons=init_cons(CONS_TYPE_TRACK_OBJ);cons.obj_parent=obj_parent;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_track_point=function(obj,target){var cons=init_cons(CONS_TYPE_TRACK_POINT);cons.target=new Float32Array(target);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_follow_obj=function(obj,
obj_parent,offset_min,offset_max){var cons=init_cons(CONS_TYPE_FOLLOW_OBJ);cons.obj_parent=obj_parent;cons.offset_min=offset_min;cons.offset_max=offset_max;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_follow_point=function(obj,target,offset_min,offset_max){var cons=init_cons(CONS_TYPE_FOLLOW_POINT);cons.target=new Float32Array(target);cons.offset_min=offset_min;cons.offset_max=offset_max;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_trans_obj=function(obj,obj_parent,
offset){var cons=init_cons(CONS_TYPE_STIFF_TRANS_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_copy_trans_obj=function(obj,obj_parent,offset){var cons=init_cons(CONS_TYPE_COPY_TRANS_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_child_of=function(obj,obj_parent,tsr_offset){var cons=init_cons(CONS_TYPE_CHILD_OF);cons.obj_parent=obj_parent;
cons.tsr_offset=new Float32Array(tsr_offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.update_constraint=function(obj,elapsed){if(obj._constraint)update_cons(obj,obj._constraint,elapsed)};function update_cons(obj,cons,elapsed){switch(cons.type){case CONS_TYPE_STIFF_OBJ:var trans=obj._render.trans;var quat=obj._render.quat;var p_world_matrix=cons.obj_parent._render.world_matrix;var p_trans=cons.obj_parent._render.trans;var p_quat=cons.obj_parent._render.quat;if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,
quat);m_quat.multiply(p_quat,quat,quat)}else m_quat.copy(p_quat,quat);m_vec3.transformMat4(cons.offset,p_world_matrix,obj._render.trans);obj._render.scale=cons.scale_offset*cons.obj_parent._render.scale;break;case CONS_TYPE_SEMI_STIFF_OBJ:var trans=obj._render.trans;var quat=obj._render.quat;var p_world_matrix=cons.obj_parent._render.world_matrix;var p_quat=cons.obj_parent._render.quat;m_quat.multiply(m_quat.invert(cons.parent_prev_rotation,cons.parent_prev_rotation),quat,quat);m_quat.multiply(p_quat,
quat,quat);m_vec3.transformMat4(cons.offset,p_world_matrix,trans);m_quat.copy(p_quat,cons.parent_prev_rotation);break;case CONS_TYPE_SEMI_STIFF_CAM_OBJ:var trans=obj._render.trans;var quat=obj._render.quat;var p_world_matrix=cons.obj_parent._render.world_matrix;var p_quat=cons.obj_parent._render.quat;m_quat.multiply(m_quat.invert(cons.parent_prev_rotation,cons.parent_prev_rotation),quat,quat);m_quat.multiply(p_quat,quat,quat);m_vec3.transformMat4(cons.offset,p_world_matrix,trans);m_quat.copy(p_quat,
cons.parent_prev_rotation);clamp_angles(obj,cons);if(obj._render.type=="CAMERA"){var p_y_axis=m_vec3.transformQuat(m_util.AXIS_Y,p_quat,_vec3_tmp_2);correct_up(obj,p_y_axis)}break;case CONS_TYPE_SEMI_SOFT_CAM_OBJ:var trans=obj._render.trans;var quat=obj._render.quat;var p_world_matrix=cons.obj_parent._render.world_matrix;var p_trans=cons.obj_parent._render.trans;var trans_pivot=_vec3_tmp;var quat_pivot=_quat4_tmp;m_vec3.transformMat4(cons.offset,p_world_matrix,trans_pivot);m_util.smooth_v(trans_pivot,
trans,elapsed,0.3,trans);var dir_to_obj=_vec3_tmp;m_vec3.sub(p_trans,trans,dir_to_obj);m_vec3.normalize(dir_to_obj,dir_to_obj);cam_rotate_to(quat,dir_to_obj,quat_pivot);m_util.smooth_q(quat_pivot,quat,elapsed,0.1,quat);break;case CONS_TYPE_STIFF_BONE:var trans=obj._render.trans;var quat=obj._render.quat;var p_trans=_vec4_tmp;var p_quat=_quat4_tmp;get_bone_pose(cons.obj_parent,cons.bone_name,true,p_trans,p_quat);if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,quat);m_quat.multiply(p_quat,
quat,quat)}else m_quat.copy(p_quat,quat);m_util.transform_vec3(cons.offset,1,p_quat,p_trans,obj._render.trans);break;case CONS_TYPE_TRACK_OBJ:var trans=obj._render.trans;var quat=obj._render.quat;var t_trans=cons.obj_parent._render.trans;rotate_to(trans,quat,t_trans);if(obj._render.type=="CAMERA")correct_up(obj,m_util.AXIS_Y);break;case CONS_TYPE_TRACK_POINT:var trans=obj._render.trans;var quat=obj._render.quat;var t_trans=cons.target;rotate_to(trans,quat,t_trans);if(obj._render.type=="CAMERA")correct_up(obj,
m_util.AXIS_Y);break;case CONS_TYPE_FOLLOW_OBJ:var trans=obj._render.trans;var quat=obj._render.quat;var t_trans=cons.obj_parent._render.trans;var is_rotated=rotate_to_limits(trans,quat,t_trans,CONS_ROTATE_LIMIT);var dist=m_vec3.dist(trans,t_trans);if(!is_rotated)delta=dist+cons.offset_min;else if(dist>cons.offset_max)var delta=dist-cons.offset_max;else if(dist<cons.offset_min)var delta=dist-cons.offset_min;else var delta=0;if(delta){m_vec3.sub(t_trans,trans,_vec3_tmp);m_vec3.normalize(_vec3_tmp,
_vec3_tmp);m_vec3.scale(_vec3_tmp,delta,_vec3_tmp);m_vec3.add(trans,_vec3_tmp,trans)}if(obj._render.type=="CAMERA")correct_up(obj,m_util.AXIS_Y);break;case CONS_TYPE_FOLLOW_POINT:var trans=obj._render.trans;var quat=obj._render.quat;var t_trans=cons.target;var is_rotated=rotate_to_limits(trans,quat,t_trans,CONS_ROTATE_LIMIT);var dist=m_vec3.dist(trans,t_trans);if(!is_rotated)delta=dist+cons.offset_min;else if(dist>cons.offset_max)var delta=dist-cons.offset_max;else if(dist<cons.offset_min)var delta=
dist-cons.offset_min;else var delta=0;if(delta){m_vec3.sub(t_trans,trans,_vec3_tmp);m_vec3.normalize(_vec3_tmp,_vec3_tmp);m_vec3.scale(_vec3_tmp,delta,_vec3_tmp);m_vec3.add(trans,_vec3_tmp,trans)}if(obj._render.type=="CAMERA")correct_up(obj,m_util.AXIS_Y);break;case CONS_TYPE_STIFF_TRANS_OBJ:var p_world_matrix=cons.obj_parent._render.world_matrix;m_vec3.transformMat4(cons.offset,p_world_matrix,obj._render.trans);break;case CONS_TYPE_COPY_TRANS_OBJ:var p_trans=cons.obj_parent._render.trans;var trans=
obj._render.trans;m_vec3.add(p_trans,cons.offset,trans);break;case CONS_TYPE_STIFF_TRANS_ROT_OBJ:var trans=obj._render.trans;var quat=obj._render.quat;var p_world_matrix=cons.obj_parent._render.world_matrix;var p_trans=cons.obj_parent._render.trans;var p_quat=cons.obj_parent._render.quat;if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}else m_quat.copy(p_quat,quat);m_vec3.transformMat4(cons.offset,p_world_matrix,obj._render.trans);break;case CONS_TYPE_CHILD_OF:var prender=
cons.obj_parent._render;var ptsr=m_tsr.create_sep(prender.trans,prender.scale,prender.quat,_tsr8_tmp);var tsr_offset=cons.tsr_offset;m_tsr.multiply(ptsr,tsr_offset,ptsr);var trans=obj._render.trans;trans[0]=ptsr[0];trans[1]=ptsr[1];trans[2]=ptsr[2];obj._render.scale=ptsr[3];var quat=obj._render.quat;quat[0]=ptsr[4];quat[1]=ptsr[5];quat[2]=ptsr[6];quat[3]=ptsr[7];break;default:break}}function clamp_angles(obj,cons){var quat=obj._render.quat;var p_quat=cons.obj_parent._render.quat;var y_world_cam=m_vec3.transformQuat(m_util.AXIS_Y,
quat,_vec3_tmp);var p_quat_inv=m_quat.invert(p_quat,_quat4_tmp);var y_cam_parent=m_vec3.transformQuat(y_world_cam,p_quat_inv,_vec3_tmp_2);var y_world_cam_proj=_vec3_tmp_3;y_world_cam_proj[0]=y_cam_parent[0];y_world_cam_proj[1]=0;y_world_cam_proj[2]=y_cam_parent[2];var y_world_cam_proj_length=m_vec3.length(y_world_cam_proj);var cos_phi=-y_world_cam_proj[2]/y_world_cam_proj_length;var phi=Math.acos(cos_phi)*m_util.sign(y_world_cam_proj[0]);var cos_theta=y_world_cam_proj_length/m_vec3.length(y_cam_parent);
var theta=Math.acos(cos_theta)*m_util.sign(y_cam_parent[1]);var is_clamped=false;if(phi<-cons.clamp_left){phi=-cons.clamp_left;is_clamped=true}if(phi>cons.clamp_right){phi=cons.clamp_right;is_clamped=true}if(theta<-cons.clamp_up){theta=-cons.clamp_up;is_clamped=true}if(theta>cons.clamp_down){theta=cons.clamp_down;is_clamped=true}if(is_clamped){var sin_theta=Math.sin(theta);var cos_theta=Math.cos(theta);var sin_phi=Math.sin(phi);var cos_phi=Math.cos(phi);var y_world_cam_new=_vec3_tmp_2;y_world_cam_new[0]=
cos_theta*sin_phi;y_world_cam_new[1]=sin_theta;y_world_cam_new[2]=-cos_theta*cos_phi;m_vec3.transformQuat(y_world_cam_new,p_quat,y_world_cam_new);var clamp_rotation=m_quat.rotationTo(y_world_cam,y_world_cam_new,_quat4_tmp);m_quat.multiply(clamp_rotation,quat,quat);m_quat.normalize(quat,quat)}}function rotate_to(trans,quat,target){var dir_from=_vec3_tmp;m_util.quat_to_dir(quat,m_util.AXIS_MY,dir_from);m_vec3.normalize(dir_from,dir_from);var dir_to=_vec3_tmp_2;m_vec3.subtract(target,trans,dir_to);m_vec3.normalize(dir_to,
dir_to);var rotation=_vec4_tmp;m_quat.rotationTo(dir_from,dir_to,rotation);m_quat.multiply(rotation,quat,quat)}function rotate_to_limits(trans,quat,target,limit_angle){var dir_from=_vec3_tmp;m_util.quat_to_dir(quat,m_util.AXIS_MY,dir_from);m_vec3.normalize(dir_from,dir_from);var dir_to=_vec3_tmp_2;m_vec3.subtract(target,trans,dir_to);m_vec3.normalize(dir_to,dir_to);if(m_vec3.dot(dir_from,dir_to)<Math.cos(limit_angle))return false;else{var rotation=_vec4_tmp;m_quat.rotationTo(dir_from,dir_to,rotation);
m_quat.multiply(rotation,quat,quat);return true}}function cam_rotate_to(quat,dir,dest){var mat_dst=_mat3_tmp;var x_cam_world=mat_dst.subarray(0,3);var y_cam_world=mat_dst.subarray(3,6);var z_cam_world=mat_dst.subarray(6,9);m_vec3.copy(dir,y_cam_world);m_vec3.negate(y_cam_world,y_cam_world);m_vec3.normalize(y_cam_world,y_cam_world);var up_down=Boolean(Math.abs(m_vec3.dot(dir,m_util.AXIS_Y))>0.999999);if(up_down){var mat_src=m_mat3.fromQuat(m_quat.normalize(quat,dest),_mat3_tmp2);m_vec3.copy(mat_src.subarray(0,
3),x_cam_world)}else m_vec3.cross(m_util.AXIS_Y,y_cam_world,x_cam_world);m_vec3.normalize(x_cam_world,x_cam_world);m_vec3.cross(x_cam_world,y_cam_world,z_cam_world);m_vec3.normalize(z_cam_world,z_cam_world);m_quat.fromMat3(mat_dst,dest);m_quat.normalize(dest,dest)}exports.correct_up=correct_up;function correct_up(camobj,y_axis){var quat=camobj._render.quat;var rmat=m_mat3.fromQuat(quat,_mat3_tmp);var y_world=y_axis;var y_cam_world=_vec3_tmp;y_cam_world[0]=rmat[3];y_cam_world[1]=rmat[4];y_cam_world[2]=
rmat[5];if(Math.abs(m_vec3.dot(y_world,y_cam_world))>0.999)return;var x_cam_world_new=m_vec3.cross(y_world,y_cam_world,y_cam_world);m_vec3.normalize(x_cam_world_new,x_cam_world_new);var z_cam_world_y=rmat[7];if(z_cam_world_y>0){x_cam_world_new[0]*=-1;x_cam_world_new[1]*=-1;x_cam_world_new[2]*=-1}var x_cam_world=_vec3_tmp_2;x_cam_world[0]=rmat[0];x_cam_world[1]=rmat[1];x_cam_world[2]=rmat[2];m_vec3.normalize(x_cam_world,x_cam_world);var rotation=_quat4_tmp;m_quat.rotationTo(x_cam_world,x_cam_world_new,
rotation);m_quat.multiply(rotation,quat,quat)}exports.remove=function(obj){if(obj._constraint.obj_parent)remove_parent_descendant(obj._constraint.obj_parent,obj);obj._constraint=null};exports.get_type=function(obj){if(obj._constraint)return obj._constraint.type;else return null};exports.get_parent=function(obj){if(obj._constraint&&obj._constraint.obj_parent)return obj._constraint.obj_parent;else return null};exports.get_child_of_offset=function(obj){if(obj._constraint&&obj._constraint.type==CONS_TYPE_CHILD_OF)return obj._constraint.tsr_offset;
else return null};exports.get_bone_pose=get_bone_pose;function get_bone_pose(armobj,bone_name,get_pose_tail,dest_transscale,dest_quat){var render=armobj._render;var frame_factor=render.frame_factor;var bone_pointer=render.bone_pointers[bone_name];var index=bone_pointer.deform_bone_index;var pose_bone_index=bone_pointer.pose_bone_index;var bone=armobj["pose"]["bones"][pose_bone_index];var tsr_local=bone._tsr_local;var transcale=_vec4_tmp;var trans_before=render.trans_before;var trans_after=render.trans_after;
var quats_before=render.quats_before;var quats_after=render.quats_after;var x=trans_before[4*index];var y=trans_before[4*index+1];var z=trans_before[4*index+2];var s=trans_before[4*index+3];var xn=trans_after[4*index];var yn=trans_after[4*index+1];var zn=trans_after[4*index+2];var sn=trans_after[4*index+3];transcale[0]=(1-frame_factor)*x+frame_factor*xn;transcale[1]=(1-frame_factor)*y+frame_factor*yn;transcale[2]=(1-frame_factor)*z+frame_factor*zn;transcale[3]=(1-frame_factor)*s+frame_factor*sn;var quat=
_quat4_tmp;var quatn=_quat4_tmp2;quat[0]=quats_before[4*index];quat[1]=quats_before[4*index+1];quat[2]=quats_before[4*index+2];quat[3]=quats_before[4*index+3];quatn[0]=quats_after[4*index];quatn[1]=quats_after[4*index+1];quatn[2]=quats_after[4*index+2];quatn[3]=quats_after[4*index+3];m_quat.slerp(quat,quatn,frame_factor,quat);var tsr_bone=_tsr8_tmp;m_tsr.set_transcale(transcale,tsr_bone);m_tsr.set_quat(quat,tsr_bone);if(get_pose_tail){var tsr_local_tail=_tsr8_tmp2;m_tsr.translate(tsr_local,bone._tail,
tsr_local_tail);m_tsr.multiply(tsr_bone,tsr_local_tail,tsr_bone)}else m_tsr.multiply(tsr_bone,tsr_local,tsr_bone);m_tsr.multiply(render.tsr,tsr_bone,tsr_bone);dest_transscale[0]=tsr_bone[0];dest_transscale[1]=tsr_bone[1];dest_transscale[2]=tsr_bone[2];dest_transscale[3]=tsr_bone[3];if(dest_quat){dest_quat[0]=tsr_bone[4];dest_quat[1]=tsr_bone[5];dest_quat[2]=tsr_bone[6];dest_quat[3]=tsr_bone[7]}}};b4w.module["__controls"]=function(exports,require){var m_cfg=require("__config");var m_print=require("__print");var m_phy=require("__physics");var m_scs=require("__scenes");var m_util=require("__util");var m_vec3=require("vec3");var m_quat=require("quat");var cfg_ctl=m_cfg.controls;var _objects=[];var _sensors=[];var _wheel_delta=0;var _mouse_curr_x=0;var _mouse_curr_y=0;var _mouse_last_x=0;var _mouse_last_y=0;var _touch_curr_x=0;var _touch_curr_y=0;var _touch_last_x=0;var _touch_last_y=0;var _touch_zoom_curr_dist=
0;var _touch_zoom_last_dist=0;var _timeline=0;var ST_CUSTOM=10;var ST_KEYBOARD=20;var ST_MOUSE_WHEEL=30;var ST_MOUSE_MOVE=40;var ST_MOUSE_CLICK=50;var ST_TOUCH_MOVE=60;var ST_TOUCH_ZOOM=70;var ST_COLLISION=80;var ST_COLLISION_IMPULSE=90;var ST_RAY=100;var ST_MOTION=110;var ST_V_VELOCITY=120;var ST_TIMER=130;var ST_ELAPSED=140;var ST_TIMELINE=150;exports.CT_CONTINUOUS=10;exports.CT_TRIGGER=20;exports.CT_SHOT=30;exports.CT_LEVEL=40;var SENSOR_SMOOTH_PERIOD=0.3;var KEY_SHIFT=16;exports.update=function(timeline,
elapsed){_timeline=timeline;var scene=m_scs.get_active();for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];update_sensor(sensor,timeline,elapsed)}for(var i=0;i<_objects.length;i++){var obj=_objects[i];for(var j in obj._sensor_manifolds){var manifold=obj._sensor_manifolds[j];var logic_result=manifold_logic_result(manifold);var pulse=manifold_gen_pulse(manifold,logic_result);if(pulse){manifold.callback(obj,j,pulse,manifold.callback_param);manifold.last_logic_result=logic_result}}}for(var i=
0;i<_objects.length;i++){var obj=_objects[i];for(var j in obj._sensor_manifolds){var manifold=obj._sensor_manifolds[j];discharge_sensors(manifold.sensors)}}_wheel_delta=0;_mouse_last_x=_mouse_curr_x;_mouse_last_y=_mouse_curr_y;_touch_last_x=_touch_curr_x;_touch_last_y=_touch_curr_y;_touch_zoom_last_dist=_touch_zoom_curr_dist};exports.create_custom_sensor=function(value){var sensor=init_sensor(ST_CUSTOM);sensor_set_value(value);return sensor};function init_sensor(type){var sensor={};sensor.type=type;
sensor.value=0;sensor.payload=null;sensor.lock_sensors=null;sensor.lock_sensor_values=null;sensor.lock_logic_fun=null;return sensor}exports.create_keyboard_sensor=function(key){var sensor=init_sensor(ST_KEYBOARD);sensor.key=key;return sensor};exports.create_collision_sensor=function(obj,collision_id,need_collision_pt){if(!(obj&&obj._physics)){m_print.error("Wrong collision object");return null}var sensor=init_sensor(ST_COLLISION);sensor.collision_obj=obj;sensor.collision_id=collision_id||null;sensor.collision_cb=
function(is_collision,collision_point){sensor_set_value(sensor,is_collision);if(is_collision&&(collision_point&&need_collision_pt)){sensor.payload=sensor.payload||new Float32Array(3);sensor.payload[0]=collision_point[0];sensor.payload[1]=collision_point[1];sensor.payload[2]=collision_point[2]}};m_phy.append_collision_test(obj,sensor.collision_id,sensor.collision_cb,need_collision_pt);return sensor};exports.create_collision_impulse_sensor=function(obj){if(!(obj&&obj._physics)){m_print.error("Wrong collision impulse object");
return null}var sensor=init_sensor(ST_COLLISION_IMPULSE);sensor.col_imp_obj=obj;sensor.col_imp_cb=function(impulse){sensor_set_value(sensor,impulse)};m_phy.apply_collision_impulse_test(sensor.col_imp_obj,sensor.col_imp_cb);return sensor};exports.create_ray_sensor=function(obj,start_offset,end_offset,local_coords,collision_id){if(!obj){m_print.error("Wrong collision object");return null}var sensor=init_sensor(ST_RAY);sensor.source_object=obj;sensor.start_offset=start_offset;sensor.end_offset=end_offset;
sensor.local_coords=local_coords;sensor.collision_id=collision_id;sensor.ray_cb=function(is_hit,hit_frac){sensor_set_value(sensor,is_hit);if(is_hit)sensor.payload=hit_frac};m_phy.append_ray_test(obj,sensor.collision_id,start_offset,end_offset,local_coords,sensor.ray_cb);return sensor};exports.create_mouse_click_sensor=function(){var sensor=init_sensor(ST_MOUSE_CLICK);return sensor};exports.create_mouse_wheel_sensor=function(){var sensor=init_sensor(ST_MOUSE_WHEEL);return sensor};exports.create_mouse_move_sensor=
function(axis){var sensor=init_sensor(ST_MOUSE_MOVE);sensor.axis=axis||"XY";return sensor};exports.create_touch_move_sensor=function(axis){var sensor=init_sensor(ST_TOUCH_MOVE);sensor.axis=axis||"XY";return sensor};exports.create_touch_zoom_sensor=function(){var sensor=init_sensor(ST_TOUCH_ZOOM);return sensor};exports.create_motion_sensor=function(obj,threshold,rotation_threshold){if(!obj){m_print.error("Wrong collision object");return null}var sensor=init_sensor(ST_MOTION);sensor.source_object=obj;
var trans=obj._render.trans;var quat=obj._render.quat;sensor.quat_temp=new Float32Array(4);sensor.trans_last=new Float32Array(trans);sensor.quat_last=new Float32Array(quat);sensor.avg_linear_vel=0;sensor.avg_angular_vel=0;sensor.threshold=threshold;sensor.rotation_threshold=rotation_threshold;sensor.time_last=0;sensor.payload=new Float32Array([0,0]);return sensor};exports.create_vertical_velocity_sensor=function(obj,threshold){if(!obj){m_print.error("Wrong collision object");return null}var sensor=
init_sensor(ST_V_VELOCITY);sensor.source_object=obj;var trans=obj._render.trans;var quat=obj._render.quat;sensor.trans_last=new Float32Array(trans);sensor.quat_last=new Float32Array(quat);sensor.avg_vertical_vel=0;sensor.threshold=threshold;sensor.time_last=0;sensor.payload=0;return sensor};exports.create_timer_sensor=function(period){var sensor=init_sensor(ST_TIMER);sensor.period=period;sensor.time_last=_timeline;return sensor};exports.reset_timer_sensor=function(obj,manifold_id,num,delay){delay=
delay||0;var manifolds=obj._sensor_manifolds;if(!manifolds||!manifolds[manifold_id]){m_print.error("reset_timer_sensor(): wrong object");return null}var sensor=manifolds[manifold_id].sensors[num];if(!sensor){m_print.error("reset_timer_sensor(): sensor not found");return null}sensor.time_last=_timeline+delay};exports.create_elapsed_sensor=function(){var sensor=init_sensor(ST_ELAPSED);sensor.time_last=0;return sensor};exports.create_timeline_sensor=function(){var sensor=init_sensor(ST_TIMELINE);return sensor};
exports.sensor_set_value=sensor_set_value;function sensor_set_value(sensor,value){if(lock_logic_result(sensor))return;sensor.value=Number(value)}function lock_logic_result(sensor){if(!sensor.lock_logic_fun)return false;var sensors=sensor.lock_sensors;var values=sensor.lock_sensor_values;for(var i=0;i<sensors.length;i++)values[i]=sensors[i].value;var logic_result=sensor.lock_logic_fun(values);return logic_result}function manifold_logic_result(manifold){var sensors=manifold.sensors;var values=manifold.sensor_values;
for(var i=0;i<sensors.length;i++)values[i]=sensors[i].value;var logic_result=manifold.logic_fun(values);return logic_result}function update_sensor(sensor,timeline,elapsed){if(!elapsed)return;var scene=m_scs.get_active();switch(sensor.type){case ST_MOTION:var obj=sensor.source_object;var trans=obj._render.trans;var quat=obj._render.quat;var dist=m_vec3.dist(sensor.trans_last,trans);var quat_temp=sensor.quat_temp;m_quat.invert(sensor.quat_last,quat_temp);m_quat.multiply(quat,quat_temp,quat_temp);m_quat.normalize(quat_temp,
quat_temp);var angle=Math.abs(2*Math.acos(quat_temp[3]));var linear_vel=dist/elapsed;sensor.avg_linear_vel=m_util.smooth(linear_vel,sensor.avg_linear_vel,elapsed,SENSOR_SMOOTH_PERIOD);sensor.payload[0]=linear_vel;var angular_vel=angle/elapsed;sensor.avg_angular_vel=m_util.smooth(angular_vel,sensor.avg_angular_vel,elapsed,SENSOR_SMOOTH_PERIOD);sensor.payload[1]=angular_vel;if(sensor.avg_linear_vel>=sensor.threshold||sensor.avg_angular_vel>=sensor.rotation_threshold)sensor_set_value(sensor,1);else sensor_set_value(sensor,
0);m_vec3.copy(trans,sensor.trans_last);m_quat.copy(quat,sensor.quat_last);sensor.time_last=timeline;break;case ST_V_VELOCITY:var obj=sensor.source_object;var trans=obj._render.trans;var vel=Math.abs(trans[1]-sensor.trans_last[1])/elapsed;sensor.avg_vertical_vel=m_util.smooth(vel,sensor.avg_vertical_vel,elapsed,SENSOR_SMOOTH_PERIOD);sensor.payload=vel;if(sensor.avg_vertical_vel>=sensor.threshold)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);m_vec3.copy(trans,sensor.trans_last);sensor.time_last=
timeline;break;case ST_TIMER:if(timeline-sensor.time_last>=sensor.period){sensor_set_value(sensor,1);sensor.time_last=timeline}break;case ST_ELAPSED:if(!sensor.time_last)sensor.time_last=timeline;sensor_set_value(sensor,timeline-sensor.time_last);sensor.time_last=timeline;break;case ST_TIMELINE:sensor_set_value(sensor,timeline);break;default:break}}function manifold_gen_pulse(manifold,logic_result){var last_pulse=manifold.last_pulse;var pulse;var new_last_pulse;switch(manifold.type){case exports.CT_CONTINUOUS:if(logic_result){pulse=
1;new_last_pulse=1}else if(last_pulse==1){pulse=-1;new_last_pulse=-1}else pulse=0;break;case exports.CT_TRIGGER:if(logic_result&&last_pulse==-1){pulse=1;new_last_pulse=1}else if(!logic_result&&last_pulse==1){pulse=-1;new_last_pulse=-1}else pulse=0;break;case exports.CT_SHOT:if(logic_result&&last_pulse==-1){pulse=1;new_last_pulse=1}else if(!logic_result&&last_pulse==1){pulse=0;new_last_pulse=-1}else pulse=0;break;case exports.CT_LEVEL:var last_logic_result=manifold.last_logic_result;if(last_logic_result!=
logic_result)pulse=1;else pulse=0;break;default:throw"Wrong sensor manifold type: "+manifold.type;break}if(new_last_pulse)manifold.last_pulse=new_last_pulse;return pulse}function manifold_get_value(manifold,logic_result){if(logic_result)var value=manifold.sensors[0].value;else var value=0;return value}function discharge_sensors(sensors){for(var i=0;i<sensors.length;i++){var sensor=sensors[i];switch(sensor.type){case ST_MOUSE_WHEEL:sensor_set_value(sensor,0);break;case ST_MOUSE_MOVE:sensor_set_value(sensor,
0);break;case ST_TOUCH_MOVE:sensor_set_value(sensor,0);break;case ST_TOUCH_ZOOM:sensor_set_value(sensor,0);break;case ST_TIMER:sensor_set_value(sensor,0);break;default:break}}}exports.cleanup=function(){_objects=[];_sensors=[];_timeline=0};exports.check_sensor_manifold=function(obj,id){if(id)for(var i in obj._sensor_manifolds){if(i===id)return true}else for(var i in obj._sensor_manifolds)return true;return false};exports.remove_sensor_manifold=function(obj,id){var manifolds=obj._sensor_manifolds;
if(id){var manifold=manifolds[id];var sensors=manifold.sensors;for(var j=0;j<sensors.length;j++)if(check_sensor_users(sensors[j],_objects)===1)remove_sensor(sensors[j],_sensors);delete manifolds[id];if(!Object.getOwnPropertyNames(manifolds).length)remove_from_objects(obj);return}for(var i in manifolds){var manifold=manifolds[i];var sensors=manifold.sensors;for(var j=0;j<sensors.length;j++)if(check_sensor_users(sensors[j],_objects)===1)remove_sensor(sensors[j],_sensors);delete manifolds[i]}remove_from_objects(obj)};
function remove_from_objects(obj){var obj_index=_objects.indexOf(obj);if(obj_index>-1)_objects.splice(obj_index,1);else{m_print.error("Wrong object");return}}function check_sensor_users(sensor,objects){var users=0;for(var i=0;i<objects.length;i++){var obj=objects[i];var manifolds=obj._sensor_manifolds;for(var j in manifolds){var manifold=obj._sensor_manifolds[j];var sensors=manifold.sensors;for(var k=0;k<sensors.length;k++)if(sensors[k]===sensor)users++}}return users}function remove_sensor(sensor,
sensors){switch(sensor.type){case ST_COLLISION:m_phy.remove_collision_test(sensor.collision_obj,sensor.collision_id,sensor.collision_cb);break;case ST_COLLISION_IMPULSE:m_phy.clear_collision_impulse_test(sensor.col_imp_obj);break;case ST_RAY:m_phy.remove_ray_test(sensor.source_object,sensor.collision_id,sensor.start_offset,sensor.end_offset,sensor.local_coords);break}var sens_index=sensors.indexOf(sensor);if(sens_index>-1)sensors.splice(sens_index,1)}exports.create_sensor_manifold=function(obj,id,
type,sensors,logic_fun,callback,callback_param){obj._sensor_manifolds=obj._sensor_manifolds||{};var manifold={};manifold.name=name;manifold.type=type;manifold.sensors=sensors.slice(0);manifold.logic_fun=logic_fun||default_AND_logic_fun;manifold.sensor_values=new Array(sensors.length);manifold.callback=callback;manifold.callback_param=callback_param||null;manifold.last_pulse=-1;manifold.last_logic_result=0;obj._sensor_manifolds[id]=manifold;if(_objects.indexOf(obj)==-1)_objects.push(obj);append_unique_sensors(manifold.sensors)};
exports.default_AND_logic_fun=default_AND_logic_fun;function default_AND_logic_fun(s){for(var i=0;i<s.length;i++)if(!s[i])return s[i];return s[s.length-1]}function append_unique_sensors(sensors){for(var i=0;i<sensors.length;i++){var sensor=sensors[i];if(_sensors.indexOf(sensor)==-1)_sensors.push(sensor)}}exports.reset=function(){for(var i=0;i<_objects.length;i++){var obj=_objects[i];var manifolds=obj._sensor_manifolds;for(var j in manifolds)delete manifolds[j]}for(var i=0;i<_sensors.length;i++){remove_sensor(_sensors[i],
_sensors);i--}_objects.splice(0,_objects.length)};exports.debug=function(){var scene=m_scs.get_active();m_print.log(String(_objects.length)+" objects with manifolds",_objects);m_print.log(String(_sensors.length)+" sensors",_sensors);var collisions=[];var rays=[];for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_COLLISION)collisions.push(sensor);if(sensor.type==ST_RAY)rays.push(sensor)}m_print.log(String(collisions.length)+" collision sensors",collisions);m_print.log(String(rays.length)+
" ray sensors",rays)};exports.keydown_cb=function(e){for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_KEYBOARD&&e.keyCode==sensor.key)sensor_set_value(sensor,1)}};exports.keyup_cb=function(e){for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_KEYBOARD&&(e.keyCode==0&&sensor.key==KEY_SHIFT))sensor_set_value(sensor,0);if(sensor.type==ST_KEYBOARD&&e.keyCode==sensor.key)sensor_set_value(sensor,0)}};exports.mouse_down_cb=function(e){for(var i=0;i<_sensors.length;i++){var sensor=
_sensors[i];if(sensor.type==ST_MOUSE_CLICK)sensor_set_value(sensor,1)}};exports.mouse_up_cb=function(e){for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type==ST_MOUSE_CLICK)sensor_set_value(sensor,0)}};exports.mouse_wheel_cb=function(e){var wd=e.wheelDelta||-40*e.detail;wd*=cfg_ctl.mouse_wheel_notch_multiplier;_wheel_delta+=wd;for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type===ST_MOUSE_WHEEL)sensor_set_value(sensor,_wheel_delta)}};exports.mouse_move_cb=
function(e){var x=e.clientX;var y=e.clientY;_mouse_curr_x=x;_mouse_curr_y=y;var delta_x=x-_mouse_last_x;var delta_y=y-_mouse_last_y;var delta=Math.sqrt(delta_x*delta_x+delta_y*delta_y);for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type===ST_MOUSE_MOVE)switch(sensor.axis){case "X":sensor_set_value(sensor,delta_x);break;case "Y":sensor_set_value(sensor,delta_y);break;case "XY":sensor_set_value(sensor,delta);break}}};exports.touch_start_cb=function(e){var touches=e.targetTouches;
if(touches.length==1){var touch=touches[0];var x=touch.pageX;var y=touch.pageY;_touch_curr_x=_touch_last_x=x;_touch_curr_y=_touch_last_y=y}else if(touches.length>1){var zoom_dist=touch_zoom_dist(touches);_touch_zoom_curr_dist=_touch_zoom_last_dist=zoom_dist}};exports.touch_move_cb=function(e){var touches=e.targetTouches;if(touches.length===0)return;e.preventDefault();if(touches.length===1){var touch=touches[0];var x=touch.pageX;var y=touch.pageY;_touch_curr_x=x;_touch_curr_y=y;var delta_x=x-_touch_last_x;
var delta_y=y-_touch_last_y;var delta=Math.sqrt(delta_x*delta_x+delta_y*delta_y);for(var i=0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type===ST_TOUCH_MOVE)switch(sensor.axis){case "X":sensor_set_value(sensor,delta_x);break;case "Y":sensor_set_value(sensor,delta_y);break;case "XY":sensor_set_value(sensor,delta);break}}}else if(touches.length>1){var zoom_dist=touch_zoom_dist(touches);_touch_zoom_curr_dist=zoom_dist;var delta_dist=_touch_zoom_curr_dist-_touch_zoom_last_dist;for(var i=
0;i<_sensors.length;i++){var sensor=_sensors[i];if(sensor.type===ST_TOUCH_ZOOM)sensor_set_value(sensor,delta_dist)}}};function touch_zoom_dist(touches){var touch1=touches[0];var touch2=touches[1];var x1=touch1.pageX;var y1=touch1.pageY;var x2=touch2.pageX;var y2=touch2.pageY;var zoom_dist=Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));return zoom_dist}};b4w.module["__curve"]=function(exports,require){var util=require("__util");var SPLINE_POINTS=1E3;exports.create_spline=function(obj){var spline={};var bpy_curve=obj["data"];var bpy_spline=bpy_curve["splines"][0];if(!(bpy_spline&&(bpy_spline["type"]=="NURBS"&&bpy_spline["use_endpoint_u"])))return null;var order=bpy_spline["order_u"];spline.order=order;var points=bpy_spline["points"];var knot=gen_open_knot(points.length/5,order,[]);spline.knot=knot;if(bpy_curve["dimensions"]=="2D")spline.is_3d=false;
else if(bpy_curve["dimensions"]=="3D")spline.is_3d=true;else throw"Wrong curve dimensions";var cpoints=[];var weights=[];for(var i=0;i<points.length;i+=5){cpoints.push(points[i]);cpoints.push(points[i+1]);cpoints.push(points[i+2]);if(spline.is_3d)cpoints.push(points[i+3]);weights.push(points[i+4])}spline.cpoints=cpoints;spline.weights=weights;var points=spline_points(spline,SPLINE_POINTS,[]);var ncoords=spline.is_3d?4:3;var clen=new Float32Array(SPLINE_POINTS);clen[0]=0;for(var i=1;i<SPLINE_POINTS;i+=
1){var x0=points[(i-1)*ncoords];var y0=points[(i-1)*ncoords+1];var z0=points[(i-1)*ncoords+2];var x=points[i*ncoords];var y=points[i*ncoords+1];var z=points[i*ncoords+2];var len=Math.sqrt((x-x0)*(x-x0)+(y-y0)*(y-y0)+(z-z0)*(z-z0));clen[i]=clen[i-1]+len}spline.cumulative_length=clen;return spline};function gen_open_knot(n,order,dest){if(!dest)var dest=[];var nplusorder=n+order;var nplus2=n+2;dest[0]=0;for(var i=2;i<=nplusorder;i++)if(i>order&&i<nplus2)dest[i-1]=dest[i-2]+1;else dest[i-1]=dest[i-2];
return dest}function gen_periodic_knot(n,order,dest){if(!dest)var dest=[];var nplusorder=n+order;var nplus2=n+2;dest[0]=0;for(var i=2;i<=nplusorder;i++)dest[i-1]=i-1;return dest}function gen_rational_basis(order,t,knot,weights,r){var n=weights.length;if(!r)var r=new Float32Array(n);var nplusorder=n+order;var temp=new Float32Array(nplusorder);for(var i=1;i<=nplusorder-1;i++)if(t>=knot[i-1]&&t<knot[i+1-1])temp[i-1]=1;else temp[i-1]=0;for(var k=2;k<=order;k++)for(var i=1;i<=nplusorder-k;i++){if(temp[i-
1]!=0)var d=(t-knot[i-1])*temp[i-1]/(knot[i+k-1-1]-knot[i-1]);else var d=0;if(temp[i+1-1]!=0)var e=(knot[i+k-1]-t)*temp[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var e=0;temp[i-1]=d+e}if(t==knot[nplusorder-1])temp[n-1]=1;var sum=0;for(var i=1;i<=n;i++)sum=sum+temp[i-1]*weights[i-1];for(var i=1;i<=n;i++)if(sum!=0)r[i-1]=temp[i-1]*weights[i-1]/sum;else r[i-1]=0;return r}function gen_rational_dbasis(order,t,knot,weights,rd){var num=weights.length;if(!rd)var rd=new Float32Array(num);var n=new Float32Array(num);
var d=new Float32Array(num);gen_basis_d(num,order,t,knot,n,d);var sum=0;for(var i=1;i<=num;i++)sum=sum+n[i-1]*weights[i-1];var dsum=0;for(var i=1;i<=num;i++)dsum=dsum+d[i-1]*weights[i-1];for(var i=1;i<=num;i++)if(sum!=0){var rd1=d[i-1]*weights[i-1]/sum;var rd2=n[i-1]*weights[i-1]*dsum/(sum*sum);rd[i-1]=rd1+rd2}else rd[i-1]=0;return rd}function gen_basis_d(num,order,t,knot,n,d){if(!n)var n=new Float32Array(num);if(!d)var d=new Float32Array(num);var nplusorder=num+order;var temp=new Float32Array(nplusorder);
var tempd=new Float32Array(nplusorder);for(var i=1;i<=nplusorder-1;i++)if(t>=knot[i-1]&&t<knot[i+1-1])temp[i-1]=1;else temp[i-1]=0;if(t==knot[nplusorder-1])temp[num-1]=1;for(var k=2;k<=order;k++)for(var i=1;i<=nplusorder-k;i++){if(temp[i-1]!=0)var b1=(t-knot[i-1])*temp[i-1]/(knot[i+k-1-1]-knot[i-1]);else var b1=0;if(temp[i+1-1]!=0)var b2=(knot[i+k-1]-t)*temp[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var b2=0;if(temp[i-1]!=0)var f1=temp[i-1]/(knot[i+k-1-1]-knot[i-1]);else var f1=0;if(temp[i+1-1]!=0)var f2=
-temp[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var f2=0;if(tempd[i-1]!=0)var f3=(t-knot[i-1])*tempd[i-1]/(knot[i+k-1-1]-knot[i-1]);else var f3=0;if(tempd[i+1-1]!=0)var f4=(knot[i+k-1]-t)*tempd[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var f4=0;temp[i-1]=b1+b2;tempd[i-1]=f1+f2+f3+f4}for(var i=1;i<=num;i++){n[i-1]=temp[i-1];d[i-1]=tempd[i-1]}return n}function spline_points(spline,num,dest){if(!dest)var dest=[];var cpoints=spline.cpoints;var ncoords=spline.is_3d?4:3;var weights=spline.weights;var knot=spline.knot;
var order=spline.order;var n=cpoints.length/ncoords;var nplusorder=n+order;var t=0;var step=knot[nplusorder-1]/(num-1);var icount=0;for(var i=0;i<num;i++){if(knot[nplusorder-1]-t<5E-6)t=knot[nplusorder-1];var basis=gen_rational_basis(order,t,knot,weights);for(var j=0;j<ncoords;j++){dest[ncoords*i+j]=0;for(var k=0;k<n;k++){var temp=basis[k]*cpoints[ncoords*k+j];dest[ncoords*i+j]+=temp}}t=t+step}return dest}exports.spline_point=function(spline,t,dest){if(!dest)var dest=[];var t=clamped_t(spline,t);
var cpoints=spline.cpoints;var ncoords=spline.is_3d?4:3;var weights=spline.weights;var knot=spline.knot;var order=spline.order;var n=cpoints.length/ncoords;var nplusorder=n+order;if(knot[nplusorder-1]-t<5E-6)t=knot[nplusorder-1];var basis=new Float32Array(n);gen_rational_basis(order,t,knot,weights,basis);for(var i=0;i<ncoords;i++){dest[i]=0;for(var j=0;j<n;j++)dest[i]+=basis[j]*cpoints[ncoords*j+i]}return dest};function clamped_t(spline,t){var t_clamped=Math.max(t,0);var max_t=spline_max_t(spline);
t_clamped=Math.min(t,max_t);return t_clamped}exports.spline_derivative=function(spline,t,dest){if(!dest)var dest=[];var cpoints=spline.cpoints;var ncoords=spline.is_3d?4:3;var weights=spline.weights;var knot=spline.knot;var order=spline.order;var n=cpoints.length/ncoords;var nplusorder=n+order;if(knot[nplusorder-1]-t<5E-6)t=knot[nplusorder-1];var dbasis=new Float32Array(n);gen_rational_dbasis(order,t,knot,weights,dbasis);for(var i=0;i<ncoords;i++){dest[i]=0;for(var j=0;j<n;j++)dest[i]+=dbasis[j]*
cpoints[ncoords*j+i]}return dest};exports.spline_max_t=spline_max_t;function spline_max_t(spline){var knot=spline.knot;return knot[knot.length-1]}exports.spline_length=spline_length;function spline_length(spline){var clen=spline.cumulative_length;return clen[clen.length-1]}exports.spline_len_to_t=function(spline,len){if(len<=0)return 0;var max_t=spline_max_t(spline);if(len>=spline_length(spline))return max_t;var clen=spline.cumulative_length;var index=util.binary_search_max(clen,len,0,clen.length-
1);var index_float=index+(len-clen[index])/(clen[index+1]-clen[index]);var t=max_t*index_float/SPLINE_POINTS;return t}};b4w.module["__dds"]=function(exports,require){var m_print=require("__print");var DDS_MAGIC=542327876;var DDSD_CAPS=1,DDSD_HEIGHT=2,DDSD_WIDTH=4,DDSD_PITCH=8,DDSD_PIXELFORMAT=4096,DDSD_MIPMAPCOUNT=131072,DDSD_LINEARSIZE=524288,DDSD_DEPTH=8388608;var DDSCAPS_COMPLEX=8,DDSCAPS_MIPMAP=4194304,DDSCAPS_TEXTURE=4096;var DDSCAPS2_CUBEMAP=512,DDSCAPS2_CUBEMAP_POSITIVEX=1024,DDSCAPS2_CUBEMAP_NEGATIVEX=2048,DDSCAPS2_CUBEMAP_POSITIVEY=4096,DDSCAPS2_CUBEMAP_NEGATIVEY=8192,DDSCAPS2_CUBEMAP_POSITIVEZ=16384,DDSCAPS2_CUBEMAP_NEGATIVEZ=
32768,DDSCAPS2_VOLUME=2097152;var DDPF_ALPHAPIXELS=1,DDPF_ALPHA=2,DDPF_FOURCC=4,DDPF_RGB=64,DDPF_YUV=512,DDPF_LUMINANCE=131072;var FOURCC_DXT1=fourcc_to_int32("DXT1");var FOURCC_DXT3=fourcc_to_int32("DXT3");var FOURCC_DXT5=fourcc_to_int32("DXT5");var HEADER_LENGTH_INT=31;var OFFSET_MAGIC=0;var OFFSET_SIZE=1;var OFFSET_FLAGS=2;var OFFSET_HEIGHT=3;var OFFSET_WIDTH=4;var OFFSET_MIPMAPCOUNT=7;var OFFSET_PF_FLAGS=20;var OFFSET_PF_FOUR_CC=21;exports.dxt_to_rgb_565=dxt_to_rgb_565;function dxt_to_rgb_565(src,
src16Offset,width,height){var c=new Uint16Array(4);var dst=new Uint16Array(width*height);var nWords=width*height/4;var m=0;var dstI=0;var i=0;var r0=0,g0=0,b0=0,r1=0,g1=0,b1=0;var blockWidth=width/4;var blockHeight=height/4;for(var blockY=0;blockY<blockHeight;blockY++)for(var blockX=0;blockX<blockWidth;blockX++){i=src16Offset+4*(blockY*blockWidth+blockX);c[0]=src[i];c[1]=src[i+1];r0=c[0]&31;g0=c[0]&2016;b0=c[0]&63488;r1=c[1]&31;g1=c[1]&2016;b1=c[1]&63488;c[2]=5*r0+3*r1>>3|5*g0+3*g1>>3&2016|5*b0+3*
b1>>3&63488;c[3]=5*r1+3*r0>>3|5*g1+3*g0>>3&2016|5*b1+3*b0>>3&63488;m=src[i+2];dstI=blockY*4*width+blockX*4;dst[dstI]=c[m&3];dst[dstI+1]=c[m>>2&3];dst[dstI+2]=c[m>>4&3];dst[dstI+3]=c[m>>6&3];dstI+=width;dst[dstI]=c[m>>8&3];dst[dstI+1]=c[m>>10&3];dst[dstI+2]=c[m>>12&3];dst[dstI+3]=c[m>>14];m=src[i+3];dstI+=width;dst[dstI]=c[m&3];dst[dstI+1]=c[m>>2&3];dst[dstI+2]=c[m>>4&3];dst[dstI+3]=c[m>>6&3];dstI+=width;dst[dstI]=c[m>>8&3];dst[dstI+1]=c[m>>10&3];dst[dstI+2]=c[m>>12&3];dst[dstI+3]=c[m>>14]}return dst}
exports.upload_dds_levels=upload_dds_levels;function upload_dds_levels(gl,ext,arrayBuffer,loadMipmaps){var header=new Int32Array(arrayBuffer,0,HEADER_LENGTH_INT),fourCC,blockBytes,internalFormat,width,height,dataLength,dataOffset,rgb565Data,byteArray,mipmapCount,i;if(header[OFFSET_MAGIC]!=DDS_MAGIC){m_print.error("Invalid magic number in DDS header");return 0}if(!header[OFFSET_PF_FLAGS]&DDPF_FOURCC){m_print.error("Unsupported format, must contain a FourCC code");return 0}fourCC=header[OFFSET_PF_FOUR_CC];
switch(fourCC){case FOURCC_DXT1:blockBytes=8;internalFormat=ext?ext.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case FOURCC_DXT3:blockBytes=16;internalFormat=ext?ext.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case FOURCC_DXT5:blockBytes=16;internalFormat=ext?ext.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:m_print.error("Unsupported FourCC code:",int32_to_fourcc(fourCC));return null}mipmapCount=1;if(header[OFFSET_FLAGS]&DDSD_MIPMAPCOUNT&&loadMipmaps!==false)mipmapCount=Math.max(1,header[OFFSET_MIPMAPCOUNT]);
width=header[OFFSET_WIDTH];height=header[OFFSET_HEIGHT];dataOffset=header[OFFSET_SIZE]+4;if(ext)for(i=0;i<mipmapCount;++i){dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes;byteArray=new Uint8Array(arrayBuffer,dataOffset,dataLength);gl.compressedTexImage2D(gl.TEXTURE_2D,i,internalFormat,width,height,0,byteArray);dataOffset+=dataLength;width=Math.max(width*0.5,1);height=Math.max(height*0.5,1)}else if(fourCC==FOURCC_DXT1){dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes;byteArray=
new Uint16Array(arrayBuffer);rgb565Data=dxt_to_rgb_565(byteArray,dataOffset/2,width,height);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,width,height,0,gl.RGB,gl.UNSIGNED_SHORT_5_6_5,rgb565Data);if(loadMipmaps)gl.generateMipmap(gl.TEXTURE_2D)}else{m_print.error("No manual decoder for",int32_to_fourcc(fourCC),"and no native support");return 0}return mipmapCount}exports.get_width_height=function(arrayBuffer){var header=new Int32Array(arrayBuffer,0,HEADER_LENGTH_INT);return{width:header[OFFSET_WIDTH],height:header[OFFSET_HEIGHT]}};
exports.get_compress_ratio=function(arrayBuffer){var comp_ratio=1;var header=new Int32Array(arrayBuffer,0,HEADER_LENGTH_INT);var fourCC=header[OFFSET_PF_FOUR_CC];switch(fourCC){case FOURCC_DXT1:var comp_ratio=6;break;case FOURCC_DXT3:case FOURCC_DXT5:var comp_ratio=4;break;default:m_print.error("Unsupported FourCC code:",int32_to_fourcc(fourCC));break}return comp_ratio};exports.load_dds_texture_ex=load_dds_texture_ex;function load_dds_texture_ex(gl,ext,src,texture,loadMipmaps,callback){var xhr=new XMLHttpRequest;
xhr.open("GET",src,true);xhr.responseType="arraybuffer";xhr.onload=function(){if(xhr.status==200){gl.bindTexture(gl.TEXTURE_2D,texture);var mipmaps=upload_dds_levels(gl,ext,xhr.response,loadMipmaps);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,mipmaps>1?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR)}if(callback)callback(texture)};xhr.send(null);return texture}exports.load_dds_texture=function(gl,ext,src,callback){var texture=gl.createTexture();
load_dds_texture_ex(gl,ext,src,texture,true,callback);return texture};function fourcc_to_int32(value){return value.charCodeAt(0)+(value.charCodeAt(1)<<8)+(value.charCodeAt(2)<<16)+(value.charCodeAt(3)<<24)}function int32_to_fourcc(value){return String.fromCharCode(value&255,value>>8&255,value>>16&255,value>>24&255)}};b4w.module["__debug"]=function(exports,require){var m_print=require("__print");var extensions=require("__extensions");var m_textures=require("__textures");var util=require("__util");var _gl=null;var ERRORS={};var _check_errors=false;var _exec_counters={};var _telemetry_messages=[];var _depth_only_issue=-1;exports.WIREFRAME_MODES={"WM_OPAQUE_WIREFRAME":0,"WM_TRANSPARENT_WIREFRAME":1,"WM_FRONT_BACK_VIEW":2,"WM_DEBUG_SPHERES":3};exports.setup_context=function(gl){var errors=["INVALID_ENUM","INVALID_VALUE",
"INVALID_OPERATION","OUT_OF_MEMORY","INVALID_FRAMEBUFFER_OPERATION","CONTEXT_LOST_WEBGL"];for(var i in errors){var error=errors[i];if(error in gl)ERRORS[gl[error]]=error}_gl=gl};exports.check_gl=function(msg){if(!_check_errors)return;var error=_gl.getError();if(error==_gl.NO_ERROR)return;if(error in ERRORS)throw"B4W Error: "+error+", gl."+ERRORS[error]+" ("+msg+")";else throw"Unknown GL error: "+error+" ("+msg+")";};exports.check_bound_fb=function(){if(!_check_errors)return true;switch(_gl.checkFramebufferStatus(_gl.FRAMEBUFFER)){case _gl.FRAMEBUFFER_COMPLETE:return true;
case _gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:m_print.error("B4W Error: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");return false;case _gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:m_print.error("B4W Error: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");return false;case _gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:m_print.error("B4W Error: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");return false;case _gl.FRAMEBUFFER_UNSUPPORTED:m_print.error("B4W Error: Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");
return false;default:m_print.error("B4W Error: FRAMEBUFFER CHECK FAILED");return false}};exports.check_depth_only_issue=function(){if(_depth_only_issue!=-1)return _depth_only_issue;var framebuffer=_gl.createFramebuffer();_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);var texture=m_textures.create_texture("DEBUG",m_textures.TT_DEPTH);m_textures.resize(texture,1,1);var w_tex=texture.w_texture;var w_target=texture.w_target;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,w_target,w_tex,
0);if(_gl.checkFramebufferStatus(_gl.FRAMEBUFFER)!=_gl.FRAMEBUFFER_COMPLETE){_depth_only_issue=true;m_print.warn("B4W warning: depth-only issue was found")}else _depth_only_issue=false;_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);return _depth_only_issue};exports.check_shader_compiling=function(shader,shader_id,shader_text){if(!_check_errors)return;if(!_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)){shader_text=supply_line_numbers(shader_text);m_print.error("B4W Error: shader compilation failed:\n"+
shader_text+"\n"+_gl.getShaderInfoLog(shader)+" ("+shader_id+")");throw"Engine failed: see above for error messages";}};function supply_line_numbers(text){var lines=text.split("\n");for(var i=0;i<lines.length;i++)lines[i]=i+1+" "+lines[i];text=lines.join("\n");return text}exports.check_shader_linking=function(program,shader_id,vshader,fshader,vshader_text,fshader_text){if(!_check_errors)return;if(!_gl.getProgramParameter(program,_gl.LINK_STATUS)){var ext_ds=extensions.get_debug_shaders();if(ext_ds){var vshader_text=
ext_ds.getTranslatedShaderSource(vshader);var fshader_text=ext_ds.getTranslatedShaderSource(fshader)}vshader_text=supply_line_numbers(vshader_text);fshader_text=supply_line_numbers(fshader_text);m_print.error("B4W Error: shader linking failed:\n"+vshader_text+"\n\n\n"+fshader_text+"\n"+_gl.getProgramInfoLog(program)+" ("+shader_id+")");throw"Engine failed: see above for error messages";}};exports.set_check_gl_errors=function(val){_check_errors=val};exports.exec_count=function(counter){if(counter in
_exec_counters)_exec_counters[counter]+=1;else _exec_counters[counter]=1};exports.update=function(){for(var i in _exec_counters){m_print.log(i,_exec_counters[i]);_exec_counters[i]=0}};exports.fbmsg=function(){var msg=[performance.now()];for(var i=0;i<arguments.length;i++){var arg=arguments[i];if(util.is_vector(arg))for(var j=0;j<arg.length;j++)msg.push(arg[j]);else msg.push(arguments[i])}_telemetry_messages.push(msg)};exports.msg=function(){var id_count=1;for(var i=0;i<_telemetry_messages.length;i++){var msg=
_telemetry_messages[i];if(msg[1]==arguments[0])id_count++}var msg=[id_count];for(var i=0;i<arguments.length;i++){var arg=arguments[i];if(util.is_vector(arg))for(var j=0;j<arg.length;j++)msg.push(arg[j]);else msg.push(arguments[i])}_telemetry_messages.push(msg)};var COLORS=["color: #3366FF","color: #CC33FF","color: #FF3366","color: #33FF66","color: #FFCC33"];exports.print_telemetry=function(time){if(!time)time=1;var color_counter=0;var color_by_id={};var start_time_ms=Math.max(0,performance.now()-
time*1E3);for(var i=0;i<_telemetry_messages.length;i++){var msg=_telemetry_messages[i];var time=msg[0];if(time<start_time_ms)continue;var id=String(msg[1]);if(!color_by_id[id])color_by_id[id]=COLORS[color_counter++%COLORS.length];var color=color_by_id[id];var console_args=["%c"+(time/1E3).toFixed(6),color,id];for(var j=2;j<msg.length;j++)console_args.push(msg[j]);m_print.log.apply(this,console_args)}_telemetry_messages.splice(0)};exports.plot_telemetry=function(time){if(!time)time=1;var msg_by_id=
{};var start_time_ms=Math.max(0,performance.now()-time*1E3);for(var i=0;i<_telemetry_messages.length;i++){var msg=_telemetry_messages[i];var time=msg[0];if(time<start_time_ms)continue;for(var j=2;j<msg.length;j++){var id=String(msg[1]);if(msg.length>3)id+="_"+String(j-2);if(!msg_by_id[id])msg_by_id[id]=id+"\n";msg_by_id[id]+=String(time)+" "+msg[j]+"\n"}}var plot_str="";for(var id in msg_by_id)plot_str+=msg_by_id[id]+"\n\n";m_print.log(plot_str);_telemetry_messages.splice(0)};exports.check_browser=
function(name){var user_agent=navigator.userAgent.toLowerCase();var check_ua=function(name){if(user_agent.indexOf(name)>-1)return true;else return false};switch(name.toLowerCase()){case "chrome":return check_ua("mozilla")&&(check_ua("applewebkit")&&check_ua("chrome"));case "firefox":return check_ua("mozilla")&&(check_ua("gecko")&&check_ua("firefox"));case "msie":return check_ua("mozilla")&&(check_ua("trident")&&check_ua("msie"));case "opera":return check_ua("opera")&&check_ua("presto");case "safari":return check_ua("mozilla")&&
(check_ua("applewebkit")&&(check_ua("safari")&&!check_ua("chrome")));default:return false}};exports.check_finite=function(o){if(util.is_vector(o)){for(var i=0;i<o.length;i++)if(!isFinite(o[i]))return false;return Boolean(o.length)}else if(!isFinite(o))return false;else return true}};b4w.module["__extensions"]=function(exports,require){var m_print=require("__print");var _gl=null;var _ext_cache={};exports.setup_context=function(gl){_gl=gl};exports.get_s3tc=function(){var ext_s3tc=get("WEBGL_compressed_texture_s3tc")||(get("WEBKIT_WEBGL_compressed_texture_s3tc")||get("MOZ_WEBGL_compressed_texture_s3tc"));return ext_s3tc};exports.get_depth_texture=function(){var ext_dtex=get("WEBGL_depth_texture")||(get("WEBKIT_WEBGL_depth_texture")||get("MOZ_WEBGL_depth_texture"));return ext_dtex};
exports.get_aniso=function(){var ext_aniso=get("EXT_texture_filter_anisotropic")||(get("WEBKIT_EXT_texture_filter_anisotropic")||get("MOZ_EXT_texture_filter_anisotropic"));return ext_aniso};exports.get_debug_shaders=function(){var ext_ds=get("WEBGL_debug_shaders");return ext_ds};exports.get_renderer_info=function(){var ext_ri=get("WEBGL_debug_renderer_info");return ext_ri};exports.get_elem_index_uint=function(){var ext_elem_index_uint=get("OES_element_index_uint");return ext_elem_index_uint};exports.get_standard_derivatives=
function(){var ext_standard_derivatives=get("OES_standard_derivatives");return ext_standard_derivatives};function get(name){if(name in _ext_cache)return _ext_cache[name];var ext=_gl.getExtension(name)||null;_ext_cache[name]=ext;if(ext)var color="0a0";else var color="a00";m_print.log("%cGET EXTENSION","color: #"+color,name);return ext}exports.cleanup=function(){_ext_cache={}}};b4w.module["__graph"]=function(exports,require){var NULL_NODE=-1;var NULL=0;var FORWARD_DIR=10;var BACKWARD_DIR=20;var TWO_WAY=30;var _next_pair_cache=[NULL_NODE,NULL_NODE];exports.NULL_NODE=NULL_NODE;exports.FORWARD_DIR=FORWARD_DIR;exports.BACKWARD_DIR=BACKWARD_DIR;exports.TWO_WAY=TWO_WAY;exports.create=function(){var node_edge_arr=arguments;var nodes=[];var edges=[];for(var i=0;i<node_edge_arr.length;i++){var node_edge=node_edge_arr[i];switch(node_edge.length){case 2:nodes.push(node_edge[0],node_edge[1]);
break;case 3:edges.push(node_edge[0],node_edge[1],node_edge[2]);break;default:throw"Wrong graph constructor params";break}}var graph={nodes:nodes,edges:edges};return graph};exports.create_node_edge_arr=function(nodes_arr,edges_arr){var nodes=[];var edges=[];for(var i=0;i<nodes_arr.length;i++)nodes.push(nodes_arr[i][0],nodes_arr[i][1]);for(var i=0;i<edges_arr.length;i++)edges.push(edges_arr[i][0],edges_arr[i][1],edges_arr[i][2]);var graph={nodes:nodes,edges:edges};return graph};exports.append_node=
append_node;function append_node(graph,id,attr){if(!attr)attr=null;if(has_node(graph,id))throw"Graph already has node with given ID";else graph.nodes.push(id,attr)}exports.has_node=has_node;function has_node(graph,id){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i]==id)return true;return false}exports.append_edge=append_edge;function append_edge(graph,id1,id2,attr){if(!attr)attr=null;if(!has_node(graph,id1)||!has_node(graph,id2))throw"Wrong node IDs";else graph.edges.push(id1,id2,
attr)}exports.remove_node=remove_node;function remove_node(graph,id){if(!has_node(graph,id))throw"Node not found";var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i]==id){nodes.splice(i,2);i-=2}}exports.remove_edge=function(graph,id1,id2,edge_num){if(!has_edge(graph,id1,id2))throw"Edge not found";var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&edges[i+1]==id2){if(edge_num==-1)edges.splice(i,3);else{if(edge_num==count){edges.splice(i,3);break}count++}i-=
3}};exports.append_node_attr=function(graph,attr){if(node_by_attr(graph,attr)==NULL_NODE)append_node(graph,gen_node_id(graph),attr);else throw"Non-unique attribute";};exports.replace_edge_attr=function(graph,id1,id2,attr_old,attr_new){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&(edges[i+1]==id2&&edges[i+2]==attr_old))edges[i+2]=attr_new};exports.gen_node_id=gen_node_id;function gen_node_id(graph){var nodes=graph.nodes;var counter=-1;for(var i=0;i<nodes.length;i+=2)counter=
Math.max(counter,nodes[i]);return++counter}exports.node_by_attr=node_by_attr;function node_by_attr(graph,attr){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i+1]==attr)return nodes[i];return NULL_NODE}exports.append_edge_attr=function(graph,attr_node1,attr_node2,attr_edge){var id1=node_by_attr(graph,attr_node1);var id2=node_by_attr(graph,attr_node2);if(id1!=NULL_NODE&&id2!=NULL_NODE)append_edge(graph,id1,id2,attr_edge);else throw"Attributes not found";};exports.traverse=function(graph,
callback){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(callback(nodes[i],nodes[i+1]))break};exports.traverse_edges=function(graph,callback){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(callback(edges[i],edges[i+1],edges[i+2]))break};exports.traverse_inputs=function(graph,node,callback){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node){var node_in=edges[i];if(callback(node_in,get_node_attr(graph,node_in),edges[i+2]))return}};exports.traverse_outputs=
function(graph,node,callback){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==node){var node_out=edges[i+1];if(callback(node_out,get_node_attr(graph,node_out),edges[i+2]))return}};exports.topsort=topsort;function topsort(graph){var new_nodes=[];var visit_state={};set_unvisited(graph,visit_state);var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(in_edge_count(graph,nodes[i])==0)topsort_iter(graph,nodes[i],visit_state,new_nodes);var new_graph={nodes:new_nodes,edges:graph.edges.slice(0)};
return new_graph}function set_unvisited(graph,visit_state){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)visit_state[nodes[i]]=false}function topsort_iter(graph,node_id,visit_state,new_nodes){if(!visit_state[node_id]){visit_state[node_id]=true;for(var i=0;i<out_edge_count(graph,node_id);i++){var other=get_out_edge(graph,node_id,i);topsort_iter(graph,other,visit_state,new_nodes)}new_nodes.unshift(node_id,get_node_attr(graph,node_id))}}exports.topsort_attr=function(graph){var nodes=topsort(graph).nodes;
var result=[];for(var i=0;i<nodes.length;i+=2)result.push(nodes[i+1]);return result};exports.is_connected=function(graph){};exports.subgraph_node_conn=function(graph,node_id,dir){if(!has_node(graph,node_id))throw"No such node";var visit_state={};set_unvisited(graph,visit_state);subgraph_node_conn_iter(graph,node_id,visit_state,dir);var new_nodes=[];for(var id in visit_state)if(visit_state[id]){var id=Number(id);new_nodes.push(id,get_node_attr(graph,id))}var new_graph={nodes:new_nodes,edges:graph.edges.slice(0)};
cleanup_loose_edges(new_graph);return new_graph};function subgraph_node_conn_iter(graph,node_id,visit_state,dir){if(!visit_state[node_id]){visit_state[node_id]=true;if(dir==FORWARD_DIR||dir==TWO_WAY)for(var i=0;i<out_edge_count(graph,node_id);i++){var other=get_out_edge(graph,node_id,i);subgraph_node_conn_iter(graph,other,visit_state,dir)}if(dir==BACKWARD_DIR||dir==TWO_WAY)for(var i=0;i<in_edge_count(graph,node_id);i++){var other=get_in_edge(graph,node_id,i);subgraph_node_conn_iter(graph,other,visit_state,
dir)}}}function cleanup_loose_edges(graph){var nodes=graph.nodes;var edges=graph.edges;for(var i=0;i<edges.length;i+=3){var node1=edges[i];var node2=edges[i+1];if(!has_node(graph,node1)||!has_node(graph,node2)){edges.splice(i,3);i-=3}}}exports.get_source_nodes=function(graph){var result=[];var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2){var node=nodes[i];if(!in_edge_count(graph,node))result.push(node)}return result};exports.get_sink_nodes=function(graph){var result=[];var nodes=graph.nodes;
for(var i=0;i<nodes.length;i+=2){var node=nodes[i];if(!out_edge_count(graph,node))result.push(node)}return result};exports.match=function(graph1,graph2,node_comp,edge_comp){var state={};state.g1=gen_ordered_graph(graph1);state.g2=gen_ordered_graph(graph2);state.node_comp=node_comp||function(attr1,attr2){return attr1==attr2};state.edge_comp=edge_comp||function(attr1,attr2){return attr1==attr2};var n1=node_count(graph1);var n2=node_count(graph2);state.n1=n1;state.n2=n2;state.order=NULL;state.core_len=
state.orig_core_len=0;state.t1both_len=state.t1in_len=state.t1out_len=0;state.t2both_len=state.t2in_len=state.t2out_len=0;state.added_node1=NULL_NODE;state.core_1=Array(n1);state.core_2=Array(n2);state.in_1=new Array(n1);state.in_2=new Array(n2);state.out_1=new Array(n1);state.out_2=new Array(n2);state.share_count=[1];for(var i=0;i<n1;i++){state.core_1[i]=NULL_NODE;state.in_1[i]=0;state.out_1[i]=0}for(var i=0;i<n2;i++){state.core_2[i]=NULL_NODE;state.in_2[i]=0;state.out_2[i]=0}var c1=new Array(n1);
var c2=new Array(n1);var res=match_iter(c1,c2,state);if(res){for(var i=0;i<c1.length;i++){c1[i]=graph1.nodes[2*c1[i]];c2[i]=graph2.nodes[2*c2[i]]}return[c1,c2]}else return null};function node_count(graph){return graph.nodes.length/2}function gen_ordered_graph(graph){var nodes=graph.nodes;var edges=graph.edges;var new_nodes=[];var new_edges=[];var map=[];for(var i=0;i<nodes.length;i++){map[nodes[2*i]]=i;new_nodes.push(i,nodes[2*i+1])}for(var i=0;i<edges.length;i+=3)new_edges.push(map[edges[i]],map[edges[i+
1]],edges[i+2]);var new_graph={nodes:new_nodes,edges:new_edges};return new_graph}function match_iter(c1,c2,state){if(state_is_goal(state)){state_get_core_set(state,c1,c2);return true}if(state_is_dead(state))return false;var n1=NULL_NODE;var n2=NULL_NODE;var found=false;while(!found&&state_next_pair(state,_next_pair_cache,n1,n2)){var n1=_next_pair_cache[0];var n2=_next_pair_cache[1];if(state_is_feasible_pair(state,n1,n2)){var new_state=state_clone(state);state_add_pair(new_state,n1,n2);found=match_iter(c1,
c2,new_state);state_back_track(new_state)}}return found}function state_is_goal(state){return state.core_len==state.n1}function state_core_len(state){return state.core_len}function state_get_core_set(state,c1,c2){for(var i=0,j=0;i<state.n1;i++)if(state.core_1[i]!=NULL_NODE){c1[j]=i;c2[j]=state.core_1[i];j++}}function state_is_dead(state){return state.n1>state.n2||(state.t1both_len>state.t2both_len||(state.t1out_len>state.t2out_len||state.t1in_len>state.t2in_len))}function state_next_pair(state,next_pair,
prev_n1,prev_n2){if(prev_n1==NULL_NODE)prev_n1=0;if(prev_n2==NULL_NODE)prev_n2=0;else prev_n2++;var t1both_len=state.t1both_len;var t2both_len=state.t2both_len;var t1out_len=state.t1out_len;var t2out_len=state.t2out_len;var t1in_len=state.t1in_len;var t2in_len=state.t2in_len;var core_len=state.core_len;var n1=state.n1;var n2=state.n2;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;if(t1both_len>core_len&&t2both_len>
core_len)while(prev_n1<n1&&(core_1[prev_n1]!=NULL_NODE||(out_1[prev_n1]==0||in_1[prev_n1]==0))){prev_n1++;prev_n2=0}else if(t1out_len>core_len&&t2out_len>core_len)while(prev_n1<n1&&(core_1[prev_n1]!=NULL_NODE||out_1[prev_n1]==0)){prev_n1++;prev_n2=0}else if(t1in_len>core_len&&t2in_len>core_len)while(prev_n1<n1&&(core_1[prev_n1]!=NULL_NODE||in_1[prev_n1]==0)){prev_n1++;prev_n2=0}else if(prev_n1==0&&state.order!=NULL){var i=0;while(i<n1&&core_1[prev_n1=state.order[i]]!=NULL_NODE)i++;if(i==n1)prev_n1=
n1}else while(prev_n1<n1&&core_1[prev_n1]!=NULL_NODE){prev_n1++;prev_n2=0}if(t1both_len>core_len&&t2both_len>core_len)while(prev_n2<n2&&(core_2[prev_n2]!=NULL_NODE||(out_2[prev_n2]==0||in_2[prev_n2]==0)))prev_n2++;else if(t1out_len>core_len&&t2out_len>core_len)while(prev_n2<n2&&(core_2[prev_n2]!=NULL_NODE||out_2[prev_n2]==0))prev_n2++;else if(t1in_len>core_len&&t2in_len>core_len)while(prev_n2<n2&&(core_2[prev_n2]!=NULL_NODE||in_2[prev_n2]==0))prev_n2++;else while(prev_n2<n2&&core_2[prev_n2]!=NULL_NODE)prev_n2++;
if(prev_n1<n1&&prev_n2<n2){next_pair[0]=prev_n1;next_pair[1]=prev_n2;return true}return false}function state_is_feasible_pair(state,node1,node2){var g1=state.g1;var g2=state.g2;var n1=state.n1;var n2=state.n2;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;assert(node1<n1);assert(node2<n2);assert(core_1[node1]==NULL_NODE);assert(core_2[node2]==NULL_NODE);if(!compatible_node(state.node_comp,g1,node1,g2,node2))return false;
var termout1=0,termout2=0,termin1=0,termin2=0,new1=0,new2=0;for(var i=0;i<out_edge_count(g1,node1);i++){var other1=get_out_edge(g1,node1,i);if(core_1[other1]!=NULL_NODE){var other2=core_1[other1];if(!has_edge(g2,node2,other2)||!compatible_edge(state.edge_comp,g1,node1,other1,g2,node2,other2))return false}else{if(in_1[other1])termin1++;if(out_1[other1])termout1++;if(!in_1[other1]&&!out_1[other1])new1++}}for(var i=0;i<in_edge_count(g1,node1);i++){var other1=get_in_edge(g1,node1,i);if(core_1[other1]!=
NULL_NODE){var other2=core_1[other1];if(!has_edge(g2,other2,node2)||!compatible_edge(state.edge_comp,g1,other1,node1,g2,other2,node2))return false}else{if(in_1[other1])termin1++;if(out_1[other1])termout1++;if(!in_1[other1]&&!out_1[other1])new1++}}for(var i=0;i<out_edge_count(g2,node2);i++){var other2=get_out_edge(g2,node2,i);if(core_2[other2]!=NULL_NODE){var other1=core_2[other2];if(!has_edge(g1,node1,other1))return false}else{if(in_2[other2])termin2++;if(out_2[other2])termout2++;if(!in_2[other2]&&
!out_2[other2])new2++}}for(var i=0;i<in_edge_count(g2,node2);i++){var other2=get_in_edge(g2,node2,i);if(core_2[other2]!=NULL_NODE){var other1=core_2[other2];if(!has_edge(g1,other1,node1))return false}else{if(in_2[other2])termin2++;if(out_2[other2])termout2++;if(!in_2[other2]&&!out_2[other2])new2++}}return termin1<=termin2&&(termout1<=termout2&&new1<=new2)}function assert(expr){if(!expr)throw"Assertion failed";}function compatible_node(node_comp,graph1,node1,graph2,node2){if(node_comp(get_node_attr(graph1,
node1),get_node_attr(graph2,node2)))return true;else return false}exports.get_node_attr=get_node_attr;function get_node_attr(graph,node){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i]==node)return nodes[i+1];return null}exports.out_edge_count=out_edge_count;function out_edge_count(graph,node){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==node)count++;return count}exports.in_edge_count=in_edge_count;function in_edge_count(graph,node){var edges=graph.edges;
var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node)count++;return count}exports.get_out_edge=get_out_edge;function get_out_edge(graph,node,num){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==node){if(count==num)return edges[i+1];count++}return NULL_NODE}exports.get_in_edge=get_in_edge;function get_in_edge(graph,node,num){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node){if(count==num)return edges[i];count++}return NULL_NODE}
function has_edge(graph,node1,node2){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==node1&&edges[i+1]==node2)return true;return false}function compatible_edge(edge_comp,graph1,node11,node12,graph2,node21,node22){var graph1_edge_count=get_edge_count(graph1,node11,node12);var graph2_edge_count=get_edge_count(graph2,node21,node22);for(var i=0;i<graph1_edge_count;i++){var edge_match=false;for(var j=0;j<graph2_edge_count;j++)if(edge_comp(get_edge_attr(graph1,node11,node12,i),get_edge_attr(graph2,
node21,node22,j))){edge_match=true;break}if(!edge_match)return false}return true}exports.get_edge_count=get_edge_count;function get_edge_count(graph,node1,node2){var count=0;var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==node1&&edges[i+1]==node2)count++;return count}exports.get_edge_attr=get_edge_attr;function get_edge_attr(graph,node1,node2,num){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==node1&&edges[i+1]==node2){if(count==num)return edges[i+
2];count++}return null}function state_add_pair(state,node1,node2){var g1=state.g1;var g2=state.g2;var n1=state.n1;var n2=state.n2;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;assert(node1<n1);assert(node2<n2);assert(state.core_len<n1);assert(state.core_len<n2);var core_len=++state.core_len;state.added_node1=node1;if(!in_1[node1]){in_1[node1]=core_len;state.t1in_len++;if(out_1[node1])state.t1both_len++}if(!out_1[node1]){out_1[node1]=
core_len;state.t1out_len++;if(in_1[node1])state.t1both_len++}if(!in_2[node2]){in_2[node2]=core_len;state.t2in_len++;if(out_2[node2])state.t2both_len++}if(!out_2[node2]){out_2[node2]=core_len;state.t2out_len++;if(in_2[node2])state.t2both_len++}core_1[node1]=node2;core_2[node2]=node1;for(var i=0;i<in_edge_count(g1,node1);i++){var other=get_in_edge(g1,node1,i);if(!in_1[other]){in_1[other]=core_len;state.t1in_len++;if(out_1[other])state.t1both_len++}}for(var i=0;i<out_edge_count(g1,node1);i++){var other=
get_out_edge(g1,node1,i);if(!out_1[other]){out_1[other]=core_len;state.t1out_len++;if(in_1[other])state.t1both_len++}}for(var i=0;i<in_edge_count(g2,node2);i++){var other=get_in_edge(g2,node2,i);if(!in_2[other]){in_2[other]=core_len;state.t2in_len++;if(out_2[other])state.t2both_len++}}for(var i=0;i<out_edge_count(g2,node2);i++){var other=get_out_edge(g2,node2,i);if(!out_2[other]){out_2[other]=core_len;state.t2out_len++;if(in_2[other])state.t2both_len++}}}function state_back_track(state){assert(state.core_len-
state.orig_core_len<=1);assert(state.added_node1!=NULL_NODE);var g1=state.g1;var g2=state.g2;var core_len=state.core_len;var added_node1=state.added_node1;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;if(state.orig_core_len<core_len){if(in_1[added_node1]==core_len)in_1[added_node1]=0;for(var i=0;i<in_edge_count(g1,added_node1);i++){var other=get_in_edge(g1,added_node1,i);if(in_1[other]==core_len)in_1[other]=0}if(out_1[added_node1]==
core_len)out_1[added_node1]=0;for(var i=0;i<out_edge_count(g1,added_node1);i++){var other=get_out_edge(g1,added_node1,i);if(out_1[other]==core_len)out_1[other]=0}var node2=core_1[added_node1];if(in_2[node2]==core_len)in_2[node2]=0;for(var i=0;i<in_edge_count(g2,node2);i++){var other=get_in_edge(g2,node2,i);if(in_2[other]==core_len)in_2[other]=0}if(out_2[node2]==core_len)out_2[node2]=0;for(var i=0;i<out_edge_count(g2,node2);i++){var other=get_out_edge(g2,node2,i);if(out_2[other]==core_len)out_2[other]=
0}core_1[added_node1]=NULL_NODE;core_2[node2]=NULL_NODE;state.core_len=state.orig_core_len;state.added_node1=NULL_NODE}}function state_clone(state){var new_state={};new_state.g1=state.g1;new_state.g2=state.g2;new_state.node_comp=state.node_comp;new_state.edge_comp=state.edge_comp;new_state.n1=state.n1;new_state.n2=state.n2;new_state.order=state.order;new_state.core_len=new_state.orig_core_len=state.core_len;new_state.t1in_len=state.t1in_len;new_state.t1out_len=state.t1out_len;new_state.t1both_len=
state.t1both_len;new_state.t2in_len=state.t2in_len;new_state.t2out_len=state.t2out_len;new_state.t2both_len=state.t2both_len;new_state.added_node1=NULL_NODE;new_state.core_1=state.core_1;new_state.core_2=state.core_2;new_state.in_1=state.in_1;new_state.in_2=state.in_2;new_state.out_1=state.out_1;new_state.out_2=state.out_2;new_state.share_count=state.share_count;state.share_count[0]+=1;return new_state}exports.replace=function(graph,rnode_ids,new_node_attr){var nodes=graph.nodes;var edges=graph.edges;
var new_node_id=gen_node_id(graph);for(var i=0;i<rnode_ids.length;i++){var rnode_id=rnode_ids[i];remove_node(graph,rnode_id);for(var j=0;j<edges.length;j+=3){if(edges[j]==rnode_id)edges[j]=new_node_id;if(edges[j+1]==rnode_id)edges[j+1]=new_node_id;if(edges[j]==edges[j+1]){edges.splice(j,3);j-=3}}}append_node(graph,new_node_id,new_node_attr)};exports.debug_dot=function(graph,label_cb){var nodes=graph.nodes;var edges=graph.edges;var dot_str="digraph debug {\n";dot_str+="    ";dot_str+="node [shape=box];\n";
for(var i=0;i<nodes.length;i+=2){var node=nodes[i];var attr=nodes[i+1];var label=label_cb?label_cb(node,attr):String(node);dot_str+="    ";dot_str+=String(node)+' [label="'+label.replace(/\"/g,'\\"')+'"];\n'}for(var i=0;i<edges.length;i+=3){var node1=edges[i];var node2=edges[i+1];dot_str+="    ";dot_str+=String(node1)+" -> "+String(node2)+";\n"}dot_str+="}";return dot_str}};b4w.module["__ipc"]=function(exports,require){var IN_COLLISION=1;var IN_COLLISION_IMPULSE=2;var IN_ERROR=3;var IN_FBMSG=4;var IN_FLOATER_BOB_TRANSFORM=5;var IN_FRAME_END=6;var IN_LOG=7;var IN_PROP_OFFSET=8;var IN_RAY_HIT=9;var IN_TRANSFORM=10;var IN_VEHICLE_SPEED=11;var IN_PING=12;exports.IN_COLLISION=IN_COLLISION;exports.IN_COLLISION_IMPULSE=IN_COLLISION_IMPULSE;exports.IN_ERROR=IN_ERROR;exports.IN_FBMSG=IN_FBMSG;exports.IN_FLOATER_BOB_TRANSFORM=IN_FLOATER_BOB_TRANSFORM;exports.IN_FRAME_END=IN_FRAME_END;
exports.IN_LOG=IN_LOG;exports.IN_PROP_OFFSET=IN_PROP_OFFSET;exports.IN_RAY_HIT=IN_RAY_HIT;exports.IN_TRANSFORM=IN_TRANSFORM;exports.IN_VEHICLE_SPEED=IN_VEHICLE_SPEED;exports.IN_PING=IN_PING;exports.OUT_ACTIVATE=1001;exports.OUT_ADD_BOAT_BOB=1002;exports.OUT_ADD_CAR_WHEEL=1003;exports.OUT_ADD_FLOATER_BOB=1004;exports.OUT_APPEND_BOUNDING_BODY=1006;exports.OUT_APPEND_BOAT=1007;exports.OUT_APPEND_CAR=1008;exports.OUT_APPEND_CHARACTER=1009;exports.OUT_APPEND_COLLISION_TEST=1010;exports.OUT_APPEND_CONSTRAINT=
1011;exports.OUT_APPEND_FLOATER=1012;exports.OUT_APPEND_GHOST_MESH_BODY=1013;exports.OUT_APPEND_STATIC_MESH_BODY=1014;exports.OUT_APPEND_WATER=1015;exports.OUT_APPEND_WORLD=1016;exports.OUT_APPLY_CENTRAL_FORCE=1017;exports.OUT_APPLY_COLLISION_IMPULSE_TEST=1018;exports.OUT_APPLY_TORQUE=1019;exports.OUT_CHARACTER_JUMP=1020;exports.OUT_CHARACTER_ROTATION_INCREMENT=1021;exports.OUT_CLEANUP=1022;exports.OUT_CLEAR_COLLISION_IMPULSE_TEST=1023;exports.OUT_DISABLE_SIMULATION=1024;exports.OUT_ENABLE_SIMULATION=
1025;exports.OUT_FRAME_START=1026;exports.OUT_PAUSE=1027;exports.OUT_RAY_TEST=1028;exports.OUT_REMOVE_COLLISION_TEST=1029;exports.OUT_REMOVE_CONSTRAINT=1030;exports.OUT_RESUME=1031;exports.OUT_SET_ACTIVE_WORLD=1032;exports.OUT_SET_CHARACTER_FLY_VELOCITY=1033;exports.OUT_SET_CHARACTER_HOR_ROTATION=1034;exports.OUT_SET_CHARACTER_MOVE_DIR=1035;exports.OUT_SET_CHARACTER_MOVE_TYPE=1036;exports.OUT_SET_CHARACTER_ROTATION=1037;exports.OUT_SET_CHARACTER_RUN_VELOCITY=1038;exports.OUT_SET_CHARACTER_VERT_ROTATION=
1039;exports.OUT_SET_CHARACTER_WALK_VELOCITY=1040;exports.OUT_SET_GRAVITY=1041;exports.OUT_SET_LINEAR_VELOCITY=1042;exports.OUT_SET_TRANSFORM=1043;exports.OUT_SET_WATER_TIME=1044;exports.OUT_ADD_WATER_WRAPPER=1045;exports.OUT_UPDATE_BOAT_CONTROLS=1047;exports.OUT_UPDATE_CAR_CONTROLS=1048;exports.OUT_PING=1049;exports.OUT_DEBUG=1050;var OUT_SET_TRANSFORM=exports.OUT_SET_TRANSFORM;var _worker=null;var _worker_msg_cache={};var _msg_cache={};_msg_cache[IN_TRANSFORM]={"msg_id":null,"body_id":null,"time":null,
"trans":new Float32Array(3),"quat":new Float32Array(4),"linvel":new Float32Array(3),"angvel":new Float32Array(3)};_msg_cache[IN_PROP_OFFSET]={"msg_id":null,"chassis_hull_body_id":null,"prop_ind":null,"trans":new Float32Array(3),"quat":new Float32Array(4)};_msg_cache[IN_RAY_HIT]={"msg_id":null,"body_id":null,"from":new Float32Array(3),"to":new Float32Array(3),"local":null,"body_id_b_hit":null,"cur_result":null};_msg_cache[IN_COLLISION]={"msg_id":null,"body_id_a":null,"body_id_b":null,"result":null,
"coll_point":new Float32Array(3)};_msg_cache[OUT_SET_TRANSFORM]={"msg_id":null,"body_id":null,"trans":new Float32Array(3),"quat":new Float32Array(4)};var _patterns={};_patterns[IN_TRANSFORM]=["msg_id",1,"body_id",1,"time",1,"trans",3,"quat",4,"linvel",3,"angvel",3];_patterns[IN_PROP_OFFSET]=["msg_id",1,"chassis_hull_body_id",1,"prop_ind",1,"trans",3,"quat",4];_patterns[IN_RAY_HIT]=["msg_id",1,"body_id",1,"from",3,"to",3,"local",1,"body_id_b_hit",1,"cur_result",1];_patterns[IN_COLLISION]=["msg_id",
1,"body_id_a",1,"body_id_b",1,"result",1,"coll_point",3];_patterns[OUT_SET_TRANSFORM]=["msg_id",1,"body_id",1,"trans",3,"quat",4];var _cached_data={};exports.init=function(worker,process_message_cb){worker.addEventListener("message",function(event){var msg_id=event.data[0];if(msg_id in _patterns)var data=process_raw_data(event.data);else var data=event.data;process_message_cb(msg_id,data)},false);_worker=worker};exports.cleanup=function(){_worker=null;_worker_msg_cache={}};exports.post_msg=function(){var msg_id=
arguments[0];if(msg_id in _patterns){var data=zip_row_data(msg_id);if(!(msg_id in _worker_msg_cache))_worker_msg_cache[msg_id]=data;var msg=_worker_msg_cache[msg_id]}else{var msg_len=arguments.length;if(!(msg_id in _worker_msg_cache)){_worker_msg_cache[msg_id]=Array(msg_len);_worker_msg_cache[msg_id][0]=msg_id}var msg=_worker_msg_cache[msg_id];for(var i=1;i<msg_len;i++)msg[i]=arguments[i]}_worker.postMessage(msg)};exports.get_msg_cache=function(msg_id){return _msg_cache[msg_id]};function process_raw_data(raw_data){var msg_id=
raw_data[0];var msg_cache=_msg_cache[msg_id];var pattern=_patterns[msg_id];var elem_pos=0;for(var i=0;i<pattern.length;i+=2){var prop=pattern[i];var elem_length=pattern[i+1];var new_elem_pos=elem_pos+elem_length;if(elem_length==1)msg_cache[prop]=raw_data[elem_pos];else for(var j=0;j<elem_length;j++)msg_cache[prop][j]=raw_data[elem_pos+j];elem_pos=new_elem_pos}return msg_cache}function zip_row_data(msg_id){var msg_cache=_msg_cache[msg_id];var pattern=_patterns[msg_id];var elem_pos=0;if(!(msg_id in
_cached_data)){var raw_data_length=0;for(var i=1;i<pattern.length;i+=2)raw_data_length+=pattern[i];_cached_data[msg_id]=new Float32Array(raw_data_length)}var raw_data=_cached_data[msg_id];for(var i=0;i<pattern.length;i+=2){var cur_elem=msg_cache[pattern[i]];var elem_length=pattern[i+1];if(elem_length==1)raw_data[elem_pos]=cur_elem;else raw_data.set(cur_elem,elem_pos);elem_pos+=elem_length}return raw_data}};b4w.module["__hud"]=function(exports,require){var m_graph=require("__graph");var START_POINT_X=30;var START_POINT_Y=80;var LINE_WIDTH=20;var _canvas_context=null;var _carriage=[0,0];exports.init=function(canvas_elem){var ctx=canvas_elem.getContext("2d");set_style(ctx);_canvas_context=ctx;return ctx};function set_style(ctx){ctx.font="bold 15px Courier";ctx.textBaseline="middle";ctx.shadowBlur=0;ctx.shadowColor=null}exports.update_dim=function(){if(_canvas_context)set_style(_canvas_context)};exports.reset=
function(){var ctx=_canvas_context;if(!ctx)return;ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.fillStyle="rgba(0,0,0,0.5)";ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);reset_carriage()};exports.show_debug_info=function(scenes,elapsed){var ctx=_canvas_context;if(!ctx)return;ctx.textAlign="left";ctx.fillStyle="rgba(0,255,0,255)";print(" FPS",(1/elapsed).toFixed(2));new_line();var sum_bundles=0;var sum_rcalls=0;for(var i=0;i<scenes.length;i++){var sum=show_debug_info_scene(scenes[i]);
sum_bundles+=sum[0];sum_rcalls+=sum[1];new_line()}print(" ---------------------------------------------");print("    ","TOTAL ACTIVE","","",sum_rcalls,"of",sum_bundles)};function show_debug_info_scene(scene){print(' SCENE "'+scene["name"]+'"');if(!scene._render){print("No INFO");return}var sum_bundles=0;var sum_rcalls=0;var next_slot=2;var graph=scene._render.graph;m_graph.traverse(graph,function(node,attr){var subs=attr;if(subs.type=="SINK"){print(" (F)",subs.type);return}var type=subs.type;var size=
Math.round(subs.camera.width)+"x"+Math.round(subs.camera.height);var bundles=subs.bundles.length;var rcalls=subs.debug_render_calls;var lights=subs.lights.length;var is_active=subs.enqueue&&subs.do_render;if(is_active)print(" (A)",type,lights,size,rcalls,"of",bundles);else print(" (P)",type,lights,size,rcalls,"of",bundles);subs.debug_render_calls=0;if(is_active){sum_bundles+=bundles;sum_rcalls+=rcalls}});return[sum_bundles,sum_rcalls]}function reset_carriage(){_carriage[0]=0;_carriage[1]=0}function new_line(){_carriage[0]++}
exports.print=function(){var ctx=_canvas_context;if(!ctx)return;ctx.textAlign="left";ctx.fillStyle="rgba(0,255,0,255)";print.apply(Math,arguments)};function print(){var x=START_POINT_X;var y=START_POINT_Y+_carriage[0]*LINE_WIDTH;var OFFSETS=[5,18,2,10,4,3,5];var text=arguments[0];for(var i=1;i<arguments.length;i++){var arg=arguments[i];var num_spaces=OFFSETS[i]-String(arg).length;text+=spaces(num_spaces)+arguments[i]}new_line();_canvas_context.fillText(text,x,y)}function spaces(n){var s="";for(var i=
0;i<n;i++)s+=" ";return s}function wrap_text(context,text,x,y,maxWidth,lineHeight){var words=text.split(" ");var line="";for(var n=0;n<words.length;n++){var testLine=line+words[n]+" ";var metrics=context.measureText(testLine);var testWidth=metrics.width;if(testWidth>maxWidth){context.fillText(line,x,y);line=words[n]+" ";y+=lineHeight}else line=testLine}context.fillText(line,x,y)}exports.plot_array=function(header,slot,arr,arg_min,arg_max,val_min,val_max){var ctx=_canvas_context;if(!ctx)return;var box=
create_strip_box(slot);box_split_v(box,4,5,box);ctx.textAlign="center";ctx.fillStyle="#00FF00";_canvas_context.fillText(header,box_mid_h(box),box.y-10);ctx.strokeStyle="#00FF00";ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(box.x,box.y);ctx.lineTo(box.x+box.w,box.y);ctx.lineTo(box.x+box.w,box.y+box.h);ctx.lineTo(box.x,box.y+box.h);ctx.closePath();ctx.stroke();if(!val_min&&!val_max){val_min=1E6;val_max=-1E6;for(var i=0;i<arr.length;i++){val_min=Math.min(val_min,arr[i]);val_max=Math.max(val_max,arr[i])}}ctx.textAlign=
"right";_canvas_context.fillText(String(val_min),box.x-10,box.y+box.h);_canvas_context.fillText(String(val_max),box.x-10,box.y);ctx.textAlign="center";_canvas_context.fillText(String(arg_min),box.x,box.y+box.h+15);_canvas_context.fillText(String(arg_max),box.x+box.w,box.y+box.h+15);ctx.strokeStyle="#FF0000";ctx.lineWidth=1.5;ctx.beginPath();var dx=box.w/(arr.length-1);var dy=box.h/(val_max-val_min);for(var i=0;i<arr.length;i++){var x=box.x+dx*i;var y=box.y+box.h-(arr[i]-val_min)*dy;if(i==0)ctx.moveTo(x,
y);else ctx.lineTo(x,y)}ctx.stroke()};function box_create(){return{x:0,y:0,w:0,h:0}}function box_set(x,y,w,h,dest){dest.x=x;dest.y=y;dest.w=w;dest.h=h;return dest}function box_split_h(box,part,parts,dest){var dw=box.w/parts;dest.x=box.x+dw*part;dest.y=box.y;dest.w=dw;dest.h=box.h;return dest}function box_split_v(box,part,parts,dest){var dh=box.h/parts;dest.x=box.x;dest.y=box.y+dh*part;dest.w=box.w;dest.h=dh;return dest}function box_trim_h(box,ratio,dest){var dw=box.w*ratio;dest.x=box.x+dw;dest.y=
box.y;dest.w=box.w-2*dw;dest.h=box.h;return dest}function box_trim_v(box,ratio,dest){var dh=box.h*ratio;dest.x=box.x;dest.y=box.y+dh;dest.w=box.w;dest.h=box.h-2*dh;return dest}function box_mid_h(box){return box.x+box.w/2}function box_mid_v(box){return box.y+box.h/2}function box_debug_draw(box){var ctx=_canvas_context;var ss=ctx.strokeStyle;var lw=ctx.lineWidth;ctx.strokeStyle="#FF0000";ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(box.x,box.y);ctx.lineTo(box.x+box.w,box.y);ctx.lineTo(box.x+box.w,box.y+
box.h);ctx.lineTo(box.x,box.y+box.h);ctx.closePath();ctx.stroke();ctx.strokeStyle=ss;ctx.lineWidth=lw}function create_strip_box(slot){var ctx=_canvas_context;var box=box_create();box_set(0,0,ctx.canvas.width,ctx.canvas.height,box);box_trim_h(box,0.01,box);box_trim_v(box,0.02,box);box_split_h(box,slot,8,box);box_trim_h(box,0.02,box);return box}exports.draw_mixer_strip=function(id,is_active,slot,params,active_param,mute,solo){var ctx=_canvas_context;if(!ctx)return;ctx.textAlign="center";ctx.fillStyle=
"#00FF00";ctx.font="bold 12px Courier";var box_strip=create_strip_box(slot);var strip_title=is_active?"["+id+"]":id;_canvas_context.fillText(strip_title,box_mid_h(box_strip),box_strip.y);if(mute>=0)_canvas_context.fillText(mute?"[M]":"[ ]",box_mid_h(box_strip)-15,box_strip.y+30);if(solo>=0)_canvas_context.fillText(solo?"[S]":"[ ]",box_mid_h(box_strip)+15,box_strip.y+30);var box_param=box_create();for(var i=0;i<params.length;i++){var param=params[i];var is_volume=param[0]=="VOLUME";if(is_volume)box_set(box_strip.x,
box_strip.y+350,box_strip.w,250,box_param);else box_set(box_strip.x,box_strip.y+10+50*i,box_strip.w,box_strip.h,box_param);draw_param_bar(ctx,is_volume,box_param,param,i==active_param)}};function draw_param_bar(ctx,vertical,box,param,is_active){var name=param[0];var value=param[1];var min=param[2];var max=param[3];var steps=param[4];var is_log=param[5];var step=(max-min)/steps;if(step<1)var digits=Math.floor(1/step-1E-5).toFixed(0).length;else var digits=0;if(is_log)var val_pos_factor=Math.log(value/
min)/Math.log(max/min);else var val_pos_factor=(value-min)/(max-min);ctx.textAlign="center";if(is_active)ctx.fillText("["+name+"]",box_mid_h(box),box.y);else ctx.fillText(name,box_mid_h(box),box.y);ctx.strokeStyle="#00FF00";if(vertical)ctx.lineWidth=3;else ctx.lineWidth=1;if(vertical){ctx.textAlign="right";ctx.fillText(max.toFixed(digits),box_mid_h(box)-10,box.y+15);ctx.textAlign="right";ctx.fillText(min.toFixed(digits),box_mid_h(box)-10,box.y+box.h-15)}else{ctx.textAlign="right";ctx.fillText(min.toFixed(digits),
box.x+28,box.y+15);ctx.textAlign="left";ctx.fillText(max.toFixed(digits),box.x+box.w-28,box.y+15)}ctx.beginPath();if(vertical){var val_pos_y=box.y+15+(box.h-30)*(1-val_pos_factor);ctx.moveTo(box_mid_h(box),box.y+15);ctx.lineTo(box_mid_h(box),box.y+box.h-15);ctx.moveTo(box_mid_h(box)-5,box.y+15);ctx.lineTo(box_mid_h(box)+5,box.y+15);ctx.moveTo(box_mid_h(box)-5,box.y+box.h-15);ctx.lineTo(box_mid_h(box)+5,box.y+box.h-15);ctx.moveTo(box_mid_h(box)-5,val_pos_y);ctx.lineTo(box_mid_h(box)+5,val_pos_y)}else{var val_pos_x=
box.x+30+(box.w-60)*val_pos_factor;ctx.moveTo(box.x+30,box.y+15);ctx.lineTo(box.x+box.w-30,box.y+15);ctx.moveTo(box.x+30,box.y+15-5);ctx.lineTo(box.x+30,box.y+15+5);ctx.moveTo(box.x+box.w-30,box.y+15-5);ctx.lineTo(box.x+box.w-30,box.y+15+5);ctx.moveTo(val_pos_x,box.y+15-5);ctx.lineTo(val_pos_x,box.y+15+5)}ctx.stroke();if(name=="EQ_Q"){var Q=value;var Y=1+1/(2*Q*Q)+Math.sqrt((2+1/(Q*Q))*(2+1/(Q*Q))/4-1);var N=Math.log(Y)/Math.log(2);if(vertical){ctx.textAlign="left";ctx.fillText(value.toFixed(digits),
box_mid_h(box)+10,val_pos_y);ctx.textAlign="left";ctx.fillText("("+N.toFixed(digits+1)+")",box_mid_h(box)+10,val_pos_y+10)}else{ctx.textAlign="right";ctx.fillText(value.toFixed(digits),val_pos_x,box.y+30);ctx.textAlign="left";ctx.fillText("("+N.toFixed(digits+1)+")",val_pos_x,box.y+30)}}else if(vertical){ctx.textAlign="left";ctx.fillText(value.toFixed(digits),box_mid_h(box)+10,val_pos_y)}else{ctx.textAlign="center";ctx.fillText(value.toFixed(digits),val_pos_x,box.y+30)}}};b4w.module["__renderer"]=function(exports,require){var config=require("__config");var debug=require("__debug");var m_textures=require("__textures");var cfg_def=config.defaults;var _gl=null;var USE_BACKFACE_CULLING=true;var DEBUG_DISABLE_RENDER_LOCK=false;var SHADOW_BG_COLOR=[1,1,1,1];var DEPTH_BG_COLOR=[1,1,1,1];var COLOR_PICKING_BG_COLOR=[0,0,0,1];var GLOW_MASK_BG_COLOR=[0,0,0,0];var FLOAT_BYTE_SIZE=4;var _render_lock=false;var _ivec4_tmp=new Uint8Array(4);var _subpixel_index=0;var CUBEMAP_BOTTOM_SIDE=
0;var CUBEMAP_UPPER_SIDE=1;var JITTER=[new Float32Array([0.25,-0.25]),new Float32Array([-0.25,0.25])];var SUBSAMPLE_IND=[new Float32Array([1,1,1,0]),new Float32Array([2,2,2,0])];exports.setup_context=function(gl){var bc=cfg_def.background_color;gl.clearColor(bc[0],bc[1],bc[2],bc[3]);gl.clearDepth(1);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LEQUAL);if(USE_BACKFACE_CULLING){gl.enable(gl.CULL_FACE);gl.frontFace(gl.CCW);gl.cullFace(gl.BACK)}else gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,
gl.ONE_MINUS_SRC_ALPHA);_gl=gl};exports.draw=function(subscene){if(!subscene.do_render)return;prepare_subscene_render(subscene);var camera=subscene.camera;var bundles=subscene.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];if(bundle.do_render){var obj_render=bundle.obj_render;var batch=bundle.batch;draw_bundle(subscene,camera,obj_render,batch)}}debug.check_gl("draw subscene: "+subscene.type);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)};function prepare_subscene_render(subscene){var camera=
subscene.camera;_gl.bindFramebuffer(_gl.FRAMEBUFFER,camera.framebuffer);if(subscene.assign_texture){var tex=camera.color_attachment;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,tex.w_target,tex.w_texture,0)}_gl.viewport(0,0,camera.width,camera.height);clear(subscene);if(subscene.blend)_gl.enable(_gl.BLEND);else _gl.disable(_gl.BLEND);if(subscene.depth_test)_gl.enable(_gl.DEPTH_TEST);else _gl.disable(_gl.DEPTH_TEST);if(subscene.need_perm_uniforms_update){update_subs_permanent_uniforms(subscene);
subscene.need_perm_uniforms_update=false}switch(subscene.type){case "SHADOW_CAST":_gl.enable(_gl.POLYGON_OFFSET_FILL);_gl.polygonOffset(1,1);_gl.cullFace(_gl.BACK);break;case "MAIN_REFLECT":_gl.disable(_gl.POLYGON_OFFSET_FILL);_gl.cullFace(_gl.FRONT);break;case "SMAA_BLENDING_WEIGHT_CALCULATION":var s_index=SUBSAMPLE_IND[_subpixel_index];subscene.jitter_subsample_ind=s_index;_gl.disable(_gl.POLYGON_OFFSET_FILL);_gl.cullFace(_gl.BACK);break;default:_gl.disable(_gl.POLYGON_OFFSET_FILL);_gl.cullFace(_gl.BACK)}if(cfg_def.smaa)setup_smaa_jitter(subscene)}
exports.clear=clear;function clear(subscene){if(subscene){var bitfield=(subscene.clear_color?_gl.COLOR_BUFFER_BIT:0)|(subscene.clear_depth?_gl.DEPTH_BUFFER_BIT:0);if(!bitfield)return;switch(subscene.type){case "SHADOW_CAST":var bc=SHADOW_BG_COLOR;break;case "DEPTH":var bc=DEPTH_BG_COLOR;break;case "SHORE_SMOOTHING":var bc=SHADOW_BG_COLOR;break;case "COLOR_PICKING":var bc=COLOR_PICKING_BG_COLOR;break;case "GLOW_MASK":var bc=GLOW_MASK_BG_COLOR;break;default:var bc=cfg_def.background_color;break}}else{var bitfield=
_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT;var bc=cfg_def.background_color}_gl.colorMask(true,true,true,true);_gl.depthMask(true);_gl.clearColor(bc[0],bc[1],bc[2],bc[3]);_gl.clear(bitfield)}function setup_smaa_jitter(subscene){var jitter=JITTER[_subpixel_index];var camera=subscene.camera;subscene.jitter_projection_space[0]=jitter[0]*2/camera.width;subscene.jitter_projection_space[1]=jitter[1]*2/camera.height}function draw_bundle(subscene,camera,obj_render,batch){var shader=batch.shader;if(!shader.transient_uniform_setters)assign_uniform_setters(shader);
_gl.useProgram(shader.program);var bufs_data=batch.bufs_data;var uniforms=shader.uniforms;var transient_uniform_setters=shader.transient_uniform_setters;var transient_uniform_names=shader.transient_uniform_names;var i=transient_uniform_names.length;while(i--){var uni=transient_uniform_names[i];transient_uniform_setters[uni](_gl,uniforms[uni],subscene,obj_render,batch,camera)}var cm=batch.color_mask;_gl.colorMask(cm,cm,cm,cm);_gl.depthMask(batch.depth_mask);if(USE_BACKFACE_CULLING)if(batch.use_backface_culling)_gl.enable(_gl.CULL_FACE);
else _gl.disable(_gl.CULL_FACE);setup_textures(batch.textures,batch.texture_names,uniforms);if(subscene.type=="SKY")draw_sky_buffers(subscene,bufs_data,shader,obj_render);else draw_buffers(bufs_data,shader,obj_render.va_frame);subscene.debug_render_calls++}function draw_sky_buffers(subscene,bufs_data,shader,obj_render){var camera=subscene.camera;var uniforms=shader.uniforms;var v_matrs=subscene.cube_view_matrices;for(var i=0;i<6;i++){_gl.uniformMatrix4fv(uniforms["u_cube_view_matrix"],false,v_matrs[i]);
var w_target=get_cube_target_by_id(i);var color_attachment=camera.color_attachment;var w_tex=color_attachment.w_texture;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_tex,0);draw_buffers(bufs_data,shader,obj_render.va_frame);if(subscene.need_fog_update&&i!=CUBEMAP_BOTTOM_SIDE)update_subs_sky_fog(subscene,i)}subscene.debug_render_calls++}function update_subs_sky_fog(subscene,cubemap_side_ind){var col=_ivec4_tmp;_gl.readPixels(191,191,1,1,_gl.RGBA,_gl.UNSIGNED_BYTE,col);if(col[0]==
255||(col[1]==255||col[2]==255))_gl.readPixels(191,220,1,1,_gl.RGBA,_gl.UNSIGNED_BYTE,col);var res_r=col[0];var res_g=col[1];var res_b=col[2];res_r/=255;res_g/=255;res_b/=255;if(cubemap_side_ind===CUBEMAP_UPPER_SIDE){subscene.cube_fog[3]=res_r;subscene.cube_fog[7]=res_g;subscene.cube_fog[11]=res_b}else{subscene.cube_fog[4*(cubemap_side_ind-2)]=res_r;subscene.cube_fog[4*(cubemap_side_ind-2)+1]=res_g;subscene.cube_fog[4*(cubemap_side_ind-2)+2]=res_b}}function setup_float_attribute(attributes,name,value){var attribute_loc=
attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib1f(attribute_loc,value)}function setup_vec2_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib2fv(attribute_loc,value)}function setup_vec3_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib3fv(attribute_loc,value)}function setup_vec4_attribute(attributes,name,value){var attribute_loc=attributes[name];
if(attribute_loc==undefined)return;_gl.vertexAttrib4fv(attribute_loc,value)}function draw_buffers(bufs_data,shader,frame){var attributes=shader.attributes;var attribute_names=shader.attribute_names;_gl.bindBuffer(_gl.ARRAY_BUFFER,bufs_data.vbo);var pointers=bufs_data.pointers;var i=attribute_names.length;while(i--){var attr=attribute_names[i];var attribute_loc=attributes[attr];var p=pointers[attr];_gl.enableVertexAttribArray(attribute_loc);if(frame&&p.frames>1)var offset=(p.offset+frame*p.length)*
FLOAT_BYTE_SIZE;else var offset=p.offset*FLOAT_BYTE_SIZE;_gl.vertexAttribPointer(attribute_loc,p.num_comp,_gl.FLOAT,false,0,offset)}if(bufs_data.ibo){_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo);_gl.drawElements(bufs_data.mode,bufs_data.count,bufs_data.ibo_type,0)}else _gl.drawArrays(bufs_data.mode,0,bufs_data.count);var i=attribute_names.length;while(i--){var attr=attribute_names[i];_gl.disableVertexAttribArray(attributes[attr])}}function get_cube_target_by_id(id){switch(id){case 0:return _gl.TEXTURE_CUBE_MAP_NEGATIVE_Y;
break;case 1:return _gl.TEXTURE_CUBE_MAP_POSITIVE_Y;break;case 2:return _gl.TEXTURE_CUBE_MAP_POSITIVE_X;break;case 3:return _gl.TEXTURE_CUBE_MAP_NEGATIVE_X;break;case 4:return _gl.TEXTURE_CUBE_MAP_POSITIVE_Z;break;case 5:return _gl.TEXTURE_CUBE_MAP_NEGATIVE_Z;break}}function assign_uniform_setters(shader){var uniforms=shader.uniforms;var transient_uniform_names=[];var transient_uniform_setters={};var permanent_uniform_names=[];var permanent_uniform_setters={};for(var uni in uniforms){var transient_uni=
false;switch(uni){case "u_proj_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.proj_matrix)};transient_uni=true;break;case "u_view_matrix":case "u_view_matrix_frag":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.view_matrix)};transient_uni=true;break;case "u_view_proj_prev":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.prev_view_proj_matrix)};transient_uni=
true;break;case "u_view_proj_inverse":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.view_proj_inv_matrix)};transient_uni=true;break;case "u_sky_vp_inverse":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.sky_vp_inv_matrix)};transient_uni=true;break;case "u_camera_eye":case "u_camera_eye_frag":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,camera.eye)};transient_uni=true;break;
case "u_camera_eye_last":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,camera.eye_last)};transient_uni=true;break;case "u_camera_quat":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,camera.quat)};transient_uni=true;break;case "u_view_max_depth":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.far)};transient_uni=true;break;case "u_camera_range":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2f(loc,
camera.near,camera.far)};break;case "u_cam_water_depth":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.cam_water_depth)};transient_uni=true;break;case "u_waves_height":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.water_waves_height)};break;case "u_waves_length":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.water_waves_length)};break;case "u_caust_scale":var fun=function(gl,loc,subscene,
obj_render,batch,camera){gl.uniform1f(loc,subscene.caust_scale)};break;case "u_caust_bright":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.caust_brightness)};break;case "u_caust_speed":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,subscene.caust_speed)};break;case "u_fog_color_density":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.fog_color_density)};break;case "u_underwater_fog_color_density":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.water_fog_color_density)};break;case "u_shadow_visibility_falloff":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.shadow_visibility_falloff)};break;case "u_bloom_key":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.bloom_key)};break;case "u_bloom_edge_lum":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.bloom_edge_lum)};
break;case "u_time":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.time)};transient_uni=true;break;case "u_wind":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.wind)};break;case "u_horizon_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.horizon_color)};break;case "u_zenith_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.zenith_color)};break;
case "u_environment_energy":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.environment_energy)};break;case "u_sky_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sky_color)};break;case "u_rayleigh_brightness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.rayleigh_brightness)};break;case "u_mie_brightness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
subscene.mie_brightness)};break;case "u_spot_brightness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.spot_brightness)};break;case "u_scatter_strength":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.scatter_strength)};break;case "u_rayleigh_strength":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.rayleigh_strength)};break;case "u_mie_strength":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform1f(loc,subscene.mie_strength)};break;case "u_rayleigh_collection_power":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.rayleigh_collection_power)};break;case "u_mie_collection_power":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mie_collection_power)};break;case "u_mie_distribution":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mie_distribution)};break;case "u_light_positions":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.light_positions)};break;case "u_light_directions":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.light_directions)};break;case "u_light_color_intensities":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.light_color_intensities)};break;case "u_light_factors1":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.light_factors1)};
break;case "u_light_factors2":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.light_factors2)};break;case "u_sun_quaternion":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.sun_quaternion)};break;case "u_sun_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sun_intensity)};break;case "u_sun_direction":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sun_direction)};
break;case "u_height":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.height)};transient_uni=true;break;case "u_model_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,obj_render.world_matrix)};transient_uni=true;break;case "u_transb":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.trans_before)};transient_uni=true;break;case "u_transa":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform4fv(loc,obj_render.trans_after)};transient_uni=true;break;case "u_quat":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.quat)};transient_uni=true;break;case "u_quatsb":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.quats_before)};transient_uni=true;break;case "u_quatsa":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.quats_after)};transient_uni=true;break;case "u_frame_factor":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.frame_factor)};transient_uni=true;break;case "au_center_pos":var fun=function(gl,loc,subscene,obj_render,batch,camera){};transient_uni=true;break;case "au_wind_bending_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.wind_bending_amp)};transient_uni=true;break;case "au_wind_bending_freq":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.wind_bending_freq)};
transient_uni=true;break;case "au_detail_bending_freq":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.detail_bending_freq)};transient_uni=true;break;case "au_detail_bending_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.detail_bending_amp)};transient_uni=true;break;case "au_branch_bending_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.branch_bending_amp)};transient_uni=true;
break;case "u_diffuse_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.diffuse_color)};transient_uni=true;break;case "u_diffuse_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.diffuse_intensity)};transient_uni=true;break;case "u_diffuse_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.diffuse_params)};transient_uni=true;break;case "u_emit":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform1f(loc,batch.emit)};transient_uni=true;break;case "u_ambient":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.ambient)};transient_uni=true;break;case "u_specular_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.specular_color)};transient_uni=true;break;case "u_specular_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.specular_params)};transient_uni=true;break;case "u_reflect_factor":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.reflect_factor)};transient_uni=true;break;case "u_mirror_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.mirror_factor)};transient_uni=true;break;case "u_grass_map_dim":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.grass_map_dim)};transient_uni=true;break;case "u_grass_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
batch.grass_size)};transient_uni=true;break;case "u_scale_threshold":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.grass_scale_threshold)};transient_uni=true;break;case "u_cube_fog":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,batch.cube_fog)};break;case "u_jitter_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.jitter_amp)};transient_uni=true;break;case "u_jitter_freq":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.jitter_freq)};transient_uni=true;break;case "u_wireframe_mode":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1i(loc,batch.wireframe_mode)};break;case "u_wireframe_edge_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.wireframe_edge_color)};break;case "u_subpixel_jitter":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,subscene.jitter_projection_space)};
transient_uni=true;break;case "u_subsample_indices":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.jitter_subsample_ind)};transient_uni=true;break;case "u_halo_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_size)};transient_uni=true;break;case "u_halo_hardness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_hardness)};transient_uni=true;break;case "u_halo_rings_color":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.halo_rings_color)};transient_uni=true;break;case "u_halo_lines_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.halo_lines_color)};transient_uni=true;break;case "u_halo_stars_blend":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_stars_blend)};transient_uni=true;break;case "u_halo_stars_height":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
batch.halo_stars_height)};transient_uni=true;break;case "u_fresnel_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.fresnel_params)};transient_uni=true;break;case "u_texture_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.texture_scale)};transient_uni=true;break;case "u_parallax_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.parallax_scale)};transient_uni=true;break;case "u_color_id":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.color_id)};transient_uni=true;break;case "u_line_points":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.line_points)};transient_uni=true;break;case "u_diffuse_color_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.diffuse_color_factor)};transient_uni=true;break;case "u_specular_color_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
batch.specular_color_factor)};transient_uni=true;break;case "u_normal_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.normal_factor)};transient_uni=true;break;case "u_colormap0_uv_velocity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.colormap0_uv_velocity)};transient_uni=true;break;case "u_normalmap0_uv_velocity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_uv_velocities[0])};
transient_uni=true;break;case "u_normalmap1_uv_velocity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_uv_velocities[1])};transient_uni=true;break;case "u_normalmap2_uv_velocity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_uv_velocities[2])};transient_uni=true;break;case "u_normalmap3_uv_velocity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_uv_velocities[3])};
transient_uni=true;break;case "u_normalmap0_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[0])};transient_uni=true;break;case "u_normalmap1_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[1])};transient_uni=true;break;case "u_normalmap2_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[2])};transient_uni=true;break;case "u_normalmap3_scale":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[3])};transient_uni=true;break;case "u_foam_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.foam_factor)};transient_uni=true;break;case "u_foam_uv_freq":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.foam_uv_freq)};transient_uni=true;break;case "u_foam_mag":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.foam_mag)};
transient_uni=true;break;case "u_foam_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.foam_scale)};transient_uni=true;break;case "u_shallow_water_col":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.shallow_water_col)};transient_uni=true;break;case "u_shore_water_col":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.shore_water_col)};transient_uni=true;break;case "u_water_shallow_col_fac":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.shallow_water_col_fac)};transient_uni=true;break;case "u_water_shore_col_fac":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.shore_water_col_fac)};transient_uni=true;break;case "u_p_starttime":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_starttime)};transient_uni=true;break;case "u_p_endtime":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
batch.p_endtime)};transient_uni=true;break;case "u_p_cyclic":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1i(loc,batch.p_cyclic)};transient_uni=true;break;case "u_p_max_lifetime":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_max_lifetime)};transient_uni=true;break;case "u_p_fade_in":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_fade_in)};transient_uni=true;break;case "u_p_fade_out":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_fade_out)};transient_uni=true;break;case "u_p_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_size)};transient_uni=true;break;case "u_p_alpha_start":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_alpha_start)};transient_uni=true;break;case "u_p_alpha_end":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_alpha_end)};transient_uni=
true;break;case "u_p_nfactor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_nfactor)};transient_uni=true;break;case "u_p_gravity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_gravity)};transient_uni=true;break;case "u_p_mass":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.p_mass)};transient_uni=true;break;case "u_p_size_ramp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,
batch.p_size_ramp)};transient_uni=true;break;case "u_p_color_ramp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.p_color_ramp)};transient_uni=true;break;case "u_p_wind":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.p_wind)};transient_uni=true;break;case "u_texel_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.texel_size)};transient_uni=true;break;case "u_p_time":var fun=function(gl,loc,
subscene,obj_render,batch,camera){if(batch.p_cyclic===1)var p_time=subscene.time%(batch.p_endtime-batch.p_starttime);else var p_time=obj_render.time;gl.uniform1f(uniforms["u_p_time"],p_time)};transient_uni=true;break;case "u_va_frame_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.va_frame_factor)};transient_uni=true;break;case "u_v_light_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.v_light_matrix)};
transient_uni=true;break;case "u_b_light_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.b_light_matrix)};break;case "u_p_light_matrix0":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[0])};transient_uni=true;break;case "u_p_light_matrix1":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[1])};transient_uni=true;break;
case "u_p_light_matrix2":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[2])};transient_uni=true;break;case "u_p_light_matrix3":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[3])};transient_uni=true;break;case "u_motion_blur_exp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.motion_blur_exp)};transient_uni=true;break;case "u_refl_plane":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.reflection_plane)};break;case "u_radial_blur_step":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.radial_blur_step)};break;case "u_god_rays_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.god_rays_intensity)};break;case "u_ssao_radius_increase":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_radius_increase)};
break;case "u_ssao_dithering_amount":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_dithering_amount)};break;case "u_ssao_gauss_center":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_gauss_center)};break;case "u_ssao_gauss_width_square":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_gauss_width_square)};break;case "u_ssao_gauss_width_left_square":var fun=function(gl,loc,subscene,
obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_gauss_width_left_square)};break;case "u_ssao_influence":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_influence)};break;case "u_ssao_dist_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_dist_factor)};break;case "u_dof_dist":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.dof_distance)};transient_uni=true;break;case "u_dof_front":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.dof_front)};transient_uni=true;break;case "u_dof_rear":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.dof_rear)};transient_uni=true;break;case "u_glow_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.glow_intensity)};transient_uni=true;break;case "u_glow_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.glow_color)};
break;case "u_draw_glow":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.draw_glow_flag)};transient_uni=true;break;case "u_blur_depth_edge_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.blur_depth_edge_size)};break;case "u_blur_depth_diff_threshold":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.blur_depth_diff_threshold)};break;case "u_brightness":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform1f(loc,subscene.brightness)};break;case "u_contrast":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.contrast)};break;case "u_exposure":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.exposure)};break;case "u_saturation":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.saturation)};break;case "u_saturation":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
subscene.saturation)};break;default:var fun=null;break}if(fun)if(transient_uni){transient_uniform_names.push(uni);transient_uniform_setters[uni]=fun}else{permanent_uniform_names.push(uni);permanent_uniform_setters[uni]=fun}}shader.transient_uniform_setters=transient_uniform_setters;shader.transient_uniform_names=transient_uniform_names;shader.permanent_uniform_setters=permanent_uniform_setters;shader.permanent_uniform_names=permanent_uniform_names}function setup_textures(textures,names,uniforms){var len=
textures.length|0;if(len===0)return;else if(len===1){_gl.activeTexture(_gl.TEXTURE0);_gl.bindTexture(textures[0].w_target,textures[0].w_texture)}else for(var i=0;i<len;i++){var tex=textures[i];var name=names[i];_gl.activeTexture(_gl.TEXTURE0+i);_gl.bindTexture(tex.w_target,tex.w_texture);_gl.uniform1i(uniforms[name],i)}}exports.read_pixels=read_pixels;function read_pixels(framebuffer,x,y,width,height,storage){if(!width)var width=1;if(!height)var height=1;if(!storage)var storage=new Uint8Array(4*width*
height);if(storage.length!=4*width*height)throw"Wrong storage";_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);_gl.readPixels(x,y,width,height,_gl.RGBA,_gl.UNSIGNED_BYTE,storage);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);return storage}function update_subs_permanent_uniforms(subscene){var camera=subscene.camera;var bundles=subscene.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];var batch=bundle.batch;var shader=batch.shader;_gl.useProgram(shader.program);var obj_render=bundle.obj_render;
var uniforms=shader.uniforms;if(!shader.permanent_uniform_setters)assign_uniform_setters(shader);var permanent_uniform_setters=shader.permanent_uniform_setters;var permanent_uniform_names=shader.permanent_uniform_names;var j=permanent_uniform_names.length;while(j--){var uni=permanent_uniform_names[j];permanent_uniform_setters[uni](_gl,uniforms[uni],subscene,obj_render,batch,camera)}}}exports.update_batch_permanent_uniform=function(batch,uni_name){var shader=batch.shader;_gl.useProgram(shader.program);
var uniforms=shader.uniforms;var uni_setters=shader.permanent_uniform_setters;if(!uni_setters)assign_uniform_setters(shader);uni_setters[uni_name](_gl,uniforms[uni_name],null,null,batch,null)};exports.render_target_create=function(color_attachment,depth_attachment){var framebuffer=_gl.createFramebuffer();_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);if(color_attachment){var texture=color_attachment;var w_tex=texture.w_texture;var w_target=texture.w_target==_gl.TEXTURE_CUBE_MAP?_gl.TEXTURE_CUBE_MAP_NEGATIVE_Z:
texture.w_target;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_tex,0)}if(m_textures.is_renderbuffer(depth_attachment)){var renderbuffer=depth_attachment.w_renderbuffer;_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,renderbuffer)}else if(m_textures.is_texture(depth_attachment)){var texture=depth_attachment;var w_tex=texture.w_texture;var w_target=texture.w_target;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,w_target,w_tex,
0)}debug.check_bound_fb();_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);return framebuffer};exports.render_target_cleanup=function(framebuffer,color_attachment,depth_attachment,width,height){if(framebuffer==null){_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);_gl.viewport(0,0,width,height);_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT);return}if(m_textures.is_texture(color_attachment))_gl.deleteTexture(color_attachment.w_texture);if(m_textures.is_renderbuffer(depth_attachment))_gl.deleteRenderbuffer(depth_attachment.w_renderbuffer);
else if(m_textures.is_texture(depth_attachment))_gl.deleteTexture(depth_attachment.w_texture);_gl.deleteFramebuffer(framebuffer)};exports.lock=function(){_render_lock=true};exports.unlock=function(){_render_lock=false};exports.is_locked=function(){return DEBUG_DISABLE_RENDER_LOCK?false:_render_lock};exports.increment_subpixel_index=function(){_subpixel_index=(_subpixel_index+1)%2};exports.cleanup=function(){_render_lock=false}};b4w.module["__shaders"]=function(exports,require){var config=require("__config");var m_print=require("__print");var debug=require("__debug");var gpp_eval=require("__gpp_eval");var assets=require("__assets");var util=require("__util");if(b4w.module_check(config.paths.shader_texts_module)){var shader_texts=require(config.paths.shader_texts_module);var gpp_parser=null}else{var shader_texts=null;var gpp_parser=require("__gpp_parser")}var SHADERS_DIR=config.paths.shaders_dir;var SHADERS_INCLUDE_DIR=config.paths.shaders_include_dir;
var _compiled_shaders={};var _shader_ast_cache={};var DEBUG_COMPILATION_UNIQUENESS=false;var _debug_hash_codes=[];var _gl=null;exports.setup_context=function(gl){_gl=gl};exports.set_directive=set_directive;function set_directive(shaders_info,name,value){var dirs=shaders_info.directives;if(typeof value=="string"){var dir=get_directive(shaders_info,value);if(dir)var value=dir[1]}for(var i=0;i<dirs.length;i++)if(dirs[i][0]==name){dirs[i][1]=value;return}dirs.push([name,value])}exports.get_directive=
get_directive;function get_directive(shaders_info,name){var dirs=shaders_info.directives;for(var i=0;i<dirs.length;i++)if(dirs[i][0]==name)return dirs[i];return false}exports.is_enabled=function(shaders_info,name){var dirs=shaders_info.directives;for(var i=0;i<dirs.length;i++)if(dirs[i][0]==name&&dirs[i][1]==1)return true;return false};exports.set_default_directives=function(sinfo){sinfo.directives=[];var dir_names=["ALPHA","ALPHA_CLIP","ALPHA_MAP","BEND_CENTER_ONLY","CAUSTICS","CSM_SECTION0","CSM_SECTION1",
"CSM_SECTION2","CSM_SECTION3","DEBUG_SPHERE","DEBUG_SPHERE_DYNAMIC","DEPTH_RGBA","DISABLE_FOG","DOUBLE_SIDED_LIGHTING","DYNAMIC","DYNAMIC_GRASS","DYNAMIC_GRASS_COLOR","DYNAMIC_GRASS_SIZE","FOAM","FRAMES_BLENDING","HAIR_BILLBOARD_JITTERED","HAIR_BILLBOARD_SPHERICAL","MAIN_BEND_COL","MAX_BONES","NUM_NORMALMAPS","PARALLAX","PARALLAX_STEPS","PROCEDURAL_FOG","REFLECTION","REFLECTION_PASS","REFLECTIVE","REFRACTIVE","SHORE_SMOOTHING","SKINNED","SSAO_ONLY","SSAO_WHITE","STATIC_BATCH","TEXTURE_COLOR","TEXTURE_MIRROR",
"TEXTURE_NORM","TEXTURE_SPEC","TEXTURE_STENCIL_ALPHA_MASK","VERTEX_ANIM","VERTEX_COLOR","WATER_EFFECTS","WIND_BEND","DETAIL_BEND","SHORE_PARAMS","ALPHA_AS_SPEC","DEPTH_RGBA","NUM_LIGHTS","MAX_STEPS","CSM_SECTION_DIST0","CSM_SECTION_DIST1","CSM_SECTION_DIST2","CSM_SECTION_DIST3","BILLBOARD_ALIGN","SHADOW_SRC","SHADOW_DST","POST_EFFECT","SSAO_QUALITY","TEXTURE_BLEND_TYPE","TEXTURE_COORDS","AA_METHOD","AU_QUALIFIER","HAIR_BILLBOARD","HAIR_BILLBOARD_RANDOM","PRECISION","EPSILON","WIREFRAME_QUALITY"];
for(var i=0;i<dir_names.length;i++){var name=dir_names[i];var val;switch(name){case "ALPHA":case "ALPHA_CLIP":case "ALPHA_MAP":case "CAUSTICS":case "CSM_SECTION0":case "CSM_SECTION1":case "CSM_SECTION2":case "CSM_SECTION3":case "DEBUG_SPHERE":case "DEBUG_SPHERE_DYNAMIC":case "DEPTH_RGBA":case "DISABLE_FOG":case "DOUBLE_SIDED_LIGHTING":case "DYNAMIC":case "DYNAMIC_GRASS":case "DYNAMIC_GRASS_COLOR":case "DYNAMIC_GRASS_SIZE":case "FOAM":case "FRAMES_BLENDING":case "HAIR_BILLBOARD_JITTERED":case "MAIN_BEND_COL":case "MAX_BONES":case "NUM_NORMALMAPS":case "PARALLAX":case "PARALLAX_STEPS":case "PROCEDURAL_FOG":case "REFLECTION":case "REFLECTION_PASS":case "REFLECTIVE":case "REFRACTIVE":case "SHORE_SMOOTHING":case "SKINNED":case "SSAO_ONLY":case "SSAO_WHITE":case "STATIC_BATCH":case "TEXTURE_COLOR":case "TEXTURE_MIRROR":case "TEXTURE_NORM":case "TEXTURE_SPEC":case "TEXTURE_STENCIL_ALPHA_MASK":case "VERTEX_ANIM":case "VERTEX_COLOR":case "WATER_EFFECTS":case "WIND_BEND":case "DETAIL_BEND":case "SHORE_PARAMS":case "HAIR_BILLBOARD":case "HAIR_BILLBOARD_RANDOM":case "WIREFRAME_QUALITY":val=
0;break;case "ALPHA_AS_SPEC":case "BEND_CENTER_ONLY":case "DEPTH_RGBA":case "HAIR_BILLBOARD_SPHERICAL":case "NUM_LIGHTS":case "MAX_STEPS":val=1;break;case "CSM_SECTION_DIST0":val=2.0001;break;case "CSM_SECTION_DIST1":val=4.0001;break;case "CSM_SECTION_DIST2":val=7.0001;break;case "CSM_SECTION_DIST3":val=9.0001;break;case "AA_METHOD":val="AA_METHOD_FXAA_QUALITY";break;case "AU_QUALIFIER":val="NOT_ASSIGNED";break;case "BILLBOARD_ALIGN":val="BILLBOARD_ALIGN_VIEW";break;case "POST_EFFECT":val="POST_EFFECT_NONE";
break;case "SHADOW_SRC":val="SHADOW_SRC_NONE";break;case "SHADOW_DST":val="SHADOW_DST_NONE";break;case "SSAO_QUALITY":val="SSAO_QUALITY_32";break;case "TEXTURE_BLEND_TYPE":val="TEXTURE_BLEND_TYPE_MIX";break;case "TEXTURE_COORDS":val="TEXTURE_COORDS_UV";break;case "PRECISION":val=config.defaults.precision;break;case "EPSILON":if(config.defaults.precision=="highp")val=1E-6;else val=1E-4;break;default:m_print.error("Unknown directive ("+sinfo.vert+", "+sinfo.frag+"): "+name);break}set_directive(sinfo,
name,val)}};exports.get_vname=function(sinfo){return sinfo.vert};exports.get_fname=function(sinfo){return sinfo.frag};exports.inherit_directives=function(sinfo_to,sinfo_from){var dirs=sinfo_from.directives;for(var i=0;i<dirs.length;i++){var name=dirs[i][0];var value=dirs[i][1];if(get_directive(sinfo_to,name))set_directive(sinfo_to,name,value)}};exports.get_compiled_shader=get_compiled_shader;function get_compiled_shader(shaders_info,node_elements){var shader_id=JSON.stringify(shaders_info)+JSON.stringify(node_elements);
var compiled_shader=_compiled_shaders[shader_id];if(compiled_shader)return compiled_shader;var vshader=shaders_info.vert;var fshader=shaders_info.frag;var vshader_ast=get_shader_ast(SHADERS_DIR,vshader);var fshader_ast=get_shader_ast(SHADERS_DIR,fshader);if(!vshader_ast||!fshader_ast)return null;var directives=shaders_info.directives||[];var vshader_text=preprocess_shader("vert",vshader_ast,directives,node_elements);var fshader_text=preprocess_shader("frag",fshader_ast,directives,node_elements);_compiled_shaders[shader_id]=
compiled_shader=init_shader(_gl,vshader_text,fshader_text,shader_id,shaders_info);return compiled_shader}function get_shader_ast(dir,filename){var cache_id=dir+filename;if(_shader_ast_cache[cache_id])return _shader_ast_cache[cache_id];if(shader_texts){var ast=shader_texts[filename];if(!ast)return null}else{var main_text=assets.get_text_sync(dir+filename,false);if(!main_text)return null;var ast=gpp_parser.parser.parse(main_text)}_shader_ast_cache[cache_id]=ast;return ast}function preprocess_shader(type,
ast,dirs_arr,node_elements){var lines=[];var dirs={};for(var i=0;i<dirs_arr.length;i++)dirs[dirs_arr[i][0]]=[dirs_arr[i][1]];if(node_elements)for(var i=0;i<node_elements.length;i++)dirs["USE_NODE_"+node_elements[i].id]=[1];var fdirs={};var shader_nodes={};process_group(ast);var text=lines.join("\n");return text;function process_group(elem){var parts=elem.parts;for(var i=0;i<parts.length;i++){var pelem=parts[i];switch(pelem.type){case "condition":process_condition(pelem);break;case "include":process_include(pelem);
break;case "var":case "export":case "import":break;case "define":process_define(pelem);break;case "error":process_error(pelem);break;case "line":break;case "pragma":process_pragma(pelem);break;case "undef":process_undef(pelem);break;case "warning":process_warning(pelem);break;case "extension":process_extension(pelem);break;case "#":break;case "node":process_node(pelem);break;case "nodes_global":process_nodes_global(node_elements);break;case "nodes_main":process_nodes_main(node_elements);break;case "textline":process_textline(pelem);
break;default:throw"Unknown element type: "+pelem.type;break}}}function process_condition(elem){var parts=elem.parts;for(var i=0;i<parts.length;i++){var pelem=parts[i];switch(pelem.type){case "if":case "elif":var expression=pelem.expression;try{var result=expression_result(expression)}catch(e){throw"Failed to process #"+pelem.type+" expression: "+expression.join(" ");}if(result){process_group(pelem.group);return}break;case "else":process_group(pelem.group);break;case "ifdef":if(pelem.name in dirs)process_group(pelem.group);
break;case "ifndef":if(!(pelem.name in dirs))process_group(pelem.group);break}}}function expression_result(expression){var expr_str=expand_macro(expression,dirs,fdirs,true);return gpp_eval.parser.parse(expr_str)}function process_include(elem){var file=elem.file;var ast_inc=get_shader_ast(SHADERS_DIR,SHADERS_INCLUDE_DIR+file);process_group(ast_inc)}function process_define(elem){var name=elem.name;var tokens=elem.tokens;dirs[name]=tokens;if(elem.params)fdirs[name]=elem.params}function process_error(elem){var tokens=
elem.tokens;throw"Shader error: #error "+tokens.join(" ");}function process_pragma(elem){var name=elem.name;var tokens=elem.tokens;lines.push("#pragma "+name+" "+tokens.join(" "))}function process_undef(elem){var name=elem.name;delete dirs[name];delete fdirs[name]}function process_warning(elem){var tokens=elem.tokens;m_print.warn("Shader warning: #warning "+tokens.join(" "))}function process_extension(elem){var tokens=elem.tokens;lines.push("#extension "+expand_macro(tokens,dirs,fdirs,false))}function process_node(elem){var name=
elem.name;var group_parts=elem.group.parts;shader_nodes[name]=group_parts}function process_nodes_global(node_elements){for(var i=0;i<node_elements.length;i++){var nelem=node_elements[i];var node_parts=shader_nodes[nelem.id];if(!node_parts)continue;var param_index=0;for(var j=0;j<node_parts.length;j++){var part=node_parts[j];if(part.type=="node_param"){var glob_var_line=part.qualifier.join(" ")+" ";if(type=="vert")glob_var_line+=nelem.vparams[param_index];else if(type=="frag"){glob_var_line+=nelem.params[param_index];
if(nelem.param_values[param_index]!==null)glob_var_line+=" = "+nelem.param_values[param_index]}glob_var_line+=";";lines.push(glob_var_line);param_index++}}}}function process_nodes_main(node_elements){for(var i=0;i<node_elements.length;i++){var nelem=node_elements[i];var node_parts=shader_nodes[nelem.id];if(!node_parts)continue;var input_index=0;var output_index=0;var param_index=0;nelem.replaces={};for(var j=0;j<node_parts.length;j++){var part=node_parts[j];switch(part.type){case "node_in":var new_name=
nelem.inputs[input_index];if(nelem.input_values[input_index]!==null){var main_var_line=part.qualifier.join(" ")+" ";main_var_line+=new_name;main_var_line+=" = "+nelem.input_values[input_index];main_var_line+=";";lines.push(main_var_line)}nelem.replaces[part.name]=new_name;input_index++;break;case "node_out":var new_name=nelem.outputs[output_index];var main_var_line=part.qualifier.join(" ")+" ";main_var_line+=new_name;main_var_line+=";";lines.push(main_var_line);nelem.replaces[part.name]=new_name;
output_index++;break;case "node_param":if(type=="vert")var new_name=nelem.vparams[param_index];else if(type=="frag")var new_name=nelem.params[param_index];nelem.replaces[part.name]=new_name;param_index++;break}}}for(var i=0;i<node_elements.length;i++){var nelem=node_elements[i];var node_parts=shader_nodes[nelem.id];if(!node_parts)continue;for(var j=0;j<node_parts.length;j++){var part=node_parts[j];if(part.type=="textline"){var new_part={type:"textline",tokens:[]};for(var k=0;k<part.tokens.length;k++){var tok=
part.tokens[k];if(tok in nelem.replaces)new_part.tokens.push(nelem.replaces[tok]);else new_part.tokens.push(tok)}process_textline(new_part)}}}}function process_textline(elem){var tokens=elem.tokens;lines.push(expand_macro(tokens,dirs,fdirs,false))}}function expand_macro(tokens,dirs,fdirs,empty_as_zero){var result=[];expand_macro_iter(tokens,dirs,fdirs,empty_as_zero,result);return result.join(" ")}function expand_macro_iter(tokens,dirs,fdirs,empty_as_zero,result){for(var i=0;i<tokens.length;i++){var token=
tokens[i];if(token in dirs){var new_tokens=dirs[token];if(new_tokens.length==0&&empty_as_zero)result.push(0);else expand_macro_iter(new_tokens,dirs,fdirs,empty_as_zero,result)}else result.push(token)}}function init_shader(gl,vshader_text,fshader_text,shader_id,shaders_info){var vshader=compile_shader(gl,shader_id,vshader_text,gl.VERTEX_SHADER,shaders_info);var fshader=compile_shader(gl,shader_id,fshader_text,gl.FRAGMENT_SHADER,shaders_info);var program=gl.createProgram();gl.attachShader(program,vshader);
gl.attachShader(program,fshader);gl.linkProgram(program);gl.validateProgram(program);if(gl.getProgramParameter(program,gl.VALIDATE_STATUS)==gl.FALSE)m_print.error("B4W Error - shader program is not valid",shader_id);debug.check_shader_linking(program,shader_id,vshader,fshader,vshader_text,fshader_text);var compiled_shader={vshader:vshader,fshader:fshader,program:program,attributes:{},uniforms:{},attribute_names:[],permanent_uniform_names:[],transient_uniform_names:[],permanent_uniform_setters:null,
transient_uniform_setters:null,shaders_info:shaders_info};var att_count=gl.getProgramParameter(program,gl.ACTIVE_ATTRIBUTES);for(var i=0;i<att_count;i++){var att=gl.getActiveAttrib(program,i);var att_name=att.name;var att_loc=gl.getAttribLocation(program,att_name);compiled_shader.attributes[att_name]=att_loc;compiled_shader.attribute_names.push(att_name)}var uni_count=gl.getProgramParameter(program,gl.ACTIVE_UNIFORMS);for(var i=0;i<uni_count;i++){var uni=gl.getActiveUniform(program,i);var uni_name=
uni.name.split("[0]").join("");var uni_loc=gl.getUniformLocation(program,uni_name);compiled_shader.uniforms[uni_name]=uni_loc}return compiled_shader}exports.debug_get_compilation_stats=function(){return _debug_hash_codes};function debug_compilation_uniqueness(shader_id,shader_text,shader_type,shaders_info){if(shader_type==_gl.VERTEX_SHADER)var shader_filename=shaders_info.vert;else var shader_filename=shaders_info.frag;var hc=util.hash_code(shader_text);var info=_debug_hash_codes[hc];if(info)info.count++;
else{info={count:1,shader_filename:shader_filename,hc:hc};_debug_hash_codes[hc]=info}}function compile_shader(gl,shader_id,shader_text,shader_type,shaders_info){if(DEBUG_COMPILATION_UNIQUENESS)debug_compilation_uniqueness(shader_id,shader_text,shader_type,shaders_info);var shader=gl.createShader(shader_type);gl.shaderSource(shader,shader_text);gl.compileShader(shader);debug.check_shader_compiling(shader,shader_id,shader_text);return shader}exports.get_compiled_shaders=function(){return _compiled_shaders};
exports.cleanup=cleanup;function cleanup(){for(var shader_id in _compiled_shaders){var shader=_compiled_shaders[shader_id];_gl.deleteProgram(shader.program);_gl.deleteShader(shader.vshader);_gl.deleteShader(shader.fshader);delete _compiled_shaders[shader_id]}for(var id in _shader_ast_cache)delete _shader_ast_cache[id];for(var hc in _debug_hash_codes)delete _debug_hash_codes[hc]}exports.debug_shaders_info=function(shaders_info){var dirs=shaders_info.directives;m_print.log("Shader: "+shaders_info.vert+
" "+shaders_info.frag+", "+String(dirs.length)+" directives: ");for(var i=0;i<dirs.length;i++)m_print.log("  "+dirs[i][0],dirs[i][1])};exports.glsl_value=function(value,dim){if(!dim&&value.length)dim=value.length;else if(!dim)dim=1;switch(dim){case 1:return glsl_float(value);break;case 2:return"vec2("+glsl_float(value[0])+","+glsl_float(value[1])+")";break;case 3:return"vec3("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+")";break;case 4:return"vec4("+glsl_float(value[0])+
","+glsl_float(value[1])+","+glsl_float(value[2])+","+glsl_float(value[3])+")";break;case 9:return"mat3("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+","+glsl_float(value[3])+","+glsl_float(value[4])+","+glsl_float(value[5])+","+glsl_float(value[6])+","+glsl_float(value[7])+","+glsl_float(value[8])+")";break;case 16:return"mat4("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+","+glsl_float(value[3])+","+glsl_float(value[4])+","+glsl_float(value[5])+
","+glsl_float(value[6])+","+glsl_float(value[7])+","+glsl_float(value[8])+","+glsl_float(value[9])+","+glsl_float(value[10])+","+glsl_float(value[11])+","+glsl_float(value[12])+","+glsl_float(value[13])+","+glsl_float(value[14])+","+glsl_float(value[15])+")";break;default:throw"Wrong glsl value dimension";break}};function glsl_float(value){return value%1?String(value):String(value)+".0"}exports.check_uniform=function(shader,name){if(name in shader.uniforms)return true;else return false}};b4w.module["shader_texts"]=function(exports,require){exports["color_id.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","vec3","u_color_id",";","uniform","vec4","u_diffuse_color",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_sampler",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec2","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_GLOW"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_glow_intensity",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["float","b","=","(","texture2D","(","u_sampler",
",","a",")",")",".","a",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","b","=","u_diffuse_color",".","a",";"]}]}}]},{type:"textline",tokens:["if","(","b","<","0.5",")","discard",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_GLOW"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","u_glow_intensity",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor",
"=","vec4","(","u_color_id",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["color_id.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","attribute","vec3","a_normal",";","AU_QUALIFIER",
"float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND",
"||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],
group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",
expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","a",";"]}]}}]},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"textline",tokens:["void","main","(",")","{","vec3","cf","=","a_position",";"]},{type:"condition",
parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["cf","=","mix","(","cf",",","a_position_next",",","u_va_frame_factor",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","cg","=","vec3","(","0.0",")",";","vec3","ch","=","vec3","(","0.0",")",";","vec3","ci","=","vec3","(","0.0",")",";","bn","(","cf",",","cg",",","ch",",","ci",")",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["WIND_BEND","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","cj","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","cj","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ck","=","(","u_model_matrix","*","vec4","(","cj",",","1.0",")",")",".","xyz",";","mat4","cl","=","ab","(","u_camera_eye",",",
"ck",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","cm","=","(","u_model_matrix","*","vec4","(","cj",",","1.0",")",")",".","xyz",";","cl","=","cl","*","R","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","cm",")",";"]}]}}]},{type:"textline",tokens:["b","cn","=","ai","(","cf","-","cj",",","cj",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",",
"vec3","(","0.0",")",",","cl",")",";","cn",".","b","=","ck",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["b","cn","=","ai","(","cf",",","cj",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL","&&","DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["vec3",
"co","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","co","=","vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["ce","(","cn",".","a",",","cn",".","b",",","co",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["a","=","al","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","u_proj_matrix","*","u_view_matrix","*","vec4",
"(","cn",".","a",",","1.0",")",";","}"]}]},exports["depth.glslf"]={type:"group",parts:[{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_sampler",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_shadow_visibility_falloff",
";"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map2",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_mask",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2",
"a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_DST","==","SHADOW_DST_NONE","||","SHADOW_DST","==","SHADOW_DST_RGBA","||","SHADOW_DST","==","SHADOW_DST_VSM"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","co",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cp",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec4","cq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cs",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec3","ct",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_MASK","&&","SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cu",";"]}]}}]},{type:"include",file:"shadow.glslf"},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",
tokens:["float","dd","=","(","texture2D","(","u_sampler",",","a",")",")",".","a",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","dd","=","u_diffuse_color",".","a",";"]}]}}]},{type:"textline",tokens:["if","(","dd","<","0.5",")","discard",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SHADOW_DST","==","SHADOW_DST_NONE"],group:{type:"group",parts:[{type:"textline",
tokens:["gl_FragColor","=","cj","(","co",")",";"]}]}},{type:"elif",expression:["SHADOW_DST","==","SHADOW_DST_RGBA"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","cj","(","co",")",";"]}]}},{type:"elif",expression:["SHADOW_DST","==","SHADOW_DST_DEPTH"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","1.0",")",";"]}]}},{type:"elif",expression:["SHADOW_DST","==","SHADOW_DST_VSM"],group:{type:"group",parts:[{type:"textline",
tokens:["float","de","=","co",";","float","df","=","de","*","de",";","gl_FragColor","=","vec4","(","de",",","df",",","0.0",",","1.0",")",";"]}]}},{type:"elif",expression:["SHADOW_DST","==","SHADOW_DST_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","1.0",")",";"]}]}}]}]}},{type:"elif",expression:["SHADOW_DST","==","SHADOW_DST_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","cX","(","cu",
".","z",",","u_shadow_visibility_falloff",")",",","1.0",",","1.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["depth.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",
parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","||","DYNAMIC_GRASS","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",
parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","attribute","vec3","a_normal",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",
";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},
{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_grass_map_depth",";","uniform","sampler2D","u_grass_map_color",";","uniform",
"vec4","u_camera_quat",";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4",
"u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float",
"u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_DST","==","SHADOW_DST_NONE","||","SHADOW_DST","==","SHADOW_DST_RGBA","||","SHADOW_DST","==","SHADOW_DST_VSM"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_v_light_matrix",";","uniform","mat4","u_b_light_matrix",";","uniform","mat4","u_p_light_matrix0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix1",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","a",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SHADOW_DST","==","SHADOW_DST_NONE","||","SHADOW_DST","==","SHADOW_DST_RGBA","||","SHADOW_DST","==","SHADOW_DST_VSM"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","co",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cp",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec4","cq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cs",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ct",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_MASK","&&","SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cu",";"]}]}}]},{type:"include",file:"dynamic_grass.glslv"},{type:"include",file:"shadow.glslv"},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"textline",tokens:["void","main","(",")","{","vec3","d_","=","a_position",";"]},{type:"condition",parts:[{type:"if",
expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["d_","=","mix","(","d_",",","a_position_next",",","u_va_frame_factor",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ea","=","vec3","(","0.0",")",";","vec3","eb","=","vec3","(","0.0",")",";","vec3","ec","=","vec3","(","0.0",")",";","bn","(","d_",",","ea",",","eb",",","ec",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND",
"||","DYNAMIC_GRASS","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ed","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","ed","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["b","ee","=","dT","(","d_",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","ed",",","u_grass_map_depth",
",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","u_view_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ef","=","(","u_model_matrix","*","vec4","(","ed",",","1.0",")",")",".","xyz",";","mat4","eg","=","ab","(","u_camera_eye",",","ef",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND",
"&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","eh","=","(","u_model_matrix","*","vec4","(","ed",",","1.0",")",")",".","xyz",";","eg","=","eg","*","R","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","eh",")",";"]}]}}]},{type:"textline",tokens:["b","ee","=","ai","(","d_","-","ed",",","ed",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","eg",")",";","ee",".","b","=","ef",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["b","ee","=","ai","(","d_",",","ed",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL","&&","DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ei","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["vec3","ei","=","vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["ce","(","ee",".","a",",","ee",".","b",",","ei",")",";"]}]}}]},{type:"textline",tokens:["vec4","ej","=","u_view_matrix","*","vec4","(","ee",".","a",",","1.0",")",";","vec4","ek","=","u_proj_matrix","*","ej",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["ek",".","xy","+=","u_subpixel_jitter","*","ek",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["a","=","al","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["dV","(","ee",".","a",")",";","cu","=","ej",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_DST","==","SHADOW_DST_NONE","||","SHADOW_DST","==","SHADOW_DST_RGBA","||","SHADOW_DST","==","SHADOW_DST_VSM"],
group:{type:"group",parts:[{type:"textline",tokens:["co","=","-","ej",".","z","/","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","ek",";","}"]}]},exports["grass_map.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4",
"d_",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","float","d_",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","d_",";"]}]}}]}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","d_",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","d_",",","vec3","(","1.0",")",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",",","d_",")",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",")",";"]}]}}]}]}}]},{type:"textline",tokens:["}"]}]},exports["grass_map.glslv"]={type:"group",parts:[{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_grass_size",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_grass_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4",
"u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float","u_time",";","uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","d_",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","float","d_",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","d_",
";"]}]}}]}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ea","=","(","u_model_matrix","*","vec4","(","vec3","(","0.0",")",",","1.0",")",")",".","xyz",";","mat4","eb","=","ab","(","u_camera_eye",",","ea",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",
tokens:["eb","=","eb","*","R","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","vec3","(","0.0",")",")",";"]}]}}]},{type:"textline",tokens:["b","ec","=","ai","(","a_position",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","eb",")",";","ec",".","b","=","ea",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["b","ec","=","ai","(","a_position",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3",
"(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]}]}}]},{type:"textline",tokens:["vec4","ed","=","u_proj_matrix","*","u_view_matrix","*","vec4","(","ec",".","a",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["d_","=","vec4","(","a_grass_size",",","a_grass_color",")",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["d_","=","a_grass_size",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["d_","=","a_grass_color",";"]}]}}]}]}}]},{type:"textline",tokens:["gl_Position","=","ed",";","}"]}]},exports["halo.glslf"]={type:"group",parts:[{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"NUM_LINES",tokens:["0"]},{type:"var",name:"NUM_RINGS",
tokens:["0"]},{type:"var",name:"NUM_STARS",tokens:["0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","uniform","vec3","u_halo_rings_color",";","uniform","vec3","u_halo_lines_color",";","uniform","float","u_halo_hardness",";","uniform","float","u_halo_size",";"]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec3","u_sun_intensity",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","&&","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_halo_stars_blend",";","uniform","float","u_halo_stars_height",";","uniform","float","u_cam_water_depth",";","varying","vec4","eh",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec2","a",";","varying","float","ei",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS",">","NUM_LINES"],
group:{type:"group",parts:[{type:"textline",tokens:["const","int","ej","=","NUM_RINGS",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["const","int","ej","=","NUM_LINES",";"]}]}}]},{type:"textline",tokens:["float","el","(","float","ek",")","{","return","ek","-","floor","(","ek","*","(","1.0","/","0.01",")",")","*","0.01",";","}"]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS"],group:{type:"group",parts:[{type:"textline",tokens:["void","eu","(","inout","float",
"em",",","in","float","en","[","ej","]",",","in","float","eo",")","{","for","(","int","ep","=","NUM_RINGS",";","ep",">","0",";","ep","--",")","{","float","eq","=","40.0","*","en","[","ep","]",";","float","er","=","300.0","*","(","el","(","eq",")","-","0.005",")",";","float","es","=","eq",";","float","et","=","abs","(","es","*","(","u_halo_size","*","er","-","eo",")",")",";","em","+=","1.0","-","min","(","et",",","1.0",")",";","}","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_LINES"],
group:{type:"group",parts:[{type:"textline",tokens:["void","eD","(","inout","float","ev",",","in","float","ew","[","ej","]",",","in","float","ex",")","{","for","(","int","ey","=","NUM_LINES",";","ey",">","0",";","ey","--",")","{","float","ez","=","ew","[","ey","]",";","float","eA","=","ez",";","float","eB","=","1000.0","*","(","el","(","ez",")","-","0.005",")",";","float","eC","=","20.0","*","abs","(","eA","*","a",".","x","+","eB","*","a",".","y",")",";","ev","+=","1.0","-","min","(","eC",",","1.0",
")",";","}","ev","*=","ex",";","}"]}]}}]},{type:"textline",tokens:["void","eK","(","inout","float","eE",",","in","vec2","eF",")","{","float","eG",",","eH",";","eH","=","atan","(","eF",".","y",",","eF",".","x",")",";","eH","*=","(","1.0","+","0.25","*","float","(","NUM_STARS",")",")",";","float","eI","=","cos","(","eH",")",";","float","eJ","=","sin","(","eH",")",";","eH","=","(","eI","*","eF",".","x","+","eJ","*","eF",".","y",")","*","(","eI","*","eF",".","y","-","eJ","*","eF",".","x",")",";","eG",
"=","abs","(","eH",")",";","if","(","eG","<","1.0",")","{","eG","=","(","0.01","*","u_halo_size",")","/","(","eG",")",";","eE","*=","sqrt","(","min","(","eG",",","1.0",")",")",";","}","}","void","main","(",")","{","float","eL","=","(","a",".","x","*","a",".","x","+","a",".","y","*","a",".","y",")",";","float","eM","=","sqrt","(","eL",")",";","eL","=","max","(","1.0","-","eL",",","0.0",")",";","eL","=","pow","(","eL",",","u_halo_hardness",")",";","float","eN","=","u_diffuse_color",".","a",";"]},{type:"condition",
parts:[{type:"if",expression:["NUM_RINGS","||","NUM_LINES"],group:{type:"group",parts:[{type:"textline",tokens:["float","eO","[","ej","]",";","for","(","int","eP","=","0",";","eP","<","ej",";","eP","++",")","{","eO","[","eP","]","=","fract","(","ei","/","float","(","eP",")",")","-","1.0",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS"],group:{type:"group",parts:[{type:"textline",tokens:["float","eQ","=","0.0",";","eu","(","eQ",",","eO",",","eM",")",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["NUM_LINES"],group:{type:"group",parts:[{type:"textline",tokens:["float","eR","=","0.0",";","eD","(","eR",",","eO",",","eL",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["eK","(","eL",",","a",")",";"]}]}}]},{type:"textline",tokens:["eL","*=","eN",";","vec3","eS","=","u_diffuse_color",".","rgb","*","eL",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS"],group:{type:"group",
parts:[{type:"textline",tokens:["eQ","*=","eL",";","eS","+=","u_halo_rings_color","*","eQ",";","eL","+=","eQ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_LINES"],group:{type:"group",parts:[{type:"textline",tokens:["eR","*=","eN",";","eS","+=","u_halo_lines_color","*","eR",";","eL","+=","eR",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["eL","*=","max","(","1.0","-","2.0","*","u_sun_intensity",".","x",
",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","&&","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["float","eT","=","u_halo_stars_blend","*","(","eh",".","y","-","u_halo_stars_height",")",";","eL","*=","clamp","(","eT",",","0.0",",","1.0",")",";","eL","*=","min","(","u_cam_water_depth","+","2.0","*","WAVES_HEIGHT",",","1.0",")",";"]}]}}]}]}}]},{type:"textline",tokens:["ed","(","eS",")",";","eg","(","eS",",","eL",")",";","gl_FragColor","=",
"vec4","(","eS",",","eL",")",";","}"]}]},exports["halo.glslv"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec2","a_halo_bb_vertex",";","uniform","mat4","u_proj_matrix",";","uniform","mat4","u_view_matrix",";","uniform","PRECISION","float","u_halo_size",";","varying","vec2","a",";","varying","float","ei",";"]},{type:"condition",
parts:[{type:"if",expression:["WATER_EFFECTS","&&","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","eh",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec3","ej","=","a_position",";","a","=","a_halo_bb_vertex","*","2.0",";","ei","=","fract","(","ej",".","x","+","ej",".","y","+","ej",".","z",")",";"]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["mat4","ek","=","A","(","ej",",",
"u_view_matrix",")",";","mat4","el","=","u_view_matrix",";","el","[","3","]","[","0","]","=","0.0",";","el","[","3","]","[","1","]","=","0.0",";","el","[","3","]","[","2","]","=","0.0",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","ek","=","A","(","ej",",","u_view_matrix",")",";"]}]}}]},{type:"textline",tokens:["vec4","em","=","vec4","(","a_halo_bb_vertex","*","2.0","*","u_halo_size",",","0.0",",","1.0",")",";","vec4","en","=","ek","*","em",";"]},{type:"condition",
parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","eo","=","u_proj_matrix","*","el","*","en",";","eo",".","z","=","0.99999","*","eo",".","w",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","&&","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["eh","=","en",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","eo","=","u_proj_matrix","*","u_view_matrix","*","en",";"]}]}}]},
{type:"textline",tokens:["gl_Position","=","eo",";","}"]}]},exports["line.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","void","main","(",")","{","gl_FragColor","=","u_diffuse_color",";","}"]}]},exports["line.glslv"]={type:"group",parts:[{type:"var",name:"NUM_POINTS",tokens:["0"]},{type:"textline",tokens:["attribute","float","a_point",";","uniform","vec3","u_line_points","[","NUM_POINTS","]",";","uniform",
"mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","void","main","(",")","{","vec3","ej","=","u_line_points","[","int","(","a_point",")","]",";","gl_Position","=","u_proj_matrix","*","u_view_matrix","*","vec4","(","ej",",","1.0",")",";","}"]}]},exports["main.glslf"]={type:"group",parts:[{type:"var",name:"PARALLAX_STEPS",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"include",file:"std_enums.glsl"},{type:"include",
file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"include",file:"fog.glslf"},{type:"include",file:"lighting.glslf"},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"include",file:"procedural.glslf"},{type:"include",file:"caustics.glslf"}]}}]},{type:"include",file:"gamma.glslf"},{type:"include",file:"math.glslv"},{type:"define",name:"TEXCOORD",tokens:["(","TEXTURE_COLOR","&&","TEXTURE_COORDS","==","TEXTURE_COORDS_UV","||","TEXTURE_STENCIL_ALPHA_MASK",
"||","TEXTURE_SPEC","||","TEXTURE_NORM",")"]},{type:"textline",tokens:["uniform","float","u_time",";","uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";","uniform","float","u_environment_energy",";","uniform","float","u_shadow_visibility_falloff",";","uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors1",
"[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors2","[","NUM_LIGHTS","]",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","&&","CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_sun_quaternion",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COORDS","==","TEXTURE_COORDS_NORMAL"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_view_matrix_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["!",
"DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";","uniform","float","u_cam_water_depth",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","||","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_intensity",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","&&","CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_direction",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG","&&","PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D",
"u_colormap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_SPEC","&&","!","ALPHA_AS_SPEC"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_specmap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_normalmap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"sampler2D","u_colormap1",";","uniform","sampler2D","u_stencil0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_reflectmap",";"]}]}},{type:"elif",expression:["TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","sampler2D","u_shadow_mask",";"]}]}},{type:"elif",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"sampler2D","u_shadow_map2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map3",";"]}]}}]}]}}]},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","uniform","vec2","u_diffuse_params",";","uniform","float","u_diffuse_intensity",";","uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","float","u_normal_factor",";","uniform","vec2","u_normalmap0_uv_velocity",
";","uniform","vec4","u_fresnel_params",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_diffuse_color_factor",";","uniform","vec2","u_colormap0_uv_velocity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_SPEC"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_specular_color_factor",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_specular_color",";","uniform",
"vec2","u_specular_params",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM","&&","PARALLAX"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_parallax_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_reflect_factor",";"]}]}},{type:"elif",expression:["TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",
";"]}]}}]},{type:"textline",tokens:["varying","vec3","hZ",";","varying","vec3","h_",";","varying","vec3","ia",";"]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG","||","(","TEXTURE_NORM","&&","PARALLAX",")","||","(","WATER_EFFECTS","&&","CAUSTICS",")"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cu",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","ib",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","||","DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ic",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_MASK","&&","SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec4","cp",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cs",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",
expression:["REFLECTIVE","||","SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ct",";"]}]}}]},{type:"include",file:"shadow.glslf"},{type:"include",file:"mirror.glslf"},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["float","iz","=","h_",".","y","-","WATER_LEVEL",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],
group:{type:"group",parts:[{type:"textline",tokens:["vec2","iA","=","a",";"]}]}}]},{type:"textline",tokens:["vec3","iB","=","ia",";"]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","gl_FrontFacing",")","iB","=","iB",";","else","iB","=","-","iB",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iC","=","cross","(","iB",",","ib",
".","xyz",")","*","ib",".","w",";","mat3","iD","=","mat3","(","ib",".","xyz",",","iC",",","iB",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG","||","(","TEXTURE_NORM","&&","PARALLAX",")","||","(","WATER_EFFECTS","&&","CAUSTICS",")"],group:{type:"group",parts:[{type:"textline",tokens:["float","iE","=","length","(","cu",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM","&&","PARALLAX"],group:{type:"group",parts:[{type:"textline",tokens:["if",
"(","iE","<","10.0",")","{","float","iF","=","clamp","(","5.0","-","0.5","*","iE",",","0.0",",","1.0",")",";","float","iG","=","u_parallax_scale","*","iF",";","vec3","iH","=","normalize","(","hZ","*","iD",")",";","float","iI","=","1.0","/","PARALLAX_STEPS",";","vec2","iJ","=","iH",".","xy","*","iG","/","(","PARALLAX_STEPS","*","iH",".","z",")",";","float","iK","=","1.0",";","float","iL","=","texture2D","(","u_normalmap0",",","iA",")",".","a",";","for","(","float","iM","=","1.0",";","iM","<=","PARALLAX_STEPS",
";","iM","++",")","{","if","(","iL","<","iK",")","{","iK","-=","iI",";","iA","-=","iJ",";","iL","=","texture2D","(","u_normalmap0",",","iA",")",".","a",";","}","}","vec2","iN","=","iA","+","iJ",";","float","iO","=","texture2D","(","u_normalmap0",",","iN",")",".","a","-","(","iK","+","iI",")",";","float","iP","=","iL","-","iK",";","float","iQ","=","iP","/","(","iP","-","iO",")",";","iA","=","iQ","*","iN","+","(","1.0","-","iQ",")","*","iA",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],
group:{type:"group",parts:[{type:"textline",tokens:["vec4","iR","=","texture2D","(","u_normalmap0",",","iA","+","u_time","*","u_normalmap0_uv_velocity",")",";","vec3","iS","=","iR",".","rgb","-","0.5",";","iS","=","mix","(","vec3","(","0.0",",","0.0",",","1.0",")",",","iS",",","u_normal_factor",")",";","vec3","iT","=","iD","*","iS",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","iT","=","iB",";"]}]}}]},{type:"textline",tokens:["iT","=","normalize","(","iT",")",";",
"vec3","iU","=","normalize","(","hZ",")",";","float","iV","=","0.5","*","iT",".","y","+","0.5",";","vec3","iW","=","u_environment_energy","*","mix","(","u_horizon_color",",","u_zenith_color",",","iV",")",";","vec3","iX","=","u_ambient","*","iW",";"]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","||","DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iY","=","ic",";","eb","(","iY",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR",
"||","DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","iZ","=","vec4","(","iY",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","iZ","=","u_diffuse_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COORDS","==","TEXTURE_COORDS_NORMAL"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","i_","=","normalize",
"(","u_view_matrix_frag","*","vec4","(","iT",",","0.0",")",")",".","st",";","i_","=","i_","*","vec2","(","0.495",")","+","vec2","(","0.5",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","ja","=","texture2D","(","u_colormap0",",","iA",")",";","eb","(","ja",".","rgb",")",";","vec4","jb",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COORDS","==","TEXTURE_COORDS_NORMAL"],group:{type:"group",
parts:[{type:"textline",tokens:["jb","=","texture2D","(","u_colormap1",",","i_",")",";"]}]}},{type:"elif",expression:["TEXTURE_COORDS","==","TEXTURE_COORDS_UV"],group:{type:"group",parts:[{type:"textline",tokens:["jb","=","texture2D","(","u_colormap1",",","iA",")",";"]}]}}]},{type:"textline",tokens:["eb","(","jb",".","rgb",")",";","vec4","jc","=","texture2D","(","u_stencil0",",","iA",")",";","vec4","jd","=","mix","(","ja",",","jb",",","jc",".","r",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["TEXTURE_COORDS","==","TEXTURE_COORDS_NORMAL"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","jd","=","texture2D","(","u_colormap0",",","i_",")",";"]}]}},{type:"elif",expression:["TEXTURE_COORDS","==","TEXTURE_COORDS_UV"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","jd","=","texture2D","(","u_colormap0",",","iA","+","u_time","*","u_colormap0_uv_velocity",")",";"]}]}}]},{type:"textline",tokens:["eb","(","jd",".","rgb",")",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["TEXTURE_BLEND_TYPE","==","TEXTURE_BLEND_TYPE_MIX"],group:{type:"group",parts:[{type:"textline",tokens:["iZ",".","rgb","=","mix","(","iZ",".","rgb",",","jd",".","rgb",",","u_diffuse_color_factor",")",";","iZ",".","a","=","jd",".","a",";"]}]}},{type:"elif",expression:["TEXTURE_BLEND_TYPE","==","TEXTURE_BLEND_TYPE_MULTIPLY"],group:{type:"group",parts:[{type:"textline",tokens:["iZ",".","rgb","*=","mix","(","vec3","(","1.0",")",",","jd",".","rgb",",","u_diffuse_color_factor",
")",";","iZ",".","a","=","jd",".","a",";"]}]}}]}]}}]},{type:"textline",tokens:["vec3","je","=","u_diffuse_intensity","*","iZ",".","rgb",";","float","jf","=","dc","(","u_shadow_visibility_falloff",",","je",")",";","vec3","jg","=","u_emit","*","iZ",".","rgb",";","vec3","jh","=","u_specular_color",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_SPEC"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["ALPHA_AS_SPEC"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","ji","=","vec3","(","iZ",".","a",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","ji","=","texture2D","(","u_specmap",",","iA",")",".","rgb",";"]}]}}]},{type:"textline",tokens:["eb","(","ji",".","rgb",")",";","jh","=","mix","(","jh",",","ji",",","u_specular_color_factor",")",";"]}]}}]},{type:"textline",tokens:["float","jj","=","u_specular_params","[","0","]",";","float","jk","=","u_specular_params","[","1","]",";","vec3","jl","=","jj","*","jh",";",
"eW","jm","=","gz","(","jg",",","iX",",","je",",","jl",",","h_",",","iT",",","iU",",","jk",",","u_diffuse_params",",","jf",",","u_light_positions",",","u_light_directions",",","u_light_color_intensities",",","u_light_factors1",",","u_light_factors2",",","0.0",",","vec4","(","0.0",")",")",";","vec3","jn","=","jm",".","a",".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE","||","TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],
group:{type:"group",parts:[{type:"textline",tokens:["iy","(","jn",",","iU",",","iT",",","u_fresnel_params","[","2","]",",","u_fresnel_params","[","3","]",",","iS",".","st",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["iy","(","jn",",","iU",",","iT",",","u_fresnel_params","[","2","]",",","u_fresnel_params","[","3","]",",","vec2","(","0.0",")",")",";"]}]}}]}]}}]},{type:"textline",tokens:["jn","+=","jm",".","b",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WETTABLE"],group:{type:"group",parts:[{type:"textline",tokens:["jn","=","max","(","jn","-","sqrt","(","0.01","*","-","min","(","iz",",","0.0",")",")",",","0.5","*","jn",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["hY","(","jn",",","iz",",","u_time",",","jf",",","iT",",","u_sun_direction",",","u_sun_intensity",",","u_sun_quaternion",",","h_",
",","iE",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["float","jo","=","iZ",".","a",";","if","(","jo","<","0.5",")","discard",";","jo","=","1.0",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","jo","=","iZ",".","a","+","jm",".","a",".","a","*","jl",".","r",";"]}]}}]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["float","jo","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","jp","=","ev","(","u_cube_fog",",","iU",")",";","vec4","jq","=","vec4","(","jp",",","u_fog_color_density",".","a",")",";","eb","(","jq",".","rgb",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["vec4","jq","=","u_fog_color_density",";","jq",".","rgb","*=","u_sun_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["eM","(","jn",",","iE",",","iU",".","y",",","u_cam_water_depth",",","u_underwater_fog_color_density",",","jq",",","iz",",","length","(","u_sun_intensity",")","+","u_environment_energy",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["eo","(","jn",",","iE",
",","jq",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SSAO_ONLY","&&","SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["jn","=","vec3","(","cv",".","a",")",";"]}]}}]},{type:"textline",tokens:["ed","(","jn",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","&&","!","ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["eg","(","jn",",","jo",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(",
"jn",",","jo",")",";","}"]}]},exports["main.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"define",name:"TEXCOORD",tokens:["(","TEXTURE_COLOR","&&","TEXTURE_COORDS","==","TEXTURE_COORDS_UV","||","TEXTURE_STENCIL_ALPHA_MASK",
"||","TEXTURE_SPEC","||","TEXTURE_NORM",")"]},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_normal",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND",
"||","DYNAMIC_GRASS","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",
";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";","attribute","vec3","a_normal_next",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent_next",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["attribute",
"vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform",
"mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","uniform","vec3","u_camera_eye",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_grass_map_depth",";","uniform","sampler2D","u_grass_map_color",";","uniform","vec4","u_camera_quat",
";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES",
"]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","PRECISION","float","u_time",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_MASK","&&","SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_v_light_matrix",";","uniform","mat4","u_b_light_matrix",";","uniform",
"mat4","u_p_light_matrix0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix3",
";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec3","hZ",";","varying","vec3","h_",";","varying","vec3","ia",";"]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG","||","(","TEXTURE_NORM","&&","PARALLAX",")","||","(","WATER_EFFECTS","&&","CAUSTICS",")"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cu",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","ib",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","||","DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ic",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_MASK","&&","SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec4","cp",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cs",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",
expression:["REFLECTIVE","||","SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ct",";"]}]}}]},{type:"include",file:"dynamic_grass.glslv"},{type:"include",file:"shadow.glslv"},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"textline",tokens:["void","main","(",")","{","vec3","iz","=","a_position",";","vec3","iA","=","a_normal",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],group:{type:"group",
parts:[{type:"textline",tokens:["vec3","iB","=","vec3","(","a_tangent",")",";","vec3","iC","=","a_tangent","[","3","]","*","cross","(","iA",",","iB",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","iB","=","vec3","(","0.0",")",";","vec3","iC","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["iz","=","mix","(","iz",",","a_position_next",",","u_va_frame_factor",
")",";","iA","=","mix","(","iA",",","a_normal_next",",","u_va_frame_factor",")",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iD","=","vec3","(","a_tangent",")",";","vec3","iE","=","a_tangent_next","[","3","]","*","cross","(","a_normal_next",",","iD",")",";","iB","=","mix","(","iB",",","iD",",","u_va_frame_factor",")",";","iC","=","mix","(","iC",",","iE",",","u_va_frame_factor",")",";"]}]}}]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["bn","(","iz",",","iB",",","iC",",","iA",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","||","DYNAMIC_GRASS","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iF","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","iF","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM"],
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["b","iG","=","dT","(","iz",",","iB",",","iC",",","iA",",","iF",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","u_view_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","iH","=","(","u_model_matrix","*","vec4","(","iF",",","1.0",")",")",".","xyz",";","mat4","iI","=","ab","(","u_camera_eye",",","iH",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iJ","=","(","u_model_matrix","*","vec4","(","iF",",","1.0",")",")",".","xyz",";","iI","=","iI","*","R","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","iJ",
")",";"]}]}}]},{type:"textline",tokens:["b","iG","=","ai","(","iz","-","iF",",","iF",",","iB",",","iC",",","iA",",","iI",")",";","iG",".","b","=","iH",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["b","iG","=","ai","(","iz",",","iF",",","iB",",","iC",",","iA",",","u_model_matrix",")",";"]}]}}]}]}}]},{type:"textline",tokens:["float","iK","=","(","dot","(","cross","(","iG",".","e",",","iG",".","c",")",",","iG",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","ib","=",
"vec4","(","iG",".","c",",","iK",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["b","iG","=","dT","(","iz",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","iA",",","iF",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","u_view_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iH","=","(","u_model_matrix","*","vec4","(","iF",",","1.0",")",")",".","xyz",";","mat4","iI","=","ab","(","u_camera_eye",",","iH",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iJ","=","(","u_model_matrix","*","vec4","(","iF",",","1.0",")",")",".","xyz",";",
"iI","=","iI","*","R","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","iJ",")",";"]}]}}]},{type:"textline",tokens:["b","iG","=","ai","(","iz","-","iF",",","iF",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","iA",",","iI",")",";","iG",".","b","=","iH",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["b","iG","=","ai","(","iz",",","iF",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","iA",",","u_model_matrix",")",";"]}]}}]}]}}]}]}}]},{type:"condition",
parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["ce","(","iG",".","a",",","iG",".","b",",","iA",")",";"]}]}}]},{type:"textline",tokens:["h_","=","iG",".","a",";","ia","=","iG",".","e",";","hZ","=","u_camera_eye","-","iG",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["a","=","al","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],
group:{type:"group",parts:[{type:"textline",tokens:["ic","=","iG",".","f",";"]}]}},{type:"elif",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["ic","=","a_color",";"]}]}}]},{type:"textline",tokens:["vec4","iL","=","u_view_matrix","*","vec4","(","iG",".","a",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG","||","(","TEXTURE_NORM","&&","PARALLAX",")","||","(","WATER_EFFECTS","&&","CAUSTICS",")"],group:{type:"group",parts:[{type:"textline",
tokens:["cu","=","iL",";"]}]}}]},{type:"textline",tokens:["vec4","iM","=","u_proj_matrix","*","iL",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["iM",".","xy","+=","u_subpixel_jitter","*","iM",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["dV","(","iM",")",";"]}]}},{type:"elif",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],
group:{type:"group",parts:[{type:"textline",tokens:["dV","(","iG",".","a",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["float","iN","=","iM",".","x",";","float","iO","=","iM",".","y",";","float","iP","=","iM",".","w",";","ct",".","x","=","(","iN","+","iP",")","/","2.0",";","ct",".","y","=","(","iO","+","iP",")","/","2.0",";","ct",".","z","=","iP",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","iM",";","}"]}]},
exports["nodes.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"include",file:"fog.glslf"},{type:"include",file:"lighting.glslf"},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"include",file:"procedural.glslf"},{type:"include",file:"caustics.glslf"}]}}]},
{type:"include",file:"gamma.glslf"},{type:"include",file:"math.glslv"},{type:"textline",tokens:["uniform","float","u_time",";","uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";","uniform","float","u_environment_energy",";","uniform","float","u_shadow_visibility_falloff",";","uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform",
"vec4","u_light_factors1","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors2","[","NUM_LIGHTS","]",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","&&","CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_sun_quaternion",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["!",
"DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";","uniform","float","u_cam_water_depth",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","||","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_intensity",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADED","&&","WATER_EFFECTS","&&","CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_direction",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG","&&","PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix_frag",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_reflectmap",";"]}]}},{type:"elif",expression:["TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_mask",";"]}]}},{type:"elif",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_map2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","sampler2D","u_shadow_map3",";"]}]}}]}]}}]},{type:"textline",tokens:["uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_reflect_factor",";"]}]}},{type:"elif",expression:["TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}}]},{type:"textline",
tokens:["varying","vec3","h_",";","varying","vec4","cu",";"]},{type:"condition",parts:[{type:"if",expression:["SHADED","||","USE_NODE_GEOMETRY_NO"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ia",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","ib",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_MASK","&&","SHADOW_SRC","!=","SHADOW_SRC_NONE"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cp",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec4","cs",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE","||","SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ct",";"]}]}}]},{type:"textline",tokens:["float","iz","=","0.0",";","float","iA","=","1.0",";"]},{type:"include",file:"shadow.glslf"},{type:"include",file:"mirror.glslf"},{type:"condition",parts:[{type:"if",expression:["USE_NODE_HUE_SAT","||","USE_NODE_MIX_RGB_HUE","||","USE_NODE_MIX_RGB_SATURATION",
"||","USE_NODE_MIX_RGB_VALUE","||","USE_NODE_MIX_RGB_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iJ","(","vec3","iB",")","{","float","iC",",","iD",",","iE",",","iF",",","iG",",","iH",";","vec3","iI",";","iC","=","max","(","iB","[","0","]",",","max","(","iB","[","1","]",",","iB","[","2","]",")",")",";","iD","=","min","(","iB","[","0","]",",","min","(","iB","[","1","]",",","iB","[","2","]",")",")",";","iH","=","iC","-","iD",";","iG","=","iC",";","if","(","iC","!=","iz",")","iF",
"=","iH","/","iC",";","else","{","iF","=","iz",";","iE","=","iz",";","}","if","(","e","(","iF",",","iz",")",")","{","iE","=","iz",";","}","else","{","iI","=","(","vec3","(","iC",",","iC",",","iC",")","-","iB",".","xyz",")","/","iH",";","if","(","e","(","iB",".","x",",","iC",")",")","iE","=","iI","[","2","]","-","iI","[","1","]",";","else","if","(","e","(","iB",".","y",",","iC",")",")","iE","=","2.0","+","iI","[","0","]","-","iI","[","2","]",";","else","iE","=","4.0","+","iI","[","1","]","-","iI",
"[","0","]",";","iE","/=","6.0",";","if","(","iE","<","iz",")","iE","+=","iA",";","}","return","vec3","(","iE",",","iF",",","iG",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_HUE_SAT","||","USE_NODE_MIX_RGB_HUE","||","USE_NODE_MIX_RGB_SATURATION","||","USE_NODE_MIX_RGB_VALUE","||","USE_NODE_MIX_RGB_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iU","(","vec3","iK",")","{","float","iL",",","iM",",","iN",",","iO",",","iP",",","iQ",",","iR",",","iS",
";","vec3","iT",";","iQ","=","iK","[","0","]",";","iR","=","iK","[","1","]",";","iS","=","iK","[","2","]",";","if","(","e","(","iR",",","iz",")",")","{","iT","=","vec3","(","iS",",","iS",",","iS",")",";","}","else","{","if","(","e","(","iQ",",","iz",")",")","iQ","=","iz",";","iQ","*=","6.0",";","iL","=","floor","(","iQ",")",";","iM","=","iQ","-","iL",";","iT","=","vec3","(","iM",",","iM",",","iM",")",";","iN","=","iS","*","(","iA","-","iR",")",";","iO","=","iS","*","(","iA","-","(","iR","*","iM",
")",")",";","iP","=","iS","*","(","iA","-","(","iR","*","(","iA","-","iM",")",")",")",";","if","(","e","(","iL",",","iz",")",")","iT","=","vec3","(","iS",",","iP",",","iN",")",";","else","if","(","e","(","iL",",","iA",")",")","iT","=","vec3","(","iO",",","iS",",","iN",")",";","else","if","(","e","(","iL",",","2.0",")",")","iT","=","vec3","(","iN",",","iS",",","iP",")",";","else","if","(","e","(","iL",",","3.0",")",")","iT","=","vec3","(","iN",",","iO",",","iS",")",";","else","if","(","e","(","iL",
",","4.0",")",")","iT","=","vec3","(","iP",",","iN",",","iS",")",";","else","iT","=","vec3","(","iS",",","iN",",","iO",")",";","}","return","iT",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_UV","||","USE_NODE_PARALLAX"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iW","(","vec2","iV",")","{","return","vec3","(","iV","*","2.0","-","vec2","(","iA",",","iA",")",",","iz",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_TEXTURE_COLOR",
"||","USE_NODE_TEXTURE_NORMAL","||","USE_NODE_TEXTURE_COLOR2","||","USE_NODE_TEXTURE_NORMAL2","||","USE_NODE_TEXTURE_COLOR3","||","USE_NODE_TEXTURE_NORMAL3","||","USE_NODE_PARALLAX"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","iY","(","vec3","iX",")","{","return","vec2","(","iX",".","xy","*","0.5","+","vec2","(","0.5",",","0.5",")",")",";","}"]}]}}]},{type:"node",name:"CAMERA",group:{type:"group",parts:[{type:"node_out",name:"jN",qualifier:["vec3"]},{type:"node_out",name:"jO",qualifier:["float"]},
{type:"node_out",name:"jP",qualifier:["float"]},{type:"textline",tokens:["jN","=","normalize","(","jC",".","xyz",")",";","jO","=","abs","(","jC",".","z",")",";","jP","=","length","(","jC",".","xyz",")",";"]}]}},{type:"node",name:"COMBRGB",group:{type:"group",parts:[{type:"node_in",name:"jQ",qualifier:["float"]},{type:"node_in",name:"jR",qualifier:["float"]},{type:"node_in",name:"jS",qualifier:["float"]},{type:"node_out",name:"jT",qualifier:["vec3"]},{type:"textline",tokens:["jT","=","vec3","(","jQ",
",","jR",",","jS",")",";"]}]}},{type:"node",name:"GEOMETRY_UV",group:{type:"group",parts:[{type:"node_param",name:"iZ",qualifier:["varying","vec2"]},{type:"node_out",name:"jU",qualifier:["vec3"]},{type:"textline",tokens:["jU","=","iW","(","iZ",")",";"]}]}},{type:"node",name:"GEOMETRY_VC",group:{type:"group",parts:[{type:"node_param",name:"i_",qualifier:["varying","vec3"]},{type:"node_out",name:"jV",qualifier:["vec3"]},{type:"textline",tokens:["jV","=","i_",";"]}]}},{type:"node",name:"GEOMETRY_VC1",
group:{type:"group",parts:[{type:"node_param",name:"ja",qualifier:["varying","float"]},{type:"node_out",name:"jW",qualifier:["float"]},{type:"textline",tokens:["jW","=","ja",";"]}]}},{type:"node",name:"GEOMETRY_VC2",group:{type:"group",parts:[{type:"node_param",name:"jb",qualifier:["varying","vec2"]},{type:"node_out",name:"jX",qualifier:["float"]},{type:"node_out",name:"jY",qualifier:["float"]},{type:"textline",tokens:["jX","=","jb","[","0","]",";","jY","=","jb","[","1","]",";"]}]}},{type:"node",
name:"GEOMETRY_VC3",group:{type:"group",parts:[{type:"node_param",name:"jc",qualifier:["varying","vec3"]},{type:"node_out",name:"jZ",qualifier:["float"]},{type:"node_out",name:"j_",qualifier:["float"]},{type:"node_out",name:"ka",qualifier:["float"]},{type:"textline",tokens:["jZ","=","jc","[","0","]",";","j_","=","jc","[","1","]",";","ka","=","jc","[","2","]",";"]}]}},{type:"node",name:"GEOMETRY_NO",group:{type:"group",parts:[{type:"node_out",name:"kb",qualifier:["vec3"]},{type:"textline",tokens:["kb",
"=","jw",";"]}]}},{type:"node",name:"GEOMETRY_FB",group:{type:"group",parts:[{type:"node_out",name:"kc",qualifier:["float"]},{type:"textline",tokens:["kc","=","(","gl_FrontFacing",")","?","iA",":","iz",";"]}]}},{type:"node",name:"GEOMETRY_VW",group:{type:"group",parts:[{type:"node_out",name:"kd",qualifier:["vec3"]},{type:"textline",tokens:["kd","=","jA",";"]}]}},{type:"node",name:"GEOMETRY_GL",group:{type:"group",parts:[{type:"node_out",name:"ke",qualifier:["vec3"]},{type:"textline",tokens:["ke",
"=","vec3","(","jB",".","r",",","-","jB",".","b",",","jB",".","g",")",";"]}]}},{type:"node",name:"HUE_SAT",group:{type:"group",parts:[{type:"node_in",name:"kf",qualifier:["float"]},{type:"node_in",name:"kg",qualifier:["float"]},{type:"node_in",name:"kh",qualifier:["float"]},{type:"node_in",name:"ki",qualifier:["float"]},{type:"node_in",name:"kj",qualifier:["vec3"]},{type:"node_out",name:"kk",qualifier:["vec3"]},{type:"textline",tokens:["{","vec3","kl","=","iJ","(","kj",")",";","kl","[","0","]","+=",
"(","kf","-","0.5",")",";","if","(","kl","[","0","]",">","iA",")","kl","[","0","]","-=","iA",";","else","if","(","kl","[","0","]","<","iz",")","kl","[","0","]","+=","iA",";","kl","[","1","]","*=","kg",";","if","(","kl","[","1","]",">","iA",")","kl","[","1","]","=","iA",";","else","if","(","kl","[","1","]","<","iz",")","kl","[","1","]","=","iz",";","kl","[","2","]","*=","kh",";","if","(","kl","[","2","]",">","iA",")","kl","[","2","]","=","iA",";","else","if","(","kl","[","2","]","<","iz",")","kl",
"[","2","]","=","iz",";","kk","=","mix","(","kj",",","iU","(","kl",")",",","ki",")",";","}"]}]}},{type:"node",name:"INVERT",group:{type:"group",parts:[{type:"node_in",name:"km",qualifier:["float"]},{type:"node_in",name:"kn",qualifier:["vec3"]},{type:"node_out",name:"ko",qualifier:["vec3"]},{type:"textline",tokens:["ko","=","mix","(","kn",",","vec3","(","iA",")","-","kn",",","km",")",";"]}]}},{type:"node",name:"NORMAL",group:{type:"group",parts:[{type:"node_param",name:"jd",qualifier:["vec3"]},{type:"node_in",
name:"kp",qualifier:["vec3"]},{type:"node_out",name:"kq",qualifier:["vec3"]},{type:"node_out",name:"kr",qualifier:["float"]},{type:"textline",tokens:["kq","=","jd",";","kr","=","-","dot","(","kp",",","jd",")",";"]}]}},{type:"node",name:"NORMAL_VIEW",group:{type:"group",parts:[{type:"node_in",name:"ks",qualifier:["vec3"]},{type:"node_out",name:"kt",qualifier:["vec3"]},{type:"textline",tokens:["kt","=","-","(","u_view_matrix_frag","*","vec4","(","ks",",","iz",")",")",".","xyz",";"]}]}},{type:"node",
name:"MAPPING_LIGHT",group:{type:"group",parts:[{type:"node_param",name:"je",qualifier:["vec3"]},{type:"node_in",name:"ku",qualifier:["vec3"]},{type:"node_out",name:"kv",qualifier:["vec3"]},{type:"textline",tokens:["kv","=","ku","*","je",";"]}]}},{type:"node",name:"MAPPING_HEAVY",group:{type:"group",parts:[{type:"node_param",name:"jf",qualifier:["mat4"]},{type:"node_param",name:"jg",qualifier:["const","float"]},{type:"node_param",name:"jh",qualifier:["const","float"]},{type:"node_param",name:"ji",
qualifier:["vec3"]},{type:"node_param",name:"jj",qualifier:["vec3"]},{type:"node_in",name:"kw",qualifier:["vec3"]},{type:"node_out",name:"kx",qualifier:["vec3"]},{type:"textline",tokens:["kx","=","(","jf","*","vec4","(","kw",",","iA",")",")",".","xyz",";","if","(","jg","==","iA",")","kx","=","max","(","kx",",","ji",")",";","if","(","jh","==","iA",")","kx","=","min","(","kx",",","jj",")",";"]}]}},{type:"node",name:"MATH_ADD",group:{type:"group",parts:[{type:"node_in",name:"ky",qualifier:["float"]},
{type:"node_in",name:"kz",qualifier:["float"]},{type:"node_out",name:"kA",qualifier:["float"]},{type:"textline",tokens:["kA","=","ky","+","kz",";"]}]}},{type:"node",name:"MATH_SUBTRACT",group:{type:"group",parts:[{type:"node_in",name:"kB",qualifier:["float"]},{type:"node_in",name:"kC",qualifier:["float"]},{type:"node_out",name:"kD",qualifier:["float"]},{type:"textline",tokens:["kD","=","kB","-","kC",";"]}]}},{type:"node",name:"MATH_MULTIPLY",group:{type:"group",parts:[{type:"node_in",name:"kE",qualifier:["float"]},
{type:"node_in",name:"kF",qualifier:["float"]},{type:"node_out",name:"kG",qualifier:["float"]},{type:"textline",tokens:["kG","=","kE","*","kF",";"]}]}},{type:"node",name:"MATH_DIVIDE",group:{type:"group",parts:[{type:"node_in",name:"kH",qualifier:["float"]},{type:"node_in",name:"kI",qualifier:["float"]},{type:"node_out",name:"kJ",qualifier:["float"]},{type:"textline",tokens:["kJ","=","(","kI","!=","iz",")","?","kH","/","kI",":","iz",";"]}]}},{type:"node",name:"MATH_SINE",group:{type:"group",parts:[{type:"node_in",
name:"kK",qualifier:["float"]},{type:"node_in",name:"kL",qualifier:["float"]},{type:"node_out",name:"kM",qualifier:["float"]},{type:"textline",tokens:["kM","=","sin","(","kK",")",";","kL",";"]}]}},{type:"node",name:"MATH_COSINE",group:{type:"group",parts:[{type:"node_in",name:"kN",qualifier:["float"]},{type:"node_in",name:"kO",qualifier:["float"]},{type:"node_out",name:"kP",qualifier:["float"]},{type:"textline",tokens:["kP","=","cos","(","kN",")",";","kO",";"]}]}},{type:"node",name:"MATH_TANGENT",
group:{type:"group",parts:[{type:"node_in",name:"kQ",qualifier:["float"]},{type:"node_in",name:"kR",qualifier:["float"]},{type:"node_out",name:"kS",qualifier:["float"]},{type:"textline",tokens:["kS","=","tan","(","kQ",")",";","kR",";"]}]}},{type:"node",name:"MATH_ARCSINE",group:{type:"group",parts:[{type:"node_in",name:"kT",qualifier:["float"]},{type:"node_in",name:"kU",qualifier:["float"]},{type:"node_out",name:"kV",qualifier:["float"]},{type:"textline",tokens:["kV","=","(","kT","<=","iA","&&","kT",
">=","-","iA",")","?","asin","(","kT",")",":","iz",";","kU",";"]}]}},{type:"node",name:"MATH_ARCCOSINE",group:{type:"group",parts:[{type:"node_in",name:"kW",qualifier:["float"]},{type:"node_in",name:"kX",qualifier:["float"]},{type:"node_out",name:"kY",qualifier:["float"]},{type:"textline",tokens:["kY","=","(","kW","<=","iA","&&","kW",">=","-","iA",")","?","acos","(","kW",")",":","iz",";","kX",";"]}]}},{type:"node",name:"MATH_ARCTANGENT",group:{type:"group",parts:[{type:"node_in",name:"kZ",qualifier:["float"]},
{type:"node_in",name:"k_",qualifier:["float"]},{type:"node_out",name:"la",qualifier:["float"]},{type:"textline",tokens:["la","=","atan","(","kZ",")",";","k_",";"]}]}},{type:"node",name:"MATH_POWER",group:{type:"group",parts:[{type:"node_in",name:"lb",qualifier:["float"]},{type:"node_in",name:"lc",qualifier:["float"]},{type:"node_out",name:"ld",qualifier:["float"]},{type:"textline",tokens:["ld","=","pow","(","lb",",","lc",")",";"]}]}},{type:"node",name:"MATH_LOGARITHM",group:{type:"group",parts:[{type:"node_in",
name:"le",qualifier:["float"]},{type:"node_in",name:"lf",qualifier:["float"]},{type:"node_out",name:"lg",qualifier:["float"]},{type:"textline",tokens:["lg","=","(","le",">","iz","&&","lf",">","iz",")","?","log2","(","le",")","/","log2","(","lf",")",":","iz",";"]}]}},{type:"node",name:"MATH_MINIMUM",group:{type:"group",parts:[{type:"node_in",name:"lh",qualifier:["float"]},{type:"node_in",name:"li",qualifier:["float"]},{type:"node_out",name:"lj",qualifier:["float"]},{type:"textline",tokens:["lj","=",
"min","(","lh",",","li",")",";"]}]}},{type:"node",name:"MATH_MAXIMUM",group:{type:"group",parts:[{type:"node_in",name:"lk",qualifier:["float"]},{type:"node_in",name:"ll",qualifier:["float"]},{type:"node_out",name:"lm",qualifier:["float"]},{type:"textline",tokens:["lm","=","max","(","lk",",","ll",")",";"]}]}},{type:"node",name:"MATH_ROUND",group:{type:"group",parts:[{type:"node_in",name:"ln",qualifier:["float"]},{type:"node_in",name:"lo",qualifier:["float"]},{type:"node_out",name:"lp",qualifier:["float"]},
{type:"textline",tokens:["lp","=","floor","(","ln","+","0.5",")",";","lo",";"]}]}},{type:"node",name:"MATH_LESS_THAN",group:{type:"group",parts:[{type:"node_in",name:"lq",qualifier:["float"]},{type:"node_in",name:"lr",qualifier:["float"]},{type:"node_out",name:"ls",qualifier:["float"]},{type:"textline",tokens:["ls","=","(","lq","<","lr",")","?","iA",":","iz",";"]}]}},{type:"node",name:"MATH_GREATER_THAN",group:{type:"group",parts:[{type:"node_in",name:"lt",qualifier:["float"]},{type:"node_in",name:"lu",
qualifier:["float"]},{type:"node_out",name:"lv",qualifier:["float"]},{type:"textline",tokens:["lv","=","lt","+","lu",";","lv","=","(","lt",">","lu",")","?","iA",":","iz",";"]}]}},{type:"node",name:"MATH_MODULO",group:{type:"group",parts:[{type:"node_in",name:"lw",qualifier:["float"]},{type:"node_in",name:"lx",qualifier:["float"]},{type:"node_out",name:"ly",qualifier:["float"]},{type:"textline",tokens:["ly","=","abs","(","lx",")",">","0.000001","?","mod","(","lw",",","lx",")",":","iz",";"]}]}},{type:"node",
name:"MIX_RGB_MIX",group:{type:"group",parts:[{type:"node_in",name:"lz",qualifier:["float"]},{type:"node_in",name:"lA",qualifier:["vec3"]},{type:"node_in",name:"lB",qualifier:["vec3"]},{type:"node_out",name:"lC",qualifier:["vec3"]},{type:"textline",tokens:["{","float","lD","=","clamp","(","lz",",","iz",",","iA",")",";","lC","=","mix","(","lA",",","lB",",","lD",")",";","}"]}]}},{type:"node",name:"MIX_RGB_ADD",group:{type:"group",parts:[{type:"node_in",name:"lE",qualifier:["float"]},{type:"node_in",
name:"lF",qualifier:["vec3"]},{type:"node_in",name:"lG",qualifier:["vec3"]},{type:"node_out",name:"lH",qualifier:["vec3"]},{type:"textline",tokens:["{","float","lI","=","clamp","(","lE",",","iz",",","iA",")",";","lH","=","mix","(","lF",",","lF","+","lG",",","lI",")",";","}"]}]}},{type:"node",name:"MIX_RGB_MULTIPLY",group:{type:"group",parts:[{type:"node_in",name:"lJ",qualifier:["float"]},{type:"node_in",name:"lK",qualifier:["vec3"]},{type:"node_in",name:"lL",qualifier:["vec3"]},{type:"node_out",name:"lM",
qualifier:["vec3"]},{type:"textline",tokens:["{","float","lN","=","clamp","(","lJ",",","iz",",","iA",")",";","lM","=","mix","(","lK",",","lK","*","lL",",","lN",")",";","}"]}]}},{type:"node",name:"MIX_RGB_SUBTRACT",group:{type:"group",parts:[{type:"node_in",name:"lO",qualifier:["float"]},{type:"node_in",name:"lP",qualifier:["vec3"]},{type:"node_in",name:"lQ",qualifier:["vec3"]},{type:"node_out",name:"lR",qualifier:["vec3"]},{type:"textline",tokens:["{","float","lS","=","clamp","(","lO",",","iz",",",
"iA",")",";","lR","=","mix","(","lP",",","lP","-","lQ",",","lS",")",";","}"]}]}},{type:"node",name:"MIX_RGB_SCREEN",group:{type:"group",parts:[{type:"node_in",name:"lT",qualifier:["float"]},{type:"node_in",name:"lU",qualifier:["vec3"]},{type:"node_in",name:"lV",qualifier:["vec3"]},{type:"node_out",name:"lW",qualifier:["vec3"]},{type:"textline",tokens:["{","float","lX","=","clamp","(","lT",",","iz",",","iA",")",";","float","lY","=","iA","-","lX",";","lW","=","vec3","(","iA",")","-","(","vec3","(",
"lY",")","+","lX","*","(","vec3","(","iA",")","-","lV",")",")","*","(","vec3","(","iA",")","-","lU",")",";","}"]}]}},{type:"node",name:"MIX_RGB_DIVIDE",group:{type:"group",parts:[{type:"node_in",name:"lZ",qualifier:["float"]},{type:"node_in",name:"l_",qualifier:["vec3"]},{type:"node_in",name:"ma",qualifier:["vec3"]},{type:"node_out",name:"mb",qualifier:["vec3"]},{type:"textline",tokens:["{","float","mc","=","clamp","(","lZ",",","iz",",","iA",")",";","float","md","=","iA","-","mc",";","mb","=","l_",
";","if","(","ma",".","r","!=","iz",")","mb",".","r","=","md","*","mb",".","r","+","mc","*","mb",".","r","/","ma",".","r",";","if","(","ma",".","g","!=","iz",")","mb",".","g","=","md","*","mb",".","g","+","mc","*","mb",".","g","/","ma",".","g",";","if","(","ma",".","b","!=","iz",")","mb",".","b","=","md","*","mb",".","b","+","mc","*","mb",".","b","/","ma",".","b",";","}"]}]}},{type:"node",name:"MIX_RGB_DIFFERENCE",group:{type:"group",parts:[{type:"node_in",name:"me",qualifier:["float"]},{type:"node_in",
name:"mf",qualifier:["vec3"]},{type:"node_in",name:"mg",qualifier:["vec3"]},{type:"node_out",name:"mh",qualifier:["vec3"]},{type:"textline",tokens:["{","float","mi","=","clamp","(","me",",","iz",",","iA",")",";","mh","=","mix","(","mf",",","abs","(","mf","-","mg",")",",","mi",")",";","}"]}]}},{type:"node",name:"MIX_RGB_DARKEN",group:{type:"group",parts:[{type:"node_in",name:"mj",qualifier:["float"]},{type:"node_in",name:"mk",qualifier:["vec3"]},{type:"node_in",name:"ml",qualifier:["vec3"]},{type:"node_out",
name:"mm",qualifier:["vec3"]},{type:"textline",tokens:["{","float","mn","=","clamp","(","mj",",","iz",",","iA",")",";","mm","=","min","(","mk",".","rgb",",","ml",".","rgb","*","mn",")",";","}"]}]}},{type:"node",name:"MIX_RGB_LIGHTEN",group:{type:"group",parts:[{type:"node_in",name:"mo",qualifier:["float"]},{type:"node_in",name:"mp",qualifier:["vec3"]},{type:"node_in",name:"mq",qualifier:["vec3"]},{type:"node_out",name:"mr",qualifier:["vec3"]},{type:"textline",tokens:["{","float","ms","=","clamp",
"(","mo",",","iz",",","iA",")",";","mr","=","max","(","mp",".","rgb",",","mq",".","rgb","*","ms",")",";","}"]}]}},{type:"node",name:"MIX_RGB_OVERLAY",group:{type:"group",parts:[{type:"node_in",name:"mt",qualifier:["float"]},{type:"node_in",name:"mu",qualifier:["vec3"]},{type:"node_in",name:"mv",qualifier:["vec3"]},{type:"node_out",name:"mw",qualifier:["vec3"]},{type:"textline",tokens:["{","float","mx","=","clamp","(","mt",",","iz",",","iA",")",";","float","my","=","iA","-","mx",";","mw","=","mu",
";","if","(","mw",".","r","<","0.5",")","mw",".","r","*=","my","+","2.0","*","mx","*","mv",".","r",";","else","mw",".","r","=","iA","-","(","my","+","2.0","*","mx","*","(","iA","-","mv",".","r",")",")","*","(","iA","-","mw",".","r",")",";","if","(","mw",".","g","<","0.5",")","mw",".","g","*=","my","+","2.0","*","mx","*","mv",".","g",";","else","mw",".","g","=","iA","-","(","my","+","2.0","*","mx","*","(","iA","-","mv",".","g",")",")","*","(","iA","-","mw",".","g",")",";","if","(","mw",".","b","<",
"0.5",")","mw",".","b","*=","my","+","2.0","*","mx","*","mv",".","b",";","else","mw",".","b","=","iA","-","(","my","+","2.0","*","mx","*","(","iA","-","mv",".","b",")",")","*","(","iA","-","mw",".","b",")",";","}"]}]}},{type:"node",name:"MIX_RGB_DODGE",group:{type:"group",parts:[{type:"node_in",name:"mz",qualifier:["float"]},{type:"node_in",name:"mA",qualifier:["vec3"]},{type:"node_in",name:"mB",qualifier:["vec3"]},{type:"node_out",name:"mC",qualifier:["vec3"]},{type:"textline",tokens:["{","float",
"mD","=","clamp","(","mz",",","iz",",","iA",")",";","mC","=","mA",";","if","(","mC",".","r","!=","iz",")","{","float","mE","=","iA","-","mD","*","mB",".","r",";","if","(","mE","<=","iz",")","mC",".","r","=","iA",";","else","if","(","(","mE","=","mC",".","r","/","mE",")",">","iA",")","mC",".","r","=","iA",";","else","mC",".","r","=","mE",";","}","if","(","mC",".","g","!=","iz",")","{","float","mF","=","iA","-","mD","*","mB",".","g",";","if","(","mF","<=","iz",")","mC",".","g","=","iA",";","else","if",
"(","(","mF","=","mC",".","g","/","mF",")",">","iA",")","mC",".","g","=","iA",";","else","mC",".","g","=","mF",";","}","if","(","mC",".","b","!=","iz",")","{","float","mG","=","iA","-","mD","*","mB",".","b",";","if","(","mG","<=","iz",")","mC",".","b","=","iA",";","else","if","(","(","mG","=","mC",".","b","/","mG",")",">","iA",")","mC",".","b","=","iA",";","else","mC",".","b","=","mG",";","}","}"]}]}},{type:"node",name:"MIX_RGB_BURN",group:{type:"group",parts:[{type:"node_in",name:"mH",qualifier:["float"]},
{type:"node_in",name:"mI",qualifier:["vec3"]},{type:"node_in",name:"mJ",qualifier:["vec3"]},{type:"node_out",name:"mK",qualifier:["vec3"]},{type:"textline",tokens:["{","float","mL","=","clamp","(","mH",",","iz",",","iA",")",";","float","mM","=","iA","-","mL",";","float","mN",";","mK","=","mI",";","mN","=","mM","+","mL","*","mJ",".","r",";","if","(","mN","<=","iz",")","mK",".","r","=","iz",";","else","if","(","(","mN","=","(","iA","-","(","iA","-","mK",".","r",")","/","mN",")",")","<","iz",")","mK",
".","r","=","iz",";","else","if","(","mN",">","iA",")","mK",".","r","=","iA",";","else","mK",".","r","=","mN",";","mN","=","mM","+","mL","*","mJ",".","g",";","if","(","mN","<=","iz",")","mK",".","g","=","iz",";","else","if","(","(","mN","=","(","iA","-","(","iA","-","mK",".","g",")","/","mN",")",")","<","iz",")","mK",".","g","=","iz",";","else","if","(","mN",">","iA",")","mK",".","g","=","iA",";","else","mK",".","g","=","mN",";","mN","=","mM","+","mL","*","mJ",".","b",";","if","(","mN","<=","iz",
")","mK",".","b","=","iz",";","else","if","(","(","mN","=","(","iA","-","(","iA","-","mK",".","b",")","/","mN",")",")","<","iz",")","mK",".","b","=","iz",";","else","if","(","mN",">","iA",")","mK",".","b","=","iA",";","else","mK",".","b","=","mN",";","}"]}]}},{type:"node",name:"MIX_RGB_HUE",group:{type:"group",parts:[{type:"node_in",name:"mO",qualifier:["float"]},{type:"node_in",name:"mP",qualifier:["vec3"]},{type:"node_in",name:"mQ",qualifier:["vec3"]},{type:"node_out",name:"mR",qualifier:["vec3"]},
{type:"textline",tokens:["{","float","mS","=","clamp","(","mO",",","iz",",","iA",")",";","vec3","mT",",","mU",",","mV",";","mR","=","mP",";","mU","=","iJ","(","mQ",")",";","if","(","mU",".","y","!=","iz",")","{","mT","=","iJ","(","mR",")",";","mT",".","x","=","mU",".","x",";","mV","=","iU","(","mT",")",";","mR","=","mix","(","mR",",","mV",",","mS",")",";","}","}"]}]}},{type:"node",name:"MIX_RGB_SATURATION",group:{type:"group",parts:[{type:"node_in",name:"mW",qualifier:["float"]},{type:"node_in",name:"mX",
qualifier:["vec3"]},{type:"node_in",name:"mY",qualifier:["vec3"]},{type:"node_out",name:"mZ",qualifier:["vec3"]},{type:"textline",tokens:["{","float","m_","=","clamp","(","mW",",","iz",",","iA",")",";","float","na","=","iA","-","m_",";","mZ","=","mX",";","vec3","nb",",","nc",";","nb","=","iJ","(","mZ",")",";","if","(","nb",".","y","!=","iz",")","{","nc","=","iJ","(","mY",")",";","nb",".","y","=","na","*","nb",".","y","+","m_","*","nc",".","y",";","mZ","=","iU","(","nb",")",";","}","}"]}]}},{type:"node",
name:"MIX_RGB_VALUE",group:{type:"group",parts:[{type:"node_in",name:"nd",qualifier:["float"]},{type:"node_in",name:"ne",qualifier:["vec3"]},{type:"node_in",name:"nf",qualifier:["vec3"]},{type:"node_out",name:"ng",qualifier:["vec3"]},{type:"textline",tokens:["{","float","nh","=","clamp","(","nd",",","iz",",","iA",")",";","float","ni","=","iA","-","nh",";","vec3","nj",",","nk",";","nj","=","iJ","(","ne",")",";","nk","=","iJ","(","nf",")",";","nj",".","z","=","ni","*","nj",".","z","+","nh","*","nk",
".","z",";","ng","=","iU","(","nj",")",";","}"]}]}},{type:"node",name:"MIX_RGB_COLOR",group:{type:"group",parts:[{type:"node_in",name:"nl",qualifier:["float"]},{type:"node_in",name:"nm",qualifier:["vec3"]},{type:"node_in",name:"nn",qualifier:["vec3"]},{type:"node_out",name:"no",qualifier:["vec3"]},{type:"textline",tokens:["{","float","np","=","clamp","(","nl",",","iz",",","iA",")",";","vec3","nq",",","nr",",","ns",";","no","=","nm",";","nr","=","iJ","(","nn",")",";","if","(","nr",".","y","!=","iz",
")","{","nq","=","iJ","(","no",")",";","nq",".","x","=","nr",".","x",";","nq",".","y","=","nr",".","y",";","ns","=","iU","(","nq",")",";","no","=","mix","(","no",",","ns",",","np",")",";","}","}"]}]}},{type:"node",name:"MIX_RGB_SOFT_LIGHT",group:{type:"group",parts:[{type:"node_in",name:"nt",qualifier:["float"]},{type:"node_in",name:"nu",qualifier:["vec3"]},{type:"node_in",name:"nv",qualifier:["vec3"]},{type:"node_out",name:"nw",qualifier:["vec3"]},{type:"textline",tokens:["{","float","nx","=","clamp",
"(","nt",",","iz",",","iA",")",";","float","ny","=","iA","-","nx",";","vec3","nz","=","vec3","(","iA",")",";","vec3","nA","=","nz","-","(","nz","-","nv",")","*","(","nz","-","nu",")",";","nw","=","ny","*","nu","+","nx","*","(","(","nz","-","nu",")","*","nv","*","nu","+","nu","*","nA",")",";","}"]}]}},{type:"node",name:"MIX_RGB_LINEAR_LIGHT",group:{type:"group",parts:[{type:"node_in",name:"nB",qualifier:["float"]},{type:"node_in",name:"nC",qualifier:["vec3"]},{type:"node_in",name:"nD",qualifier:["vec3"]},
{type:"node_out",name:"nE",qualifier:["vec3"]},{type:"textline",tokens:["{","float","nF","=","clamp","(","nB",",","iz",",","iA",")",";","nE","=","nC",";","if","(","nD",".","r",">","0.5",")","nE",".","r","=","nC",".","r","+","nF","*","(","2.0","*","(","nD",".","r","-","0.5",")",")",";","else","nE",".","r","=","nC",".","r","+","nF","*","(","2.0","*","(","nD",".","r",")","-","iA",")",";","if","(","nD",".","g",">","0.5",")","nE",".","g","=","nC",".","g","+","nF","*","(","2.0","*","(","nD",".","g","-",
"0.5",")",")",";","else","nE",".","g","=","nC",".","g","+","nF","*","(","2.0","*","(","nD",".","g",")","-","iA",")",";","if","(","nD",".","b",">","0.5",")","nE",".","b","=","nC",".","b","+","nF","*","(","2.0","*","(","nD",".","b","-","0.5",")",")",";","else","nE",".","b","=","nC",".","b","+","nF","*","(","2.0","*","(","nD",".","b",")","-","iA",")",";","nE","=","clamp","(","nE",",","iz",",","iA",")",";","}"]}]}},{type:"node",name:"OUTPUT",group:{type:"group",parts:[{type:"node_in",name:"nG",qualifier:["vec3"]},
{type:"node_in",name:"nH",qualifier:["float"]},{type:"textline",tokens:["jH","=","nG",";","jM","=","nH",";"]}]}},{type:"node",name:"MATERIAL",group:{type:"group",parts:[{type:"node_param",name:"jk",qualifier:["const","vec3"]},{type:"node_param",name:"jl",qualifier:["const","vec3"]},{type:"node_param",name:"jm",qualifier:["const","float"]},{type:"node_in",name:"nI",qualifier:["vec3"]},{type:"node_in",name:"nJ",qualifier:["float"]},{type:"node_in",name:"nK",qualifier:["vec3"]},{type:"node_in",name:"nL",
qualifier:["vec3"]},{type:"node_out",name:"nM",qualifier:["vec3"]},{type:"node_out",name:"nN",qualifier:["float"]},{type:"node_out",name:"nO",qualifier:["vec3"]},{type:"textline",tokens:["nI","=","clamp","(","nI",",","iz",",","iA",")",";","nJ","=","clamp","(","nJ",",","iz",",","iA",")",";","nK","=","clamp","(","nK",",","iz",",","iA",")",";","vec3","nP","=","nI",";","float","nQ","=","jk","[","0","]",";","vec2","nR","=","vec2","(","jk","[","1","]",",","jk","[","2","]",")",";","vec3","nS","=","jD","*",
"nI",";","vec3","nT","=","jE","*","jy",";","vec3","nU","=","jl","[","1","]","*","nK",";","float","nV","=","jl","[","0","]",";","float","nW","=","jl","[","2","]",";","float","nX","=","dc","(","jF",",","nP",")",";","vec3","nY",";","if","(","jm","==","iA",")","nY","=","normalize","(","nL",")",";","else","nY","=","jw",";","eW","nZ","=","gz","(","nS",",","nT",",","nP",",","nU",",","jB",",","nY",",","jA",",","nW",",","nR",",","nX",",","u_light_positions",",","u_light_directions",",","u_light_color_intensities",
",","u_light_factors1",",","u_light_factors2",",","iz",",","vec4","(","iz",")",")",";","nM","=","(","nQ","==","iA",")","?","nZ",".","a",".","rgb",":","vec3","(","iz",")",";","nN","=","nJ","+","nZ",".","a",".","a","*","nU",".","r",";","nO","=","nY",";","if","(","nV","==","iA",")","{","nM","+=","nZ",".","b",";","jI","=","nZ",".","b",";","}","else","{","jI","=","vec3","(","iz",")",";","}","jJ","=","nY",";","jL","=","nX",";"]}]}},{type:"node",name:"MATERIAL_EXT",group:{type:"group",parts:[{type:"node_param",
name:"jn",qualifier:["const","vec3"]},{type:"node_param",name:"jo",qualifier:["const","vec3"]},{type:"node_param",name:"jp",qualifier:["const","float"]},{type:"node_in",name:"n_",qualifier:["vec3"]},{type:"node_in",name:"oa",qualifier:["float"]},{type:"node_in",name:"ob",qualifier:["vec3"]},{type:"node_in",name:"oc",qualifier:["vec3"]},{type:"node_in",name:"od",qualifier:["float"]},{type:"node_in",name:"oe",qualifier:["float"]},{type:"node_in",name:"of",qualifier:["vec4"]},{type:"node_out",name:"og",
qualifier:["vec3"]},{type:"node_out",name:"oh",qualifier:["float"]},{type:"node_out",name:"oi",qualifier:["vec3"]},{type:"node_out",name:"oj",qualifier:["vec3"]},{type:"node_out",name:"ok",qualifier:["vec3"]},{type:"textline",tokens:["n_","=","clamp","(","n_",",","iz",",","iA",")",";","oa","=","clamp","(","oa",",","iz",",","iA",")",";","ob","=","clamp","(","ob",",","iz",",","iA",")",";","vec3","nP","=","n_",";","float","nQ","=","jn","[","0","]",";","vec2","nR","=","vec2","(","jn","[","1","]",",",
"jn","[","2","]",")",";","vec3","nS","=","od","*","n_",";","vec3","nT","=","jE","*","jy",";","vec3","nU","=","jo","[","1","]","*","ob",";","float","nV","=","jo","[","0","]",";","float","nW","=","jo","[","2","]",";","float","nX","=","dc","(","jF",",","nP",")",";","vec3","nY",";","if","(","jp","==","iA",")","nY","=","normalize","(","oc",")",";","else","nY","=","jw",";","eW","nZ","=","gz","(","nS",",","nT",",","nP",",","nU",",","jB",",","nY",",","jA",",","nW",",","nR",",","nX",",","u_light_positions",
",","u_light_directions",",","u_light_color_intensities",",","u_light_factors1",",","u_light_factors2",",","oe",",","of",")",";","og","=","(","nQ","==","iA",")","?","nZ",".","a",".","rgb",":","vec3","(","iz",")",";","oh","=","oa","+","nZ",".","a",".","a","*","nU",".","r",";","oi","=","nY",";","oj","=","nZ",".","a",".","rgb",";","ok","=","nZ",".","b",";","if","(","nV","==","iA",")","{","og","+=","nZ",".","b",";","jI","=","nZ",".","b",";","}","else","{","jI","=","vec3","(","iz",")",";","}","jJ","=",
"nY",";","jL","=","nX",";"]}]}},{type:"node",name:"RGB",group:{type:"group",parts:[{type:"node_param",name:"jq",qualifier:["vec3"]},{type:"node_out",name:"ol",qualifier:["vec3"]},{type:"textline",tokens:["ol","=","jq",";"]}]}},{type:"node",name:"RGBTOBW",group:{type:"group",parts:[{type:"node_in",name:"om",qualifier:["vec3"]},{type:"node_out",name:"on",qualifier:["float"]},{type:"textline",tokens:["on","=","om",".","r","*","0.35","+","om",".","g","*","0.45","+","om",".","b","*","0.2",";"]}]}},{type:"node",
name:"SEPRGB",group:{type:"group",parts:[{type:"node_in",name:"oo",qualifier:["vec3"]},{type:"node_out",name:"op",qualifier:["float"]},{type:"node_out",name:"oq",qualifier:["float"]},{type:"node_out",name:"or",qualifier:["float"]},{type:"textline",tokens:["op","=","oo",".","r",";","oq","=","oo",".","g",";","or","=","oo",".","b",";"]}]}},{type:"node",name:"SQUEEZE",group:{type:"group",parts:[{type:"node_in",name:"os",qualifier:["float"]},{type:"node_in",name:"ot",qualifier:["float"]},{type:"node_in",
name:"ou",qualifier:["float"]},{type:"node_out",name:"ov",qualifier:["float"]},{type:"textline",tokens:["ov","=","iA","/","(","iA","+","pow","(","2.71828183",",","-","(","(","os","-","ou",")","*","ot",")",")",")",";"]}]}},{type:"node",name:"SRGB_TO_LINEAR",group:{type:"group",parts:[{type:"node_in",name:"ow",qualifier:["vec3"]},{type:"node_out",name:"ox",qualifier:["vec3"]},{type:"textline",tokens:["ox","=","pow","(","ow",",","vec3","(","2.2",")",")",";"]}]}},{type:"node",name:"LINEAR_TO_SRGB",group:{type:"group",
parts:[{type:"node_in",name:"oy",qualifier:["vec3"]},{type:"node_out",name:"oz",qualifier:["vec3"]},{type:"textline",tokens:["oz","=","pow","(","oy",",","vec3","(","iA","/","2.2",")",")",";"]}]}},{type:"node",name:"TEXTURE_COLOR",group:{type:"group",parts:[{type:"node_param",name:"node_TEXTURE_COLOR_var_texture",qualifier:["uniform","sampler2D"]},{type:"node_in",name:"oA",qualifier:["vec3"]},{type:"node_out",name:"oB",qualifier:["vec3"]},{type:"node_out",name:"oC",qualifier:["float"]},{type:"textline",
tokens:["{","vec4","oD","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","iY","(","oA",")",")",";","oB","=","oD",".","xyz",";","eb","(","oB",")",";","oC","=","oD",".","w",";","}"]}]}},{type:"node",name:"TEXTURE_NORMAL",group:{type:"group",parts:[{type:"node_param",name:"node_TEXTURE_NORMAL_var_texture",qualifier:["uniform","sampler2D"]},{type:"node_in",name:"oE",qualifier:["vec3"]},{type:"node_out",name:"oF",qualifier:["vec3"]},{type:"node_out",name:"oG",qualifier:["float"]},{type:"textline",
tokens:["{","vec4","oH","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","iY","(","oE",")",")",";","jK","=","oH",".","xyz","-","0.5",";","oF","=","normalize","(","jG","*","jK",")",";","oG","=","oH",".","w",";","}"]}]}},{type:"node",name:"TEXTURE_ENVIRONMENT",group:{type:"group",parts:[{type:"node_param",name:"node_TEXTURE_ENVIRONMENT_var_texture",qualifier:["uniform","samplerCube"]},{type:"node_in",name:"oI",qualifier:["vec3"]},{type:"node_out",name:"oJ",qualifier:["vec3"]},{type:"node_out",
name:"oK",qualifier:["float"]},{type:"textline",tokens:["{","vec4","oL","=","textureCube","(","node_TEXTURE_ENVIRONMENT_var_texture",",","oI",")",";","oJ","=","oL",".","xyz",";","eb","(","oJ",")",";","oK","=","oL",".","w",";","}"]}]}},{type:"node",name:"TEXTURE_COLOR2",group:{type:"group",parts:[{type:"node_param",name:"node_TEXTURE_COLOR2_var_texture",qualifier:["uniform","sampler2D"]},{type:"node_in",name:"oM",qualifier:["vec3"]},{type:"node_in",name:"oN",qualifier:["vec3"]},{type:"node_out",name:"oO",
qualifier:["vec3"]},{type:"node_out",name:"oP",qualifier:["float"]},{type:"node_out",name:"oQ",qualifier:["vec3"]},{type:"node_out",name:"oR",qualifier:["float"]},{type:"textline",tokens:["{","vec4","oS","=","texture2D","(","node_TEXTURE_COLOR2_var_texture",",","iY","(","oM",")",")",";","oO","=","oS",".","xyz",";","eb","(","oO",")",";","oP","=","oS",".","w",";","oS","=","texture2D","(","node_TEXTURE_COLOR2_var_texture",",","iY","(","oN",")",")",";","oQ","=","oS",".","xyz",";","eb","(","oQ",")",";",
"oR","=","oS",".","w",";","}"]}]}},{type:"node",name:"TEXTURE_NORMAL2",group:{type:"group",parts:[{type:"node_param",name:"node_TEXTURE_NORMAL2_var_texture",qualifier:["uniform","sampler2D"]},{type:"node_in",name:"oT",qualifier:["vec3"]},{type:"node_in",name:"oU",qualifier:["vec3"]},{type:"node_out",name:"oV",qualifier:["vec3"]},{type:"node_out",name:"oW",qualifier:["float"]},{type:"node_out",name:"oX",qualifier:["vec3"]},{type:"node_out",name:"oY",qualifier:["float"]},{type:"textline",tokens:["{",
"vec4","oZ","=","texture2D","(","node_TEXTURE_NORMAL2_var_texture",",","iY","(","oT",")",")",";","jK","=","oZ",".","xyz","-","0.5",";","oV","=","normalize","(","jG","*","jK",")",";","oW","=","oZ",".","w",";","oZ","=","texture2D","(","node_TEXTURE_NORMAL2_var_texture",",","iY","(","oU",")",")",";","jK","=","oZ",".","xyz","-","0.5",";","oX","=","normalize","(","jG","*","jK",")",";","oY","=","oZ",".","w",";","}"]}]}},{type:"node",name:"TEXTURE_COLOR3",group:{type:"group",parts:[{type:"node_param",name:"node_TEXTURE_COLOR3_var_texture",
qualifier:["uniform","sampler2D"]},{type:"node_in",name:"o_",qualifier:["vec3"]},{type:"node_in",name:"pa",qualifier:["vec3"]},{type:"node_in",name:"pb",qualifier:["vec3"]},{type:"node_out",name:"pc",qualifier:["vec3"]},{type:"node_out",name:"pd",qualifier:["float"]},{type:"node_out",name:"pe",qualifier:["vec3"]},{type:"node_out",name:"pf",qualifier:["float"]},{type:"node_out",name:"pg",qualifier:["vec3"]},{type:"node_out",name:"ph",qualifier:["float"]},{type:"textline",tokens:["{","vec4","pi","=",
"texture2D","(","node_TEXTURE_COLOR3_var_texture",",","iY","(","o_",")",")",";","pc","=","pi",".","xyz",";","eb","(","pc",")",";","pd","=","pi",".","w",";","pi","=","texture2D","(","node_TEXTURE_COLOR3_var_texture",",","iY","(","pa",")",")",";","pe","=","pi",".","xyz",";","eb","(","pe",")",";","pf","=","pi",".","w",";","pi","=","texture2D","(","node_TEXTURE_COLOR3_var_texture",",","iY","(","pb",")",")",";","pg","=","pi",".","xyz",";","eb","(","pg",")",";","ph","=","pi",".","w",";","}"]}]}},{type:"node",
name:"TEXTURE_NORMAL3",group:{type:"group",parts:[{type:"node_param",name:"node_TEXTURE_NORMAL3_var_texture",qualifier:["uniform","sampler2D"]},{type:"node_in",name:"pj",qualifier:["vec3"]},{type:"node_in",name:"pk",qualifier:["vec3"]},{type:"node_in",name:"pl",qualifier:["vec3"]},{type:"node_out",name:"pm",qualifier:["vec3"]},{type:"node_out",name:"pn",qualifier:["float"]},{type:"node_out",name:"po",qualifier:["vec3"]},{type:"node_out",name:"pp",qualifier:["float"]},{type:"node_out",name:"pq",qualifier:["vec3"]},
{type:"node_out",name:"pr",qualifier:["float"]},{type:"textline",tokens:["{","vec4","ps","=","texture2D","(","node_TEXTURE_NORMAL3_var_texture",",","iY","(","pj",")",")",";","jK","=","ps",".","xyz","-","0.5",";","pm","=","normalize","(","jG","*","jK",")",";","pn","=","ps",".","w",";","ps","=","texture2D","(","node_TEXTURE_NORMAL3_var_texture",",","iY","(","pk",")",")",";","jK","=","ps",".","xyz","-","0.5",";","po","=","normalize","(","jG","*","jK",")",";","pp","=","ps",".","w",";","ps","=","texture2D",
"(","node_TEXTURE_NORMAL3_var_texture",",","iY","(","pl",")",")",";","jK","=","ps",".","xyz","-","0.5",";","pq","=","normalize","(","jG","*","jK",")",";","pr","=","ps",".","w",";","}"]}]}},{type:"node",name:"VALUE",group:{type:"group",parts:[{type:"node_param",name:"jr",qualifier:["float"]},{type:"node_out",name:"pt",qualifier:["float"]},{type:"textline",tokens:["pt","=","jr",";"]}]}},{type:"node",name:"VECT_MATH_ADD",group:{type:"group",parts:[{type:"node_in",name:"pu",qualifier:["vec3"]},{type:"node_in",
name:"pv",qualifier:["vec3"]},{type:"node_out",name:"pw",qualifier:["vec3"]},{type:"node_out",name:"px",qualifier:["float"]},{type:"textline",tokens:["pw","=","pu","+","pv",";","px","=","(","abs","(","pw","[","0","]",")","+","abs","(","pw","[","1","]",")","+","abs","(","pw","[","2","]",")",")","/","3.0",";"]}]}},{type:"node",name:"VECT_MATH_SUBTRACT",group:{type:"group",parts:[{type:"node_in",name:"py",qualifier:["vec3"]},{type:"node_in",name:"pz",qualifier:["vec3"]},{type:"node_out",name:"pA",qualifier:["vec3"]},
{type:"node_out",name:"pB",qualifier:["float"]},{type:"textline",tokens:["pA","=","py","-","pz",";","pB","=","(","abs","(","pA","[","0","]",")","+","abs","(","pA","[","1","]",")","+","abs","(","pA","[","2","]",")",")","/","3.0",";"]}]}},{type:"node",name:"VECT_MATH_AVERAGE",group:{type:"group",parts:[{type:"node_in",name:"pC",qualifier:["vec3"]},{type:"node_in",name:"pD",qualifier:["vec3"]},{type:"node_out",name:"pE",qualifier:["vec3"]},{type:"node_out",name:"pF",qualifier:["float"]},{type:"textline",
tokens:["pE","=","pC","+","pD",";","pF","=","length","(","pE",")",";","pE","=","normalize","(","pE",")",";"]}]}},{type:"node",name:"VECT_MATH_DOT_PRODUCT",group:{type:"group",parts:[{type:"node_in",name:"pG",qualifier:["vec3"]},{type:"node_in",name:"pH",qualifier:["vec3"]},{type:"node_out",name:"pI",qualifier:["vec3"]},{type:"node_out",name:"pJ",qualifier:["float"]},{type:"textline",tokens:["pI","=","vec3","(","iz",")",";","pJ","=","dot","(","pG",",","pH",")",";"]}]}},{type:"node",name:"VECT_MATH_CROSS_PRODUCT",
group:{type:"group",parts:[{type:"node_in",name:"pK",qualifier:["vec3"]},{type:"node_in",name:"pL",qualifier:["vec3"]},{type:"node_out",name:"pM",qualifier:["vec3"]},{type:"node_out",name:"pN",qualifier:["float"]},{type:"textline",tokens:["pM","=","cross","(","pK",",","pL",")",";","pN","=","length","(","pM",")",";"]}]}},{type:"node",name:"VECT_MATH_NORMALIZE",group:{type:"group",parts:[{type:"node_in",name:"pO",qualifier:["vec3"]},{type:"node_in",name:"pP",qualifier:["vec3"]},{type:"node_out",name:"pQ",
qualifier:["vec3"]},{type:"node_out",name:"pR",qualifier:["float"]},{type:"textline",tokens:["pQ","=","normalize","(","pO",")",";","pR","=","length","(","pO",")",";","pP",";"]}]}},{type:"node",name:"REFLECT",group:{type:"group",parts:[{type:"node_in",name:"pS",qualifier:["vec3"]},{type:"node_in",name:"pT",qualifier:["vec3"]},{type:"node_out",name:"pU",qualifier:["vec3"]},{type:"textline",tokens:["pU","=","reflect","(","-","pS",",","pT",")",";"]}]}},{type:"node",name:"PARALLAX",group:{type:"group",
parts:[{type:"node_param",name:"node_PARALLAX_var_texture",qualifier:["uniform","sampler2D"]},{type:"node_in",name:"pV",qualifier:["vec3"]},{type:"node_in",name:"pW",qualifier:["float"]},{type:"node_in",name:"pX",qualifier:["const","float"]},{type:"node_out",name:"pY",qualifier:["vec3"]},{type:"textline",tokens:["float","pZ","=","length","(","jC",")",";","if","(","pZ","<","10.0",")","{","float","p_","=","clamp","(","5.0","-","0.5","*","pZ",",","iz",",","iA",")",";","float","qa","=","pW","*","p_",
";","vec3","qb","=","normalize","(","jA","*","jG",")",";","float","qc","=","iA","/","pX",";","vec2","qd","=","qb",".","xy","*","qa","/","(","pX","*","qb",".","z",")",";","float","qe","=","iA",";","vec2","qf","=","iY","(","pV",")",";","float","qg","=","texture2D","(","node_PARALLAX_var_texture",",","qf",")",".","a",";","for","(","float","qh","=","1.0",";","qh","<=","pX",";","qh","++",")","{","if","(","qg","<","qe",")","{","qe","-=","qc",";","qf","-=","qd",";","qg","=","texture2D","(","node_PARALLAX_var_texture",
",","qf",")",".","a",";","}","}","vec2","qi","=","qf","+","qd",";","float","qj","=","texture2D","(","node_PARALLAX_var_texture",",","qi",")",".","a","-","(","qe","+","qc",")",";","float","qk","=","qg","-","qe",";","float","ql","=","qk","/","(","qk","-","qj",")",";","qf","=","ql","*","qi","+","(","iA","-","ql",")","*","qf",";","pY","=","iW","(","qf",")",";","}","else","pY","=","pV",";"]}]}},{type:"node",name:"CLAMP",group:{type:"group",parts:[{type:"node_in",name:"qm",qualifier:["vec3"]},{type:"node_out",
name:"qn",qualifier:["vec3"]},{type:"textline",tokens:["qn","=","clamp","(","qm",",","iz",",","iA",")",";"]}]}},{type:"node",name:"TRANSLUCENCY",group:{type:"group",parts:[{type:"node_in",name:"qo",qualifier:["float"]},{type:"node_in",name:"qp",qualifier:["float"]},{type:"node_in",name:"qq",qualifier:["float"]},{type:"node_in",name:"qr",qualifier:["float"]},{type:"node_in",name:"qs",qualifier:["float"]},{type:"node_out",name:"qt",qualifier:["float"]},{type:"node_out",name:"qu",qualifier:["vec4"]},
{type:"textline",tokens:["qt","=","qo",";","qu","=","vec4","(","qp",",","qq",",","qr",",","qs",")",";"]}]}},{type:"node",name:"TIME",group:{type:"group",parts:[{type:"node_out",name:"qv",qualifier:["float"]},{type:"textline",tokens:["qv","=","u_time",";"]}]}},{type:"nodes_global"},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["SHADED"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",
parts:[{type:"textline",tokens:["float","js","=","h_",".","y","-","WATER_LEVEL",";"]}]}}]},{type:"textline",tokens:["vec3","jt","=","ia",";"]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","gl_FrontFacing",")","jt","=","jt",";","else","jt","=","-","jt",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ju","=","cross","(","jt",
",","ib",".","xyz",")","*","ib",".","w",";","mat3","jv","=","mat3","(","ib",".","xyz",",","ju",",","jt",")",";"]}]}}]},{type:"textline",tokens:["vec3","jw","=","normalize","(","jt",")",";","float","jx","=","0.5","*","jw",".","y","+","0.5",";","vec3","jy","=","u_environment_energy","*","mix","(","u_horizon_color",",","u_zenith_color",",","jx",")",";","vec3","jz","=","u_camera_eye_frag","-","h_",";","vec3","jA","=","normalize","(","jz",")",";","vec3","jB","=","h_",";","vec4","jC","=","cu",";","float",
"jD","=","u_emit",";","float","jE","=","u_ambient",";","float","jF","=","u_shadow_visibility_falloff",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["mat3","jG","=","jv",";"]}]}}]},{type:"textline",tokens:["vec3","jH",";","vec3","jI",";","vec3","jJ",";","vec3","jK",";","float","jL",";","float","jM",";"]},{type:"nodes_main"},{type:"textline",tokens:["vec3","qw","=","jH",";","float","qx","=","jM",";"]},{type:"condition",parts:[{type:"if",
expression:["REFLECTIVE","||","TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["iy","(","qw",",","jA",",","jJ",",","u_fresnel_params","[","2","]",",","u_fresnel_params","[","3","]",",","jK",".","st",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["iy","(","qw",",","jA",",","jJ",",","u_fresnel_params","[","2","]",",","u_fresnel_params","[","3","]",",","vec2",
"(","iz",")",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","||","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","qy","=","u_sun_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WETTABLE"],group:{type:"group",parts:[{type:"textline",tokens:["qw","=","max","(","qw","-","sqrt","(","0.01","*","-","min","(","js",",","iz",")",
")",",","0.5","*","qw",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["hY","(","qw",",","js",",","u_time",",","jL",",","jt",",","u_sun_direction",",","qy",",","u_sun_quaternion",",","h_",",","length","(","cu",")",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","qz","=","ev","(","u_cube_fog",",","jA",")",";","vec4","qA","=","vec4","(","qz",",","u_fog_color_density",".","a",")",";","eb","(","qA",".","rgb",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","qA","=","u_fog_color_density",";","qA",".","rgb","*=","qy",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["eM","(","qw",",","length","(","cu",")",",","jA",".","y",",","u_cam_water_depth",
",","u_underwater_fog_color_density",",","qA",",","js",",","length","(","qy",")","+","u_environment_energy",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["eo","(","qw",",","length","(","cu",")",",","qA",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SSAO_ONLY","&&","SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","qB","=","texture2DProj","(","u_shadow_mask",",","ct",")",".","rg",";","float","qC","=",
"qB",".","g",";","qw","=","vec3","(","qC",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","jB","=","h_",";","vec4","jC","=","cu",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_NO"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","jt","=","ia",";"]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","gl_FrontFacing",")","jt","=","jt",";",
"else","jt","=","-","jt",";"]}]}}]},{type:"textline",tokens:["vec3","jw","=","normalize","(","jt",")",";"]}]}}]},{type:"textline",tokens:["vec3","jH",";","float","jM",";"]},{type:"nodes_main"},{type:"textline",tokens:["vec3","qw","=","jH",";","float","qx","=","jM",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["ALPHA","&&","ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","qx","<","0.5",")","discard",";","qx","=","iA",";"]}]}}]},{type:"textline",tokens:["ed","(",
"qw",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","&&","!","ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["eg","(","qw",",","qx",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","qw",",","qx",")",";","}"]}]},exports["nodes.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"include",file:"std_enums.glsl"},{type:"include",
file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["SHADED","||","USE_NODE_GEOMETRY_NO"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],
group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",
";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",
expression:["WIND_BEND","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]},{type:"condition",parts:[{type:"if",expression:["SHADED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal_next",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],
group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent_next",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";"]},
{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4",
"u_transb","[","MAX_BONES","]",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","PRECISION","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_MASK","&&","SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","mat4","u_v_light_matrix",";","uniform","mat4","u_b_light_matrix",";","uniform","mat4","u_p_light_matrix0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix2",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix3",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec3","h_",";","varying","vec4","cu",";"]},{type:"condition",parts:[{type:"if",expression:["SHADED","||","USE_NODE_GEOMETRY_NO"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ia",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec4","ib",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_MASK","&&","SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cp",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec4","cr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","cs",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE","||","SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ct",";"]}]}}]},{type:"include",file:"shadow.glslv"},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"node",
name:"GEOMETRY_UV",group:{type:"group",parts:[{type:"node_param",name:"node_GEOMETRY_UV_var_a_uv",qualifier:["attribute","vec2"]},{type:"node_param",name:"iZ",qualifier:["varying","vec2"]},{type:"textline",tokens:["iZ","=","node_GEOMETRY_UV_var_a_uv",";"]}]}},{type:"node",name:"GEOMETRY_VC",group:{type:"group",parts:[{type:"node_param",name:"node_GEOMETRY_VC_var_a_vertex_color",qualifier:["attribute","vec3"]},{type:"node_param",name:"jd",qualifier:["varying","vec3"]},{type:"textline",tokens:["jd",
"=","node_GEOMETRY_VC_var_a_vertex_color",";"]}]}},{type:"node",name:"GEOMETRY_VC1",group:{type:"group",parts:[{type:"node_param",name:"node_GEOMETRY_VC1_var_a_vertex_color",qualifier:["attribute","float"]},{type:"node_param",name:"je",qualifier:["varying","float"]},{type:"textline",tokens:["je","=","node_GEOMETRY_VC1_var_a_vertex_color",";"]}]}},{type:"node",name:"GEOMETRY_VC2",group:{type:"group",parts:[{type:"node_param",name:"node_GEOMETRY_VC2_var_a_vertex_color",qualifier:["attribute","vec2"]},
{type:"node_param",name:"jf",qualifier:["varying","vec2"]},{type:"textline",tokens:["jf","=","node_GEOMETRY_VC2_var_a_vertex_color",";"]}]}},{type:"node",name:"GEOMETRY_VC3",group:{type:"group",parts:[{type:"node_param",name:"node_GEOMETRY_VC3_var_a_vertex_color",qualifier:["attribute","vec3"]},{type:"node_param",name:"jg",qualifier:["varying","vec3"]},{type:"textline",tokens:["jg","=","node_GEOMETRY_VC3_var_a_vertex_color",";"]}]}},{type:"nodes_global"},{type:"textline",tokens:["void","main","(",
")","{","vec3","jh","=","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["SHADED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ji","=","a_normal",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","jj","=","vec3","(","a_tangent",")",";","vec3","jk","=","a_tangent","[","3","]","*","cross","(","ji",",","jj",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3",
"jj","=","vec3","(","0.0",")",";","vec3","jk","=","vec3","(","0.0",")",";"]}]}}]}]}},{type:"elif",expression:["USE_NODE_GEOMETRY_NO"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ji","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","ji","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["jh","=","mix","(","jh",",","a_position_next",",","u_va_frame_factor",
")",";"]},{type:"condition",parts:[{type:"if",expression:["SHADED"],group:{type:"group",parts:[{type:"textline",tokens:["ji","=","mix","(","ji",",","a_normal_next",",","u_va_frame_factor",")",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","jl","=","vec3","(","a_tangent",")",";","vec3","jm","=","a_tangent_next","[","3","]","*","cross","(","a_normal_next",",","jl",")",";","jj","=","mix","(","jj",",","jl",",","u_va_frame_factor",
")",";","jk","=","mix","(","jk",",","jm",",","u_va_frame_factor",")",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["bn","(","jh",",","jj",",","jk",",","ji",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","jn","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3",
"jn","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","jo","=","(","u_model_matrix","*","vec4","(","jn",",","1.0",")",")",".","xyz",";","mat4","jp","=","ab","(","u_camera_eye",",","jo",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","&&","HAIR_BILLBOARD_JITTERED"],
group:{type:"group",parts:[{type:"textline",tokens:["vec3","jq","=","(","u_model_matrix","*","vec4","(","jn",",","1.0",")",")",".","xyz",";","jp","=","jp","*","R","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","jq",")",";"]}]}}]},{type:"textline",tokens:["b","jr","=","ai","(","jh","-","jn",",","jn",",","jj",",","jk",",","ji",",","jp",")",";","jr",".","b","=","jo",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["b","jr","=","ai","(","jh",",","jn",",",
"jj",",","jk",",","ji",",","u_model_matrix",")",";"]}]}}]},{type:"textline",tokens:["float","js","=","(","dot","(","cross","(","jr",".","e",",","jr",".","c",")",",","jr",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","ib","=","vec4","(","jr",".","c",",","js",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","jo","=","(","u_model_matrix","*","vec4","(","jn",",","1.0",
")",")",".","xyz",";","mat4","jp","=","ab","(","u_camera_eye",",","jo",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","jq","=","(","u_model_matrix","*","vec4","(","jn",",","1.0",")",")",".","xyz",";","jp","=","jp","*","R","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","jq",")",";"]}]}}]},{type:"textline",tokens:["b","jr","=","ai","(","jh","-",
"jn",",","jn",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","ji",",","jp",")",";","jr",".","b","=","jo",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["b","jr","=","ai","(","jh",",","jn",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","ji",",","u_model_matrix",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["ce","(","jr",".","a",",","jr",".","b",",","ji",")",";"]}]}}]},{type:"textline",
tokens:["h_","=","jr",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["SHADED","||","USE_NODE_GEOMETRY_NO"],group:{type:"group",parts:[{type:"textline",tokens:["ia","=","jr",".","e",";"]}]}}]},{type:"textline",tokens:["cu","=","u_view_matrix","*","vec4","(","jr",".","a",",","1.0",")",";","vec4","jt","=","u_proj_matrix","*","cu",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["jt",".","xy","+=","u_subpixel_jitter",
"*","jt",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["dV","(","jt",")",";"]}]}},{type:"elif",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["dV","(","jr",".","a",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["float","ju","=","jt",".","x",";","float","jv",
"=","jt",".","y",";","float","jw","=","jt",".","w",";","ct",".","x","=","(","ju","+","jw",")","/","2.0",";","ct",".","y","=","(","jv","+","jw",")","/","2.0",";","ct",".","z","=","jw",";"]}]}}]},{type:"nodes_main"},{type:"textline",tokens:["gl_Position","=","jt",";","}"]}]},exports["particles_color.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"fog.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",
";","uniform","float","u_p_alpha_start",";","uniform","float","u_p_alpha_end",";","uniform","vec4","u_fog_color_density",";","varying","float","jh",";","varying","vec3","ic",";","varying","vec3","cu",";","void","main","(",")","{","float","ji","=","2.0","*","sqrt","(","(","gl_PointCoord",".","x","-","0.5",")","*","(","gl_PointCoord",".","x","-","0.5",")","+","(","gl_PointCoord",".","y","-","0.5",")","*","(","gl_PointCoord",".","y","-","0.5",")",")",";","float","jj","=","smoothstep","(","u_p_alpha_start",
",","u_p_alpha_end",",","ji",")",";","float","jk","=","u_diffuse_color",".","a","*","jh","*","(","1.0","-","clamp","(","jj",",","0.0",",","1.0",")",")",";","vec3","jl","=","ic","*","u_diffuse_color",".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["eo","(","jl",",","length","(","cu",")",",","u_fog_color_density",")",";"]}]}}]},{type:"textline",tokens:["ed","(","jl",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA",
"&&","!","ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["eg","(","jl",",","jk",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","jl",",","jk",")",";","}"]}]},exports["particles_color.glslv"]={type:"group",parts:[{type:"include",file:"particles.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_normal",";","attribute","float","a_p_delay",";","attribute","float","a_p_lifetime",";","attribute","vec4","a_p_vels",";","uniform",
"vec2","u_p_size_ramp","[","RAMPSIZE","]",";","uniform","vec4","u_p_color_ramp","[","RAMPSIZE","]",";","uniform","float","u_p_time",";","uniform","float","u_p_starttime",";","uniform","float","u_p_endtime",";","uniform","int","u_p_cyclic",";","uniform","float","u_p_fade_in",";","uniform","float","u_p_fade_out",";","uniform","float","u_p_nfactor",";","uniform","float","u_p_gravity",";","uniform","float","u_p_mass",";","uniform","vec3","u_p_wind",";","uniform","float","u_p_max_lifetime",";","uniform",
"mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","uniform","float","u_height",";","uniform","float","u_p_size",";","varying","float","jh",";","varying","vec3","ic",";","varying","vec3","cu",";","struct","jP","{","float","iz",";","vec3","iA",";","float","iB",";","vec3","iC",";","float","iD",";","}",";","jP","jW","(",")","{","float","jQ","=","u_p_time","-","u_p_starttime",";","jP","jR",";","if","(","jQ","<","0.0",")","{","jR",".","iz","=","0.0001",";","jR",".","iA","=","vec3","(","99999.0",
",","0.0",",","0.0",")",";","}","if","(","!","(","jQ","<","0.0",")",")","{","float","jS",";","if","(","u_p_cyclic","==","1",")","{","float","jT","=","u_p_endtime","-","u_p_starttime",";","jS","=","mod","(","jQ",",","jT",")","-","a_p_delay",";","if","(","jS","<","0.0",")","jS","+=","jT",";","}","if","(","u_p_cyclic","!=","1",")","{","jS","=","jQ","-","a_p_delay",";","}","if","(","jS","<","0.0","||","jS",">=","a_p_lifetime",")","{","jR",".","iz","=","0.0001",";","jR",".","iA","=","vec3","(","99999.0",
",","0.0",",","0.0",")",";","}","if","(","!","(","jS","<","0.0","||","jS",">=","a_p_lifetime",")",")","{","vec3","jU","=","a_position",";","vec3","jV","=","a_normal",";","jU","+=","u_p_nfactor","*","jS","*","jV",";","jU","+=","a_p_vels",".","xyz","*","jS",";","jU",".","y","-=","u_p_gravity","*","jS","*","jS","/","2.0",";","jU","+=","(","u_p_wind","/","u_p_mass",")","*","jS","*","jS","/","2.0",";","jR",".","iA","=","jU",";","jR",".","iD","=","a_p_vels",".","w","*","jS",";","jR",".","iz","=","jt","(",
"jS",",","u_p_max_lifetime",",","u_p_size_ramp",")",";","jR",".","iB","=","jO","(","jS",",","a_p_lifetime",",","u_p_fade_in",",","u_p_fade_out",")",";","jR",".","iC","=","jF","(","jS",",","u_p_max_lifetime",",","u_p_color_ramp",")",";","}","}","return","jR",";","}","void","main","(",")","{","jP","jX",";","jX","=","jW","(",")",";","vec4","jY","=","u_view_matrix","*","vec4","(","jX",".","iA",",","1.0",")",";","gl_Position","=","u_proj_matrix","*","jY",";","jh","=","jX",".","iB",";","ic","=","jX",".",
"iC",";","cu","=","jY",".","xyz",";","float","jZ","=","u_height","*","u_proj_matrix","[","1","]","[","1","]","*","u_p_size","/","gl_Position",".","z",";","gl_PointSize","=","jX",".","iz","*","jZ",";","}"]}]},exports["particles_texture.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_sampler",";","varying","float","jh",";","varying","vec3","ic",";","varying","vec2","a",";","void","main",
"(",")","{","vec4","iz","=","texture2D","(","u_sampler",",","a",")",";","vec3","iA","=","iz",".","rgb",";","eb","(","iA",")",";","iA","*=","ic",";","float","iB","=","iz",".","a","*","jh",";","ed","(","iA",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","&&","!","ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["eg","(","iA",",","iB",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","iA",",","iB",")",";","}"]}]},exports["particles_texture.glslv"]=
{type:"group",parts:[{type:"var",name:"BILLBOARD_ALIGN",tokens:["0"]},{type:"include",file:"particles.glslv"},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"define",name:"BILLBOARD_ALIGN_VIEW",tokens:["1"]},{type:"define",name:"BILLBOARD_ALIGN_XY",tokens:["2"]},{type:"define",name:"BILLBOARD_ALIGN_YZ",tokens:["3"]},{type:"define",name:"BILLBOARD_ALIGN_ZX",tokens:["4"]},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_normal",";",
"attribute","float","a_p_delay",";","attribute","float","a_p_lifetime",";","attribute","vec4","a_p_vels",";","attribute","vec2","a_p_bb_vertex",";","uniform","vec2","u_p_size_ramp","[","RAMPSIZE","]",";","uniform","vec4","u_p_color_ramp","[","RAMPSIZE","]",";","uniform","float","u_p_time",";","uniform","float","u_p_starttime",";","uniform","float","u_p_endtime",";","uniform","int","u_p_cyclic",";","uniform","float","u_p_fade_in",";","uniform","float","u_p_fade_out",";","uniform","float","u_p_nfactor",
";","uniform","float","u_p_gravity",";","uniform","float","u_p_mass",";","uniform","vec3","u_p_wind",";","uniform","float","u_p_max_lifetime",";","uniform","mat4","u_proj_matrix",";","uniform","mat4","u_view_matrix",";","uniform","float","u_p_size",";","varying","float","jh",";","varying","vec3","ic",";","varying","vec2","a",";","varying","vec4","cu",";","struct","jP","{","float","iz",";","vec3","iA",";","float","iB",";","vec3","iC",";","float","iD",";","}",";","jP","jW","(",")","{","float","jQ",
"=","u_p_time","-","u_p_starttime",";","jP","jR",";","if","(","jQ","<","0.0",")","{","jR",".","iz","=","0.0001",";","jR",".","iA","=","vec3","(","99999.0",",","0.0",",","0.0",")",";","}","if","(","!","(","jQ","<","0.0",")",")","{","float","jS",";","if","(","u_p_cyclic","==","1",")","{","float","jT","=","u_p_endtime","-","u_p_starttime",";","jS","=","mod","(","jQ",",","jT",")","-","a_p_delay",";","if","(","jS","<","0.0",")","jS","+=","jT",";","}","if","(","u_p_cyclic","!=","1",")","{","jS","=","jQ",
"-","a_p_delay",";","}","if","(","jS","<","0.0","||","jS",">=","a_p_lifetime",")","{","jR",".","iz","=","0.0001",";","jR",".","iA","=","vec3","(","99999.0",",","0.0",",","0.0",")",";","}","if","(","!","(","jS","<","0.0","||","jS",">=","a_p_lifetime",")",")","{","vec3","jU","=","a_position",";","vec3","jV","=","a_normal",";","jU","+=","u_p_nfactor","*","jS","*","jV",";","jU","+=","a_p_vels",".","xyz","*","jS",";","jU",".","y","-=","u_p_gravity","*","jS","*","jS","/","2.0",";","jU","+=","(","u_p_wind",
"/","u_p_mass",")","*","jS","*","jS","/","2.0",";","jR",".","iA","=","jU",";","jR",".","iD","=","a_p_vels",".","w","*","jS",";","jR",".","iz","=","jt","(","jS",",","u_p_max_lifetime",",","u_p_size_ramp",")",";","jR",".","iB","=","jO","(","jS",",","a_p_lifetime",",","u_p_fade_in",",","u_p_fade_out",")",";","jR",".","iC","=","jF","(","jS",",","u_p_max_lifetime",",","u_p_color_ramp",")",";","}","}","return","jR",";","}","float","jZ","(","vec2","jX",",","vec2","jY",")","{","return","(","atan","(","jY",
".","y",",","jY",".","x",")","-","atan","(","jX",".","y",",","jX",".","x",")",")",";","}","void","main","(",")","{","jP","j_",";","j_","=","jW","(",")",";","float","ka",";","mat4","kb",";","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_VIEW",")","{","ka","=","j_",".","iD",";","kb","=","A","(","j_",".","iA",",","u_view_matrix",")",";","}","else","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_XY",")","{","ka","=","j_",".","iD",";","kb","=","l","(",")",";","kb","[","3","]","=","vec4","(","j_",".",
"iA",",","1.0",")",";","}","else","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_YZ",")","{","ka","=","j_",".","iD",";","kb","=","p","(","radians","(","90.0",")",")",";","kb","[","3","]","=","vec4","(","j_",".","iA",",","1.0",")",";","}","else","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_ZX",")","{","ka","=","jZ","(","vec2","(","0.0",",","-","1.0",")",",","vec2","(","a_normal",".","x",",","a_normal",".","z",")",")","+","j_",".","iD",";","kb","=","n","(","radians","(","-","90.0",")",")",";",
"kb","[","3","]","=","vec4","(","j_",".","iA",",","1.0",")",";","}","vec4","kc","=","vec4","(","a_p_bb_vertex","*","2.0","*","j_",".","iz","*","u_p_size",",","0.0",",","1.0",")",";","vec4","kd","=","kb","*","r","(","ka",")","*","kc",";","cu","=","u_view_matrix","*","kd",";","vec4","ke","=","u_proj_matrix","*","cu",";","gl_Position","=","ke",";","jh","=","j_",".","iB",";","ic","=","j_",".","iC",";","a","=","a_p_bb_vertex","+","0.5",";","}"]}]},exports["procedural_skydome.glslf"]={type:"group",parts:[{type:"include",
file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","vec3","u_sky_color",";","uniform","vec3","u_sun_direction",";","uniform","float","u_rayleigh_brightness",";","uniform","float","u_mie_brightness",";","uniform","float","u_spot_brightness",";","uniform","float","u_scatter_strength",";","uniform","float","u_rayleigh_strength",";","uniform","float","u_mie_strength",";","uniform","float","u_rayleigh_collection_power",";","uniform","float","u_mie_collection_power",
";","uniform","float","u_mie_distribution",";","varying","vec3","jP",";","const","float","jQ","=","0.99",";","const","float","jR","=","1.8",";","const","int","jS","=","8",";","float","kb","(","vec3","jT",",","vec3","jU",")","{","float","jV","=","dot","(","jU",",","jU",")",";","float","jW","=","2.0","*","dot","(","jU",",","jT",")",";","float","jX","=","dot","(","jT",",","jT",")","-","1.0",";","float","jY","=","jW","*","jW","-","4.0","*","jV","*","jX",";","float","jZ","=","sqrt","(","jY",")",";","float",
"j_","=","(","-","jW","-","jZ",")","/","2.0",";","float","ka","=","jX","/","j_",";","return","ka",";","}","float","ki","(","float","kc",",","float","kd",")","{","float","ke","=","3.0","*","(","1.0","-","kd","*","kd",")",";","float","kf","=","2.0","*","(","2.0","+","kd","*","kd",")",";","float","kg","=","1.0","+","kc","*","kc",";","float","kh","=","pow","(","1.0","+","kd","*","kd","-","2.0","*","kd","*","kc",",","1.5",")",";","return","(","ke","/","kf",")","*","(","kg","/","kh",")",";","}","float",
"kq","(","vec3","kj",",","vec3","kk",",","float","kl",")","{","float","km","=","dot","(","kk",",","-","kj",")",";","if","(","km","<","0.0",")","{","return","1.0",";","}","vec3","kn","=","kj","+","km","*","kk",";","if","(","length","(","kn",")","<","kl",")","{","return","0.0",";","}","else","if","(","length","(","kn",")",">=","kl",")","{","vec3","ko","=","normalize","(","kn",")","*","kl","-","kj",";","float","kp","=","acos","(","dot","(","normalize","(","ko",")",",","kk",")",")",";","return","smoothstep",
"(","0.0",",","1.0",",","pow","(","kp","*","2.0",",","3.0",")",")",";","}","else","return","1.0",";","}","vec3","ku","(","float","kr",",","vec3","ks",",","float","kt",")","{","return","ks","-","ks","*","pow","(","u_sky_color",",","vec3","(","kt","/","kr",")",")",";","}","void","main","(",")","{","vec3","kv","=","normalize","(","jP",")",";","vec3","kw","=","u_sun_direction",";","float","kx","=","dot","(","kv",",","kw",")",";","float","ky","=","ki","(","kx",",","-","0.01",")","*","u_rayleigh_brightness",
"*","kw",".","y",";","float","kz","=","ki","(","kx","-","0.5",",","u_mie_distribution",")","*","u_mie_brightness","*","(","1.0","-","kw",".","y",")",";","float","kA","=","smoothstep","(","0.0",",","100.0",",","ki","(","kx",",","0.9995",")",")","*","u_spot_brightness",";","vec3","kB","=","vec3","(","0.0",",","jQ",",","0.0",")",";","float","kC","=","kb","(","kB",",","kv",")",";","float","kD","=","kC","/","float","(","jS",")",";","float","kE","=","kq","(","kB",",","kv",",","jQ","-","0.3",")",";","vec3",
"kF","=","vec3","(","0.0",",","0.0",",","0.0",")",";","vec3","kG","=","vec3","(","0.0",",","0.0",",","0.0",")",";","for","(","int","kH","=","0",";","kH","<","jS",";","kH","++",")","{","float","kI","=","kD","*","float","(","kH",")",";","vec3","kJ","=","kB","+","kv","*","kI",";","float","kK","=","kq","(","kJ",",","kw",",","jQ","-","0.2",")",";","float","kL","=","kb","(","kJ",",","kw",")",";","vec3","kM","=","ku","(","kL",",","vec3","(","jR",")",",","u_scatter_strength",")","*","kK",";","kF","+=","ku",
"(","sqrt","(","kI",")",",","u_sky_color","*","kM",",","u_rayleigh_strength",")",";","kG","+=","ku","(","kI",",","kM",",","u_mie_strength",")",";","}","kF","=","kF","*","kE","*","pow","(","kC",",","u_rayleigh_collection_power",")","/","float","(","jS",")",";","kG","=","(","kG","*","kE","*","pow","(","kC",",","u_mie_collection_power",")",")","/","float","(","jS",")",";","vec3","kN","=","vec3","(","kA","*","kG","+","kz","*","kG","+","ky","*","kF",")",";","ed","(","kN",")",";","gl_FragColor","=","vec4",
"(","kN",",","1.0",")",";","}"]}]},exports["procedural_skydome.glslv"]={type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position",";","uniform","mat4","u_cube_view_matrix",";","varying","vec3","jP",";","void","main","(",")","{","vec4","iz","=","vec4","(","a_position",".","xy",",","0.999999",",","1.0",")",";","vec4","iA","=","u_cube_view_matrix","*","iz",";","jP","=","iA",".","xyz",";","gl_Position","=","iz",";","}"]}]},exports["shadeless.glslf"]={type:"group",parts:[{type:"include",
file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"fog.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","float","u_time",";","uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_colormap0",";","uniform","float","u_diffuse_color_factor",";","uniform","vec2","u_colormap0_uv_velocity",";"]},{type:"condition",
parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_colormap1",";","uniform","sampler2D","u_stencil0",";","varying","vec2","a",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","a",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ic",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";"]}]}}]},{type:"textline",tokens:["varying","vec4","cu",";","void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","iz","=","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iA","=","ic",";","eb","(","iA",")",";","vec4","iB","=","vec4","(","iA",",",
"1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","iB","=","u_diffuse_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","iC","=","texture2D","(","u_colormap0",",","iz",")",";","eb","(","iC",".","rgb",")",";","vec4","iD","=","texture2D","(","u_colormap1",",","iz",
")",";","eb","(","iD",".","rgb",")",";","vec4","iE","=","texture2D","(","u_stencil0",",","iz",")",";","vec4","iF","=","mix","(","iC",",","iD",",","iE",".","r",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","iF","=","texture2D","(","u_colormap0",",","iz","+","u_time","*","u_colormap0_uv_velocity",")",";","eb","(","iF",".","rgb",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_BLEND_TYPE","==","TEXTURE_BLEND_TYPE_MIX"],group:{type:"group",
parts:[{type:"textline",tokens:["iB",".","rgb","=","mix","(","iB",".","rgb",",","iF",".","rgb",",","u_diffuse_color_factor",")",";","iB",".","a","=","iF",".","a",";"]}]}},{type:"elif",expression:["TEXTURE_BLEND_TYPE","==","TEXTURE_BLEND_TYPE_MULTIPLY"],group:{type:"group",parts:[{type:"textline",tokens:["iB",".","rgb","*=","mix","(","vec3","(","1.0",")",",","iF",".","rgb",",","u_diffuse_color_factor",")",";","iB",".","a","=","iF",".","a",";"]}]}}]}]}}]},{type:"textline",tokens:["vec3","iG","=","iB",
".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["float","iH","=","iB",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","iH","<","0.5",")","discard",";","iH","=","1.0",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","iH","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG"],
group:{type:"group",parts:[{type:"textline",tokens:["eo","(","iG",",","length","(","cu",")",",","u_fog_color_density",")",";"]}]}}]},{type:"textline",tokens:["ed","(","iG",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","&&","!","ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["eg","(","iG",",","iH",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","iG",",","iH",")",";","}"]}]},exports["shadeless.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",
tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","attribute","vec3","a_normal",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER",
"float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3",
"au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec3","a_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";"]},{type:"condition",parts:[{type:"if",
expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float",
"u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"textline",tokens:["varying","vec4","cu",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","a",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ic",";"]}]}}]},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"textline",tokens:["void","main","(",")","{","vec3","iz","=","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["iz","=","mix","(","iz",",","a_position_next",",","u_va_frame_factor",")",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iA","=","vec3","(","0.0",")",";","vec3","iB","=","vec3","(","0.0",")",";","vec3","iC","=","vec3","(","0.0",")",";","bn","(","iz",",","iA",",","iB",",","iC",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","||","DYNAMIC_GRASS","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iD","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["vec3","iD","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iE","=","(","u_model_matrix","*","vec4","(","iD",",","1.0",")",")",".","xyz",";","mat4","iF","=","ab","(","u_camera_eye",",","iE",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","iG","=","(","u_model_matrix","*","vec4","(","iD",",","1.0",")",")",".","xyz",";","iF","=","iF","*","R","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","iG",")",";"]}]}}]},{type:"textline",tokens:["b","iH","=","ai","(","iz","-","iD",",","iD",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","iF",")",";","iH",".","b","=","iE",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["b","iH","=","ai","(","iz",",","iD",
",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL","&&","DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iI","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","iI","=","vec3","(","0.0",")",";"]}]}}]},{type:"textline",
tokens:["ce","(","iH",".","a",",","iH",".","b",",","iI",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["a","=","al","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["ic","=","a_color",";"]}]}}]},{type:"textline",tokens:["cu","=","u_view_matrix","*","vec4","(","iH",".","a",",","1.0",")",";","gl_Position",
"=","u_proj_matrix","*","cu",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["gl_Position",".","xy","+=","u_subpixel_jitter","*","gl_Position",".","w",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["special_lens_flares.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_sampler",";","varying","vec2","a",";","void",
"main","(",")","{","vec4","iz","=","texture2D","(","u_sampler",",","a",")",";","ed","(","iz",".","rgb",")",";","eg","(","iz",".","rgb",",","iz",".","a",")",";","gl_FragColor","=","iz",";","}"]}]},exports["special_lens_flares.glslv"]={type:"group",parts:[{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"define",name:"LIGHT_INDEX",tokens:["0"]},{type:"textline",tokens:["attribute","float","a_lf_dist",";","attribute","vec2","a_lf_bb_vertex",";","attribute","vec2","a_texcoord",";","uniform","mat4","u_view_matrix",
";","uniform","mat4","u_proj_matrix",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","varying","vec2","a",";","void","main","(",")","{","a","=","a_texcoord",";","vec3","iz","=","normalize","(","u_light_directions","[","LIGHT_INDEX","]",")",";","vec4","iA","=","u_proj_matrix","*","u_view_matrix","*","vec4","(","iz",",","0.0",")",";","iA",".","x","/=","iA",".","w",";","iA",".","y","/=","iA",".","w",";","iA","+=","99999.0","*","step","(","iA",".","z",",","0.0",")",";","iA","+=","100.0",
"*","(","step","(","1.0",",","abs","(","iA",".","x",")",")","+","step","(","1.0",",","abs","(","iA",".","y",")",")",")",";","iA",".","x","=","-","a_lf_dist","*","iA",".","x",";","iA",".","y","=","-","a_lf_dist","*","iA",".","y",";","float","iB","=","u_proj_matrix","[","1","]","[","1","]","/","u_proj_matrix","[","0","]","[","0","]",";","vec2","iC","=","vec2","(","a_lf_bb_vertex",".","x","/","iB",",","a_lf_bb_vertex",".","y",")",";","if","(","a_lf_dist",">","-","0.999",")","{","const","float","iD",
"=","1.9",";","iC","*=","(","1.0","+","iD","*","length","(","iA",".","xy",")",")",";","}","gl_Position","=","vec4","(","iA",".","xy","+","iC",",","0.999999",",","1.0",")",";","}"]}]},exports["special_skydome.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","samplerCube","u_sky",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","&&",
"!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",";","uniform","vec3","u_sun_intensity",";","uniform","float","u_environment_energy",";","uniform","vec4","u_underwater_fog_color_density",";"]}]}}]},{type:"textline",tokens:["varying","vec3","jP",";","void","main","(",")","{","vec3","iz","=","textureCube","(","u_sky",",","jP",")",".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","&&","!","DISABLE_FOG","&&","!",
"REFLECTION_PASS"],group:{type:"group",parts:[{type:"textline",tokens:["eb","(","iz",".","rgb",")",";","float","iA","=","u_camera_eye_frag",".","y","-","WATER_LEVEL",";","iA","=","min","(","-","iA","*","0.03",",","0.8",")",";","float","iB","=","length","(","u_sun_intensity",")","+","u_environment_energy",";","vec3","iC","=","normalize","(","jP",")",";","vec3","iD","=","vec3","(","0.0",")",";","vec4","iE","=","u_underwater_fog_color_density",";","iE",".","rgb","=","mix","(","iE",".","rgb",",","iD",
",","min","(","-","iC",".","y","+","iA",",","1.0",")",")","*","iB",";","float","iF","=","clamp","(","sign","(","iC",".","y","-","0.05","*","iA",")",",","0.0",",","1.0",")",";","iz","=","mix","(","iE",".","rgb",",","iz",",","iF",")",";","ed","(","iz",".","rgb",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","iz",",","1.0",")",";","}"]}]},exports["special_skydome.glslv"]={type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position",";","uniform","mat4","u_sky_vp_inverse",
";","varying","vec3","jP",";","void","main","(",")","{","vec4","iz","=","vec4","(","a_position",".","xy",",","0.9999999",",","1.0",")",";","vec4","iA","=","u_sky_vp_inverse","*","iz",";","jP","=","iA",".","xyz",";","gl_Position","=","iz",";","}"]}]},exports["special_water.glslf"]={type:"group",parts:[{type:"var",name:"ABSORB",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"SSS_STRENGTH",tokens:["6.0"]},{type:"var",name:"SSS_WIDTH",tokens:["0.0"]},{type:"include",file:"std_enums.glsl"},
{type:"include",file:"precision_statement.glslf"},{type:"include",file:"fog.glslf"},{type:"include",file:"procedural.glslf"},{type:"include",file:"lighting.glslf"},{type:"include",file:"pack.glslf"},{type:"include",file:"gamma.glslf"},{type:"include",file:"math.glslv"},{type:"define",name:"REFL_BUMP",tokens:["0.001"]},{type:"define",name:"REFR_BUMP",tokens:["0.0001"]},{type:"textline",tokens:["uniform","float","u_time",";","uniform","vec3","u_zenith_color",";","uniform","float","u_environment_energy",
";","uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors1","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors2","[","NUM_LIGHTS","]",";","uniform","vec3","u_sun_intensity",";","uniform","vec3","u_sun_direction",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE","||","REFRACTIVE","||","WATER_EFFECTS"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_cam_water_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG",
"&&","PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","0"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_normalmap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_reflectmap",";"]}]}},{type:"elif",expression:["TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shore_depth",";"]}]}},{type:"elif",expression:["ALPHA_MAP"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"sampler2D","u_alphamap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_foam",";"]}]}}]},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","uniform","vec2","u_diffuse_params",";","uniform","float","u_diffuse_intensity",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";","uniform","vec3","u_specular_color",";","uniform","vec2","u_specular_params",";"]},{type:"condition",
parts:[{type:"if",expression:["NUM_NORMALMAPS",">","0"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_normalmap0_uv_velocity",";","uniform","vec2","u_normalmap0_scale",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","1"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_normalmap1_uv_velocity",";","uniform","vec2","u_normalmap1_scale",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","2"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","vec2","u_normalmap2_uv_velocity",";","uniform","vec2","u_normalmap2_scale",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","3"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_normalmap3_uv_velocity",";","uniform","vec2","u_normalmap3_scale",";"]}]}}]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_reflect_factor",
";"]}]}},{type:"elif",expression:["TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","||","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_shallow_water_col",";","uniform",
"vec3","u_shore_water_col",";","uniform","float","u_water_shallow_col_fac",";","uniform","float","u_water_shore_col_fac",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_foam_factor",";","uniform","vec2","u_foam_uv_freq",";","uniform","vec2","u_foam_mag",";","uniform","vec2","u_foam_scale",";"]}]}}]},{type:"textline",tokens:["varying","vec3","hZ",";","varying","vec3","h_",";"]},{type:"condition",parts:[{type:"if",
expression:["!","GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ia",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","0"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ib",";","varying","vec3","jQ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","jR",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","jS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","||","REFLECTIVE","||","REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ct",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","||","REFLECTIVE",
"||","REFRACTIVE","||","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","jT",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","&&","SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["float","jZ","(","in","float","jU",",","inout","vec2","jV",",","in","vec2","jW",")","{","vec4","jX","=","texture2D","(","u_shore_depth",",","jV",")",";","float","jY","=","cn","(","jX",")",";","if","(","jY","<","jT",")","{","jV","=","jW",
";","return","jU",";","}","else","{","return","jY",";","}","}"]}]}}]},{type:"textline",tokens:["vec3","kn","(","in","vec2","j_",",","in","vec3","ka",",","in","vec3","kb",",","in","vec3","kc",",","out","float","kd",")","{","vec3","ke","=","reflect","(","-","kb",",","ka",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","kf","=","j_",".","xy","+","ka",".","xz","*","REFL_BUMP","/","jT",";","kd","=","u_reflect_factor",";",
"vec3","kg",";","if","(","u_cam_water_depth","<","0.0",")","{"]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG","&&","WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["kg","=","u_underwater_fog_color_density",".","rgb",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["kg","=","u_diffuse_color",".","rgb",";"]}]}}]},{type:"textline",tokens:["float","kh","=","dot","(","kb",",","ka",")",";","kd","*=","max","(","1.0","-","1.0","/","kh",",",
"1.0",")",";","}","else","{","kg","=","texture2D","(","u_reflectmap",",","kf",")",".","rgb",";","eb","(","kg",")",";","}"]}]}},{type:"elif",expression:["TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"textline",tokens:["kd","=","u_mirror_factor",";","vec3","kg","=","kc","*","textureCube","(","u_mirrormap",",","ke",")",".","rgb",";","eb","(","kg",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["kd","=","1.0",";","vec3","kg","=","kc","*","vec3","(","0.3",",","0.5",",",
"1.0",")",";","eb","(","kg",")",";"]}]}}]},{type:"textline",tokens:["vec3","ki","=","normalize","(","ke","+","kb",")",";","float","kj","=","1.0","-","dot","(","kb",",","ki",")",";","float","kk","=","u_fresnel_params","[","3","]",";","float","kl","=","u_fresnel_params","[","2","]",";","float","km","=","kk","+","(","1.0","-","kk",")","*","pow","(","kj",",","kl",")",";","kd","=","min","(","kd","*","km",",","1.0",")",";","return","kg",";","}","void","main","(",")","{"]},{type:"condition",parts:[{type:"if",
expression:["DYNAMIC"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","0"],group:{type:"group",parts:[{type:"textline",tokens:["mat3","ko","=","mat3","(","ib",",","jQ",",","ia",")",";"]}]}}]},{type:"textline",tokens:["vec3","kp","=","normalize","(","ia",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","0"],group:{type:"group",parts:[{type:"textline",tokens:["mat3","ko","=","mat3",
"(","1.0",",","0.0",",","0.0",",","0.0",",","0.0",",","-","1.0",",","0.0",",","1.0",",","0.0",")",";"]}]}}]},{type:"textline",tokens:["vec3","kp","=","vec3","(","0.0",",","1.0",",","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC","&&","(","REFLECTIVE","||","FOAM","||","(","WATER_EFFECTS","&&","!","DISABLE_FOG",")",")","||","GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["float","kq","=","h_",".","y","-","WATER_LEVEL",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","kr","=","vec2","(","jR",".","x",",","-","jR",".","z",")","+","0.5",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec2","kr","=","vec2","(","h_",".","x",",","-","h_",".","z",")","+","0.5",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec2","kr",
"=","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","0"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ks","=","vec3","(","0.0",")",";","vec3","kt","=","texture2D","(","u_normalmap0",",","kr","*","u_normalmap0_scale","+","u_normalmap0_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","ks","+=","kt",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ku","=","vec3","(","0.0",
")",";"]},{type:"condition",parts:[{type:"if",expression:["NORM_FOAM0"],group:{type:"group",parts:[{type:"textline",tokens:["ku","+=","kt",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","1"],group:{type:"group",parts:[{type:"textline",tokens:["kt","=","texture2D","(","u_normalmap0",",","kr","*","u_normalmap1_scale","+","u_normalmap1_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","ks","+=","kt",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORM_FOAM1"],group:{type:"group",parts:[{type:"textline",tokens:["ku","+=","kt",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","2"],group:{type:"group",parts:[{type:"textline",tokens:["kt","=","texture2D","(","u_normalmap0",",","kr","*","u_normalmap2_scale","+","u_normalmap2_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","ks","+=","kt",";"]},{type:"condition",parts:[{type:"if",
expression:["FOAM"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORM_FOAM2"],group:{type:"group",parts:[{type:"textline",tokens:["ku","+=","kt",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","3"],group:{type:"group",parts:[{type:"textline",tokens:["kt","=","texture2D","(","u_normalmap0",",","kr","*","u_normalmap3_scale","+","u_normalmap3_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","ks","+=","kt",";"]},{type:"condition",
parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORM_FOAM3"],group:{type:"group",parts:[{type:"textline",tokens:["ku","+=","kt",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","0"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","kv","=","ko","*","ku",";","if","(","!","h","(","kv",",","vec3","(","0.0",
")",")",")","kv","=","normalize","(","kv",")",";","vec3","kw","=","mix","(","kp",",","kv",",","0.2",")",";","kw","=","normalize","(","kw",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["kp","=","mix","(","kp",",","normalize","(","ko","*","ks",")",",","0.3",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["kp","=","mix","(","kp",",","normalize","(","ko","*","ks",")",",","0.5",")",";"]}]}}]},
{type:"textline",tokens:["kp","=","normalize","(","kp",")",";"]}]}}]},{type:"textline",tokens:["vec3","kx","=","normalize","(","hZ",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE","||","REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","ky","=","ct",".","xy","/","ct",".","z",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","||","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["float","kz","=","jT","*","u_view_max_depth",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["float","kA","=","u_diffuse_color",".","a",";","vec4","kB","=","texture2DProj","(","u_shore_depth",",","ct",")",";","float","kC","=","cn","(","kB",")",";","float","kD","=","max","(","kC","-","jT",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","kE","=","ky","+","kp",".","xz","*",
"REFR_BUMP","/","jT",";","float","kF","=","jZ","(","kC",",","kE",",","ky",")",";","float","kG","=","max","(","kF","-","jT",",","0.0",")",";","float","kH","=","u_view_max_depth","/","ABSORB","*","kG",";","float","kI",";","if","(","u_cam_water_depth","<","0.0",")","kI","=","0.0",";","else","kI","=","min","(","kA","*","kH",",","1.0",")",";","float","kJ","=","u_view_max_depth","/","ABSORB","*","kD",";","kA","=","min","(","15.0","*","kA","*","u_view_max_depth","*","kD",",","1.0",")",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["float","kJ","=","u_view_max_depth","/","ABSORB","*","kD",";","if","(","u_cam_water_depth",">","0.0",")","kA","=","min","(","kA","*","kJ",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["kA","*=","min","(","5.0","*","kz",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["ALPHA_MAP"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","kK","=","texture2D","(","u_alphamap",",","kr",
")",";","float","kA","=","kK",".","r",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","kA","=","u_diffuse_color",".","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["float","kI","=","1.0","-","kA",";","vec2","kE","=","ky","+","kp",".","xz","*","REFR_BUMP","/","jT",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","kL","=","texture2D","(","u_refractmap",",","kE",")",".","rgb",";","eb","(","kL",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["float","kM","=","pow","(","min","(","jS",".","b","/","u_water_shallow_col_fac",",","1.0",")",",","0.3",")",";","vec3","kN","=","mix","(","u_shallow_water_col",",","u_diffuse_color",".","rgb",",","kM",")",";","kM","=","pow","(","min","(","jS",".","b","/","u_water_shore_col_fac",
",","1.0",")",",","0.3",")",";","kN","=","mix","(","u_shore_water_col",",","kN",",","kM",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","kN","=","u_diffuse_color",".","rgb",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["float","kO","=","max","(","1.0","-","u_view_max_depth","*","kD",",","0.0",")",
";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","kO","=","1.0","-","kA",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["float","kP","=","max","(","3.0","*","kq",",","0.0",")",";","kP","*=","kP",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","kQ","=","normalize","(","vec3","(","jS",".","r",",","0.0",",","jS",".",
"g",")",")",";","vec3","kR","=","normalize","(","mix","(","vec3","(","0.0",",","1.0",",","0.0",")",",","kQ",",","0.8",")",")",";","float","kS","=","max","(","2.5","*","dot","(","kw",",","kR",")","-","0.7",",","0.0",")",";","kO","+=","kS","*","(","1.0","-","jS",".","b",")",";","kP","*=","(","1.0","-","0.95","*","pow","(","jS",".","b",",","0.1",")",")",";"]}]}}]},{type:"textline",tokens:["kO","+=","kP",";","kO","=","min","(","u_foam_factor","*","kO",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["vec4",
"kT","=","texture2D","(","u_foam",",","u_foam_mag","*","sin","(","u_foam_uv_freq","*","u_time",")","+","kr","*","u_foam_scale",")",";"]}]}}]},{type:"textline",tokens:["float","kU","=","u_specular_params","[","0","]",";","float","kV","=","u_specular_params","[","1","]",";","vec3","kW","=","kU","*","u_specular_color",";","vec3","kX","=","u_environment_energy","*","u_zenith_color",";","vec3","kY","=","u_ambient","*","kX",";","vec3","kZ","=","kY","+","u_sun_intensity",";","float","k_",";"]},{type:"condition",
parts:[{type:"if",expression:["REFLECTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","la","=","kn","(","ky",",","kp",",","kx",",","kZ",",","k_",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","la","=","kn","(","vec2","(","0.0",")",",","kp",",","kx",",","kZ",",","k_",")",";"]}]}}]},{type:"textline",tokens:["vec3","lb","=","u_diffuse_intensity","*","kN",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS","&&","DYNAMIC"],group:{type:"group",
parts:[{type:"textline",tokens:["float","lc","=","max","(","dot","(","u_sun_direction",",","-","ia",")","+","SSS_WIDTH",",","0.0",")","*","max","(","dot","(","-","kx",",","u_sun_direction",")","-","0.5",",","0.0",")","*","max","(","0.0",",","length","(","u_sun_intensity",")","-","0.1",")",";","lc","=","clamp","(","SSS_STRENGTH","*","lc",",","0.0",",","1.0",")",";","lb","=","mix","(","lb",",","u_shallow_water_col",",","lc",")",";","lb","=","mix","(","lb",",","u_shore_water_col",",","lc",")",";"]}]}}]},
{type:"textline",tokens:["eW","ld","=","gz","(","vec3","(","0.0",")",",","vec3","(","0.0",")",",","lb",",","kW",",","h_",",","kp",",","kx",",","kV",",","u_diffuse_params",",","1.0",",","u_light_positions",",","u_light_directions",",","u_light_color_intensities",",","u_light_factors1",",","u_light_factors2",",","0.0",",","vec4","(","0.0",")",")",";","lb","=","ld",".","a",".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["lb",
"=","mix","(","kL",",","lb",",","kI",")",";"]}]}}]},{type:"textline",tokens:["lb","=","mix","(","lb",",","la",",","k_",")",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["float","le","=","mix","(","kT",".","g",",","kT",".","r",",","clamp","(","4.0","*","(","kO","-","0.75",")",",","0.0",",","1.0",")",")",";","le","=","mix","(","kT",".","b",",","le",",","clamp","(","2.0","*","kO","-","1.0",",","0.0",",","1.0",")",")",";","le","=","mix",
"(","0.0",",","le",",","kO",")",";","lb","=","mix","(","lb",",","kZ",",","le",")",";"]}]}}]},{type:"textline",tokens:["lb","+=","ld",".","b",";"]},{type:"condition",parts:[{type:"if",expression:["!","DISABLE_FOG"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","lf","=","ev","(","u_cube_fog",",","kx",")",";","vec4","lg","=","vec4","(","lf",",","u_fog_color_density",".","a",")",";","eb","(","lg",
".","rgb",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","lg","=","u_fog_color_density",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","u_cam_water_depth","<","0.0",")","{","eV","(","lb",",","kz",",","u_cam_water_depth",",","u_underwater_fog_color_density",",","length","(","u_sun_intensity",")","+","u_environment_energy",")",";","}","else","{","eo","(","lb",",","kz",",",
"lg",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["eo","(","lb",",","kz",",","lg",")",";"]}]}}]}]}}]},{type:"textline",tokens:["ed","(","lb",")",";"]},{type:"condition",parts:[{type:"if",expression:["!","REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["kA","=","max","(","kA",",","ld",".","b",".","r",")",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["kA","+=","le",";"]}]}}]}]}}]},
{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["eg","(","lb",",","kA",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","lb",",","kA",")",";","}"]}]},exports["special_water.glslv"]={type:"group",parts:[{type:"var",name:"DIR_MIN_SHR_FAC",tokens:["0.0"]},{type:"var",name:"DIR_FREQ",tokens:["0.0"]},{type:"var",name:"DIR_NOISE_SCALE",tokens:["0.0"]},{type:"var",name:"DIR_NOISE_FREQ",tokens:["0.0"]},{type:"var",name:"DIR_MIN_NOISE_FAC",
tokens:["0.0"]},{type:"var",name:"DST_NOISE_SCALE_0",tokens:["0.0"]},{type:"var",name:"DST_NOISE_FREQ_0",tokens:["0.0"]},{type:"var",name:"DST_NOISE_SCALE_1",tokens:["0.0"]},{type:"var",name:"DST_NOISE_FREQ_1",tokens:["0.0"]},{type:"var",name:"DST_MIN_FAC",tokens:["0.0"]},{type:"var",name:"MAX_SHORE_DIST",tokens:["0.0"]},{type:"var",name:"PRECISION",tokens:["mediump"]},{type:"var",name:"SHORE_MAP_CENTER_X",tokens:["0.0"]},{type:"var",name:"SHORE_MAP_SIZE_X",tokens:["0.0"]},{type:"var",name:"SHORE_MAP_CENTER_Z",
tokens:["0.0"]},{type:"var",name:"SHORE_MAP_SIZE_Z",tokens:["0.0"]},{type:"var",name:"WAVES_HOR_FAC",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"WAVES_LENGTH",tokens:["0.0"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"include",file:"procedural.glslf"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",
parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_cascad_step",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix","=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","uniform","vec3","u_camera_eye",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_time",";","uniform","vec3","u_wind",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","||","REFLECTIVE","||","REFRACTIVE","||","!","DISABLE_FOG"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shore_dist_map",";"]}]}}]},{type:"textline",tokens:["varying","vec3","hZ",";","varying","vec3","h_",";"]},{type:"condition",parts:[{type:"if",expression:["!","GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","a",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ia",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",">","0"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ib",";","varying","vec3","jQ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","jR",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","jS",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","||","REFLECTIVE","||","REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","ct",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","||","REFLECTIVE","||","REFRACTIVE","||","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","jT",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iF","(","in","vec2","iz",")","{","vec2","iA","=","vec2","(","(","iz",".","x","-","SHORE_MAP_CENTER_X",")","/","SHORE_MAP_SIZE_X",",","-","(","SHORE_MAP_CENTER_Z","+","iz",".","y",")","/","SHORE_MAP_SIZE_Z",")","+","0.5",";","iA","=","clamp","(","iA",",","0.0",",","1.0",")",";","vec4","iB","=","texture2D","(","u_shore_dist_map",",","iA",")",";","const","vec2","iC","=","vec2","(","1.0","/","255.0",
",","1.0",")",";","float","iD","=","dot","(","iB",".","ba",",","iC",")",";","vec2","iE","=","normalize","(","iB",".","rg","*","2.0","-","1.0",")",";","return","vec3","(","iE",",","iD",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"textline",tokens:["void","iT","(","inout","vec3","iG",",","in","float","iH",",","in","vec3","iI",")","{","float","iJ","=","hx","(","DST_NOISE_SCALE_0","*",
"(","iG",".","xz","+","DST_NOISE_FREQ_0","*","iH",")",")","*","hx","(","DST_NOISE_SCALE_1","*","(","iG",".","zx","-","DST_NOISE_FREQ_1","*","iH",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["float","iK","=","iI",".","b",";","float","iL","=","WAVES_LENGTH","/","MAX_SHORE_DIST","/","M_PI",";","float","iM","=","sqrt","(","iK",")",";","float","iN","=","max","(","iK",",","DIR_MIN_SHR_FAC",")","*","(","sin","(","(","iM",
"/","iL","+","DIR_FREQ","*","iH",")",")",")","*","max","(","hx","(","DIR_NOISE_SCALE","*","(","iG",".","xz","+","DIR_NOISE_FREQ","*","iH",")",")",",","DIR_MIN_NOISE_FAC",")",";","float","iO","=","WAVES_HEIGHT","*","mix","(","iN",",","iJ",",","max","(","iM",",","DST_MIN_FAC",")",")",";","vec2","iP","=","iI",".","rg",";","float","iQ","=","WAVES_HOR_FAC","*","iN","*","max","(","MAX_SHORE_DIST","/","35.0","*","(","0.05","-","iK",")",",","0.0",")",";","vec2","iR","=","iQ","*","iP",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["float","iO","=","WAVES_HEIGHT","*","iJ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["float","iS","=","gT","(","20.0","/","WAVES_LENGTH","*","(","iG",".","xz","-","0.25","*","iH",")",")",".","x","+","gT","(","17.0","/","WAVES_LENGTH","*","(","iG",".","zx","+","0.1","*","iH",")",")",".","x","-","1.0",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],
group:{type:"group",parts:[{type:"textline",tokens:["iG",".","xz","+=","iR",";","iS","*=","iK",";"]}]}}]},{type:"textline",tokens:["iO","+=","0.05","*","iS",";"]}]}}]},{type:"textline",tokens:["iG",".","y","+=","iO",";","}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec3","iU","=","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["float","iV","=","abs","(","a_cascad_step",")",";","vec2","iW","=",
"u_camera_eye",".","xz","-","mod","(","u_camera_eye",".","xz",",","iV",")",";","iU",".","y","+=","WATER_LEVEL",";","iU",".","xz","+=","iW",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["a","=","a_texcoord",";"]}]}}]},{type:"textline",tokens:["b","iX","=","ai","(","iU",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC","&&","GENERATED_MESH"],
group:{type:"group",parts:[{type:"textline",tokens:["jR","=","iX",".","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["jS","=","iF","(","iX",".","a",".","xz",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["float","iY","=","length","(","u_wind",")",";","float","jU","=","u_time",";","jU","*=","iY",";"]},{type:"condition",parts:[{type:"if",
expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["float","jV","=","iV",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","jV","=","0.1",";"]}]}}]},{type:"textline",tokens:["vec3","jW","=","iX",".","a","+","vec3","(","jV",",","0.0",",","0.0",")",";","vec3","jX","=","iX",".","a","+","vec3","(","0.0",",","0.0",",","jV",")",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","jY","=","iF","(","jW",".","xz",")",";","vec3","jZ","=","iF","(","jX",".","xz",")",";","iT","(","jW",",","jU",",","jY",")",";","iT","(","jX",",","jU",",","jZ",")",";","iT","(","iX",".","a",",","jU",",","jS",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["iT","(","jW",",","jU",",","vec3","(","0.0",")",")",";","iT","(","jX",",","jU",",","vec3","(","0.0",")",")",";","iT","(","iX",".","a",",","jU",",","vec3","(","0.0",")",")",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","a_cascad_step","<","0.0",")","{","jW",".","y","=","iX",".","a",".","y",";","jX",".","y","=","iX",".","a",".","y",";","}"]}]}}]},{type:"textline",tokens:["vec3","j_","=","normalize","(","jW","-","iX",".","a",")",";","vec3","ka","=","normalize","(","jX","-","iX",".","a",")",";","ia","=","normalize","(","cross","(","ka",",","j_",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",
">","0"],group:{type:"group",parts:[{type:"textline",tokens:["ib","=","ka",";","jQ","=","cross","(","ia",",","ib",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["float","kb","=","dot","(","ia",",","vec3","(","0.0",",","1.0",",","0.0",")",")",";","float","kc","=","clamp","(","0.8","-","kb",",","0.0",",","1.0",")",";","ia","=","mix","(","ia",",","vec3","(","0.0",",","1.0",",","0.0",")",",","kc",")",";"]}]}}]}]}}]},{type:"textline",
tokens:["h_","=","iX",".","a",";","hZ","=","u_camera_eye","-","iX",".","a",";","vec4","kd","=","u_view_matrix","*","vec4","(","iX",".","a",",","1.0",")",";","vec4","ke","=","u_proj_matrix","*","kd",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","||","REFLECTIVE","||","REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["float","kf","=","ke",".","x",";","float","kg","=","ke",".","y",";","float","kh","=","ke",".","w",";","ct",".","x","=","(","kf","+","kh",")","/",
"2.0",";","ct",".","y","=","(","kg","+","kh",")","/","2.0",";","ct",".","z","=","kh",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","||","REFLECTIVE","||","REFRACTIVE","||","!","DISABLE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["jT","=","-","kd",".","z","/","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","ke",";","}"]}]},exports["wireframe.glslf"]={type:"group",parts:[{type:"define",name:"WM_OPAQUE_WIREFRAME",tokens:["0"]},{type:"define",
name:"WM_TRANSPARENT_WIREFRAME",tokens:["1"]},{type:"define",name:"WM_FRONT_BACK_VIEW",tokens:["2"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"condition",parts:[{type:"if",expression:["!","DEBUG_SPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","int","u_wireframe_mode",";","uniform","vec3","u_wireframe_edge_color",";"]}]}}]},{type:"textline",tokens:["varying","vec3","jU",";","const","float","jV","=","1.0",";"]},{type:"condition",
parts:[{type:"if",expression:["DEBUG_SPHERE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE_DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["const","vec3","jW","=","vec3","(","1.0",",","0.05",",","0.05",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["const","vec3","jW","=","vec3","(","0.05",",","0.05",",","1.0",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["const","vec3","jX",
"=","vec3","(","0.4",",","0.4",",","1.0",")",";","const","vec3","jY","=","vec3","(","1.0",",","0.4",",","0.4",")",";","const","vec3","jZ","=","vec3","(","1.0",",","1.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec3","j_","=","vec3","(","0.0",")",";","float","ka","=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","kb","=","sign","(","jU","-","vec3","(","0.02","*","jV",")",")",
";","if","(","kb",".","x","<","0.0","||","kb",".","y","<","0.0","||","kb",".","z","<","0.0",")","{","j_","=","jW",";","ka","=","1.0",";","}","else","discard",";"]}]}},{type:"elif",expression:["WIREFRAME_QUALITY","==","0"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","kb","=","sign","(","jU","-","vec3","(","0.02","*","jV",")",")",";","if","(","u_wireframe_mode","==","WM_OPAQUE_WIREFRAME",")","{","if","(","kb",".","x","<","0.0","||","kb",".","y","<","0.0","||","kb",".","z","<","0.0",")",
"j_","=","u_wireframe_edge_color",";","else","j_","=","jZ",";","ka","=","1.0",";","}","else","if","(","u_wireframe_mode","==","WM_TRANSPARENT_WIREFRAME",")","{","if","(","kb",".","x","<","0.0","||","kb",".","y","<","0.0","||","kb",".","z","<","0.0",")","ka","=","1.0",";","else","ka","=","0.0",";","j_","=","u_wireframe_edge_color",";","}","else","if","(","u_wireframe_mode","==","WM_FRONT_BACK_VIEW",")","{","if","(","kb",".","x","<","0.0","||","kb",".","y","<","0.0","||","kb",".","z","<","0.0",")",
"j_","=","u_wireframe_edge_color",";","else","if","(","gl_FrontFacing",")","j_","=","jX",";","else","j_","=","jY",";","ka","=","1.0",";","}"]}]}},{type:"elif",expression:["WIREFRAME_QUALITY","==","1"],group:{type:"group",parts:[{type:"extension",tokens:["GL_OES_standard_derivatives",":","enable"]},{type:"textline",tokens:["vec3","kc","=","fwidth","(","jU",")",";","vec3","kd","=","smoothstep","(","vec3","(","0.0",")",",","kc","*","jV",",","jU",")",";","float","ke","=","min","(","min","(","kd",".",
"x",",","kd",".","y",")",",","kd",".","z",")",";","ke","=","clamp","(","ke",",","0.0",",","1.0",")",";","if","(","u_wireframe_mode","==","WM_OPAQUE_WIREFRAME",")","{","j_","=","vec3","(","mix","(","u_wireframe_edge_color",",","jZ",",","ke",")",")",";","ka","=","1.0",";","}","else","if","(","u_wireframe_mode","==","WM_TRANSPARENT_WIREFRAME",")","{","j_","=","u_wireframe_edge_color",";","ka","=","mix","(","1.0",",","0.0",",","ke",")",";","}","else","if","(","u_wireframe_mode","==","WM_FRONT_BACK_VIEW",
")","{","if","(","gl_FrontFacing",")","j_","=","mix","(","u_wireframe_edge_color",",","jX",",","ke",")",";","else","j_","=","mix","(","u_wireframe_edge_color",",","jY",",","ke",")",";","ka","=","1.0",";","}"]}]}}]},{type:"textline",tokens:["ed","(","j_",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["eg","(","j_",",","ka",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","j_",",","ka",")",";","}"]}]},exports["wireframe.glslv"]=
{type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_normal",";","attribute","float","a_polyindex",";"]},{type:"condition",parts:[{type:"if",expression:["!","DEBUG_SPHERE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float",
"au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","||","DYNAMIC_GRASS","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER",
"vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat4","u_model_matrix",
"=","mat4","(","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_model_matrix",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_proj_matrix",";","uniform","mat4","u_view_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["!","DEBUG_SPHERE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","PRECISION",
"float","u_time",";"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD","&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS","||","HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4",
"u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_grass_map_depth",";","uniform","sampler2D","u_grass_map_color",";","uniform","vec4","u_camera_quat",";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec3",
"jU",";"]},{type:"condition",parts:[{type:"if",expression:["!","DEBUG_SPHERE"],group:{type:"group",parts:[{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"include",file:"dynamic_grass.glslv"}]}}]},{type:"textline",tokens:["void","main","(",")","{","if","(","a_polyindex","==","0.0",")","jU","=","vec3","(","1.0",",","0.0",",","0.0",")",";","else","if","(","a_polyindex","==","1.0",")","jU","=","vec3","(","0.0",",","1.0",",","0.0",")",";","else","if","(","a_polyindex",
"==","2.0",")","jU","=","vec3","(","0.0",",","0.0",",","1.0",")",";","vec3","iz","=","a_position",";","vec3","iA","=","a_normal",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["b","iB","=","ai","(","iz",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],
group:{type:"group",parts:[{type:"textline",tokens:["iz","=","mix","(","iz",",","a_position_next",",","u_va_frame_factor",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iC","=","vec3","(","0.0",")",";","vec3","iD","=","vec3","(","0.0",")",";","bn","(","iz",",","iC",",","iD",",","iA",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","||","DYNAMIC_GRASS","||","HAIR_BILLBOARD"],group:{type:"group",
parts:[{type:"textline",tokens:["vec3","iE","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","iE","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["b","iB","=","dT","(","iz",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","iE",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",
",","u_camera_eye",",","u_camera_quat",",","u_view_matrix",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","iF","=","(","u_model_matrix","*","vec4","(","iE",",","1.0",")",")",".","xyz",";","mat4","iG","=","ab","(","u_camera_eye",",","iF",",","u_view_matrix",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","&&","HAIR_BILLBOARD_JITTERED"],group:{type:"group",
parts:[{type:"textline",tokens:["vec3","iH","=","(","u_model_matrix","*","vec4","(","iE",",","1.0",")",")",".","xyz",";","iG","=","iG","*","R","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","iH",")",";"]}]}}]},{type:"textline",tokens:["b","iB","=","ai","(","iz","-","iE",",","iE",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","iG",")",";","iB",".","b","=","iF",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["b","iB","=",
"ai","(","iz",",","iE",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","u_model_matrix",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["ce","(","iB",".","a",",","iB",".","b",",","iA",")",";"]}]}}]}]}}]},{type:"textline",tokens:["vec4","iI","=","u_view_matrix","*","vec4","(","iB",".","a",",","1.0",")",";","gl_Position","=","u_proj_matrix","*","iI",";","}"]}]},exports["postprocessing/anaglyph.glslf"]=
{type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_sampler_left",";","uniform","sampler2D","u_sampler_right",";","varying","vec2","a",";","void","main","(",")","{","vec4","iz","=","texture2D","(","u_sampler_left",",","a",")",";","vec4","iA","=","texture2D","(","u_sampler_right",",","a",")",";","gl_FragColor","=","vec4","(","iz","[","0","]",",","iA","[","1","]",",","iA","[","2","]",",","iz","[","3","]","+","iA","[","3","]",")",";",
"}"]}]},exports["postprocessing/antialiasing.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"define",name:"AA_METHOD_PASS",tokens:["1"]},{type:"define",name:"AA_METHOD_FXAA_LIGHT",tokens:["2"]},{type:"define",name:"AA_METHOD_FXAA_QUALITY",tokens:["3"]},{type:"define",name:"FXAA_REDUCE_MIN",tokens:["(","1.0","/","128.0",")"]},{type:"define",name:"FXAA_REDUCE_MUL",tokens:["(","1.0","/","8.0",")"]},{type:"define",name:"FXAA_SPAN_MAX",tokens:["8.0"]},{type:"textline",
tokens:["uniform","sampler2D","u_color",";","uniform","vec2","u_texel_size",";","varying","vec2","a",";","vec4","iC","(","float","iz",",","float","iA",")","{","vec2","iB","=","a","+","vec2","(","iz",",","iA",")","*","u_texel_size",";","return","texture2D","(","u_color",",","iB",")",";","}","float","iG","(","vec4","iD",")","{","vec3","iE","=","vec3","(","0.299",",","0.587",",","0.114",")",";","float","iF","=","dot","(","iD",".","rgb",",","iE",")",";","return","iF",";","}","vec4","jV","(",")","{","vec4",
"iH","=","iC","(","-","1.0",",","-","1.0",")",";","vec4","iI","=","iC","(","1.0",",","-","1.0",")",";","vec4","iJ","=","iC","(","-","1.0",",","1.0",")",";","vec4","iK","=","iC","(","1.0",",","1.0",")",";","vec4","iL","=","iC","(","0.0",",","0.0",")",";","float","iM","=","iG","(","iH",")",";","float","iN","=","iG","(","iI",")",";","float","iO","=","iG","(","iJ",")",";","float","iP","=","iG","(","iK",")",";","float","iQ","=","iG","(","iL",")",";","float","iR","=","min","(","iQ",",","min","(","min",
"(","iM",",","iN",")",",","min","(","iO",",","iP",")",")",")",";","float","iS","=","max","(","iQ",",","max","(","max","(","iM",",","iN",")",",","max","(","iO",",","iP",")",")",")",";","vec2","iT",";","iT",".","x","=","-","(","(","iM","+","iN",")","-","(","iO","+","iP",")",")",";","iT",".","y","=","(","(","iM","+","iO",")","-","(","iN","+","iP",")",")",";","float","iU","=","max","(","(","iM","+","iN","+","iO","+","iP",")","*","(","0.25","*","FXAA_REDUCE_MUL",")",",","FXAA_REDUCE_MIN",")",";","float",
"iV","=","1.0","/","(","min","(","abs","(","iT",".","x",")",",","abs","(","iT",".","y",")",")","+","iU",")",";","iT","=","min","(","vec2","(","FXAA_SPAN_MAX",",","FXAA_SPAN_MAX",")",",","max","(","vec2","(","-","FXAA_SPAN_MAX",",","-","FXAA_SPAN_MAX",")",",","iT","*","iV",")",")","*","u_texel_size",";","vec4","iW","=","0.5","*","(","texture2D","(","u_color",",","a","+","iT","*","(","1.0","/","3.0","-","0.5",")",")","+","texture2D","(","u_color",",","a","+","iT","*","(","2.0","/","3.0","-","0.5",")",
")",")",";","vec4","iX","=","iW","*","0.5","+","0.25","*","(","texture2D","(","u_color",",","a","+","iT","*","-","0.5",")","+","texture2D","(","u_color",",","a","+","iT","*","0.5",")",")",";","float","iY","=","iG","(","iX",")",";","if","(","(","iY","<","iR",")","||","(","iY",">","iS",")",")","return","iW",";","else","return","iX",";","}"]},{type:"define",name:"FXAA_QUALITY_EDGE_THRESHOLD",tokens:["(","1.0","/","6.0",")"]},{type:"define",name:"FXAA_QUALITY_EDGE_THRESHOLD_MIN",tokens:["(","1.0","/",
"12.0",")"]},{type:"define",name:"FXAA_QUALITY_SUBPIX",tokens:["(","3.0","/","4.0",")"]},{type:"textline",tokens:["vec4","lG","(",")","{","vec2","jW",";","jW",".","x","=","a",".","x",";","jW",".","y","=","a",".","y",";","vec4","jX","=","texture2D","(","u_color",",","jW",")",";","vec4","jY","=","iC","(","0.0",",","1.0",")",";","vec4","jZ","=","iC","(","1.0",",","0.0",")",";","vec4","j_","=","iC","(","0.0",",","-","1.0",")",";","vec4","ka","=","iC","(","-","1.0",",","0.0",")",";","float","kb","=","iG",
"(","jY",")",";","float","kc","=","iG","(","jZ",")",";","float","kd","=","iG","(","j_",")",";","float","ke","=","iG","(","ka",")",";","float","kf","=","iG","(","jX",")",";","float","kg","=","max","(","kb",",","kf",")",";","float","kh","=","min","(","kb",",","kf",")",";","float","ki","=","max","(","kc",",","kg",")",";","float","kj","=","min","(","kc",",","kh",")",";","float","kk","=","max","(","kd",",","ke",")",";","float","kl","=","min","(","kd",",","ke",")",";","float","km","=","max","(","kk",",",
"ki",")",";","float","kn","=","min","(","kl",",","kj",")",";","float","ko","=","km","*","FXAA_QUALITY_EDGE_THRESHOLD",";","float","kp","=","km","-","kn",";","float","kq","=","max","(","FXAA_QUALITY_EDGE_THRESHOLD_MIN",",","ko",")",";","bool","kr","=","kp","<","kq",";","if","(","kr",")","return","jX",";","vec4","ks","=","iC","(","-","1.0",",","-","1.0",")",";","vec4","kt","=","iC","(","1.0",",","1.0",")",";","vec4","ku","=","iC","(","1.0",",","-","1.0",")",";","vec4","kv","=","iC","(","-","1.0",",",
"1.0",")",";","float","kw","=","iG","(","ks",")",";","float","kx","=","iG","(","kt",")",";","float","ky","=","iG","(","ku",")",";","float","kz","=","iG","(","kv",")",";","float","kA","=","kd","+","kb",";","float","kB","=","ke","+","kc",";","float","kC","=","1.0","/","kp",";","float","kD","=","kA","+","kB",";","float","kE","=","(","-","2.0","*","kf",")","+","kA",";","float","kF","=","(","-","2.0","*","kf",")","+","kB",";","float","kG","=","ky","+","kx",";","float","kH","=","kw","+","ky",";","float",
"kI","=","(","-","2.0","*","kc",")","+","kG",";","float","kJ","=","(","-","2.0","*","kd",")","+","kH",";","float","kK","=","kw","+","kz",";","float","kL","=","kz","+","kx",";","float","kM","=","(","abs","(","kE",")","*","2.0",")","+","abs","(","kI",")",";","float","kN","=","(","abs","(","kF",")","*","2.0",")","+","abs","(","kJ",")",";","float","kO","=","(","-","2.0","*","ke",")","+","kK",";","float","kP","=","(","-","2.0","*","kb",")","+","kL",";","float","kQ","=","abs","(","kO",")","+","kM",";",
"float","kR","=","abs","(","kP",")","+","kN",";","float","kS","=","kK","+","kG",";","float","kT","=","u_texel_size",".","x",";","bool","kU","=","kQ",">=","kR",";","float","kV","=","kD","*","2.0","+","kS",";","if","(","!","kU",")","kd","=","ke",";","if","(","!","kU",")","kb","=","kc",";","if","(","kU",")","kT","=","u_texel_size",".","y",";","float","kW","=","(","kV","*","(","1.0","/","12.0",")",")","-","kf",";","float","kX","=","kd","-","kf",";","float","kY","=","kb","-","kf",";","float","kZ","=",
"kd","+","kf",";","float","k_","=","kb","+","kf",";","bool","la","=","abs","(","kX",")",">=","abs","(","kY",")",";","float","lb","=","max","(","abs","(","kX",")",",","abs","(","kY",")",")",";","if","(","la",")","kT","=","-","kT",";","float","lc","=","clamp","(","abs","(","kW",")","*","kC",",","0.0",",","1.0",")",";","vec2","ld",";","ld",".","x","=","jW",".","x",";","ld",".","y","=","jW",".","y",";","vec2","le",";","le",".","x","=","(","!","kU",")","?","0.0",":","u_texel_size",".","x",";","le",".",
"y","=","(","kU",")","?","0.0",":","u_texel_size",".","y",";","if","(","!","kU",")","ld",".","x","+=","kT","*","0.5",";","if","(","kU",")","ld",".","y","+=","kT","*","0.5",";","vec2","lf",";","lf",".","x","=","ld",".","x","-","le",".","x",";","lf",".","y","=","ld",".","y","-","le",".","y",";","vec2","lg",";","lg",".","x","=","ld",".","x","+","le",".","x",";","lg",".","y","=","ld",".","y","+","le",".","y",";","float","lh","=","(","(","-","2.0",")","*","lc",")","+","3.0",";","float","li","=","iG","(",
"texture2D","(","u_color",",","lf",")",")",";","float","lj","=","lc","*","lc",";","float","lk","=","iG","(","texture2D","(","u_color",",","lg",")",")",";","if","(","!","la",")","kZ","=","k_",";","float","ll","=","lb","*","1.0","/","4.0",";","float","lm","=","kf","-","kZ","*","0.5",";","float","ln","=","lh","*","lj",";","bool","lo","=","lm","<","0.0",";","li","-=","kZ","*","0.5",";","lk","-=","kZ","*","0.5",";","bool","lp","=","abs","(","li",")",">=","ll",";","bool","lq","=","abs","(","lk",")",">=",
"ll",";","if","(","!","lp",")","lf",".","x","-=","le",".","x","*","1.5",";","if","(","!","lp",")","lf",".","y","-=","le",".","y","*","1.5",";","bool","lr","=","(","!","lp",")","||","(","!","lq",")",";","if","(","!","lq",")","lg",".","x","+=","le",".","x","*","1.5",";","if","(","!","lq",")","lg",".","y","+=","le",".","y","*","1.5",";","if","(","lr",")","{","if","(","!","lp",")","li","=","iG","(","texture2D","(","u_color",",","lf",".","xy",")",")",";","if","(","!","lq",")","lk","=","iG","(","texture2D",
"(","u_color",",","lg",".","xy",")",")",";","if","(","!","lp",")","li","=","li","-","kZ","*","0.5",";","if","(","!","lq",")","lk","=","lk","-","kZ","*","0.5",";","lp","=","abs","(","li",")",">=","ll",";","lq","=","abs","(","lk",")",">=","ll",";","if","(","!","lp",")","lf",".","x","-=","le",".","x","*","2.0",";","if","(","!","lp",")","lf",".","y","-=","le",".","y","*","2.0",";","lr","=","(","!","lp",")","||","(","!","lq",")",";","if","(","!","lq",")","lg",".","x","+=","le",".","x","*","2.0",";","if",
"(","!","lq",")","lg",".","y","+=","le",".","y","*","2.0",";","if","(","lr",")","{","if","(","!","lp",")","li","=","iG","(","texture2D","(","u_color",",","lf",".","xy",")",")",";","if","(","!","lq",")","lk","=","iG","(","texture2D","(","u_color",",","lg",".","xy",")",")",";","if","(","!","lp",")","li","=","li","-","kZ","*","0.5",";","if","(","!","lq",")","lk","=","lk","-","kZ","*","0.5",";","lp","=","abs","(","li",")",">=","ll",";","lq","=","abs","(","lk",")",">=","ll",";","if","(","!","lp",")","lf",
".","x","-=","le",".","x","*","2.0",";","if","(","!","lp",")","lf",".","y","-=","le",".","y","*","2.0",";","lr","=","(","!","lp",")","||","(","!","lq",")",";","if","(","!","lq",")","lg",".","x","+=","le",".","x","*","2.0",";","if","(","!","lq",")","lg",".","y","+=","le",".","y","*","2.0",";","if","(","lr",")","{","if","(","!","lp",")","li","=","iG","(","texture2D","(","u_color",",","lf",".","xy",")",")",";","if","(","!","lq",")","lk","=","iG","(","texture2D","(","u_color",",","lg",".","xy",")",")",
";","if","(","!","lp",")","li","=","li","-","kZ","*","0.5",";","if","(","!","lq",")","lk","=","lk","-","kZ","*","0.5",";","lp","=","abs","(","li",")",">=","ll",";","lq","=","abs","(","lk",")",">=","ll",";","if","(","!","lp",")","lf",".","x","-=","le",".","x","*","4.0",";","if","(","!","lp",")","lf",".","y","-=","le",".","y","*","4.0",";","lr","=","(","!","lp",")","||","(","!","lq",")",";","if","(","!","lq",")","lg",".","x","+=","le",".","x","*","4.0",";","if","(","!","lq",")","lg",".","y","+=","le",
".","y","*","4.0",";","if","(","lr",")","{","if","(","!","lp",")","li","=","iG","(","texture2D","(","u_color",",","lf",".","xy",")",")",";","if","(","!","lq",")","lk","=","iG","(","texture2D","(","u_color",",","lg",".","xy",")",")",";","if","(","!","lp",")","li","=","li","-","kZ","*","0.5",";","if","(","!","lq",")","lk","=","lk","-","kZ","*","0.5",";","lp","=","abs","(","li",")",">=","ll",";","lq","=","abs","(","lk",")",">=","ll",";","if","(","!","lp",")","lf",".","x","-=","le",".","x","*","2.0",
";","if","(","!","lp",")","lf",".","y","-=","le",".","y","*","2.0",";","if","(","!","lq",")","lg",".","x","+=","le",".","x","*","2.0",";","if","(","!","lq",")","lg",".","y","+=","le",".","y","*","2.0",";","}","}","}","}","float","ls","=","jW",".","x","-","lf",".","x",";","float","lt","=","lg",".","x","-","jW",".","x",";","if","(","!","kU",")","ls","=","jW",".","y","-","lf",".","y",";","if","(","!","kU",")","lt","=","lg",".","y","-","jW",".","y",";","bool","lu","=","(","li","<","0.0",")","!=","lo",
";","float","lv","=","(","lt","+","ls",")",";","bool","lw","=","(","lk","<","0.0",")","!=","lo",";","float","lx","=","1.0","/","lv",";","bool","ly","=","ls","<","lt",";","float","lz","=","min","(","ls",",","lt",")",";","bool","lA","=","ly","?","lu",":","lw",";","float","lB","=","ln","*","ln",";","float","lC","=","(","lz","*","(","-","lx",")",")","+","0.5",";","float","lD","=","lB","*","FXAA_QUALITY_SUBPIX",";","float","lE","=","lA","?","lC",":","0.0",";","float","lF","=","max","(","lE",",","lD",")",
";","if","(","!","kU",")","jW",".","x","+=","lF","*","kT",";","if","(","kU",")","jW",".","y","+=","lF","*","kT",";","return","texture2D","(","u_color",",","jW",")",";","}"]},{type:"define",name:"FXAA_CONSOLE_EDGE_SHARPNESS",tokens:["8.0"]},{type:"define",name:"FXAA_CONSOLE_EDGE_THRESHOLD",tokens:["0.125"]},{type:"define",name:"FXAA_CONSOLE_EDGE_THRESHOLD_MIN",tokens:["0.05"]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["AA_METHOD","==","AA_METHOD_PASS"],
group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","texture2D","(","u_color",",","a",")",";"]}]}},{type:"elif",expression:["AA_METHOD","==","AA_METHOD_FXAA_LIGHT"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","jV","(",")",";"]}]}},{type:"elif",expression:["AA_METHOD","==","AA_METHOD_FXAA_QUALITY"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","lG","(",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor",
"=","vec4","(","1.0",",","1.0",",","0.0",",","1.0",")","*","texture2D","(","u_color",",","a",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["postprocessing/bloom_blur.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","vec2","u_texel_size",";","uniform","sampler2D","u_color",";","varying","vec2","a",";","void","main","(",")","{","vec2","iz","=","vec2","(","0.0",",","0.0",")",";","vec2","iA","=","u_texel_size",";","vec4","iB",
"=","texture2D","(","u_color",",","a",")",";","gl_FragColor","=","iB","*","0.0875447373698",";","iz","+=","iA",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","iz",")","*","0.0858112354248",";","gl_FragColor","+=","texture2D","(","u_color",",","a","-","iz",")","*","0.0858112354248",";","iz","+=","iA",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","iz",")","*","0.0808139781061",";","gl_FragColor","+=","texture2D","(","u_color",",","a","-","iz",")","*","0.0808139781061",
";","iz","+=","iA",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","iz",")","*","0.0731235112908",";","gl_FragColor","+=","texture2D","(","u_color",",","a","-","iz",")","*","0.0731235112908",";","iz","+=","iA",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","iz",")","*","0.0635705267419",";","gl_FragColor","+=","texture2D","(","u_color",",","a","-","iz",")","*","0.0635705267419",";","iz","+=","iA",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","iz",")","*",
"0.0530985673112",";","gl_FragColor","+=","texture2D","(","u_color",",","a","-","iz",")","*","0.0530985673112",";","iz","+=","iA",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","iz",")","*","0.0426125984122",";","gl_FragColor","+=","texture2D","(","u_color",",","a","-","iz",")","*","0.0426125984122",";","iz","+=","iA",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","iz",")","*","0.0328565115809",";","gl_FragColor","+=","texture2D","(","u_color",",","a","-","iz",")","*",
"0.0328565115809",";","iz","+=","iA",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","iz",")","*","0.0243407024472",";","gl_FragColor","+=","texture2D","(","u_color",",","a","-","iz",")","*","0.0243407024472",";","gl_FragColor","=","max","(","0.7","*","iB",",","gl_FragColor",")",";","}"]}]},exports["postprocessing/bloom_combine.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_main",";","uniform","sampler2D",
"u_bloom",";","varying","vec2","a",";","void","main","(",")","{","vec4","iz","=","texture2D","(","u_main",",","a",")",";","vec4","iA","=","texture2D","(","u_bloom",",","a",")",";","vec4","iB","=","iz",";","iB","+=","iA",";","gl_FragColor","=","vec4","(","iB",".","rgb",",","1.0",")",";","}"]}]},exports["postprocessing/blur_depth.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_color",
";","uniform","sampler2D","u_depth",";","uniform","vec2","u_texel_size",";","uniform","vec2","u_camera_range",";","uniform","float","u_blur_depth_edge_size",";","uniform","float","u_blur_depth_diff_threshold",";","varying","vec2","a",";","float","kd","(","in","vec2","kc",")","{","return","kb","(","u_depth",",","kc",",","u_camera_range",")",";","}","void","main","(",")","{","vec2","ke","=","u_texel_size",";","vec4","kf","=","texture2D","(","u_color",",","a",")",";","float","kg","=","kd","(","a",")",
";","float","kh","=","kd","(","a","+","u_blur_depth_edge_size","*","ke",")",";","float","ki","=","kd","(","a","-","u_blur_depth_edge_size","*","ke",")",";","float","kj","=","abs","(","kg","-","kh",")",";","float","kk","=","abs","(","kg","-","ki",")",";","float","kl","=","max","(","kj",",","kk",")",";","if","(","kl",">","u_blur_depth_diff_threshold",")","{","gl_FragColor","=","kf",";","return",";","}","vec2","km","=","vec2","(","0.0",",","0.0",")",";","gl_FragColor","=","kf","*","0.2270270270",";",
"km","+=","ke",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","km",")","*","0.1945945946",",","gl_FragColor","+=","texture2D","(","u_color",",","a","-","km",")","*","0.1945945946",",","km","+=","ke",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","km",")","*","0.1216216216",",","gl_FragColor","+=","texture2D","(","u_color",",","a","-","km",")","*","0.1216216216",",","km","+=","ke",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","km",")","*","0.0540540541",
",","gl_FragColor","+=","texture2D","(","u_color",",","a","-","km",")","*","0.0540540541",",","km","+=","ke",";","gl_FragColor","+=","texture2D","(","u_color",",","a","+","km",")","*","0.0162162162",";","gl_FragColor","+=","texture2D","(","u_color",",","a","-","km",")","*","0.0162162162",";","}"]}]},exports["postprocessing/compositing.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"define",name:"PI_4",tokens:["0.785398163"]},{type:"textline",tokens:["uniform",
"sampler2D","u_color",";","uniform","float","u_brightness",";","uniform","float","u_contrast",";","uniform","float","u_exposure",";","uniform","float","u_saturation",";","varying","vec2","a",";","void","main","(",")","{","vec4","iz","=","texture2D","(","u_color",",","a",")",";","vec3","iA","=","iz",".","rgb",";","if","(","u_brightness","<","0.0",")","iA","=","iA","*","(","1.0","+","u_brightness",")",";","else","iA","=","iA","+","(","(","1.0","-","iA",")","*","u_brightness",")",";","iA","=","(","iA",
"-","0.5",")","*","(","tan","(","(","u_contrast","+","1.0",")","*","PI_4",")",")","+","0.5",";","iA","*=","u_exposure",";","vec3","iB","=","vec3","(","0.299",",","0.587",",","0.114",")",";","float","iC","=","dot","(","iA",",","iB",")",";","iA","=","mix","(","vec3","(","iC",")",",","iA",",","u_saturation",")",";","gl_FragColor","=","vec4","(","iA",",","iz",".","a",")",";","}"]}]},exports["postprocessing/depth_pack.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",
file:"pack.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_depth",";","uniform","vec2","u_camera_range",";","varying","vec2","a",";","void","main","(",")","{","gl_FragColor","=","cj","(","clamp","(","kb","(","u_depth",",","a",",","u_camera_range",")",",","0.0",",","0.999999",")",")",";","}"]}]},exports["postprocessing/dof.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"textline",
tokens:["uniform","sampler2D","u_sharp",";","uniform","sampler2D","u_blurred",";","uniform","sampler2D","u_depth",";","uniform","float","u_view_max_depth",";","uniform","float","u_dof_dist",";","uniform","float","u_dof_front",";","uniform","float","u_dof_rear",";","uniform","vec2","u_camera_range",";","varying","vec2","a",";","void","main","(",")","{","vec4","kc","=","texture2D","(","u_sharp",",","a",")",";","if","(","u_dof_dist",">","0.0",")","{","float","kd","=","kb","(","u_depth",",","a",",","u_camera_range",
")",";","kd","*=","u_view_max_depth",";","float","ke",";","if","(","kd","<","u_dof_dist",")","ke","=","(","u_dof_dist","-","kd",")","/","u_dof_front",";","else","ke","=","(","kd","-","u_dof_dist",")","/","u_dof_rear",";","ke","=","clamp","(","ke",",","0.0",",","1.0",")",";","vec4","kf","=","texture2D","(","u_blurred",",","a",")",";","gl_FragColor","=","mix","(","kc",",","kf",",","ke",")",";","}","else","gl_FragColor","=","kc",";","}"]}]},exports["postprocessing/edge.glslf"]={type:"group",parts:[{type:"include",
file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_sampler",";","uniform","vec2","u_texel_size",";","varying","vec2","a",";","float","iE","(","float","iz",",","float","iA",",","float","iB",")","{","vec2","iC","=","a","+","vec2","(","iz",",","iA",")","*","u_texel_size",";","vec4","iD","=","texture2D","(","u_sampler",",","iC",")","*","iB",";","return","cn","(","iD",")",";","}","void","main","(",")","{","float","iF","=","(","iE","(",
"-","1.0",",","-","1.0",",","-","1.0",")","+","iE","(","0.0",",","-","1.0",",","-","1.0",")","+","iE","(","1.0",",","-","1.0",",","-","1.0",")","+","iE","(","-","1.0",",","0.0",",","-","1.0",")","+","iE","(","0.0",",","0.0",",","8.0",")","+","iE","(","1.0",",","0.0",",","-","1.0",")","+","iE","(","-","1.0",",","1.0",",","-","1.0",")","+","iE","(","0.0",",","1.0",",","-","1.0",")","+","iE","(","1.0",",","1.0",",","-","1.0",")",")",";","iF","*=","1000.0",";","gl_FragColor","=","vec4","(","iF",",","iF",
",","iF",",","1.0",")",";","}"]}]},exports["postprocessing/glow.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_glow_src",";","uniform","sampler2D","u_glow_mask",";","uniform","sampler2D","u_glow_mask_blurred",";","uniform","vec3","u_glow_color",";","uniform","float","u_draw_glow",";","varying","vec2","a",";","void","main","(",")","{","vec4","iz","=","texture2D","(","u_glow_src",",",
"a",")",";","gl_FragColor","=","iz",";","if","(","u_draw_glow","!=","0.0",")","{","vec4","iA","=","texture2D","(","u_glow_mask",",","a",")",";","vec4","iB","=","texture2D","(","u_glow_mask_blurred",",","a",")",";","float","iC","=","iB",".","a","-","iA",".","a",";","if","(","iC","!=","0.0",")","{","float","iD","=","smoothstep","(","0.0",",","1.0",",","iB",".","a",")",";","if","(","iA",".","a","==","0.0",")","{","vec3","iE","=","u_glow_color",";","ed","(","iE",")",";","vec4","iF","=","vec4","(","clamp",
"(","iE",",","0.0",",","1.0",")",",","iD",")",";","gl_FragColor","=","mix","(","iz",",","iF",",","iD",")",";","}","}","}","}"]}]},exports["postprocessing/god_rays.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"include",file:"procedural.glslf"},{type:"var",name:"STEPS_PER_PASS",tokens:["0.0"]},{type:"textline",tokens:["uniform","float","u_time",";","uniform","float","u_radial_blur_step",";","uniform","vec3","u_sun_intensity",
";","uniform","sampler2D","u_input",";"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_camera_range",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","kc",";","varying","vec2","kd",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec2","a",";","varying","vec4","ke",";","void","main","(",")","{","vec3","kf","=","u_sun_intensity",
";","vec2","kg","=","(","ke",".","xy","-","a",")",";","float","kh","=","length","(","kg",")",";","vec2","ki","=","u_radial_blur_step","*","kg","/","kh",";","float","kj","=","kh","/","u_radial_blur_step",";","ki","*=","min","(","kj",",","STEPS_PER_PASS",")","/","STEPS_PER_PASS",";","kj","=","max","(","kj",",","STEPS_PER_PASS",")",";","vec2","kk","=","a",";","float","kl","=","0.0",";","for","(","float","km","=","0.0",";","km","<","STEPS_PER_PASS",";","km","+=","1.0",")","{","if","(","km","<=","kj",
")","{"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA"],group:{type:"group",parts:[{type:"textline",tokens:["float","kn","=","kb","(","u_input",",","kk",",","u_camera_range",")",";","kl","+=","(","1.0","-","pow","(","kh",",","0.3",")",")","*","step","(","0.9",",","kn",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["kl","+=","texture2D","(","u_input",",","kk",")",".","r",";"]}]}}]},{type:"textline",tokens:["}","kk","+=","ki",";","}"]},{type:"condition",
parts:[{type:"if",expression:["DEPTH_RGBA","&&","WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","ko","=","a","+","kd",";","float","kp","=","gT","(","vec2","(","2.5","*","(","ko",".","x",")",",","2.5","*","(","ko",".","y",")","+","1.0","*","u_time",")",")",".","x","+","0.75","*","gT","(","vec2","(","5.0","*","(","ko",".","x",")","-","0.66","*","u_time",",","5.0","*","(","ko",".","y",")","+","0.66","*","u_time",")",")",".","x","+","0.5","*","hx","(","vec2","(","7.5","*",
"(","ko",".","x",")","+","0.33","*","u_time",",","7.5","*","(","ko",".","y",")","-","0.33","*","u_time",")",")",";","kp","*=","clamp","(","1.2","-","sqrt","(","0.2","*","kh",")",",","0.0",",","1.0",")","*","kc",";","kl","=","max","(","kp",",","kl",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","kl","/","STEPS_PER_PASS","*","clamp","(","kf",",","0.4",",","0.8",")",",","1.0",")",";","}"]}]},exports["postprocessing/god_rays.glslv"]={type:"group",parts:[{type:"define",name:"LIGHT_INDEX",
tokens:["0"]},{type:"textline",tokens:["attribute","vec2","a_bb_vertex",";","uniform","mat4","u_view_matrix",";","uniform","mat4","u_proj_matrix",";","uniform","vec3","u_sun_direction",";"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_camera_quat",";","uniform",
"vec4","u_refl_plane",";","varying","float","kc",";","varying","vec2","kd",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec2","a",";","varying","vec4","ke",";","void","iG","(","in","vec4","iz",",","in","vec3","iA",",","out","vec3","iB",")","{","float","iC","=","iz",".","w","*","iA",".","x","+","iz",".","y","*","iA",".","z","-","iz",".","z","*","iA",".","y",";","float","iD","=","iz",".","w","*","iA",".","y","+","iz",".","z","*","iA",".","x","-","iz",".","x","*","iA",".","z",";","float","iE",
"=","iz",".","w","*","iA",".","z","+","iz",".","x","*","iA",".","y","-","iz",".","y","*","iA",".","x",";","float","iF","=","-","iz",".","x","*","iA",".","x","-","iz",".","y","*","iA",".","y","-","iz",".","z","*","iA",".","z",";","iB",".","x","=","iC","*","iz",".","w","-","iF","*","iz",".","x","-","iD","*","iz",".","z","+","iE","*","iz",".","y",";","iB",".","y","=","iD","*","iz",".","w","-","iF","*","iz",".","y","-","iE","*","iz",".","x","+","iC","*","iz",".","z",";","iB",".","z","=","iE","*","iz",
".","w","-","iF","*","iz",".","z","-","iC","*","iz",".","y","+","iD","*","iz",".","x",";","}","void","main","(",")","{","a","=","a_bb_vertex","+","0.5",";","vec3","iH","=","normalize","(","u_sun_direction",")",";","ke","=","u_proj_matrix","*","u_view_matrix","*","vec4","(","iH",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA","&&","WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","u_camera_eye",".","y","+","a_bb_vertex",".","t","<","-","u_refl_plane",
".","w",")","{","kc","=","1.0",";","vec3","iI","=","vec3","(","0.0",",","1.0",",","0.0",")",";","vec3","iJ",";","iG","(","u_camera_quat",",","iI",",","iJ",")",";","iJ","=","normalize","(","iJ",")",";","float","iK","=","dot","(","iJ",",","vec3","(","0.0",",","1.0",",","0.0",")",")",";","float","iL","=","atan","(","iJ",".","x",",","iJ",".","z",")",";","kd","=","vec2","(","-","iL",",","acos","(","iK",")",")",";","}","else","{","kc","=","0.0",";","}"]}]}}]},{type:"textline",tokens:["ke",".","x","/=",
"ke",".","w",";","ke",".","y","/=","ke",".","w",";","ke",".","x","=","0.5","*","(","ke",".","x","+","1.0",")",";","ke",".","y","=","0.5","*","(","ke",".","y","+","1.0",")",";","ke","+=","99999.0","*","step","(","ke",".","z",",","0.0",")",";","gl_Position","=","vec4","(","2.0","*","a_bb_vertex",".","xy",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/god_rays_combine.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"textline",
tokens:["uniform","sampler2D","u_main",";","uniform","sampler2D","u_god_rays",";","uniform","float","u_god_rays_intensity",";","varying","vec2","a",";","void","main","(",")","{","vec4","iz","=","texture2D","(","u_main",",","a",")",";","eb","(","iz",".","rgb",")",";","vec3","iA","=","iz",".","rgb","+","u_god_rays_intensity","*","(","texture2D","(","u_god_rays",",","a",")",")",".","rgb",";","ed","(","iA",")",";","gl_FragColor",".","rgb","=","iA",";","gl_FragColor",".","a","=","iz",".","a",";","}"]}]},
exports["postprocessing/lanczos.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","vec2","u_texel_size",";","uniform","sampler2D","u_color",";","varying","vec2","a",";","void","main","(",")","{","vec4","iz","=","texture2D","(","u_color",",","a",")","*","0.38026",";","iz","+=","texture2D","(","u_color",",","a","-","u_texel_size",")","*","0.27667",";","iz","+=","texture2D","(","u_color",",","a","+","u_texel_size",")","*","0.27667",";",
"iz","+=","texture2D","(","u_color",",","a","-","2.0","*","u_texel_size",")","*","0.08074",";","iz","+=","texture2D","(","u_color",",","a","+","2.0","*","u_texel_size",")","*","0.08074",";","iz","+=","texture2D","(","u_color",",","a","-","3.0","*","u_texel_size",")","*","-","0.02612",";","iz","+=","texture2D","(","u_color",",","a","+","3.0","*","u_texel_size",")","*","-","0.02612",";","iz","+=","texture2D","(","u_color",",","a","-","4.0","*","u_texel_size",")","*","-","0.02143",";","iz","+=","texture2D",
"(","u_color",",","a","+","4.0","*","u_texel_size",")","*","-","0.02143",";","gl_FragColor","=","iz",";","}"]}]},exports["postprocessing/luminance.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_input",";","varying","vec2","a",";","void","main","(",")","{","vec4","iz","=","texture2D","(","u_input",",","a",")",";","float","iA","=","dot","(","iz",".","rgb",",","vec3","(","0.2126",",","0.7152",",","0.0722",")",")",";","gl_FragColor",
"=","vec4","(","vec3","(","iA",")",",","1.0",")",";","}"]}]},exports["postprocessing/luminance_av.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_input",";","void","main","(",")","{","float","iz",";","float","iA","=","0.0",";","for","(","float","iB","=","0.025",";","iB","<","1.0",";","iB","+=","0.05",")","for","(","float","iC","=","0.025",";","iC","<","1.0",";","iC","+=","0.05",")","{","iz","=","max","(","texture2D",
"(","u_input",",","vec2","(","iB",",","iC",")",")",".","r",",","0.01",")",";","iA","+=","log","(","iz",")",";","}","float","iD","=","exp","(","iA","/","400.0",")",";","gl_FragColor","=","vec4","(","vec3","(","iD",")",",","1.0",")",";","}"]}]},exports["postprocessing/luminance_trunced.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_main",";","uniform","sampler2D","u_luminance",";","uniform","sampler2D","u_average_lum",
";","uniform","float","u_bloom_edge_lum",";","varying","vec2","a",";","varying","float","kf",";","void","main","(",")","{","float","kg","=","texture2D","(","u_average_lum",",","vec2","(","0.5",")",")",".","r",";","float","kh","=","texture2D","(","u_luminance",",","a",")",".","r",";","vec4","ki","=","texture2D","(","u_main",",","a",")",";","float","kj","=","kh","/","kg",";","float","kk","=","u_bloom_edge_lum",";","gl_FragColor","=","ki","*","max","(","kj","-","kk",",","0.0",")","*","kf",";","}"]}]},
exports["postprocessing/luminance_trunced.glslv"]={type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_bb_vertex",";","uniform","vec4","u_camera_quat",";","uniform","vec3","u_sun_direction",";","uniform","float","u_bloom_key",";","varying","vec2","a",";","varying","float","kf",";","const","vec3","iz","=","vec3","(","0.0",",","1.0",",","0.0",")",";","void","iH","(","in","vec4","iA",",","in","vec3","iB",",","out","vec3","iC",")","{","float","iD","=","iA",".","w","*","iB",".","x","+",
"iA",".","y","*","iB",".","z","-","iA",".","z","*","iB",".","y",";","float","iE","=","iA",".","w","*","iB",".","y","+","iA",".","z","*","iB",".","x","-","iA",".","x","*","iB",".","z",";","float","iF","=","iA",".","w","*","iB",".","z","+","iA",".","x","*","iB",".","y","-","iA",".","y","*","iB",".","x",";","float","iG","=","-","iA",".","x","*","iB",".","x","-","iA",".","y","*","iB",".","y","-","iA",".","z","*","iB",".","z",";","iC",".","x","=","iD","*","iA",".","w","-","iG","*","iA",".","x","-","iE",
"*","iA",".","z","+","iF","*","iA",".","y",";","iC",".","y","=","iE","*","iA",".","w","-","iG","*","iA",".","y","-","iF","*","iA",".","x","+","iD","*","iA",".","z",";","iC",".","z","=","iF","*","iA",".","w","-","iG","*","iA",".","z","-","iD","*","iA",".","y","+","iE","*","iA",".","x",";","}","void","main","(",")","{","a","=","a_bb_vertex","+","0.5",";","vec3","iI",";","iH","(","u_camera_quat",",","iz",",","iI",")",";","kf","=","dot","(","-","iI",",","u_sun_direction",")","*","u_bloom_key",";","kf",
"*=","max","(","sign","(","u_sun_direction",".","y",")",",","0.0",")",";","gl_Position","=","vec4","(","2.0","*","a_bb_vertex",".","xy",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/motion_blur.glslf"]={type:"group",parts:[{type:"var",name:"BLUR_DECAY_THRESHOLD",tokens:["0.0"]},{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_mb_tex_curr",";","uniform","sampler2D","u_mb_tex_accum",";","uniform","float","u_motion_blur_exp",";","varying",
"vec2","a",";","void","main","(",")","{","vec4","iz","=","texture2D","(","u_mb_tex_curr",",","a",")",";","vec4","iA","=","texture2D","(","u_mb_tex_accum",",","a",")",";","if","(","length","(","iz","-","iA",")",">","BLUR_DECAY_THRESHOLD",")","{","gl_FragColor","=","(","1.0","-","u_motion_blur_exp",")","*","iz","+","u_motion_blur_exp","*","iA",";","}","else","{","gl_FragColor","=","iz",";","}","}"]}]},exports["postprocessing/postprocessing.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},
{type:"define",name:"POST_EFFECT_NONE",tokens:["1"]},{type:"define",name:"POST_EFFECT_GRAYSCALE",tokens:["2"]},{type:"define",name:"POST_EFFECT_X_BLUR",tokens:["3"]},{type:"define",name:"POST_EFFECT_Y_BLUR",tokens:["4"]},{type:"define",name:"POST_EFFECT_X_EXTEND",tokens:["5"]},{type:"define",name:"POST_EFFECT_Y_EXTEND",tokens:["6"]},{type:"textline",tokens:["uniform","vec2","u_texel_size",";","uniform","sampler2D","u_color",";","varying","vec2","a",";","void","main","(",")","{"]},{type:"condition",
parts:[{type:"if",expression:["POST_EFFECT","==","POST_EFFECT_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","texture2D","(","u_color",",","a",")",";"]}]}},{type:"elif",expression:["POST_EFFECT","==","POST_EFFECT_GRAYSCALE"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","iz","=","texture2D","(","u_color",",","a",")",";","gl_FragColor",".","rgb","=","vec3","(","(","iz",".","r","+","iz",".","g","+","iz",".","b",")","/","3.0",")",";","gl_FragColor",".","a",
"=","1.0",";"]}]}},{type:"elif",expression:["POST_EFFECT","==","POST_EFFECT_X_BLUR","||","POST_EFFECT","==","POST_EFFECT_Y_BLUR"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","iA","=","vec2","(","0.0",",","0.0",")",";","vec2","iB","=","u_texel_size",";","vec4","iC",";","iC","=","texture2D","(","u_color",",","a",")",";","gl_FragColor","=","iC","*","0.2270270270",";","iA","+=","iB",";","iC","=","texture2D","(","u_color",",","a","+","iA",")",";","gl_FragColor","+=","iC","*","0.1945945946",
";","iC","=","texture2D","(","u_color",",","a","-","iA",")",";","gl_FragColor","+=","iC","*","0.1945945946",";","iA","+=","iB",";","iC","=","texture2D","(","u_color",",","a","+","iA",")",";","gl_FragColor","+=","iC","*","0.1216216216",";","iC","=","texture2D","(","u_color",",","a","-","iA",")",";","gl_FragColor","+=","iC","*","0.1216216216",";","iA","+=","iB",";","iC","=","texture2D","(","u_color",",","a","+","iA",")",";","gl_FragColor","+=","iC","*","0.0540540541",";","iC","=","texture2D","(","u_color",
",","a","-","iA",")",";","gl_FragColor","+=","iC","*","0.0540540541",";","iA","+=","iB",";","iC","=","texture2D","(","u_color",",","a","+","iA",")",";","gl_FragColor","+=","iC","*","0.0162162162",";","iC","=","texture2D","(","u_color",",","a","-","iA",")",";","gl_FragColor","+=","iC","*","0.0162162162",";"]}]}},{type:"elif",expression:["POST_EFFECT","==","POST_EFFECT_X_EXTEND","||","POST_EFFECT","==","POST_EFFECT_Y_EXTEND"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","iB","=","u_texel_size",
";","vec4","iC","=","texture2D","(","u_color",",","a",")",";","gl_FragColor","=","iC",";","if","(","iC",".","a","==","0.0",")","{","iC","=","texture2D","(","u_color",",","a","+","iB",")",";","if","(","iC",".","a",">","0.0",")","gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","iC",".","a",")",";","else","{","iC","=","texture2D","(","u_color",",","a","-","iB",")",";","if","(","iC",".","a",">","0.0",")","gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","iC",".","a",")",";","}","}"]}]}}]},
{type:"textline",tokens:["}"]}]},exports["postprocessing/postprocessing.glslv"]={type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_bb_vertex",";","varying","vec2","a",";","void","main","(",")","{","a","=","a_bb_vertex","+","0.5",";","gl_Position","=","vec4","(","2.0","*","a_bb_vertex",".","xy",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/smaa.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"gamma.glslf"},{type:"define",
name:"SMAA_RESOLVE",tokens:["1"]},{type:"define",name:"SMAA_EDGE_DETECTION",tokens:["2"]},{type:"define",name:"SMAA_BLENDING_WEIGHT_CALCULATION",tokens:["3"]},{type:"define",name:"SMAA_NEIGHBORHOOD_BLENDING",tokens:["4"]},{type:"define",name:"AA_METHOD_SMAA_LOW",tokens:["1"]},{type:"define",name:"AA_METHOD_SMAA_MEDIUM",tokens:["2"]},{type:"define",name:"AA_METHOD_SMAA_HIGH",tokens:["3"]},{type:"define",name:"AA_METHOD_SMAA_ULTRA",tokens:["4"]},{type:"textline",tokens:["uniform","sampler2D","u_color",
";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_RESOLVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_color_prev",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_NEIGHBORHOOD_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_blend",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"sampler2D","u_velocity_tex",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_EDGE_DETECTION","&&","SMAA_PREDICATION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_predication_tex",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_BLENDING_WEIGHT_CALCULATION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_search_tex",";","uniform","sampler2D","u_area_tex",";"]}]}}]},{type:"textline",
tokens:["uniform","vec2","u_texel_size",";","varying","vec2","a",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_NEIGHBORHOOD_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","kg",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","kg","[","3","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_BLENDING_WEIGHT_CALCULATION"],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec2","kh",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["AA_METHOD","==","AA_METHOD_SMAA_LOW"],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.15"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["1"]},{type:"define",name:"SMAA_DISABLE_CORNER_DETECTION",tokens:["1"]}]}},{type:"elif",expression:["AA_METHOD","==","AA_METHOD_SMAA_MEDIUM"],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.1"]},{type:"define",
name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["1"]},{type:"define",name:"SMAA_DISABLE_CORNER_DETECTION",tokens:["1"]}]}},{type:"elif",expression:["AA_METHOD","==","AA_METHOD_SMAA_HIGH"],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.1"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["0"]},{type:"define",name:"SMAA_MAX_SEARCH_STEPS_DIAG",tokens:["8"]},{type:"define",name:"SMAA_CORNER_ROUNDING",tokens:["25"]}]}},{type:"elif",expression:["AA_METHOD","==","AA_METHOD_SMAA_ULTRA"],
group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.05"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["0"]},{type:"define",name:"SMAA_MAX_SEARCH_STEPS_DIAG",tokens:["16"]},{type:"define",name:"SMAA_CORNER_ROUNDING",tokens:["25"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_THRESHOLD",group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.1"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_DEPTH_THRESHOLD",group:{type:"group",
parts:[{type:"define",name:"SMAA_DEPTH_THRESHOLD",tokens:["(","0.1","*","SMAA_THRESHOLD",")"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_MAX_SEARCH_STEPS_DIAG",group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS_DIAG",tokens:["8"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_CORNER_ROUNDING",group:{type:"group",parts:[{type:"define",name:"SMAA_CORNER_ROUNDING",tokens:["25"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR",
group:{type:"group",parts:[{type:"define",name:"SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR",tokens:["2.0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION_THRESHOLD",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION_THRESHOLD",tokens:["0.01"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION_SCALE",group:{type:"group",
parts:[{type:"define",name:"SMAA_PREDICATION_SCALE",tokens:["2.0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION_STRENGTH",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION_STRENGTH",tokens:["0.4"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_REPROJECTION",group:{type:"group",parts:[{type:"define",name:"SMAA_REPROJECTION",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_REPROJECTION_WEIGHT_SCALE",group:{type:"group",parts:[{type:"define",
name:"SMAA_REPROJECTION_WEIGHT_SCALE",tokens:["30.0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_MAX_SEARCH_STEPS",group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["16"]}]}}]},{type:"define",name:"SMAA_AREATEX_MAX_DISTANCE",tokens:["16"]},{type:"define",name:"SMAA_AREATEX_MAX_DISTANCE_DIAG",tokens:["20"]},{type:"define",name:"SMAA_AREATEX_PIXEL_SIZE",tokens:["(","1.0","/","vec2","(","160.0",",","560.0",")",")"]},{type:"define",name:"SMAA_AREATEX_SUBTEX_SIZE",
tokens:["(","1.0","/","7.0",")"]},{type:"define",name:"SMAA_SEARCHTEX_SIZE",tokens:["vec2","(","66.0",",","33.0",")"]},{type:"define",name:"SMAA_SEARCHTEX_PACKED_SIZE",tokens:["vec2","(","64.0",",","16.0",")"]},{type:"define",name:"SMAA_CORNER_ROUNDING_NORM",tokens:["(","float","(","SMAA_CORNER_ROUNDING",")","/","100.0",")"]},{type:"textline",tokens:["vec3","ko","(","vec2","ki",",","vec4","kj","[","3","]",",","sampler2D","kk",")","{","float","kl","=","texture2D","(","kk",",","ki",")",".","r",";",
"float","km","=","texture2D","(","kk",",","kj","[","0","]",".","xy",")",".","r",";","float","kn","=","texture2D","(","kk",",","kj","[","0","]",".","zw",")",".","r",";","return","vec3","(","kl",",","km",",","kn",")",";","}","vec2","kv","(","vec2","kp",",","vec4","kq","[","3","]",",","sampler2D","kr",")","{","vec3","ks","=","ko","(","kp",",","kq",",","kr",")",";","vec2","kt","=","abs","(","ks",".","xx","-","ks",".","yz",")",";","vec2","ku","=","step","(","SMAA_PREDICATION_THRESHOLD",",","kt",")",";",
"return","SMAA_PREDICATION_SCALE","*","SMAA_THRESHOLD","*","(","1.0","-","SMAA_PREDICATION_STRENGTH","*","ku",")",";","}","void","kz","(","bvec2","kw",",","inout","vec2","kx",",","vec2","ky",")","{","if","(","kw",".","x",")","kx",".","x","=","ky",".","x",";","if","(","kw",".","y",")","kx",".","y","=","ky",".","y",";","}","void","kz","(","bvec4","kA",",","inout","vec4","kB",",","vec4","kC",")","{","kz","(","kA",".","xy",",","kB",".","xy",",","kC",".","xy",")",";","kz","(","kA",".","zw",",","kB",".",
"zw",",","kC",".","zw",")",";","}","vec2","kE","(","vec2","kD",")","{","return","sign","(","kD",")","*","floor","(","abs","(","kD",")","+",".5",")",";","}","vec4","kE","(","vec4","kF",")","{","return","sign","(","kF",")","*","floor","(","abs","(","kF",")","+",".5",")",";","}","vec2","kX","(","vec2","kG",",","vec4","kH","[","3","]",",","sampler2D","kI"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PREDICATION"],group:{type:"group",parts:[{type:"textline",tokens:[",","sampler2D","kJ"]}]}}]},
{type:"textline",tokens:[")","{"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PREDICATION"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","kK","=","kv","(","kG",",","kH",",","kJ",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec2","kK","=","vec2","(","SMAA_THRESHOLD",",","SMAA_THRESHOLD",")",";"]}]}}]},{type:"textline",tokens:["vec3","kL","=","vec3","(","0.2126",",","0.7152",",","0.0722",")",";","float","kM","=","dot","(","texture2D","(","kI",
",","kG",")",".","rgb",",","kL",")",";","float","kN","=","dot","(","texture2D","(","kI",",","kH","[","0","]",".","xy",")",".","rgb",",","kL",")",";","float","kO","=","dot","(","texture2D","(","kI",",","kH","[","0","]",".","zw",")",".","rgb",",","kL",")",";","vec4","kP",";","kP",".","xy","=","abs","(","kM","-","vec2","(","kN",",","kO",")",")",";","vec2","kQ","=","step","(","kK",",","kP",".","xy",")",";","if","(","dot","(","kQ",",","vec2","(","1.0",",","1.0",")",")","==","0.0",")","discard",";","float",
"kR","=","dot","(","texture2D","(","kI",",","kH","[","1","]",".","xy",")",".","rgb",",","kL",")",";","float","kS","=","dot","(","texture2D","(","kI",",","kH","[","1","]",".","zw",")",".","rgb",",","kL",")",";","kP",".","zw","=","abs","(","kM","-","vec2","(","kR",",","kS",")",")",";","vec2","kT","=","max","(","kP",".","xy",",","kP",".","zw",")",";","float","kU","=","dot","(","texture2D","(","kI",",","kH","[","2","]",".","xy",")",".","rgb",",","kL",")",";","float","kV","=","dot","(","texture2D","(",
"kI",",","kH","[","2","]",".","zw",")",".","rgb",",","kL",")",";","kP",".","zw","=","abs","(","vec2","(","kN",",","kO",")","-","vec2","(","kU",",","kV",")",")",";","kT","=","max","(","kT",".","xy",",","kP",".","zw",")",";","float","kW","=","max","(","kT",".","x",",","kT",".","y",")",";","kQ",".","xy","*=","step","(","kW",",","SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR","*","kP",".","xy",")",";","return","kQ",";","}"]},{type:"condition",parts:[{type:"if",expression:["!","SMAA_DISABLE_DIAG_DETECTION"],group:{type:"group",
parts:[{type:"textline",tokens:["vec2","kZ","(","vec2","kY",")","{","kY",".","r","=","kY",".","r","*","abs","(","5.0","*","kY",".","r","-","5.0","*","0.75",")",";","return","kE","(","kY",")",";","}","vec4","kZ","(","vec4","k_",")","{","k_",".","rb","=","k_",".","rb","*","abs","(","5.0","*","k_",".","rb","-","5.0","*","0.75",")",";","return","kE","(","k_",")",";","}","vec2","lh","(","sampler2D","la",",","vec2","lb",",","vec2","lc",",","out","vec2","ld",")","{","vec4","le","=","vec4","(","lb",",","-",
"1.0",",","1.0",")",";","vec3","lf","=","vec3","(","u_texel_size",",","1.0",")",";","for","(","int","lg","=","0",";","lg","<","SMAA_MAX_SEARCH_STEPS_DIAG",";","lg","++",")","{","if","(","le",".","z","<","float","(","SMAA_MAX_SEARCH_STEPS_DIAG","-","1",")","&&","le",".","w",">","0.9",")","{","le",".","xyz","+=","lf","*","vec3","(","lc",",","1.0",")",";","ld","=","texture2D","(","la",",","le",".","xy",",","0.0",")",".","rg",";","le",".","w","=","dot","(","ld",",","vec2","(","0.5",",","0.5",")",")",
";","}","}","return","le",".","zw",";","}","vec2","lp","(","sampler2D","li",",","vec2","lj",",","vec2","lk",",","out","vec2","ll",")","{","vec4","lm","=","vec4","(","lj",",","-","1.0",",","1.0",")",";","lm",".","x","+=","0.25","*","u_texel_size",".","x",";","vec3","ln","=","vec3","(","u_texel_size",",","1.0",")",";","for","(","int","lo","=","0",";","lo","<","SMAA_MAX_SEARCH_STEPS_DIAG",";","lo","++",")","{","if","(","lm",".","z","<","float","(","SMAA_MAX_SEARCH_STEPS_DIAG","-","1",")","&&","lm",".",
"w",">","0.9",")","{","lm",".","xyz","=","ln","*","vec3","(","lk",",","1.0",")","+","lm",".","xyz",";","ll","=","texture2D","(","li",",","lm",".","xy",",","0.0",")",".","rg",";","ll","=","kZ","(","ll",")",";","lm",".","w","=","dot","(","ll",",","vec2","(","0.5",",","0.5",")",")",";","}","}","return","lm",".","zw",";","}","vec2","lv","(","sampler2D","lq",",","vec2","lr",",","vec2","ls",",","float","lt",")","{","vec2","lu","=","vec2","(","SMAA_AREATEX_MAX_DISTANCE_DIAG",",","SMAA_AREATEX_MAX_DISTANCE_DIAG",
")","*","ls","+","lr",";","lu","=","SMAA_AREATEX_PIXEL_SIZE","*","lu","+","0.5","*","SMAA_AREATEX_PIXEL_SIZE",";","lu",".","x","+=","0.5",";","lu",".","y","+=","SMAA_AREATEX_SUBTEX_SIZE","*","lt",";","return","texture2D","(","lq",",","lu",",","0.0",")",".","rg",";","}","vec2","lK","(","sampler2D","lw",",","sampler2D","lx",",","vec2","ly",",","vec2","lz",",","vec4","lA",")","{","vec2","lB","=","vec2","(","0.0",",","0.0",")",";","vec4","lC",";","vec2","lD",";","if","(","lz",".","r",">","0.0",")","{",
"lC",".","xz","=","lh","(","lw",",","ly",",","vec2","(","-","1.0",",","1.0",")",",","lD",")",";","lC",".","x","+=","float","(","lD",".","y",">","0.9",")",";","}","else","lC",".","xz","=","vec2","(","0.0",",","0.0",")",";","lC",".","yw","=","lh","(","lw",",","ly",",","vec2","(","1.0",",","-","1.0",")",",","lD",")",";","if","(","lC",".","x","+","lC",".","y",">","2.0",")","{","vec4","lE","=","vec4","(","-","lC",".","x","+","0.25",",","lC",".","x",",","lC",".","y",",","-","lC",".","y","-","0.25",")",
"*","u_texel_size",".","xyxy","+","ly",".","xyxy",";","vec4","lF",";","lF",".","xy","=","texture2D","(","lw",",","lE",".","xy","+","u_texel_size","*","vec2","(","-","1",",","0",")",",","0.0",")",".","rg",";","lF",".","zw","=","texture2D","(","lw",",","lE",".","zw","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","rg",";","lF",".","yxwz","=","kZ","(","lF",".","xyzw",")",";","vec2","lG","=","vec2","(","2.0",",","2.0",")","*","lF",".","xz","+","lF",".","yw",";","kz","(","bvec2","(",
"step","(","0.9",",","lC",".","zw",")",")",",","lG",",","vec2","(","0.0",",","0.0",")",")",";","lB","+=","lv","(","lx",",","lC",".","xy",",","lG",",","lA",".","z",")",";","}","lC",".","xz","=","lp","(","lw",",","ly",",","vec2","(","-","1",",","-","1",")",",","lD",")",";","if","(","texture2D","(","lw",",","ly","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","r",">","0.0",")","{","lC",".","yw","=","lp","(","lw",",","ly",",","vec2","(","1",",","1",")",",","lD",")",";","lC",".","y",
"+=","float","(","lD",".","y",">","0.9",")",";","}","else","lC",".","yw","=","vec2","(","0.0",",","0.0",")",";","if","(","lC",".","x","+","lC",".","y",">","2.0",")","{","vec4","lH","=","vec4","(","-","lC",".","x",",","-","lC",".","x",",","lC",".","y",",","lC",".","y",")","*","u_texel_size",".","xyxy","+","ly",".","xyxy",";","vec4","lI",";","lI",".","x","=","texture2D","(","lw",",","lH",".","xy","+","u_texel_size","*","vec2","(","-","1",",","0",")",",","0.0",")",".","g",";","lI",".","y","=","texture2D",
"(","lw",",","lH",".","xy","+","u_texel_size","*","vec2","(","0",",","-","1",")",",","0.0",")",".","r",";","lI",".","zw","=","texture2D","(","lw",",","lH",".","zw","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","gr",";","vec2","lJ","=","vec2","(","2.0",",","2.0",")","*","lI",".","xz","+","lI",".","yw",";","kz","(","bvec2","(","step","(","0.9",",","lC",".","zw",")",")",",","lJ",",","vec2","(","0",",","0",")",")",";","lB","+=","lv","(","lx",",","lC",".","xy",",","lJ",",","lA",".",
"w",")",".","gr",";","}","return","lB",";","}"]}]}}]},{type:"textline",tokens:["float","lQ","(","sampler2D","lL",",","vec2","lM",",","float","lN",")","{","vec2","lO","=","SMAA_SEARCHTEX_SIZE","*","vec2","(","0.5",",","-","1.0",")",";","vec2","lP","=","SMAA_SEARCHTEX_SIZE","*","vec2","(","lN",",","1.0",")",";","lO","+=","vec2","(","-","1.0",",","1.0",")",";","lP","+=","vec2","(","0.5",",","-","0.5",")",";","lO","*=","1.0","/","SMAA_SEARCHTEX_PACKED_SIZE",";","lP","*=","1.0","/","SMAA_SEARCHTEX_PACKED_SIZE",
";","return","texture2D","(","lL",",","lO","*","lM","+","lP",",","0.0",")",".","r",";","}","float","lY","(","sampler2D","lR",",","sampler2D","lS",",","vec2","lT",",","float","lU",")","{","vec2","lV","=","vec2","(","0.0",",","1.0",")",";","for","(","int","lW","=","0",";","lW","<","SMAA_MAX_SEARCH_STEPS",";","lW","++",")","{","if","(","lT",".","x",">","lU","&&","lV",".","g",">","0.8281","&&","lV",".","r","==","0.0",")","{","lV","=","texture2D","(","lR",",","lT",",","0.0",")",".","rg",";","lT","=","-",
"vec2","(","2.0",",","0.0",")","*","u_texel_size","+","lT",";","}","}","float","lX","=","-","(","255.0","/","127.0",")","*","lQ","(","lS",",","lV",",","0.0",")","+","3.25",";","return","u_texel_size",".","x","*","lX","+","lT",".","x",";","}","float","mf","(","sampler2D","lZ",",","sampler2D","l_",",","vec2","ma",",","float","mb",")","{","vec2","mc","=","vec2","(","0.0",",","1.0",")",";","for","(","int","md","=","0",";","md","<","SMAA_MAX_SEARCH_STEPS",";","md","++",")","{","if","(","ma",".","x","<",
"mb","&&","mc",".","g",">","0.8281","&&","mc",".","r","==","0.0",")","{","mc","=","texture2D","(","lZ",",","ma",",","0.0",")",".","rg",";","ma","=","vec2","(","2.0",",","0.0",")","*","u_texel_size","+","ma",";","}","}","float","me","=","-","(","255.0","/","127.0",")","*","lQ","(","l_",",","mc",",","0.5",")","+","3.25",";","return","-","u_texel_size",".","x","*","me","+","ma",".","x",";","}","float","mn","(","sampler2D","mg",",","sampler2D","mh",",","vec2","mi",",","float","mj",")","{","vec2","mk",
"=","vec2","(","1.0",",","0.0",")",";","for","(","int","ml","=","0",";","ml","<","SMAA_MAX_SEARCH_STEPS",";","ml","++",")","{","if","(","mi",".","y",">","mj","&&","mk",".","r",">","0.8281","&&","mk",".","g","==","0.0",")","{","mk","=","texture2D","(","mg",",","mi",",","0.0",")",".","rg",";","mi","=","-","vec2","(","0.0",",","2.0",")","*","u_texel_size","+","mi",";","}","}","float","mm","=","-","(","255.0","/","127.0",")","*","lQ","(","mh",",","mk",".","gr",",","0.0",")","+","3.25",";","return","u_texel_size",
".","y","*","mm","+","mi",".","y",";","}","float","mv","(","sampler2D","mo",",","sampler2D","mp",",","vec2","mq",",","float","mr",")","{","vec2","ms","=","vec2","(","1.0",",","0.0",")",";","for","(","int","mt","=","0",";","mt","<","SMAA_MAX_SEARCH_STEPS",";","mt","++",")","{","if","(","mq",".","y","<","mr","&&","ms",".","r",">","0.8281","&&","ms",".","g","==","0.0",")","{","ms","=","texture2D","(","mo",",","mq",",","0.0",")",".","rg",";","mq","=","vec2","(","0.0",",","2.0",")","*","u_texel_size",
"+","mq",";","}","}","float","mu","=","-","(","255.0","/","127.0",")","*","lQ","(","mp",",","ms",".","gr",",","0.5",")","+","3.25",";","return","-","u_texel_size",".","y","*","mu","+","mq",".","y",";","}","vec2","mC","(","sampler2D","mw",",","vec2","mx",",","float","my",",","float","mz",",","float","mA",")","{","vec2","mB","=","vec2","(","SMAA_AREATEX_MAX_DISTANCE",",","SMAA_AREATEX_MAX_DISTANCE",")","*","kE","(","4.0","*","vec2","(","my",",","mz",")",")","+","mx",";","mB","=","SMAA_AREATEX_PIXEL_SIZE",
"*","mB","+","0.5","*","SMAA_AREATEX_PIXEL_SIZE",";","mB",".","y","=","SMAA_AREATEX_SUBTEX_SIZE","*","mA","+","mB",".","y",";","return","texture2D","(","mw",",","mB",",","0.0",")",".","rg",";","}","void","mK","(","sampler2D","mD",",","inout","vec2","mE",",","vec4","mF",",","vec2","mG",")","{"]},{type:"condition",parts:[{type:"if",expression:["!","SMAA_DISABLE_CORNER_DETECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","mH","=","step","(","mG",".","xy",",","mG",".","yx",")",";","vec2",
"mI","=","(","1.0","-","SMAA_CORNER_ROUNDING_NORM",")","*","mH",";","mI","/=","mH",".","x","+","mH",".","y",";","vec2","mJ","=","vec2","(","1.0",",","1.0",")",";","mJ",".","x","-=","mI",".","x","*","texture2D","(","mD",",","mF",".","xy","+","u_texel_size","*","vec2","(","0",",","1",")",",","0.0",")",".","r",";","mJ",".","x","-=","mI",".","y","*","texture2D","(","mD",",","mF",".","zw","+","u_texel_size","*","vec2","(","1",",","1",")",",","0.0",")",".","r",";","mJ",".","y","-=","mI",".","x","*","texture2D",
"(","mD",",","mF",".","xy","+","u_texel_size","*","vec2","(","0",",","-","2",")",",","0.0",")",".","r",";","mJ",".","y","-=","mI",".","y","*","texture2D","(","mD",",","mF",".","zw","+","u_texel_size","*","vec2","(","1",",","-","2",")",",","0.0",")",".","r",";","mE","*=","clamp","(","mJ",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}","void","mS","(","sampler2D","mL",",","inout","vec2","mM",",","vec4","mN",",","vec2","mO",")","{"]},{type:"condition",parts:[{type:"if",expression:["!",
"SMAA_DISABLE_CORNER_DETECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","mP","=","step","(","mO",".","xy",",","mO",".","yx",")",";","vec2","mQ","=","(","1.0","-","SMAA_CORNER_ROUNDING_NORM",")","*","mP",";","mQ","/=","mP",".","x","+","mP",".","y",";","vec2","mR","=","vec2","(","1.0",",","1.0",")",";","mR",".","x","-=","mQ",".","x","*","texture2D","(","mL",",","mN",".","xy","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","g",";","mR",".","x","-=","mQ",".","y",
"*","texture2D","(","mL",",","mN",".","zw","+","u_texel_size","*","vec2","(","1",",","1",")",",","0.0",")",".","g",";","mR",".","y","-=","mQ",".","x","*","texture2D","(","mL",",","mN",".","xy","+","u_texel_size","*","vec2","(","-","2",",","0",")",",","0.0",")",".","g",";","mR",".","y","-=","mQ",".","y","*","texture2D","(","mL",",","mN",".","zw","+","u_texel_size","*","vec2","(","-","2",",","1",")",",","0.0",")",".","g",";","mM","*=","clamp","(","mR",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",
tokens:["}","vec4","nl","(","vec2","mT",",","vec2","mU",",","vec4","mV","[","3","]",",","sampler2D","mW",",","sampler2D","mX",",","sampler2D","mY",",","vec4","mZ",")","{","vec4","m_","=","vec4","(","0.0",",","0.0",",","0.0",",","0.0",")",";","vec2","na","=","texture2D","(","mW",",","mT",")",".","rg",";","if","(","na",".","g",">","0.0",")","{"]},{type:"condition",parts:[{type:"if",expression:["!","SMAA_DISABLE_DIAG_DETECTION"],group:{type:"group",parts:[{type:"textline",tokens:["m_",".","rg","=","lK",
"(","mW",",","mX",",","mT",",","na",",","mZ",")",";","if","(","m_",".","r","==","-","m_",".","g",")","{"]}]}}]},{type:"textline",tokens:["vec2","nb",";","vec3","nc",";","nc",".","x","=","lY","(","mW",",","mY",",","mV","[","0","]",".","xy",",","mV","[","2","]",".","x",")",";","nc",".","y","=","mV","[","1","]",".","y",";","nb",".","x","=","nc",".","x",";","float","nd","=","texture2D","(","mW",",","nc",".","xy",",","0.0",")",".","r",";","nc",".","z","=","mf","(","mW",",","mY",",","mV","[","0","]",".",
"zw",",","mV","[","2","]",".","y",")",";","nb",".","y","=","nc",".","z",";","nb","=","abs","(","kE","(","nb","/","u_texel_size",".","xx","-","mU",".","xx",")",")",";","vec2","ne","=","sqrt","(","nb",")",";","float","nf","=","texture2D","(","mW",",","nc",".","zy","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","r",";","m_",".","rg","=","mC","(","mX",",","ne",",","nd",",","nf",",","mZ",".","y",")",";","nc",".","y","=","mT",".","y",";","mK","(","mW",",","m_",".","rg",",","nc",".",
"xyzy",",","nb",")",";"]},{type:"condition",parts:[{type:"if",expression:["!","SMAA_DISABLE_DIAG_DETECTION"],group:{type:"group",parts:[{type:"textline",tokens:["}","else","na",".","r","=","0.0",";"]}]}}]},{type:"textline",tokens:["}","if","(","na",".","r",">","0.0",")","{","vec2","ng",";","vec3","nh",";","nh",".","y","=","mn","(","mW",",","mY",",","mV","[","1","]",".","xy",",","mV","[","2","]",".","z",")",";","nh",".","x","=","mV","[","0","]",".","x",";","ng",".","x","=","nh",".","y",";","float",
"ni","=","texture2D","(","mW",",","nh",".","xy",",","0.0",")",".","g",";","nh",".","z","=","mv","(","mW",",","mY",",","mV","[","1","]",".","zw",",","mV","[","2","]",".","w",")",";","ng",".","y","=","nh",".","z",";","ng","=","abs","(","kE","(","ng","/","u_texel_size",".","yy","-","mU",".","yy",")",")",";","vec2","nj","=","sqrt","(","ng",")",";","float","nk","=","texture2D","(","mW",",","nh",".","xz","+","u_texel_size","*","vec2","(","0",",","1",")",",","0.0",")",".","g",";","m_",".","ba","=","mC",
"(","mX",",","nj",",","ni",",","nk",",","mZ",".","x",")",";","nh",".","x","=","mT",".","x",";","mS","(","mW",",","m_",".","ba",",","nh",".","xyxz",",","ng",")",";","}","return","m_",";","}","vec4","nA","(","vec2","nm",",","vec4","nn",",","sampler2D","no",",","sampler2D","np"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","sampler2D","nq"]}]}}]},{type:"textline",tokens:[")","{","vec4","nr",";","nr",".","x","=","texture2D",
"(","np",",","nn",".","xy",")",".","a",";","nr",".","y","=","texture2D","(","np",",","nn",".","zw",")",".","g",";","nr",".","wz","=","texture2D","(","np",",","nm",")",".","xz",";","if","(","dot","(","nr",",","vec4","(","1.0",",","1.0",",","1.0",",","1.0",")",")","<","1e-5",")","{","vec4","ns","=","texture2D","(","no",",","nm",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","nt","=","2.0","*","texture2D",
"(","nq",",","nm",")",".","rg","-","1.0",";","if","(","ns",".","a","!=","0.0",")","ns",".","a","=","sqrt","(","5.0","*","length","(","nt",")",")",";"]}]}}]},{type:"textline",tokens:["return","ns",";","}","else","{","bool","nu","=","max","(","nr",".","x",",","nr",".","z",")",">","max","(","nr",".","y",",","nr",".","w",")",";","vec4","nv","=","vec4","(","0.0",",","nr",".","y",",","0.0",",","nr",".","w",")",";","vec2","nw","=","nr",".","yw",";","kz","(","bvec4","(","nu",",","nu",",","nu",",","nu",")",
",","nv",",","vec4","(","nr",".","x",",","0.0",",","nr",".","z",",","0.0",")",")",";","kz","(","bvec2","(","nu",",","nu",")",",","nw",",","nr",".","xz",")",";","nw","/=","dot","(","nw",",","vec2","(","1.0",",","1.0",")",")",";","vec4","nx","=","nv","*","vec4","(","u_texel_size",",","-","u_texel_size",")","+","nm",".","xyxy",";","vec4","ny","=","nw",".","x","*","texture2D","(","no",",","nx",".","xy",",","0.0",")",";","ny","+=","nw",".","y","*","texture2D","(","no",",","nx",".","zw",",","0.0",")",";"]},
{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","nz","=","nw",".","x","*","(","2.0","*","texture2D","(","nq",",","nx",".","xy",",","0.0",")",".","rg","-","1.0",")",";","nz","+=","nw",".","y","*","(","2.0","*","texture2D","(","nq",",","nx",".","zw",",","0.0",")",".","rg","-","1.0",")",";","if","(","ny",".","a","!=","0.0",")","ny",".","a","=","sqrt","(","5.0","*","length","(","nz",")",")",";"]}]}}]},{type:"textline",tokens:["return",
"ny",";","}","}","vec4","nK","(","vec2","nB",",","sampler2D","nC",",","sampler2D","nD"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","sampler2D","nE"]}]}}]},{type:"textline",tokens:[")","{"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","nF","=","texture2D","(","nC",",","nB",")",";","vec4","nG","=","texture2D","(","nD",",","nB",")",";",
"float","nH","=","abs","(","nF",".","a","*","nF",".","a","-","nG",".","a","*","nG",".","a",")","/","5.0",";","float","nI","=","0.5","*","clamp","(","1.0","-","sqrt","(","nH",")","*","SMAA_REPROJECTION_WEIGHT_SCALE",",","0.0",",","1.0",")",";","vec4","nJ","=","mix","(","nF",",","nG",",","nI",")",";","nJ",".","a","=","1.0",";","return","nJ",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","nF","=","texture2D","(","nC",",","nB",")",";","vec4","nG","=","texture2D","(",
"nD",",","nB",")",";","return","mix","(","nF",",","nG",",","0.5",")",";"]}]}}]},{type:"textline",tokens:["}","void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_EDGE_DETECTION"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","nL","=","vec4","(","kX","(","a",",","kg",",","u_color"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PREDICATION"],group:{type:"group",parts:[{type:"textline",tokens:[",","u_predication_tex"]}]}}]},{type:"textline",
tokens:[")",",","0.0",",","0.0",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","==","SMAA_BLENDING_WEIGHT_CALCULATION"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","nL","=","nl","(","a",",","kh",",","kg",",","u_color",",","u_area_tex",",","u_search_tex",",","vec4","(","0.0",")",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","==","SMAA_NEIGHBORHOOD_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","nL","=","nA","(","a",",","kg",",","u_color",",","u_blend"]},
{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","u_velocity_tex"]}]}}]},{type:"textline",tokens:[")",";"]}]}},{type:"elif",expression:["SMAA_PASS","==","SMAA_RESOLVE"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","nL","=","vec4","(","nK","(","a",",","u_color",",","u_color_prev"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","u_velocity_tex"]}]}}]},
{type:"textline",tokens:[")",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec4","nL","=","texture2D","(","u_color",",","a",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","nL",";","}"]}]},exports["postprocessing/smaa.glslv"]={type:"group",parts:[{type:"define",name:"SMAA_EDGE_DETECTION",tokens:["1"]},{type:"define",name:"SMAA_BLENDING_WEIGHT_CALCULATION",tokens:["2"]},{type:"define",name:"SMAA_NEIGHBORHOOD_BLENDING",tokens:["3"]},{type:"define",name:"AA_METHOD_SMAA_LOW",
tokens:["1"]},{type:"define",name:"AA_METHOD_SMAA_MEDIUM",tokens:["2"]},{type:"define",name:"AA_METHOD_SMAA_HIGH",tokens:["3"]},{type:"define",name:"AA_METHOD_SMAA_ULTRA",tokens:["4"]},{type:"textline",tokens:["attribute","vec2","a_bb_vertex",";","uniform","vec2","u_texel_size",";","varying","vec2","a",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_NEIGHBORHOOD_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","kg",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","kg","[","3","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_BLENDING_WEIGHT_CALCULATION"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","kh",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["AA_METHOD","==","AA_METHOD_SMAA_LOW"],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["4"]}]}},{type:"elif",expression:["AA_METHOD","==","AA_METHOD_SMAA_MEDIUM"],
group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["8"]}]}},{type:"elif",expression:["AA_METHOD","==","AA_METHOD_SMAA_HIGH"],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["16"]}]}},{type:"elif",expression:["AA_METHOD","==","AA_METHOD_SMAA_ULTRA"],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["32"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_MAX_SEARCH_STEPS",group:{type:"group",parts:[{type:"define",
name:"SMAA_MAX_SEARCH_STEPS",tokens:["16"]}]}}]},{type:"textline",tokens:["void","iB","(","vec2","iz",",","out","vec4","iA","[","3","]",")","{","iA","[","0","]","=","u_texel_size",".","xyxy","*","vec4","(","-","1.0",",","0.0",",","0.0",",","-","1.0",")","+","iz",".","xyxy",";","iA","[","1","]","=","u_texel_size",".","xyxy","*","vec4","(","1.0",",","0.0",",","0.0",",","1.0",")","+","iz",".","xyxy",";","iA","[","2","]","=","u_texel_size",".","xyxy","*","vec4","(","-","2.0",",","0.0",",","0.0",",","-",
"2.0",")","+","iz",".","xyxy",";","}","void","iF","(","vec2","iC",",","out","vec2","iD",",","out","vec4","iE","[","3","]",")","{","iD","=","iC","/","u_texel_size",";","iE","[","0","]","=","u_texel_size",".","xyxy","*","vec4","(","-","0.25",",","-","0.125",",","1.25",",","-","0.125",")","+","iC",".","xyxy",";","iE","[","1","]","=","u_texel_size",".","xyxy","*","vec4","(","-","0.125",",","-","0.25",",","-","0.125",",","1.25",")","+","iC",".","xyxy",";","iE","[","2","]","=","u_texel_size",".","xxyy",
"*","vec4","(","-","2.0",",","2.0",",","-","2.0",",","2.0",")","*","float","(","SMAA_MAX_SEARCH_STEPS",")","+","vec4","(","iE","[","0","]",".","xz",",","iE","[","1","]",".","yw",")",";","}","void","iI","(","vec2","iG",",","out","vec4","iH",")","{","iH","=","u_texel_size",".","xyxy","*","vec4","(","1.0",",","0.0",",","0.0",",","1.0",")","+","iG",".","xyxy",";","}","void","main","(",")","{","a","=","a_bb_vertex","+","0.5",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","==","SMAA_EDGE_DETECTION"],
group:{type:"group",parts:[{type:"textline",tokens:["iB","(","a",",","kg",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","==","SMAA_BLENDING_WEIGHT_CALCULATION"],group:{type:"group",parts:[{type:"textline",tokens:["iF","(","a",",","kh",",","kg",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","==","SMAA_NEIGHBORHOOD_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["iI","(","a",",","kg",")",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","vec4","(","2.0","*","a_bb_vertex",".",
"xy",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/ssao.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"define",name:"SSAO_QUALITY_16",tokens:["1"]},{type:"define",name:"SSAO_QUALITY_32",tokens:["2"]},{type:"textline",tokens:["uniform","sampler2D","u_color",";","uniform","sampler2D","u_depth",";","uniform","vec2","u_texel_size",";","uniform","float","u_view_max_depth",";","uniform","vec2","u_camera_range",
";","varying","vec2","a",";","uniform","float","u_ssao_radius_increase",";","uniform","float","u_ssao_dithering_amount",";","uniform","float","u_ssao_gauss_center",";","uniform","float","u_ssao_gauss_width_square",";","uniform","float","u_ssao_gauss_width_left_square",";","uniform","float","u_ssao_influence",";","uniform","float","u_ssao_dist_factor",";","vec2","kn","(","vec2","ki",")","{","float","kj","=","dot","(","ki",",","vec2","(","12.9898",",","78.233",")",")",";","float","kk","=","dot","(",
"ki",",","vec2","(","12.9898",",","78.233",")","*","2.0",")",";","float","kl","=","fract","(","sin","(","kj",")","*","43758.5453",")","*","2.0","-","1.0",";","float","km","=","fract","(","sin","(","kk",")","*","43758.5453",")","*","2.0","-","1.0",";","return","vec2","(","kl",",","km",")",";","}","float","kp","(","in","vec2","ko",")","{","return","kb","(","u_depth",",","ko",",","u_camera_range",")",";","}","float","kx","(","in","float","kq",",","in","float","kr",",","inout","int","ks",")","{","float",
"kt","=","u_ssao_gauss_width_square",";","float","ku","=","(","kq","-","kr",")","*","100.0",";","if","(","ku","<","u_ssao_gauss_center",")","kt","=","u_ssao_gauss_width_left_square",";","else","ks","=","1",";","float","kv","=","ku","-","u_ssao_gauss_center",";","float","kw","=","exp","(","-","2.0","*","kv","*","kv","/","kt",")",";","return","kw",";","}","float","kG","(","float","ky",",","vec2","kz",")","{","float","kA","=","0.0",";","float","kB","=","0.0",";","float","kC","=","max","(","1.0",",",
"u_view_max_depth","/","100.0",")",";","ky","*=","kC",";","kz","/=","ky",";","vec2","kD","=","a","+","kz",";","vec2","kE","=","a","-","kz",";","int","kF","=","0",";","kA","=","kx","(","ky",",","kC","*","kp","(","kD",")",",","kF",")",";","if","(","kF",">","0","||","kD",".","y","<","0.0","||","kD",".","y",">","1.0","||","kD",".","x","<","0.0","||","kD",".","x",">","1.0",")","{","kB","=","kx","(","kC","*","kp","(","kE",")",",","ky",",","kF",")",";","kA","+=","(","1.0","-","kA",")","*","kB",";","}","return",
"kA",";","}","void","main","(",")","{","vec2","kH","=","kn","(","a",")","*","u_ssao_dithering_amount",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_QUALITY","==","SSAO_QUALITY_16"],group:{type:"group",parts:[{type:"textline",tokens:["kH","*=","1.5",";"]}]}}]},{type:"textline",tokens:["float","kI","=","kp","(","a",")",";","float","kJ","=","0.0",";","vec2","kK","=","u_texel_size","*","0.5",";","for","(","int","kL","=","0",";","kL","<","4",";","kL","++",")","{"]},{type:"condition",parts:[{type:"if",
expression:["SSAO_QUALITY","==","SSAO_QUALITY_16"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","kL","==","0","||","kL","==","2",")","{"]}]}}]},{type:"textline",tokens:["kJ","+=","kG","(","kI",",","kK",")",";","kJ","+=","kG","(","kI",",","vec2","(","kK",".","x",",","-","kK",".","y",")",")",";","kJ","+=","kG","(","kI",",","vec2","(","-","kK",".","x",",","kK",".","y",")",")",";","kJ","+=","kG","(","kI",",","vec2","(","-","kK",".","x",",","-","kK",".","y",")",")",";"]},{type:"condition",
parts:[{type:"if",expression:["SSAO_QUALITY","==","SSAO_QUALITY_16"],group:{type:"group",parts:[{type:"textline",tokens:["}","else","if","(","kL","==","1","||","kL","==","3",")","{"]}]}}]},{type:"textline",tokens:["kJ","+=","kG","(","kI",",","vec2","(","kK",".","x","*","1.2",",","0.0",")",")",";","kJ","+=","kG","(","kI",",","vec2","(","-","kK",".","x","*","1.2",",","0.0",")",")",";","kJ","+=","kG","(","kI",",","vec2","(","0.0",",","kK",".","y","*","1.2",")",")",";","kJ","+=","kG","(","kI",",","vec2",
"(","0.0",",","-","kK",".","y","*","1.2",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_QUALITY","==","SSAO_QUALITY_16"],group:{type:"group",parts:[{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["kK","+=","kH",";","kK","*=","u_ssao_radius_increase",";","}"]},{type:"condition",parts:[{type:"if",expression:["SSAO_QUALITY","==","SSAO_QUALITY_16"],group:{type:"group",parts:[{type:"textline",tokens:["kJ","=","1.0","-","kJ","/","16.0",";"]}]}},{type:"elif",expression:["SSAO_QUALITY",
"==","SSAO_QUALITY_32"],group:{type:"group",parts:[{type:"textline",tokens:["kJ","=","1.0","-","kJ","/","32.0",";"]}]}}]},{type:"textline",tokens:["float","kM","=","u_ssao_influence","*","(","1.0","-","u_ssao_dist_factor","*","kI",")",";","kJ","=","(","1.0","-","kM",")","+","kJ","*","kM",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_WHITE"],group:{type:"group",parts:[{type:"textline",tokens:["kJ","=","1.0",";"]}]}}]},{type:"textline",tokens:["float","kN","=","texture2D","(","u_color",
",","a",")",".","r",";","gl_FragColor","=","vec4","(","kN",",","kJ",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/velocity.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_depth",";","uniform","mat4","u_view_proj_inverse",";","uniform","mat4","u_view_proj_prev",";","varying","vec2","a",";","void","main","(",")","{","float","iz","=","texture2D","(","u_depth",",","a",")",".","x",";","vec4","iA","=","vec4",
"(","a","*","2.0","-","1.0",",","2.0","*","iz","-","1.0",",","1.0",")",";","vec4","iB","=","u_view_proj_inverse","*","iA",";","vec4","iC","=","iB","/","iB",".","w",";","vec4","iD","=","iA",";","vec4","iE","=","u_view_proj_prev","*","iC",";","iE","/=","iE",".","w",";","vec2","iF","=","(","iD",".","xy","-","iE",".","xy",")","/","2.0",";","gl_FragColor","=","vec4","(","iF","/","2.0","+","0.5",",","0.0",",","1.0",")",";","}"]}]},exports["include/precision_statement.glslf"]={type:"group",parts:[{type:"var",
name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","float",";"]}]},exports["include/math.glslv"]={type:"group",parts:[{type:"var",name:"EPSILON",tokens:["0.0001"]},{type:"textline",tokens:["struct","b","{","vec3","a",";","vec3","b",";","vec3","c",";","vec3","d",";","vec3","e",";","vec3","f",";","}",";","bool","e","(","float","c",",","float","d",")","{","return","abs","(","c","-","d",")","<","EPSILON",";","}","bool","h","(","vec3","f",",","vec3","g",")","{","return",
"any","(","lessThan","(","abs","(","f","-","g",")",",","vec3","(","EPSILON",")",")",")",";","}","vec3","k","(","in","vec4","i",",","in","vec3","j",")","{","return","j","+","2.0","*","cross","(","i",".","xyz",",","cross","(","i",".","xyz",",","j",")","+","i",".","w","*","j",")",";","}","mat4","l","(",")","{","return","mat4","(","1.0",",","0.0",",","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",",","0.0",",","1.0",")",";","}","mat4",
"n","(","float","m",")","{","return","mat4","(","1.0",",","0.0",",","0.0",",","0.0",",","0.0",",","cos","(","m",")",",","sin","(","m",")",",","0.0",",","0.0",",","-","sin","(","m",")",",","cos","(","m",")",",","0.0",",","0.0",",","0.0",",","0.0",",","1.0",")",";","}","mat4","p","(","float","o",")","{","return","mat4","(","cos","(","o",")",",","0.0",",","-","sin","(","o",")",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","sin","(","o",")",",","0.0",",","cos","(","o",")",",","0.0",",","0.0",
",","0.0",",","0.0",",","1.0",")",";","}","mat4","r","(","float","q",")","{","return","mat4","(","cos","(","q",")",",","sin","(","q",")",",","0.0",",","0.0",",","-","sin","(","q",")",",","cos","(","q",")",",","0.0",",","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",",","0.0",",","1.0",")",";","}","b","t","(","in","b","s",")","{","return","b","(","s",".","a",",","s",".","b",",","normalize","(","s",".","c",")",",","normalize","(","s",".","d",")",",","normalize","(","s",".","e",")",
",","s",".","f",")",";","}"]}]},exports["include/to_world.glslv"]={type:"group",parts:[{type:"define",name:"SKIN_SLERP",tokens:["0"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"define",name:"MAX_BILLBOARD_ANGLE",tokens:["(","M_PI","/","4.0",")"]},{type:"textline",tokens:["const","vec3","u","=","vec3","(","0.0",",","1.0",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD_SPHERICAL"],group:{type:"group",parts:[{type:"textline",tokens:["mat4","A","(",
"vec3","v",",","mat4","w",")","{","vec3","x","=","vec3","(","w","[","0","]","[","0","]",",","w","[","1","]","[","0","]",",","w","[","2","]","[","0","]",")",";","vec3","y","=","vec3","(","w","[","0","]","[","1","]",",","w","[","1","]","[","1","]",",","w","[","2","]","[","1","]",")",";","vec3","z","=","vec3","(","w","[","0","]","[","2","]",",","w","[","1","]","[","2","]",",","w","[","2","]","[","2","]",")",";","y","=","cross","(","z",",","x",")",";","return","mat4","(","vec4","(","x",",","0.0",")",
",","vec4","(","y",",","0.0",")",",","vec4","(","z",",","0.0",")",",","vec4","(","v",",","1.0",")",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","G","(","vec3","B",",","vec3","C",")","{","vec3","D","=","B","-","C",";","D",".","y","=","0.0",";","D","=","normalize","(","D",")",";","vec3","E","=","normalize","(","cross","(","u",",","D",")",")",";","vec3","F","=","normalize","(","cross","(","D",",","E",")",")",";","return","mat4","(","vec4","(","E",",","0.0",
")",",","vec4","(","F",",","0.0",")",",","vec4","(","D",",","0.0",")",",","vec4","(","C",",","1.0",")",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["mat4","R","(","in","vec3","H",",","float","I",",","float","J",",","float","L",",","vec3","M",")","{","float","N","=","fract","(","length","(","M",")","/","0.17",")",";","float","O","=","L","+","N","/","10.0",";","float","P","=","N","/","L",";","H","*=",
"1.0","+","0.5","*","sin","(","I",")",";","float","Q","=","length","(","H",")","*","J","*","sin","(","2.0","*","3.14","*","I","*","O","+","P",")",";","return","r","(","Q",")",";","}"]}]}}]},{type:"textline",tokens:["mat4","ab","(","in","vec3","S",",","in","vec3","T",",","in","mat4","U",")","{"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD_SPHERICAL"],group:{type:"group",parts:[{type:"textline",tokens:["mat4","V","=","A","(","T",",","U",")",";"]}]}},{type:"elif",expression:["HAIR_BILLBOARD_RANDOM"],
group:{type:"group",parts:[{type:"textline",tokens:["float","W","=","fract","(","(","T",".","x","*","1.43","+","T",".","y","*","0.123","+","T",".","z","*","6.1",")",")",";","float","X","=","2.0","*","M_PI","*","W",";","vec3","Y","=","normalize","(","vec3","(","U","[","0","]","[","2","]",",","0.0",",","U","[","2","]","[","2","]",")",")",";","float","Z","=","acos","(","Y","[","2","]",")",";","if","(","Y","[","0","]","<","0.0",")","Z","=","2.0","*","M_PI","-","Z",";","float","_","=","Z","-","X",";",
"if","(","_","<","0.0",")","_","=","2.0","*","M_PI","+","_",";","float","aa","=","X",";","if","(","_","<=","MAX_BILLBOARD_ANGLE",")","aa","+=","_",";","else","if","(","_","<=","M_PI","-","MAX_BILLBOARD_ANGLE",")","aa","+=","MAX_BILLBOARD_ANGLE","*","(","2.0","*","_","-","M_PI",")","/","(","2.0","*","MAX_BILLBOARD_ANGLE","-","M_PI",")",";","else","if","(","_","<=","M_PI","+","MAX_BILLBOARD_ANGLE",")","aa","+=","_","-","M_PI",";","else","if","(","_","<=","2.0","*","M_PI","-","MAX_BILLBOARD_ANGLE",")",
"aa","+=","MAX_BILLBOARD_ANGLE","*","(","2.0","*","_","-","M_PI",")","/","(","2.0","*","MAX_BILLBOARD_ANGLE","-","M_PI",")","+","M_PI",";","else","aa","+=","_","-","2.0","*","M_PI",";","mat4","V","=","p","(","aa",")",";","V","[","3","]","=","vec4","(","T",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","V","=","G","(","S",",","T",")",";"]}]}}]},{type:"textline",tokens:["return","V",";","}","b","ai","(","in","vec3","ac",",","in","vec3","ad",",","in","vec3",
"ae",",","in","vec3","af",",","in","vec3","ag",",","in","mat4","ah",")","{","ac","=","(","ah","*","vec4","(","ac",",","1.0",")",")",".","xyz",";","ad","=","(","ah","*","vec4","(","ad",",","1.0",")",")",".","xyz",";","ae","=","(","ah","*","vec4","(","ae",",","0.0",")",")",".","xyz",";","af","=","(","ah","*","vec4","(","af",",","0.0",")",")",".","xyz",";","ag","=","(","ah","*","vec4","(","ag",",","0.0",")",")",".","xyz",";","return","t","(","b","(","ac",",","ad",",","ae",",","af",",","ag",",","vec3",
"(","0.0",")",")",")",";","}"]}]},exports["include/scale_texcoord.glslv"]={type:"group",parts:[{type:"textline",tokens:["vec2","al","(","vec2","aj",",","vec3","ak",")","{","return","(","aj","+","0.5",")","*","ak",".","xy","-","0.5",";","}"]}]},exports["include/skin.glslv"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SKIN_SLERP"],group:{type:"group",parts:[{type:"textline",tokens:["vec4",
"au","(","in","vec4","am",",","in","vec4","an",",","in","float","ao",")","{","float","ap","=","am","[","0","]","*","an","[","0","]","+","am","[","1","]","*","an","[","1","]","+","am","[","2","]","*","an","[","2","]","+","am","[","3","]","*","an","[","3","]",";","if","(","ap","<","0.0",")","{","an","*=","-","1.0",";","ap","=","-","ap",";","}","if","(","abs","(","ap",")",">=","1.0",")","return","am",";","float","aq","=","acos","(","ap",")",";","float","ar","=","sqrt","(","1.0","-","ap","*","ap",")",
";","if","(","abs","(","ar",")","<","0.001",")","return","vec4","(","am","*","0.5","+","an","*","0.5",")",";","float","as","=","sin","(","(","1.0","-","ao",")","*","aq",")","/","ar",";","float","at","=","sin","(","ao","*","aq",")","/","ar",";","return","am","*","as","+","an","*","at",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","aJ","(","in","vec3","av",",","in","vec4","aw",",","in","vec4","ax",",","in",
"vec4","ay",",","in","vec4","az",",","in","float","aA",")","{"]},{type:"condition",parts:[{type:"if",expression:["SKIN_SLERP"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","aB","=","au","(","aw",",","ax",",","aA",")",";","vec4","aC","=","mix","(","ay",",","az",",","aA",")",";","vec3","aD","=","k","(","aB",",","av",")",";","vec3","aE","=","aD","*","aC",".","w","+","aC",".","xyz",";","return","aE",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","aF","=",
"k","(","aw",",","av",")",";","vec3","aG","=","k","(","ax",",","av",")",";","vec3","aH","=","aF","*","ay",".","w","+","ay",".","xyz",";","vec3","aI","=","aG","*","az",".","w","+","az",".","xyz",";","return","mix","(","aH",",","aI",",","aA",")",";"]}]}}]},{type:"textline",tokens:["}","vec3","aS","(","in","vec3","aK",",","in","vec4","aL",",","in","vec4","aM",",","in","float","aN",")","{"]},{type:"condition",parts:[{type:"if",expression:["SKIN_SLERP"],group:{type:"group",parts:[{type:"textline",tokens:["vec4",
"aO","=","au","(","aL",",","aM",",","aN",")",";","vec3","aP","=","k","(","aO",",","aK",")",";","return","aP",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","aQ","=","k","(","aL",",","aK",")",";","vec3","aR","=","k","(","aM",",","aK",")",";","return","mix","(","aQ",",","aR",",","aN",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","aJ","(","in","vec3","aT",",","in","vec4","aU",",","in","vec4",
"aV",")","{","vec3","aW","=","k","(","aU",",","aT",")",";","vec3","aX","=","aW","*","aV",".","w","+","aV",".","xyz",";","return","aX",";","}","vec3","aS","(","in","vec3","aY",",","in","vec4","aZ",")","{","vec3","a_","=","k","(","aZ",",","aY",")",";","return","a_",";","}"]}]}}]},{type:"textline",tokens:["void","bn","(","inout","vec3","ba",",","inout","vec3","bb",",","inout","vec3","bc",",","inout","vec3","bd",")","{"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",
parts:[{type:"textline",tokens:["float","be","=","u_frame_factor",";"]}]}}]},{type:"textline",tokens:["if","(","a_influence",".","y",">","0.0",")","{","vec3","bf","=","vec3","(","0.0",",","0.0",",","0.0",")",";","vec3","bg","=","vec3","(","0.0",",","0.0",",","0.0",")",";","vec3","bh","=","vec3","(","0.0",",","0.0",",","0.0",")",";","vec3","bi","=","vec3","(","0.0",",","0.0",",","0.0",")",";","for","(","int","bj","=","0",";","bj","<","4",";","bj","++",")","{","int","bk","=","int","(","a_influence",
"[","bj","]",")",";","float","bl","=","fract","(","a_influence","[","bj","]",")",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["bf","+=","bl","*","aJ","(","ba",",","u_quatsb","[","bk","]",",","u_quatsa","[","bk","]",",","u_transb","[","bk","]",",","u_transa","[","bk","]",",","be",")",";","bg","+=","bl","*","aS","(","bb",",","u_quatsb","[","bk","]",",","u_quatsa","[","bk","]",",","be",")",";","bh","+=","bl","*","aS","(",
"bc",",","u_quatsb","[","bk","]",",","u_quatsa","[","bk","]",",","be",")",";","bi","+=","bl","*","aS","(","bd",",","u_quatsb","[","bk","]",",","u_quatsa","[","bk","]",",","be",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bf","+=","bl","*","aJ","(","ba",",","u_quatsb","[","bk","]",",","u_transb","[","bk","]",")",";","bg","+=","bl","*","aS","(","bb",",","u_quatsb","[","bk","]",")",";","bh","+=","bl","*","aS","(","bc",",","u_quatsb","[","bk","]",")",";","bi","+=","bl",
"*","aS","(","bd",",","u_quatsb","[","bk","]",")",";"]}]}}]},{type:"textline",tokens:["}","ba","=","bf",";","bb","=","bg",";","bc","=","bh",";","bd","=","bi",";","}","if","(","!","(","a_influence",".","y",">","0.0",")",")","{","int","bm","=","int","(","a_influence","[","0","]","-","1.0",")",";","if","(","bm",">","-","1",")","{"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["ba","=","aJ","(","ba",",","u_quatsb","[","bm","]",
",","u_quatsa","[","bm","]",",","u_transb","[","bm","]",",","u_transa","[","bm","]",",","be",")",";","bb","=","aS","(","bb",",","u_quatsb","[","bm","]",",","u_quatsa","[","bm","]",",","be",")",";","bc","=","aS","(","bc",",","u_quatsb","[","bm","]",",","u_quatsa","[","bm","]",",","be",")",";","bd","=","aS","(","bd",",","u_quatsb","[","bm","]",",","u_quatsa","[","bm","]",",","be",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["ba","=","aJ","(","ba",",","u_quatsb","[",
"bm","]",",","u_transb","[","bm","]",")",";","bb","=","aS","(","bb",",","u_quatsb","[","bm","]",")",";","bc","=","aS","(","bc",",","u_quatsb","[","bm","]",")",";","bd","=","aS","(","bd",",","u_quatsb","[","bm","]",")",";"]}]}}]},{type:"textline",tokens:["}","}","}"]}]}}]}]},exports["include/wind_bending.glslv"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["void","bB","(","inout","vec3","bo",",","in","vec3","bp",
",","in","float","bq",",","in","float","br",",","in","float","bs",",","in","vec3","bt",",","in","float","bu",")","{","float","bv","=","length","(","bp",")",";","float","bw","=","br","*","(","1.0","+","0.1","*","fract","(","bv",")",")",";","float","bx","=","bq","*","bu","*","(","1.0","+","sin","(","2.0","*","3.14","*","bs","*","bw","+","bv",")",")",";","float","by","=","(","bo",".","y","-","bp",".","y",")","*","abs","(","bx",")",";","by","+=","1.0",";","by","*=","by",";","by","=","by","*","by","-",
"by",";","vec3","bz","=","bo",";","bz",".","xz","+=","bt",".","xz","*","by","*","sign","(","bx",")",";","float","bA","=","length","(","bo","-","bp",")",";","bo","=","bp","+","normalize","(","bz","-","bp",")","*","bA",";","}"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","bD","(","vec4","bC",")","{","return","bC","*","bC","*","(","3.0","-","2.0","*","bC",")",";","}","vec4","bF","(","vec4","bE",")","{","return","abs","(",
"fract","(","bE","+","0.5",")","*","2.0","-","1.0",")",";","}","vec4","bH","(","vec4","bG",")","{","return","bD","(","bF","(","bG",")",")",";","}","void","bY","(","inout","vec3","bI",",","in","float","bJ",",","in","vec3","bK",",","in","vec3","bL",",","in","vec3","bM",",","in","float","bN",",","in","float","bO",",","in","float","bP",",","in","vec3","bQ",")","{","float","bR",";","float","bS",";","float","bT",";","vec2","bU",";","vec4","bV",";","vec2","bW",";","vec3","bX",";","bR","=","dot","(","bM",
",","vec3","(","1.0",")",")",";","bS","=","bR","+","bQ",".","g",";","bT","=","dot","(","bI",",","vec3","(","bQ",".","g",")",")",";","bU","=","(","bJ","+","vec2","(","bT",",","bS",")",")",";","bV","=","(","(","fract","(","(","bU",".","xxyy","*","vec4","(","1.975",",","0.793",",","0.375",",","0.193",")",")",")","*","2.0",")","-","1.0",")","*","length","(","bL",")","*","bN",";","bV","=","bH","(","bV",")",";","bW","=","bV",".","xz","+","bV",".","yw",";","bW",".","y","=","0.5","-","bW",".","y",";","bX",
"=","bW",".","xyx","*","bQ",".","rbr","*","vec3","(","bO","*","bK",".","x",",","bP",",","bO","*","bK",".","z",")",";","bI","+=","bX",";","}"]}]}}]},{type:"textline",tokens:["void","ce","(","inout","vec3","bZ",",","inout","vec3","b_",",","in","vec3","ca",")","{","vec3","cb","=","u_wind","*","1.0","+","0.7","*","sin","(","u_time",")",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","cc","=","b_",";","vec3","cd","=",
"a_emitter_center",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","cc","=","bZ",";","vec3","cd","=","b_",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["bY","(","cc",",","u_time",",","ca",",","cb",",","cd",",","au_detail_bending_freq",",","au_detail_bending_amp",",","au_branch_bending_amp",",","a_bending_col_detail",
")",";"]}]}}]},{type:"textline",tokens:["bB","(","cc",",","cd",",","au_wind_bending_amp",",","au_wind_bending_freq",",","u_time",",","cb",",","a_bending_col_main",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bB","(","cc",",","cd",",","au_wind_bending_amp",",","au_wind_bending_freq",",","u_time",",","cb",",","1.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["bZ","+=","cc","-",
"b_",";","b_","=","cc",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bZ","=","cc",";","b_","=","cd",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]}]},exports["include/std_enums.glsl"]={type:"group",parts:[{type:"define",name:"TEXTURE_COORDS_UV",tokens:["1"]},{type:"define",name:"TEXTURE_COORDS_NORMAL",tokens:["2"]},{type:"define",name:"TEXTURE_BLEND_TYPE_MIX",tokens:["1"]},{type:"define",name:"TEXTURE_BLEND_TYPE_MULTIPLY",tokens:["2"]},{type:"define",name:"SHADOW_SRC_NONE",
tokens:["1"]},{type:"define",name:"SHADOW_SRC_RGBA",tokens:["2"]},{type:"define",name:"SHADOW_SRC_RGBA_PCF",tokens:["3"]},{type:"define",name:"SHADOW_SRC_DEPTH",tokens:["4"]},{type:"define",name:"SHADOW_SRC_VSM",tokens:["5"]},{type:"define",name:"SHADOW_SRC_MASK",tokens:["6"]},{type:"define",name:"SHADOW_DST_NONE",tokens:["1"]},{type:"define",name:"SHADOW_DST_RGBA",tokens:["2"]},{type:"define",name:"SHADOW_DST_DEPTH",tokens:["3"]},{type:"define",name:"SHADOW_DST_VSM",tokens:["4"]},{type:"define",
name:"SHADOW_DST_MASK",tokens:["5"]},{type:"define",name:"SPECULAR_PHONG",tokens:["1"]},{type:"define",name:"SPECULAR_COOKTORR",tokens:["2"]},{type:"define",name:"SPECULAR_WARDISO",tokens:["3"]},{type:"define",name:"DIFFUSE_LAMBERT",tokens:["1"]},{type:"define",name:"DIFFUSE_OREN_NAYAR",tokens:["2"]},{type:"define",name:"DIFFUSE_FRESNEL",tokens:["3"]}]},exports["include/pack.glslf"]={type:"group",parts:[{type:"textline",tokens:["vec4","cj","(","const","in","float","cf",")","{","const","vec4","cg",
"=","vec4","(","255.0","*","255.0","*","255.0",",","255.0","*","255.0",",","255.0",",","1.0",")",";","const","vec4","ch","=","vec4","(","0.0",",","1.0","/","255.0",",","1.0","/","255.0",",","1.0","/","255.0",")",";","vec4","ci","=","fract","(","cf","*","cg",")",";","ci","-=","ci",".","xxyz","*","ch",";","return","ci",";","}","float","cn","(","const","in","vec4","ck",")","{","float","cl",";","const","vec4","cm","=","vec4","(","1.0","/","(","255.0","*","255.0","*","255.0",")",",","1.0","/","(","255.0",
"*","255.0",")",",","1.0","/","255.0",",","1.0",")",";","cl","=","dot","(","ck",",","cm",")",";","return","cl",";","}"]}]},exports["include/shadow.glslf"]={type:"group",parts:[{type:"var",name:"CSM_SECTION_DIST0",tokens:["0.0"]},{type:"var",name:"CSM_SECTION_DIST1",tokens:["0.0"]},{type:"var",name:"CSM_SECTION_DIST2",tokens:["0.0"]},{type:"var",name:"CSM_SECTION_DIST3",tokens:["0.0"]},{type:"var",name:"PCF_TEXEL_SIZE",tokens:["0.0"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==",
"SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","cv",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_RGBA_PCF"],group:{type:"group",parts:[{type:"textline",tokens:["float","cC","(","sampler2D","cw",",","vec3","cx",",","float","cy",",","float","cz",")","{","vec2","cA","=","cx",".","xy","+","vec2","(","cy",",","cz",")",
"*","PCF_TEXEL_SIZE",";","vec4","cB","=","texture2D","(","cw",",","cA",")",";","return","cn","(","cB",")",";","}"]}]}}]},{type:"textline",tokens:["float","cR","(","vec3","cD",",","sampler2D","cE",",","float","cF",")","{","float","cG",";","cD",".","z","=","clamp","(","cD",".","z",",","0.0",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_RGBA"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","cH","=","texture2D","(","cE",",","cD",".","xy",
")",";","float","cI","=","cn","(","cH",")",";","if","(","all","(","lessThan","(","cD",".","xy",",","vec2","(","1.0",")",")",")","&&","all","(","greaterThan","(","cD",".","xy",",","vec2","(","0.0",")",")",")","&&","cI","<","cD",".","z",")","{","float","cJ","=","cD",".","z","-","cI",";","cG","=","exp","(","-","cJ","*","cF",")",";","}","else","cG","=","1.0",";"]}]}},{type:"elif",expression:["SHADOW_SRC","==","SHADOW_SRC_RGBA_PCF"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","cI",";","cI",
".","r","=","cC","(","cE",",","cD",",","0.5",",","0.5",")",";","cI",".","g","=","cC","(","cE",",","cD",",","0.5",",","-","0.5",")",";","cI",".","b","=","cC","(","cE",",","cD",",","-","0.5",",","-","0.5",")",";","cI",".","a","=","cC","(","cE",",","cD",",","-","0.5",",","0.5",")",";","vec4","cK","=","vec4","(","cD",".","z",",","cD",".","z",",","cD",".","z",",","cD",".","z",")",";","if","(","all","(","lessThan","(","cD",".","xy",",","vec2","(","1.0",")",")",")","&&","all","(","greaterThan","(","cD",
".","xy",",","vec2","(","0.0",")",")",")",")","cG","=","dot","(","vec4","(","greaterThanEqual","(","cI",",","cK",")",")",",","vec4","(","0.25",",","0.25",",","0.25",",","0.25",")",")",";","else","cG","=","1.0",";"]}]}},{type:"elif",expression:["SHADOW_SRC","==","SHADOW_SRC_VSM"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","cL","=","texture2D","(","cE",",","cD",".","xy",")",";","float","cM","=","cL",".","r",";","float","cN","=","cL",".","g",";","if","(","all","(","lessThan","(","cD",
".","xy",",","vec2","(","1.0",")",")",")","&&","all","(","greaterThan","(","cD",".","xy",",","vec2","(","0.0",")",")",")","&&","cM","<","cD",".","z",")","{","float","cO","=","cN","-","cM","*","cM",";","float","cP","=","cD",".","z","-","cM",";","cG","=","cO","/","(","cO","+","cP","*","cP",")",";","}","else","cG","=","1.0",";"]}]}},{type:"elif",expression:["SHADOW_SRC","==","SHADOW_SRC_DEPTH"],group:{type:"group",parts:[{type:"textline",tokens:["float","cI","=","texture2D","(","cE",",","cD",".","xy",
")",".","r",";","if","(","all","(","lessThan","(","cD",".","xy",",","vec2","(","1.0",")",")",")","&&","all","(","greaterThan","(","cD",".","xy",",","vec2","(","0.0",")",")",")","&&","cI","<","cD",".","z",")","{","cG","=","0.0",";","float","cQ","=","cD",".","z","-","cI",";","cG","=","exp","(","-","cQ","*","cF",")",";","}","else","cG","=","1.0",";"]}]}}]},{type:"textline",tokens:["return","clamp","(","cG",",","0.0",",","1.0",")",";","}"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC",
"!=","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["float","cX","(","float","cS",",","float","cT",")","{","vec3","cU",";","float","cV","=","1.0",";","float","cW","=","-","cS",";","if","(","cW","<","CSM_SECTION_DIST0",")","{","cU","=","cp",".","xyz","/","cp",".","w",";","cV","=","cR","(","cU",",","u_shadow_map0",",","cT",")",";","}"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["else","if","(","cW","<",
"CSM_SECTION_DIST1",")","{","cU","=","cq",".","xyz","/","cq",".","w",";","cV","=","cR","(","cU",",","u_shadow_map1",",","cT",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["else","if","(","cW","<","CSM_SECTION_DIST2",")","{","cU","=","cr",".","xyz","/","cr",".","w",";","cV","=","cR","(","cU",",","u_shadow_map2",",","cT",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",
parts:[{type:"textline",tokens:["else","if","(","cW","<","CSM_SECTION_DIST3",")","{","cU","=","cs",".","xyz","/","cs",".","w",";","cV","=","cR","(","cU",",","u_shadow_map3",",","cT",")",";","}"]}]}}]},{type:"textline",tokens:["return","cV",";","}"]}]}}]}]}}]},{type:"textline",tokens:["float","dc","(","in","float","cY",",","inout","vec3","cZ",")","{"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","c_",
"=","texture2DProj","(","u_shadow_mask",",","ct",")",".","rg",";","vec3","da","=","vec3","(","c_",".","r",")",";","float","db","=","c_",".","g",";","cv","=","vec4","(","da",",","db",")",";","cZ","*=","cv",".","a",";","return","cv",".","r",";"]}]}},{type:"elif",expression:["SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["return","cX","(","cu",".","z",",","cY",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","1.0",";"]}]}}]},
{type:"textline",tokens:["}"]}]},exports["include/dynamic_grass.glslv"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","dh","(","vec3","dd",",","float","de",",","vec2","df",")","{","vec2","dg","=","vec2","(","(","dd",".","x","-","df",".","x",")","/","de",",","-","(","dd",".","z","-","df",".","y",")","/","de",")",";","return","fract","(","dg",")",";","}","vec2","dl","(","vec2","di",",","float","dj",",",
"vec2","dk",")","{","return","vec2","(","di",".","x","*","dj",",","-","di",".","y","*","dj",")","+","dk",";","}","b","dm","(",")","{","return","b","(","vec3","(","-","10000.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",")",";","}","b","dT","(","vec3","dn",",","vec3","dp",",","vec3","dq",",","vec3","dr",",","vec3","ds",",","sampler2D","dt",",","sampler2D","du",",","vec3","dv",",","float","dw",",","vec3","dx",",",
"vec4","dy",",","mat4","dz",")","{","vec3","dA","=","k","(","dy",",","vec3","(","0.0",",","-","1.0",",","0.0",")",")",";","float","dB","=","-","dA",".","x",";","float","dC","=","-","dA",".","z",";","vec2","dD","=","vec2","(","dx",".","x","+","dw","*","(","-","1.0","-","dB",")","/","2.0",",","dx",".","z","+","dw","*","(","1.0","-","dC",")","/","2.0",")",";","vec2","dE","=","dh","(","ds",",","dw",",","dD",")",";","float","dF","=","dw","/","2.0",";","vec2","dG","=","abs","(","dl","(","dE","-","vec2",
"(","0.5",")",",","dw",",","vec2","(","0.0",")",")",")",";","float","dH","=","dF","*","(","1.0","+","sqrt","(","2.0",")",")","/","2.0",";","if","(","length","(","dG",")",">","dH",")","return","dm","(",")",";","float","dI","=","dw","/","dv",".","z",";","vec2","dJ","=","(","dE","-","vec2","(","0.5",")",")","*","dI","+","vec2","(","0.5",")",";","vec3","dK","=","dA","*","(","dw","/","dv",".","z","-","1.0",")","/","2.0",";","dJ",".","x","+=","dK",".","x",";","dJ",".","y","-=","dK",".","z",";","vec4","dL",
"=","texture2D","(","du",",","dJ",")",";","float","dM","=","dL",".","r",";","if","(","dM","<","u_scale_threshold",")","return","dm","(",")",";","float","dN","=","dv",".","y","-","dv",".","x",";","float","dO","=","dv",".","y","-","texture2D","(","dt",",","dJ",")",".","r","*","dN",";","vec2","dP","=","dn",".","xz","-","ds",".","xz",";","ds",".","xz","=","dl","(","dE",",","dw",",","dD",")",";","ds",".","y","=","dO",";","dn",".","xz","=","ds",".","xz","+","dP",";","dn",".","y","*=","dM",";","dn",".",
"y","+=","dO",";","vec3","dQ","=","dL",".","gba",";"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["dn","-=","ds",";","mat4","dR","=","ab","(","dx",",","ds",",","dz",")",";","b","dS","=","ai","(","dn",",","ds",",","dp",",","dq",",","dr",",","dR",")",";","dS",".","b","=","ds",";","dS",".","f","=","dQ",";","return","t","(","dS",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","t","(","b",
"(","dn",",","ds",",","dp",",","dq",",","dr",",","dQ",")",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]}]},exports["include/shadow.glslv"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SHADOW_SRC","!=","SHADOW_SRC_MASK","&&","SHADOW_SRC","!=","SHADOW_SRC_NONE"],group:{type:"group",parts:[{type:"textline",tokens:["void","dV","(","vec3","dU",")","{","cp","=","u_b_light_matrix","*","u_p_light_matrix0","*","u_v_light_matrix","*","vec4","(","dU",",","1.0",")",";"]},{type:"condition",
parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["cq","=","u_b_light_matrix","*","u_p_light_matrix1","*","u_v_light_matrix","*","vec4","(","dU",",","1.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["cr","=","u_b_light_matrix","*","u_p_light_matrix2","*","u_v_light_matrix","*","vec4","(","dU",",","1.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],
group:{type:"group",parts:[{type:"textline",tokens:["cs","=","u_b_light_matrix","*","u_p_light_matrix3","*","u_v_light_matrix","*","vec4","(","dU",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}},{type:"elif",expression:["SHADOW_SRC","==","SHADOW_SRC_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["void","dV","(","vec4","dW",")","{","float","dX","=","dW",".","x",";","float","dY","=","dW",".","y",";","float","dZ","=","dW",".","w",";","ct",".","x","=","(","dX","+","dZ",")","/",
"2.0",";","ct",".","y","=","(","dY","+","dZ",")","/","2.0",";","ct",".","z","=","dZ",";","}"]}]}}]}]},exports["include/gamma.glslf"]={type:"group",parts:[{type:"define",name:"GAMMA",tokens:["1"]},{type:"define",name:"PREMULTIPLY_ALPHA",tokens:["1"]},{type:"textline",tokens:["void","eb","(","inout","vec3","ea",")","{"]},{type:"condition",parts:[{type:"if",expression:["GAMMA"],group:{type:"group",parts:[{type:"textline",tokens:["ea","=","pow","(","ea",",","vec3","(","2.2",")",")",";"]}]}}]},{type:"textline",
tokens:["}","void","ed","(","inout","vec3","ec",")","{"]},{type:"condition",parts:[{type:"if",expression:["GAMMA"],group:{type:"group",parts:[{type:"textline",tokens:["ec","=","pow","(","ec",",","vec3","(","1.0","/","2.2",")",")",";"]}]}}]},{type:"textline",tokens:["}","void","eg","(","inout","vec3","ee",",","in","float","ef",")","{"]},{type:"condition",parts:[{type:"if",expression:["PREMULTIPLY_ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["ee","=","ee","*","ef",";"]}]}}]},{type:"textline",
tokens:["}"]}]},exports["include/fog.glslf"]={type:"group",parts:[{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"textline",tokens:["float","eo","(","inout","vec3","ej",",","in","float","ek",",","in","vec4","el",")","{","float","em","=","el",".","w","*","ek",";","float","en","=","exp","(","-","em","*","em",")",";","en","=","clamp","(","en",",","0.0",",","1.0",")",";","ej","=","mix","(","el",".","rgb",",","ej",",","en",")",";","return","en",";","}"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],
group:{type:"group",parts:[{type:"textline",tokens:["vec3","ev","(","in","mat4","ep",",","in","vec3","eq",")","{","vec3","er","=","mix","(","ep","[","0","]",".","rgb",",","ep","[","1","]",".","rgb",",","max","(","sign","(","eq",".","x",")",",","0.0",")",")",";","vec3","es","=","mix","(","ep","[","2","]",".","rgb",",","ep","[","3","]",".","rgb",",","max","(","sign","(","eq",".","z",")",",","0.0",")",")",";","vec3","et","=","vec3","(","ep","[","0","]",".","a",",","ep","[","1","]",".","a",",","ep","[",
"2","]",".","a",")",";","vec3","eu","=","mix","(","er",",","es",",","abs","(","eq",".","z",")",")",";","eu","=","mix","(","eu",",","et",",","abs","(","eq",".","y",")",")",";","return","eu",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["void","ex","(","inout","float","ew",")","{","ew","-=","0.5",";","ew","=","4.0","*","(","ew","*","ew","*","ew",")","+","0.5",";","}","float","eM","(","inout","vec3","ey",",","in","float",
"ez",",","in","float","eA",",","in","float","eB",",","in","vec4","eC",",","in","vec4","eD",",","in","float","eE",",","in","float","eF",")","{","eA","=","clamp","(","eA",",","0.0",",","1.0",")",";","float","eG","=","eD",".","w","*","ez",";","float","eH","=","exp","(","-","eG","*","eG",")",";","eH","=","clamp","(","eH",",","0.0",",","1.0",")",";","ez","=","max","(","ez","-","max","(","eB","/","eA",",","0.0",")",",","0.0",")",";","eG","=","eC",".","w","*","ez",";","float","eI","=","1.0","-","eG",";",
"eI","+=","max","(","eE","-","WAVES_HEIGHT","-","0.05",",","0.0",")",";","+","max","(","eE","/","WAVES_HEIGHT",",","0.0",")",";","eI","=","clamp","(","eI",",","0.0",",","1.0",")",";","ex","(","eI",")",";","if","(","eI","<","eH",")","{","vec3","eJ","=","vec3","(","0.0",",","0.02",",","0.05",")",";","vec3","eK","=","eC",".","rgb",";","eB","=","clamp","(","-","eB","*","0.03",",","0.0",",","0.8",")",";","vec3","eL","=","mix","(","eK",",","eJ",",","min","(","eA",",","1.0",")",")",";","eL","=","mix","(",
"eL",",","vec3","(","0.0",")",",","eB",")","*","eF",";","ey","=","mix","(","eL",",","ey",",","eI",")",";","return","eI",";","}","if","(","eI",">=","eH",")","{","ey","=","mix","(","eD",".","rgb",",","ey",",","eH",")",";","return","eH",";","}","}","float","eV","(","inout","vec3","eN",",","in","float","eO",",","in","float","eP",",","in","vec4","eQ",",","in","float","eR",")","{","float","eS","=","eQ",".","w","*","eO",";","float","eT","=","1.0","-","eS",";","eT","=","clamp","(","eT",",","0.0",",","1.0",
")",";","ex","(","eT",")",";","eP","=","clamp","(","-","eP","*","0.03",",","0.0",",","0.8",")",";","vec3","eU","=","mix","(","eQ",".","rgb",",","vec3","(","0.0",")",",","eP",")","*","eR",";","eN","=","mix","(","eU",",","eN",",","eT",")",";","return","eT",";","}"]}]}}]}]},exports["include/lighting.glslf"]={type:"group",parts:[{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"textline",tokens:["struct","eW","{","vec4","a",";","vec3","b",";","}",
";"]},{type:"condition",parts:[{type:"if",expression:["SPECULAR_SHADER","==","SPECULAR_PHONG","||","SPECULAR_SHADER","==","SPECULAR_COOKTORR"],group:{type:"group",parts:[{type:"textline",tokens:["float","fd","(","vec3","eX",",","vec3","eY",",","vec3","eZ",",","vec4","e_",",","float","fa",")","{","vec3","fb","=","normalize","(","eX","+","eY",")",";","float","fc","=","e_","[","0","]","*","max","(","dot","(","eZ",",","fb",")",",","0.0",")","+","e_","[","1","]",";","return","pow","(","fc",",","fa",")",
";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SPECULAR_SHADER","==","SPECULAR_WARDISO"],group:{type:"group",parts:[{type:"textline",tokens:["float","fo","(","vec3","fe",",","vec3","ff",",","vec3","fg",",","float","fh",")","{","vec3","fi","=","normalize","(","fe","+","ff",")",";","float","fj","=","max","(","dot","(","fg",",","fi",")",",","0.001",")",";","float","fk","=","max","(","dot","(","fg",",","ff",")",",","0.001",")",";","float","fl","=","max","(","dot","(","fg",",","fe",")",
",","0.001",")",";","float","fm","=","tan","(","acos","(","fj",")",")",";","float","fn","=","max","(","fh",",","0.001",")",";","return","fl","*","(","1.0","/","(","4.0","*","M_PI","*","fn","*","fn",")",")","*","(","exp","(","-","(","fm","*","fm",")","/","(","fn","*","fn",")",")","/","(","sqrt","(","fk","*","fl",")",")",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DIFFUSE_SHADER","==","DIFFUSE_OREN_NAYAR"],group:{type:"group",parts:[{type:"textline",tokens:["void","fG","(","float",
"fp",",","vec3","fq",",","vec3","fr",",","vec3","fs",",","float","ft",",","inout","float","fu",")","{","if","(","ft",">","0.0",")","{","float","fv","=","max","(","dot","(","fq",",","fs",")",",","0.0",")",";","float","fw","=","acos","(","fp",")",";","float","fx","=","acos","(","fv",")",";","vec3","fy","=","normalize","(","fr","-","fp","*","fq",")",";","vec3","fz","=","normalize","(","fs","-","fv","*","fq",")",";","float","fA","=","max","(","dot","(","fy",",","fz",")",",","0.0",")",";","float","fB",
",","fC",";","fB","=","max","(","fw",",","fx",")",";","fC","=","min","(","fw",",","fx",")",";","float","fD","=","ft","*","ft",";","float","fE","=","1.0","-","0.5","*","(","fD","/","(","fD","+","0.33",")",")",";","float","fF","=","0.45","*","(","fD","/","(","fD","+","0.09",")",")",";","fC","*=","0.95",";","fu","=","fu","*","(","fE","+","(","fF","*","fA","*","sin","(","fB",")","*","tan","(","fC",")",")",")",";","}","else","{","fu","=","fu",";","}","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DIFFUSE_SHADER",
"==","DIFFUSE_FRESNEL"],group:{type:"group",parts:[{type:"textline",tokens:["void","fN","(","vec3","fH",",","vec3","fI",",","float","fJ",",","float","fK",",","out","float","fL",")","{","float","fM",";","if","(","fJ","==","0.0",")","{","fL","=","1.0",";","}","else","{","fM","=","1.0","+","abs","(","dot","(","fI",",","fH",")",")",";","fM","=","fK","+","(","1.0","-","fK",")","*","pow","(","fM",",","fJ",")",";","fL","=","clamp","(","fM",",","0.0",",","1.0",")",";","}","}"]}]}}]},{type:"textline",tokens:["eW",
"gz","(","vec3","fO",",","vec3","fP",",","vec3","fQ",",","vec3","fR",",","vec3","fS",",","vec3","fT",",","vec3","fU",",","float","fV",",","vec2","fW",",","float","fX",",","vec3","fY","[","NUM_LIGHTS","]",",","vec3","fZ","[","NUM_LIGHTS","]",",","vec3","f_","[","NUM_LIGHTS","]",",","vec4","ga","[","NUM_LIGHTS","]",",","vec4","gb","[","NUM_LIGHTS","]",",","float","gc",",","vec4","gd",")","{","eW","ge",";","ge",".","a","=","vec4","(","fO","+","fQ","*","fP",",","0.0",")",";","ge",".","b","=","vec3","(",
"0.0",")",";","for","(","int","gf","=","0",";","gf","<","NUM_LIGHTS",";","gf","++",")","{","vec4","gg","=","ga","[","gf","]",";","vec4","gh","=","gb","[","gf","]",";","vec3","gi","=","vec3","(","0.0",")",";","vec3","gj","=","f_","[","gf","]",";","gj","*=","fX",";","float","gk","=","gh",".","z",";","if","(","gk","!=","-","1.0",")","{","gi","=","fY","[","gf","]","-","fS",";","float","gl","=","length","(","gi",")",";","gj","*=","gk","/","(","gk","+","gl","*","gl",")",";","gi","=","normalize","(","gi",
")",";","float","gm","=","gh",".","x",";","float","gn","=","gh",".","y",";","if","(","gm",">","-","1.0",")","{","float","go","=","dot","(","gi",",","fZ","[","gf","]",")",";","go","*=","smoothstep","(","0.0",",","1.0",",","(","go","-","gm",")","/","gn",")",";","gj","*=","go",";","}","}","else","gi","=","fZ","[","gf","]",";","float","gp",";"]},{type:"condition",parts:[{type:"if",expression:["DIFFUSE_SHADER","==","DIFFUSE_FRESNEL"],group:{type:"group",parts:[{type:"textline",tokens:["fN","(","fT",",",
"gi",",","fW","[","0","]",",","fW","[","1","]",",","gp",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["float","gq","=","max","(","dot","(","fT",",","gi",")",",","0.0",")",";","gp","=","gg","[","0","]","*","gq","+","gg","[","1","]",";"]},{type:"condition",parts:[{type:"if",expression:["DIFFUSE_SHADER","==","DIFFUSE_OREN_NAYAR"],group:{type:"group",parts:[{type:"textline",tokens:["fG","(","gq",",","fT",",","gi",",","fU",",","fW","[","0","]",",","gp",")",";"]}]}}]}]}}]},
{type:"condition",parts:[{type:"if",expression:["SPECULAR_SHADER","==","SPECULAR_PHONG","||","SPECULAR_SHADER","==","SPECULAR_COOKTORR"],group:{type:"group",parts:[{type:"textline",tokens:["float","gr","=","fd","(","gi",",","fU",",","fT",",","gg",",","fV",")",";"]}]}},{type:"elif",expression:["SPECULAR_SHADER","==","SPECULAR_WARDISO"],group:{type:"group",parts:[{type:"textline",tokens:["float","gr","=","fo","(","gi",",","fU",",","fT",",","fV",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["float","gr","=","0.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_TRANSLUCENCY"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","dot","(","gi",",","fT",")","*","dot","(","fU",",","fT",")","<","0.0",")","{","float","gs","=","gd",".","x",";","float","gt","=","gd",".","y",";","float","gu","=","gd",".","z",";","float","gv","=","gd",".","w",";","float","gw","=","clamp","(","abs","(","dot","(","gi",",","fT",")",")",",","0.0",",","1.0",")",";","float","gx",
"=","clamp","(","dot","(","fU",",","-","gi",")",",","0.0",",","1.0",")",";","float","gy","=","pow","(","gx",",","gt",")",";","ge",".","a","+=","gc","*","vec4","(","gj","*","gw","*","pow","(","fQ",",","vec3","(","gs",")",")",",","1.0",")",";","ge",".","a","+=","gu","*","mix","(","vec4","(","fQ",",","1.0",")",",","vec4","(","1.0",")",",","gv",")","*","gc","*","vec4","(","gj","*","gw","*","vec3","(","gy",")",",","1.0",")",";","}","else","{","ge",".","b","+=","gj","*","fR","*","gr",";","ge",".","a","+=",
"vec4","(","gj","*","fQ","*","gp",",","gr",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["ge",".","b","+=","gj","*","fR","*","gr",";","ge",".","a","+=","vec4","(","gj","*","fQ","*","gp",",","gr",")",";"]}]}}]},{type:"textline",tokens:["}","return","ge",";","}"]}]},exports["include/procedural.glslf"]={type:"group",parts:[{type:"textline",tokens:["vec4","gB","(","vec4","gA",")","{","return","gA","-","floor","(","gA","*","(","1.0","/","289.0",")",")","*","289.0",";",
"}","vec3","gB","(","vec3","gC",")","{","return","gC","-","floor","(","gC","*","(","1.0","/","289.0",")",")","*","289.0",";","}","vec2","gB","(","vec2","gD",")","{","return","gD","-","floor","(","gD","*","(","1.0","/","289.0",")",")","*","289.0",";","}","vec4","gF","(","vec4","gE",")","{","return","gE","-","floor","(","gE","*","(","1.0","/","7.0",")",")","*","7.0",";","}","vec4","gH","(","vec4","gG",")","{","return","gB","(","(","34.0","*","gG","+","5.0",")","*","gG",")",";","}"]},{type:"define",
name:"K",tokens:["0.142857142857"]},{type:"define",name:"K2",tokens:["0.0714285714285"]},{type:"define",name:"JITTER",tokens:["0.7"]},{type:"textline",tokens:["vec2","gT","(","vec2","gI",")","{","vec2","gJ","=","gB","(","floor","(","gI",")",")",";","vec2","gK","=","fract","(","gI",")",";","vec4","gL","=","gK",".","x","+","vec4","(","-","0.5",",","-","1.5",",","-","0.5",",","-","1.5",")",";","vec4","gM","=","gK",".","y","+","vec4","(","-","0.5",",","-","0.5",",","-","1.5",",","-","1.5",")",";","vec4",
"gN","=","gH","(","gJ",".","x","+","vec4","(","0.0",",","1.0",",","0.0",",","1.0",")",")",";","gN","=","gH","(","gN","+","gJ",".","y","+","vec4","(","0.0",",","0.0",",","1.0",",","1.0",")",")",";","vec4","gO","=","gF","(","gN",")","*","K","+","K2",";","vec4","gP","=","gF","(","floor","(","gN","*","K",")",")","*","K","+","K2",";","vec4","gQ","=","gL","+","JITTER","*","gO",";","vec4","gR","=","gM","+","JITTER","*","gP",";","vec4","gS","=","gQ","*","gQ","+","gR","*","gR",";"]},{type:"condition",parts:[{type:"if",
expression:["1"],group:{type:"group",parts:[{type:"textline",tokens:["gS",".","xy","=","min","(","gS",".","xy",",","gS",".","zw",")",";","gS",".","x","=","min","(","gS",".","x",",","gS",".","y",")",";","return","gS",".","xx",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gS",".","xy","=","(","gS",".","x","<","gS",".","y",")","?","gS",".","xy",":","gS",".","yx",";","gS",".","xz","=","(","gS",".","x","<","gS",".","z",")","?","gS",".","xz",":","gS",".","zx",";","gS",".","xw",
"=","(","gS",".","x","<","gS",".","w",")","?","gS",".","xw",":","gS",".","wx",";","gS",".","y","=","min","(","gS",".","y",",","gS",".","z",")",";","gS",".","y","=","min","(","gS",".","y",",","gS",".","w",")",";","return","sqrt","(","gS",".","xy",")",";"]}]}}]},{type:"textline",tokens:["}","mat3","hh","(","vec2","gU",",","float","gV",")","{","vec2","gW","=","gB","(","floor","(","gU",")",")",";","vec2","gX","=","fract","(","gU",")",";","vec4","gY","=","gX",".","x","+","vec4","(","-","0.5",",","-","1.5",
",","-","0.5",",","-","1.5",")",";","vec4","gZ","=","gX",".","y","+","vec4","(","-","0.5",",","-","0.5",",","-","1.5",",","-","1.5",")",";","vec4","g_","=","gH","(","gW",".","x","+","vec4","(","0.0",",","1.0",",","0.0",",","1.0",")",")",";","g_","=","gH","(","g_","+","gW",".","y","+","vec4","(","0.0",",","0.0",",","1.0",",","1.0",")",")",";","vec4","ha","=","gF","(","g_",")","*","K","+","K2",";","vec4","hb","=","gF","(","floor","(","g_","*","K",")",")","*","K","+","K2",";","vec4","hc","=","gY","+",
"JITTER","*","ha",";","vec4","hd","=","gZ","+","JITTER","*","hb",";","vec4","he","=","hc","*","hc","+","hd","*","hd",";","hc","+=","gV",";","hd","+=","gV",";","vec4","hf","=","hc","*","hc","+","hd","*","hd",";","hc","+=","gV",";","hd","+=","gV",";","vec4","hg","=","hc","*","hc","+","hd","*","hd",";","he",".","xy","=","min","(","he",".","xy",",","he",".","zw",")",";","he",".","x","=","min","(","he",".","x",",","he",".","y",")",";","hf",".","xy","=","min","(","hf",".","xy",",","hf",".","zw",")",";",
"hf",".","x","=","min","(","hf",".","x",",","hf",".","y",")",";","hg",".","xy","=","min","(","hg",".","xy",",","hg",".","zw",")",";","hg",".","x","=","min","(","hg",".","x",",","hg",".","y",")",";","return","mat3","(","he",".","xx",",","0.0",",","hf",".","xx",",","0.0",",","hg",".","xx",",","0.0",")",";","}","vec3","hj","(","vec3","hi",")","{","return","gB","(","(","(","hi","*","34.0",")","+","1.0",")","*","hi",")",";","}","float","hx","(","vec2","hk",")","{","const","vec4","hl","=","vec4","(","0.211324865405187",
",","0.366025403784439",",","-","0.577350269189626",",","0.024390243902439",")",";","vec2","hm","=","floor","(","hk","+","dot","(","hk",",","hl",".","yy",")",")",";","vec2","hn","=","hk","-","hm","+","dot","(","hm",",","hl",".","xx",")",";","vec2","ho",";","ho","=","(","hn",".","x",">","hn",".","y",")","?","vec2","(","1.0",",","0.0",")",":","vec2","(","0.0",",","1.0",")",";","vec4","hp","=","hn",".","xyxy","+","hl",".","xxzz",";","hp",".","xy","-=","ho",";","hm","=","gB","(","hm",")",";","vec3","hq",
"=","hj","(","hj","(","hm",".","y","+","vec3","(","0.0",",","ho",".","y",",","1.0",")",")","+","hm",".","x","+","vec3","(","0.0",",","ho",".","x",",","1.0",")",")",";","vec3","hr","=","max","(","0.5","-","vec3","(","dot","(","hn",",","hn",")",",","dot","(","hp",".","xy",",","hp",".","xy",")",",","dot","(","hp",".","zw",",","hp",".","zw",")",")",",","0.0",")",";","hr","=","hr","*","hr",";","hr","=","hr","*","hr",";","vec3","hs","=","2.0","*","fract","(","hq","*","hl",".","www",")","-","1.0",";","vec3",
"ht","=","abs","(","hs",")","-","0.5",";","vec3","hu","=","floor","(","hs","+","0.5",")",";","vec3","hv","=","hs","-","hu",";","hr","*=","1.79284291400159","-","0.85373472095314","*","(","hv","*","hv","+","ht","*","ht",")",";","vec3","hw",";","hw",".","x","=","hv",".","x","*","hn",".","x","+","ht",".","x","*","hn",".","y",";","hw",".","yz","=","hv",".","yz","*","hp",".","xz","+","ht",".","yz","*","hp",".","yw",";","return","130.0","*","dot","(","hr",",","hw",")",";","}"]}]},exports["include/caustics.glslf"]=
{type:"group",parts:[{type:"var",name:"CAUST_SPEED",tokens:["vec2","(","0.0",")"]},{type:"var",name:"CAUST_SCALE",tokens:["0.0"]},{type:"var",name:"CAUST_BRIGHT",tokens:["0.0"]},{type:"textline",tokens:["void","hY","(","inout","vec3","hy",",","float","hz",",","float","hA",",","float","hB",",","vec3","hC",",","vec3","hD",",","vec3","hE",",","vec4","hF",",","vec3","hG",",","float","hH",")","{","if","(","hH",">","100.0",")","return",";","vec4","hI","=","hF",";","vec3","hJ","=","hG","+","hC",";","hJ",
".","xz","=","10.0","*","sin","(","0.1","*","hJ",".","xz",")",";","vec3","hK","=","hJ","+","2.0","*","cross","(","-","hI",".","xyz",",","cross","(","-","hI",".","xyz",",","hJ",")","+","hI",".","w","*","hJ",")",";","vec2","hL","=","hK",".","xz",";","vec3","hM","=","hD",";","float","hN","=","max","(","dot","(","hC",",","hM",")",",","0.0",")",";","float","hO","=","0.025",";","hL",".","s","+=","0.5","*","sin","(","dot","(","hG","+","hA",",","vec3","(","1.0",")",")",")",";","hL",".","t","+=","0.7","*",
"(","-","sin","(","dot","(","hG","-","hA",",","vec3","(","-","0.7",")",")",")",")",";","hL",".","st","+=","0.23","*","cos","(","4.0","*","hz","-","CAUST_SPEED",".","x","*","hA",")",";","hL",".","st","+=","3.0","*","sin","(","hz","-","0.3","*","CAUST_SPEED",".","y","*","hA",")",";","float","hP","=","CAUST_SCALE","*","(","1.0","+","max","(","0.1","*","hz",",","0.0",")",")",";","mat3","hQ","=","hh","(","(","hL","/","hP",")",",","hO",")",";","float","hR","=","(","hQ","*","vec3","(","1.0",",","0.0",",",
"0.0",")",")",".","x",";","float","hS","=","(","hQ","*","vec3","(","0.0",",","1.0",",","0.0",")",")",".","x",";","float","hT","=","(","hQ","*","vec3","(","0.0",",","0.0",",","1.0",")",")",".","x",";","vec3","hU","=","CAUST_BRIGHT","*","vec3","(","hR",",","hS",",","hT",")",";","float","hV","=","hB","*","hN",";","float","hW","=","max","(","sign","(","hz",")",",","0.0",")",";","hV","=","min","(","hV","+","0.5","*","sign","(","-","hC",".","y",")","*","hW",",","1.0",")",";","hV","*=","1.0","-","hW","*",
"(","0.1","*","hz",")",";","hU","*=","hV",";","hU","*=","hU",";","float","hX","=","min","(","-","hz","+","10.0",",","1.0",")",";","hy","+=","max","(","(","2.0","*","hE","*","hU",")","*","hX",",","0.0",")",";","}"]}]},exports["include/mirror.glslf"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFLECTIVE","||","TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"define",name:"BUMP",tokens:["0.1"]},{type:"textline",tokens:["float","il","(","in","vec3","id",",","in","vec3","ie",
",","in","float","ig",",","in","float","ih",")","{","vec3","ii","=","normalize","(","ie","+","id",")",";","float","ij","=","1.0","-","dot","(","id",",","ii",")",";","float","ik","=","ih","+","(","1.0","-","ih",")","*","pow","(","ij",",","ig",")",";","return","ik",";","}","void","iy","(","inout","vec3","im",",","in","vec3","io",",","in","vec3","ip",",","in","float","iq",",","in","float","ir",",","in","vec2","is",")","{","vec3","it","=","reflect","(","-","io",",","ip",")",";","float","iu","=","il",
"(","io",",","it",",","iq",",","ir",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["vec2","iv","=","ct",".","xy","/","ct",".","z",";","iv","+=","is","*","BUMP",";","vec3","iw","=","texture2D","(","u_reflectmap",",","iv",")",".","rgb",";","eb","(","iw",".","rgb",")",";","im","=","mix","(","im",",","iw",",","u_reflect_factor","*","iu",")",";"]}]}},{type:"elif",expression:["TEXTURE_MIRROR"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","ix","=","textureCube","(","u_mirrormap",",","it",")",".","xyz",";","eb","(","ix",".","rgb",")",";","im","=","mix","(","im",",","ix",",","u_mirror_factor","*","iu",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]}]},exports["include/particles.glslv"]={type:"group",parts:[{type:"define",name:"RAMPSIZE",tokens:["4"]},{type:"textline",tokens:["float","jt","(","float","ji",",","float","jj",",","vec2","jk","[","RAMPSIZE","]",")","{","if","(","jk","[","0","]","[","0","]","<","0.0",")","return",
"1.0",";","float","jl","=","ji","/","jj",";","bool","jm","=","false",";","float","jn","=","0.0",";","float","jo","=","jk","[","0","]","[","1","]",";","float","jp","=","1.0",";","float","jq","=","1.0",";","for","(","int","jr","=","0",";","jr","<","RAMPSIZE",";","jr","++",")","{","if","(","!","jm",")","{","if","(","jk","[","jr","]","[","0","]",">=","0.0",")","{","if","(","jl",">=","jn","&&","jl","<","jk","[","jr","]","[","0","]",")","{","jp","=","jk","[","jr","]","[","0","]",";","jq","=","jk","[","jr",
"]","[","1","]",";","jm","=","true",";","}","else","if","(","jl","<","jn","||","jl",">=","jk","[","jr","]","[","0","]",")","{","jn","=","jk","[","jr","]","[","0","]",";","jo","=","jk","[","jr","]","[","1","]",";","}","}","else","if","(","jk","[","jr","]","[","0","]","<","0.0",")","{","jq","=","jo",";","jm","=","true",";","}","}","}","if","(","!","jm",")","jq","=","jo",";","float","js","=","(","jq","-","jo",")","/","(","jp","-","jn",")",";","return","jo","+","js","*","(","jl","-","jn",")",";","}",
"vec3","jF","(","float","ju",",","float","jv",",","vec4","jw","[","RAMPSIZE","]",")","{","if","(","jw","[","0","]","[","0","]","<","0.0",")","return","vec3","(","1.0",",","1.0",",","1.0",")",";","float","jx","=","ju","/","jv",";","bool","jy","=","false",";","float","jz","=","0.0",";","vec3","jA","=","jw","[","0","]",".","yzw",";","float","jB","=","1.0",";","vec3","jC","=","vec3","(","1.0",",","1.0",",","1.0",")",";","for","(","int","jD","=","0",";","jD","<","RAMPSIZE",";","jD","++",")","{","if","(",
"!","jy",")","{","if","(","jw","[","jD","]","[","0","]",">=","0.0",")","{","if","(","jx",">=","jz","&&","jx","<","jw","[","jD","]","[","0","]",")","{","jB","=","jw","[","jD","]","[","0","]",";","jC","=","jw","[","jD","]",".","yzw",";","jy","=","true",";","}","else","if","(","jx","<","jz","||","jx",">=","jw","[","jD","]","[","0","]",")","{","jz","=","jw","[","jD","]","[","0","]",";","jA","=","jw","[","jD","]",".","yzw",";","}","}","else","if","(","jw","[","jD","]","[","0","]","<","0.0",")","{","jC",
"=","jA",";","jy","=","true",";","}","}","}","if","(","!","jy",")","jC","=","jA",";","vec3","jE","=","(","jC","-","jA",")","/","(","jB","-","jz",")",";","return","jA","+","jE","*","(","jx","-","jz",")",";","}","float","jO","(","float","jG",",","float","jH",",","float","jI",",","float","jJ",")","{","float","jK","=","max","(","0.01",",","min","(","jH",",","jI",")",")",";","float","jL","=","max","(","0.01",",","min","(","jH",",","jJ",")",")",";","float","jM","=","jH","-","jL",";","float","jN","=","clamp",
"(","jG","/","jK",",","0.0",",","1.0",")","-","step","(","jM",",","jG",")","*","(","jG","-","jM",")","/","jL",";","return","jN",";","}"]}]},exports["include/depth_fetch.glslf"]={type:"group",parts:[{type:"textline",tokens:["float","kb","(","in","sampler2D","jV",",","in","vec2","jW",",","in","vec2","jX",")","{","float","jY","=","texture2D","(","jV",",","jW",")",".","r",";","float","jZ","=","jX",".","x",";","float","j_","=","jX",".","y",";","float","ka","=","2.0","*","jZ","/","(","jZ","+","j_","-",
"(","2.0","*","jY","-","1.0",")","*","(","j_","-","jZ",")",")",";","return","ka",";","}"]}]}};b4w.module["__geometry"]=function(exports,require){var m_print=require("__print");var m_tsr=require("__tsr");var m_util=require("__util");var m_ext=require("__extensions");var m_vec3=require("vec3");var MAX_SUBMESH_LENGTH=256*256;var COMB_SORT_JUMP_COEFF=1.247330950103979;var POS_NUM_COMP=3;var NOR_NUM_COMP=3;var TAN_NUM_COMP=4;var COL_NUM_COMP=3;var INFLUENCE_NUM_COMP=4;exports.ZSORT_DISABLED=10;exports.ZSORT_BACK_TO_FRONT=20;exports.ZSORT_FRONT_TO_BACK=30;exports.DM_TRIANGLES=10;exports.DM_POINTS=
20;exports.DM_DYNAMIC_TRIANGLES=30;exports.DM_DYNAMIC_POINTS=40;exports.DM_LINES=50;exports.DM_DEFAULT=exports.DM_TRIANGLES;var _gl=null;exports.setup_context=function(gl){_gl=gl};exports.delete_buffers=function(geometry_id){var buffers=_buffers[geometry_id];_gl.deleteBuffer(buffers.ibo);_gl.deleteBuffer(buffers.vbo);delete _buffers[geometry_id]};exports.submesh_to_bufs_data=function(submesh,zsort_type,draw_mode,vc_usage){if(is_long_submesh(submesh)&&is_indexed(submesh))submesh_drop_indices(submesh);
var indices=submesh.indices;var base_length=submesh.base_length;var va_frames=submesh.va_frames;var va_common={};for(var attr_name in submesh.va_common)if(!(attr_name in vc_usage)||vc_usage[attr_name].generate_buffer)va_common[attr_name]=submesh.va_common[attr_name];var bufs_data=generate_bufs_data_arrays(indices,va_frames,va_common,base_length);update_draw_mode(bufs_data,draw_mode);update_gl_buffers(bufs_data);if(zsort_type!=exports.ZSORT_DISABLED&&is_indexed(submesh)){var positions=va_frames[0]["a_position"];
bufs_data.info_for_z_sort_updates={median_cache:new Float32Array(indices.length),median_world_cache:new Float32Array(indices.length),dist_cache:new Float32Array(indices.length/3),type:zsort_type}}return bufs_data};exports.is_long_submesh=is_long_submesh;function is_long_submesh(submesh){var base_length=submesh.base_length;if(base_length>MAX_SUBMESH_LENGTH){if(m_ext.get_elem_index_uint())return false;return true}return false}exports.is_indexed=is_indexed;function is_indexed(submesh){if(submesh.indices.length>
0)return true;else return false}exports.submesh_drop_indices=submesh_drop_indices;function submesh_drop_indices(submesh,count,is_manually_dropped){count=count||1;if(!is_manually_dropped)m_print.log('%cDEBUG max vertices exceeded for indexed submesh "'+submesh.name+'": '+submesh.base_length*count+", will use drawArrays","color: #aa0");var indices=submesh.indices;var base_length=submesh.base_length;var va_common=submesh.va_common;var va_frames=submesh.va_frames;for(var name in va_common){var arr=va_common[name];
var nc=num_comp(arr,base_length);va_common[name]=expand_vertex_array_i(indices,arr,nc)}for(var i=0;i<va_frames.length;i++){var va_frame=va_frames[i];for(var name in va_frame){var arr=va_frame[name];var nc=num_comp(arr,base_length);va_frame[name]=expand_vertex_array_i(indices,arr,nc)}}submesh.base_length=indices.length;submesh.indices=new Uint16Array(0);return submesh}function expand_vertex_array_i(indices,vertex_array,num_comp){if(vertex_array.length==0)return new Float32Array(0);var len=indices.length*
num_comp;var new_vertex_array=new Float32Array(len);for(var i=0;i<indices.length;i++){var index=indices[i];for(var j=0;j<num_comp;j++)new_vertex_array[num_comp*i+j]=vertex_array[num_comp*index+j]}return new_vertex_array}exports.create_bufs_data=function(draw_mode,indices,count){var bufs_data={vbo_array:[],pointers:{}};update_draw_mode(bufs_data,draw_mode);if(bufs_data.mode==_gl.TRIANGLES){bufs_data.count=indices.length;bufs_data.ibo_array=indices;if(bufs_data.count<=MAX_SUBMESH_LENGTH)bufs_data.ibo_type=
_gl.UNSIGNED_SHORT;else bufs_data.ibo_type=_gl.UNSIGNED_INT}else if(bufs_data.mode==_gl.POINTS){bufs_data.count=count;bufs_data.ibo_array=null}return bufs_data};exports.update_bufs_data_array=function(bufs_data,attrib_name,num_comp,array){var vbo_array=bufs_data.vbo_array;var pointers=bufs_data.pointers;var pointer=pointers[attrib_name];if(pointer){if(num_comp&&pointer.num_comp!=num_comp)throw'Error: invalid num_comp for "'+attrib_name+'"';vbo_array.set(array,pointer.offset)}else{var len=vbo_array.length;
var vbo_array_new=new Float32Array(len+array.length);vbo_array_new.set(bufs_data.vbo_array);vbo_array_new.set(array,len);bufs_data.vbo_array=vbo_array_new;pointers[attrib_name]={num_comp:num_comp,offset:len}}update_gl_buffers(bufs_data);return bufs_data};exports.extract_array=extract_array;function extract_array(bufs_data,name){var vbo_array=bufs_data.vbo_array;var pointers=bufs_data.pointers;var pointer=pointers[name];if(pointer)return vbo_array.subarray(pointer.offset,pointer.offset+pointer.length);
else throw"extract_array() failed; invalid name: "+name;}function update_draw_mode(bufs_data,draw_mode){var mode;var usage;switch(draw_mode){case exports.DM_DEFAULT:case exports.DM_TRIANGLES:mode=_gl.TRIANGLES;usage=_gl.STATIC_DRAW;break;case exports.DM_POINTS:mode=_gl.POINTS;usage=_gl.STATIC_DRAW;break;case exports.DM_DYNAMIC_TRIANGLES:mode=_gl.TRIANGLES;usage=_gl.DYNAMIC_DRAW;break;case exports.DM_DYNAMIC_POINTS:mode=_gl.POINTS;usage=_gl.DYNAMIC_DRAW;break;case exports.DM_LINES:mode=_gl.LINES;usage=
_gl.STATIC_DRAW;break;default:throw"Wrong draw_mode";}bufs_data.mode=mode;bufs_data.usage=usage}exports.make_static=function(bufs_data){bufs_data.usage=_gl.STATIC_DRAW};exports.make_dynamic=function(bufs_data){bufs_data.usage=_gl.DYNAMIC_DRAW};function generate_bufs_data_arrays(indices,va_frames,va_common,base_length){if(indices.length){var count=indices.length;if(base_length<=MAX_SUBMESH_LENGTH){var ibo_array=new Uint16Array(indices);var ibo_type=_gl.UNSIGNED_SHORT}else{var ibo_array=new Uint32Array(indices);
var ibo_type=_gl.UNSIGNED_INT}}else{var count=base_length;var ibo_array=null}var vbo_array_length=calc_vbo_length(va_frames,va_common);var vbo_array=new Float32Array(vbo_array_length);var offset=0;var pointers={};for(var name in va_common){var arr=va_common[name];var len=arr.length;if(!len)continue;vbo_array.set(arr,offset);pointers[name]={attribute_name:name,num_comp:num_comp(arr,base_length),offset:offset,frames:1,length:len};offset+=len}var frames_count=va_frames.length;for(var name in va_frames[0]){var arr0=
va_frames[0][name];var len=arr0.length;var ncomp=num_comp(arr0,base_length);if(!len)continue;pointers[name]={num_comp:ncomp,offset:offset,frames:frames_count,length:len};if(frames_count>1)pointers[name+"_next"]={num_comp:ncomp,offset:offset+len,frames:frames_count,length:len};for(var i=0;i<frames_count;i++){var va_frame=va_frames[i];var arr=va_frame[name];vbo_array.set(arr,offset);offset+=len}}return{count:count,ibo_array:ibo_array,vbo_array:vbo_array,ibo_type:ibo_type,pointers:pointers}}function calc_vbo_length(va_frames,
va_common){var len=0;var frames_count=va_frames.length;for(var name in va_frames[0]){var arr=va_frames[0][name];len+=arr.length*frames_count}for(var name in va_common){var arr=va_common[name];len+=arr.length}return len}function update_gl_buffers(bufs_data){if(bufs_data.ibo_array){if(!bufs_data.ibo)bufs_data.ibo=_gl.createBuffer();_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo_array,bufs_data.usage);bufs_data.debug_ibo_bytes=bufs_data.ibo_array.byteLength}else bufs_data.debug_ibo_bytes=
0;if(!bufs_data.vbo)bufs_data.vbo=_gl.createBuffer();_gl.bindBuffer(_gl.ARRAY_BUFFER,bufs_data.vbo);_gl.bufferData(_gl.ARRAY_BUFFER,bufs_data.vbo_array,bufs_data.usage);bufs_data.debug_vbo_bytes=bufs_data.vbo_array.byteLength}exports.cleanup_bufs_data=function(bufs_data){if(bufs_data.ibo)_gl.deleteBuffer(bufs_data.ibo);if(bufs_data.vbo)_gl.deleteBuffer(bufs_data.vbo)};exports.has_empty_submesh=function(mesh,index){var bsub=mesh["submeshes"][index];if(bsub["base_length"])return false;else return true};
exports.submesh_apply_transform=submesh_apply_transform;function submesh_apply_transform(submesh,transform){var base_length=submesh.base_length;for(var f=0;f<submesh.va_frames.length;f++){var positions=submesh.va_frames[f]["a_position"];m_tsr.transform_vectors(positions,transform,positions,0);var normals=submesh.va_frames[f]["a_normal"];if(normals.length>0)m_tsr.transform_dir_vectors(normals,transform,normals,0);var tangents=submesh.va_frames[f]["a_tangent"];if(tangents.length>0)m_tsr.transform_tangents(tangents,
transform,tangents,0)}var au_center_pos=submesh.va_common["au_center_pos"];if(au_center_pos&&au_center_pos.length)m_tsr.transform_vectors(au_center_pos,transform,au_center_pos,0);return submesh}exports.submesh_apply_particle_transform=submesh_apply_particle_transform;function submesh_apply_particle_transform(submesh,transform){var au_center_pos=submesh.va_common["au_center_pos"];if(au_center_pos&&au_center_pos.length){var cen_pos_transformed=new Float32Array(au_center_pos);m_tsr.transform_vectors(cen_pos_transformed,
transform,cen_pos_transformed,0);for(var i=0;i<submesh.va_frames.length;i++)for(var j=0;j<cen_pos_transformed.length;j++)submesh.va_frames[i]["a_position"][j]+=cen_pos_transformed[j]-au_center_pos[j];au_center_pos.set(cen_pos_transformed)}else throw'Attribute "au_center_pos" is missing in particle submesh';return submesh}exports.submesh_apply_params=submesh_apply_params;function submesh_apply_params(submesh,params){var base_length=submesh.base_length;for(var param in params){var param_len=params[param].length;
var len=params[param].length*base_length;submesh.va_common[param]=new Float32Array(param_len*base_length);for(var i=0;i<base_length;i++)for(var j=0;j<param_len;j++)submesh.va_common[param][i*param_len+j]=params[param][j]}return submesh}function gen_buf_clone_source(source,n){var len=source.length;var new_buf=new Float32Array(len*n);for(var i=0;i<n;i++)for(var j=0;j<len;j++)new_buf[i*len+j]=source[j];return new_buf}exports.submesh_list_join=submesh_list_join;function submesh_list_join(submeshes){var submesh0=
submeshes[0];var new_submesh=submesh_list_join_prepare_dest(submeshes);var i_offset=0;var v_ind_offset=0;for(var i=0;i<submeshes.length;i++){var submesh=submeshes[i];var indices=submesh.indices;var base_length=submesh.base_length;var va_common=submesh.va_common;var va_frames=submesh.va_frames;for(var j=0;j<indices.length;j++){var ind=indices[j];new_submesh.indices[i_offset+j]=ind+v_ind_offset}i_offset+=indices.length;for(var param_name in va_common){var arr=va_common[param_name];var offset=v_ind_offset*
num_comp(arr,base_length);new_submesh.va_common[param_name].set(arr,offset)}for(var j=0;j<submesh.va_frames.length;j++){var va_frame=submesh.va_frames[j];var new_va_frame=new_submesh.va_frames[j];for(var param_name in va_frame){var arr=va_frame[param_name];var offset=v_ind_offset*num_comp(arr,base_length);new_va_frame[param_name].set(arr,offset)}}v_ind_offset+=base_length}return new_submesh}function submesh_list_join_prepare_dest(submeshes){var new_submesh=m_util.create_empty_submesh("JOIN_"+submeshes.length+
"_SUBMESHES");var len=0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].indices.length;new_submesh.indices=new Uint32Array(len);len=0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].base_length;new_submesh.base_length=len;var submesh0=submeshes[0];for(var param_name in submesh0.va_common){len=0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].va_common[param_name].length;new_submesh.va_common[param_name]=new Float32Array(len)}for(var param_name in submesh0.va_frames[0]){len=0;for(var i=
0;i<submeshes.length;i++)len+=submeshes[i].va_frames[0][param_name].length;for(var i=0;i<submesh0.va_frames.length;i++){new_submesh.va_frames[i]=new_submesh.va_frames[i]||{};new_submesh.va_frames[i][param_name]=new Float32Array(len)}}return new_submesh}exports.make_clone_submesh=function(src_submesh,params,transforms){if(!src_submesh.base_length)return m_util.create_empty_submesh("EMPTY");var count=transforms.length;if(src_submesh.base_length*count>MAX_SUBMESH_LENGTH&&!m_ext.get_elem_index_uint())submesh_drop_indices(src_submesh,
count);var indices=src_submesh.indices;var base_length=src_submesh.base_length;var va_common=src_submesh.va_common;var va_frames=src_submesh.va_frames;for(var param in params){var param_len=params[param].length;var len=param_len*base_length;va_common[param]=new Float32Array(len);for(var i=0;i<base_length;i++)for(var j=0;j<param_len;j++)va_common[param][i*param_len+j]=params[param][j]}var new_submesh=m_util.create_empty_submesh("CLONE_"+count+"_SUBMESHES");new_submesh.base_length=base_length*count;
new_submesh.indices=new Uint32Array(indices.length*count);for(var i=0;i<count;i++){var i_offset=indices.length*i;var v_offset=base_length*i;for(var j=0;j<indices.length;j++){var ind=indices[j];new_submesh.indices[i_offset+j]=ind+v_offset}}for(var param_name in va_common){var arr=va_common[param_name];var len=arr.length*count;var ncomp=num_comp(arr,base_length);new_submesh.va_common[param_name]=new Float32Array(len);for(var i=0;i<count;i++){var v_offset=base_length*ncomp*i;new_submesh.va_common[param_name].set(arr,
v_offset)}}for(var param_name in va_frames[0])for(var i=0;i<va_frames.length;i++){var arr=va_frames[i][param_name];var len=arr.length*count;var ncomp=num_comp(arr,base_length);new_submesh.va_frames[i]=new_submesh.va_frames[i]||{};new_submesh.va_frames[i][param_name]=new Float32Array(len);for(var j=0;j<count;j++){var transform=transforms[j];var v_offset=base_length*ncomp*j;switch(param_name){case "a_position":m_tsr.transform_vectors(arr,transform,new_submesh.va_frames[i][param_name],v_offset);break;
case "a_normal":m_tsr.transform_dir_vectors(arr,transform,new_submesh.va_frames[i][param_name],v_offset);break;case "a_tangent":m_tsr.transform_tangents(arr,transform,new_submesh.va_frames[i][param_name],v_offset);break;default:throw"Wrong attribute name: "+param_name;break}}}return new_submesh};exports.extract_submesh=extract_submesh;function extract_submesh(mesh,material_index,attr_names,bone_pointers,vertex_colors_usage,uv_maps_usage){var submesh=m_util.create_empty_submesh("SUBMESH_"+mesh["name"]+
"_"+material_index);var bsub=mesh["submeshes"][material_index];var base_length=bsub["base_length"];submesh.base_length=base_length;if(has_attr(attr_names,"a_texcoord"))var texcoords=new Float32Array(bsub["texcoord"]);else var texcoords=new Float32Array(0);var influences=extract_influences(attr_names,base_length,bone_pointers,bsub["group"]);if(vertex_colors_usage)var submesh_vc_usage=m_util.clone_object_r(vertex_colors_usage);else var submesh_vc_usage={};submesh_vc_usage["a_color"]={generate_buffer:true};
if(has_attr(attr_names,"a_color")&&mesh["active_vcol_name"])submesh_vc_usage["a_color"].src=[{name:mesh["active_vcol_name"],mask:7}];else submesh_vc_usage["a_color"].src=[];var va_common={"a_texcoord":texcoords,"a_influence":influences};extract_vcols(va_common,submesh_vc_usage,bsub["vertex_colors"],bsub["color"],base_length);assign_node_uv_maps(mesh["uv_textures"],bsub["texcoord"],bsub["texcoord2"],uv_maps_usage,base_length,va_common,mesh.name);submesh.va_common=va_common;submesh.indices=new Uint32Array(bsub["indices"]);
var frames=bsub["position"].length/base_length/POS_NUM_COMP;if(has_attr(attr_names,"a_normal")&&bsub["normal"].length)var use_normal=true;else var use_normal=false;if(use_normal&&(has_attr(attr_names,"a_tangent")&&bsub["tangent"].length))var use_tangent=true;else var use_tangent=false;for(var i=0;i<frames;i++){var va_frame={};var pos_arr=new Float32Array(base_length*POS_NUM_COMP);var nor_arr=new Float32Array(use_normal?base_length*NOR_NUM_COMP:0);var tan_arr=new Float32Array(use_tangent?base_length*
TAN_NUM_COMP:0);var from_index=i*base_length*POS_NUM_COMP;var to_index=from_index+base_length*POS_NUM_COMP;pos_arr.set(bsub["position"].subarray(from_index,to_index),0);if(use_normal){var from_index=i*base_length*NOR_NUM_COMP;var to_index=from_index+base_length*NOR_NUM_COMP;nor_arr.set(bsub["normal"].subarray(from_index,to_index),0)}if(use_tangent){var from_index=i*base_length*TAN_NUM_COMP;var to_index=from_index+base_length*TAN_NUM_COMP;tan_arr.set(bsub["tangent"].subarray(from_index,to_index),0)}va_frame["a_position"]=
pos_arr;va_frame["a_normal"]=nor_arr;va_frame["a_tangent"]=tan_arr;submesh.va_frames.push(va_frame)}if(frames>1){var va_frame0=submesh.va_frames[0];var va_frame={};for(var prop in va_frame0)va_frame[prop]=new Float32Array(va_frame0[prop]);submesh.va_frames.push(va_frame)}if(has_attr(attr_names,"a_polyindex")){submesh_drop_indices(submesh,1,true);submesh.va_common["a_polyindex"]=extract_polyindices(submesh)}return submesh}function extract_vcols(va_common,vc_usage,submesh_vc,bsub_color,base_length){var submesh_vc_names=
submesh_vc_get_names(submesh_vc);for(var attr_name in vc_usage){var colors_data=vc_usage[attr_name].src;if(colors_data.length){var dst_channels_count=0;for(var i=0;i<colors_data.length;i++)dst_channels_count+=m_util.rgb_mask_get_channels_count(colors_data[i].mask);va_common[attr_name]=new Float32Array(dst_channels_count*base_length);var dst_channel_index_offset=0;for(var i=0;i<colors_data.length;i++){var color_name=colors_data[i].name;var color_mask=colors_data[i].mask;var channels_presence=m_util.rgb_mask_get_channels_presence(color_mask);
var color_name_index=submesh_vc_names.indexOf(color_name);if(color_name_index==-1)throw'B4W Error: vertex color "'+color_name+'" not found';var mask_exported=submesh_vc[color_name_index]["mask"];var exported_channels_count=m_util.rgb_mask_get_channels_count(mask_exported);if((color_mask&mask_exported)!==color_mask)m_print.error("B4W Error: Wrong color extraction from "+color_name+" to "+attr_name+".");var exported_colors_offset=submesh_vc_get_offset(submesh_vc,color_name_index,base_length);for(var j=
0;j<base_length;j++)for(var k=0;k<COL_NUM_COMP;k++)if(channels_presence[k]){var dst_channel_index=dst_channel_index_offset+m_util.rgb_mask_get_channel_presence_index(color_mask,k);var exported_channel_index=m_util.rgb_mask_get_channel_presence_index(mask_exported,k);va_common[attr_name][j*dst_channels_count+dst_channel_index]=bsub_color[exported_colors_offset+j*exported_channels_count+exported_channel_index]}dst_channel_index_offset+=exported_channels_count}}else va_common[attr_name]=new Float32Array(0)}}
function submesh_vc_get_names(submesh_vc){var submesh_vc_names=[];for(var i=0;i<submesh_vc.length;i++)submesh_vc_names.push(submesh_vc[i]["name"]);return submesh_vc_names}function submesh_vc_get_offset(submesh_vc,vc_index,base_length){var offset=0;for(var i=0;i<vc_index;i++)offset+=m_util.rgb_mask_get_channels_count(submesh_vc[i]["mask"]);return offset*base_length}function assign_node_uv_maps(mesh_uvs,bsub_texcoord,bsub_texcoord2,uv_maps_usage,base_length,va_common,mesh_name){if(!uv_maps_usage)return;
for(var uv_name in uv_maps_usage){var uv_map_index=mesh_uvs.indexOf(uv_name);if(uv_map_index==-1)throw'B4W Error: uv map "'+uv_name+'" for mesh "'+mesh_name+'" not found';if(uv_map_index==0)var uv_node_arr=new Float32Array(bsub_texcoord);else if(uv_map_index==1)var uv_node_arr=new Float32Array(bsub_texcoord2);va_common[uv_maps_usage[uv_name]]=uv_node_arr}}exports.extract_halo_submesh=function(submesh){var base_length=submesh.base_length;var position_in=submesh.va_frames[0]["a_position"];var pos_arr=
new Float32Array(12*base_length);var bb_vert_arr=new Float32Array(8*base_length);var indices_out=new Uint16Array(4*submesh.indices.length);for(var i=0;i<base_length;i++){pos_arr[12*i]=position_in[3*i];pos_arr[12*i+1]=position_in[3*i+1];pos_arr[12*i+2]=position_in[3*i+2];pos_arr[12*i+3]=position_in[3*i];pos_arr[12*i+4]=position_in[3*i+1];pos_arr[12*i+5]=position_in[3*i+2];pos_arr[12*i+6]=position_in[3*i];pos_arr[12*i+7]=position_in[3*i+1];pos_arr[12*i+8]=position_in[3*i+2];pos_arr[12*i+9]=position_in[3*
i];pos_arr[12*i+10]=position_in[3*i+1];pos_arr[12*i+11]=position_in[3*i+2];bb_vert_arr[8*i]=-0.5;bb_vert_arr[8*i+1]=-0.5;bb_vert_arr[8*i+2]=-0.5;bb_vert_arr[8*i+3]=0.5;bb_vert_arr[8*i+4]=0.5;bb_vert_arr[8*i+5]=0.5;bb_vert_arr[8*i+6]=0.5;bb_vert_arr[8*i+7]=-0.5;indices_out[6*i]=4*i+2;indices_out[6*i+1]=4*i+1;indices_out[6*i+2]=4*i;indices_out[6*i+3]=4*i+2;indices_out[6*i+4]=4*i;indices_out[6*i+5]=4*i+3}var halo_submesh=m_util.create_empty_submesh("HALO");halo_submesh.va_frames=[];halo_submesh.va_frames[0]=
{};halo_submesh.base_length=4*base_length;halo_submesh.va_frames[0]["a_position"]=pos_arr;halo_submesh.va_common["a_halo_bb_vertex"]=bb_vert_arr;halo_submesh.indices=indices_out;return halo_submesh};exports.has_attr=has_attr;function has_attr(attr_names,name){if(attr_names.indexOf(name)>-1)return true;else return false}exports.extract_submesh_all_mats=function(mesh,attr_names){var submeshes=[];for(var i=0;i<mesh["submeshes"].length;i++){var submesh=extract_submesh(mesh,i,attr_names,null,null,null);
if(submesh.base_length)submeshes.push(submesh)}if(submeshes.length==0)var submesh_all=m_util.create_empty_submesh("EMPTY");else if(submeshes.length==1)var submesh_all=submeshes[0];else var submesh_all=submesh_list_join(submeshes);return submesh_all};function extract_influences(attr_names,base_length,bone_pointers,groups){if(has_attr(attr_names,"a_influence")&&bone_pointers){var influences=new Float32Array(base_length*INFLUENCE_NUM_COMP);var groups_num=groups.length/base_length;var deform_bone_indices=
get_deform_bone_indices(bone_pointers,groups_num);var buf_length=groups_num>3?groups_num:4;var weights_buf=new Float32Array(buf_length);var bones_buf=new Uint32Array(buf_length);var res_buf=new Float32Array(INFLUENCE_NUM_COMP);var zero_weights=new Float32Array(buf_length);var zero_bones=new Uint32Array(buf_length);var zero_res=new Float32Array(INFLUENCE_NUM_COMP);for(var i=0;i<base_length;i++){weights_buf.set(zero_weights);bones_buf.set(zero_bones);res_buf.set(zero_res);influences.set(get_vertex_influences(groups,
groups_num,i,base_length,deform_bone_indices,weights_buf,bones_buf,res_buf),i*INFLUENCE_NUM_COMP)}}else var influences=new Float32Array(0);return influences}function get_deform_bone_indices(bone_pointers,groups_num){var deform_bone_indices=new Float32Array(groups_num);for(var i=0;i<groups_num;i++){deform_bone_indices[i]=-1;for(var j in bone_pointers){var bone_pointer=bone_pointers[j];if(bone_pointer.vgroup_index===i){deform_bone_indices[i]=bone_pointer.deform_bone_index;break}}}return deform_bone_indices}
function get_vertex_influences(vertex_groups,groups_num,vert_index,base_length,deform_bone_indices,weights_buf,bones_buf,res_buf){var precision=0.01;var no_weights=true;for(var i=0;i<groups_num;i++){var weight=vertex_groups[i*base_length+vert_index];if(weight!==-1){var bone_index=deform_bone_indices[i];if(bone_index!==-1){weights_buf[i]=weight;bones_buf[i]=bone_index;no_weights=false}}}if(no_weights)return res_buf;sort_two_arrays(weights_buf,bones_buf);var sum_weights=0;for(var i=0;i<INFLUENCE_NUM_COMP;i++)sum_weights+=
weights_buf[i];if(sum_weights<precision)return res_buf;for(var i=0;i<INFLUENCE_NUM_COMP;i++)weights_buf[i]/=sum_weights;if(Math.abs(weights_buf[0]-1)<precision)res_buf[0]=bones_buf[0]+1;else for(var i=0;i<INFLUENCE_NUM_COMP;i++)res_buf[i]=bones_buf[i]+weights_buf[i];return res_buf}function num_comp(array,base_length){if(base_length==0)return 0;var array_length=array.length;var factor=array_length/base_length;if(factor!=Math.floor(factor))throw"Array size mismatch during geometry calculation: array length="+
array_length+", base length="+base_length;return factor}exports.update_buffers_movable=function(bufs_data,world_matrix,eye){var indices=bufs_data.ibo_array;var positions=extract_array(bufs_data,"a_position");var zinfo=bufs_data.info_for_z_sort_updates;var median_cache=zinfo.median_cache;var median_world_cache=zinfo.median_world_cache;var dist_cache=zinfo.dist_cache;var sort_back_to_front=zinfo.sort_back_to_front;compute_triangle_medians(indices,positions,median_cache);m_util.positions_multiply_matrix(median_cache,
world_matrix,median_world_cache);compute_triangle_dists(median_cache,eye,dist_cache);var indices=sort_triangles(dist_cache,indices);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,indices,_gl.DYNAMIC_DRAW)};function compute_triangle_medians(indices,positions,medians){var num_faces=indices.length/3;for(var i=0;i<num_faces;i++){var index0=indices[3*i];var index1=indices[3*i+1];var index2=indices[3*i+2];var pos00=positions[3*index0];var pos01=positions[3*
index0+1];var pos02=positions[3*index0+2];var pos10=positions[3*index1];var pos11=positions[3*index1+1];var pos12=positions[3*index1+2];var pos20=positions[3*index2];var pos21=positions[3*index2+1];var pos22=positions[3*index2+2];medians[3*i]=(pos00+pos10+pos20)/3;medians[3*i+1]=(pos01+pos11+pos21)/3;medians[3*i+2]=(pos02+pos12+pos22)/3}return medians}function compute_triangle_dists(medians,eye,dists){var len=medians.length/3;for(var i=0;i<len;i++){var dx=medians[3*i]-eye[0];var dy=medians[3*i+1]-
eye[1];var dz=medians[3*i+2]-eye[2];dists[i]=dx*dx+dy*dy+dz*dz}return dists}function sort_triangles(dists,indices){var dlen=dists.length;if(dlen<2)return indices;var gap=dlen;var swapped=false;var t;while(gap>1||swapped){if(gap>1)gap=Math.floor(gap/COMB_SORT_JUMP_COEFF);swapped=false;for(var i=0;gap+i<dlen;i++)if(dists[i]-dists[i+gap]<0){t=dists[i];dists[i]=dists[i+gap];dists[i+gap]=t;swap_indices(indices,i,i+gap);swapped=true}}return indices}exports.sort_two_arrays=sort_two_arrays;function sort_two_arrays(main_arr,
extra_arr,ascending){var arr_length=main_arr.length;var gap=arr_length;var swapped=false;var tmp;var order_factor=ascending==1?-1:1;while(gap>1||swapped){if(gap>1)gap=Math.floor(gap/COMB_SORT_JUMP_COEFF);swapped=false;for(var i=0;gap+i<arr_length;i++)if(order_factor*(main_arr[i]-main_arr[i+gap])<0){tmp=main_arr[i];main_arr[i]=main_arr[i+gap];main_arr[i+gap]=tmp;tmp=extra_arr[i];extra_arr[i]=extra_arr[i+gap];extra_arr[i+gap]=tmp;swapped=true}}}function swap_indices(indices,pos1,pos2){var t0=indices[3*
pos1];var t1=indices[3*pos1+1];var t2=indices[3*pos1+2];indices[3*pos1]=indices[3*pos2];indices[3*pos1+1]=indices[3*pos2+1];indices[3*pos1+2]=indices[3*pos2+2];indices[3*pos2]=t0;indices[3*pos2+1]=t1;indices[3*pos2+2]=t2}exports.calc_normals=function(indices,positions,shared_indices){var num_vertices=positions.length/POS_NUM_COMP;var num_faces=indices.length/3;var normals=[];var pos0=new Array(3);var pos1=new Array(3);var pos2=new Array(3);for(var i=0;i<num_faces;i++){var index0=indices[3*i];var index1=
indices[3*i+1];var index2=indices[3*i+2];for(var j=0;j<POS_NUM_COMP;j++){pos0[j]=positions[POS_NUM_COMP*index0+j];pos1[j]=positions[POS_NUM_COMP*index1+j];pos2[j]=positions[POS_NUM_COMP*index2+j]}if(shared_indices){var angle0=angle(pos0,pos1,pos2);var angle1=angle(pos1,pos2,pos0);var angle2=Math.PI-angle0-angle1}else{var angle0=1;var angle1=1;var angle2=1}calc_normal_for_face(index0,index1,index2,pos0,pos1,pos2,angle0,angle1,angle2,normals)}if(shared_indices)smooth_normals(shared_indices,normals);
for(var i=0;i<num_vertices;i++)normalize_normal(i,normals);return normals};function angle(pos,pos1,pos2){var vec1=[];var vec2=[];m_vec3.subtract(pos1,pos,vec1);m_vec3.subtract(pos2,pos,vec2);m_vec3.normalize(vec1,vec1);m_vec3.normalize(vec2,vec2);return Math.acos(m_vec3.dot(vec1,vec2))}function calc_normal_for_face(index0,index1,index2,pos0,pos1,pos2,angle0,angle1,angle2,dest){var normal=calc_normal_by_pos(pos0,pos1,pos2);for(var i=0;i<NOR_NUM_COMP;i++){var i0=NOR_NUM_COMP*index0+i;var i1=NOR_NUM_COMP*
index1+i;var i2=NOR_NUM_COMP*index2+i;dest[i0]=angle0*normal[i];dest[i1]=angle1*normal[i];dest[i2]=angle2*normal[i]}}function calc_normal_by_pos(pos0,pos1,pos2){var vec1=[],vec2=[],normal=[];m_vec3.subtract(pos1,pos0,vec1);m_vec3.subtract(pos2,pos0,vec2);m_vec3.cross(vec1,vec2,normal);m_vec3.normalize(normal,normal);return normal}function smooth_normals(shared_indices,normals){for(var i in shared_indices){var indices=shared_indices[i];for(var j=0;j<NOR_NUM_COMP;j++){var offset0=NOR_NUM_COMP*indices[0]+
j;for(var k=1;k<indices.length;k++){var offset=NOR_NUM_COMP*indices[k]+j;normals[offset0]+=normals[offset]}for(var k=1;k<indices.length;k++){var offset=NOR_NUM_COMP*indices[k]+j;normals[offset]=normals[offset0]}}}}function normalize_normal(i,normals){var normal=new Float32Array(NOR_NUM_COMP);for(var j=0;j<NOR_NUM_COMP;j++){var index=NOR_NUM_COMP*i+j;normal[j]=normals[index]}m_vec3.normalize(normal,normal);for(var j=0;j<NOR_NUM_COMP;j++){var index=NOR_NUM_COMP*i+j;normals[index]=normal[j]}}exports.calc_shared_indices=
calc_shared_indices;function calc_shared_indices(indices,shared_locations,locations){var sh_loc_set={};var len=shared_locations.length/3;for(var i=0;i<len;i++){var key=String(shared_locations[3*i])+String(shared_locations[3*i+1])+String(shared_locations[3*i+2]);sh_loc_set[key]=[]}var len=indices.length;for(var i=0;i<len;i++){var index=indices[i];var key=String(locations[3*index])+String(locations[3*index+1])+String(locations[3*index+2]);if(key in sh_loc_set)sh_loc_set[key].push(index)}return sh_loc_set}
exports.geometry_random_points=function(submesh,n,process_normals,seed){var triangles=extract_triangles(submesh,null,false);if(process_normals)var triangles_n=extract_triangles(submesh,null,true);var tnum=triangles.length;var areas=new Float32Array(tnum);for(var i=0;i<tnum;i++){var tri=triangles[i];areas[i]=triangle_area(tri)}var cumulative_areas=new Float32Array(tnum);cumulative_areas[0]=areas[0];for(var i=1;i<tnum;i++)cumulative_areas[i]=cumulative_areas[i-1]+areas[i];var geom_area=cumulative_areas[areas.length-
1];var points=[];for(var i=0;i<n;i++){var area=geom_area*m_util.rand_r(seed);var tri_index=m_util.binary_search_max(cumulative_areas,area,0,cumulative_areas.length-1);if(process_normals)var tri=triangles_n[tri_index];else var tri=triangles[tri_index];points[i]=triangle_random_point(tri,seed)}return points};exports.extract_triangles=extract_triangles;function extract_triangles(submesh,dest,process_normals){if(!dest)var dest=[];if(process_normals)var positions=submesh.va_frames[0]["a_normal"];else var positions=
submesh.va_frames[0]["a_position"];if(is_indexed(submesh)){var indices=submesh.indices;var tnum=indices.length/3;for(var i=0;i<tnum;i++){var tri=new Float32Array(9);var i0=indices[3*i];tri[0]=positions[3*i0];tri[1]=positions[3*i0+1];tri[2]=positions[3*i0+2];var i1=indices[3*i+1];tri[3]=positions[3*i1];tri[4]=positions[3*i1+1];tri[5]=positions[3*i1+2];var i2=indices[3*i+2];tri[6]=positions[3*i2];tri[7]=positions[3*i2+1];tri[8]=positions[3*i2+2];dest[i]=tri}}else{var tnum=positions.length/9;for(var i=
0;i<positions.length;i++){var tri=new Float32Array(9);tri[0]=positions[9*i];tri[1]=positions[9*i+1];tri[2]=positions[9*i+2];tri[3]=positions[9*i+3];tri[4]=positions[9*i+4];tri[5]=positions[9*i+5];tri[6]=positions[9*i+6];tri[7]=positions[9*i+7];tri[8]=positions[9*i+8];dest[i]=tri}}return dest}exports.extract_polyindices=extract_polyindices;function extract_polyindices(submesh){var polyindices=new Float32Array(submesh.base_length);for(var i=0;i<submesh.base_length;i++)polyindices[i]=i%3;return polyindices}
function triangle_area(triangle){var pos0=new Float32Array([triangle[0],triangle[1],triangle[2]]);var pos1=new Float32Array([triangle[3],triangle[4],triangle[5]]);var pos2=new Float32Array([triangle[6],triangle[7],triangle[8]]);var a=m_vec3.dist(pos0,pos1);var b=m_vec3.dist(pos0,pos2);var c=m_vec3.dist(pos1,pos2);var s=(a+b+c)/2;var t=Math.sqrt(s*(s-a)*(s-b)*(s-c));return t}function triangle_random_point(triangle,seed,dest){if(!dest)var dest=new Float32Array(3);var x0=triangle[0];var y0=triangle[1];
var z0=triangle[2];var x1=triangle[3];var y1=triangle[4];var z1=triangle[5];var x2=triangle[6];var y2=triangle[7];var z2=triangle[8];var w1=m_util.rand_r(seed);var w2=m_util.rand_r(seed);if(w1+w2>1){w1=1-w1;w2=1-w2}var w0=1-w1-w2;var x=w0*x0+w1*x1+w2*x2;var y=w0*y0+w1*y1+w2*y2;var z=w0*z0+w1*z1+w2*z2;dest[0]=x;dest[1]=y;dest[2]=z;return dest}exports.scale_submesh_xyz=function(submesh,scale,center){var positions=submesh.va_frames[0]["a_position"];for(var i=0;i<positions.length;i+=3){positions[i]=(positions[i]-
center[0])*scale[0]+center[0];positions[i+1]=(positions[i+1]-center[1])*scale[1]+center[1];positions[i+2]=(positions[i+2]-center[2])*scale[2]+center[2]}}};b4w.module["__particles"]=function(exports,require){var m_cfg=require("__config");var m_geom=require("__geometry");var m_util=require("__util");var m_vec3=require("vec3");var cfg_ani=m_cfg.animation;var STDGRAVITY=9.81;var DELAYRANDFACTOR=10;var _rand=function(){throw"_rand() undefined";};var _wind=[0,0,0];exports.has_particles=function(obj){if(obj["particle_systems"].length>0)return true;else return false};exports.has_anim_particles=function(obj){for(var i=0;i<obj["particle_systems"].length;i++){var psettings=
obj["particle_systems"][i]["settings"];if(psettings["type"]=="EMITTER")return true}return false};exports.has_hair_particles=function(obj){for(var i=0;i<obj["particle_systems"].length;i++){var psettings=obj["particle_systems"][i]["settings"];if(psettings["type"]=="HAIR")return true}return false};exports.has_dynamic_grass_particles=function(obj){for(var i=0;i<obj["particle_systems"].length;i++){var psettings=obj["particle_systems"][i]["settings"];if(psettings["type"]=="HAIR"&&psettings["b4w_dynamic_grass"])return true}return false};
exports.generate_emitter_particles_submesh=function(batch,emitter_mesh,psystem,pmaterial,world_matrix){psystem._internal=psystem._internal||{};var emitter_submesh=m_geom.extract_submesh_all_mats(emitter_mesh,["a_position","a_normal"],false);var pcount=psystem["settings"]["count"];var time_start=psystem["settings"]["frame_start"]/cfg_ani.framerate;var time_end=psystem["settings"]["frame_end"]/cfg_ani.framerate;var lifetime=psystem["settings"]["lifetime"]/cfg_ani.framerate;var lifetime_random=psystem["settings"]["lifetime_random"];
var emit_from=psystem["settings"]["emit_from"];var vel_factor_rand=psystem["settings"]["factor_random"];var ang_vel_mode=psystem["settings"]["angular_velocity_mode"];var ang_vel_factor=psystem["settings"]["angular_velocity_factor"];var is_rand_delay=psystem["settings"]["b4w_randomize_emission"];init_particle_rand(psystem["seed"]);if(pmaterial["halo"])var is_billboard=false;else var is_billboard=true;if(is_billboard){var bb_vertices=gen_bb_vertices(pcount);var bb_indices=gen_bb_indices(pcount)}var pos_norm=
distribute_positions_normals(pcount,emit_from,emitter_submesh,is_billboard);var positions=pos_norm[0];var normals=pos_norm[1];psystem._internal.positions=new Float32Array(positions);psystem._internal.normals=new Float32Array(normals);psystem._internal.positions_cache=new Float32Array(positions.length);psystem._internal.normals_cache=new Float32Array(normals.length);pose_emitter(positions,normals,world_matrix,positions,normals);var maxdelay=time_end-time_start;var delay_attrs=gen_delay_attrs(pcount,
maxdelay,is_rand_delay,is_billboard);psystem._internal.delay_attrs=new Float32Array(delay_attrs);var lifetimes=gen_lifetimes(pcount,lifetime,lifetime_random,is_billboard);var vels=gen_velocities(pcount,vel_factor_rand,ang_vel_mode,ang_vel_factor,is_billboard);var submesh=m_util.create_empty_submesh("EMITTER_PARTICLES");var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=positions;va_frame["a_normal"]=normals;submesh.va_frames[0]=va_frame;if(is_billboard)submesh.indices=bb_indices;else{batch.draw_mode=
m_geom.DM_POINTS;submesh.indices=new Uint16Array(0)}submesh.base_length=positions.length/3;submesh.va_common["a_p_delay"]=delay_attrs;submesh.va_common["a_p_lifetime"]=lifetimes;submesh.va_common["a_p_vels"]=vels;if(is_billboard)submesh.va_common["a_p_bb_vertex"]=bb_vertices;set_emitter_particles_uniforms(batch,psystem,pmaterial);return submesh};function pose_emitter(positions,normals,world_matrix,positions_new,normals_new){m_util.positions_multiply_matrix(positions,world_matrix,positions_new,0);
m_util.vectors_multiply_matrix(normals,world_matrix,normals_new,0)}exports.update_emitter_transform=function(obj){var batches=obj._batches;for(var i=0;i<batches.length;i++){var batch=batches[i];var psys=batches[i].particle_system;if(!psys)continue;var pbuf=batch.bufs_data;var pcache=psys._internal.positions_cache;var ncache=psys._internal.normals_cache;pose_emitter(psys._internal.positions,psys._internal.normals,obj._render.world_matrix,pcache,ncache);m_geom.make_dynamic(pbuf);m_geom.update_bufs_data_array(pbuf,
"a_position",3,pcache);m_geom.update_bufs_data_array(pbuf,"a_normal",3,ncache)}};exports.update_emitter_animation=function(obj){var batches=obj._batches;for(var i=0;i<batches.length;i++){var batch=batches[i];var psys=batches[i].particle_system;if(!psys)continue;var pbuf=batch.bufs_data;var positions=psys._internal.positions;var normals=psys._internal.normals;var delay_attrs=psys._internal.delay_attrs;var time_start=psys["settings"]["frame_start"]/cfg_ani.framerate;var trans=obj._anim.trans;var quats=
obj._anim.quats;if(!(trans&&quats))continue;animate_pos_norm(positions,normals,delay_attrs,time_start,trans,quats);m_geom.make_dynamic(pbuf);m_geom.update_bufs_data_array(pbuf,"a_position",3,positions);m_geom.update_bufs_data_array(pbuf,"a_normal",3,normals);m_geom.update_bufs_data_array(pbuf,"a_p_delay",1,delay_attrs)}};function animate_pos_norm(positions,normals,delay_attrs,time_start,trans,quats){for(var i=0;i<positions.length;i+=3){var pos=[positions[i],positions[i+1],positions[i+2]];var norm=
[normals[i],normals[i+1],normals[i+2]];var time=delay_attrs[i/3]+time_start;var ff=time*cfg_ani.framerate;var frame=Math.floor(ff);var frame_next=frame+1;var frame_factor=ff-frame;var tran,quat;if(trans.length>0&&(frame>=0&&frame<trans.length-1)){tran=m_util.blend_arrays(trans[frame],trans[frame_next],frame_factor);quat=m_util.blend_arrays(quats[frame],quats[frame_next],frame_factor)}else{tran=[0,0,0];quat=[0,0,0,1]}var pos_new=[];var norm_new=[];m_vec3.transformQuat(pos,quat,pos_new);m_vec3.transformQuat(norm,
quat,norm_new);positions[i]=pos_new[0]+tran[0];positions[i+1]=pos_new[1]+tran[1];positions[i+2]=pos_new[2]+tran[2];normals[i]=norm_new[0];normals[i+1]=norm_new[1];normals[i+2]=norm_new[2]}}function set_emitter_particles_uniforms(batch,psystem,pmaterial){var lifetime=psystem["settings"]["lifetime"]/cfg_ani.framerate;var time_start=psystem["settings"]["frame_start"]/cfg_ani.framerate;var time_end=psystem["settings"]["frame_end"]/cfg_ani.framerate;var nfactor=psystem["settings"]["normal_factor"];var bfactor=
psystem["settings"]["brownian_factor"];var gravity=psystem["settings"]["effector_weights"]["gravity"]*STDGRAVITY;var wind=psystem["settings"]["effector_weights"]["wind"];var mass=psystem["settings"]["mass"];var fade_in=psystem["settings"]["b4w_fade_in"]/cfg_ani.framerate;var fade_out=psystem["settings"]["b4w_fade_out"]/cfg_ani.framerate;var cyclic=psystem["settings"]["b4w_cyclic"];batch.p_starttime=time_start;batch.p_endtime=time_end;batch.p_cyclic=cyclic?1:0;batch.p_nfactor=nfactor;batch.p_gravity=
gravity;var glob_wind=exports.wind();batch.p_wind=new Float32Array([glob_wind[0]*wind,glob_wind[1]*wind,glob_wind[2]*wind]);batch.p_max_lifetime=lifetime;batch.p_mass=mass;batch.p_fade_in=fade_in;batch.p_fade_out=fade_out;var psize;var alpha_start;var alpha_end;if(pmaterial["halo"]){psize=pmaterial["halo"]["size"];var hardness=pmaterial["halo"]["hardness"];if(hardness<30){var alpha_start=0.5;var alpha_end=0.9}else if(hardness<40){var alpha_start=0.1;var alpha_end=1}else if(hardness<50){var alpha_start=
0;var alpha_end=0.8}else{var alpha_start=0;var alpha_end=0.5}}else{psize=psystem["settings"]["particle_size"];alpha_start=1;alpha_end=1}batch.p_size=psize;batch.p_alpha_start=alpha_start;batch.p_alpha_end=alpha_end;var tex_slot=psystem["settings"]["texture_slots"];var sramp_varr=[-1,0,-1,0,-1,0,-1,0];if(tex_slot[0]&&(tex_slot[0]["use_map_size"]&&(tex_slot[0]["texture"]&&(tex_slot[0]["texture"]["type"]=="BLEND"&&tex_slot[0]["texture"]["use_color_ramp"])))){var color_ramp_elems=tex_slot[0]["texture"]["color_ramp"]["elements"];
var rlen=Math.min(color_ramp_elems.length*2,sramp_varr.length);for(var i=0;i<rlen;i+=2){var rel=color_ramp_elems[i/2];sramp_varr[i]=rel["position"];var intensity=(rel["color"][0]+rel["color"][1]+rel["color"][2])/3;sramp_varr[i+1]=intensity}}batch.p_size_ramp=new Float32Array(sramp_varr);var m_tex_slot=pmaterial["texture_slots"];var cramp_varr=[-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0];if(m_tex_slot[0]&&(m_tex_slot[0]["texture_coords"]=="STRAND"&&(m_tex_slot[0]["texture"]&&(m_tex_slot[0]["texture"]["type"]==
"BLEND"&&m_tex_slot[0]["texture"]["use_color_ramp"])))){var color_ramp_elems=m_tex_slot[0]["texture"]["color_ramp"]["elements"];var rlen=Math.min(color_ramp_elems.length*4,cramp_varr.length);for(var i=0;i<rlen;i+=4){var rel=color_ramp_elems[i/4];cramp_varr[i]=rel["position"];cramp_varr[i+1]=rel["color"][0];cramp_varr[i+2]=rel["color"][1];cramp_varr[i+3]=rel["color"][2]}pmaterial["texture_slots"]=[]}batch.p_color_ramp=new Float32Array(cramp_varr)}function init_particle_rand(seed){if(seed){m_util.srand(seed);
_rand=function(){return m_util.rand()}}else _rand=function(){return Math.random()}}function gen_bb_vertices(pcount){var bbv=[];for(var i=0;i<pcount;i++)bbv.push(-0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,-0.5);var bb_vertices=new Float32Array(bbv);return bb_vertices}function gen_bb_indices(pcount){var bbi=[];for(var i=0;i<pcount;i++)bbi.push(4*i,4*i+2,4*i+1,4*i,4*i+3,4*i+2);var bb_indices=new Uint16Array(bbi);return bb_indices}function distribute_positions_normals(pcount,emit_from,emitter_submesh,is_billboard){switch(emit_from){case "VERT":var ecoords=
emitter_submesh.va_frames[0]["a_position"];var encoords=emitter_submesh.va_frames[0]["a_normal"];var pindices=gen_pindices(pcount,ecoords,is_billboard);var positions=gen_positions(pindices,ecoords);var normals=gen_normals(pindices,encoords);break;case "FACE":var positions=[];var normals=[];var seed=[];m_util.init_rand_r_seed(0,seed);var rand_pos=m_geom.geometry_random_points(emitter_submesh,pcount,false,seed);m_util.init_rand_r_seed(0,seed);var rand_norm=m_geom.geometry_random_points(emitter_submesh,
pcount,true,seed);for(var i=0;i<rand_pos.length;i++){positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2]);if(is_billboard){positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2]);positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2]);positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2])}normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2]);if(is_billboard){normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2]);normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2]);
normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2])}}var positions=new Float32Array(positions);var normals=new Float32Array(normals);break;case "VOLUME":throw"Particle emission from volume is not supported";break;default:throw"Wrong emit from option";break}return[positions,normals]}function gen_pindices(pcount,ecoords,is_billboard){var vcount=ecoords.length/3;var indices=[];for(var i=0;i<pcount;i++){var vrand=Math.round((vcount-1)*_rand());indices.push(vrand);if(is_billboard){indices.push(vrand);
indices.push(vrand);indices.push(vrand)}}return indices}function gen_positions(indices,ecoords){var parr=[];for(var i=0;i<indices.length;i++){parr.push(ecoords[3*indices[i]]);parr.push(ecoords[3*indices[i]+1]);parr.push(ecoords[3*indices[i]+2])}var positions=new Float32Array(parr);return positions}function gen_normals(indices,encoords){var narr=[];for(var i=0;i<indices.length;i++){narr.push(encoords[3*indices[i]]);narr.push(encoords[3*indices[i]+1]);narr.push(encoords[3*indices[i]+2])}var normals=
new Float32Array(narr);return normals}function gen_delay_attrs(pcount,maxdelay,random,is_billboard){var darr=[];var delayint=maxdelay/pcount;for(var i=0;i<pcount;i++){var delay;if(random)delay=delayint*i+DELAYRANDFACTOR*delayint*(0.5-_rand());else delay=delayint*i;darr.push(delay);if(is_billboard){darr.push(delay);darr.push(delay);darr.push(delay)}}var delay_attrs=new Float32Array(darr);return delay_attrs}function gen_lifetimes(pcount,lifetime,lifetime_random,is_billboard){var larr=[];var delta=lifetime*
lifetime_random;for(var i=0;i<pcount;i++){var delta_rand=delta*_rand();larr.push(lifetime-delta_rand);if(is_billboard){larr.push(lifetime-delta_rand);larr.push(lifetime-delta_rand);larr.push(lifetime-delta_rand)}}var lifetimes=new Float32Array(larr);return lifetimes}function gen_velocities(pcount,vel_factor_rand,ang_vel_mode,ang_vel_factor,is_billboard){var varr=[];for(var i=0;i<pcount;i++){var vvec=[_rand()-0.5,_rand()-0.5,_rand()-0.5];m_vec3.normalize(vvec,vvec);varr.push(vel_factor_rand*vvec[0]);
varr.push(vel_factor_rand*vvec[1]);varr.push(vel_factor_rand*vvec[2]);switch(ang_vel_mode){case "NONE":varr.push(0);break;case "SPIN":case "VELOCITY":varr.push(ang_vel_factor);break;case "RAND":varr.push(ang_vel_factor*2*(_rand()-0.5));break;default:throw"Undefined velocity factor";}if(is_billboard){var last=varr.slice(-4);for(var j=0;j<12;j++)varr.push(last[j%4])}}var vels=new Float32Array(varr);return vels}exports.prepare_lens_flares=function(submesh){var base_length=submesh.base_length;var sub_pos=
submesh.va_frames[0]["a_position"];var sub_tco=submesh.va_common["a_texcoord"];var bb_dist_arr=[];var bb_vert_arr=[];for(var i=0;i<base_length;i++){bb_vert_arr.push(sub_pos[3*i]);bb_vert_arr.push(sub_pos[3*i+1]);bb_dist_arr.push(sub_pos[3*i+2])}var bb_dist_arr=new Float32Array(bb_dist_arr);var bb_vert_arr=new Float32Array(bb_vert_arr);submesh.va_common["a_lf_dist"]=bb_dist_arr;submesh.va_common["a_lf_bb_vertex"]=bb_vert_arr;submesh.va_common["a_texcoord"]=sub_tco;return submesh};exports.update_force=
function(obj){var field=obj["field"];if(field["type"]=="WIND"){var render=obj._render;m_util.quat_to_dir(render.quat,m_util.AXIS_Y,_wind);_wind=m_vec3.normalize(_wind,_wind);m_vec3.scale(_wind,render.force_strength,_wind)}};exports.wind=function(){return _wind};exports.cleanup=function(){_wind[0]=0;_wind[1]=0;_wind[2]=0}};b4w.module["__primitives"]=function(exports,require){var geometry=require("__geometry");var util=require("__util");exports.generate_lines=function(num){var submesh=util.create_empty_submesh("LINE");var points=[];for(var i=0;i<num*2;i++)points.push(i);var va_frame=util.create_empty_va_frame();va_frame["a_point"]=new Float32Array(points);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array(points);submesh.base_length=num*2;return submesh};exports.generate_plane=function(x_size,z_size){var grid_submesh=
generate_grid(2,2,x_size,z_size);grid_submesh.name="PLANE";return grid_submesh};exports.generate_grid=generate_grid;function generate_grid(x_subdiv,z_subdiv,x_size,z_size){var indices=[];var positions=[];var normals=[];var texcoords=[];var delta_x=2*x_size/(x_subdiv-1);var delta_z=2*z_size/(z_subdiv-1);for(var i=0;i<x_subdiv;i++){var x=-x_size+i*delta_x;for(var j=0;j<z_subdiv;j++){var z=-z_size+j*delta_z;positions.push(x,0,z);normals.push(0,1,0);texcoords.push(i/(x_subdiv-1),j/(z_subdiv-1));if(i&&
j){var idx0=i*z_subdiv+j;var idx1=idx0-1;var idx2=(i-1)*z_subdiv+j;var idx3=idx2-1;indices.push(idx0,idx1,idx2);indices.push(idx1,idx3,idx2)}}}var va_frame=util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);va_frame["a_normal"]=new Float32Array(normals);var submesh=util.create_empty_submesh("GRID_PLANE");submesh.va_frames[0]=va_frame;submesh.va_common["a_texcoord"]=new Float32Array(texcoords);submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/
3;return submesh}exports.generate_multigrid=function(num_cascads,subdivs,detailed_dist){var min_casc_size=detailed_dist/Math.pow(2,num_cascads-1);var x_size=min_casc_size;var z_size=min_casc_size;var x_subdiv=subdivs+1;var z_subdiv=subdivs+1;var indices=[];var positions=[];var cascad_steps=[];var prev_x=0;var prev_z=0;var last_added_ind=-1;function is_merged_vertex(i,j){if(i%2==1&&(j==0||j==z_subdiv-1)||j%2==1&&(i==0||i==x_subdiv-1))return true;else return false}var prev_utmost_verts=[];for(var c=
0;c<num_cascads;c++){var delta_x=2*x_size/(x_subdiv-1);var delta_z=2*z_size/(z_subdiv-1);var cur_utmost_verts=[];var casc_indices=[];var all_skipped=0;for(var i=0;i<x_subdiv;i++){var x=-x_size+i*delta_x;var indices_in_row=[];for(var j=0;j<z_subdiv;j++){var z=-z_size+j*delta_z;if(!(x>-prev_x&&(x<prev_x&&(z>-prev_z&&z<prev_z)))){var coinciding_ind=null;for(var k=0;k<prev_utmost_verts.length;k+=3)if(x==prev_utmost_verts[k]&&z==prev_utmost_verts[k+1]){coinciding_ind=prev_utmost_verts[k+2];break}if(coinciding_ind!==
null)var idx0=coinciding_ind;else var idx0=last_added_ind+1;if(!is_merged_vertex(i,j)){if(coinciding_ind==null){if((j==0||j==z_subdiv-1||(i==0||i==x_subdiv-1))&&c!=num_cascads-1){cascad_steps.push(2*delta_x);cur_utmost_verts.push(x,z,idx0)}else cascad_steps.push(delta_x);positions.push(x,0,z);last_added_ind++}indices_in_row.push(idx0)}else{indices_in_row.push(-2);all_skipped++}if(i&&j)if(i==1)if(is_merged_vertex(i-1,j))if(j>1){var idx1=idx0-1;var idx2=casc_indices[i-1][j+1];var idx3=idx2-1;indices.push(idx0,
idx1,idx3);indices.push(idx0,idx3,idx2)}else{var idx2=casc_indices[i-1][j+1];var idx3=idx2-1;indices.push(idx0,idx3,idx2)}else{if(!is_merged_vertex(i,j)){var idx1=idx0-1;var idx2=casc_indices[i-1][j];indices.push(idx0,idx1,idx2)}}else if(i==x_subdiv-1){if(!is_merged_vertex(i,j))if(j==z_subdiv-1){var idx1=idx0-1;var idx2=casc_indices[i-1][j-1];var idx3=casc_indices[i-2][j];indices.push(idx0,idx1,idx2);indices.push(idx0,idx2,idx3)}else{var idx1=idx0-1;var idx2=casc_indices[i-1][j];var idx3=idx2-1;var idx4=
idx2+1;indices.push(idx0,idx1,idx3);indices.push(idx0,idx3,idx2);indices.push(idx0,idx2,idx4);if(j==2){idx4=casc_indices[i-2][j-2];indices.push(idx1,idx4,idx3)}}}else if(j==1)if(!is_merged_vertex(i,j-1)){var idx1=indices_in_row[j-1];var idx2=casc_indices[i-1][j];var idx3=casc_indices[i-2][j-1];indices.push(idx0,idx1,idx2);indices.push(idx1,idx3,idx2)}else{var idx1=casc_indices[i-1][j];var idx2=casc_indices[i-1][j-1];indices.push(idx0,idx2,idx1)}else if(j==z_subdiv-1){if(!is_merged_vertex(i,j)){var idx1=
indices_in_row[j-1];var idx2=casc_indices[i-1][j-1];var idx3=casc_indices[i-2][j];indices.push(idx0,idx1,idx2);indices.push(idx0,idx2,idx3)}}else if(casc_indices[i-1][j]!=-1&&(casc_indices[i-1][j-1]!=-1&&indices_in_row[j-1]!=-1)){var idx1=indices_in_row[j-1];var idx2=casc_indices[i-1][j];var idx3=casc_indices[i-1][j-1];indices.push(idx0,idx1,idx2);indices.push(idx1,idx3,idx2);if(j==z_subdiv-2&&is_merged_vertex(i,j+1)){var idx4=casc_indices[i-1][j+1];indices.push(idx0,idx2,idx4)}}else if(j==z_subdiv-
2&&is_merged_vertex(i,j+1)){var idx2=casc_indices[i-1][j];var idx4=casc_indices[i-1][j+1];indices.push(idx0,idx2,idx4)}}else{indices_in_row.push(-1);all_skipped++}}casc_indices.push(indices_in_row)}prev_utmost_verts=cur_utmost_verts;prev_x=x_size;prev_z=z_size;x_size*=2;z_size*=2}var required_mesh_size=2E4;if(prev_x<required_mesh_size){var x=-required_mesh_size;positions.push(-required_mesh_size,-1,-required_mesh_size);positions.push(-required_mesh_size,-1,required_mesh_size);positions.push(-prev_x,
-1,-prev_z);positions.push(-prev_x,-1,prev_z);positions.push(required_mesh_size,-1,-required_mesh_size);positions.push(required_mesh_size,-1,required_mesh_size);positions.push(prev_x,-1,-prev_z);positions.push(prev_x,-1,prev_z);var idx0=last_added_ind+1;indices.push(idx0+3,idx0+2,idx0+1,idx0+2,idx0+0,idx0+1,idx0+6,idx0+4,idx0+2,idx0+4,idx0+0,idx0+2,idx0+5,idx0+7,idx0+1,idx0+7,idx0+3,idx0+1,idx0+5,idx0+4,idx0+7,idx0+7,idx0+4,idx0+6);var delta_x=2*prev_x/(x_subdiv-1);for(var i=0;i<8;i++)cascad_steps.push(-delta_x)}var va_frame=
util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);va_frame["a_cascad_step"]=new Float32Array(cascad_steps);var submesh=util.create_empty_submesh("multigrid_plane");submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;return submesh};exports.generate_from_triangles=function(verts){var len=verts.length;if(len%3)throw"Wrong array";var indices=[];var positions=[];for(var i=0;i<len;i+=3){var v1=verts[i];var v2=verts[i+
1];var v3=verts[i+2];add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);indices.push(i,i+1,i+2)}var va_frame=util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);var submesh=util.create_empty_submesh("FROM_TRIANGLES");submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;return submesh};exports.generate_from_quads=generate_from_quads;function generate_from_quads(verts){var len=
verts.length;if(len%4)throw"Wrong array";var indices=[];var positions=[];for(var i=0;i<len;i+=4){var v1=verts[i];var v2=verts[i+1];var v3=verts[i+2];var v4=verts[i+3];add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);add_vec3_to_array(v4,positions);indices.push(i,i+1,i+2);indices.push(i,i+2,i+3)}var va_frame=util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);var submesh=util.create_empty_submesh("FROM_QUADS");submesh.va_frames[0]=
va_frame;submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;return submesh}exports.generate_frustum=function(corners){var corners=util.vectorize(corners,[]);var quads=[];quads.push(corners[0],corners[1],corners[2],corners[3]);quads.push(corners[0],corners[3],corners[5],corners[4]);quads.push(corners[3],corners[2],corners[6],corners[5]);quads.push(corners[1],corners[7],corners[6],corners[2]);quads.push(corners[0],corners[4],corners[7],corners[1]);quads.push(corners[4],
corners[5],corners[6],corners[7]);var submesh=generate_from_quads(quads);submesh.name="FRUSTUM";return submesh};function generate_fullscreen_quad(){var attr_arrays={};var NINES=0.9999;attr_arrays["indices"]=[0,2,1,1,2,3];attr_arrays["a_position"]=[-1,1,NINES,1,1,NINES,-1,-1,NINES,1,-1,NINES];attr_arrays["a_normal"]=[];attr_arrays["a_texcoord"]=[];attr_arrays["a_influence"]=[];attr_arrays["a_color"]=[];return attr_arrays}exports.generate_billboard=function(){var submesh=util.create_empty_submesh("BILLBOARD");
var va_frame=util.create_empty_va_frame();va_frame["a_bb_vertex"]=new Float32Array([-0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,-0.5]);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,2,1,0,3,2]);submesh.base_length=4;return submesh};exports.generate_cube=function(){var submesh=util.create_empty_submesh("CUBEMAP_BOARD");var va_frame=util.create_empty_va_frame();va_frame["a_position"]=new Float32Array([-1,-1,-1,1,1,1,1,-1]);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,2,1,0,
3,2]);submesh.base_length=4;return submesh};exports.generate_uv_sphere=function(segments,rings,size,center,use_smooth,use_wireframe){var submesh=util.create_empty_submesh("UV_SPHERE");var x,y;var positions=[];var grid_positions=[];var indices=[];for(y=0;y<=rings;y++)for(x=0;x<=segments;x++){var u=x/segments;var v=y/rings;var xpos=-size*Math.cos(u*2*Math.PI)*Math.sin(v*Math.PI);var ypos=size*Math.cos(v*Math.PI);var zpos=size*Math.sin(u*2*Math.PI)*Math.sin(v*Math.PI);if(use_smooth){var edge=1E-5;xpos=
Math.abs(xpos)<edge?0:xpos;ypos=Math.abs(ypos)<edge?0:ypos;zpos=Math.abs(zpos)<edge?0:zpos}grid_positions.push(xpos+center[0],ypos+center[1],zpos+center[2])}var v_index=0;for(y=0;y<rings;y++)for(x=0;x<segments;x++){var v1=extract_vec3(grid_positions,(segments+1)*y+x+1);var v2=extract_vec3(grid_positions,(segments+1)*y+x);var v3=extract_vec3(grid_positions,(segments+1)*(y+1)+x);var v4=extract_vec3(grid_positions,(segments+1)*(y+1)+x+1);if(Math.abs(v1[1])==size+center[1]){add_vec3_to_array(v1,positions);
add_vec3_to_array(v3,positions);add_vec3_to_array(v4,positions);if(use_wireframe)indices.push(v_index,v_index+1,v_index+1,v_index+2,v_index+2,v_index);else indices.push(v_index,v_index+1,v_index+2);v_index+=3}else if(Math.abs(v3[1])==size+center[1]){add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);if(use_wireframe)indices.push(v_index,v_index+1,v_index+1,v_index+2,v_index+2,v_index);else indices.push(v_index,v_index+1,v_index+2);v_index+=3}else{add_vec3_to_array(v1,
positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);add_vec3_to_array(v4,positions);if(use_wireframe){indices.push(v_index,v_index+1);indices.push(v_index+1,v_index+2);indices.push(v_index+2,v_index+3);indices.push(v_index+3,v_index)}else{indices.push(v_index,v_index+1,v_index+2);indices.push(v_index,v_index+2,v_index+3)}v_index+=4}}var va_frame={};va_frame["a_position"]=positions;if(use_wireframe)va_frame["a_normal"]=[];else{var shared_indices=geometry.calc_shared_indices(indices,
grid_positions,positions);va_frame["a_normal"]=geometry.calc_normals(indices,positions,shared_indices)}va_frame["a_tangent"]=[];submesh.va_common["a_influence"]=[];submesh.va_common["a_color"]=[];submesh.va_common["a_texcoord"]=[];submesh.va_frames[0]=va_frame;submesh.indices=indices;submesh.base_length=positions.length/3;return submesh};function extract_vec3(array,position){var offset=position*3;var x=array[offset];var y=array[offset+1];var z=array[offset+2];return[x,y,z]}function add_vec3_to_array(vec,
array){array.push(vec[0],vec[1],vec[2])}};b4w.module["__prerender"]=function(exports,require){var config=require("__config");var debug=require("__debug");var m_geom=require("__geometry");var m_vec3=require("vec3");var util=require("__util");var cfg_def=config.defaults;var USE_FRUSTUM_CULLING=true;var USE_LOD_TRANSITION=false;var SUBS_UPDATE_DO_RENDER=["MAIN_OPAQUE","MAIN_BLEND","MAIN_REFLECT","SHADOW_CAST","DEPTH","GLOW_MASK","WIREFRAME"];exports.prerender_subs=function(subs){if(SUBS_UPDATE_DO_RENDER.indexOf(subs.type)>-1){var has_render_bundles=
false;var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];prerender_bundle(bundle,subs);if(bundle.do_render)has_render_bundles=true}var cam=subs.camera;switch(subs.type){case "WIREFRAME":break;default:if(subs.type==="MAIN_OPAQUE"||(subs.type==="DEPTH"||has_render_bundles))subs.do_render=true;else subs.do_render=false;break}}if(subs.type=="MAIN_BLEND")zsort(subs)};function zsort(subs){var eye=subs.camera.eye;if(m_vec3.dist(eye,subs.zsort_eye_last)>cfg_def.alpha_sort_threshold){if(!cfg_def.alpha_sort||
!subs.bundles)return;for(var i=0;i<subs.bundles.length;i++){var bundle=subs.bundles[i];var batch=bundle.batch;var world_matrix=bundle.obj_render.world_matrix;if(batch&&(batch.blend&&batch.zsort_type!=m_geom.ZSORT_DISABLED)){var bufs_data=batch.bufs_data;if(!bufs_data||!bundle.do_render)continue;var info=bufs_data.info_for_z_sort_updates;if(info&&info.type==m_geom.ZSORT_BACK_TO_FRONT)m_geom.update_buffers_movable(bufs_data,world_matrix,eye)}}subs.zsort_eye_last[0]=eye[0];subs.zsort_eye_last[1]=eye[1];
subs.zsort_eye_last[2]=eye[2]}}function prerender_bundle(bundle,subs){var obj_render=bundle.obj_render;var cam=subs.camera;bundle.do_render=true;obj_render.is_visible=false;if(!obj_render){bundle.do_render=false;return}if(obj_render.hide){bundle.do_render=false;return}if(!is_lod_visible(obj_render,cam)){bundle.do_render=false;return}obj_render.is_visible=true;if(subs.type=="GLOW_MASK"&&!Boolean(bundle.batch.glow_intensity)){bundle.do_render=false;return}if(USE_FRUSTUM_CULLING&&is_out_of_frustum(obj_render,
cam.frustum_planes)){bundle.do_render=false;return}if(subs.type=="WIREFRAME")if(bundle.batch.wireframe_mode==debug.WIREFRAME_MODES["WM_DEBUG_SPHERES"])bundle.do_render=bundle.batch.debug_sphere;else bundle.do_render=!bundle.batch.debug_sphere}function is_out_of_frustum(obj_render,planes){if(obj_render.do_not_cull)return false;if(obj_render.type==="STATIC"){var bs=obj_render.bs_world;var pt=bs.center;var radius=bs.radius;var is_out=util.sphere_is_out_of_frustum(pt,planes,radius)}else{var be=obj_render.be_world;
var pt=be.center;var axis_x=be.axis_x;var axis_y=be.axis_y;var axis_z=be.axis_z;var is_out=util.ellipsoid_is_out_of_frustum(pt,planes,axis_x,axis_y,axis_z)}return is_out}function is_lod_visible(obj_render,camera){var eye=camera.eye;var center=obj_render.bs_world.center;var dist_min=obj_render.lod_dist_min;var dist_max=obj_render.lod_dist_max;if(USE_LOD_TRANSITION&&obj_render.last_lod)dist_max+=obj_render.bs_world.radius;var dist=Math.sqrt((center[0]-eye[0])*(center[0]-eye[0])+(center[1]-eye[1])*(center[1]-
eye[1])+(center[2]-eye[2])*(center[2]-eye[2]));var tr_int=USE_LOD_TRANSITION?cfg_def.lod_transition_interval:0;if(dist>=Math.max(0,dist_min-tr_int)&&dist<dist_max)return true;else return false}};b4w.module["__print"]=function(exports,require){var _verbose=false;var _error_count=0;var _warning_count=0;exports.set_verbose=function(v){_verbose=v};exports.log=function(){if(_verbose)console.log.apply(console,arguments)};exports.error=function(){_error_count++;console.error.apply(console,arguments)};exports.warn=function(){if(_verbose){_warning_count++;console.warn.apply(console,arguments)}};exports.time=function(){if(_verbose)console.time.apply(console,arguments)};exports.timeEnd=function(){if(_verbose)console.timeEnd.apply(console,
arguments)};exports.group=function(){if(_verbose)console.group.apply(console,arguments)};exports.groupCollapsed=function(){if(_verbose)console.groupCollapsed.apply(console,arguments)};exports.groupEnd=function(){if(_verbose)console.groupEnd.apply(console,arguments)};exports.clear=function(){if(typeof console.clear=="function")console.clear.apply(console,arguments)};exports.get_warning_count=function(){return _warning_count};exports.get_error_count=function(){return _error_count};exports.clear_errors_warnings=
function(){_warning_count=0;_error_count=0}};b4w.module["print"]=b4w.module["__print"];b4w.module["__reformer"]=function(exports,require){var m_bounds=require("__boundings");var m_curve=require("__curve");var m_print=require("__print");var m_util=require("__util");var m_vec3=require("vec3");var m_vec4=require("vec4");var m_quat=require("quat");var m_mat4=require("mat4");var REPORT_COMPATIBILITY_ISSUES=true;var _unreported_compat_issues=false;exports.check_bpy_data=function(bpy_data){var check_modifier=function(mod,obj){switch(mod["type"]){case "ARRAY":if(!("fit_type"in mod)){report_modifier(mod["type"],
obj);return false}break;default:break}return true};var worlds=bpy_data["worlds"];if(worlds.length==0){report_missing_datablock("world");var world={"name":"DEFAULT","horizon_color":[0,0,0],"zenith_color":[0,0,0],"light_settings":{"use_environment_light":false,"environment_energy":1,"environment_color":"PLAIN"},"b4w_fog_color":[0.5,0.5,0.5],"b4w_fog_density":0};worlds.push(world)}var worlds=bpy_data["worlds"];for(var i=0;i<worlds.length;i++){var world=worlds[i];var ssao=world["b4w_ssao_settings"];if(!("dist_factor"in
ssao)){report("world",world,"b4w_ssao_settings.dist_factor");ssao["dist_factor"]=0;ssao["samples"]=16}if(!("b4w_glow_color"in world)){world["b4w_glow_color"]=new Float32Array(3);world["b4w_glow_color"]=[1,1,1];report("object",world,"b4w_glow_color")}if(!("b4w_glow_factor"in world)){world["b4w_glow_factor"]=1;report("object",world,"b4w_glow_factor")}if(!("b4w_fog_density"in world)){report("world",world,"b4w_fog_density");world["b4w_fog_density"]=0}if(!("b4w_sky_settings"in world)||!("rayleigh_brightness"in
world["b4w_sky_settings"])){report("world",world,"rayleigh_brightness");world["b4w_sky_settings"]={"color":[0.24,0.43,0.75],"rayleigh_brightness":3.3,"mie_brightness":0.1,"spot_brightness":10,"scatter_strength":0.2,"rayleigh_strength":0.2,"mie_strength":0.006,"rayleigh_collection_power":0.5,"mie_collection_power":0.5,"mie_distribution":0.4}}if(!("b4w_bloom_settings"in world)){report("world",world,"b4w_bloom_settings");world["b4w_bloom_settings"]={"key":0.2,"blur":4}}else{if(!("blur"in world["b4w_bloom_settings"])){report("world",
world,"b4w_bloom_settings.blur");world["b4w_bloom_settings"]["blur"]=4}if(!("edge_lum"in world["b4w_bloom_settings"])){report("world",world,"b4w_bloom_settings.edge_lum");world["b4w_bloom_settings"]["edge_lum"]=1}}if(!("b4w_motion_blur_settings"in world)){report("world",world,"b4w_motion_blur_settings");world["b4w_motion_blur_settings"]={"motion_blur_factor":0.01,"motion_blur_decay_threshold":0.01}}else{if(!("motion_blur_factor"in world["b4w_motion_blur_settings"])){report("world",world,"b4w_motion_blur_settings.motion_blur_factor");
world["b4w_motion_blur_settings"]["motion_blur_factor"]=0.01}if(!("motion_blur_decay_threshold"in world["b4w_motion_blur_settings"])){report("world",world,"b4w_motion_blur_settings.motion_blur_decay_threshold");world["b4w_motion_blur_settings"]["motion_blur_decay_threshold"]=0.01}}if(!("b4w_color_correction_settings"in world)){report("world",world,"b4w_color_correction_settings");world["b4w_color_correction_settings"]={"brightness":0,"contrast":0,"exposure":1,"saturation":1}}if(!("steps_per_pass"in
world["b4w_god_rays_settings"])){report("world",world,"b4w_god_rays_settings.steps_per_pass");world["b4w_god_rays_settings"]["steps_per_pass"]=10}}var scenes=bpy_data["scenes"];for(var i=0;i<scenes.length;i++){var scene=scenes[i];if(!("b4w_use_nla"in scene)){scene["b4w_use_nla"]=false;report("scene",scene,"b4w_use_nla")}if(!("b4w_nla_cyclic"in scene)){scene["b4w_nla_cyclic"]=false;report("scene",scene,"b4w_nla_cyclic")}if("b4w_detect_collisions"in scene){report_deprecated("scene",scene,"b4w_detect_collisions");
delete scene["b4w_detect_collisions"]}if(!("audio_doppler_speed"in scene))scene["audio_doppler_speed"]=343.3;if(!("audio_doppler_factor"in scene))scene["audio_doppler_factor"]=1;if(!("b4w_dynamic_compressor_settings"in scene)){scene["b4w_dynamic_compressor_settings"]={"threshold":-24,"knee":30,"ratio":12,"attack":0.003,"release":0.25};report("scene",scene,"b4w_dynamic_compressor_settings")}if(!("b4w_enable_convolution_engine"in scene))scene["b4w_enable_convolution_engine"]=false;if(!("b4w_enable_bloom"in
scene)){scene["b4w_enable_bloom"]=false;report("scene",scene,"b4w_enable_bloom")}if(!("b4w_enable_motion_blur"in scene)){scene["b4w_enable_motion_blur"]=false;report("scene",scene,"b4w_enable_motion_blur")}if(!("b4w_enable_color_correction"in scene)){scene["b4w_enable_color_correction"]=false;report("scene",scene,"b4w_enable_color_correction")}if(!("b4w_enable_antialiasing"in scene)){scene["b4w_enable_antialiasing"]=true;report("scene",scene,"b4w_enable_antialiasing")}}var meshes=bpy_data["meshes"];
for(var i=0;i<meshes.length;i++){var mesh=meshes[i];if(!mesh["b4w_bounding_box"]){report("mesh",mesh,"b4w_bounding_box");mesh["b4w_bounding_box"]={"max_x":0,"max_y":0,"max_z":0,"min_x":0,"min_y":0,"min_z":0}}if(!mesh["uv_textures"]){report("mesh",mesh,"uv_textures");mesh["uv_textures"]=[]}if(!mesh["b4w_bounding_sphere_center"])mesh["b4w_bounding_sphere_center"]=[0,0,0];if(!mesh["b4w_bounding_cylinder_center"])mesh["b4w_bounding_cylinder_center"]=[0,0,0];if(!mesh["b4w_bounding_ellipsoid_center"])mesh["b4w_bounding_ellipsoid_center"]=
[0,0,0];if(!mesh["b4w_bounding_ellipsoid_axes"]){var bb=mesh["b4w_bounding_box"];mesh["b4w_bounding_ellipsoid_axes"]=[(bb["max_x"]-bb["min_x"])/2,(bb["max_y"]-bb["min_y"])/2,(bb["max_z"]-bb["min_z"])/2]}}var cameras=bpy_data["cameras"];for(var i=0;i<cameras.length;i++){var camera=cameras[i];if(!camera["type"]){camera["type"]="PERSP";report("camera",camera,"type")}if("b4w_eye_target_dist"in camera){delete camera["b4w_eye_target_dist"];report_deprecated("camera",camera,"b4w_eye_target_dist")}if(!("b4w_use_distance_limits"in
camera)){camera["b4w_use_distance_limits"]=false;report("camera",camera,"b4w_use_distance_limits")}if(!("b4w_distance_min"in camera)){camera["b4w_distance_min"]=1;report("camera",camera,"b4w_distance_min")}if(!("b4w_distance_max"in camera)){camera["b4w_distance_max"]=100;report("camera",camera,"b4w_distance_max")}if(!("b4w_use_vertical_clamping"in camera)){camera["b4w_use_vertical_clamping"]=false;report("camera",camera,"b4w_use_vertical_clamping")}if(!("b4w_rotation_down_limit"in camera)){camera["b4w_rotation_down_limit"]=
Math.PI/2;report("camera",camera,"b4w_rotation_down_limit")}if(!("b4w_rotation_up_limit"in camera)){camera["b4w_rotation_up_limit"]=Math.PI/2;report("camera",camera,"b4w_rotation_up_limit")}}var lamps=bpy_data["lamps"];for(var i=0;i<lamps.length;i++){var lamp=lamps[i];if(!("b4w_generate_shadows"in lamp)){lamp["b4w_generate_shadows"]=false;report("lamp",lamp,"b4w_generate_shadows")}if(!("b4w_dynamic_intensity"in lamp)){lamp["b4w_dynamic_intensity"]=false;report("lamp",lamp,"b4w_dynamic_intensity")}}var speakers=
bpy_data["speakers"];for(var i=0;i<speakers.length;i++){var speaker=speakers[i];if(!("b4w_behavior"in speaker))if(speaker["b4w_background_music"])speaker["b4w_behavior"]="BACKGROUND_SOUND";else speaker["b4w_behavior"]="POSITIONAL";if(!("b4w_disable_doppler"in speaker))speaker["b4w_disable_doppler"]=false;if(!("b4w_delay"in speaker))speaker["b4w_delay"]=0;if(!("b4w_delay_random"in speaker))speaker["b4w_delay_random"]=0;if(!("b4w_volume_random"in speaker))speaker["b4w_volume_random"]=0;if(!("b4w_pitch_random"in
speaker))speaker["b4w_pitch_random"]=0;if(!("b4w_fade_in"in speaker))speaker["b4w_fade_in"]=0;if(!("b4w_fade_out"in speaker))speaker["b4w_fade_out"]=0;if(!("b4w_loop"in speaker))speaker["b4w_loop"]=false;if(!("b4w_loop_count"in speaker))speaker["b4w_loop_count"]=0;if(!("b4w_loop_count_random"in speaker))speaker["b4w_loop_count_random"]=0;if(!("b4w_playlist_id"in speaker))speaker["b4w_playlist_id"]=""}var textures=bpy_data["textures"];for(var i=0;i<textures.length;i++){var texture=textures[i];if(!("b4w_anisotropic_filtering"in
texture)){texture["b4w_anisotropic_filtering"]="OFF";report("texture",texture,"b4w_anisotropic_filtering")}if(!("b4w_water_foam"in texture)){texture["b4w_water_foam"]=false;report("texture",texture,"b4w_water_foam")}if(!("b4w_foam_uv_freq"in texture)){texture["b4w_foam_uv_freq"]=0;report("texture",texture,"b4w_foam_uv_freq")}if(!("b4w_foam_uv_magnitude"in texture)){texture["b4w_foam_uv_magnitude"]=0;report("texture",texture,"b4w_foam_uv_magnitude")}if(!("b4w_foam_uv_magnitude"in texture)){texture["b4w_foam_uv_magnitude"]=
0;report("texture",texture,"b4w_foam_uv_magnitude")}if(!("b4w_parallax_steps"in texture)){texture["b4w_parallax_steps"]=5;report("material",texture,"b4w_parallax_steps")}if(!("b4w_shore_dist_map"in texture)){texture["b4w_shore_dist_map"]=false;report("texture",texture,"b4w_shore_dist_map")}if(!("b4w_shore_boundings"in texture)){texture["b4w_shore_boundings"]=new Float32Array(4);texture["b4w_shore_boundings"]=[1E3,-1E3,1E3,-1E3];report("texture",texture,"b4w_shore_boundings")}if(!("b4w_max_shore_dist"in
texture)){texture["b4w_max_shore_dist"]=100;report("texture",texture,"b4w_max_shore_dist")}if(!("b4w_disable_compression"in texture)){texture["b4w_disable_compression"]=false;report("texture",texture,"b4w_disable_compression")}}var materials=bpy_data["materials"];for(var i=0;i<materials.length;i++){var mat=materials[i];if("b4w_node_mat_type"in mat)report_deprecated("material",mat,"b4w_node_mat_type");if(mat["b4w_water"]){if(!("b4w_water_shore_smoothing"in mat)){mat["b4w_water_shore_smoothing"]=false;
report("material",mat,"b4w_water_shore_smoothing")}if(!("b4w_water_dynamic"in mat)){mat["b4w_water_dynamic"]=false;report("material",mat,"b4w_water_dynamic")}if(!("b4w_waves_height"in mat)){mat["b4w_waves_height"]=1;report("material",mat,"b4w_waves_height")}if(!("b4w_waves_length"in mat)){mat["b4w_waves_length"]=1;report("material",mat,"b4w_waves_length")}if(!("b4w_water_dst_noise_scale0"in mat)){mat["b4w_water_dst_noise_scale0"]=0.05;report("material",mat,"b4w_water_dst_noise_scale0")}if(!("b4w_water_dst_noise_scale1"in
mat)){mat["b4w_water_dst_noise_scale1"]=0.03;report("material",mat,"b4w_water_dst_noise_scale1")}if(!("b4w_water_dst_noise_freq0"in mat)){mat["b4w_water_dst_noise_freq0"]=1.3;report("material",mat,"b4w_water_dst_noise_freq0")}if(!("b4w_water_dst_noise_freq1"in mat)){mat["b4w_water_dst_noise_freq1"]=1;report("material",mat,"b4w_water_dst_noise_freq1")}if(!("b4w_water_dir_min_shore_fac"in mat)){mat["b4w_water_dir_min_shore_fac"]=0.4;report("material",mat,"b4w_water_dir_min_shore_fac")}if(!("b4w_water_dir_freq"in
mat)){mat["b4w_water_dir_freq"]=0.5;report("material",mat,"b4w_water_dir_freq")}if(!("b4w_water_dir_noise_scale"in mat)){mat["b4w_water_dir_noise_scale"]=0.05;report("material",mat,"b4w_water_dir_noise_scale")}if(!("b4w_water_dir_noise_freq"in mat)){mat["b4w_water_dir_noise_freq"]=0.07;report("material",mat,"b4w_water_dir_noise_freq")}if(!("b4w_water_dir_min_noise_fac"in mat)){mat["b4w_water_dir_min_noise_fac"]=0.5;report("material",mat,"b4w_water_dir_min_noise_fac")}if(!("b4w_water_dst_min_fac"in
mat)){mat["b4w_water_dst_min_fac"]=0.2;report("material",mat,"b4w_water_dst_min_fac")}if(!("b4w_water_waves_hor_fac"in mat)){mat["b4w_water_waves_hor_fac"]=5;report("material",mat,"b4w_water_waves_hor_fac")}if(!("b4w_water_absorb_factor"in mat)){mat["b4w_water_absorb_factor"]=6;report("material",mat,"b4w_water_absorb_factor")}if(!("b4w_water_fog_color"in mat)){mat["b4w_water_fog_color"]=new Float32Array(3);mat["b4w_water_fog_color"]=[0.5,0.7,0.7];report("material",mat,"b4w_water_fog_color")}if(!("b4w_foam_factor"in
mat)){mat["b4w_foam_factor"]=5;report("material",mat,"b4w_foam_factor")}if(!("b4w_generated_mesh"in mat)){mat["b4w_generated_mesh"]=false;report("material",mat,"b4w_generated_mesh")}if(!("b4w_water_num_cascads"in mat)){mat["b4w_water_num_cascads"]=5;report("material",mat,"b4w_water_num_cascads")}if(!("b4w_water_subdivs"in mat)){mat["b4w_water_subdivs"]=64;report("material",mat,"b4w_water_subdivs")}if(!("b4w_water_detailed_dist"in mat)){mat["b4w_water_detailed_dist"]=1E3;report("material",mat,"b4w_water_detailed_dist")}}if(!("b4w_dynamic_grass_size"in
mat))mat["b4w_dynamic_grass_size"]="";if(!("b4w_dynamic_grass_color"in mat))mat["b4w_dynamic_grass_color"]="";if(!("diffuse_intensity"in mat)){mat["diffuse_intensity"]=1;report("material",mat,"diffuse_intensity")}if(!("b4w_procedural_skydome"in mat)){mat["b4w_procedural_skydome"]=false;report("material",mat,"b4w_procedural_skydome")}if(!("b4w_use_ghost"in mat))mat["b4w_use_ghost"]=false;if(!("b4w_collision_group"in mat)){mat["b4w_collision_group"]=128;report("material",mat,"b4w_collision_group")}if(!("b4w_collision_mask"in
mat)){mat["b4w_collision_mask"]=127;report("material",mat,"b4w_collision_mask")}if(mat.type=="HALO"&&!("b4w_halo_sky_stars"in mat)){mat["b4w_halo_sky_stars"]=false;report("material",mat,"b4w_halo_sky_stars")}if(mat.type=="HALO"&&!("b4w_halo_stars_blend_height"in mat)){mat["b4w_halo_stars_blend_height"]=10;report("material",mat,"b4w_halo_stars_blend_height")}if(mat.type=="HALO"&&!("b4w_halo_stars_min_height"in mat)){mat["b4w_halo_stars_min_height"]=0;report("material",mat,"b4w_halo_stars_min_height")}if(!("specular_shader"in
mat)){mat["specular_shader"]="COOKTORR";report("material",mat,"specular_shader")}if(!("diffuse_shader"in mat)){mat["diffuse_shader"]="LAMBERT";report("material",mat,"diffuse_shader")}if(!("roughness"in mat)){mat["roughness"]=0.5;report("material",mat,"roughness")}if(!("diffuse_fresnel"in mat)){mat["diffuse_fresnel"]=0.1;report("material",mat,"diffuse_fresnel")}if(!("diffuse_fresnel_factor"in mat)){mat["diffuse_fresnel_factor"]=0.5;report("material",mat,"diffuse_fresnel_factor")}if(!("specular_slope"in
mat)){mat["specular_slope"]=0.2;report("material",mat,"specular_slope")}if(!("b4w_wettable"in mat)){mat["b4w_wettable"]=false;report("material",mat,"b4w_wettable")}if(!("b4w_shallow_water_col"in mat)){mat["b4w_shallow_water_col"]=[0,0.8,0.3];report("material",mat,"b4w_shallow_water_col")}if(!("b4w_shore_water_col"in mat)){mat["b4w_shore_water_col"]=[0,0.9,0.2];report("material",mat,"b4w_shore_water_col")}if(!("b4w_shallow_water_col_fac"in mat)){mat["b4w_shallow_water_col_fac"]=1;report("material",
mat,"b4w_shallow_water_col_fac")}if(!("b4w_shore_water_col_fac"in mat)){mat["b4w_shore_water_col_fac"]=0.5;report("material",mat,"b4w_shore_water_col_fac")}if(!("b4w_water_sss_strength"in mat)){mat["b4w_water_sss_strength"]=5.9;report("material",mat,"b4w_water_sss_strength")}if(!("b4w_water_sss_width"in mat)){mat["b4w_water_sss_width"]=0.45;report("material",mat,"b4w_water_sss_width")}var texture_slots=mat["texture_slots"];for(var j=0;j<texture_slots.length;j++){var slot=texture_slots[j];if(!("blend_type"in
slot)){slot["blend_type"]="MIX";report("texture_slot",slot,"blend_type")}}}var objects=bpy_data["objects"];for(var i=0;i<objects.length;i++){var obj=objects[i];switch(obj["type"]){case "MESH":if(!("b4w_dynamic_geometry"in obj))obj["b4w_dynamic_geometry"]=false;if(!("b4w_reflexible"in obj))obj["b4w_reflexible"]=false;if(!("b4w_reflexible_only"in obj))obj["b4w_reflexible_only"]=false;if(!("b4w_reflective"in obj))obj["b4w_reflective"]=false;if(!("b4w_wind_bending"in obj)){obj["b4w_wind_bending"]=false;
report("object",obj,"b4w_wind_bending")}if(!("b4w_wind_bending_angle"in obj)){obj["b4w_wind_bending_angle"]=10;obj["b4w_wind_bending_freq"]=0.25;report("object",obj,"wind bending params")}if(!("b4w_detail_bending_amp"in obj)){obj["b4w_detail_bending_amp"]=0.1;obj["b4w_branch_bending_amp"]=0.3;report("object",obj,"detail bending params")}if(!("b4w_detail_bending_freq"in obj)){obj["b4w_detail_bending_freq"]=1;report("object",obj,"b4w_detail_bending_freq")}if(!("b4w_main_bend_stiffness_col"in obj)){obj["b4w_main_bend_stiffness_col"]=
"";report("object",obj,"b4w_main_bend_stiffness_col")}if(!("b4w_detail_bend_colors"in obj)){obj["b4w_detail_bend_colors"]={"leaves_stiffness_col":"","leaves_phase_col":"","overall_stiffness_col":""};report("object",obj,"b4w_detail_bend_colors")}if(!("b4w_caustics"in obj))obj["b4w_caustics"]=false;if("vertex_groups"in obj&&(obj["vertex_groups"].length&&(obj["data"]&&obj["data"]["vertex_groups"].length==0))){obj["data"]["vertex_groups"]=obj["vertex_groups"];delete obj["vertex_groups"];report("object",
obj,"vertex_groups")}if("b4w_vertex_anim"in obj&&(obj["b4w_vertex_anim"].length&&(obj["data"]&&obj["data"]["b4w_vertex_anim"].length==0))){obj["data"]["b4w_vertex_anim"]=obj["b4w_vertex_anim"];delete obj["b4w_vertex_anim"];report("object",obj,"b4w_vertex_anim")}if(!("b4w_do_not_render"in obj))obj["b4w_do_not_render"]=false;if(!("use_ghost"in obj["game"]))obj["game"]["use_ghost"]=false;if(!("use_sleep"in obj["game"]))obj["game"]["use_sleep"]=false;if(!("velocity_min"in obj["game"]))obj["game"]["velocity_min"]=
0;if(!("velocity_max"in obj["game"]))obj["game"]["velocity_max"]=0;if(!("collision_group"in obj["game"]))obj["game"]["collision_group"]=1;if(!("collision_mask"in obj["game"]))obj["game"]["collision_mask"]=255;if("b4w_vehicle_settings"in obj){if(obj["b4w_vehicle_settings"]){if(!("steering_ratio"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["steering_ratio"]=10;if(!("steering_max"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["steering_max"]=1;if(!("inverse_control"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["inverse_control"]=
false;if(!("force_max"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["force_max"]=1500;if(!("brake_max"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["brake_max"]=100;if(!("speed_ratio"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["speed_ratio"]=0.027;if(!("max_speed_angle"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["max_speed_angle"]=Math.PI;if(!("delta_tach_angle"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["delta_tach_angle"]=
4.43;if(!("suspension_compression"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["suspension_compression"]=4.4;if(!("suspension_stiffness"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["suspension_stiffness"]=20;if(!("suspension_damping"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["suspension_damping"]=2.3;if(!("wheel_friction"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["wheel_friction"]=1E3;if(!("roll_influence"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["roll_influence"]=
0.1;if(!("max_suspension_travel_cm"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["max_suspension_travel_cm"]=30;if(!("floating_factor"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["floating_factor"]=3;if(!("floating_factor"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["floating_factor"]=3;if(!("water_lin_damp"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["water_lin_damp"]=0.9;if(!("water_rot_damp"in obj["b4w_vehicle_settings"]))obj["b4w_vehicle_settings"]["water_rot_damp"]=
0.9}}else{obj["b4w_vehicle_settings"]=null;report("object",obj,"b4w_vehicle_settings")}if("b4w_floating_settings"in obj){if(obj["b4w_floating_settings"]){if(!("floating_factor"in obj["b4w_floating_settings"]))obj["b4w_floating_settings"]["floating_factor"]=3;if(!("water_lin_damp"in obj["b4w_floating_settings"]))obj["b4w_floating_settings"]["water_lin_damp"]=0.8;if(!("water_rot_damp"in obj["b4w_floating_settings"]))obj["b4w_floating_settings"]["water_rot_damp"]=0.8}}else{obj["b4w_floating_settings"]=
null;report("object",obj,"b4w_floating_settings")}if("b4w_character_settings"in obj){if(obj["b4w_character_settings"]){if(!("walk_speed"in obj["b4w_character_settings"]))obj["b4w_character_settings"]["walk_speed"]=4;if(!("run_speed"in obj["b4w_character_settings"]))obj["b4w_character_settings"]["run_speed"]=8;if(!("step_height"in obj["b4w_character_settings"]))obj["b4w_character_settings"]["step_height"]=0.25;if(!("jump_strength"in obj["b4w_character_settings"]))obj["b4w_character_settings"]["jump_strength"]=
5;if(!("waterline"in obj["b4w_character_settings"]))obj["b4w_character_settings"]["waterline"]=0}}else{obj["b4w_character_settings"]=null;report("object",obj,"b4w_character_settings")}if(!("b4w_selectable"in obj)){obj["b4w_selectable"]=false;report("object",obj,"b4w_selectable")}if(!("b4w_glow_settings"in obj)){obj["b4w_glow_settings"]={};obj["b4w_glow_settings"]["glow_duration"]=1;obj["b4w_glow_settings"]["glow_period"]=1;obj["b4w_glow_settings"]["glow_relapses"]=0;report("object",obj,"b4w_glow_settings")}if(!("b4w_lods_num"in
obj)){obj["b4w_lods_num"]=0;report("object",obj,"b4w_lods_num")}break;case "EMPTY":if(!("b4w_group_relative"in obj)){obj["b4w_group_relative"]=false;report("object",obj,"b4w_group_relative")}break;default:break}if(!("rotation_quaternion"in obj)){var quat=[0,0,0,1];m_util.euler_to_quat(obj["rotation_euler"],quat);quat_b4w_bpy(quat,quat);obj["rotation_quaternion"]=quat;report("object",obj,"rotation_quaternion")}if("webgl_do_not_batch"in obj){obj["b4w_do_not_batch"]=obj["webgl_do_not_batch"];if(obj["webgl_do_not_batch"])report_deprecated("object",
obj,"webgl_do_not_batch")}if(!("b4w_shadow_cast_only"in obj)){obj["b4w_shadow_cast_only"]=false;report("object",obj,"b4w_shadow_cast_only")}if(!("b4w_correct_bounding_offset"in obj)){obj["b4w_correct_bounding_offset"]="AUTO";report("object",obj,"b4w_correct_bounding_offset")}var psystems=obj["particle_systems"];for(var j=0;j<psystems.length;j++){var psys=psystems[j];var pset=psys["settings"];if(!("use_whole_group"in pset)){pset["use_whole_group"]=false;report("object",pset,"use_whole_group")}if(!psys["transforms"]){psys["transforms"]=
new Float32Array;report("particle_system",psys,"transforms")}if(!("b4w_billboard_align"in pset)){pset["b4w_billboard_align"]="VIEW";report("particle_settings",pset,"b4w_billboard_align")}if(!("b4w_dynamic_grass"in pset)){pset["b4w_dynamic_grass"]=false;report("object",pset,"b4w_dynamic_grass")}if(!("b4w_dynamic_grass_scale_threshold"in pset)){pset["b4w_dynamic_grass_scale_threshold"]=0.01;report("object",pset,"b4w_dynamic_grass_scale_threshold")}if(!("b4w_initial_rand_rotation"in pset)){pset["b4w_initial_rand_rotation"]=
false;report("particle_settings",pset,"b4w_initial_rand_rotation")}if(!("b4w_rotation_type"in pset)){pset["b4w_rotation_type"]="Z";report("particle_settings",pset,"b4w_rotation_type")}if(!("b4w_rand_rotation_strength"in pset)){pset["b4w_rand_rotation_strength"]=1;report("particle_settings",pset,"b4w_rand_rotation_strength")}if(!("b4w_hair_billboard"in pset)){pset["b4w_hair_billboard"]=false;report("particle_settings",pset,"b4w_hair_billboard")}if(!("b4w_hair_billboard_type"in pset)){pset["b4w_hair_billboard_type"]=
"BASIC";report("particle_settings",pset,"b4w_hair_billboard_type")}if(!("b4w_hair_billboard_jitter_amp"in pset)){pset["b4w_hair_billboard_jitter_amp"]=0;report("particle_settings",pset,"b4w_hair_billboard_jitter_amp")}if(!("b4w_hair_billboard_jitter_freq"in pset)){pset["b4w_hair_billboard_jitter_freq"]=0;report("particle_settings",pset,"b4w_hair_billboard_jitter_freq")}if(!("b4w_hair_billboard_geometry"in pset)){pset["b4w_hair_billboard_geometry"]="SPHERICAL";report("particle_settings",pset,"b4w_hair_billboard_geometry")}if(!("b4w_wind_bend_inheritance"in
pset)){pset["b4w_wind_bend_inheritance"]="PARENT";report("particle_settings",pset,"b4w_wind_bend_inheritance")}if(!("b4w_shadow_inheritance"in pset)){pset["b4w_shadow_inheritance"]="PARENT";report("particle_settings",pset,"b4w_shadow_inheritance")}if(!("b4w_reflection_inheritance"in pset)){pset["b4w_reflection_inheritance"]="PARENT";report("particle_settings",pset,"b4w_reflection_inheritance")}if(!("b4w_vcol_from_name"in pset)){pset["b4w_vcol_from_name"]="";report("particle_settings",pset,"b4w_vcol_from_name")}if(!("b4w_vcol_to_name"in
pset)){pset["b4w_vcol_to_name"]="";report("particle_settings",pset,"b4w_vcol_to_name")}}if(!("constraints"in obj)){obj["constraints"]=[];report("object",obj,"constraints")}var mods=obj["modifiers"];for(var j=0;j<mods.length;j++)if(!check_modifier(mods[j],obj)){mods.splice(j,1);j--}if(!("animation_data"in obj)){obj["animation_data"]={"action":null,"nla_tracks":[]};report("object",obj,"animation_data")}if(obj["animation_data"]){if(!("action"in obj["animation_data"])){obj["animation_data"]["action"]=
null;report_raw("B4W Warning: no action in animation data "+obj["name"])}if(!("nla_tracks"in obj["animation_data"])){obj["animation_data"]["nla_tracks"]=[];report_raw("B4W Warning: no NLA in animation data "+obj["name"])}var nla_tracks=obj["animation_data"]["nla_tracks"];for(var j=0;j<nla_tracks.length;j++){var track=nla_tracks[j];for(var k=0;k<track["strips"].length;k++)if(!("action"in track["strips"][k])){track["strips"][k]["action"]=null;report_raw("B4W Warning: no action in NLA strip "+obj["name"])}}}if(!("b4w_collision_id"in
obj)){obj["b4w_collision_id"]="";report("material",obj,"b4w_collision_id")}if(!check_uniform_scale(obj))report_raw("B4W Warning: non-uniform scale for object "+obj["name"])}if(_unreported_compat_issues)m_print.error("Compatibility issues detected")};function quat_b4w_bpy(quat,dest){var x=quat[0];var y=quat[1];var z=quat[2];var w=quat[3];dest[0]=w;dest[1]=x;dest[2]=y;dest[3]=z;return dest}function report(type,obj,missing_param){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}m_print.warn("WARNING "+
String(missing_param)+" for "+String(type)+" "+'"'+obj["name"]+'"'+" undefined, reexport "+(obj["library"]?"library "+libname(obj):"main scene"))}function report_missing_datablock(type){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}m_print.warn("WARNING "+"Datablock "+type+" is missing, reexport scene")}function report_deprecated(type,obj,deprecated_param){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}m_print.warn('B4W Warning: "'+String(deprecated_param)+
'" for '+String(type)+" "+'"'+obj["name"]+'"'+" is deprecated, reexport "+(obj["library"]?'library "'+libname(obj)+'"':"main scene."))}function report_modifier(type,obj){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}m_print.error("WARNING "+"Incomplete modifier "+String(type)+" for "+'"'+obj["name"]+'"'+", reexport "+(obj["library"]?"library"+libname(obj):"main scene"))}function report_raw(msg){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}m_print.warn(msg)}
function libname(obj){var path=obj["library"];return path.split("/").slice(-1)[0]}function check_uniform_scale(obj){var scale=obj["scale"];var delta1=Math.abs((scale[0]-scale[1])/scale[0]);var delta2=Math.abs((scale[1]-scale[2])/scale[1]);return delta1<0.001&&delta2<0.001}exports.apply_mesh_modifiers=function(obj){if(!has_modifiers(obj))return null;var mesh=mesh_copy(obj["data"],obj["data"]["name"]+"_MOD");var modifiers=obj["modifiers"];for(var i=0;i<modifiers.length;i++){var mod=modifiers[i];switch(mod["type"]){case "ARRAY":apply_array_modifier(mesh,
mod);break;case "CURVE":apply_curve_modifier(mesh,mod);break;default:break}m_bounds.recalculate_mesh_boundings(mesh)}return mesh};function has_modifiers(obj){var modifiers=obj["modifiers"];for(var i=0;i<modifiers.length;i++){var mod=modifiers[i];var type=mod["type"];if(type=="ARRAY"||type=="CURVE")return true}return false}function apply_array_modifier(mesh,mod){var dx=0;var dy=0;var dz=0;var trans_matrix=new Float32Array(16);var new_meshes=[];for(var i=1;i<mod["count"];i++){if(mod["use_constant_offset"]){dx+=
mod["constant_offset_displace"][0];dy+=mod["constant_offset_displace"][1];dz+=mod["constant_offset_displace"][2]}if(mod["use_relative_offset"]){var bb=mesh["b4w_bounding_box"];dx+=(bb["max_x"]-bb["min_x"])*mod["relative_offset_displace"][0];dy+=(bb["max_y"]-bb["min_y"])*mod["relative_offset_displace"][1];dz+=(bb["max_z"]-bb["min_z"])*mod["relative_offset_displace"][2]}m_util.trans_matrix(dx,dy,dz,trans_matrix);var mc=mesh_copy(mesh);mesh_transform_locations(mc,trans_matrix);new_meshes.push(mc)}for(var i=
0;i<new_meshes.length;i++)mesh_join(mesh,new_meshes[i])}function apply_curve_modifier(mesh,mod){var cobj=mod["object"];var spline=cobj._spline;var matrix=new Float32Array(16);var ncoords=spline.is_3d?4:3;var point=new Float32Array(ncoords);var deriv=new Float32Array(ncoords);var trans=new Float32Array(3);var quat=new Float32Array(4);var qtilt=new Float32Array(4);var tangent_a=new Float32Array(3);var tangent_b=new Float32Array(3);var loc=new Float32Array(3);var nor=new Float32Array(4);var tan=new Float32Array(4);
for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];var position=submesh["position"];var normal=submesh["normal"];var tangent=submesh["tangent"];var deform_index=deform_axis_index(mod["deform_axis"]);tangent_a[0]=0;tangent_a[1]=0;tangent_a[2]=0;tangent_a[deform_index]=1;var slen=m_curve.spline_length(spline);for(var j=0;j<position.length/3;j++){loc[0]=position[3*j];loc[1]=position[3*j+1];loc[2]=position[3*j+2];var loc_spline_len=loc[deform_index];var t=m_curve.spline_len_to_t(spline,
loc_spline_len);m_curve.spline_point(spline,t,point);trans[0]=point[0];trans[1]=point[1];trans[2]=point[2];m_curve.spline_derivative(spline,t,deriv);tangent_b[0]=deriv[0];tangent_b[1]=0;tangent_b[2]=deriv[2];m_vec3.normalize(tangent_b,tangent_b);m_quat.rotationTo(tangent_a,tangent_b,quat);if(loc_spline_len<0){point[0]=tangent_b[0];point[1]=tangent_b[1];point[2]=tangent_b[2];m_vec3.scale(point,loc_spline_len,point);m_vec3.add(trans,point,trans)}else if(loc_spline_len>slen){point[0]=tangent_b[0];point[1]=
tangent_b[1];point[2]=tangent_b[2];m_vec3.scale(point,loc_spline_len-slen,point);m_vec3.add(trans,point,trans)}m_mat4.fromRotationTranslation(quat,trans,matrix);if(spline.is_3d){var tilt=point[3];m_quat.setAxisAngle(tangent_a,tilt,qtilt);m_vec3.transformQuat(loc,qtilt,loc)}loc[deform_index]=0;m_vec3.transformMat4(loc,matrix,loc);position[3*j]=loc[0];position[3*j+1]=loc[1];position[3*j+2]=loc[2];if(normal.length){nor[0]=normal[3*j];nor[1]=normal[3*j+1];nor[2]=normal[3*j+2];nor[3]=0;m_vec4.transformMat4(nor,
matrix,nor);normal[3*j]=nor[0];normal[3*j+1]=nor[1];normal[3*j+2]=nor[2]}if(tangent.length){tan[0]=tangent[3*j];tan[1]=tangent[3*j+1];tan[2]=tangent[3*j+2];tan[3]=0;m_vec4.transformMat4(tan,matrix,tan);tangent[3*j]=tan[0];tangent[3*j+1]=tan[1];tangent[3*j+2]=tan[2]}}}}function mesh_range_deform_axis(mesh,deform_axis){var bpy_bb=mesh["b4w_bounding_box"];switch(deform_axis){case "POS_X":case "NEG_X":return[bpy_bb["min_x"],bpy_bb["max_x"]];case "POS_Y":case "NEG_Y":return[bpy_bb["min_y"],bpy_bb["max_y"]];
case "POS_Z":case "NEG_Z":return[bpy_bb["min_z"],bpy_bb["max_z"]];default:throw"Wrong deform axis value "+deform_axis;}}function deform_axis_index(deform_axis){switch(deform_axis){case "POS_X":case "NEG_X":return 0;case "POS_Y":case "NEG_Y":return 1;case "POS_Z":case "NEG_Z":return 2;default:throw"Wrong deform axis value "+deform_axis;}}function modify_mesh_points_interval(mesh,x_min,x_max,y_min,y_max,z_min,z_max,matrix){var locations=mesh["vertices"]["locations"];var loc=new Float32Array(3);for(var i=
0;i<locations.length/3;i++){var x=locations[3*i];var y=locations[3*i+1];var z=locations[3*i+2];if((x_max-x_min==0||x>=x_min&&x<x_max)&&((y_max-y_min==0||y>=y_min&&y<y_max)&&(z_max-z_min==0||z>=z_min&&z<z_max))){loc[0]=x;loc[1]=y;loc[2]=z;m_vec3.transformMat4(loc,matrix,loc);locations[3*i]=loc[0];locations[3*i+1]=loc[1];locations[3*i+2]=loc[2]}}}exports.create_material=function(name){var mat={"name":name,"use_nodes":false,"diffuse_shader":"LAMBERT","diffuse_color":[0.8,0.8,0.8],"diffuse_intensity":1,
"alpha":1,"raytrace_transparency":{"fresnel":0,"fresnel_factor":1.25},"raytrace_mirror":{"reflect_factor":0,"fresnel":0,"fresnel_factor":1.25},"specular_color":[1,1,1],"specular_intensity":0.5,"specular_shader":"COOKTORR","specular_hardness":50,"specular_slope":0.2,"emit":0,"ambient":1,"use_vertex_color_paint":false,"b4w_water":false,"b4w_water_shore_smoothing":false,"b4w_water_dynamic":false,"b4w_generated_mesh":false,"b4w_waves_height":1,"b4w_water_fog_color":[0.5,0.5,0.5],"b4w_water_fog_density":0.06,
"b4w_water_num_cascads":5,"b4w_water_subdivs":64,"b4w_water_detailed_dist":1E3,"b4w_terrain":false,"b4w_terrain_tex_type":"B4W_TERRAIN_NONE","b4w_skydome":false,"b4w_collision":false,"b4w_collision_id":"","b4w_double_sided_lighting":false,"physics":{"friction":0.5,"elasticity":0},"type":"SURFACE","use_transparency":false,"use_shadeless":false,"offset_z":0,"game_settings":{"alpha_blend":"OPAQUE","use_backface_culling":true},"node_tree":null,"texture_slots":[]};return mat};function mesh_init_uv_textures(mesh,
count){var uv_tex=mesh["uv_textures"];for(var i=0;i<count;i++){if(!uv_tex[i])uv_tex[i]={};if(!uv_tex[i]["data"])uv_tex[i]["data"]=[]}return mesh}function mesh_copy(mesh,new_name){if(!new_name)var new_name=mesh["name"]+"_COPY";var materials=mesh["materials"];var submeshes=mesh["submeshes"];mesh["materials"]=null;mesh["submeshes"]=null;var mesh_new=m_util.clone_object_json(mesh);mesh["materials"]=materials;mesh["submeshes"]=submeshes;mesh_new["name"]=new_name;mesh_new["materials"]=mesh["materials"].slice(0);
mesh_new["submeshes"]=[];for(var i=0;i<submeshes.length;i++){var submesh=submeshes[i];var submesh_new=m_util.clone_object_nr(submesh);mesh_new["submeshes"].push(submesh_new)}return mesh_new}function mesh_join(mesh,mesh2){for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];var submesh2=mesh2["submeshes"][i];var base_length=submesh["base_length"];var index_length=submesh["indices"].length;submesh["base_length"]+=submesh2["base_length"];for(var prop in submesh){if(prop=="base_length")continue;
if(prop=="indices"){submesh[prop]=m_util.uint32_concat(submesh[prop],submesh2[prop]);for(var j=index_length;j<submesh["indices"].length;j++)submesh["indices"][j]+=base_length}else submesh[prop]=m_util.float32_concat(submesh[prop],submesh2[prop])}}return mesh}function mesh_transform_locations(mesh,matrix){for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];m_util.positions_multiply_matrix(submesh["position"],matrix,submesh["position"],0);m_util.vectors_multiply_matrix(submesh["normal"],
matrix,submesh["normal"],0);m_util.tangents_multiply_matrix(submesh["tangent"],matrix,submesh["tangent"],0)}}};b4w.module["__scenegraph"]=function(exports,require){var m_cam=require("__camera");var m_cfg=require("__config");var m_dbg=require("__debug");var m_graph=require("__graph");var m_render=require("__renderer");var m_tex=require("__textures");var m_util=require("__util");var m_vec4=require("vec4");var cfg_def=m_cfg.defaults;var cfg_scs=m_cfg.scenes;var DEBUG_DISABLE_TEX_REUSE=false;var SKY_TEX_SIZE=384;exports.create_rendering_graph_compat=function(cam_render,sc_render){var graph=m_graph.create();var cam=
cam_render.cameras[0];var num_lights=sc_render.lamps_number;var wls_params=sc_render.world_light_set;var fog=sc_render.fog_color_density;var subs_main_opaque=create_subs_main("OPAQUE",cam,false,sc_render.water_params,num_lights,fog,wls_params);m_graph.append_node_attr(graph,subs_main_opaque);var subs_main_blend=create_subs_main("BLEND",cam,true,null,num_lights,fog,wls_params,null);m_graph.append_node_attr(graph,subs_main_blend);m_graph.append_edge_attr(graph,subs_main_opaque,subs_main_blend,create_slink("SCREEN",
"NONE",1,1,true));var subs_sink=create_subs_sink();m_graph.append_node_attr(graph,subs_sink);if(cfg_def.wireframe_debug){var subs_wireframe=create_subs_wireframe(cam);m_graph.append_node_attr(graph,subs_wireframe);m_graph.append_edge_attr(graph,subs_main_blend,subs_wireframe,create_slink("SCREEN","NONE",1,1,true));m_graph.append_edge_attr(graph,subs_wireframe,subs_sink,create_slink("SCREEN","NONE",1,1,true))}else m_graph.append_edge_attr(graph,subs_main_blend,subs_sink,create_slink("SCREEN","NONE",
1,1,true));if(sc_render.color_picking){var cam=cam_copy(subs_main_opaque.camera);cam_render.cameras.push(cam);var subs_color_picking=create_subs_color_picking(cam);m_graph.append_node_attr(graph,subs_color_picking);m_graph.append_edge_attr(graph,subs_color_picking,subs_sink,create_slink("COLOR","NONE",1,1,true));m_graph.append_edge_attr(graph,subs_color_picking,subs_sink,create_slink("DEPTH","NONE",1,1,true))}if(sc_render.procedural_sky){var sky_params=sc_render.sky_params;var subs_sky=create_subs_sky(num_lights,
sky_params);m_graph.append_node_attr(graph,subs_sky);var slink_sky=create_slink("CUBEMAP","u_sky",SKY_TEX_SIZE,1,false);m_graph.append_edge_attr(graph,subs_sky,subs_sink,slink_sky)}enforce_graph_consistency(graph,true);if(cfg_def.resolution_factor>1)apply_resolution_factor(graph);process_subscene_links(graph);assign_render_targets(graph);return graph};function cam_copy(cam){var cam_new=m_util.clone_object_r(cam);cam_new.framebuffer=null;cam_new.color_attachment=null;cam_new.depth_attachment=null;
return cam_new}function enforce_graph_consistency(graph,compat){var slinks=[];m_graph.traverse_edges(graph,function(node1,node2,attr){var slink=attr;if(slinks.indexOf(slink)>-1)m_graph.replace_edge_attr(graph,node1,node2,slink,clone_slink(slink));else slinks.push(slink)});m_graph.traverse(graph,function(id,attr){var subs=attr;for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(slinks.indexOf(slink)>-1)subs.slinks_internal[i]=clone_slink(slink);else slinks.push(slink)}if(subs.type==
"ANTIALIASING")m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var subs_in=attr_in;if(subs_in.type=="MOTION_BLUR")for(var i=0;i<subs_in.slinks_internal.length;i++){var slink_mb_int=subs_in.slinks_internal[i];slink_mb_int.min_filter=m_tex.TF_LINEAR;slink_mb_int.mag_filter=m_tex.TF_LINEAR}})});m_graph.traverse(graph,function(id,attr){var subs=attr;var dest={};combine_same_slinks(graph,id,dest);for(var i in dest){var slinks=dest[i];if(compat)for(var j=0;j<slinks.length;j++){var slink=
slinks[j];if(slink.from!="DEPTH")continue;if(!check_slink_tex_conn(slink))slink.use_renderbuffer=true;else throw"Failed to use renderbuffer as input texture: "+slink.from+"->"+slink.to;}var min_filt_slink=slinks[0];for(var j=0;j<slinks.length;j++)if(slinks[j].min_filter==m_tex.TF_LINEAR){min_filt_slink=slinks[j];break}var mag_filt_slink=slinks[0];for(var j=0;j<slinks.length;j++)if(slinks[j].mag_filter==m_tex.TF_LINEAR){mag_filt_slink=slinks[j];break}var not_rb_slink=slinks[0];for(var j=0;j<slinks.length;j++)if(!slinks[j].use_renderbuffer){not_rb_slink=
slinks[j];break}for(var j=0;j<slinks.length;j++){slinks[j].min_filter=min_filt_slink.min_filter;slinks[j].mag_filter=mag_filt_slink.mag_filter;slinks[j].use_renderbuffer=not_rb_slink.use_renderbuffer}}})}function combine_same_slinks(graph,id,dest){m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;if(!slink.active)return;if(slink.from==slink.to){dest[slink.from]=dest[slink.from]||[];if(dest[slink.from].indexOf(slink)==-1)dest[slink.from].push(slink);combine_same_slinks(graph,
id_in,dest)}});m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(!slink.active)return;dest[slink.from]=dest[slink.from]||[];if(dest[slink.from].indexOf(slink)==-1)dest[slink.from].push(slink)});var subs=m_graph.get_node_attr(graph,id);if(subs.type=="MOTION_BLUR")for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];dest[slink.from].push(slink)}}exports.check_slink_tex_conn=check_slink_tex_conn;function check_slink_tex_conn(slink){switch(slink.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "SCREEN":case "NONE":return false;
default:return true}}function clone_slink(slink){if(slink.texture)throw"Failed to clone slink with attached texture";return m_util.clone_object_json(slink)}function process_subscene_links(graph){var graph_sorted=m_graph.topsort(graph);var tex_storage_all=[];m_graph.traverse(graph_sorted,function(id,attr){var subs=attr;switch(subs.type){case "MOTION_BLUR":case "SMAA_RESOLVE":case "SMAA_NEIGHBORHOOD_BLENDING":case "MAIN_REFLECT":var tex_storage=[];break;default:var tex_storage=tex_storage_all}for(var i=
0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];var tex=tex_aquire(tex_storage,slink,calc_slink_id(slink));slink.texture=tex;subs.textures_internal[i]=tex}for(var i=0;i<subs.textures_internal.length;i++){var tex=subs.textures_internal[i];tex_dec_ref(tex_storage,tex)}switch(subs.type){case "MOTION_BLUR":case "SMAA_RESOLVE":case "SMAA_NEIGHBORHOOD_BLENDING":case "MAIN_REFLECT":var tex_storage=[];break;default:}m_graph.traverse_outputs(graph_sorted,id,function(id_out,attr_out,
attr_edge){var slink=attr_edge;var tex=find_nearest_tex(graph_sorted,id,slink.from);if(tex&&(slink.active&&!slink.texture)){if(slink.from!=slink.to)tex_inc_ref(tex_storage,tex);slink.texture=tex;return}var tex=tex_aquire(tex_storage,slink,calc_slink_id(slink));slink.texture=tex});m_graph.traverse_inputs(graph_sorted,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;var subs_in=attr_in;if(slink.from!=slink.to)tex_dec_ref(tex_storage,slink.texture)});m_graph.traverse_outputs(graph_sorted,id,
function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.texture&&slink.to=="NONE")tex_dec_ref(tex_storage,slink.texture)})})}function apply_resolution_factor(graph){traverse_slinks(graph,function(slink,internal,subs1,subs2){if(slink.update_dim&&(has_lower_subs(graph,subs1,"SMAA_NEIGHBORHOOD_BLENDING")&&subs1.type!="SMAA_NEIGHBORHOOD_BLENDING"||has_lower_subs(graph,subs1,"ANTIALIASING")))slink.size_mult*=cfg_def.resolution_factor})}function calc_slink_id(slink){var id_obj=m_util.clone_object_json(slink);
delete id_obj.to;delete id_obj.active;return JSON.stringify(id_obj)}function find_nearest_tex(graph,id,type){var tex=null;m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;if(slink.active&&(slink.from==slink.to&&(slink.from==type&&slink.texture))){tex=slink.texture;return true}});m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.active&&(slink.from==type&&slink.texture)){tex=slink.texture;return true}});return tex}
function tex_inc_ref(storage,tex){for(var i=0;i<storage.length;i++){var item=storage[i];if(item.tex===tex)item.ref++}}function tex_dec_ref(storage,tex){for(var i=0;i<storage.length;i++){var item=storage[i];if(item.tex===tex&&item.ref)item.ref--}}function tex_aquire(storage,slink,slink_id){var storage_item_free=null;for(var i=0;i<storage.length;i++){var item=storage[i];if(item.id==slink_id&&item.ref===0){storage_item_free=item;break}}if(storage_item_free&&!DEBUG_DISABLE_TEX_REUSE){storage_item_free.ref++;
return storage_item_free.tex}else{var tex=tex_create_for_slink(slink);storage.push({id:slink_id,ref:1,tex:tex});return tex}}function tex_create_for_slink(slink){var size=slink.size_mult*slink.size;switch(slink.from){case "COLOR":var tex=m_tex.create_texture("COLOR",m_tex.TT_RGBA_INT);m_tex.resize(tex,size,size);m_tex.set_filters(tex,slink.min_filter,slink.mag_filter);return tex;case "DEPTH":if(slink.use_renderbuffer){var tex=m_tex.create_texture("DEPTH_RBUF",m_tex.TT_RENDERBUFFER);m_tex.resize(tex,
size,size)}else{var tex=m_tex.create_texture("DEPTH_TEX",m_tex.TT_DEPTH);m_tex.resize(tex,size,size);m_tex.set_filters(tex,slink.min_filter,slink.mag_filter)}return tex;case "CUBEMAP":var tex=m_tex.create_cubemap_texture("CUBEMAP",size);return tex;case "SCREEN":return null;default:throw"Wrong slink param: "+slink.from;}}exports.traverse_slinks=traverse_slinks;function traverse_slinks(graph,callback){var exit=false;m_graph.traverse_edges(graph,function(node1,node2,attr){var slink=attr;if(!slink)return;
var subs1=m_graph.get_node_attr(graph,node1);var subs2=m_graph.get_node_attr(graph,node2);if(callback(slink,false,subs1,subs2)){exit=true;return true}});if(exit)return;m_graph.traverse(graph,function(node,attr){var subs=attr;for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(callback(slink,true,subs,null))return true}})}function assign_render_targets(graph){m_graph.traverse(graph,function(id,attr){var subs=attr;if(subs.type=="SINK")return;var cam=subs.camera;m_graph.traverse_outputs(graph,
id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.active&&slink.texture){m_cam.set_attachment(cam,slink.from,slink.texture);if(slink.from==slink.to&&attr_out.camera)m_cam.set_attachment(attr_out.camera,slink.from,slink.texture)}});for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(slink.active&&slink.from==slink.to){var tex=subs.textures_internal[i];m_cam.set_attachment(cam,slink.from,tex)}}if((cam.color_attachment||cam.depth_attachment)&&!cam.framebuffer)cam.framebuffer=
m_render.render_target_create(cam.color_attachment,cam.depth_attachment)})}exports.create_rendering_graph=function(render_to_texture,sc_render,cam_render){var graph=m_graph.create();var prev_level=[];var curr_level=[];var depth_subscenes=[];var slinks_main_color_o=[];var slinks_main_depth_o=[];var reflect_subscenes=[];var reflect_links=[];var refract_subscenes=[];var refract_links=[];var shadow_subscenes=[];var shadow_links=[];var num_lights=sc_render.lamps_number;var water_params=sc_render.water_params;
var shore_smoothing=sc_render.shore_smoothing;var render_shadows=sc_render.render_shadows;var ssao=sc_render.ssao;var god_rays=sc_render.god_rays;var refractions=sc_render.refractions;var refl_planes=sc_render.refl_planes;var bloom=sc_render.bloom;var motion_blur=sc_render.motion_blur;var compositing=sc_render.compositing;var antialiasing=sc_render.antialiasing;var wls_params=sc_render.world_light_set;var fog=sc_render.fog_color_density;var shadow_params=sc_render.shadow_params;var mb_params=sc_render.mb_params;
var bloom_params=sc_render.bloom_params;var cc_params=sc_render.cc_params;var gr_params=sc_render.god_rays_params;var glow_params=sc_render.glow_params;if(render_shadows){var csm_num=shadow_params.csm_num;if(!csm_num)throw"Zero CSM sections is forbidden";for(var i=0;i<csm_num;i++){var subs_shadow=create_subs_shadow_cast(i);m_graph.append_node_attr(graph,subs_shadow);shadow_subscenes.push(subs_shadow);var tex_size=cfg_scs.shadow_tex_size;var cam=subs_shadow.camera;cam.width=tex_size;cam.height=tex_size;
subs_shadow.clear_color=false;shadow_links.push(create_slink("DEPTH","u_shadow_map"+i,tex_size,1,false));if(m_dbg.check_depth_only_issue())subs_shadow.slinks_internal.push(create_slink("COLOR","COLOR",tex_size,1,false))}}if(cfg_def.dof&&(cam_render.dof_distance>0||cam_render.dof_object))var dof_on=true;else var dof_on=false;var main_cams=[];if(cfg_def.anaglyph_use&&!render_to_texture){var cam_left=cam_render.cameras[0];var cam_right=cam_copy(cam_left);m_cam.make_stereo(cam_left,m_cam.TYPE_STEREO_LEFT);
m_cam.make_stereo(cam_right,m_cam.TYPE_STEREO_RIGHT);main_cams.push(cam_left,cam_right);cam_render.cameras.push(cam_right)}else{var cam=cam_render.cameras[0];main_cams.push(cam)}if(refl_planes.length>0&&!render_to_texture)for(var i=0;i<main_cams.length;i++){var cam=cam_copy(main_cams[i]);cam_render.cameras.push(cam);var subs_main=create_subs_main("REFLECT",cam,false,water_params,num_lights,fog,wls_params);subs_main.reflection_plane=refl_planes[0];subs_main.camera.reflection_plane=refl_planes[0];m_graph.append_node_attr(graph,
subs_main);reflect_subscenes.push(subs_main);var slink_refl_c=create_slink("COLOR","u_reflectmap",1,cfg_def.reflect_multiplier,true);reflect_links.push(slink_refl_c);var slink_refl_d=create_slink("DEPTH","DEPTH",1,cfg_def.reflect_multiplier,true);subs_main.slinks_internal.push(slink_refl_d)}prev_level=[];curr_level=[];if(sc_render.dynamic_grass){var subs_grass_map=create_subs_grass_map();m_graph.append_node_attr(graph,subs_grass_map);var tex_size=cfg_scs.grass_tex_size;subs_grass_map.camera.width=
tex_size;subs_grass_map.camera.height=tex_size;var slink_grass_map_d=create_slink("DEPTH","u_grass_map_depth",tex_size,1,false);slink_grass_map_d.min_filter=m_tex.TF_LINEAR;slink_grass_map_d.mag_filter=m_tex.TF_LINEAR;var slink_grass_map_c=create_slink("COLOR","u_grass_map_color",tex_size,1,false);slink_grass_map_c.min_filter=m_tex.TF_LINEAR;slink_grass_map_c.mag_filter=m_tex.TF_LINEAR}else{var subs_grass_map=null;var slink_grass_map_d=null;var slink_grass_map_c=null}for(var i=0;i<main_cams.length;i++){var cam=
main_cams[i];var cam_depth=cam_copy(cam);var shadow_visibility_falloff=shadow_params.visibility_falloff;cam_render.cameras.push(cam_depth);if(render_shadows){var subs_depth=create_subs_depth_shadow(graph,cam_depth,shadow_visibility_falloff);m_graph.append_node_attr(graph,subs_depth);for(var j=0;j<shadow_subscenes.length;j++){var subs_shadow=shadow_subscenes[j];var slink_shadow=shadow_links[j];m_graph.append_edge_attr(graph,subs_shadow,subs_depth,slink_shadow)}var slink_depth_c=create_slink("COLOR",
"u_color",1,1,true);var slink_depth_d=create_slink("DEPTH","u_depth",1,1,true);if(ssao){var cam_ssao=cam_copy(cam);cam_render.cameras.push(cam_ssao);var ssao_params=sc_render.ssao_params;var subs_ssao=create_subs_ssao(cam_ssao,fog,ssao_params);m_graph.append_node_attr(graph,subs_ssao);var slink_ssao=create_slink("COLOR","u_color",1,1,true);m_graph.append_edge_attr(graph,subs_depth,subs_ssao,slink_depth_c);m_graph.append_edge_attr(graph,subs_depth,subs_ssao,slink_depth_d)}var cam_blur_depth_x=cam_copy(cam);
cam_render.cameras.push(cam_blur_depth_x);var cam_blur_depth_y=cam_copy(cam);cam_render.cameras.push(cam_blur_depth_y);var blur_depth_size_mult=shadow_params.blur_depth_size_mult;var blur_depth_edge_size=shadow_params.blur_depth_edge_size;var blur_depth_diff_threshold=shadow_params.blur_depth_diff_threshold;var subs_pp_x=create_subs_blur_depth(cam_blur_depth_x,"X",blur_depth_size_mult,blur_depth_edge_size,blur_depth_diff_threshold);m_graph.append_node_attr(graph,subs_pp_x);var slink_pp_x=create_slink("COLOR",
"u_color",1,1,true);if(ssao)m_graph.append_edge_attr(graph,subs_ssao,subs_pp_x,slink_ssao);else m_graph.append_edge_attr(graph,subs_depth,subs_pp_x,slink_depth_c);m_graph.append_edge_attr(graph,subs_depth,subs_pp_x,slink_depth_d);var subs_pp_y=create_subs_blur_depth(cam_blur_depth_y,"Y",blur_depth_size_mult,blur_depth_edge_size,blur_depth_diff_threshold);m_graph.append_node_attr(graph,subs_pp_y);m_graph.append_edge_attr(graph,subs_pp_x,subs_pp_y,slink_pp_x);m_graph.append_edge_attr(graph,subs_depth,
subs_pp_y,slink_depth_d);var slink_pp_y=create_slink("COLOR","u_shadow_mask",1,1,true);var cam_depth_pack=cam_copy(cam_depth);cam_render.cameras.push(cam_depth_pack);var subs_depth_pack=create_subs_depth_pack(cam_depth_pack);m_graph.append_node_attr(graph,subs_depth_pack);m_graph.append_edge_attr(graph,subs_depth,subs_depth_pack,create_slink("DEPTH","u_depth",1,1,true));depth_subscenes.push(subs_depth_pack);var slink_depth_o=create_slink("DEPTH","DEPTH",1,1,true);slinks_main_depth_o.push(slink_depth_o)}else{var subs_depth=
create_subs_depth_shadow(graph,cam_depth,shadow_visibility_falloff);m_graph.append_node_attr(graph,subs_depth);var slink_depth_o=create_slink("DEPTH","DEPTH",1,1,true);slinks_main_depth_o.push(slink_depth_o);if(m_dbg.check_depth_only_issue())subs_depth.slinks_internal.push(create_slink("COLOR","COLOR",1,1,true));var cam_depth_pack=cam_copy(cam_depth);cam_render.cameras.push(cam_depth_pack);var subs_depth_pack=create_subs_depth_pack(cam_depth_pack);m_graph.append_node_attr(graph,subs_depth_pack);m_graph.append_edge_attr(graph,
subs_depth,subs_depth_pack,create_slink("DEPTH","u_depth",1,1,true));depth_subscenes.push(subs_depth_pack)}if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_depth,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_depth,slink_grass_map_c)}var subs_main=create_subs_main("OPAQUE",cam,true,water_params,num_lights,fog,wls_params);m_graph.append_node_attr(graph,subs_main);curr_level.push(subs_main);m_graph.append_edge_attr(graph,subs_depth,subs_main,slinks_main_depth_o[i]);
if(subs_pp_y)m_graph.append_edge_attr(graph,subs_pp_y,subs_main,slink_pp_y);var slink_main_c=create_slink("COLOR","u_color",1,1,true);var slink_main_o=create_slink("COLOR","COLOR",1,1,true);slinks_main_color_o.push(slink_main_o);if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_c)}if(reflect_subscenes.length){m_graph.append_edge_attr(graph,reflect_subscenes[i],subs_main,reflect_links[i]);
subs_main.reflection_plane=refl_planes[0]}}prev_level=curr_level;curr_level=[];if(!render_to_texture&&sc_render.color_picking){var cam=cam_copy(prev_level[0].camera);cam_render.cameras.push(cam);var subs_color_picking=create_subs_color_picking(cam);m_graph.append_node_attr(graph,subs_color_picking)}else var subs_color_picking=null;if(refractions&&!render_to_texture)for(var i=0;i<main_cams.length;i++){var subs_refr=create_subs_refract();m_graph.append_node_attr(graph,subs_refr);m_graph.append_edge_attr(graph,
prev_level[i],subs_refr,slink_main_c);refract_subscenes.push(subs_refr);refract_links.push(create_slink("COLOR","u_refractmap",1,1,true))}var blend_subscenes=[];for(var i=0;i<main_cams.length;i++){var subs_depth=depth_subscenes[i];var cam=cam_copy(main_cams[i]);cam_render.cameras.push(cam);var subs_main=create_subs_main("BLEND",cam,true,water_params,num_lights,fog,wls_params,shadow_params);curr_level.push(subs_main);m_graph.append_node_attr(graph,subs_main);m_graph.append_edge_attr(graph,prev_level[i],
subs_main,slinks_main_color_o[i]);m_graph.append_edge_attr(graph,prev_level[i],subs_main,slinks_main_depth_o[i]);if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_c)}for(var j=0;j<shadow_subscenes.length;j++){var subs_shadow=shadow_subscenes[j];var slink_shadow=shadow_links[j];m_graph.append_edge_attr(graph,subs_shadow,subs_main,slink_shadow)}if(subs_depth.type=="DEPTH_PACK"){var slink_shore_in=
create_slink("COLOR","u_shore_depth",1,1,true);slink_shore_in.min_filter=m_tex.TF_NEAREST;slink_shore_in.mag_filter=m_tex.TF_NEAREST;m_graph.append_edge_attr(graph,subs_depth,subs_main,slink_shore_in)}else{var slink_shore_in=create_slink("DEPTH","u_shore_depth",1,1,true);slink_shore_in.min_filter=m_tex.TF_LINEAR;slink_shore_in.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_depth,subs_main,slink_shore_in)}if(reflect_subscenes.length){m_graph.append_edge_attr(graph,reflect_subscenes[i],
subs_main,reflect_links[i]);subs_main.reflection_plane=refl_planes[0]}if(refract_subscenes.length)m_graph.append_edge_attr(graph,refract_subscenes[i],subs_main,refract_links[i]);blend_subscenes.push(subs_main)}prev_level=curr_level;curr_level=[];if(cfg_def.wireframe_debug){for(var i=0;i<main_cams.length;i++){var cam=m_util.clone_object_r(main_cams[i]);cam_render.cameras.push(cam);var subs_wireframe=create_subs_wireframe(cam);curr_level.push(subs_wireframe);m_graph.append_node_attr(graph,subs_wireframe);
m_graph.append_edge_attr(graph,prev_level[i],subs_wireframe,slinks_main_color_o[i]);m_graph.append_edge_attr(graph,prev_level[i],subs_wireframe,slinks_main_depth_o[i]);if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_wireframe,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_wireframe,slink_grass_map_c)}}prev_level=curr_level;curr_level=[]}if(god_rays&&!render_to_texture){for(var i=0;i<main_cams.length;i++){var max_ray_length=gr_params.max_ray_length;var intensity=
gr_params.intensity;var steps_per_pass=gr_params.steps_per_pass;var subs_prev=prev_level[i];var water=water_params?1:0;var slink_gr_d=create_slink("DEPTH","u_input",1,1,true);slink_gr_d.min_filter=m_tex.TF_LINEAR;slink_gr_d.mag_filter=m_tex.TF_LINEAR;var slink_gr_c=create_slink("COLOR","u_input",1,0.25,true);slink_gr_c.min_filter=m_tex.TF_LINEAR;slink_gr_c.mag_filter=m_tex.TF_NEAREST;var step=max_ray_length/steps_per_pass;var cam_god_rays=cam_copy(main_cams[i]);cam_render.cameras.push(cam_god_rays);
var subs_god_rays=create_subs_god_rays(cam_god_rays,water,max_ray_length,true,step,num_lights,steps_per_pass);m_graph.append_node_attr(graph,subs_god_rays);m_graph.append_edge_attr(graph,subs_prev,subs_god_rays,slink_gr_d);step=max_ray_length/steps_per_pass*0.5;var cam_blur1=cam_copy(main_cams[i]);cam_render.cameras.push(cam_blur1);var subs_gr_blur1=create_subs_god_rays(cam_blur1,water,max_ray_length,false,step,num_lights,steps_per_pass);m_graph.append_node_attr(graph,subs_gr_blur1);m_graph.append_edge_attr(graph,
subs_god_rays,subs_gr_blur1,slink_gr_c);step=max_ray_length/steps_per_pass*0.25;var cam_blur2=cam_copy(main_cams[i]);cam_render.cameras.push(cam_blur2);var subs_gr_blur2=create_subs_god_rays(cam_blur2,water,max_ray_length,false,step,num_lights,steps_per_pass);m_graph.append_node_attr(graph,subs_gr_blur2);m_graph.append_edge_attr(graph,subs_gr_blur1,subs_gr_blur2,slink_gr_c);if(reflect_subscenes.length){subs_god_rays.reflection_plane=refl_planes[0];subs_gr_blur1.reflection_plane=refl_planes[0];subs_gr_blur2.reflection_plane=
refl_planes[0]}var subs_god_rays_comb=create_subs_god_rays_comb(intensity);curr_level.push(subs_god_rays_comb);m_graph.append_node_attr(graph,subs_god_rays_comb);m_graph.append_edge_attr(graph,subs_prev,subs_god_rays_comb,create_slink("COLOR","u_main",1,1,true));m_graph.append_edge_attr(graph,subs_gr_blur2,subs_god_rays_comb,create_slink("COLOR","u_god_rays",1,1,true))}prev_level=curr_level;curr_level=[]}if(bloom&&!render_to_texture){for(var i=0;i<main_cams.length;i++){var subs_prev=prev_level[i];
var subs_luminance=create_subs_luminance();m_graph.append_node_attr(graph,subs_luminance);m_graph.append_edge_attr(graph,subs_prev,subs_luminance,create_slink("COLOR","u_input",1,1,true));var subs_av_luminance=create_subs_av_luminance();m_graph.append_node_attr(graph,subs_av_luminance);subs_av_luminance.camera.width=tex_size;subs_av_luminance.camera.height=tex_size;var slink_luminance_av=create_slink("COLOR","u_input",1,0.25,true);slink_luminance_av.min_filter=m_tex.TF_LINEAR;slink_luminance_av.mag_filter=
m_tex.TF_LINEAR;var slink_luminance_tr=create_slink("COLOR","u_luminance",1,0.25,true);slink_luminance_tr.min_filter=m_tex.TF_LINEAR;slink_luminance_tr.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_luminance,subs_av_luminance,slink_luminance_av);var bloom_key=bloom_params.key;var edge_lum=bloom_params.edge_lum;var cam_luminance=cam_copy(main_cams[i]);cam_render.cameras.push(cam_luminance);var subs_lum_trunced=create_subs_luminance_trunced(bloom_key,edge_lum,num_lights,cam_luminance);
m_graph.append_node_attr(graph,subs_lum_trunced);m_graph.append_edge_attr(graph,subs_prev,subs_lum_trunced,create_slink("COLOR","u_main",1,1,true));m_graph.append_edge_attr(graph,subs_luminance,subs_lum_trunced,slink_luminance_tr);m_graph.append_edge_attr(graph,subs_av_luminance,subs_lum_trunced,create_slink("COLOR","u_average_lum",1,1,false));var slink_blur_in=create_slink("COLOR","u_color",1,0.25,true);slink_blur_in.min_filter=m_tex.TF_LINEAR;slink_blur_in.mag_filter=m_tex.TF_LINEAR;var blur_x=
create_subs_bloom_blur(graph,subs_luminance,"X_BLUR",true);m_graph.append_node_attr(graph,blur_x);m_graph.append_edge_attr(graph,subs_lum_trunced,blur_x,slink_blur_in);var blur_y=create_subs_bloom_blur(graph,blur_x,"Y_BLUR",true);m_graph.append_node_attr(graph,blur_y);m_graph.append_edge_attr(graph,blur_x,blur_y,slink_blur_in);var bloom_blur=bloom_params.blur;var subs_bloom_combine=create_subs_bloom_combine(bloom_blur);m_graph.append_node_attr(graph,subs_bloom_combine);m_graph.append_edge_attr(graph,
blur_y,subs_bloom_combine,create_slink("COLOR","u_bloom",1,0.25,true));m_graph.append_edge_attr(graph,subs_prev,subs_bloom_combine,create_slink("COLOR","u_main",1,1,true));curr_level.push(subs_bloom_combine)}prev_level=curr_level;curr_level=[]}if(motion_blur&&!render_to_texture){for(var i=0;i<prev_level.length;i++){var subs_to_blur=prev_level[i];var subs_mb=create_subs_motion_blur(mb_params.mb_decay_threshold,mb_params.mb_factor);curr_level.push(subs_mb);m_graph.append_node_attr(graph,subs_mb);var slink_mb_in=
create_slink("COLOR","u_mb_tex_curr",1,1,true);m_graph.append_edge_attr(graph,subs_to_blur,subs_mb,slink_mb_in);var slink_mb_accum=create_slink("COLOR","u_mb_tex_accum",1,1,true);subs_mb.slinks_internal.push(slink_mb_accum)}prev_level=curr_level;curr_level=[]}if(dof_on&&!render_to_texture){for(var i=0;i<prev_level.length;i++){var subs_prev=prev_level[i];var cam_dof=cam_copy(main_cams[i]);cam_render.cameras.push(cam_dof);var slink_blur_in=create_slink("COLOR","u_color",1,1,true);slink_blur_in.min_filter=
m_tex.TF_LINEAR;slink_blur_in.mag_filter=m_tex.TF_LINEAR;var pp_x=create_subs_postprocessing("X_BLUR");m_graph.append_node_attr(graph,pp_x);m_graph.append_edge_attr(graph,subs_prev,pp_x,slink_blur_in);var pp_y=create_subs_postprocessing("Y_BLUR");m_graph.append_node_attr(graph,pp_y);m_graph.append_edge_attr(graph,pp_x,pp_y,slink_blur_in);var subs_depth=blend_subscenes[i];var subs_dof=create_subs_dof(cam_dof);cam_dof.dof_distance=cam_render.dof_distance;cam_dof.dof_object=cam_render.dof_object;cam_dof.dof_front=
cam_render.dof_front;cam_dof.dof_rear=cam_render.dof_rear;cam_dof.dof_power=cam_render.dof_power;cam_dof.dof_on=1;curr_level.push(subs_dof);m_graph.append_node_attr(graph,subs_dof);m_graph.append_edge_attr(graph,subs_prev,subs_dof,create_slink("COLOR","u_sharp",1,1,true));m_graph.append_edge_attr(graph,pp_y,subs_dof,create_slink("COLOR","u_blurred",1,1,true));m_graph.append_edge_attr(graph,subs_depth,subs_dof,create_slink("DEPTH","u_depth",1,1,true))}prev_level=curr_level;curr_level=[]}if(!render_to_texture&&
sc_render.glow){for(var i=0;i<main_cams.length;i++){var subs_prev=prev_level[i];var cam_glow=cam_copy(main_cams[i]);cam_render.cameras.push(cam_glow);var subs_glow_mask=create_subs_glow_mask(cam_glow);m_graph.append_node_attr(graph,subs_glow_mask);var pp_x_ext=create_subs_postprocessing("X_EXTEND");var slink_mask_pp=create_slink("COLOR","u_color",1,1,true);var slink_mask_gl=create_slink("COLOR","u_glow_mask",1,1,true);pp_x_ext.is_for_glow=true;m_graph.append_node_attr(graph,pp_x_ext);m_graph.append_edge_attr(graph,
subs_glow_mask,pp_x_ext,slink_mask_pp);var slink_ext=create_slink("COLOR","u_color",1,0.5,true);slink_ext.min_filter=m_tex.TF_LINEAR;slink_ext.mag_filter=m_tex.TF_LINEAR;var pp_y_ext=create_subs_postprocessing("Y_EXTEND");pp_y_ext.is_for_glow=true;m_graph.append_node_attr(graph,pp_y_ext);m_graph.append_edge_attr(graph,pp_x_ext,pp_y_ext,slink_ext);var pp_x=create_subs_postprocessing("X_BLUR");pp_x.is_for_glow=true;m_graph.append_node_attr(graph,pp_x);m_graph.append_edge_attr(graph,pp_y_ext,pp_x,slink_ext);
var slink_blur_blur=create_slink("COLOR","u_color",1,0.25,true);slink_blur_blur.min_filter=m_tex.TF_LINEAR;slink_blur_blur.mag_filter=m_tex.TF_LINEAR;var slink_blur_glow=create_slink("COLOR","u_glow_mask_blurred",1,0.25,true);slink_blur_glow.min_filter=m_tex.TF_LINEAR;slink_blur_glow.mag_filter=m_tex.TF_LINEAR;var pp_y=create_subs_postprocessing("Y_BLUR");pp_y.is_for_glow=true;m_graph.append_node_attr(graph,pp_y);m_graph.append_edge_attr(graph,pp_x,pp_y,slink_blur_blur);var subs_glow=create_subs_glow(glow_params);
m_graph.append_node_attr(graph,subs_glow);m_graph.append_edge_attr(graph,subs_prev,subs_glow,create_slink("COLOR","u_glow_src",1,1,true));m_graph.append_edge_attr(graph,subs_glow_mask,subs_glow,slink_mask_gl);m_graph.append_edge_attr(graph,pp_y,subs_glow,slink_blur_glow);curr_level.push(subs_glow)}prev_level=curr_level;curr_level=[]}if(compositing&&!render_to_texture){for(var i=0;i<prev_level.length;i++){var subs_prev=prev_level[i];var brightness=cc_params.brightness;var contrast=cc_params.contrast;
var exposure=cc_params.exposure;var saturation=cc_params.saturation;var subs_compositing=create_subs_compositing(brightness,contrast,exposure,saturation);m_graph.append_node_attr(graph,subs_compositing);m_graph.append_edge_attr(graph,subs_prev,subs_compositing,create_slink("COLOR","u_color",1,1,true));curr_level.push(subs_compositing)}prev_level=curr_level;curr_level=[]}if(antialiasing&&!render_to_texture){for(var i=0;i<prev_level.length;i++){var subs_prev=prev_level[i];if(cfg_def.smaa&&!m_cfg.context.alpha){var depth_subs=
find_upper_subs(graph,subs_prev,"DEPTH");var cam_velocity=cam_copy(main_cams[i]);cam_render.cameras.push(cam_velocity);var subs_velocity=create_subs_veloctity(cam_velocity);var slink_velocity_in=create_slink("DEPTH","u_depth",1,1,true);slink_velocity_in.min_filter=m_tex.TF_NEAREST;slink_velocity_in.mag_filter=m_tex.TF_NEAREST;m_graph.append_node_attr(graph,subs_velocity);m_graph.append_edge_attr(graph,depth_subs,subs_velocity,slink_velocity_in);var slink_velocity_smaa=create_slink("COLOR","u_velocity_tex",
1,1,true);var subs_smaa_1=create_subs_smaa("SMAA_EDGE_DETECTION");m_graph.append_node_attr(graph,subs_smaa_1);var slink_smaa_in=create_slink("COLOR","u_color",1,1,true);slink_smaa_in.min_filter=m_tex.TF_LINEAR;slink_smaa_in.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_prev,subs_smaa_1,slink_smaa_in);var subs_smaa_2=create_subs_smaa("SMAA_BLENDING_WEIGHT_CALCULATION");m_graph.append_node_attr(graph,subs_smaa_2);m_graph.append_edge_attr(graph,subs_smaa_1,subs_smaa_2,slink_smaa_in);
var slink_search_tex=create_slink("COLOR","u_search_tex",1,1,false);var slink_area_tex=create_slink("COLOR","u_area_tex",1,1,false);slink_search_tex.min_filter=m_tex.TF_LINEAR;slink_search_tex.mag_filter=m_tex.TF_LINEAR;slink_area_tex.min_filter=m_tex.TF_LINEAR;slink_area_tex.mag_filter=m_tex.TF_LINEAR;subs_smaa_2.slinks_internal.push(slink_search_tex);subs_smaa_2.slinks_internal.push(slink_area_tex);var subs_smaa_3=create_subs_smaa("SMAA_NEIGHBORHOOD_BLENDING");m_graph.append_node_attr(graph,subs_smaa_3);
m_graph.append_edge_attr(graph,subs_prev,subs_smaa_3,slink_smaa_in);var slink_smaa_blend=create_slink("COLOR","u_blend",1,1,true);slink_smaa_blend.min_filter=m_tex.TF_LINEAR;slink_smaa_blend.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_smaa_2,subs_smaa_3,slink_smaa_blend);m_graph.append_edge_attr(graph,subs_velocity,subs_smaa_3,slink_velocity_smaa);var subs_smaa_r=create_subs_smaa("SMAA_RESOLVE");m_graph.append_node_attr(graph,subs_smaa_r);m_graph.append_edge_attr(graph,subs_smaa_3,
subs_smaa_r,slink_smaa_in);m_graph.append_edge_attr(graph,subs_velocity,subs_smaa_r,slink_velocity_smaa);var slink_smaa_in_prev=create_slink("COLOR","u_color_prev",1,1,true);slink_smaa_in_prev.min_filter=m_tex.TF_LINEAR;slink_smaa_in_prev.mag_filter=m_tex.TF_LINEAR;subs_smaa_r.slinks_internal.push(slink_smaa_in_prev);curr_level.push(subs_smaa_r)}else{var subs_aa=create_subs_aa();m_graph.append_node_attr(graph,subs_aa);var slink_aa_in=create_slink("COLOR","u_color",1,1,true);slink_aa_in.min_filter=
m_tex.TF_LINEAR;slink_aa_in.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_prev,subs_aa,slink_aa_in);if(cfg_def.resolution_factor>1){var subs_rescale=create_subs_postprocessing("NONE");m_graph.append_node_attr(graph,subs_rescale);m_graph.append_edge_attr(graph,subs_aa,subs_rescale,slink_aa_in);curr_level.push(subs_rescale)}else curr_level.push(subs_aa)}}prev_level=curr_level;curr_level=[]}if(cfg_def.anaglyph_use&&!render_to_texture){var subs_anaglyph=create_subs_anaglyph();m_graph.append_node_attr(graph,
subs_anaglyph);m_graph.append_edge_attr(graph,prev_level[0],subs_anaglyph,create_slink("COLOR","u_sampler_left",1,1,true));m_graph.append_edge_attr(graph,prev_level[1],subs_anaglyph,create_slink("COLOR","u_sampler_right",1,1,true));curr_level.push(subs_anaglyph)}else curr_level.push(prev_level[0]);var prev_id=m_graph.node_by_attr(graph,prev_level[0]);var need_subs_screen=false;m_graph.traverse_inputs(graph,prev_id,function(id_in,attr_in,attr_edge){var slink_in=attr_edge;if(slink_in.from==slink_in.to){need_subs_screen=
true;return true}});if(need_subs_screen||render_to_texture){var subs_screen=create_subs_screen(prev_level[0]);m_graph.append_node_attr(graph,subs_screen);m_graph.append_edge_attr(graph,prev_level[0],subs_screen,create_slink("COLOR","u_color",1,1,true));prev_level=curr_level;curr_level=[];curr_level.push(subs_screen)}if(subs_color_picking)curr_level.push(subs_color_picking);if(!render_to_texture&&sc_render.procedural_sky){var sky_params=sc_render.sky_params;var subs_sky=create_subs_sky(num_lights,
sky_params);m_graph.append_node_attr(graph,subs_sky);curr_level.push(subs_sky)}var subs_sink=create_subs_sink();m_graph.append_node_attr(graph,subs_sink);for(var i=0;i<curr_level.length;i++){var subs=curr_level[i];switch(subs.type){case "COLOR_PICKING":m_graph.append_edge_attr(graph,curr_level[i],subs_sink,create_slink("COLOR","NONE",1,1,true));m_graph.append_edge_attr(graph,curr_level[i],subs_sink,create_slink("DEPTH","NONE",1,1,true));break;case "SKY":var slink_sky=create_slink("CUBEMAP","u_sky",
SKY_TEX_SIZE,1,false);m_graph.append_edge_attr(graph,subs_sky,subs_sink,slink_sky);break;default:m_graph.append_edge_attr(graph,curr_level[i],subs_sink,create_slink("SCREEN","NONE",1,1,true));break}}var sink_nodes=m_graph.get_sink_nodes(graph);for(var i=0;i<sink_nodes.length;i++){var sink_node=sink_nodes[i];for(var j=0;j<depth_subscenes.length;j++){var subs_depth=depth_subscenes[j];if(m_graph.get_node_attr(graph,sink_node)==subs_depth)m_graph.remove_node(graph,sink_node)}}enforce_graph_consistency(graph,
false);if(cfg_def.resolution_factor>1)apply_resolution_factor(graph);process_subscene_links(graph);assign_render_targets(graph);return graph};function create_subs_shadow_cast(csm_index){var subs=init_subs("SHADOW_CAST");subs.enqueue=true;subs.csm_index=csm_index;subs.wind=new Float32Array(3);var cam=m_cam.create_camera(m_cam.TYPE_ORTHO_ASYMMETRIC);subs.camera=cam;return subs}function init_subs(type){var subs={};subs.type=type;subs.bundles=[];subs.do_render=true;subs.enqueue=true;subs.clear_color=
true;subs.clear_depth=true;subs.depth_test=true;subs.blend=false;subs.assign_texture=false;subs.lights=[];subs.need_perm_uniforms_update=true;subs.slinks_internal=[];subs.textures_internal=[];subs.debug_render_calls=0;subs.jitter_projection_space=new Float32Array(2);return subs}function create_slink(from,to,size,size_mult,update_dim){var slink={from:from,to:to,size:size,size_mult:size_mult,update_dim:update_dim,active:true,texture:null,use_renderbuffer:false,min_filter:m_tex.TF_NEAREST,mag_filter:m_tex.TF_NEAREST};
return slink}function create_subs_grass_map(){var subs=init_subs("GRASS_MAP");subs.enqueue=true;var cam=m_cam.create_camera(m_cam.TYPE_ORTHO_ASPECT);subs.camera=cam;subs.grass_map_dim=new Float32Array(3);return subs}function create_subs_postprocessing(pp_effect){var pp_subs=init_subs("POSTPROCESSING");pp_subs.enqueue=true;pp_subs.clear_color=false;pp_subs.clear_depth=false;pp_subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);pp_subs.camera=cam;pp_subs.pp_effect=pp_effect;return pp_subs}
function create_subs_bloom_blur(graph,subs_input,pp_effect){var subs=init_subs("BLOOM_BLUR");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;subs.pp_effect=pp_effect;return subs}function create_subs_main(main_type,cam,subs_attach_out,water_params,num_lights,fog,wls_params,shadow_params){var subs=init_subs("MAIN_"+main_type);subs.enqueue=true;if(main_type==="OPAQUE"&&subs_attach_out){subs.clear_color=
true;subs.clear_depth=false;subs.blend=false}else if(main_type==="OPAQUE"){subs.clear_color=true;subs.clear_depth=true;subs.blend=false}else if(main_type==="BLEND"&&subs_attach_out){subs.clear_color=false;subs.clear_depth=false;subs.blend=true}else if(main_type==="BLEND"){subs.clear_color=true;subs.clear_depth=true;subs.blend=true}else if(main_type==="REFLECT"){subs.clear_color=true;subs.clear_depth=true;subs.blend=false}else throw"wrong main subscene type";if(main_type=="BLEND"){subs.zsort_eye_last=
new Float32Array([0,0,0]);if(shadow_params)subs.shadow_visibility_falloff=shadow_params.visibility_falloff;else subs.shadow_visibility_falloff=0}subs.camera=cam;subs.horizon_color=new Float32Array(wls_params.horizon_color);subs.zenith_color=new Float32Array(wls_params.zenith_color);subs.environment_energy=wls_params.environment_energy;subs.fog_color_density=fog;subs.wind=new Float32Array(3);if(water_params){subs.water_params=water_params;var wp=water_params;if(wp.fog_color_density){subs.water_fog_color_density=
new Float32Array(4);m_vec4.copy(wp.fog_color_density,subs.water_fog_color_density)}else subs.water_fog_color_density=null;subs.water_waves_height=wp.waves_height;subs.water_waves_length=wp.waves_length;subs.water_level=wp.water_level;if(wp.caustic_scale){subs.caustics=1;subs.caust_scale=wp.caustic_scale;subs.caust_speed=wp.caustic_speed;subs.caust_brightness=wp.caustic_brightness}else subs.caustics=0;if(wp.shoremap_image){subs.shoremap_center=new Float32Array(2);subs.shoremap_size=new Float32Array(2);
var shore_boundings=wp.shore_boundings;subs.shoremap_center[0]=(shore_boundings[0]+shore_boundings[1])/2;subs.shoremap_center[1]=(shore_boundings[2]+shore_boundings[3])/2;subs.shoremap_size[0]=shore_boundings[0]-shore_boundings[1];subs.shoremap_size[1]=shore_boundings[2]-shore_boundings[3];subs.shoremap_tex_size=wp.shoremap_tex_size;subs.shoremap_image=wp.shoremap_image;subs.max_shore_dist=wp.max_shore_dist}else{subs.shoremap_center=null;subs.shoremap_size=null;subs.shoremap_tex_size=null;subs.shoremap_image=
null}}else subs.water_params=null;subs.num_lights=0;subs.light_directions=new Float32Array(num_lights*3);subs.light_positions=new Float32Array(num_lights*3);subs.light_color_intensities=new Float32Array(num_lights*3);subs.light_factors1=new Float32Array(num_lights*4);subs.light_factors2=new Float32Array(num_lights*4);subs.sun_quaternion=new Float32Array(4);subs.sun_intensity=new Float32Array(3);subs.sun_direction=new Float32Array(3);return subs}function assign_inputs(graph,subs,inputs){for(var i=
0;i<inputs.length;i++)m_graph.append_edge_attr(graph,inputs[i],subs)}function create_subs_color_picking(cam){var subs=init_subs("COLOR_PICKING");subs.enqueue=false;subs.camera=cam;subs.wind=new Float32Array(3);return subs}function create_subs_wireframe(cam){var subs=init_subs("WIREFRAME");subs.do_render=false;subs.clear_color=false;subs.clear_depth=false;subs.camera=cam;return subs}function create_subs_depth_shadow(graph,cam,shadow_visibility_falloff){var subs=init_subs("DEPTH");subs.enqueue=true;
subs.camera=cam;subs.shadow_visibility_falloff=shadow_visibility_falloff;subs.wind=new Float32Array(3);return subs}function create_subs_blur_depth(cam_blur_depth,orient,blur_depth_size_mult,blur_depth_edge_size,blur_depth_diff_threshold){var subs=init_subs("BLUR_DEPTH");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=cam_blur_depth;subs.orientation=orient;subs.blur_depth_size_mult=blur_depth_size_mult;subs.blur_depth_edge_size=blur_depth_edge_size;
subs.blur_depth_diff_threshold=blur_depth_diff_threshold;return subs}function create_subs_depth_pack(cam){var subs=init_subs("DEPTH_PACK");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.camera=cam;return subs}function create_subs_ssao(cam,fog,ssao_params){var subs=init_subs("SSAO");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=cam;subs.fog_color_density=fog;subs.water_fog_color_density=new Float32Array(4);m_vec4.copy(fog,subs.water_fog_color_density);
subs.ssao_radius_increase=ssao_params.radius_increase;subs.ssao_dithering_amount=ssao_params.dithering_amount/1E3;subs.ssao_gauss_center=ssao_params.gauss_center;subs.ssao_gauss_width_square=ssao_params.gauss_width_square;subs.ssao_gauss_width_left_square=ssao_params.gauss_width_left_square;subs.ssao_influence=ssao_params.influence;subs.ssao_dist_factor=ssao_params.dist_factor;subs.ssao_samples=ssao_params.samples;subs.ssao_only=0;return subs}function create_subs_aa(){var subs=init_subs("ANTIALIASING");
subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;return subs}function create_subs_smaa(pass){var subs=init_subs(pass);subs.enqueue=true;if(pass=="SMAA_BLENDING_WEIGHT_CALCULATION"||pass=="SMAA_EDGE_DETECTION")subs.clear_color=true;else subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;if(pass=="SMAA_BLENDING_WEIGHT_CALCULATION")subs.jitter_subsample_ind=
new Float32Array(4);return subs}function create_subs_compositing(brightness,contrast,exposure,saturation){var subs=init_subs("COMPOSITING");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;subs.brightness=brightness;subs.contrast=contrast;subs.exposure=exposure;subs.saturation=saturation;return subs}function create_subs_motion_blur(mb_decay_threshold,mb_factor){var mb_subs=init_subs("MOTION_BLUR");mb_subs.enqueue=
true;mb_subs.clear_color=false;mb_subs.clear_depth=false;mb_subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);mb_subs.camera=cam;mb_subs.assign_texture=true;mb_subs.mb_decay_threshold=mb_decay_threshold;mb_subs.mb_factor=mb_factor;return mb_subs}function create_subs_dof(cam){var subs=init_subs("DOF");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=cam;return subs}function create_subs_glow_mask(cam){var subs=init_subs("GLOW_MASK");
subs.camera=cam;subs.wind=new Float32Array(3);subs.depth_test=false;return subs}function create_subs_glow(glow_params){var subs=init_subs("GLOW");subs.glow_color=glow_params.glow_color;subs.glow_factor=glow_params.glow_factor;subs.ext_texel_size_mult=5;subs.blur_texel_size_mult=3;subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;return subs}function create_subs_refract(){var subs=init_subs("REFRACT");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;
subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;return subs}function create_subs_god_rays(cam,water,ray_length,pack,step,num_lights,steps_per_pass){var subs=init_subs("GOD_RAYS");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.horizon_color=new Float32Array([1,1,1]);subs.zenith_color=new Float32Array([1,1,1]);subs.environment_energy=1;subs.pack=pack;subs.water=water;subs.radial_blur_step=step;subs.max_ray_length=ray_length;
subs.steps_per_pass=steps_per_pass;subs.camera=cam;subs.num_lights=num_lights;subs.light_directions=new Float32Array(num_lights*3);subs.light_positions=new Float32Array(num_lights*3);subs.light_color_intensities=new Float32Array(num_lights*3);subs.light_factors1=new Float32Array(num_lights*4);subs.light_factors2=new Float32Array(num_lights*4);subs.sun_quaternion=new Float32Array(4);subs.sun_intensity=new Float32Array(3);subs.sun_direction=new Float32Array(3);subs.wind=new Float32Array(3);return subs}
function create_subs_god_rays_comb(intensity){var subs=init_subs("GOD_RAYS_COMBINE");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;subs.god_rays_intensity=intensity;return subs}function create_subs_sky(num_lights,sky_params){var subs=init_subs("SKY");subs.enqueue=false;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);cam.width=SKY_TEX_SIZE;
cam.height=SKY_TEX_SIZE;subs.camera=cam;subs.cube_view_matrices=m_util.generate_cubemap_matrices();subs.num_lights=num_lights;subs.light_directions=new Float32Array(num_lights*3);subs.light_positions=new Float32Array(num_lights*3);subs.light_color_intensities=new Float32Array(num_lights*3);subs.light_factors1=new Float32Array(num_lights*4);subs.light_factors2=new Float32Array(num_lights*4);subs.sun_quaternion=new Float32Array(4);subs.sun_intensity=new Float32Array(3);subs.sun_direction=new Float32Array(3);
subs.horizon_color=new Float32Array([1,1,1]);subs.zenith_color=new Float32Array([1,1,1]);subs.environment_energy=1;subs.sky_color=new Float32Array(sky_params.sky_color);subs.rayleigh_brightness=sky_params.rayleigh_brightness;subs.mie_brightness=sky_params.mie_brightness;subs.spot_brightness=sky_params.spot_brightness;subs.scatter_strength=sky_params.scatter_strength;subs.rayleigh_strength=sky_params.rayleigh_strength;subs.mie_strength=sky_params.mie_strength;subs.rayleigh_collection_power=sky_params.rayleigh_collection_power;
subs.mie_collection_power=sky_params.mie_collection_power;subs.mie_distribution=sky_params.mie_distribution;subs.need_fog_update=false;subs.cube_fog=new Float32Array(16);return subs}function create_subs_screen(){var subs=init_subs("SCREEN");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;return subs}function create_subs_anaglyph(){var subs=init_subs("ANAGLYPH");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;
var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;return subs}function create_subs_luminance(){var subs=init_subs("LUMINANCE");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;return subs}function create_subs_av_luminance(){var subs=init_subs("AVERAGE_LUMINANCE");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;return subs}function create_subs_luminance_trunced(bloom_key,
edge_lum,num_lights,cam){var subs=init_subs("LUMINANCE_TRUNCED");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.bloom_key=bloom_key;subs.bloom_edge_lum=edge_lum;subs.camera=cam;subs.num_lights=0;subs.light_directions=new Float32Array(num_lights*3);subs.light_positions=new Float32Array(num_lights*3);subs.light_color_intensities=new Float32Array(num_lights*3);subs.light_factors1=new Float32Array(num_lights*4);subs.light_factors2=new Float32Array(num_lights*4);subs.sun_quaternion=
new Float32Array(4);subs.sun_intensity=new Float32Array(3);subs.sun_direction=new Float32Array(3);subs.horizon_color=new Float32Array(3);subs.zenith_color=new Float32Array(3);subs.environment_energy=0;return subs}function create_subs_bloom_combine(blur){var subs=init_subs("BLOOM");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;subs.bloom_blur=blur;return subs}function create_subs_hud(){var subs=init_subs("HUD");subs.enqueue=
true;subs.clear_color=false;subs.clear_depth=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);subs.camera=cam;return subs}function create_subs_veloctity(cam){var subs=init_subs("VELOCITY");subs.enqueue=true;subs.clear_color=false;subs.clear_depth=false;subs.camera=cam;return subs}function create_subs_sink(){var subs_sink=init_subs("SINK");subs_sink.enqueue=false;return subs_sink}function find_sink_subs(graph){var sink_nodes=m_graph.get_sink_nodes(graph);if(sink_nodes.length==0)throw"No sink subscene";
else if(sink_nodes.length==1)return m_graph.get_node_attr(graph,sink_nodes[0]);else throw"Rendering graph is corrupted";}exports.find_on_screen=function(graph){var subs=null;m_graph.traverse(graph,function(node,attr){if(attr.camera&&attr.camera.framebuffer===null){subs=attr;return true}return false});return subs};exports.find_input=function(graph,subs,type){var inputs=get_inputs(graph,subs);for(var i=0;i<inputs.length;i++)if(inputs[i].type===type)return inputs[i];return null};exports.has_lower_subs=
has_lower_subs;function has_lower_subs(graph,subs,type){if(subs.type===type)return true;var outputs=get_outputs(graph,subs);for(var i=0;i<outputs.length;i++)if(has_lower_subs(graph,outputs[i],type))return true;return false}exports.has_upper_subs=has_upper_subs;function has_upper_subs(graph,subs,type){if(subs.type===type)return true;var inputs=get_inputs(graph,subs);for(var i=0;i<inputs.length;i++)if(has_upper_subs(graph,inputs[i],type))return true;return false}exports.find_upper_subs=find_upper_subs;
function find_upper_subs(graph,subs,type){if(subs.type===type)return subs;var inputs=get_inputs(graph,subs);for(var i=0;i<inputs.length;i++){var upper=find_upper_subs(graph,inputs[i],type);if(upper)return upper}return null}exports.get_inputs=get_inputs;function get_inputs(graph,subs){var node=m_graph.node_by_attr(graph,subs);if(node==m_graph.NULL_NODE)throw"Subscene not in graph";var inputs=[];var in_edge_count=m_graph.in_edge_count(graph,node);for(var i=0;i<in_edge_count;i++){var node_input=m_graph.get_in_edge(graph,
node,i);if(node_input!=node)inputs.push(m_graph.get_node_attr(graph,node_input))}return inputs}exports.get_outputs=get_outputs;function get_outputs(graph,subs){var node=m_graph.node_by_attr(graph,subs);if(node==m_graph.NULL_NODE)throw"Subscene not in graph";var outputs=[];var out_edge_count=m_graph.out_edge_count(graph,node);for(var i=0;i<out_edge_count;i++){var node_output=m_graph.get_out_edge(graph,node,i);if(node_output!=node)outputs.push(m_graph.get_node_attr(graph,node_output))}return outputs}
exports.find_subs=function(graph,type){var subs=null;m_graph.traverse(graph,function(node,attr){if(attr.type==type){subs=attr;return true}return false});return subs};exports.debug_convert_to_dot=function(graph){var PAPER_SIZE="11.7,16.5";var dot_str="digraph scenegraph {\n";dot_str+="    ";dot_str+='size="'+PAPER_SIZE+'";\n';dot_str+="    ";dot_str+='ratio="fill";\n';dot_str+="    ";dot_str+='node [shape=box margin="0.25,0.055"];\n';var tex_ids=debug_calc_tex_ids(graph);m_graph.traverse(graph,function(node,
attr){dot_str+="    ";dot_str+=dot_format_node(node,attr,tex_ids)});m_graph.traverse_edges(graph,function(node1,node2,attr){dot_str+="    ";dot_str+=dot_format_edge(node1,node2,attr,tex_ids)});dot_str+="}";return dot_str};function debug_calc_tex_ids(graph){var index_buf=[];var ids=[];traverse_slinks(graph,function(slink,internal,subs1,subs2){if(slink.texture){var num=index_buf.indexOf(slink.texture);if(num==-1){index_buf.push(slink.texture);ids.push(slink.texture,index_buf.length-1)}}});return ids}
function dot_format_node(node,subs,tex_ids){var cam=subs.camera;var label="";var label=subs.type.replace(/_/g," ");if(subs.type=="POSTPROCESSING")label+=" ("+subs.pp_effect.replace(/_/g," ")+")";else if(subs.type=="BLUR_DEPTH")label+=" ("+subs.orientation+")";if(subs.camera){label+="\\n";for(var i=0;i<tex_ids.length;i+=2)if(tex_ids[i]==subs.camera.color_attachment)label+="C"+tex_ids[i+1]+" ";for(var i=0;i<tex_ids.length;i+=2)if(tex_ids[i]==subs.camera.depth_attachment)label+="D"+tex_ids[i+1]}if(subs.slinks_internal.length)label+=
"\\n-----\\n";for(var i=0;i<subs.slinks_internal.length;i++)label+=dot_format_edge_label(subs.slinks_internal[i],node,null,tex_ids);var color="black";if(subs.type=="SINK")var style="dotted";else if(subs.enqueue)var style="solid";else var style="dashed";style+=",bold";return String(node)+' [label="'+label+'" '+'color="'+color+'" '+'style="'+style+'"'+"];\n"}function dot_format_edge(node1,node2,slink,tex_ids){var label=dot_format_edge_label(slink,node1,node2,tex_ids);if(slink.active)var style="solid";
else var style="dotted";return String(node1)+" -> "+String(node2)+' [label="'+label+'" '+'style="'+style+'"];\n'}function dot_format_edge_label(slink,node1,node2,tex_ids){function filters_to_string(filters){var string="";if(filters.min==m_tex.TF_LINEAR)string+="L";else if(filters.min==m_tex.TF_NEAREST)string+="N";if(filters.mag==m_tex.TF_LINEAR)string+="L";else if(filters.mag==m_tex.TF_NEAREST)string+="N";return string}var label="";label+=slink.from+"\\n";label+=slink.to!="NONE"?slink.to+"\\n":"";
label+="(";if(slink.update_dim){var size_mult=slink.size_mult;if(Math.round(size_mult)!=size_mult)size_mult=size_mult.toFixed(2);var size=(size_mult==1?"":size_mult)+"S";label+=size+"x"+size}else label+=slink.size+"x"+slink.size;if(slink.from!="SCREEN"){label+=" ";if(slink.use_renderbuffer)label+="RR";else label+=filters_to_string({min:slink.min_filter,mag:slink.mag_filter});for(var i=0;i<tex_ids.length;i+=2)if(tex_ids[i]==slink.texture)label+=" "+tex_ids[i+1]}label+=")"+"\\n";return label}exports.create_rendering_queue=
function(graph){var subscenes=m_graph.topsort_attr(graph);var queue=[];for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(subs.enqueue)queue.push(subs)}return queue}};b4w.module["__textures"]=function(exports,require){var config=require("__config");var m_print=require("__print");var m_dds=require("__dds");var extensions=require("__extensions");var util=require("__util");var cfg_def=config.defaults;exports.TF_NEAREST=0;exports.TF_LINEAR=0;exports.TF_NEAREST_MIPMAP_NEAREST=0;exports.TF_LINEAR_MIPMAP_NEAREST=0;exports.TF_NEAREST_MIPMAP_LINEAR=0;exports.TF_LINEAR_MIPMAP_LINEAR=0;exports.TT_RGBA_INT=10;exports.TT_RGB_INT=20;exports.TT_RGBA_FLOAT=30;exports.TT_RGB_FLOAT=
40;exports.TT_DEPTH=50;exports.TT_RENDERBUFFER=60;var CHANNEL_SIZE_BYTES_INT=4;var CHANNEL_SIZE_BYTES_FLOAT=16;var CHANNEL_SIZE_BYTES_DEPTH=3;var CHANNEL_SIZE_BYTES_RENDERBUFFER=2;var _gl=null;var LEVELS;exports.setup_context=function(gl){LEVELS=[gl.NEAREST_MIPMAP_NEAREST,gl.NEAREST_MIPMAP_LINEAR,gl.LINEAR_MIPMAP_NEAREST,gl.LINEAR_MIPMAP_LINEAR];exports.TF_NEAREST=gl.NEAREST;exports.TF_LINEAR=gl.LINEAR;exports.TF_NEAREST_MIPMAP_NEAREST=gl.NEAREST_MIPMAP_NEAREST;exports.TF_LINEAR_MIPMAP_NEAREST=gl.LINEAR_MIPMAP_NEAREST;
exports.TF_NEAREST_MIPMAP_LINEAR=gl.NEAREST_MIPMAP_LINEAR;exports.TF_LINEAR_MIPMAP_LINEAR=gl.LINEAR_MIPMAP_LINEAR;_gl=gl};exports.create_texture=function(name,type){var texture={};texture.name=name;texture.type=type;texture.source="NONE";texture.width=0;texture.height=0;texture.compress_ratio=1;if(type==exports.TT_RENDERBUFFER)texture.w_renderbuffer=_gl.createRenderbuffer();else{var w_target=_gl.TEXTURE_2D;var w_texture=_gl.createTexture();_gl.bindTexture(w_target,w_texture);_gl.texParameteri(w_target,
_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.bindTexture(w_target,null);texture.w_target=w_target;texture.w_texture=w_texture}return texture};exports.create_cubemap_texture=function(name,size){var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_CUBE_MAP;_gl.bindTexture(w_target,w_texture);_gl.texParameteri(w_target,
_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);var infos=["TEXTURE_CUBE_MAP_POSITIVE_X","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_CUBE_MAP_NEGATIVE_Z"];for(var i=0;i<6;i++){var info=infos[i];_gl.texImage2D(_gl[info],0,_gl.RGBA,size,size,
0,_gl.RGBA,_gl.UNSIGNED_BYTE,null)}_gl.bindTexture(w_target,null);var texture={};texture.name=name;texture.type=exports.TT_RGBA_INT;texture.source="NONE";texture.width=3*size;texture.height=2*size;texture.compress_ratio=1;texture.w_texture=w_texture;texture.w_target=_gl.TEXTURE_CUBE_MAP;return texture};exports.set_filters=function(texture,min_filter,mag_filter){if(texture.type==exports.TT_RENDERBUFFER)return;var w_target=texture.w_target;var w_texture=texture.w_texture;_gl.bindTexture(w_target,w_texture);
if(min_filter)_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,min_filter);if(mag_filter)_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,mag_filter);_gl.bindTexture(w_target,null)};exports.get_filters=function(texture){if(texture.type==exports.TT_RENDERBUFFER)return{min:exports.TF_NEAREST,mag:exports.TF_NEAREST};var w_target=texture.w_target;var w_texture=texture.w_texture;_gl.bindTexture(w_target,w_texture);var min=_gl.getTexParameter(w_target,_gl.TEXTURE_MIN_FILTER);var mag=_gl.getTexParameter(w_target,
_gl.TEXTURE_MAG_FILTER);_gl.bindTexture(w_target,null);return{min:min,mag:mag}};exports.resize=function(texture,width,height){var width=Math.max(width,1);var height=Math.max(height,1);if(texture.width==width&&texture.height==height)return;if(texture.type==exports.TT_RENDERBUFFER){_gl.bindRenderbuffer(_gl.RENDERBUFFER,texture.w_renderbuffer);_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,width,height);_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}else{var w_tex=texture.w_texture;var w_target=
texture.w_target;_gl.bindTexture(w_target,w_tex);var format=get_image2d_format(texture);var type=get_image2d_type(texture);_gl.texImage2D(w_target,0,format,width,height,0,format,type,null);_gl.bindTexture(w_target,null)}texture.width=width;texture.height=height};exports.create_texture_bpy=function(bpy_texture,global_af,bpy_scenes){var tex_type=bpy_texture["type"];var image_data=new Uint8Array([0.8*255,0.8*255,0.8*255,1*255]);var texture={};switch(tex_type){case "IMAGE":var w_texture=_gl.createTexture();
var w_target=_gl.TEXTURE_2D;_gl.bindTexture(w_target,w_texture);_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);break;case "NONE":if(bpy_texture["b4w_render_scene"]){var name=bpy_texture["b4w_render_scene"];var scene=util.keysearch("name",name,bpy_scenes);if(scene){texture.offscreen_scene=scene;scene._render_to_texture=true;var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_2D;_gl.bindTexture(w_target,w_texture);_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,
_gl.UNSIGNED_BYTE,image_data)}else return null}else return null;break;case "ENVIRONMENT_MAP":var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_CUBE_MAP;_gl.bindTexture(w_target,w_texture);var targets=["POSITIVE_X","NEGATIVE_X","POSITIVE_Y","NEGATIVE_Y","POSITIVE_Z","NEGATIVE_Z"];for(var i=0;i<6;i++)_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_"+targets[i]],0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);break;case "VORONOI":case "BLEND":return null;default:m_print.error('B4W warning: texture "'+
bpy_texture["name"]+'" has unsupported type "'+tex_type+'"');return null}if(tex_type=="NONE")_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);else _gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,LEVELS[cfg_def.texture_min_filter]);_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);setup_anisotropic_filtering(bpy_texture,global_af,w_target);var tex_extension=bpy_texture["extension"];if(tex_extension=="REPEAT"&&tex_type!="NONE"){_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,
_gl.REPEAT);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.REPEAT)}else{_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE)}_gl.generateMipmap(w_target);_gl.bindTexture(w_target,null);texture.name=bpy_texture["name"];texture.type=exports.TT_RGBA_INT;texture.source=tex_type;texture.width=1;texture.height=1;texture.compress_ratio=1;texture.w_texture=w_texture;texture.w_target=w_target;bpy_texture._render=texture;return texture};
function setup_anisotropic_filtering(bpy_texture,global_af,w_target){var af=bpy_texture["b4w_anisotropic_filtering"];if(af==="DEFAULT")af=global_af;if(af!=="OFF"){var ext_aniso=extensions.get_aniso();if(ext_aniso){af=parseFloat(af.split("x")[0]);_gl.texParameterf(w_target,ext_aniso.TEXTURE_MAX_ANISOTROPY_EXT,af)}}}exports.create_texture_canvas=function(name,width,height){var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_2D;_gl.bindTexture(w_target,w_texture);_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,
_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.bindTexture(w_target,null);var canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;var canvas_context=canvas.getContext("2d");var texture={};texture.name=name;texture.type=exports.TT_RGBA_INT;texture.source="CANVAS";texture.width=width;texture.height=height;texture.compress_ratio=
1;texture.w_texture=w_texture;texture.w_target=w_target;texture.canvas=canvas;texture.canvas_context=canvas_context;return texture};exports.resize_texture_canvas=function(texture,width,height){if(texture.source!="CANVAS")throw"Wrong texture";var width=Math.max(width,1);var height=Math.max(height,1);var canvas=texture.canvas;canvas.width=width;canvas.height=height;update_texture_canvas(texture)};function update_texture_canvas(texture){if(texture.source!="CANVAS")throw"Wrong texture";var w_texture=
texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,w_texture);var w_format=get_image2d_format(texture);var w_type=get_image2d_type(texture);var canvas=texture.canvas;_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);_gl.texImage2D(w_target,0,w_format,w_format,w_type,canvas);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,false);_gl.bindTexture(w_target,null);texture.width=width;texture.height=height}exports.update_texture=function(texture,image_data,is_dds,filepath){var tex_type=texture.source;
var w_texture=texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,w_texture);if(image_data.length==4){var update_color=true;var image_data=new Uint8Array([image_data[0]*255,image_data[1]*255,image_data[2]*255,image_data[3]*255])}if(tex_type=="IMAGE")if(update_color){_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);texture.width=1;texture.height=1}else if(is_dds){m_dds.upload_dds_levels(_gl,extensions.get_s3tc(),image_data,true);var dds_wh=m_dds.get_width_height(image_data);
if(is_non_power_of_two(dds_wh.width,dds_wh.height)){if(!texture.auxilary_texture)m_print.warn("B4W warning: using NPOT-texture",filepath);prepare_npot_texture(w_target)}texture.width=dds_wh.width;texture.height=dds_wh.height;texture.compress_ratio=m_dds.get_compress_ratio(image_data)}else{_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);_gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);texture.width=image_data.width;texture.height=image_data.height;if(is_non_power_of_two(image_data.width,
image_data.height)){if(!texture.auxilary_texture)m_print.warn("B4W warning: using NPOT-texture",filepath);prepare_npot_texture(w_target)}else _gl.generateMipmap(w_target)}else if(tex_type=="ENVIRONMENT_MAP"){var infos=[["POSITIVE_X",2,0],["NEGATIVE_X",0,0],["POSITIVE_Y",1,1],["NEGATIVE_Y",0,1],["POSITIVE_Z",1,0],["NEGATIVE_Z",2,1]];if(update_color){for(var i=0;i<6;i++){var info=infos[i];_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_"+info[0]],0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data)}texture.width=
3;texture.height=2}else{if(is_non_power_of_two(image_data.width/3,image_data.height/2))throw"Warning: Wrong environment map dimensions "+filepath;_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,false);var dim=image_data.width/3;for(var i=0;i<6;i++){var info=infos[i];var tmpcanvas=document.createElement("canvas");tmpcanvas.width=dim;tmpcanvas.height=dim;var ctx=tmpcanvas.getContext("2d");if(info[0]=="POSITIVE_Y"||info[0]=="NEGATIVE_Y"){ctx.translate(0,dim);ctx.scale(1,-1)}else{ctx.translate(dim,0);ctx.scale(-1,
1)}ctx.drawImage(image_data,info[1]*dim,info[2]*dim,dim,dim,0,0,dim,dim);_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_"+info[0]],0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,tmpcanvas)}texture.width=3*dim;texture.height=2*dim;_gl.generateMipmap(w_target)}}_gl.bindTexture(w_target,null)};function prepare_npot_texture(tex_target){_gl.texParameteri(tex_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(tex_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.texParameteri(tex_target,_gl.TEXTURE_MAG_FILTER,
_gl.LINEAR);_gl.texParameteri(tex_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR)}function is_non_power_of_two(width,height){var dims=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384];return dims.indexOf(width)==-1||dims.indexOf(height)==-1}function get_image2d_format(texture){var format;switch(texture.type){case exports.TT_RGBA_INT:format=_gl.RGBA;break;case exports.TT_RGB_INT:format=_gl.RGB;break;case exports.TT_RGBA_FLOAT:format=_gl.RGBA;break;case exports.TT_RGB_FLOAT:format=_gl.RGB;break;case exports.TT_DEPTH:format=
_gl.DEPTH_COMPONENT;break;default:throw"Wrong texture type";break}return format}function get_image2d_type(texture){var type;switch(texture.type){case exports.TT_RGBA_INT:type=_gl.UNSIGNED_BYTE;break;case exports.TT_RGB_INT:type=_gl.UNSIGNED_BYTE;break;case exports.TT_RGBA_FLOAT:type=_gl.FLOAT;break;case exports.TT_RGB_FLOAT:type=_gl.FLOAT;break;case exports.TT_DEPTH:type=_gl.UNSIGNED_INT;break;default:throw"Wrong texture type";break}return type}exports.delete_texture=function(texture){_gl.deleteTexture(texture)};
exports.is_texture=function(tex){if(tex&&(tex.name&&(tex.w_texture||tex.w_renderbuffer)))return true;else return false};exports.is_renderbuffer=function(tex){if(tex&&(tex.name&&tex.w_renderbuffer))return true;else return false};exports.is_float=function(tex){if(tex.type==exports.TT_RGBA_FLOAT||tex.type==exports.TT_RGB_FLOAT)return true;else return false};exports.get_texture_channel_size=function(tex){var size=0;switch(tex.type){case exports.TT_RGBA_INT:case exports.TT_RGB_INT:size=CHANNEL_SIZE_BYTES_INT;
break;case exports.TT_RGBA_FLOAT:case exports.TT_RGB_FLOAT:size=CHANNEL_SIZE_BYTES_FLOAT;break;case exports.TT_DEPTH:size=CHANNEL_SIZE_BYTES_DEPTH;break;case exports.TT_RENDERBUFFER:size=CHANNEL_SIZE_BYTES_RENDERBUFFER;break}return size};exports.calc_texture_id=function(tex){var tex_cp={};for(var prop in tex)tex_cp[prop]=tex[prop];delete tex_cp.offscreen_scene;return JSON.stringify(tex_cp)}};b4w.module["__assets"]=function(exports,require){var config=require("__config");var m_print=require("__print");var sfx=require("__sfx");var version=require("__version");var cfg_ldr=config.assets;exports.AT_ARRAYBUFFER=10;exports.AT_JSON=20;exports.AT_TEXT=30;exports.AT_AUDIOBUFFER=40;exports.AT_IMAGE_ELEMENT=50;exports.AT_AUDIO_ELEMENT=60;var ASTATE_ENQUEUED=10;var ASTATE_REQUESTED=20;var ASTATE_RECEIVED=30;var _assets_queue=[];var _assets_pack_index=0;var _image_el_pool=[];var _audio_el_pool=[];
var _loaded_assets={};function get_built_in_data(){if(b4w.module_check(config.paths.built_in_data_module))return require(config.paths.built_in_data_module)["data"];else return null}function FakeHttpRequest(){var req={_source_url:null,_parse_response:function(source){switch(req.responseType){case "json":case "text":return source;case "arraybuffer":var bin_str=atob(source);var len=bin_str.length;var arr_buffer=new Int8Array(len);for(var i=0;i<len;i++)arr_buffer[i]=bin_str.charCodeAt(i);return arr_buffer.buffer;
default:return source}},status:0,readyState:0,response:"",responseType:"",onreadystatechange:null,overrideMimeType:function(){},addEventListener:function(){},open:function(method,url,async){req._source_url=url;req.readyState=1},send:function(){req.status=404;req.readyState=4;var bd=get_built_in_data();if(bd&&req._source_url in bd){req.status=200;if(bd[req._source_url])req.response=req._parse_response(bd[req._source_url])}var get_type={};if(get_type.toString.call(req.onreadystatechange)==="[object Function]")req.onreadystatechange()}};
return req}exports.split_extension=function(path){var dot_split=path.split(".");var head_ext=Array(2);head_ext[0]=dot_split.slice(0,-1).join(".");head_ext[1]=String(dot_split.slice(-1));return head_ext};exports.get_text_sync=function(asset_uri){if(_loaded_assets[asset_uri])return _loaded_assets[asset_uri];if(cfg_ldr.prevent_caching)var filepath=asset_uri+version.timestamp();else var filepath=asset_uri;var req=new XMLHttpRequest;req.overrideMimeType("text/plain");req.open("GET",filepath,false);req.send(null);
if(req.status==200||req.status==0){var resp_text=req.responseText;if(resp_text.length){_loaded_assets[asset_uri]=resp_text;return resp_text}else throw"Error XHR: responce is empty, GET "+asset_uri;}else throw"Error XHR: "+req.status+", GET "+asset_uri;};exports.cleanup=function(){_assets_queue=[];_assets_pack_index=0;_image_el_pool=[];_audio_el_pool=[];_loaded_assets={}};exports.enqueue=function(assets_pack,asset_cb,pack_cb,progress_cb){for(var i=0;i<assets_pack.length;i++){var pack_elem=assets_pack[i];
var asset={uri:pack_elem[0],type:pack_elem[1],filepath:pack_elem[2],name:pack_elem[3],state:ASTATE_ENQUEUED,asset_cb:asset_cb||function(){},pack_cb:pack_cb||function(){},progress_cb:progress_cb||function(){},pack_index:_assets_pack_index};if(cfg_ldr.prevent_caching){var bd=get_built_in_data();if(!(bd&&asset.filepath in bd))asset.filepath+=version.timestamp()}_assets_queue.push(asset)}request_assets(_assets_queue);_assets_pack_index++};exports.update=function(){request_assets(_assets_queue);handle_packs(_assets_queue)};
function request_assets(queue){var req_cnt=0;for(var i=0;i<queue.length;i++){var asset=queue[i];if(asset.state===ASTATE_REQUESTED)req_cnt++;if(req_cnt>=cfg_ldr.max_requests)break;if(asset.state!==ASTATE_ENQUEUED)continue;asset.state=ASTATE_REQUESTED;req_cnt++;switch(asset.type){case exports.AT_ARRAYBUFFER:request_arraybuffer(asset,"arraybuffer");break;case exports.AT_JSON:request_arraybuffer(asset,"json");break;case exports.AT_TEXT:request_arraybuffer(asset,"text");break;case exports.AT_AUDIOBUFFER:request_audiobuffer(asset);
break;case exports.AT_IMAGE_ELEMENT:request_image(asset);break;case exports.AT_AUDIO_ELEMENT:request_audio(asset);break;default:throw"Wrong asset type: "+asset.type;break}}}function request_arraybuffer(asset,response_type){var bd=get_built_in_data();if(bd&&asset.filepath in bd)var req=new FakeHttpRequest;else var req=new XMLHttpRequest;req.open("GET",asset.filepath,true);if(response_type=="text"){req.overrideMimeType("text/plain");req.responseType="text"}else if(response_type=="json"){req.overrideMimeType("application/json");
req.responseType="text"}else req.responseType=response_type;req.onreadystatechange=function(){if(req.readyState==4)if(req.status==200||req.status==0){var response=req.response;if(response){if(response_type=="json"&&typeof response=="string")try{response=JSON.parse(response)}catch(e){asset.asset_cb(null,asset.uri,asset.type,asset.filepath);m_print.error(e+" (parsing JSON "+asset.filepath+")");return}asset.asset_cb(response,asset.uri,asset.type,asset.filepath);asset.state=ASTATE_RECEIVED}else{asset.asset_cb(null,
asset.uri,asset.type,asset.filepath);m_print.error("B4W Error: empty responce when trying to get "+asset.filepath)}}else{asset.asset_cb(null,asset.uri,asset.type,asset.filepath);m_print.error("B4W Error: "+req.status+" when trying to get "+asset.filepath)}};req.addEventListener("progress",function(e){if(e.lengthComputable)asset.progress_cb(e.loaded/e.total)},false);req.send(null)}function request_audiobuffer(asset){var bd=get_built_in_data();if(bd&&asset.filepath in bd)var req=new FakeHttpRequest;
else var req=new XMLHttpRequest;req.open("GET",asset.filepath,true);req.responseType="arraybuffer";req.onreadystatechange=function(){if(req.readyState==4)if(req.status==200||req.status==0){var response=req.response;if(response){var decode_cb=function(audio_buffer){asset.asset_cb(audio_buffer,asset.uri,asset.type,asset.filepath);asset.state=ASTATE_RECEIVED};var fail_cb=function(){asset.asset_cb(null,asset.uri,asset.type,asset.filepath);m_print.error("B4W Error: failed to decode "+asset.filepath)};
sfx.decode_audio_data(response,decode_cb,fail_cb)}else{asset.asset_cb(null,asset.uri,asset.type,asset.filepath);m_print.error("B4W Error: empty responce when trying to get "+asset.filepath)}}else{asset.asset_cb(null,asset.uri,asset.type,asset.filepath);m_print.error("B4W Error: "+req.status+" when trying to get "+asset.filepath)}};req.send(null)}function request_image(asset){var image=document.createElement("img");image.onload=function(){asset.asset_cb(image,asset.uri,asset.type,asset.filepath);asset.state=
ASTATE_RECEIVED};image.addEventListener("error",function(){m_print.error("B4W Error: could not load image: "+asset.filepath)},false);var bd=get_built_in_data();if(bd&&asset.filepath in bd)if(bd[asset.filepath])image.src="data:image;base64,"+bd[asset.filepath];else{var event=new CustomEvent("error");image.dispatchEvent(event)}else image.src=asset.filepath}function request_audio(asset){var audio=document.createElement("audio");audio.addEventListener("loadeddata",function(){asset.asset_cb(audio,asset.uri,
asset.type,asset.filepath);asset.state=ASTATE_RECEIVED},false);audio.addEventListener("error",function(){m_print.error("B4W Error: could not load sound: "+asset.filepath)},false);var bd=get_built_in_data();if(bd&&asset.filepath in bd)if(bd[asset.filepath]){var snd_mime_type=get_sound_mime_type(asset.filepath);audio.src="data:"+snd_mime_type+";base64,"+bd[asset.filepath]}else{var event=new CustomEvent("error");audio.dispatchEvent(event)}else audio.src=asset.filepath;setTimeout(function(){audio.some_prop_to_prevent_gc=
1},5E3)}function get_sound_mime_type(file_path){var re=/(?:\.([^.]+))?$/;var ext=re.exec(file_path)[1];var mime_type="audio";switch(ext){case "ogg":mime_type+="/ogg";break;case "mp3":mime_type+="/mpeg";break;case "mp4":mime_type+="/mp4";break}return mime_type}function handle_packs(queue){var pack_first_index=0;var pack_cb_exec=true;for(var i=0;i<queue.length;i++){var asset=queue[i];var asset_pack_first=queue[pack_first_index];if(asset.pack_index===asset_pack_first.pack_index){if(asset.state!==ASTATE_RECEIVED)pack_cb_exec=
false}else{if(pack_cb_exec){queue[i-1].pack_cb();var spliced_count=i-pack_first_index;queue.splice(pack_first_index,spliced_count);i-=spliced_count}pack_first_index=i;pack_cb_exec=queue[i].state===ASTATE_RECEIVED?true:false}if(i===queue.length-1&&pack_cb_exec){queue[i].pack_cb();queue.splice(pack_first_index)}}}function debug_queue(queue,opt_log_prefix){var state_str="[";for(var i=0;i<queue.length;i++)state_str+=String(queue[i].state/10);state_str+="]";if(opt_log_prefix||opt_log_prefix===0)m_print.log(opt_log_prefix,
state_str);else m_print.log(state_str)}};b4w.module["__loader"]=function(exports,require){var m_graph=require("__graph");var m_print=require("__print");var m_util=require("__util");var SH_IDLE=0;var SH_LOADING=1;var SH_FINISHED=2;var SH_STAGE_BEFORE=0;var SH_STAGE_LOOP=1;var SH_STAGE_AFTER=2;var SH_STAGE_IDLE=3;var DEBUG_MODE=false;var DEBUG_COLOR="color: #f0f;";var MAX_LOAD_TIME_MS=16;exports.SYNC_PRIORITY=0;exports.ASYNC_PRIORITY=1;exports.FINISH_PRIORITY=2;exports.create_scheduler=function(stages,path,loaded_callback,stageload_cb,complete_load_cb,
wait_complete_loading,do_not_load_resources){var scheduler={filepath:path,binary_filepath:null,stageload_cb:stageload_cb||function(){},complete_load_cb:complete_load_cb||function(){},status:SH_IDLE,reset_time_cycle:false,time_load_start:0,curr_percents:0,stages_size_total:0,wait_complete_loading:wait_complete_loading,is_loaded:false,make_idle_iteration:false};var loaded_cb=loaded_callback||function(){};var graph=create_loading_graph(stages,wait_complete_loading,do_not_load_resources,loaded_cb);scheduler.stage_graph=
graph;var stages_queue=[];var init_nodes=m_graph.get_source_nodes(graph);for(var i=0;i<init_nodes.length;i++)stages_queue.push(init_nodes[i]);scheduler.stages_queue=stages_queue;m_graph.traverse(graph,function(id,attr){if(attr.cb_before||(attr.cb_loop||attr.cb_after))if(stage_need_calc(scheduler,attr))scheduler.stages_size_total+=attr.relative_size});return scheduler};function create_loading_graph(stages,wait_complete_loading,do_not_load_resources,loaded_cb){var graph=m_graph.create();for(var stage_name in stages){var stage=
init_stage(stages[stage_name]);if(do_not_load_resources&&stage.is_resource)skip_stage(stage);m_graph.append_node_attr(graph,stage)}for(var stage_name in stages){var stage=stages[stage_name];stage.name=stage_name;for(var i=0;i<stage.inputs.length;i++)m_graph.append_edge_attr(graph,stages[stage.inputs[i]],stage,null)}var loaded_cb_wrapper=function(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){scheduler.is_loaded=true;loaded_cb(bpy_data);cb_finish(scheduler,stage);m_print.log("%cLOADED CALLBACK",
DEBUG_COLOR)};var finish_node=init_stage({name:"out",priority:exports.FINISH_PRIORITY,cb_before:loaded_cb_wrapper});var prefinish_nodes=[];if(wait_complete_loading){var ids=m_graph.get_sink_nodes(graph);for(var i=0;i<ids.length;i++)prefinish_nodes.push(m_graph.get_node_attr(graph,ids[i]))}else m_graph.traverse(graph,function(id,attr){if(!attr.background_loading)prefinish_nodes.push(attr)});m_graph.append_node_attr(graph,finish_node);for(var i=0;i<prefinish_nodes.length;i++){finish_node.inputs.push(prefinish_nodes[i].name);
m_graph.append_edge_attr(graph,prefinish_nodes[i],finish_node,null)}return graph}function init_stage(stage){stage.background_loading=stage.background_loading||false;if(!(stage.priority||stage.priority===0))stage.priority=stage.SYNC_PRIORITY;stage.inputs=stage.inputs||[];stage.is_finished=stage.is_finished||false;stage.skip=stage.skip||false;stage.relative_size=stage.relative_size||0;stage.is_resource=stage.is_resource||false;stage.status=SH_STAGE_BEFORE;stage.loop_index=0;stage.load_rate=0;stage.cb_param=
stage.cb_param||null;return stage}exports.update_scheduler=function(scheduler,bpy_data){if(!scheduler)return;if(scheduler.make_idle_iteration){scheduler.make_idle_iteration=false;return}var time_start=performance.now();do{if(check_finished(scheduler))return;if(scheduler.status==SH_IDLE){scheduler.status=SH_LOADING;scheduler.time_load_start=performance.now();scheduler.stageload_cb(0,0);if(DEBUG_MODE)m_print.log("%c0% LOADING START 0ms",DEBUG_COLOR)}if(update_stages_queue(scheduler))process_stages_queue(scheduler,
bpy_data);else{scheduler.complete_load_cb(bpy_data,scheduler);scheduler.status=SH_FINISHED;if(DEBUG_MODE){var ms=Math.round(performance.now()-scheduler.time_load_start);m_print.log("%c100% LOADING END "+ms+"ms",DEBUG_COLOR)}return}if(scheduler.reset_time_cycle){scheduler.reset_time_cycle=false;return}}while(performance.now()-time_start<MAX_LOAD_TIME_MS)};function process_stages_queue(scheduler,bpy_data){var iter_counter=scheduler.stages_queue.length;do{var stage_index=scheduler.stages_queue[0];var stage=
m_graph.get_node_attr(scheduler.stage_graph,stage_index);var is_processed=process_stage(scheduler,stage,bpy_data);if(stage.priority==exports.ASYNC_PRIORITY)scheduler.reset_time_cycle=true;var first=scheduler.stages_queue.shift();scheduler.stages_queue.push(first);iter_counter--}while(!(is_processed||iter_counter==0))}function propagate_stages(scheduler,stage_indices){var next_indices=[];var stages_to_remove=[];for(var i=0;i<stage_indices.length;i++){var stage_index=stage_indices[i];var stage=m_graph.get_node_attr(scheduler.stage_graph,
stage_index);if(stage.is_finished){m_graph.traverse_outputs(scheduler.stage_graph,stage_index,function(id_out,attr_out,edge_attr_out){var can_execute=true;m_graph.traverse_inputs(scheduler.stage_graph,id_out,function(id_in,attr_in,edge_attr_in){if(!attr_in.is_finished){can_execute=false;return 1}});if(can_execute&&(next_indices.indexOf(id_out)==-1&&stage_indices.indexOf(id_out)==-1))next_indices.push(id_out)});stages_to_remove.push(i)}}for(var i=stages_to_remove.length-1;i>=0;i--)stage_indices.splice(stages_to_remove[i],
1);return next_indices}function update_stages_queue(scheduler){var result_indices=[];var prev_indices=scheduler.stages_queue;var new_added=false;do{var next_indices=propagate_stages(scheduler,prev_indices);result_indices.push.apply(result_indices,prev_indices);if(next_indices.length>0)new_added=true;prev_indices=next_indices}while(next_indices.length>0);var priority_stage_sort=function(a,b){var stage_a=m_graph.get_node_attr(scheduler.stage_graph,a);var stage_b=m_graph.get_node_attr(scheduler.stage_graph,
b);var result=stage_b.priority-stage_a.priority;if(result==0)result=stage_a.background_loading-stage_b.background_loading;return result};if(new_added)result_indices.sort(priority_stage_sort);scheduler.stages_queue=result_indices;return scheduler.stages_queue.length}function process_stage(scheduler,stage,bpy_data){if(stage.skip){stage.is_finished=true;if(DEBUG_MODE)m_print.log("%cSKIP STAGE: "+stage.name,DEBUG_COLOR);return false}if(DEBUG_MODE&&stage.status==SH_STAGE_BEFORE){var percents=get_load_percents(scheduler);
var message="LOADING START: "+stage.name;var ms=Math.round(performance.now()-scheduler.time_load_start);m_print.log("%c"+percents+"% "+message+" "+ms+"ms ",DEBUG_COLOR)}if(!stage.cb_before&&(!stage.cb_loop&&!stage.cb_after)){stage_finish_cb(scheduler,stage);return false}if(stage.status==SH_STAGE_BEFORE){stage.status++;if(stage.cb_before){stage.cb_before(bpy_data,scheduler,stage,stage.cb_param,stage_finish_cb,stage_part_finish_cb);return true}}if(stage.status==SH_STAGE_LOOP)if(stage.cb_loop){stage.cb_loop(bpy_data,
scheduler,stage,stage.cb_param,stage_finish_cb,stage_part_finish_cb);return true}else stage.status++;if(stage.status==SH_STAGE_AFTER){stage.status++;if(stage.cb_after){stage.cb_after(bpy_data,scheduler,stage,stage.cb_param,stage_finish_cb,stage_part_finish_cb);return true}}return false}function get_load_percents(scheduler){if(scheduler.stages_size_total==0)return 100;var loaded=0;m_graph.traverse(scheduler.stage_graph,function(id,attr){if(stage_need_calc(scheduler,attr))loaded+=attr.load_rate*attr.relative_size});
return m_util.trunc(loaded*100/scheduler.stages_size_total)}function stage_need_calc(scheduler,stage){return!(scheduler.do_not_load_resources&&stage.is_resource)}function stage_finish_cb(scheduler,stage){stage.is_finished=true;stage.status=SH_STAGE_IDLE;stage_loading_action(scheduler,stage,1);if(DEBUG_MODE){var percents=get_load_percents(scheduler);var message="LOADING END: "+stage.name;var ms=Math.round(performance.now()-scheduler.time_load_start);m_print.log("%c"+percents+"% "+message+" "+ms+"ms ",
DEBUG_COLOR)}}exports.stage_part_finish_cb=stage_part_finish_cb;function stage_part_finish_cb(scheduler,stage,rate){if(rate<1)stage_loading_action(scheduler,stage,rate);else stage.status++}function stage_loading_action(scheduler,stage,rate){if(stage.cb_before||(stage.cb_loop||stage.cb_after)){stage.load_rate=rate;var percents=get_load_percents(scheduler);if(scheduler.curr_percents!=percents||rate==1){scheduler.stageload_cb(percents,performance.now()-scheduler.time_load_start);scheduler.curr_percents=
percents;scheduler.make_idle_iteration=true}}}function check_finished(scheduler){return scheduler.status==SH_FINISHED}exports.get_stage_by_name=get_stage_by_name;function get_stage_by_name(scheduler,name){var stage=null;m_graph.traverse(scheduler.stage_graph,function(id,attr){if(attr.name==name){stage=attr;return 1}});return stage}exports.skip_stage_by_name=function(scheduler,name){var stage=get_stage_by_name(scheduler,name);if(stage!==null)skip_stage(stage)};function skip_stage(stage){stage.skip=
true;stage.load_rate=1}exports.is_loaded=function(scheduler){if(!scheduler)return false;return scheduler.is_loaded}};b4w.module["__nla"]=function(exports,require){var m_anim=require("__animation");var m_cam=require("__camera");var m_cfg=require("__config");var m_loader=require("__loader");var m_particles=require("__particles");var m_print=require("__print");var m_scenes=require("__scenes");var m_sfx=require("__sfx");var m_util=require("__util");var cfg_ani=m_cfg.animation;var _nla_arr=[];var _start_time=-1;exports.update_scene_nla=function(scene,is_cyclic){var nla={frame_start:scene["frame_start"],frame_end:scene["frame_end"],
last_frame:-1,cyclic:is_cyclic,objects:[]};var sobjs=m_scenes.get_appended_objs(scene,"ALL");for(var i=0;i<sobjs.length;i++){var sobj=sobjs[i];var adata=sobj["animation_data"];if(adata&&adata["nla_tracks"].length){var nla_tracks=adata["nla_tracks"];if(m_util.is_armature(sobj)||(m_cam.is_camera(sobj)||m_util.is_mesh(sobj))){var nla_events=get_nla_events(nla_tracks);sobj._nla_events=nla_events;nla.objects.push(sobj)}if(m_sfx.is_speaker(sobj)){var nla_events=get_nla_events(nla_tracks);sobj._nla_events=
nla_events;nla.objects.push(sobj)}}}for(var i=0;i<sobjs.length;i++){var sobj=sobjs[i];for(var j=0;j<nla.objects.length;j++)if(m_anim.get_first_armature_object(sobj)==nla.objects[j]){sobj._nla_events=m_util.clone_object_json(nla.objects[j]._nla_events);nla.objects.push(sobj)}if(m_particles.has_particles(sobj)&&m_particles.has_anim_particles(sobj)){var ev={frame_start:nla.frame_start,frame_end:nla.frame_end+1,frame_offset:0,scheduled:false,action:null};sobj._nla_events=[ev];nla.objects.push(sobj)}}enforce_nla_consistency(nla);
_nla_arr.push(nla)};function enforce_nla_consistency(nla){var start=nla.frame_start;var end=nla.frame_end;for(var i=0;i<nla.objects.length;i++){var obj=nla.objects[i];var nla_events=obj._nla_events;for(var j=0;j<nla_events.length;j++){var ev=nla_events[j];var strip_str=obj["name"]+" ["+ev.frame_start+":"+ev.frame_end+"]";ev.frame_offset=Math.max(0,start-ev.frame_start);ev.frame_start=Math.max(start,ev.frame_start);ev.frame_end=Math.min(end+1,ev.frame_end);if(ev.frame_start>ev.frame_end){m_print.warn("NLA: out of scene range: "+
strip_str);nla_events.splice(j,1);j--}}}}exports.update=function(timeline,elapsed){if(_start_time==-1)_start_time=timeline;for(var i=0;i<_nla_arr.length;i++){var nla=_nla_arr[i];var cf=(timeline-_start_time)*cfg_ani.framerate-nla.frame_start;if(nla.cyclic){var stride=nla.frame_end-nla.frame_start+1;cf%=stride}cf+=nla.frame_start;for(var j=0;j<nla.objects.length;j++){var obj=nla.objects[j];var nla_events=obj._nla_events;for(var k=0;k<nla_events.length;k++){var ev=nla_events[k];if(cf<nla.last_frame&&
ev.scheduled){process_event_stop(obj,ev,cf,nla.last_frame);ev.scheduled=false}}for(var k=0;k<nla_events.length;k++){var ev=nla_events[k];if((cf<nla.last_frame||nla.last_frame<ev.frame_start)&&ev.frame_start<=cf)if(!ev.scheduled){process_event_start(obj,ev,cf,elapsed);ev.scheduled=true}if(nla.last_frame<ev.frame_end&&ev.frame_end<=cf)if(ev.scheduled){process_event_stop(obj,ev,cf,nla.last_frame);ev.scheduled=false}}}nla.last_frame=cf}};function process_event_start(obj,ev,frame,elapsed){var init_anim_frame=
ev.frame_offset-elapsed*cfg_ani.framerate;if(m_particles.has_particles(obj)&&m_particles.has_anim_particles(obj)){m_anim.apply_def(obj);m_anim.set_current_frame_float(obj,init_anim_frame);m_anim.play(obj)}else if(m_util.is_armature(obj)||(m_util.is_mesh(obj)||m_cam.is_camera(obj))){m_anim.apply(obj,ev.action);m_anim.set_current_frame_float(obj,init_anim_frame);m_anim.play(obj)}else if(m_sfx.is_speaker(obj)){var when=0;var duration=(ev.frame_end-frame)/cfg_ani.framerate;m_sfx.play(obj,when,duration)}}
function process_event_stop(obj,ev,frame){if(m_particles.has_particles(obj)&&m_particles.has_anim_particles(obj))m_anim.stop(obj);else if(m_util.is_armature(obj)||(m_util.is_mesh(obj)||m_cam.is_camera(obj)))m_anim.stop(obj)}exports.cleanup=function(){_nla_arr.length=0;_start_time=-1};function get_nla_events(nla_tracks){var nla_events=[];for(var i=0;i<nla_tracks.length;i++){var track=nla_tracks[i];var strips=track["strips"];if(!strips)continue;for(var j=0;j<strips.length;j++){var strip=strips[j];var ev=
{frame_start:strip["frame_start"],frame_end:strip["frame_end"],frame_offset:0,scheduled:false,action:strip["action"]?strip["action"]["name"]:null};nla_events.push(ev)}}return nla_events}};b4w.module["__camera"]=function(exports,require){var m_bounds=require("__boundings");var m_cfg=require("__config");var m_cons=require("__constraints");var m_print=require("__print");var m_util=require("__util");var m_vec3=require("vec3");var m_vec4=require("vec4");var m_quat=require("quat");var m_mat3=require("mat3");var m_mat4=require("mat4");var cfg_ctl=m_cfg.controls;exports.TYPE_NONE=10;exports.TYPE_PERSP=20;exports.TYPE_ORTHO=30;exports.TYPE_PERSP_ASPECT=40;exports.TYPE_ORTHO_ASPECT=50;exports.TYPE_ORTHO_ASYMMETRIC=
60;exports.TYPE_STEREO_LEFT=70;exports.TYPE_STEREO_RIGHT=80;exports.MS_STATIC=0;exports.MS_ANIMATION=1;exports.MS_TARGET_CONTROLS=2;exports.MS_EYE_CONTROLS=3;var STEREO_CONV_DIST=3*2;var STEREO_EYE_DIST=0.065;var DEF_WATER_PLANE_Y=-0.05;var DEF_ORTHO_SCALE=2.5;var DEF_PERSP_FOV=40;var DEF_PERSP_NEAR=0.1;var DEF_PERSP_FAR=1E3;var _vec2_tmp=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _vec4_tmp=new Float32Array(4);var _vec4_tmp2=
new Float32Array(4);var _mat3_tmp=new Float32Array(16);var _mat4_tmp=new Float32Array(16);exports.camera_object_to_camera=function(camobj){var render=camobj._render;var camobj_data=camobj["data"];switch(camobj_data["type"]){case "PERSP":var cam=create_camera(exports.TYPE_PERSP);if(camobj_data["angle_y"])var fov=camobj_data["angle_y"]/Math.PI*180;set_frustum(cam,fov,camobj_data["clip_start"],camobj_data["clip_end"]);break;case "ORTHO":var cam=create_camera(exports.TYPE_ORTHO);var top_bound=camobj_data["ortho_scale"]/
2;set_frustum(cam,top_bound,camobj_data["clip_start"],camobj_data["clip_end"]);break}cam.name=camobj["name"];render.trans_speed=cfg_ctl.cam_trans_base_speed.slice();render.underwater=false;render.move_style=move_style_bpy_to_b4w(camobj_data["b4w_move_style"]);render.dof_distance=camobj["data"]["dof_distance"];render.dof_object=camobj["data"]["dof_object"];render.dof_front=camobj["data"]["b4w_dof_front"];render.dof_rear=camobj["data"]["b4w_dof_rear"];render.dof_power=camobj["data"]["b4w_dof_power"];
render.cameras=[cam];render.use_distance_limits=camobj_data["b4w_use_distance_limits"];render.distance_min=camobj_data["b4w_distance_min"];render.distance_max=camobj_data["b4w_distance_max"];if(render.move_style==exports.MS_TARGET_CONTROLS){render.pivot=new Float32Array(3);var pivot=new Float32Array(camobj_data["b4w_target"]);exports.set_point_constraint(camobj,pivot)}else render.pivot=null;render.vertical_limits=null;if(render.move_style==exports.MS_TARGET_CONTROLS||render.move_style==exports.MS_EYE_CONTROLS)if(camobj_data["b4w_use_vertical_clamping"])render.vertical_limits=
{down:camobj_data["b4w_rotation_down_limit"],up:camobj_data["b4w_rotation_up_limit"]}};exports.set_point_constraint=function(camobj,pivot){var render=camobj._render;m_vec3.copy(pivot,render.pivot);if(render.use_distance_limits)m_cons.append_follow_point(camobj,render.pivot,render.distance_min,render.distance_max);else m_cons.append_track_point(camobj,render.pivot)};function init_camera(type){var cam={};cam.size_mult=1;cam.type=type;cam.framebuffer=null;cam.color_attachment=null;cam.depth_attachment=
null;return cam}function move_style_bpy_to_b4w(bpy_move_style){switch(bpy_move_style){case "STATIC":return exports.MS_STATIC;break;case "TARGET":return exports.MS_TARGET_CONTROLS;break;case "EYE":return exports.MS_EYE_CONTROLS;break;default:throw"Unknown move style";}}exports.create_camera=create_camera;function create_camera(type){var cam=init_camera(type);if(type==exports.TYPE_NONE)return cam;cam.eye=new Float32Array(3);cam.eye_last=new Float32Array(3);cam.quat=new Float32Array(4);cam.view_matrix=
new Float32Array(16);cam.proj_matrix=new Float32Array(16);cam.view_proj_inv_matrix=new Float32Array(16);cam.prev_view_proj_matrix=new Float32Array(16);cam.sky_vp_inv_matrix=new Float32Array(16);cam.view_proj_matrix=new Float32Array(16);cam.frustum_planes={left:[0,0,0,0],right:[0,0,0,0],top:[0,0,0,0],bottom:[0,0,0,0],near:[0,0,0,0],far:[0,0,0,0]};switch(type){case exports.TYPE_PERSP:set_frustum(cam,DEF_PERSP_FOV,DEF_PERSP_NEAR,DEF_PERSP_FAR);break;case exports.TYPE_ORTHO:set_frustum(cam,DEF_ORTHO_SCALE,
DEF_PERSP_NEAR,DEF_PERSP_FAR);break;case exports.TYPE_PERSP_ASPECT:break;case exports.TYPE_ORTHO_ASPECT:break;case exports.TYPE_ORTHO_ASYMMETRIC:break;case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:throw"Stereo camera may only be created from perspective one";break;default:throw"Unknown camera type";break}return cam}exports.check_attachment=function(cam,type){switch(type){case "COLOR":case "CUBEMAP":return Boolean(cam.color_attachment);case "DEPTH":return Boolean(cam.depth_attachment);
case "SCREEN":return!Boolean(cam.color_attachment)&&!Boolean(cam.depth_attachment);default:throw"Wrong attachment type: "+type;break}};exports.set_attachment=function(cam,type,tex){switch(type){case "COLOR":case "CUBEMAP":cam.color_attachment=tex;break;case "DEPTH":cam.depth_attachment=tex;break;case "SCREEN":cam.color_attachment=null;cam.depth_attachment=null;break;default:throw"Wrong attachment type: "+type;break}};exports.get_attachment=function(cam,type){switch(type){case "COLOR":case "CUBEMAP":return cam.color_attachment;
case "DEPTH":return cam.depth_attachment;case "SCREEN":return null;default:throw"Wrong attachment type: "+type;break}};exports.make_stereo=function(cam,type){if(!(cam.type==exports.TYPE_PERSP&&(type==exports.TYPE_STEREO_LEFT||type==exports.TYPE_STEREO_RIGHT)))throw"make_stereo(): wrong camera type";cam.type=type;set_stereo_params(cam,STEREO_CONV_DIST,STEREO_EYE_DIST)};exports.set_stereo_params=set_stereo_params;function set_stereo_params(cam,conv_dist,eye_dist){if(!(cam.type==exports.TYPE_STEREO_LEFT||
cam.type==exports.TYPE_STEREO_RIGHT))throw"set_stereo_params(): wrong camera type";cam.stereo_conv_dist=conv_dist;cam.stereo_eye_dist=eye_dist;set_projection(cam,cam.aspect)}exports.rotate_h=rotate_h;function rotate_h(camobj,angle){var quat=camobj._render.quat;var rot=_quat4_tmp;var axis=_vec3_tmp;axis[0]=0;axis[1]=1;axis[2]=0;m_quat.setAxisAngle(axis,angle,rot);m_quat.multiply(rot,quat,quat)}exports.rotate_v=rotate_v;function rotate_v(camobj,angle){var quat=camobj._render.quat;var rot=_quat4_tmp;
var axis=_vec3_tmp;axis[0]=1;axis[1]=0;axis[2]=0;m_quat.setAxisAngle(axis,angle,rot);m_quat.multiply(rot,quat,quat)}exports.rotate_h_local=rotate_h_local;function rotate_h_local(camobj,angle){var quat=camobj._render.quat;m_quat.invert(quat,quat);var rot=_quat4_tmp;var axis=_vec3_tmp;axis[0]=0;axis[1]=0;axis[2]=1;m_quat.setAxisAngle(axis,-angle,rot);m_quat.multiply(rot,quat,quat);m_quat.invert(quat,quat)}exports.rotate_v_local=rotate_v_local;function rotate_v_local(camobj,angle){var quat=camobj._render.quat;
m_quat.invert(quat,quat);var rot=_quat4_tmp;var axis=_vec3_tmp;axis[0]=1;axis[1]=0;axis[2]=0;m_quat.setAxisAngle(axis,-angle,rot);m_quat.multiply(rot,quat,quat);m_quat.invert(quat,quat)}exports.get_angles=get_angles;function get_angles(cam,dest){var render=cam._render;var y_world_cam=m_util.quat_to_dir(render.quat,m_util.AXIS_MY,_vec3_tmp);var theta=Math.asin(y_world_cam[1]/m_vec3.length(y_world_cam));if(y_world_cam[0]==0&&y_world_cam[2]==0)var phi=0;else if(Math.abs(theta)>Math.PI/4){var z_world_cam=
m_util.quat_to_dir(render.quat,m_util.AXIS_Z,_vec3_tmp2);var phi=Math.atan(Math.abs(z_world_cam[0]/z_world_cam[2]));if(y_world_cam[1]<=0){if(z_world_cam[2]<0)phi=Math.PI-phi;if(z_world_cam[0]<0)phi=2*Math.PI-phi}else{if(z_world_cam[2]>0)phi=Math.PI-phi;if(z_world_cam[0]>0)phi=2*Math.PI-phi}}else{var phi=Math.atan(Math.abs(y_world_cam[0]/y_world_cam[2]));if(y_world_cam[2]>0)phi=Math.PI-phi;if(y_world_cam[0]>0)phi=2*Math.PI-phi}dest[0]=phi;dest[1]=theta;return dest}exports.set_frustum=set_frustum;function set_frustum(cam,
v_fov_or_top,near,far,h_fov_or_right){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:cam.fov=v_fov_or_top;cam.aspect=1;break;case exports.TYPE_ORTHO:cam.top=v_fov_or_top;cam.aspect=1;break;case exports.TYPE_PERSP_ASPECT:delete cam.fov;cam.fov=v_fov_or_top;cam.aspect=h_fov_or_right/v_fov_or_top;break;case exports.TYPE_ORTHO_ASPECT:cam.top=v_fov_or_top;cam.aspect=h_fov_or_right/v_fov_or_top;break;default:m_print.error("set_frustum(): Unsupported camera type: "+
cam.type);break}cam.near=near;cam.far=far}exports.set_frustum_asymmetric=set_frustum_asymmetric;function set_frustum_asymmetric(cam,left,right,bottom,top,near,far){switch(cam.type){case exports.TYPE_ORTHO_ASYMMETRIC:cam.left=left;cam.right=right;cam.bottom=bottom;cam.top=top;cam.near=near;cam.far=far;break;default:m_print.error("set_frustum_asymmetric(): "+"Unsupported camera type: "+cam.type);break}}exports.get_move_style=get_move_style;function get_move_style(camobj){return camobj._render.move_style}
exports.set_view=set_view;function set_view(cam,camobj){var trans=camobj._render.trans;var quat=camobj._render.quat;var wm=_mat4_tmp;m_mat4.rotateX(camobj._render.world_matrix,-Math.PI/2,wm);m_mat4.invert(wm,cam.view_matrix);if(cam.reflection_plane){reflect_view_matrix(cam);reflect_proj_matrix(cam)}var x=cam.view_matrix[12];var y=cam.view_matrix[13];var z=cam.view_matrix[14];if(cam.type==exports.TYPE_STEREO_LEFT)cam.view_matrix[12]+=cam.stereo_eye_dist/2;else if(cam.type==exports.TYPE_STEREO_RIGHT)cam.view_matrix[12]-=
cam.stereo_eye_dist/2;m_mat4.copy(cam.view_proj_matrix,cam.prev_view_proj_matrix);m_mat4.multiply(cam.proj_matrix,cam.view_matrix,cam.view_proj_matrix);calc_view_proj_inverse(cam);calc_sky_vp_inverse(cam);m_vec3.copy(cam.eye,cam.eye_last);m_vec3.copy(trans,cam.eye);m_quat.copy(quat,cam.quat)}function reflect_view_matrix(cam){var Nx=cam.reflection_plane[0];var Ny=cam.reflection_plane[1];var Nz=cam.reflection_plane[2];var D=cam.reflection_plane[3];var refl_mat=_mat4_tmp;refl_mat[0]=1-2*Nx*Nx;refl_mat[1]=
-2*Nx*Ny;refl_mat[2]=-2*Nx*Nz;refl_mat[3]=0;refl_mat[4]=-2*Nx*Ny;refl_mat[5]=1-2*Ny*Ny;refl_mat[6]=-2*Ny*Nz;refl_mat[7]=0;refl_mat[8]=-2*Nx*Nz;refl_mat[9]=-2*Ny*Nz;refl_mat[10]=1-2*Nz*Nz;refl_mat[11]=0;refl_mat[12]=-2*Nx*D;refl_mat[13]=-2*Ny*D;refl_mat[14]=-2*Nz*D;refl_mat[15]=1;m_mat4.multiply(cam.view_matrix,refl_mat,cam.view_matrix)}function reflect_proj_matrix(cam){set_projection(cam,cam.aspect,true);var plane=_vec4_tmp;var view_inv_transp_matrix=_mat4_tmp;m_mat4.invert(cam.view_matrix,view_inv_transp_matrix);
m_mat4.transpose(view_inv_transp_matrix,view_inv_transp_matrix);m_vec4.transformMat4(cam.reflection_plane,view_inv_transp_matrix,plane);var corner_point=_vec4_tmp2;corner_point[0]=(m_util.sign(plane[0])+cam.proj_matrix[8])/cam.proj_matrix[0];corner_point[1]=(m_util.sign(plane[1])+cam.proj_matrix[9])/cam.proj_matrix[5];corner_point[2]=-1;corner_point[3]=(1+cam.proj_matrix[10])/cam.proj_matrix[14];var dot=plane[0]*corner_point[0]+plane[1]*corner_point[1]+plane[2]*corner_point[2]+plane[3]*corner_point[3];
m_vec4.scale(plane,2/dot,plane);cam.proj_matrix[2]=plane[0];cam.proj_matrix[6]=plane[1];cam.proj_matrix[10]=plane[2]+1;cam.proj_matrix[14]=plane[3]}exports.set_view_eye_target_up=set_view_eye_target_up;function set_view_eye_target_up(cam,eye,target,up){m_mat4.lookAt(eye,target,up,cam.view_matrix);if(cam.type==exports.TYPE_STEREO_LEFT)cam.view_matrix[12]+=cam.stereo_eye_dist/2;else if(cam.type==exports.TYPE_STEREO_RIGHT)cam.view_matrix[12]-=cam.stereo_eye_dist/2;m_mat4.multiply(cam.proj_matrix,cam.view_matrix,
cam.view_proj_matrix);calc_view_proj_inverse(cam);calc_sky_vp_inverse(cam);m_vec3.copy(eye,cam.eye)}exports.set_view_trans_quat=function(cam,trans,quat){var target=_vec3_tmp;target[0]=0;target[1]=-1;target[2]=0;m_vec3.transformQuat(target,quat,target);target[0]+=trans[0];target[1]+=trans[1];target[2]+=trans[2];var up=_vec3_tmp2;up[0]=0;up[1]=0;up[2]=-1;m_vec3.transformQuat(up,quat,up);set_view_eye_target_up(cam,trans,target,up)};exports.set_camera_trans_quat=function(obj,trans,quat){if(obj["type"]!=
"CAMERA")throw"Wrong camera object";var render=obj._render;render.trans[0]=trans[0];render.trans[1]=trans[1];render.trans[2]=trans[2];render.quat[0]=quat[0];render.quat[1]=quat[1];render.quat[2]=quat[2];render.quat[3]=quat[3]};exports.eye_target_up_to_trans_quat=function(eye,target,up,trans,quat){trans[0]=eye[0];trans[1]=eye[1];trans[2]=eye[2];m_mat4.lookAt(eye,target,up,_mat4_tmp);m_mat4.invert(_mat4_tmp,_mat4_tmp);m_mat4.rotateX(_mat4_tmp,Math.PI/2,_mat4_tmp);var rot_matrix=_mat3_tmp;m_mat3.fromMat4(_mat4_tmp,
rot_matrix);m_quat.fromMat3(rot_matrix,quat)};exports.update_camera_transform=function(obj){var cameras=obj._render.cameras;if(!cameras)throw"Wrong object";var render=obj._render;for(var i=0;i<cameras.length;i++){var cam=cameras[i];set_view(cam,obj);m_util.extract_frustum_planes(cam.view_proj_matrix,cam.frustum_planes);if(cam.dof_object)if(cam.dof_on){var cam_loc=render.trans;var obj_loc=cam.dof_object.location;var dof_dist=m_vec3.dist(cam_loc,obj_loc);cam.dof_distance=dof_dist}else cam.dof_distance=
0}};exports.clamp_vertical_limits=function(obj){var render=obj._render;if(render.vertical_limits!==null){var angles=get_angles(obj,_vec2_tmp);var phi=angles[0];var theta=angles[1];var z_world_cam=m_util.quat_to_dir(render.quat,m_util.AXIS_Z,_vec3_tmp);var camera_upside_down=m_util.sign(z_world_cam[1]);if(Math.abs(theta)>Math.PI/4)if(camera_upside_down==1)phi+=Math.PI;var clamping_theta=theta;if(camera_upside_down==1)clamping_theta=m_util.sign(theta)*Math.PI-theta;var is_clamped=false;if(clamping_theta<
-render.vertical_limits.down){var new_theta=-render.vertical_limits.down;if(new_theta<-Math.PI/2)new_theta=-Math.PI-new_theta;var return_rotation=-camera_upside_down*(new_theta-theta);if(camera_upside_down==1&&render.vertical_limits.down<Math.PI/2){phi+=Math.PI;return_rotation+=Math.PI-2*render.vertical_limits.down}is_clamped=true}if(clamping_theta>render.vertical_limits.up){var new_theta=render.vertical_limits.up;if(new_theta>Math.PI/2)new_theta=Math.PI-new_theta;var return_rotation=-camera_upside_down*
(new_theta-theta);if(camera_upside_down==1&&render.vertical_limits.up<Math.PI/2){phi+=Math.PI;return_rotation-=Math.PI-2*render.vertical_limits.up}is_clamped=true}if(is_clamped){if(render.move_style==exports.MS_TARGET_CONTROLS){var sin_phi=Math.sin(phi);var cos_phi=Math.cos(phi);var sin_theta=Math.sin(new_theta);var cos_theta=Math.cos(new_theta);render.trans[0]-=obj._constraint.target[0];render.trans[1]-=obj._constraint.target[1];render.trans[2]-=obj._constraint.target[2];var len=m_vec3.length(render.trans);
render.trans[0]=cos_theta*sin_phi;render.trans[1]=-sin_theta;render.trans[2]=cos_theta*cos_phi;m_vec3.scale(render.trans,len/m_vec3.length(render.trans),render.trans);render.trans[0]+=obj._constraint.target[0];render.trans[1]+=obj._constraint.target[1];render.trans[2]+=obj._constraint.target[2]}var axis=m_vec3.transformQuat(m_util.AXIS_X,render.quat,_vec3_tmp);m_vec3.normalize(axis,axis);var clamp_rotation=m_quat.setAxisAngle(axis,return_rotation,_quat4_tmp);m_quat.multiply(clamp_rotation,render.quat,
render.quat)}}};exports.is_float_aspect=function(cam){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_ORTHO:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:return true;default:return false}};exports.get_angular_diameter=function(camobj){var cam=camobj._render.cameras[0];switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:return Math.PI*cam.fov/180;default:m_print.error("get_min_fov(): Unsupported camera type: "+
cam.type);return 0}};exports.set_projection=set_projection;function set_projection(cam,aspect,keep_proj_view){switch(cam.type){case exports.TYPE_PERSP:if(!aspect)throw"No aspect ratio";cam.aspect=aspect;case exports.TYPE_PERSP_ASPECT:m_mat4.perspective(m_util.rad(cam.fov),cam.aspect,cam.near,cam.far,cam.proj_matrix);break;case exports.TYPE_ORTHO:if(!aspect)throw"No aspect ratio";cam.aspect=aspect;case exports.TYPE_ORTHO_ASPECT:var right=cam.top*cam.aspect;m_mat4.ortho(-right,right,-cam.top,cam.top,
cam.near,cam.far,cam.proj_matrix);break;case exports.TYPE_ORTHO_ASYMMETRIC:m_mat4.ortho(cam.left,cam.right,cam.bottom,cam.top,cam.near,cam.far,cam.proj_matrix);break;case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:if(!aspect)throw"No aspect ratio";cam.aspect=aspect;set_projection_stereo(cam);break;case exports.TYPE_NONE:return;default:throw"Wrong camera type: "+cam.type;}if(!keep_proj_view){m_mat4.multiply(cam.proj_matrix,cam.view_matrix,cam.view_proj_matrix);calc_view_proj_inverse(cam);
calc_sky_vp_inverse(cam)}}function set_projection_stereo(cam){var fov_tan=Math.tan(cam.fov*Math.PI/360);var top=cam.near*fov_tan;var bottom=-top;var a=cam.aspect*cam.stereo_conv_dist*fov_tan;if(cam.type==exports.TYPE_STEREO_LEFT){var b=a-cam.stereo_eye_dist/2;var c=a+cam.stereo_eye_dist/2}else{var b=a+cam.stereo_eye_dist/2;var c=a-cam.stereo_eye_dist/2}var left=-(cam.near/cam.stereo_conv_dist*b);var right=cam.near/cam.stereo_conv_dist*c;m_mat4.frustum(left,right,bottom,top,cam.near,cam.far,cam.proj_matrix);
cam.left=left;cam.right=right}exports.calc_sky_vp_inverse=calc_sky_vp_inverse;function calc_sky_vp_inverse(cam){m_mat4.copy(cam.view_matrix,cam.sky_vp_inv_matrix);cam.sky_vp_inv_matrix[12]=0;cam.sky_vp_inv_matrix[13]=0;cam.sky_vp_inv_matrix[14]=0;cam.sky_vp_inv_matrix[15]=1;m_mat4.multiply(cam.proj_matrix,cam.sky_vp_inv_matrix,cam.sky_vp_inv_matrix);m_mat4.invert(cam.sky_vp_inv_matrix,cam.sky_vp_inv_matrix)}exports.calc_view_proj_inverse=calc_view_proj_inverse;function calc_view_proj_inverse(cam){m_mat4.copy(cam.view_matrix,
cam.view_proj_inv_matrix);m_mat4.multiply(cam.proj_matrix,cam.view_proj_inv_matrix,cam.view_proj_inv_matrix);m_mat4.invert(cam.view_proj_inv_matrix,cam.view_proj_inv_matrix)}exports.extract_frustum_corners=function(cam,near,far,corners){if(!corners)var corners=new Float32Array(24);if(!near)var near=cam.near;if(!far)var far=cam.far;var top_near,right_near,left_near,bottom_near;var top_far,right_far,left_far,bottom_far;switch(cam.type){case exports.TYPE_NONE:throw"Extraction from NONE camera is not possible";
break;case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:top_near=near*Math.tan(cam.fov*Math.PI/360);right_near=top_near*cam.aspect;bottom_near=-top_near;left_near=-right_near;top_far=far*Math.tan(cam.fov*Math.PI/360);right_far=top_far*cam.aspect;bottom_far=-top_far;left_far=-right_far;break;case exports.TYPE_ORTHO:case exports.TYPE_ORTHO_ASPECT:var right=cam.top*cam.aspect;top_near=top_far=cam.top;right_near=right_far=right;bottom_near=bottom_far=-cam.top;left_near=left_far=-right;break;case exports.TYPE_ORTHO_ASYMMETRIC:top_near=
top_far=cam.top;right_near=right_far=cam.right;bottom_near=bottom_far=cam.bottom;left_near=left_far=cam.left;break;case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:top_near=near*Math.tan(cam.fov*Math.PI/360);right_near=cam.right;bottom_near=-top_near;left_near=cam.left;var k=far/near;top_far=top_near*k;right_far=right_near*k;bottom_far=bottom_near*k;left_far=left_near*k;break;default:throw"Wrong camera type: "+cam.type;}corners[0]=left_near;corners[1]=bottom_near;corners[2]=-near;corners[3]=
right_near;corners[4]=bottom_near;corners[5]=-near;corners[6]=right_near;corners[7]=top_near;corners[8]=-near;corners[9]=left_near;corners[10]=top_near;corners[11]=-near;corners[12]=left_far;corners[13]=bottom_far;corners[14]=-far;corners[15]=left_far;corners[16]=top_far;corners[17]=-far;corners[18]=right_far;corners[19]=top_far;corners[20]=-far;corners[21]=right_far;corners[22]=bottom_far;corners[23]=-far;var view_inv=_mat4_tmp;m_mat4.invert(cam.view_matrix,view_inv);m_util.positions_multiply_matrix(corners,
view_inv,corners,0);return corners};exports.assign_boundings=function(camobj){var CAM_COLL_HEIGHT=1.75;var CAM_COLL_RADIUS=0.35;var render=camobj._render;var bb=m_bounds.zero_bounding_box();bb.min_x=-0.5,bb.max_x=0.5,bb.min_y=-0.5,bb.max_y=0.5;bb.min_z=0,bb.max_z=1.8,render.bb_local=bb;var bs=m_bounds.zero_bounding_sphere();bs.radius=2;render.bs_local=bs;var EYE_OFFSET=0.15;render.bcap_local={radius:CAM_COLL_RADIUS,height:CAM_COLL_HEIGHT-2*CAM_COLL_RADIUS,center:[0,0,CAM_COLL_HEIGHT/2-EYE_OFFSET]}};
exports.is_camera=is_camera;function is_camera(obj){if(obj["type"]==="CAMERA")return true;else return false}exports.is_target_camera=function(obj){if(is_camera(obj)&&(obj._render&&obj._render.move_style==exports.MS_TARGET_CONTROLS))return true;else return false}};b4w.module["__lights"]=function(exports,require){var m_util=require("__util");var m_vec3=require("vec3");var _lamps_numb=0;exports.lamp_to_light=function(lamp_obj){var light=init_light();light.index=_lamps_numb++;light.name=lamp_obj["name"];var data=lamp_obj["data"];light.type=data["type"];var quat=lamp_obj._render.quat;var dir=m_util.quat_to_dir(quat,m_util.AXIS_Y,[]);m_vec3.normalize(dir,dir);light.direction[0]=dir[0];light.direction[1]=dir[1];light.direction[2]=dir[2];light.color[0]=data["color"][0];
light.color[1]=data["color"][1];light.color[2]=data["color"][2];light.energy=data["energy"];update_color_intensity(light);light.distance=data["distance"];if(light.type==="POINT"||light.type==="SPOT")light.falloff_type=data["falloff_type"];if(light.type==="SPOT"){light.spot_size=data["spot_size"];light.spot_blend=data["spot_blend"]}light.generate_shadows=data["b4w_generate_shadows"];light.dynamic_intensity=data["b4w_dynamic_intensity"];lamp_obj._light=light};function init_light(){var light={};light.direction=
new Float32Array(3);m_vec3.normalize(light.direction,light.direction);light.color=new Float32Array(3);light.energy=1;light.color_intensity=new Float32Array(3);update_color_intensity(light);light.distance=25;light.generate_shadows=false;return light}exports.set_light_color=function(light,color){light.color[0]=color[0];light.color[1]=color[1];light.color[2]=color[2];update_color_intensity(light)};exports.set_light_energy=function(light,energy){light.energy=energy;update_color_intensity(light)};function update_color_intensity(light){light.color_intensity[0]=
light.color[0]*light.energy;light.color_intensity[1]=light.color[1]*light.energy;light.color_intensity[2]=light.color[2]*light.energy}exports.update_light_transform=update_light_transform;function update_light_transform(obj){if(obj["type"]!="LAMP")throw"Wrong light object";var light=obj._light;if(!light)return;m_util.quat_to_dir(obj._render.quat,m_util.AXIS_Y,light.direction)}exports.cleanup=function(){_lamps_numb=0}};b4w.module["__scenes"]=function(exports,require){var m_batch=require("__batch");var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cfg=require("__config");var m_dbg=require("__debug");var m_geom=require("__geometry");var m_graph=require("__graph");var m_hud=require("__hud");var m_particles=require("__particles");var m_prerender=require("__prerender");var m_primitives=require("__primitives");var m_print=require("__print");var m_render=require("__renderer");var m_scgraph=require("__scenegraph");
var m_sfx=require("__sfx");var m_shaders=require("__shaders");var m_tex=require("__textures");var m_util=require("__util");var m_vec3=require("vec3");var cfg_def=m_cfg.defaults;var cfg_scs=m_cfg.scenes;var VALID_OBJ_TYPES=["ARMATURE","CAMERA","CURVE","EMPTY","LAMP","MESH","SPEAKER"];var OBJECT_SUBSCENE_TYPES=["GRASS_MAP","SHADOW_CAST","MAIN_OPAQUE","MAIN_BLEND","MAIN_REFLECT","COLOR_PICKING","DEPTH","GLOW_MASK","WIREFRAME"];var LIGHT_SUBSCENE_TYPES=["MAIN_OPAQUE","MAIN_BLEND","MAIN_REFLECT","GOD_RAYS",
"SKY","LUMINANCE_TRUNCED"];var FOG_SUBSCENE_TYPES=["MAIN_OPAQUE","SSAO","MAIN_BLEND","MAIN_REFLECT"];var TIME_SUBSCENE_TYPES=["SHADOW_CAST","MAIN_OPAQUE","MAIN_BLEND","MAIN_REFLECT","COLOR_PICKING","DEPTH","GOD_RAYS","GLOW_MASK","WIREFRAME"];var MAIN_SUBSCENE_TYPES=["MAIN_OPAQUE","MAIN_BLEND","MAIN_REFLECT"];var SHORE_DIST_COMPAT=100;var MAX_BATCH_TEXTURES=8;var _active_scene=null;var _scenes=[];var _glow_anim_objs=[];var _tex_glow_input=null;var _canvas_width;var _canvas_height;var MAX_SHADER_VARYING_COUNT=
10;var GRASS_MAP_MARGIN=1E-4;var _vec2_tmp=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _vec4_tmp2=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _frustum_corners_tmp=new Float32Array(24);var _bb_tmp=m_bounds.zero_bounding_box();var _bb_tmp2=m_bounds.zero_bounding_box();var _bb_tmp3=m_bounds.zero_bounding_box();exports.set_active=function(scene){_active_scene=scene;m_sfx.set_active_scene(scene)};exports.prepare_rendering=function(scene){if(!scene._render_to_texture){var render=
scene._render;var queue=m_scgraph.create_rendering_queue(render.graph);for(var i=0;i<queue.length;i++)render.queue.push(queue[i]);setup_scene_dim(scene,_canvas_width,_canvas_height,false)}var wind=m_particles.wind();var subs_arr=subs_array(scene,TIME_SUBSCENE_TYPES);for(i=0;i<subs_arr.length;i++){var subs=subs_arr[i];subs.wind=wind}};exports.get_active=get_active;function get_active(){if(!_active_scene)throw"no active scene";return _active_scene}exports.check_active=check_active;function check_active(){if(_active_scene)return true;
else return false}exports.get_all_scenes=function(){return _scenes};exports.append_scene=append_scene;function append_scene(bpy_scene){bpy_scene._objects={"ALL":[]};bpy_scene._appended_objects={"ALL":[]};for(var i in VALID_OBJ_TYPES){var type=VALID_OBJ_TYPES[i];var objs=combine_scene_objects(bpy_scene,type);bpy_scene._objects[type]=objs;for(var j=0;j<objs.length;j++)bpy_scene._objects["ALL"].push(objs[j]);bpy_scene._appended_objects[type]=[]}bpy_scene._render=bpy_scene._render||{};var render=bpy_scene._render;
var cam_render=bpy_scene["camera"]._render;var shs=bpy_scene["world"]["b4w_shadow_settings"];var rshs=render.shadow_params={};rshs.csm_near=shs["csm_near"];rshs.csm_far=shs["csm_far"];rshs.csm_num=shs["csm_num"];rshs.csm_lambda=shs["csm_lambda"];rshs.blur_depth_size_mult=shs["blur_depth_size_mult"];rshs.blur_depth_edge_size=shs["blur_depth_edge_size"];rshs.blur_depth_diff_threshold=shs["blur_depth_diff_threshold"]/1E3;rshs.visibility_falloff=shs["visibility_falloff"];var fog_color=bpy_scene["world"]["b4w_fog_color"];
var fog_dens=bpy_scene["world"]["b4w_fog_density"];render.fog_color_density=new Float32Array([fog_color[0],fog_color[1],fog_color[2],fog_dens]);if(!cfg_def.deferred_rendering){render.sky_params=extract_sky_params(bpy_scene);render.world_light_set=get_world_light_set(bpy_scene);render.ssao_params=extract_ssao_params(bpy_scene);render.lamps_number=get_scene_objs(bpy_scene,"LAMP").length;render.procedural_sky=check_procedural_sky(bpy_scene);render.water_params=get_water_params(bpy_scene);render.dynamic_grass=
false;render.color_picking=check_selectable_objects(bpy_scene);render.graph=m_scgraph.create_rendering_graph_compat(cam_render,render)}else{var rtt=bpy_scene._render_to_texture;render.render_shadows=check_render_shadows(bpy_scene);render.fog_color=bpy_scene["world"]["b4w_fog_color"];render.shore_smoothing=check_shore_smoothing(bpy_scene);render.refl_planes=check_render_reflections(bpy_scene);render.water_params=get_water_params(bpy_scene);render.procedural_sky=check_procedural_sky(bpy_scene);render.sky_params=
extract_sky_params(bpy_scene);render.ssao_params=extract_ssao_params(bpy_scene);render.bloom_params=extract_bloom_params(bpy_scene);render.mb_params=extract_mb_params(bpy_scene);render.cc_params=extract_cc_params(bpy_scene);render.god_rays_params=extract_god_rays_params(bpy_scene);render.glow_params=extract_glow_params(bpy_scene);render.world_light_set=get_world_light_set(bpy_scene);render.dynamic_grass=check_dynamic_grass(bpy_scene);render.motion_blur=cfg_def.motion_blur&&bpy_scene["b4w_enable_motion_blur"];
render.compositing=cfg_def.compositing&&bpy_scene["b4w_enable_color_correction"];render.antialiasing=cfg_def.antialiasing&&bpy_scene["b4w_enable_antialiasing"];render.lamps_number=get_scene_objs(bpy_scene,"LAMP").length;render.bloom=cfg_def.bloom&&bpy_scene["b4w_enable_bloom"];render.ssao=cfg_def.ssao&&bpy_scene["b4w_enable_ssao"];render.god_rays=cfg_def.god_rays&&bpy_scene["b4w_enable_god_rays"];render.refractions=cfg_def.refractions&&bpy_scene["b4w_render_refractions"];render.color_picking=check_selectable_objects(bpy_scene);
render.glow=cfg_def.glow?render.color_picking:false;render.graph=m_scgraph.create_rendering_graph(rtt,render,cam_render)}render.queue=[];render.need_shadow_update=false;render.need_grass_map_update=false;_scenes.push(bpy_scene)}exports.combine_scene_objects=combine_scene_objects;function combine_scene_objects(scene,type){if(!type)type="ALL";var scene_objs_arr=[];combine_scene_objects_iter(scene["objects"],type,scene_objs_arr);return scene_objs_arr}function combine_scene_objects_iter(objects,type,
dest){for(var i=0;i<objects.length;i++){var obj=objects[i];if(type=="ALL"||type==obj["type"])dest.push(obj);var dupli_group=obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];combine_scene_objects_iter(dg_objects,type,dest)}}}function check_render_shadows(bpy_scene){if(cfg_def.shadows=="NONE"||!bpy_scene["b4w_render_shadows"])return false;var has_casters=false;var has_receivers=false;var objects=get_scene_objs(bpy_scene,"MESH");for(var i=0;i<objects.length;i++){var obj=objects[i];
if(obj["b4w_shadow_cast"])has_casters=true;if(obj["b4w_shadow_receive"])has_receivers=true;if(has_casters&&has_receivers)return true}return false}function check_shore_smoothing(bpy_scene){if(!cfg_def.shore_smoothing)return false;var mats=get_scene_materials(bpy_scene);for(var i=0;i<mats.length;i++){var mat=mats[i];if(mat["b4w_water"]&&mat["b4w_water_shore_smoothing"])return true}return false}function get_water_params(bpy_scene){var mats=get_scene_materials(bpy_scene);var water_params=[];var objects=
get_scene_objs(bpy_scene,"MESH");for(var i=0;i<mats.length;i++){var mat=mats[i];if(mat["b4w_water"]){var wp={};for(var j=0;j<objects.length;j++){var obj=objects[j];var mesh=obj["data"];var mesh_mats=mesh["materials"];for(var k=0;k<mesh_mats.length;k++){var mesh_mat=mesh_mats[k];if(mesh_mat==mat)wp.water_level=obj["location"][1]}}if(!cfg_def.deferred_rendering){wp.waves_height=0;wp.waves_length=0;wp.caustic_scale=null;wp.caustic_brightness=null;wp.caustic_speed=null;wp.fog_color_density=null;wp.dynamic=
false;water_params.push(wp);continue}wp.fog_color_density=mat["b4w_water_fog_color"].slice(0);wp.fog_color_density.push(mat["b4w_water_fog_density"]);if(mat["b4w_water_dynamic"]){wp.dynamic=true;wp.waves_height=mat["b4w_waves_height"];wp.waves_length=mat["b4w_waves_length"];wp.dst_noise_scale0=mat["b4w_water_dst_noise_scale0"];wp.dst_noise_scale1=mat["b4w_water_dst_noise_scale1"];wp.dst_noise_freq0=mat["b4w_water_dst_noise_freq0"];wp.dst_noise_freq1=mat["b4w_water_dst_noise_freq1"];wp.dir_min_shore_fac=
mat["b4w_water_dir_min_shore_fac"];wp.dir_freq=mat["b4w_water_dir_freq"];wp.dir_noise_scale=mat["b4w_water_dir_noise_scale"];wp.dir_noise_freq=mat["b4w_water_dir_noise_freq"];wp.dir_min_noise_fac=mat["b4w_water_dir_min_noise_fac"];wp.dst_min_fac=mat["b4w_water_dst_min_fac"];wp.waves_hor_fac=mat["b4w_water_waves_hor_fac"]}else{wp.dynamic=false;wp.waves_height=0;wp.waves_length=0}wp.caustic_scale=null;wp.caustic_brightness=null;wp.caustic_speed=new Float32Array(2);wp.shoremap_image=null;var texture_slots=
mat["texture_slots"];for(var j=0;j<texture_slots.length;j++){var texture=texture_slots[j]["texture"];if(texture["type"]=="VORONOI"){wp.caustic_scale=texture["noise_scale"];wp.caustic_speed=texture["b4w_uv_velocity_trans"];wp.caustic_brightness=texture["noise_intensity"]}if(texture["b4w_shore_dist_map"]===true){wp.shoremap_image=texture["image"];wp.shoremap_tex_size=texture["image"]["size"][0];wp.shore_boundings=texture["b4w_shore_boundings"];wp.max_shore_dist=texture["b4w_max_shore_dist"]}}water_params.push(wp)}}if(water_params.length>
0){var wp=water_params[0];if(!wp.dynamic)for(var i=0;i<water_params.length;i++)if(water_params[i].dynamic)wp=water_params[i];return wp}else return null}function check_render_reflections(bpy_scene){if(!cfg_def.reflections||!bpy_scene["b4w_render_reflections"])return false;var reflective_planes=[];var objects=get_scene_objs(bpy_scene,"MESH");for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj["b4w_reflective"]){var refl_plane_obj=get_reflection_plane(obj);if(!refl_plane_obj)continue;var trans=
refl_plane_obj["location"];var quat=refl_plane_obj._render.quat;var refl_plane=new Float32Array(4);m_util.trans_quat_to_plane(trans,quat,m_util.AXIS_Y,refl_plane);reflective_planes.push(refl_plane)}}return reflective_planes}function get_reflection_plane(bpy_obj){var constraints=bpy_obj["constraints"];var lods_num=bpy_obj["b4w_lods_num"];var num=0;for(var i=0;i<constraints.length;i++){var cons=constraints[i];if(cons["type"]=="LOCKED_TRACK"){if(num==lods_num)return cons["target"];num++}}return null}
function check_procedural_sky(bpy_scene){var objects=get_scene_objs(bpy_scene,"MESH");for(var i=0;i<objects.length;i++){var obj=objects[i];var materials=obj["data"]["materials"];for(var j=0;j<materials.length;j++){var mat=materials[j];if(mat["b4w_skydome"]&&mat["b4w_procedural_skydome"])return true}}return false}function extract_sky_params(bpy_scene){var sky_params={};var world=bpy_scene["world"];var sky_settings=bpy_scene["world"]["b4w_sky_settings"];sky_params.sky_color=sky_settings["color"];sky_params.rayleigh_brightness=
sky_settings["rayleigh_brightness"];sky_params.mie_brightness=sky_settings["mie_brightness"];sky_params.spot_brightness=sky_settings["spot_brightness"];sky_params.scatter_strength=sky_settings["scatter_strength"];sky_params.rayleigh_strength=sky_settings["rayleigh_strength"];sky_params.mie_strength=sky_settings["mie_strength"];sky_params.rayleigh_collection_power=sky_settings["rayleigh_collection_power"];sky_params.mie_collection_power=sky_settings["mie_collection_power"];sky_params.mie_distribution=
sky_settings["mie_distribution"];return sky_params}function extract_ssao_params(bpy_scene){var ssao_params={};var ssao_settings=bpy_scene["world"]["b4w_ssao_settings"];ssao_params.radius_increase=ssao_settings["radius_increase"];ssao_params.dithering_amount=ssao_settings["dithering_amount"];ssao_params.gauss_center=ssao_settings["gauss_center"];ssao_params.gauss_width_square=ssao_settings["gauss_width"]*ssao_settings["gauss_width"];ssao_params.gauss_width_left_square=ssao_settings["gauss_width_left"]*
ssao_settings["gauss_width_left"];ssao_params.influence=ssao_settings["influence"];ssao_params.dist_factor=ssao_settings["dist_factor"];ssao_params.samples=ssao_settings["samples"];return ssao_params}function extract_bloom_params(bpy_scene){var bloom_params={};var bloom_settings=bpy_scene["world"]["b4w_bloom_settings"];bloom_params.blur=bloom_settings["blur"];bloom_params.edge_lum=bloom_settings["edge_lum"];bloom_params.key=bloom_settings["key"];return bloom_params}function extract_mb_params(bpy_scene){var mb_params=
{};var mb_settings=bpy_scene["world"]["b4w_motion_blur_settings"];mb_params.mb_decay_threshold=mb_settings["motion_blur_decay_threshold"];mb_params.mb_factor=mb_settings["motion_blur_factor"];return mb_params}function extract_cc_params(bpy_scene){var cc_params={};var cc_settings=bpy_scene["world"]["b4w_color_correction_settings"];cc_params.brightness=cc_settings["brightness"];cc_params.contrast=cc_settings["contrast"];cc_params.exposure=cc_settings["exposure"];cc_params.saturation=cc_settings["saturation"];
return cc_params}function extract_god_rays_params(bpy_scene){var god_rays_params={};var god_rays_settings=bpy_scene["world"]["b4w_god_rays_settings"];god_rays_params.intensity=god_rays_settings["intensity"];god_rays_params.max_ray_length=god_rays_settings["max_ray_length"];god_rays_params.steps_per_pass=god_rays_settings["steps_per_pass"];return god_rays_params}function extract_glow_params(bpy_scene){var glow_params={};var glow_settings=bpy_scene["world"];glow_params.glow_color=glow_settings["b4w_glow_color"];
glow_params.glow_factor=glow_settings["b4w_glow_factor"];return glow_params}function get_world_light_set(bpy_scene){var world=bpy_scene["world"];var hor=[0,0,0];var zen=[0,0,0];var wls=bpy_scene["world"]["light_settings"];if(wls["use_environment_light"])if(wls["environment_color"]=="SKY_COLOR"){hor=bpy_scene["world"]["horizon_color"].slice(0);zen=world["zenith_color"].slice(0)}else if(wls["environment_color"]=="PLAIN"){hor=[1,1,1];zen=[1,1,1]}else throw"Unsupported world environment color"+wls["environment_color"];
var wls_params={};wls_params.environment_energy=wls["environment_energy"];wls_params.horizon_color=hor;wls_params.zenith_color=zen;return wls_params}function check_dynamic_grass(bpy_scene){if(!cfg_def.dynamic_grass)return false;var has_terrain=false;var has_dyn_grass=false;var objects=get_scene_objs(bpy_scene,"MESH");for(var i=0;i<objects.length;i++){var obj=objects[i];var materials=obj["data"]["materials"];for(var j=0;j<materials.length;j++){var mat=materials[j];if(mat["b4w_terrain"])has_terrain=
true}var psystems=obj["particle_systems"];for(var j=0;j<psystems.length;j++){var pset=psystems[j]["settings"];if(pset["type"]=="HAIR"&&pset["b4w_dynamic_grass"])has_dyn_grass=true}if(has_terrain&&has_dyn_grass)return true}return false}function check_selectable_objects(bpy_scene){var objects=get_scene_objs(bpy_scene,"MESH");for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj._render.selectable)return true}return false}exports.get_graph=function(scene){return scene._render.graph};exports.generate_auxiliary_batches=
function(graph){m_graph.traverse(graph,function(node,attr){var subs=attr;var batch=null;switch(subs.type){case "POSTPROCESSING":batch=m_batch.create_postprocessing_batch(subs.pp_effect);break;case "SSAO":batch=m_batch.create_ssao_batch(subs.ssao_samples);break;case "DEPTH_PACK":batch=m_batch.create_depth_pack_batch();break;case "BLUR_DEPTH":batch=m_batch.create_blur_depth_batch(subs.orientation);m_batch.set_texel_size_mult(batch,subs.blur_depth_size_mult);break;case "REFRACT":case "SCREEN":batch=
m_batch.create_postprocessing_batch("NONE");break;case "GOD_RAYS":var subs_input=m_scgraph.find_input(graph,subs,"WIREFRAME")||(m_scgraph.find_input(graph,subs,"MAIN_BLEND")||m_scgraph.find_input(graph,subs,"GOD_RAYS"));var tex_input=subs_input.camera.color_attachment;var pack=subs.pack?1:0;if(subs.reflection_plane&&subs.water)var water=1;else var water=0;var steps=subs.steps_per_pass;batch=m_batch.create_god_rays_batch(tex_input,pack,water,steps);break;case "GOD_RAYS_COMBINE":var subs_input=m_scgraph.find_input(graph,
subs,"WIREFRAME")||m_scgraph.find_input(graph,subs,"MAIN_BLEND");var subs_god_rays=m_scgraph.find_input(graph,subs,"GOD_RAYS");var tex_main=subs_input.camera.color_attachment;var tex_god_rays=subs_god_rays.camera.color_attachment;batch=m_batch.create_god_rays_combine_batch(tex_main,tex_god_rays);break;case "MOTION_BLUR":batch=m_batch.create_motion_blur_batch(subs.mb_decay_threshold);break;case "DOF":batch=m_batch.create_dof_batch();m_batch.set_texel_size_mult(batch,subs.camera.dof_power);var subs_pp1=
m_scgraph.find_input(graph,subs,"POSTPROCESSING");var subs_pp2=m_scgraph.find_input(graph,subs_pp1,"POSTPROCESSING");var subs_in=[subs_pp1,subs_pp2];for(var i=0;i<subs_in.length;i++){var bundles=subs_in[i].bundles;var batch_i=bundles[0].batch;if(batch_i&&batch_i.texel_size)m_batch.set_texel_size_mult(batch_i,subs.camera.dof_power)}break;case "GLOW":var subs_glow_blur_y=m_scgraph.find_input(graph,subs,"POSTPROCESSING");var subs_glow_blur_x=m_scgraph.find_input(graph,subs_glow_blur_y,"POSTPROCESSING");
var subs_glow_extend_y=m_scgraph.find_input(graph,subs_glow_blur_x,"POSTPROCESSING");var subs_glow_extend_x=m_scgraph.find_input(graph,subs_glow_extend_y,"POSTPROCESSING");batch=m_batch.create_glow_batch();var subs_in=[subs_glow_blur_x,subs_glow_blur_y];for(var i=0;i<subs_in.length;i++){var bundles=subs_in[i].bundles;var batch_in=bundles[0].batch;if(batch_in&&batch_in.texel_size)m_batch.set_texel_size_mult(batch_in,subs.blur_texel_size_mult)}var subs_in=[subs_glow_extend_x,subs_glow_extend_y];for(var i=
0;i<subs_in.length;i++){var bundles=subs_in[i].bundles;var batch_in=bundles[0].batch;if(batch_in&&batch_in.texel_size)m_batch.set_texel_size_mult(batch_in,subs.ext_texel_size_mult*subs.glow_factor)}break;case "COMPOSITING":batch=m_batch.create_compositing_batch();break;case "ANTIALIASING":batch=m_batch.create_antialiasing_batch();break;case "LANCZOS":batch=m_batch.create_lanczos_batch(subs.lanczos_type);break;case "SMAA_RESOLVE":case "SMAA_EDGE_DETECTION":case "SMAA_BLENDING_WEIGHT_CALCULATION":case "SMAA_NEIGHBORHOOD_BLENDING":batch=
m_batch.create_smaa_batch(subs.type);break;case "ANAGLYPH":batch=m_batch.create_anaglyph_batch();break;case "HUD":batch=m_batch.create_hud_batch();var texture=m_tex.create_texture_canvas("HUD",1,1);m_batch.append_texture(batch,texture);break;case "SKY":batch=m_batch.create_sky_batch();m_batch.set_texel_size(batch,1/subs.camera.width,1/subs.camera.height);break;case "LUMINANCE":batch=m_batch.create_luminance_batch();break;case "AVERAGE_LUMINANCE":batch=m_batch.create_average_luminance_batch();break;
case "LUMINANCE_TRUNCED":batch=m_batch.create_luminance_trunced_batch();break;case "BLOOM_BLUR":batch=m_batch.create_bloom_blur_batch(subs.pp_effect);m_batch.set_texel_size(batch,1/subs.camera.width,1/subs.camera.height);break;case "BLOOM":var subs_blur_y=m_scgraph.find_input(graph,subs,"BLOOM_BLUR");var subs_blur_x=m_scgraph.find_input(graph,subs_blur_y,"BLOOM_BLUR");var subs_in=[subs_blur_x,subs_blur_y];for(var i=0;i<subs_in.length;i++){var bundles=subs_in[i].bundles;var batch_in=bundles[0].batch;
if(batch_in&&batch_in.texel_size)m_batch.set_texel_size_mult(batch_in,subs.bloom_blur)}batch=m_batch.create_bloom_combine_batch();break;case "VELOCITY":batch=m_batch.create_velocity_batch();break}if(batch){var rb={do_render:true,obj_render:m_util.create_render("NONE"),batch:batch};validate_batch(batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}})};function connect_textures(graph,subs,batch){var id=m_graph.node_by_attr(graph,subs);m_graph.traverse_inputs(graph,
id,function(id_in,attr_in,attr_edge){var slink=attr_edge;var subs_in=attr_in;if(!slink.active)return;switch(slink.from){case "COLOR":case "CUBEMAP":var tex=subs_in.camera.color_attachment;break;case "DEPTH":var tex=subs_in.camera.depth_attachment;break;case "SCREEN":var tex=null;break;default:throw"Wrong slink";}switch(slink.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "NONE":case "SCREEN":break;default:if(!tex)throw"Connection of SCREEN is forbidden";var bundles=subs.bundles;for(var k=0;k<bundles.length;k++){var batch=
bundles[k].batch;if(m_shaders.check_uniform(batch.shader,slink.to))m_batch.append_texture(batch,tex,slink.to)}break}});for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];var tex=subs.textures_internal[i];switch(slink.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "NONE":case "SCREEN":break;default:var bundles=subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;if(m_shaders.check_uniform(batch.shader,slink.to))m_batch.append_texture(batch,tex,
slink.to)}break}}}exports.append_object=function(scene,obj){var type=obj["type"];var objs_type=scene._appended_objects[type];if(!objs_type){m_print.error("B4W Error - add object(): unsupported object type",type);return}if(objs_type.indexOf(obj)!=-1){m_print.error("B4W Error - add object(): already added");return}scene._appended_objects[type].push(obj);scene._appended_objects["ALL"].push(obj);switch(type){case "MESH":var graph=scene._render.graph;var obj_render=obj._render;if(!m_scgraph.find_subs(graph,
"SHADOW_CAST")&&obj_render.shadow_receive)obj_render.shadow_receive=false;var subs_arr=subs_array(scene,OBJECT_SUBSCENE_TYPES);for(var i=0;i<subs_arr.length;i++){var subs=subs_arr[i];add_object_sub(subs,obj,graph,scene)}break;case "LAMP":increase_subs_num_lights(scene);update_lamp_scene(obj,scene);break;default:break}};function increase_subs_num_lights(scene){var subs_arr=subs_array(scene,LIGHT_SUBSCENE_TYPES);for(var i=0;i<subs_arr.length;i++){var subs=subs_arr[i];subs.num_lights++}}function add_object_sub(subs,
obj,graph,bpy_scene){switch(subs.type){case "MAIN_OPAQUE":add_object_subs_main(subs,obj,graph,"OPAQUE",bpy_scene);break;case "MAIN_BLEND":add_object_subs_main(subs,obj,graph,"BLEND",bpy_scene);break;case "MAIN_REFLECT":add_object_subs_reflect(subs,obj,graph);break;case "DEPTH":add_object_subs_depth(subs,obj,graph,bpy_scene);break;case "SHADOW_CAST":add_object_subs_shadow(subs,obj,graph,bpy_scene);break;case "COLOR_PICKING":add_object_subs_color_picking(subs,obj);break;case "GRASS_MAP":add_object_subs_grass_map(subs,
obj);break;case "GLOW_MASK":add_object_subs_glow_mask(subs,obj);break;case "WIREFRAME":add_object_subs_wireframe(subs,obj,graph);break;default:break}}function add_object_subs_main(subs,obj,graph,main_type,bpy_scene){var obj_render=obj._render;var batches=obj._batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.shadow_cast_only||batch.reflexible_only)continue;if(batch.type!="SHADELESS"&&(batch.type!="MAIN"&&batch.type!="NODES")||has_batch(subs,batch))continue;if(main_type==="OPAQUE"){if(batch.blend)continue;
if(m_scgraph.find_subs(graph,"SHADOW_CAST")&&batch.shadow_receive)var shadow_source="SHADOW_SRC_MASK";else var shadow_source="SHADOW_SRC_NONE"}else if(main_type==="BLEND"){if(!batch.blend)continue;if(m_scgraph.find_subs(graph,"SHADOW_CAST")&&batch.shadow_receive)switch(cfg_def.shadows){case "RGBA":var shadow_source="SHADOW_SRC_RGBA";break;case "RGBA_PCF":var shadow_source="SHADOW_SRC_RGBA_PCF";break;case "DEPTH":var shadow_source="SHADOW_SRC_DEPTH";break;case "VSM":var shadow_source="SHADOW_SRC_VSM";
break;default:throw"Wrong shadows type";break}else var shadow_source="SHADOW_SRC_NONE"}else throw"Wrong main subscene type";var shaders_info=batch.shaders_info;m_shaders.set_directive(shaders_info,"SHADOW_SRC",shadow_source);m_batch.assign_shadow_receive_dirs(batch,get_csm_borders(bpy_scene));m_shaders.set_directive(shaders_info,"NUM_LIGHTS",subs.num_lights);if(m_shaders.get_fname(shaders_info)=="special_skydome.glslf")m_shaders.set_directive(shaders_info,"REFLECTION_PASS",0);m_shaders.set_directive(shaders_info,
"SSAO_ONLY",0);if(subs.water_params&&subs.water_fog_color_density)m_shaders.set_directive(shaders_info,"WATER_EFFECTS",1);else m_shaders.set_directive(shaders_info,"WATER_EFFECTS",0);if(subs.water_params&&(subs.caustics&&obj_render.caustics)){m_shaders.set_directive(shaders_info,"CAUSTICS",1);m_shaders.set_directive(shaders_info,"CAUST_SCALE",subs.caust_scale);m_shaders.set_directive(shaders_info,"CAUST_SPEED",m_shaders.glsl_value(subs.caust_speed,2));m_shaders.set_directive(shaders_info,"CAUST_BRIGHT",
subs.caust_brightness)}else m_shaders.set_directive(shaders_info,"CAUSTICS",0);if(subs.water_params){m_shaders.set_directive(shaders_info,"WAVES_HEIGHT",m_shaders.glsl_value(subs.water_waves_height));m_shaders.set_directive(shaders_info,"WAVES_LENGTH",m_shaders.glsl_value(subs.water_waves_length));m_shaders.set_directive(shaders_info,"WATER_LEVEL",m_shaders.glsl_value(subs.water_level))}if(batch.reflective&&(m_scgraph.find_subs(graph,"MAIN_REFLECT")&&batch.texture_names.indexOf("u_mirrormap")===-1))m_shaders.set_directive(shaders_info,
"REFLECTIVE",1);else m_shaders.set_directive(shaders_info,"REFLECTIVE",0);var subs_sky=m_scgraph.find_subs(graph,"SKY");if(subs_sky)if(batch.procedural_sky){var tex=subs_sky.camera.color_attachment;m_batch.append_texture(batch,tex,"u_sky")}else if(cfg_def.procedural_fog&&(subs.type==="MAIN_OPAQUE"||subs.type==="MAIN_BLEND")){batch.cube_fog=subs_sky.cube_fog;m_shaders.set_directive(shaders_info,"PROCEDURAL_FOG",1)}else m_shaders.set_directive(shaders_info,"PROCEDURAL_FOG",0);else m_shaders.set_directive(shaders_info,
"PROCEDURAL_FOG",0);if(batch.dynamic_grass){var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");if(subs_grass_map)prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render)}if(batch.water){if(m_scgraph.find_subs(graph,"REFRACT"))m_shaders.set_directive(shaders_info,"REFRACTIVE",1);else m_shaders.set_directive(shaders_info,"REFRACTIVE",0);if(batch.water_shore_smoothing&&m_scgraph.find_subs(graph,"DEPTH"))m_shaders.set_directive(shaders_info,"SHORE_SMOOTHING",1);else m_shaders.set_directive(shaders_info,
"SHORE_SMOOTHING",0);if(batch.water_dynamic&&(subs.water_params&&subs.water_waves_height))m_shaders.set_directive(shaders_info,"DYNAMIC",1);else m_shaders.set_directive(shaders_info,"DYNAMIC",0)}if(cfg_def.smaa&&!m_cfg.context.alpha)m_shaders.set_directive(shaders_info,"SMAA_JITTER",1);else m_shaders.set_directive(shaders_info,"SMAA_JITTER",0);if(main_type==="OPAQUE"||main_type==="BLEND"){var textures=batch.textures;for(var j=0;j<textures.length;j++){var tex=textures[j];var src=tex.offscreen_scene;
if(src){var src_graph=src._render.graph;var subs_tex=null;var slink_tex=null;m_graph.traverse_edges(src_graph,function(id1,id2,attr){var slink=attr;if(slink.from=="SCREEN"){subs_tex=m_graph.get_node_attr(src_graph,id1);slink_tex=slink;return true}});if(!subs_tex||!slink_tex)throw"Failed to assign RTT";m_tex.set_filters(tex,m_tex.TF_LINEAR,m_tex.TF_LINEAR);slink_tex.texture=tex;var cam_tex=subs_tex.camera;cam_tex.color_attachment=tex;cam_tex.framebuffer=m_render.render_target_create(tex,null);var o_width=
cfg_scs.offscreen_tex_size;var o_height=cfg_scs.offscreen_tex_size;setup_scene_dim(src,o_width,o_height,true);var queue_tex=m_scgraph.create_rendering_queue(src_graph);for(var k=queue_tex.length-1;k>=0;k--){var subs_k=queue_tex[k];var cam_k=subs_k.camera;m_cam.set_projection(cam_k,1);bpy_scene._render.queue.unshift(subs_k)}}}}prepare_shadow_receive_batch(graph,subs,shadow_source);m_batch.update_shader(batch);var rb={do_render:true,obj_render:obj_render,batch:batch};validate_batch(batch);subs.bundles.push(rb);
connect_textures(graph,subs,batch);check_batch_textures_number(batch)}var sort_fun=function(a,b){if(a==b)return 0;return a>b?1:-1};var sort_fun_double=function(a,b){if(a.batch&&b.batch)return sort_fun(a.batch.blend,b.batch.blend)||sort_fun(a.batch.offset_z,b.batch.offset_z);else return 0};subs.bundles.sort(sort_fun_double)}function validate_batch(batch){var shader=batch.shader;var attributes=shader.attributes;var bufs_data=batch.bufs_data;var pointers=bufs_data.pointers;for(var attr in attributes){var p=
pointers[attr];if(!p)throw'B4W Error: missing data for "'+attr+'" attribute';}if(batch.type=="MAIN")check_main_varyings_count(batch);if(batch.type=="NODES")check_nodes_varyings_count(batch)}function check_batch_textures_number(batch){if(batch.textures.length>MAX_BATCH_TEXTURES)m_print.warn("B4W Warning: too many textures used - "+batch.textures.length+" (max "+MAX_BATCH_TEXTURES+'), materials "'+batch.material_names.join(", ")+'"')}function check_main_varyings_count(batch){var total=4;var attr_names_for_varyings=
["a_color","a_tangent","a_texcoord"];total+=get_shader_units_presence_count(batch.shader.attributes,attr_names_for_varyings);var unif_names_for_varyings=["u_shadow_map0","u_shadow_map1","u_shadow_map2","u_shadow_map3","u_shadow_mask"];total+=get_shader_units_presence_count(batch.shader.uniforms,unif_names_for_varyings);if(total>MAX_SHADER_VARYING_COUNT)m_print.warn("B4W Warning: Varying limit exceeded for main shader - "+total+', materials "'+batch.material_names.join(", ")+'"')}function check_nodes_varyings_count(batch){var total=
2;var used_uv=0;var used_vc=0;if(batch.uv_maps_usage){used_uv+=m_util.get_dict_length(batch.uv_maps_usage);total+=used_uv}if(batch.vertex_colors_usage){used_vc+=m_util.get_dict_length(batch.vertex_colors_usage);total+=used_vc}var attr_names_for_varyings=["a_color","a_normal","a_tangent"];total+=get_shader_units_presence_count(batch.shader.attributes,attr_names_for_varyings);var unif_names_for_varyings=["u_shadow_map0","u_shadow_map1","u_shadow_map2","u_shadow_map3","u_shadow_mask"];total+=get_shader_units_presence_count(batch.shader.uniforms,
unif_names_for_varyings);if(total>MAX_SHADER_VARYING_COUNT)m_print.warn("B4W Warning: Varying limit exceeded for node shader - "+total+", uv: "+used_uv+", vc: "+used_vc+', materials "'+batch.material_names.join(", ")+'"')}function get_shader_units_presence_count(storage,names){var count=0;for(var i=0;i<names.length;i++)if(names[i]in storage)count++;return count}function prepare_shadow_receive_batch(graph,subs,shadow_source){var csm_index=0;var subs_inputs=m_scgraph.get_inputs(graph,subs);for(var i=
0;i<subs_inputs.length;i++){var input=subs_inputs[i];if((shadow_source=="SHADOW_SRC_RGBA"||(shadow_source=="SHADOW_SRC_RGBA_PCF"||(shadow_source=="SHADOW_SRC_DEPTH"||shadow_source=="SHADOW_SRC_VSM")))&&(input.type=="SHADOW_CAST"||input.type=="POSTPROCESSING")){if(shadow_source=="SHADOW_SRC_DEPTH")var tex=input.camera.depth_attachment;else var tex=input.camera.color_attachment;var cam_cast=m_scgraph.find_upper_subs(graph,input,"SHADOW_CAST").camera;subs.v_light_matrix=cam_cast.view_matrix;subs.b_light_matrix=
new Float32Array([0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);subs.p_light_matrix=subs.p_light_matrix||new Array;subs.p_light_matrix[csm_index]=cam_cast.proj_matrix;csm_index++}}}function prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render){batch.grass_map_dim=subs_grass_map.grass_map_dim;var low=subs_grass_map.grass_map_dim[0];var high=subs_grass_map.grass_map_dim[1];var size=subs_grass_map.grass_map_dim[2];var bb=obj_render.bb_local;var bb_max_size=Math.max(bb.max_x-bb.min_x,bb.max_z-
bb.min_z);if(size==0)size=bb_max_size;else size=Math.max(size,bb_max_size);subs_grass_map.grass_map_dim[2]=size;var cam=subs_grass_map.camera;m_cam.set_frustum(cam,size/2,-high,-low,size/2);m_cam.set_projection(cam);var bsize=batch.grass_size||0;if(bsize==0)bsize=bb_max_size;else bsize=Math.max(bsize,bb_max_size);batch.grass_size=bsize}exports.has_batch=has_batch;function has_batch(subscene,batch){var sbundles=subscene.bundles;for(var i=0;i<sbundles.length;i++){var sbundle=sbundles[i];var sbatch=
sbundle.batch;if(sbatch&&sbatch.id==batch.id)return true}return false}function debug_report_order(bundles){var names=[];for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;if(batch)names.push(batch.name.split("*")[2]);else names.push("NULL")}m_print.log(names)}function add_object_subs_depth(subs,obj,graph,bpy_scene){var obj_render=obj._render;var batches=obj._batches;for(var i=0;i<batches.length;i++){var batch_src=batches[i];if(batch_src.type!="DEPTH"||(has_batch(subs,batch_src)||batch_src.shadow_cast_only))continue;
if(m_scgraph.has_upper_subs(graph,subs,"SHADOW_CAST"))if(batch_src.shadow_receive){switch(cfg_def.shadows){case "RGBA":var shadow_src="SHADOW_SRC_RGBA";var shadow_dst="SHADOW_DST_MASK";break;case "RGBA_PCF":var shadow_src="SHADOW_SRC_RGBA_PCF";var shadow_dst="SHADOW_DST_MASK";break;case "DEPTH":var shadow_src="SHADOW_SRC_DEPTH";var shadow_dst="SHADOW_DST_MASK";break;case "VSM":var shadow_src="SHADOW_SRC_VSM";var shadow_dst="SHADOW_DST_MASK";break;default:throw"Wrong shadows type";break}var batch=
m_batch.fork_depth_batch(batch_src,shadow_src,shadow_dst);m_batch.assign_shadow_receive_dirs(batch,get_csm_borders(bpy_scene));var subs_inputs=m_scgraph.get_inputs(graph,subs);prepare_shadow_receive_batch(graph,subs,shadow_src)}else var batch=m_batch.fork_depth_batch(batch_src,"SHADOW_SRC_NONE","SHADOW_DST_MASK");else var batch=m_batch.fork_depth_batch(batch_src,"SHADOW_SRC_NONE","SHADOW_DST_NONE");if(batch.dynamic_grass){var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");if(subs_grass_map)prepare_dynamic_grass_batch(batch,
subs_grass_map,obj_render)}var shaders_info=batch.shaders_info;if(cfg_def.smaa&&!m_cfg.context.alpha)m_shaders.set_directive(shaders_info,"SMAA_JITTER",1);else m_shaders.set_directive(shaders_info,"SMAA_JITTER",0);m_batch.update_shader(batch);var rb={do_render:true,obj_render:obj_render,batch:batch};validate_batch(batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}}function add_object_subs_shadow(subs,obj,graph,bpy_scene){var update_needed=false;var obj_render=
obj._render;var batches=obj._batches;for(var i=0;i<batches.length;i++){var batch_src=batches[i];if(!(batch_src.shadow_cast||batch_src.shadow_receive))continue;update_needed=true;if(batch_src.type!="DEPTH"||has_batch(subs,batch_src))continue;if(batch_src.shadow_cast){switch(cfg_def.shadows){case "RGBA":case "RGBA_PCF":var shadow_dst="SHADOW_DST_RGBA";break;case "DEPTH":var shadow_dst="SHADOW_DST_DEPTH";break;case "VSM":var shadow_dst="SHADOW_DST_VSM";break;default:throw"Wrong shadows type";break}var batch=
m_batch.fork_depth_batch(batch_src,"SHADOW_SRC_NONE",shadow_dst);if(batch.dynamic_grass){var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");if(subs_grass_map)prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render)}m_shaders.set_directive(batch.shaders_info,"SMAA_JITTER",0);m_batch.update_shader(batch);var rb={do_render:true,obj_render:obj_render,batch:batch};validate_batch(batch);subs.bundles.push(rb)}}if(update_needed)update_subs_shadow(subs,m_scgraph.find_subs(graph,"MAIN_OPAQUE"),subs.bundles,
bpy_scene)}function add_object_subs_reflect(subs,obj,graph){var obj_render=obj._render;var batches=obj._batches;for(var i=0;i<batches.length;i++){var batch_src=batches[i];var batch=batch_copy_wo_bufs(batch_src);if(batch.type!="SHADELESS"&&(batch.type!="MAIN"&&batch.type!="NODES")||has_batch(subs,batch))continue;if(batch.blend)continue;if(batch.reflexible){var shaders_info=batch.shaders_info;m_shaders.set_directive(shaders_info,"DISABLE_FOG",0);m_shaders.set_directive(shaders_info,"WATER_EFFECTS",
0);if(m_shaders.get_fname(shaders_info)=="special_skydome.glslf")m_shaders.set_directive(shaders_info,"REFLECTION_PASS",1);m_shaders.set_directive(shaders_info,"SHADOW_SRC","SHADOW_SRC_NONE");m_shaders.set_directive(shaders_info,"TEXTURE_NORM",0);m_batch.update_shader(batch);var rb={do_render:true,obj_render:obj_render,batch:batch};validate_batch(batch);subs.bundles.push(rb);if(cfg_def.smaa&&!m_cfg.context.alpha)m_shaders.set_directive(shaders_info,"SMAA_JITTER",1);else m_shaders.set_directive(shaders_info,
"SMAA_JITTER",0);if(batch.type=="MAIN"){if(!batch_src.childs)batch_src.childs=[];batch_src.childs.push(batch)}}}}exports.schedule_shadow_update=schedule_shadow_update;function schedule_shadow_update(bpy_scene){bpy_scene._render.need_shadow_update=true}function update_shadow_subscenes(bpy_scene){var subs_main=get_subs(bpy_scene,"MAIN_OPAQUE");var graph=bpy_scene._render.graph;m_graph.traverse(graph,function(node,attr){var subs=attr;if(subs.type==="SHADOW_CAST")update_subs_shadow(subs,subs_main,subs.bundles,
bpy_scene)})}function update_subs_shadow(subs,subs_main,cast_bundles,bpy_scene){if(cast_bundles.length==0)return;var cam=subs.camera;var cam_main=subs_main.camera;var lamps=get_appended_objs(bpy_scene,"LAMP");var lamp=find_first_lamp_with_shadows(lamps)||lamps[0];var lamp_render=lamp._render;m_cam.set_view_trans_quat(cam,lamp_render.trans,lamp_render.quat);m_vec3.copy(cam_main.eye,cam.eye);var near=cam_main.near;var far=csm_far_plane(bpy_scene,cam_main,subs.csm_index);var bb_view_slice=_bb_tmp;shadow_volume_from_camera(cam_main,
cam,near,far,bb_view_slice);var bb_view=_bb_tmp2;m_bounds.zero_bounding_box(bb_view);shadow_volume_intersect(cast_bundles,cam.view_matrix,bb_view_slice,bb_view);var max_z=bb_view.max_z;m_bounds.shrink_bounding_box(bb_view,bb_view_slice,bb_view);bb_view.max_z=max_z;var MAX_BOUNDING_FAC=2;var size_x=bb_view.max_x-bb_view.min_x;var size_y=bb_view.max_y-bb_view.min_y;var scale_x=size_x/(MAX_BOUNDING_FAC*far);var scale_y=size_y/(MAX_BOUNDING_FAC*far);var QUANTIZER=64;scale_x=QUANTIZER/Math.ceil(QUANTIZER/
scale_x);scale_y=QUANTIZER/Math.ceil(QUANTIZER/scale_y);var size_x_new=scale_x*MAX_BOUNDING_FAC*far;var size_y_new=scale_y*MAX_BOUNDING_FAC*far;bb_view.min_x=bb_view.min_x-0.5*(size_x_new-size_x);bb_view.max_x=bb_view.max_x+0.5*(size_x_new-size_x);bb_view.min_y=bb_view.min_y-0.5*(size_y_new-size_y);bb_view.max_y=bb_view.max_y+0.5*(size_y_new-size_y);var met_pix_x=(bb_view.max_x-bb_view.min_x)/cfg_scs.shadow_tex_size;var met_pix_y=(bb_view.max_y-bb_view.min_y)/cfg_scs.shadow_tex_size;bb_view.min_x=
Math.floor(bb_view.min_x/met_pix_x)*met_pix_x;bb_view.max_x=Math.floor(bb_view.max_x/met_pix_x)*met_pix_x;bb_view.min_y=Math.floor(bb_view.min_y/met_pix_y)*met_pix_y;bb_view.max_y=Math.floor(bb_view.max_y/met_pix_y)*met_pix_y;m_cam.set_frustum_asymmetric(cam,bb_view.min_x,bb_view.max_x,bb_view.min_y,bb_view.max_y,-bb_view.max_z,-bb_view.min_z);m_cam.set_projection(cam);m_util.extract_frustum_planes(cam.view_proj_matrix,cam.frustum_planes)}function find_first_lamp_with_shadows(lamps){for(var i=0;i<
lamps.length;i++){var lamp=lamps[i];if(lamp["data"]["b4w_generate_shadows"])return lamp}return false}function csm_far_plane(scene,cam,csm_index){var shs=scene._render.shadow_params;var n=shs.csm_near;var f=shs.csm_far;var N=shs.csm_num;var lambda=shs.csm_lambda;var far=get_csm_border(csm_index+1,n,f,N,lambda);if(far>cam.far)return cam.far;else return far}exports.get_csm_borders=get_csm_borders;function get_csm_borders(scene){var shs=scene._render.shadow_params;var n=shs.csm_near;var f=shs.csm_far;
var N=shs.csm_num;var lambda=shs.csm_lambda;var rslt=new Array;for(var i=1;i<=N;i++){var b=get_csm_border(i,n,f,N,lambda);if(b===Math.round(b))b+=1E-4;rslt.push(b)}return rslt}function get_csm_border(index,near,far,num,lambda){return lambda*near*Math.pow(far/near,index/num)+(1-lambda)*(near+index/num*(far-near))}function shadow_volume_from_camera(cam_from,cam_to,near,far,dest){var corners=_frustum_corners_tmp;m_cam.extract_frustum_corners(cam_from,near,far,corners);m_util.positions_multiply_matrix(corners,
cam_to.view_matrix,corners,0);m_bounds.bb_from_coords(corners,dest)}function shadow_volume_intersect(cast_bundles,view_matrix,bb_int_view,dest){var dest_init_flag=false;for(var i=0;i<cast_bundles.length;i++){var render=cast_bundles[i].obj_render;var bb_obj=render.bb_world;var bb_obj_view=m_bounds.bounding_box_transform(bb_obj,view_matrix,_bb_tmp3);if(!m_bounds.check_bb_intersection(bb_obj_view,bb_int_view))continue;if(dest_init_flag)m_bounds.expand_bounding_box(dest,bb_obj_view);else{m_bounds.copy_bb(bb_obj_view,
dest);dest_init_flag=true}}}function add_object_subs_color_picking(subs,obj){var obj_render=obj._render;var batches=obj._batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="COLOR_ID"||has_batch(subs,batch))continue;m_batch.set_batch_directive(batch,"USE_GLOW",0);m_batch.update_shader(batch);var rb={do_render:true,obj_render:obj_render,batch:batch};validate_batch(batch);subs.bundles.push(rb)}}function add_object_subs_wireframe(subs,obj,graph){var obj_render=obj._render;var batches=
obj._batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="WIREFRAME"||has_batch(subs,batch))continue;if(batch.dynamic_grass){var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");if(subs_grass_map)prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render)}m_batch.update_shader(batch);var rb={do_render:true,obj_render:obj_render,batch:batch};validate_batch(batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}}function add_object_subs_grass_map(subs,
obj){var obj_render=obj._render;var batches=obj._batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="GRASS_MAP"||has_batch(subs,batch))continue;m_batch.update_shader(batch);var rb={do_render:true,obj_render:obj_render,batch:batch};validate_batch(batch);subs.bundles.push(rb);var cam=subs.camera;var bb=obj_render.bb_world;var low=subs.grass_map_dim[0];var high=subs.grass_map_dim[1];var size=subs.grass_map_dim[2];if(low==0&&high==0){low=bb.min_y;high=bb.max_y}else{low=Math.min(low,
bb.min_y);high=Math.max(high,bb.max_y)}var map_margin=(high-low)*GRASS_MAP_MARGIN;subs.grass_map_dim[0]=low-map_margin;subs.grass_map_dim[1]=high+map_margin;m_cam.set_frustum(cam,size/2,-high,-low,size/2);m_cam.set_projection(cam)}}function add_object_subs_glow_mask(subs,obj){var obj_render=obj._render;var batches=obj._batches;for(var i=0;i<batches.length;i++){var batch_src=batches[i];if(batch_src.type!="COLOR_ID"||has_batch(subs,batch_src))continue;var batch=batch_copy_wo_bufs(batch_src);batch.glow_intensity=
0;m_batch.set_batch_directive(batch,"USE_GLOW",1);m_batch.update_shader(batch);batches.push(batch);var rb={do_render:true,obj_render:obj_render,batch:batch};validate_batch(batch);subs.bundles.push(rb);if(!batch_src.childs)batch_src.childs=[];batch_src.childs.push(batch)}}function batch_copy_w_bufs(batch){return m_util.clone_object_r(batch)}function batch_copy_wo_bufs(batch){var batch_copy=m_util.clone_object_nr(batch);batch.shaders_info=JSON.parse(JSON.stringify(batch.shaders_info));return batch_copy}
exports.hide_object=function(scene,obj){obj._render.hide=true};exports.show_object=function(scene,obj){obj._render.hide=false};exports.remove_object=function(scene,obj){var render=obj._render;if(render.type!="DYNAMIC")return false;var subscenes=subs_array(scene,OBJECT_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var bundles=subscenes[i].bundles;for(var j=0;j<bundles.length;j++){var bundle=bundles[j];if(bundle.obj_render==render){bundles.splice(j,1);j--}}}var ind=scene._appended_objects["MESH"].indexOf(obj);
if(ind!=-1)scene._appended_objects["MESH"].splice(ind,1);var ind=scene._appended_objects["ALL"].indexOf(obj);if(ind!=-1)scene._appended_objects["ALL"].splice(ind,1)};exports.check_object=function(obj,scene){if(scene._appended_objects[obj["type"]]&&scene._appended_objects[obj["type"]].indexOf(obj)>-1)return true;else return false};function add_bundle(subscene,render,batch){var rb={do_render:true,obj_render:render,batch:batch};subscene.bundles.push(rb)}function remove_bundle(subscene,render){var bundles=
subscene.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];if(bundle.obj_render==render){bundles.splice(i,1);i--}}}exports.update_lamp_scene=update_lamp_scene;function update_lamp_scene(lamp,scene){var subs_arr=subs_array(scene,LIGHT_SUBSCENE_TYPES);var light=lamp._light;var lamp_render=lamp._render;var ind=light.index;for(var i=0;i<subs_arr.length;i++){var subs=subs_arr[i];subs.light_positions.set(lamp_render.trans,ind*3);subs.light_directions.set(light.direction,ind*3);subs.light_color_intensities.set(light.color_intensity,
ind*3);var light_factor1=_vec4_tmp;light_factor1[0]=1;light_factor1[1]=0;light_factor1[2]=0;light_factor1[3]=0;var light_factor2=_vec4_tmp2;light_factor2[0]=-1;light_factor2[1]=-1;light_factor2[2]=-1;light_factor2[3]=0;switch(light.type){case "SUN":subs.sun_quaternion.set(lamp_render.quat,0);subs.sun_intensity=light.color_intensity;if(subs.type==="SKY"){var auxilary_vec=_vec3_tmp;auxilary_vec[0]=auxilary_vec[1]=auxilary_vec[2]=1;var prev_angle=Math.acos(m_vec3.dot(subs.sun_direction,auxilary_vec));
var new_angle=Math.acos(m_vec3.dot(light.direction,auxilary_vec));var floor_prev=Math.floor(prev_angle/0.025);var floor_new=Math.floor(new_angle/0.025);if(floor_prev!=floor_new)subs.need_fog_update=true;else subs.need_fog_update=false;m_vec3.copy(light.direction,subs.sun_direction);update_sky(scene,subs)}else m_vec3.copy(light.direction,subs.sun_direction);break;case "HEMI":light_factor1[0]=0.5;light_factor1[1]=0.5;break;case "POINT":light_factor2[2]=light.distance;break;case "SPOT":light_factor2[2]=
light.distance;var sp_size=light_factor2[0]=Math.cos(light.spot_size/2);light_factor2[1]=light.spot_blend*(1-sp_size);break;default:m_print.error("B4W Warning: unknown light type: "+light.type);break}subs.light_factors1.set(light_factor1,ind*4);subs.light_factors2.set(light_factor2,ind*4);subs.need_perm_uniforms_update=true}}function update_sky(scene,subs){m_render.draw(subs);if(subs.need_fog_update){var main_subs=subs_array(scene,["MAIN_OPAQUE","MAIN_BLEND"]);for(var i=0;i<main_subs.length;i++){var m_subs=
main_subs[i];var bundles=m_subs.bundles;for(var j=0;j<bundles.length;j++){var bundle=bundles[j];if(bundle.do_render){var batch=bundle.batch;if(m_batch.check_batch_perm_uniform(batch,"u_cube_fog"))m_render.update_batch_permanent_uniform(batch,"u_cube_fog")}}}}}exports.cleanup=function(){for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var graph=scene._render.graph;m_graph.traverse(graph,function(node,attr){if(!(attr.type=="SINK"))clear_subscene(attr)});scene._render.graph=[];scene._render.queue=
[]}_active_scene=null;_scenes.length=0;_glow_anim_objs.length=0;_tex_glow_input=null};function clear_subscene(subs){var cam=subs.camera;m_render.render_target_cleanup(cam.framebuffer,cam.color_attachment,cam.depth_attachment,cam.width,cam.height);var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;if(batch)m_batch.clear_batch(batch)}}exports.make_frustum_shot=function(cam,subscene,color){var corners=m_cam.extract_frustum_corners(cam,cam.near,cam.far,null);var submesh=
m_primitives.generate_frustum(corners);var render=m_util.create_render("DYNAMIC");render.bb_world=render.bb_local=m_bounds.big_bounding_box();render.bs_world=render.bs_local=m_bounds.big_bounding_sphere();var batch=m_batch.create_shadeless_batch(submesh,color,0.5);add_bundle(subscene,render,batch)};exports.get_scene_objs=get_scene_objs;function get_scene_objs(scene,type){if(!scene._objects)throw"Access to uninitialized scene";if(!type)type="ALL";return scene._objects[type]}exports.get_appended_objs=
get_appended_objs;function get_appended_objs(scene,type){if(!type)type="ALL";return scene._appended_objects[type]}function get_scene_materials(scene){var mats=[];var objs=get_scene_objs(scene,"MESH");for(var i=0;i<objs.length;i++){var obj=objs[i];var mesh=obj["data"];for(var j=0;j<mesh["materials"].length;j++){var mat=mesh["materials"][j];if(mats.indexOf(mat)==-1)mats.push(mat)}}return mats}exports.get_scene_timeline=function(scene){var start=scene["frame_start"];var end=scene["frame_end"];return[start,
end]};exports.setup_dim=function(width,height){_canvas_width=width;_canvas_height=height;if(_active_scene)setup_scene_dim(_active_scene,width,height,false)};function setup_scene_dim(scene,width,height,override_update_dim){var upd_cameras=scene["camera"]._render.cameras;for(var i=0;i<upd_cameras.length;i++){var cam=upd_cameras[i];m_cam.set_projection(cam,width/height)}m_cam.update_camera_transform(scene["camera"]);var graph=scene._render.graph;m_scgraph.traverse_slinks(graph,function(slink,internal,
subs1,subs2){if(!override_update_dim&&!slink.update_dim)return;var tex_width=slink.size_mult*width;var tex_height=slink.size_mult*height;if(internal)for(var i=0;i<subs1.slinks_internal.length;i++){var slink_i=subs1.slinks_internal[i];if(slink_i==slink){var tex=subs1.textures_internal[i];m_tex.resize(slink.texture,tex_width,tex_height)}}else{if(m_tex.is_texture(slink.texture))m_tex.resize(slink.texture,tex_width,tex_height);var cam=subs1.camera;cam.width=tex_width;cam.height=tex_height;if(subs1.type==
"DOF")set_dof_params(scene,{"dof_power":subs1.camera.dof_power,"dof_on":subs1.camera.dof_on});set_texel_size(subs1,1/width,1/height)}})}exports.set_texel_size=set_texel_size;function set_texel_size(subs,size_x,size_y){var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;if(batch&&batch.texel_size)m_batch.set_texel_size(batch,size_x,size_y)}}exports.subs_array=subs_array;function subs_array(scene,types){var subscenes=[];var scene_subscenes=scene._render.graph;for(var i=
0;i<types.length;i++){var type=types[i];m_graph.traverse(scene._render.graph,function(node,attr){var subs=attr;if(subs.type==type)subscenes.push(subs)})}return subscenes}exports.get_subs=get_subs;function get_subs(scene,type){var graph=scene._render.graph;return m_scgraph.find_subs(graph,type)}exports.get_environment_colors=function(scene){var subs=subs_array(scene,LIGHT_SUBSCENE_TYPES)[0];var hor=subs.horizon_color;var zen=subs.zenith_color;var hor_dest=[];var zen_dest=[];hor_dest[0]=hor[0];hor_dest[1]=
hor[1];hor_dest[2]=hor[2];zen_dest[0]=zen[0];zen_dest[1]=zen[1];zen_dest[2]=zen[2];return[subs.environment_energy,hor_dest,zen_dest]};exports.set_environment_colors=set_environment_colors;function set_environment_colors(scene,opt_environment_energy,opt_horizon_color,opt_zenith_color){var subscenes=subs_array(scene,LIGHT_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(!isNaN(opt_environment_energy))subs.environment_energy=opt_environment_energy;if(opt_horizon_color){subs.horizon_color[0]=
opt_horizon_color[0];subs.horizon_color[1]=opt_horizon_color[1];subs.horizon_color[2]=opt_horizon_color[2]}if(opt_zenith_color){subs.zenith_color[0]=opt_zenith_color[0];subs.zenith_color[1]=opt_zenith_color[1];subs.zenith_color[2]=opt_zenith_color[2]}subs.need_perm_uniforms_update=true}}exports.get_sky_params=function(scene){var subs=get_subs(scene,"SKY");if(subs){var sky_params={};sky_params["color"]=subs.sky_color;sky_params["rayleigh_brightness"]=subs.rayleigh_brightness;sky_params["mie_brightness"]=
subs.mie_brightness;sky_params["spot_brightness"]=subs.spot_brightness;sky_params["scatter_strength"]=subs.scatter_strength;sky_params["rayleigh_strength"]=subs.rayleigh_strength;sky_params["mie_strength"]=subs.mie_strength;sky_params["rayleigh_collection_power"]=subs.rayleigh_collection_power;sky_params["mie_collection_power"]=subs.mie_collection_power;sky_params["mie_distribution"]=subs.mie_distribution;return sky_params}else return null};exports.set_sky_params=function(scene,sky_params){var sky_subscenes=
subs_array(scene,["SKY"]);for(var i=0;i<sky_subscenes.length;i++){var subs=sky_subscenes[i];if("color"in sky_params)subs.sky_color=sky_params["color"];if("rayleigh_brightness"in sky_params)subs.rayleigh_brightness=sky_params["rayleigh_brightness"];if("mie_brightness"in sky_params)subs.mie_brightness=sky_params["mie_brightness"];if("spot_brightness"in sky_params)subs.spot_brightness=sky_params["spot_brightness"];if("scatter_strength"in sky_params)subs.scatter_strength=sky_params["scatter_strength"];
if("rayleigh_strength"in sky_params)subs.rayleigh_strength=sky_params["rayleigh_strength"];if("mie_strength"in sky_params)subs.mie_strength=sky_params["mie_strength"];if("rayleigh_collection_power"in sky_params)subs.rayleigh_collection_power=sky_params["rayleigh_collection_power"];if("mie_collection_power"in sky_params)subs.mie_collection_power=sky_params["mie_collection_power"];if("mie_distribution"in sky_params)subs.mie_distribution=sky_params["mie_distribution"];subs.need_perm_uniforms_update=
true;subs.need_fog_update=true;update_sky(get_active(),subs);m_render.draw(subs)}};exports.get_fog_color_density=function(scene,opt_dest){var dest=opt_dest||[];var subs=subs_array(scene,FOG_SUBSCENE_TYPES)[0];var fcd=subs.fog_color_density;dest[0]=fcd[0];dest[1]=fcd[1];dest[2]=fcd[2];dest[3]=fcd[3];return dest};exports.set_fog_color_density=function(scene,val){var subscenes=subs_array(scene,FOG_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];var fcd=subs.fog_color_density;
fcd[0]=val[0];fcd[1]=val[1];fcd[2]=val[2];fcd[3]=val[3];subs.need_perm_uniforms_update=true}};exports.get_ssao_params=function(scene){var subs=get_subs(scene,"SSAO");if(!subs)return null;var batch=subs.bundles[0].batch;var ssao_params={};ssao_params["ssao_quality"]=m_batch.get_batch_directive(batch,"SSAO_QUALITY")[1];ssao_params["radius_increase"]=subs.ssao_radius_increase;ssao_params["dithering_amount"]=subs.ssao_dithering_amount;ssao_params["gauss_center"]=subs.ssao_gauss_center;ssao_params["gauss_width_square"]=
subs.ssao_gauss_width_square;ssao_params["gauss_width_left_square"]=subs.ssao_gauss_width_left_square;ssao_params["influence"]=subs.ssao_influence;ssao_params["dist_factor"]=subs.ssao_dist_factor;ssao_params["ssao_only"]=subs.ssao_only;ssao_params["ssao_white"]=m_batch.get_batch_directive(batch,"SSAO_WHITE")[1];return ssao_params};exports.set_ssao_params=function(scene,ssao_params){var subs=get_subs(scene,"SSAO");if(!subs){m_print.error("SSAO is not enabled on scene");return 0}if("ssao_quality"in
ssao_params){var batch=subs.bundles[0].batch;m_batch.set_batch_directive(batch,"SSAO_QUALITY",ssao_params["ssao_quality"]);m_batch.update_shader(batch,true)}if("ssao_radius_increase"in ssao_params)subs.ssao_radius_increase=ssao_params["ssao_radius_increase"];if("ssao_dithering_amount"in ssao_params)subs.ssao_dithering_amount=ssao_params["ssao_dithering_amount"];if("ssao_gauss_center"in ssao_params)subs.ssao_gauss_center=ssao_params["ssao_gauss_center"];if("ssao_gauss_width_square"in ssao_params)subs.ssao_gauss_width_square=
ssao_params["ssao_gauss_width_square"];if("ssao_gauss_width_left_square"in ssao_params)subs.ssao_gauss_width_left_square=ssao_params["ssao_gauss_width_left_square"];if("ssao_influence"in ssao_params)subs.ssao_influence=ssao_params["ssao_influence"];if("ssao_dist_factor"in ssao_params)subs.ssao_dist_factor=ssao_params["ssao_dist_factor"];if("ssao_only"in ssao_params){var subs=get_subs(scene,"MAIN_OPAQUE");subs.ssao_only=ssao_params["ssao_only"];for(var i=0;i<subs.bundles.length;i++){var batch=subs.bundles[i].batch;
m_batch.set_batch_directive(batch,"SSAO_ONLY",ssao_params["ssao_only"]);m_batch.update_shader(batch,true)}}if("ssao_white"in ssao_params){var batch=subs.bundles[0].batch;m_batch.set_batch_directive(batch,"SSAO_WHITE",ssao_params["ssao_white"]);m_batch.update_shader(batch,true)}subs.need_perm_uniforms_update=true};exports.get_dof_params=function(scene){var subs=get_subs(scene,"DOF");if(!subs)return null;var dof_params={};dof_params["dof_distance"]=subs.camera.dof_distance;dof_params["dof_front"]=subs.camera.dof_front;
dof_params["dof_rear"]=subs.camera.dof_rear;dof_params["dof_power"]=subs.camera.dof_power;return dof_params};exports.set_dof_params=set_dof_params;function set_dof_params(scene,dof_params){var subs=get_subs(scene,"DOF");if(!subs){m_print.error("DOF is not enabled on scene. Check camera settings");return 0}var graph=scene._render.graph;if("dof_on"in dof_params)subs.camera.dof_on=parseFloat(dof_params["dof_on"]);if("dof_distance"in dof_params)subs.camera.dof_distance=dof_params["dof_distance"];if("dof_front"in
dof_params)subs.camera.dof_front=dof_params["dof_front"];if("dof_rear"in dof_params)subs.camera.dof_rear=dof_params["dof_rear"];if("dof_power"in dof_params){subs.camera.dof_power=dof_params["dof_power"];var subs_pp1=m_scgraph.find_input(graph,subs,"POSTPROCESSING");var subs_pp2=m_scgraph.find_input(graph,subs_pp1,"POSTPROCESSING");var subs_in=[subs_pp1,subs_pp2];for(var i=0;i<subs_in.length;i++){var bundles=subs_in[i].bundles;var batch=bundles[0].batch;if(batch&&batch.texel_size){m_batch.set_texel_size_mult(batch,
subs.camera.dof_power);set_texel_size(subs_in[i],1/subs.camera.width,1/subs.camera.height)}}}subs.need_perm_uniforms_update=true}exports.get_god_rays_params=function(scene){var gr_subs=subs_array(scene,["GOD_RAYS"]);var combo_subs=get_subs(scene,"GOD_RAYS_COMBINE");if(!gr_subs||!combo_subs)return null;var god_rays_params={};god_rays_params["god_rays_max_ray_length"]=gr_subs[0].max_ray_length;god_rays_params["god_rays_intensity"]=combo_subs.god_rays_intensity;var batch=gr_subs[0].bundles[0].batch;
god_rays_params["god_rays_steps"]=m_batch.get_batch_directive(batch,"STEPS_PER_PASS")[1];return god_rays_params};exports.set_god_rays_params=function(scene,god_rays_params){var gr_subs=subs_array(scene,["GOD_RAYS"]);var combo_subs=get_subs(scene,"GOD_RAYS_COMBINE");if(!gr_subs||!combo_subs){m_print.error("God Rays are not enabled on scene");return 0}if("god_rays_intensity"in god_rays_params)combo_subs.god_rays_intensity=god_rays_params["god_rays_intensity"];if("god_rays_max_ray_length"in god_rays_params){var r_length=
god_rays_params["god_rays_max_ray_length"];for(var i=0;i<gr_subs.length;i++){gr_subs[i].max_ray_length=r_length;gr_subs[i].radial_blur_step=r_length/gr_subs[i].steps_per_pass/(i+1);gr_subs[i].need_perm_uniforms_update=true}}if("god_rays_steps"in god_rays_params){var steps=m_shaders.glsl_value(god_rays_params["god_rays_steps"],1);var r_length=gr_subs[0].max_ray_length;for(var i=0;i<gr_subs.length;i++){gr_subs[i].steps_per_pass=steps;gr_subs[i].radial_blur_step=r_length/steps/(i+1);gr_subs[i].need_perm_uniforms_update=
true;var batch=gr_subs[i].bundles[0].batch;m_batch.set_batch_directive(batch,"STEPS_PER_PASS",steps);m_batch.update_shader(batch,true)}}combo_subs.need_perm_uniforms_update=true};exports.get_bloom_params=function(scene){var lum_subs=get_subs(scene,["LUMINANCE_TRUNCED"]);var bloom_subs=get_subs(scene,"BLOOM");if(!lum_subs||!bloom_subs)return null;var bloom_params={};bloom_params["bloom_key"]=lum_subs.bloom_key;bloom_params["bloom_edge_lum"]=lum_subs.bloom_edge_lum;bloom_params["bloom_blur"]=bloom_subs.bloom_blur;
return bloom_params};exports.set_bloom_params=function(scene,bloom_params){var lum_subs=get_subs(scene,"LUMINANCE_TRUNCED");var bloom_subs=get_subs(scene,"BLOOM");if(!lum_subs||!bloom_subs){m_print.error("Bloom is not enabled on scene");return 0}if("bloom_key"in bloom_params){lum_subs.bloom_key=bloom_params["bloom_key"];lum_subs.need_perm_uniforms_update=true}if("bloom_edge_lum"in bloom_params){lum_subs.bloom_edge_lum=bloom_params["bloom_edge_lum"];lum_subs.need_perm_uniforms_update=true}if("bloom_blur"in
bloom_params){var graph=scene._render.graph;var subs_blur1=m_scgraph.find_input(graph,bloom_subs,"BLOOM_BLUR");var subs_blur2=m_scgraph.find_input(graph,subs_blur1,"BLOOM_BLUR");var subs_in=[subs_blur1,subs_blur2];for(var i=0;i<subs_in.length;i++){var bundles=subs_in[i].bundles;var batch=bundles[0].batch;if(batch&&batch.texel_size){m_batch.set_texel_size_mult(batch,bloom_params["bloom_blur"]);set_texel_size(subs_in[i],1/bloom_subs.camera.width,1/bloom_subs.camera.height)}}}};exports.get_wind_params=
function(){var wind=m_particles.wind();var length=m_vec3.length(wind);if(length==0)return null;var angle=Math.atan(wind[0]/wind[2])*180/Math.PI;var wind_params={};wind_params["wind_dir"]=angle;wind_params["wind_strength"]=length;return wind_params};exports.set_wind_params=function(scene,wind_params){var objs=get_scene_objs(scene);for(var i=0;i<objs.length;i++){var obj=objs[i];if(obj.type==="EMPTY"&&(obj["field"]&&obj["field"]["type"]==="WIND"))var wind_obj=obj}if(!wind_obj){m_print.error("There is no wind on the scene");
return 0}var wind_render=wind_obj._render;if("wind_dir"in wind_params){var angle=wind_params["wind_dir"]/180*Math.PI;_vec3_tmp=[0,angle,-Math.PI/2];m_util.euler_to_quat(_vec3_tmp,_quat4_tmp);wind_render.quat[0]=_quat4_tmp[0];wind_render.quat[1]=_quat4_tmp[1];wind_render.quat[2]=_quat4_tmp[2];wind_render.quat[3]=_quat4_tmp[3];m_particles.update_force(wind_obj)}if("wind_strength"in wind_params){wind_render.force_strength=wind_params["wind_strength"];m_particles.update_force(wind_obj)}update_scene_permanent_uniforms(scene)};
exports.schedule_grass_map_update=schedule_grass_map_update;function schedule_grass_map_update(bpy_scene){bpy_scene._render.need_grass_map_update=true}exports.get_water_surface_level=function(pos_x,pos_z){var subs=get_subs(_active_scene,"MAIN_OPAQUE");if(!subs||!subs.water_params){m_print.error("get_water_surface_level() - no water parameters on this scene");return 0}var waves_height=subs.water_waves_height;var waves_length=subs.water_waves_length;var water_level=subs.water_level;var wp=subs.water_params;
if(!waves_height||!wp.dynamic)return wp.water_level;var wind_str=m_vec3.length(subs.wind);var time=subs.time;if(!time)time=0;if(wind_str)time*=wind_str;var cellular_coords=_vec2_tmp;cellular_coords[0]=20/waves_length*(pos_x-0.25*time);cellular_coords[1]=20/waves_length*(pos_z-0.25*time);var cellular1=m_util.cellular2x2(cellular_coords);cellular_coords[0]=17/waves_length*(pos_z+0.1*time);cellular_coords[1]=17/waves_length*(pos_x+0.1*time);var cellular2=m_util.cellular2x2(cellular_coords);var small_waves=
cellular1+cellular2-1;var dst_noise_scale0=wp.dst_noise_scale0;var dst_noise_scale1=wp.dst_noise_scale1;var dst_noise_freq0=wp.dst_noise_freq0;var dst_noise_freq1=wp.dst_noise_freq1;var noise_coords=_vec2_tmp;noise_coords[0]=dst_noise_scale0*(pos_x+dst_noise_freq0*time);noise_coords[1]=dst_noise_scale0*(pos_z+dst_noise_freq0*time);var noise1=m_util.snoise(noise_coords);noise_coords[0]=dst_noise_scale1*(pos_z-dst_noise_freq1*time);noise_coords[1]=dst_noise_scale1*(pos_x-dst_noise_freq1*time);var noise2=
m_util.snoise(noise_coords);var dist_waves=waves_height*noise1*noise2;if(subs.shoremap_image){var size_x=subs.shoremap_size[0];var size_z=subs.shoremap_size[1];var center_x=subs.shoremap_center[0];var center_z=subs.shoremap_center[1];var x=(pos_x-center_x)/size_x;var z=(center_z+pos_z)/size_z;x+=0.5;z+=0.5;if(x>1||(x<0||(z>1||z<0)))var wave_height=dist_waves;else{var width=subs.shoremap_tex_size;var array=_active_scene._render.shore_distances;var shore_dist=m_util.get_array_smooth_value(array,width,
x,z);var dir_min_shore_fac=wp.dir_min_shore_fac;var dir_freq=wp.dir_freq;var dir_noise_scale=wp.dir_noise_scale;var dir_noise_freq=wp.dir_noise_freq;var dir_min_noise_fac=wp.dir_min_noise_fac;var dst_min_fac=wp.dst_min_fac;var waves_hor_fac=wp.waves_hor_fac;var max_shore_dist=subs.max_shore_dist;var shore_waves_length=waves_length/max_shore_dist/Math.PI;var waves_coords=[dir_noise_scale/waves_length*(pos_x+dir_noise_freq*time),dir_noise_scale/waves_length*(pos_z+dir_noise_freq*time)];var dist_fact=
Math.sqrt(shore_dist);var shore_dir_waves=waves_height*Math.max(shore_dist,dir_min_shore_fac)*Math.sin(dist_fact/shore_waves_length+dir_freq*time)*Math.max(m_util.snoise(waves_coords),dir_min_noise_fac);var mix_rate=Math.max(dist_fact,dst_min_fac);var wave_height=shore_dir_waves*(1-mix_rate)+dist_waves*mix_rate;small_waves*=shore_dist}}else var wave_height=dist_waves;wave_height+=0.05*small_waves;var cur_water_level=water_level+wave_height;return cur_water_level};exports.get_water_mat_params=function(scene,
water_params){var subs=get_subs(scene,"MAIN_OPAQUE");if(!subs)return;water_params["waves_height"]=subs.water_waves_height;water_params["waves_length"]=subs.water_waves_length;if(subs.water_fog_color_density){water_params["water_fog_density"]=subs.water_fog_color_density[3];var wfc=water_params["water_fog_color"]=[];wfc[0]=subs.water_fog_color_density[0];wfc[1]=subs.water_fog_color_density[1];wfc[2]=subs.water_fog_color_density[2]}};exports.set_water_params=function(scene,water_params){var subs=get_subs(scene,
"MAIN_OPAQUE");if(!subs||!subs.water_params){m_print.error("set_water_params() - no water parameters on this scene");return null}var wp=subs.water_params;if("dst_noise_scale0"in water_params)wp.dst_noise_scale0=water_params["dst_noise_scale0"];if("dst_noise_scale1"in water_params)wp.dst_noise_scale1=water_params["dst_noise_scale1"];if("dst_noise_freq0"in water_params)wp.dst_noise_freq0=water_params["dst_noise_freq0"];if("dst_noise_freq1"in water_params)wp.dst_noise_freq1=water_params["dst_noise_freq1"];
if("dir_min_shore_fac"in water_params)wp.dir_min_shore_fac=water_params["dir_min_shore_fac"];if("dir_freq"in water_params)wp.dir_freq=water_params["dir_freq"];if("dir_noise_scale"in water_params)wp.dir_noise_scale=water_params["dir_noise_scale"];if("dir_noise_freq"in water_params)wp.dir_noise_freq=water_params["dir_noise_freq"];if("dir_min_noise_fac"in water_params)wp.dir_min_noise_fac=water_params["dir_min_noise_fac"];if("dst_min_fac"in water_params)wp.dst_min_fac=water_params["dst_min_fac"];if("waves_hor_fac"in
water_params)wp.waves_hor_fac=water_params["waves_hor_fac"];if("water_dynamic"in water_params)wp.dynamic=water_params["water_dynamic"];var subscenes=subs_array(scene,MAIN_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var sub=subscenes[i];if("water_fog_density"in water_params&&wp.fog_color_density)sub.water_fog_color_density[3]=water_params["water_fog_density"];if("water_fog_color"in water_params&&wp.fog_color_density){sub.water_fog_color_density[0]=water_params["water_fog_color"][0];sub.water_fog_color_density[1]=
water_params["water_fog_color"][1];sub.water_fog_color_density[2]=water_params["water_fog_color"][2]}if("waves_height"in water_params)sub.water_waves_height=water_params["waves_height"];if("waves_length"in water_params)sub.water_waves_length=water_params["waves_length"];sub.need_perm_uniforms_update=true}};exports.get_shore_dist=function(trans,v_dist_mult){var subs=get_subs(_active_scene,"MAIN_OPAQUE");if(!subs.shoremap_image)return SHORE_DIST_COMPAT;var size_x=subs.shoremap_size[0];var size_z=subs.shoremap_size[1];
var center_x=subs.shoremap_center[0];var center_z=subs.shoremap_center[1];var max_shore_dist=subs.max_shore_dist;var water_level=subs.water_level;var x=(trans[0]-center_x)/size_x;var z=(center_z+trans[2])/size_z;x+=0.5;z+=0.5;if(x>1||(x<0||(z>1||z<0)))var shore_dist=1;else{var width=subs.shoremap_tex_size;var array=_active_scene._render.shore_distances;var shore_dist_xz=max_shore_dist*m_util.get_array_smooth_value(array,width,x,z);var shore_dist_y=(water_level-trans[1])*v_dist_mult;var shore_dist=
Math.sqrt(shore_dist_xz*shore_dist_xz+shore_dist_y*shore_dist_y);return shore_dist}};exports.update=function(timeline,elapsed){for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var graph=scene._render.graph;if(scene._render.water_params){var camera_render=get_active()["camera"]._render;var cam_water_depth=camera_render.trans[1]-exports.get_water_surface_level(camera_render.trans[0],camera_render.trans[2])}m_graph.traverse(graph,function(node,attr){var subs=attr;if(TIME_SUBSCENE_TYPES.indexOf(subs.type)>
-1)subs.time=timeline;if(MAIN_SUBSCENE_TYPES.indexOf(subs.type)>-1&&scene._render.water_params)subs.cam_water_depth=cam_water_depth})}if(cfg_def.deferred_rendering)for(var i=0;i<_glow_anim_objs.length;i++){var obj=_glow_anim_objs[i];update_obj_glow_intensity(obj,timeline)}for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var render=scene._render;if(render.need_shadow_update){update_shadow_subscenes(scene);render.need_shadow_update=false}if(render.need_grass_map_update){update_subs_grass_map(scene);
render.need_grass_map_update=false}if(!render.queue.length)continue;if(scene["b4w_enable_motion_blur"])update_motion_blur_subscenes(render.graph,elapsed);if(cfg_def.smaa&&!m_cfg.context.alpha)update_smaa_resolve_subscene(render.graph);if(cfg_def.deferred_rendering&&render.glow){var subs_glow_mask=get_subs(scene,"GLOW_MASK");var bundles=subs_glow_mask.bundles;var summ_intensity=0;for(var j=0;j<bundles.length;j++)summ_intensity+=bundles[j].batch.glow_intensity;m_graph.traverse(scene._render.graph,function(node,
attr){if(attr.type==="GLOW")attr.draw_glow_flag=summ_intensity})}var queue=render.queue;var glow_mask_subs_index=null;for(var i=0;i<queue.length;i++)if(queue[i].type=="GLOW_MASK"){glow_mask_subs_index=i;break}for(var j=0;j<queue.length;j++){var qsubs=queue[j];if(glow_mask_subs_index!==null)optimize_glow_postprocessing(render.graph,qsubs,queue[glow_mask_subs_index])}for(var j=0;j<queue.length;j++){var qsubs=queue[j];m_prerender.prerender_subs(qsubs);m_render.draw(qsubs)}}m_render.increment_subpixel_index();
if(cfg_def.show_hud_debug_info)m_hud.show_debug_info(_scenes,elapsed)};function optimize_glow_postprocessing(graph,qsubs,glow_mask_subs){if(glow_mask_subs.do_render!=qsubs.do_render)if(qsubs.type=="POSTPROCESSING"&&qsubs.is_for_glow)qsubs.do_render=glow_mask_subs.do_render}function slink_switch_active(graph,id1,id2,slink,active){if(slink.active==active)return;if(slink.active){replace_attachment(graph,id1,slink.from,null);replace_texture(graph,id2,slink.to,null)}else{replace_attachment(graph,id1,slink.from,
slink.texture);replace_texture(graph,id2,slink.to,slink.texture)}slink.active=active}function replace_attachment(graph,id,type,tex){var subs=m_graph.get_node_attr(graph,id);m_cam.set_attachment(subs.camera,type,tex);subs.assign_texture=true;m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.active&&(slink.from==type&&m_scgraph.check_slink_tex_conn(slink)))replace_texture(graph,id_out,slink.to,tex)});m_graph.traverse_inputs(graph,id,function(id_in,attr_in,
attr_edge){var slink=attr_edge;if(slink.active&&(slink.from==type&&slink.from==slink.to))replace_attachment(graph,id_in,type,tex)})}function replace_texture(graph,id,name,tex){var subs=m_graph.get_node_attr(graph,id);var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;m_batch.replace_texture(batch,tex,name)}}function update_subs_grass_map(bpy_scene){var subs_grass_map=get_subs(bpy_scene,"GRASS_MAP");if(subs_grass_map){var cam=subs_grass_map.camera;var camera_render=
bpy_scene["camera"]._render;var camera_trans=camera_render.trans;var trans=_vec3_tmp;trans[0]=0;trans[1]=-subs_grass_map.grass_map_dim[2]/2;trans[2]=0;m_vec3.transformQuat(trans,camera_render.quat,trans);trans[0]+=camera_trans[0];trans[1]=0;trans[2]+=camera_trans[2];var quat=_quat4_tmp;quat[0]=0;quat[1]=0;quat[2]=0;quat[3]=1;m_cam.set_view_trans_quat(cam,trans,quat)}}function update_motion_blur_subscenes(graph,elapsed){m_graph.traverse(graph,function(id,attr){var subs=attr;if(subs.type!="MOTION_BLUR")return;
if(!subs.slinks_internal[0]||!subs.textures_internal[0])throw"Wrong MOTION_BLUR subscene";var slink=subs.slinks_internal[0];var tex=subs.textures_internal[0];subs.textures_internal[0]=subs.camera.color_attachment;m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink_out=attr_edge;if(slink_out.active)replace_texture(graph,id_out,slink_out.to,tex)});replace_attachment(graph,id,slink.from,tex);replace_texture(graph,id,slink.to,subs.textures_internal[0]);subs.motion_blur_exp=
Math.exp(-elapsed/subs.mb_factor)})}function update_smaa_resolve_subscene(graph){m_graph.traverse(graph,function(id,attr){var subs=attr;if(subs.type!="SMAA_RESOLVE")return;if(!subs.slinks_internal[0]||!subs.textures_internal[0])throw"Wrong SMAA RESOLVE subscene";var slink=subs.slinks_internal[0];var tex=subs.textures_internal[0];m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){if(attr_in.type!="VELOCITY"){subs.textures_internal[0]=attr_in.camera.color_attachment;replace_attachment(graph,
id_in,attr_edge.from,tex)}});replace_texture(graph,id,"u_color",tex);replace_texture(graph,id,"u_color_prev",subs.textures_internal[0])})}function update_obj_glow_intensity(obj,timeline){var glow_intensity=0;var ga_settings=obj._glow_anim;if(ga_settings.time_start==0)ga_settings.time_start=timeline;var dt=timeline-ga_settings.time_start;if(ga_settings.relapses&&dt/ga_settings.period>=ga_settings.relapses){exports.clear_glow_anim(obj);return}var periodic_time=dt%ga_settings.period;if(periodic_time<
ga_settings.glow_time){var glow_time=periodic_time/(ga_settings.glow_time/5);var stage=Math.floor(glow_time);switch(stage){case 0:glow_intensity=(glow_time-stage)/2;break;case 1:glow_intensity=(glow_time-stage)/2+0.5;break;case 2:glow_intensity=1;break;case 3:glow_intensity=1-(glow_time-stage)/2;break;case 4:glow_intensity=0.5-(glow_time-stage)/2;break}}for(var i=0;i<obj._batches.length;i++){var batch=obj._batches[i];if(batch.type=="COLOR_ID"&&typeof batch.glow_intensity!=="undefined")batch.glow_intensity=
glow_intensity}}exports.get_all_subscenes=function(scene){var graph=scene._render.graph;var subscenes=[];m_graph.traverse(graph,function(node,attr){subscenes.push(attr)});return subscenes};exports.apply_glow_anim=function(obj,tau,T,N){obj._glow_anim={time_start:0,glow_time:tau,period:T,relapses:N};_glow_anim_objs.push(obj)};exports.clear_glow_anim=function(obj){for(var i=0;i<obj._batches.length;i++){var batch=obj._batches[i];if(batch.type=="COLOR_ID"&&typeof batch.glow_intensity!=="undefined")batch.glow_intensity=
0}var ind=_glow_anim_objs.indexOf(obj);if(ind!=-1)_glow_anim_objs.splice(ind,1)};exports.cleanup_glow_anim=function(){_glow_anim_objs=[]};exports.get_cam_water_depth=function(){var subs=get_subs(_active_scene,"MAIN_BLEND");var scene=_active_scene;if(!subs&&!scene._render.water_params)return null;return subs.cam_water_depth};exports.update_scene_permanent_uniforms=update_scene_permanent_uniforms;function update_scene_permanent_uniforms(scene){var graph=scene._render.graph;m_graph.traverse(graph,function(node,
subs){subs.need_perm_uniforms_update=true})}exports.set_wireframe_mode=function(subs_wireframe,mode){switch(mode){case "WM_NONE":subs_wireframe.do_render=false;break;case "WM_OPAQUE_WIREFRAME":case "WM_TRANSPARENT_WIREFRAME":case "WM_FRONT_BACK_VIEW":case "WM_DEBUG_SPHERES":for(var i=0;i<subs_wireframe.bundles.length;i++){var batch=subs_wireframe.bundles[i].batch;batch.wireframe_mode=m_dbg.WIREFRAME_MODES[mode]}subs_wireframe.do_render=true;break}subs_wireframe.blend=mode=="WM_TRANSPARENT_WIREFRAME";
subs_wireframe.need_perm_uniforms_update=true};exports.set_wireframe_edge_color=function(subs_wireframe,color){for(var i=0;i<subs_wireframe.bundles.length;i++){var batch=subs_wireframe.bundles[i].batch;batch.wireframe_edge_color=color;subs_wireframe.need_perm_uniforms_update=true}};exports.add_meta_objects=function(scene,meta_objects){for(var i=0;i<meta_objects.length;i++){scene._objects["ALL"].push(meta_objects[i]);scene._objects["MESH"].push(meta_objects[i])}}};b4w.module["__physics"]=function(exports,require){var m_cfg=require("__config");var m_print=require("__print");var m_dbg=require("__debug");var m_ipc=require("__ipc");var m_render=require("__renderer");var m_scs=require("__scenes");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_version=require("__version");var m_vec3=require("vec3");var m_quat=require("quat");var m_mat4=require("mat4");var cfg_phy=m_cfg.physics;var RAY_CMP_PRECISION=1E-7;var _phy_fps=
0;var _active_scene_phy=null;var _bounding_objects=[];var _unique_counter={world:0,body:0,constraint:0,shape:0};var _vec3_tmp=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _mat4_tmp=new Float32Array(16);var _tsr8_tmp=new Float32Array(8);var _tsr8_tmp2=new Float32Array(8);var VT_CHASSIS=10;var VT_HULL=20;exports.init_engine=function(){if(cfg_phy.enabled){var path=cfg_phy.uranium_path+m_version.timestamp();m_print.log("%cLOAD PHYSICS","color: #0a0",path);
var worker=new Worker(path);m_ipc.init(worker,process_message)}};exports.attach_scene_physics=function(scene){var world_id=get_unique_world_id();m_ipc.post_msg(m_ipc.OUT_APPEND_WORLD,world_id);scene._physics={};scene._physics.world_id=world_id;scene._physics.bundles=[]};function get_unique_world_id(){_unique_counter.world++;return _unique_counter.world}exports.cleanup=function(){if(!cfg_phy.enabled)return;m_ipc.post_msg(m_ipc.OUT_CLEANUP);_active_scene_phy=null;_bounding_objects.length=0;for(var cnt in _unique_counter)_unique_counter[cnt]=
0};function add_compound_children(parent,container){var children=parent._descends;for(var i=0;i<children.length;i++){if(children[i]._render.use_collision_compound)container.push(children[i]);add_compound_children(children[i],container)}return null}exports.append_object=function(obj,bpy_scene){set_active_scene(bpy_scene);var render=obj._render;if(!render)throw"No object render: "+obj["name"];if(obj["parent"]&&render.use_collision_compound)return null;var compound_children=[];if(render.use_collision_compound)add_compound_children(obj,
compound_children);var batches=obj._batches||[];for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="PHYSICS"||has_batch(bpy_scene,batch))continue;if(!batch.submesh.base_length){m_print.error("Object "+obj["name"]+" has collision material with no assigned vertices");continue}if(batch.water&&bpy_scene._render.water_params){init_water_physics(obj,batch);continue}if(batch.use_ghost)var phy=init_ghost_mesh_physics(obj,batch);else var phy=init_static_mesh_physics(obj,batch);phy.id=batch.collision_id;
var pb={batch:batch,physics:phy};bpy_scene._physics.bundles.push(pb)}if(is_vehicle_chassis(obj)||(is_vehicle_hull(obj)||(is_character(obj)||(is_floater_main(obj)||obj["b4w_collision"])))){var phy=init_bounding_physics(obj,render.physics_type,compound_children);obj._physics=phy;var pb={batch:null,physics:phy};bpy_scene._physics.bundles.push(pb)}if(is_vehicle_chassis(obj)||is_vehicle_hull(obj)){init_vehicle(obj);update_vehicle_controls(obj,obj._vehicle)}else if(is_character(obj))init_character(obj);
else if(is_floater_main(obj))init_floater(obj);else if(obj["b4w_collision"])phy.id=obj["b4w_collision_id"];for(var i=0;i<_bounding_objects.length;i++){var obj=_bounding_objects[i];if(obj._physics)process_rigid_body_joints(obj)}};function has_batch(scene,batch){var pbundles=scene._physics.bundles;for(var i=0;i<pbundles.length;i++){var pbatch=pbundles[i].batch;if(pbatch&&pbatch.id==batch.id)return true}return false}function process_message(msg_id,msg){if(!_active_scene_phy)return;switch(msg_id){case m_ipc.IN_FRAME_END:m_render.unlock();
break;case m_ipc.IN_LOG:m_print.log(msg);break;case m_ipc.IN_ERROR:m_print.error(msg);break;case m_ipc.IN_FBMSG:m_dbg.fbmsg.apply(this,msg.slice(1));break;case m_ipc.IN_TRANSFORM:var obj=find_obj_by_body_id(msg["body_id"]);if(obj)update_interpolation_data(obj,msg["time"],msg["trans"],msg["quat"],msg["linvel"],msg["angvel"]);break;case m_ipc.IN_PROP_OFFSET:var obj_chassis_hull=find_obj_by_body_id(msg["chassis_hull_body_id"]);if(obj_chassis_hull)update_prop_offset(obj_chassis_hull,msg["prop_ind"],msg["trans"],
msg["quat"]);break;case m_ipc.IN_FLOATER_BOB_TRANSFORM:var obj_floater=find_obj_by_body_id(msg[1]);if(obj_floater)update_floater_bob_coords(obj_floater,msg[2],msg[3],msg[4]);break;case m_ipc.IN_VEHICLE_SPEED:var obj=find_obj_by_body_id(msg[1]);obj._vehicle.speed=msg[2];break;case m_ipc.IN_COLLISION:traverse_collision_tests(_active_scene_phy,msg["body_id_a"],msg["body_id_b"],msg["result"],msg["coll_point"]);break;case m_ipc.IN_COLLISION_IMPULSE:var obj=find_obj_by_body_id(msg[1]);var phy=obj._physics;
if(phy.col_imp_test_cb)phy.col_imp_test_cb(msg[2]);break;case m_ipc.IN_RAY_HIT:var body_id_a=msg["body_id"];var obj=find_obj_by_body_id(body_id_a);if(obj){var phy=obj._physics;var from=msg["from"];var to=msg["to"];var local=msg["local"];var body_id_b=msg["body_id_b_hit"];var result=msg["cur_result"];for(var i=0;i<phy.ray_tests.length;i++){var test=phy.ray_tests[i];if(m_util.cmp_arr_float(test.from,from,RAY_CMP_PRECISION)&&(m_util.cmp_arr_float(test.to,to,RAY_CMP_PRECISION)&&test.local==local)){for(var id in test.results)test.results[id]=
1;if(body_id_b!=-1)test.results[body_id_b]=result;traverse_ray_test(test,_active_scene_phy)}}}break;case m_ipc.IN_PING:console.log("Physics message ping: ",performance.now()-msg[1]);break;default:m_print.error("Wrong message: "+msg_id);break}}exports.find_obj_by_body_id=find_obj_by_body_id;function find_obj_by_body_id(body_id){var body_id=parseInt(body_id);for(var i=0;i<_bounding_objects.length;i++){var dobj=_bounding_objects[i];if(dobj._physics.body_id===body_id)return dobj}return null}function update_interpolation_data(obj,
time,trans,quat,linvel,angvel){var phy=obj._physics;phy.curr_time=time;m_tsr.set_sep(trans,1,quat,phy.curr_tsr);m_vec3.copy(linvel,phy.linvel);m_vec3.copy(angvel,phy.angvel)}function update_prop_offset(obj_chassis_hull,prop_num,trans,quat){var prop_offset=obj_chassis_hull._vehicle.prop_offsets[prop_num];m_tsr.set_sep(trans,1,quat,prop_offset)}function update_floater_bob_coords(obj_floater,bob_num,trans,quat){var obj_bob=obj_floater._floater.bobs[bob_num];m_trans.set_translation(obj_bob,trans);m_trans.set_rotation(obj_bob,
quat);m_trans.update_transform(obj_bob)}function traverse_collision_tests(scene,body_id_a,body_id_b,pair_result,collision_point){var body_id_a=parseInt(body_id_a);var bundles=scene._physics.bundles;for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;for(var j=0;j<phy.collision_tests.length;j++){var test=phy.collision_tests[j];var pairs=test.pairs;var results_changed=false;for(var k=0;k<pairs.length;k++){var pair=pairs[k];if(pair[0]===body_id_a&&pair[1]===body_id_b){test.pair_results[k]=pair_result;
results_changed=true;break}}if(results_changed||test.need_collision_pt){var pair_results=test.pair_results;var result=0;for(var k=0;k<pair_results.length;k++)result=result||pair_results[k];test.callback(result,collision_point)}}}}function traverse_ray_test(ray_test,bpy_scene){var collision_id=ray_test.collision_id;var callback=ray_test.callback;var results=ray_test.results;var is_collision=false;var hit_frac=1;for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=bpy_scene._physics.bundles[i];
var bphy=bundle.physics;if((collision_id=="ANY"||bphy.id==collision_id)&&(bphy.body_id in results&&results[bphy.body_id]!==1)){is_collision=true;hit_frac=results[bphy.body_id];break}}callback(is_collision,hit_frac)}exports.update=function(timeline,delta){if(_active_scene_phy){m_ipc.post_msg(m_ipc.OUT_FRAME_START,timeline,delta);m_render.lock()}for(var i=0;i<_bounding_objects.length;i++){var obj=_bounding_objects[i];var phy=obj._physics;if(phy.simulated&&phy.curr_time){var d=timeline-phy.curr_time;
d=Math.min(d,10*1/60);var tsr=_tsr8_tmp;m_tsr.integrate(phy.curr_tsr,d,phy.linvel,phy.angvel,_tsr8_tmp);m_trans.set_translation(obj,m_tsr.get_trans_view(tsr));if(obj["type"]!="CAMERA")m_trans.set_rotation(obj,m_tsr.get_quat_view(tsr));m_trans.update_transform(obj);sync_transform(obj);if(obj._vehicle)update_prop_transforms(obj);if(obj._vehicle&&obj._vehicle.steering_wheel)update_steering_wheel_coords(obj);if(obj._vehicle&&obj._vehicle.speedometer)update_speedometer(obj);if(obj._vehicle&&obj._vehicle.tachometer)update_tachometer(obj)}}var scene=
get_active_scene();if(scene){var subs=m_scs.get_subs(scene,"MAIN_OPAQUE");if(subs.water_params&&subs.water_params.waves_height>0){var wind=m_vec3.length(subs.wind);m_ipc.post_msg(m_ipc.OUT_SET_WATER_TIME,subs.time*wind)}}};function update_prop_transforms(obj_chassis_hull){var obj_props=obj_chassis_hull._vehicle.props;var chass_hull_tsr=obj_chassis_hull._render.tsr;var prop_tsr=_tsr8_tmp;for(var i=0;i<obj_props.length;i++){var obj_prop=obj_props[i];var prop_offset=obj_chassis_hull._vehicle.prop_offsets[i];
m_tsr.multiply(chass_hull_tsr,prop_offset,prop_tsr);m_trans.set_tsr(obj_prop,prop_tsr);m_trans.update_transform(obj_prop)}}function set_active_scene(scene){_active_scene_phy=scene;m_ipc.post_msg(m_ipc.OUT_SET_ACTIVE_WORLD,scene._physics.world_id)}exports.get_active_scene=get_active_scene;function get_active_scene(){return _active_scene_phy}exports.pause=function(){if(cfg_phy.enabled)m_ipc.post_msg(m_ipc.OUT_PAUSE)};exports.resume=function(){if(cfg_phy.enabled)m_ipc.post_msg(m_ipc.OUT_RESUME)};function get_unique_body_id(){_unique_counter.body++;
return _unique_counter.body}function init_water_physics(obj,batch){m_ipc.post_msg(m_ipc.OUT_APPEND_WATER);var scene=get_active_scene();var subs=m_scs.get_subs(scene,"MAIN_OPAQUE");if(subs.water_params&&batch.water_dynamics){var water_dyn_info={};water_dyn_info["dst_noise_scale0"]=batch.dst_noise_scale0;water_dyn_info["dst_noise_scale1"]=batch.dst_noise_scale1;water_dyn_info["dst_noise_freq0"]=batch.dst_noise_freq0;water_dyn_info["dst_noise_freq1"]=batch.dst_noise_freq1;water_dyn_info["dir_min_shore_fac"]=
batch.dir_min_shore_fac;water_dyn_info["dir_freq"]=batch.dir_freq;water_dyn_info["dir_noise_scale"]=batch.dir_noise_scale;water_dyn_info["dir_noise_freq"]=batch.dir_noise_freq;water_dyn_info["dir_min_noise_fac"]=batch.dir_min_noise_fac;water_dyn_info["dst_min_fac"]=batch.dst_min_fac;water_dyn_info["waves_hor_fac"]=batch.waves_hor_fac;var waves_height=subs.water_waves_height;var waves_length=subs.water_waves_length;var water_level=subs.water_level;if(subs.shoremap_size){var size_x=subs.shoremap_size[0];
var size_y=subs.shoremap_size[1];var center_x=subs.shoremap_center[0];var center_y=subs.shoremap_center[1];var max_shore_dist=subs.max_shore_dist;var array_width=subs.shoremap_tex_size;m_ipc.post_msg(m_ipc.OUT_ADD_WATER_WRAPPER,water_dyn_info,size_x,size_y,center_x,center_y,max_shore_dist,waves_height,waves_length,water_level,array_width,scene._render.shore_distances)}else m_ipc.post_msg(m_ipc.OUT_ADD_WATER_WRAPPER,water_dyn_info,0,0,0,0,0,waves_height,waves_length,water_level,0,null)}}function init_static_mesh_physics(obj,
batch){var body_id=get_unique_body_id();var submesh=batch.submesh;var positions=submesh.va_frames[0]["a_position"];var indices=submesh.indices||null;var render=obj._render;var trans=obj._render.trans;var friction=batch.friction;var restitution=batch.elasticity;var collision_group=batch.collision_group;var collision_mask=batch.collision_mask;m_ipc.post_msg(m_ipc.OUT_APPEND_STATIC_MESH_BODY,body_id,positions,indices,trans,friction,restitution,collision_group,collision_mask);var phy=init_physics(body_id);
return phy}function init_physics(body_id){var phy={body_id:body_id,mass:0,is_ghost:false,simulated:true,is_vehicle:false,is_character:false,is_floater:false,cons_id:null,id:"",collision_callbacks:{},collision_tests:[],col_imp_test_cb:null,ray_tests:[],curr_time:0,curr_tsr:new Float32Array([0,0,0,1,0,0,0,1]),linvel:new Float32Array(3),angvel:new Float32Array(3),cached_trans:new Float32Array(3)};return phy}function init_ghost_mesh_physics(obj,batch){var body_id=get_unique_body_id();var submesh=batch.submesh;
var positions=submesh.va_frames[0]["a_position"];var indices=submesh.indices||null;var collision_group=batch.collision_group;var collision_mask=batch.collision_mask;var render=obj._render;var trans=obj._render.trans;m_ipc.post_msg(m_ipc.OUT_APPEND_GHOST_MESH_BODY,body_id,positions,indices,trans,collision_group,collision_mask);var phy=init_physics(body_id);phy.is_ghost=true;return phy}function init_bounding_physics(obj,physics_type,compound_children){var render=obj._render;var game=obj["game"];var bb=
render.bb_local;var body_id=get_unique_body_id();if(obj["type"]=="CAMERA"){var bounding_type="CAPSULE";var bcap=render.bcap_local;var bcap_new={center:[bcap.center[0],-bcap.center[2],bcap.center[1]],radius:bcap.radius,height:bcap.height};var bounding_object=bcap_new;var quat=null;var friction=0.5;var restitution=0}else if(obj["type"]=="EMPTY"){var bounding_type="EMPTY";var bounding_object=null;var quat=render.quat;var friction=0;var restitution=0}else{var bounding_type=game["use_collision_bounds"]?
game["collision_bounds_type"]:"BOX";var quat=render.quat;var bounding_object=find_bounding_type(bounding_type,render);var friction=render.friction;var restitution=render.elasticity}var trans=render.trans;var is_ghost=game["use_ghost"];var disable_sleeping=game["use_sleep"];var mass=game["mass"];var velocity_min=game["velocity_min"];var velocity_max=game["velocity_max"];var damping=game["damping"];var rotation_damping=game["rotation_damping"];var collision_group=game["collision_group"];var collision_mask=
game["collision_mask"];var size=render.bs_local.radius;var worker_bounding=create_worker_bounding(bounding_object);var correct_bound_offset=obj["b4w_correct_bounding_offset"];var comp_children_params=get_children_params(render,compound_children,bounding_type,worker_bounding);m_ipc.post_msg(m_ipc.OUT_APPEND_BOUNDING_BODY,body_id,trans,quat,physics_type,is_ghost,disable_sleeping,mass,velocity_min,velocity_max,damping,rotation_damping,collision_group,collision_mask,bounding_type,worker_bounding,size,
friction,restitution,comp_children_params,correct_bound_offset);_bounding_objects.push(obj);var phy=init_physics(body_id);phy.type=physics_type;phy.mass=mass;phy.is_ghost=is_ghost;return phy}function get_children_params(render,children,bt,wb){if(!children.length)return[];var comp_children_params=[];var parent_params={};parent_params["quat"]=new Float32Array([0,0,0,1]);parent_params["trans"]=new Float32Array(3);parent_params["worker_bounding"]=wb;parent_params["bounding_type"]=bt;comp_children_params.push(parent_params);
var wm_inv=_mat4_tmp;var quat_inv=_quat4_tmp;m_mat4.invert(render.world_matrix,wm_inv);m_quat.invert(render.quat,quat_inv);for(var i=0;i<children.length;i++){var child_params={};var child=children[i];var child_bt=child["game"]["collision_bounds_type"];var loc_quat=new Float32Array(4);var loc_trans=new Float32Array(3);m_vec3.transformMat4(child._render.trans,wm_inv,loc_trans);m_quat.multiply(quat_inv,child._render.quat,loc_quat);child_params["trans"]=loc_trans;child_params["quat"]=loc_quat;child_params["bounding_type"]=
child_bt;child_params["worker_bounding"]=create_worker_bounding(find_bounding_type(child_bt,child._render));comp_children_params.push(child_params)}return comp_children_params}function find_bounding_type(bounding_type,render){switch(bounding_type){case "BOX":var bounding_object=render.bb_local;break;case "CYLINDER":var bounding_object=render.bcyl_local;break;case "CONE":var bounding_object=render.bcon_local;break;case "SPHERE":var bounding_object=render.bs_local;break;case "CAPSULE":var bounding_object=
render.bcap_local;break}return bounding_object}function create_worker_bounding(bounding_object){if(!bounding_object)return null;var in_obj=bounding_object;var out_obj={};if(typeof in_obj.min_x==="number")out_obj["min_x"]=in_obj.min_x;if(typeof in_obj.min_y==="number")out_obj["min_y"]=in_obj.min_y;if(typeof in_obj.min_z==="number")out_obj["min_z"]=in_obj.min_z;if(typeof in_obj.max_x==="number")out_obj["max_x"]=in_obj.max_x;if(typeof in_obj.max_y==="number")out_obj["max_y"]=in_obj.max_y;if(typeof in_obj.max_z===
"number")out_obj["max_z"]=in_obj.max_z;if(typeof in_obj.center==="object")out_obj["center"]=in_obj.center;if(typeof in_obj.radius==="number")out_obj["radius"]=in_obj.radius;if(typeof in_obj.height==="number")out_obj["height"]=in_obj.height;return out_obj}function init_vehicle(obj){var body_id=obj._physics.body_id;if(is_vehicle_chassis(obj)){obj._vehicle.type=VT_CHASSIS;var susp_compress=obj._vehicle.suspension_compression;var susp_stiffness=obj._vehicle.suspension_stiffness;var susp_damping=obj._vehicle.suspension_damping;
var wheel_friction=obj._vehicle.wheel_friction;var max_suspension_travel_cm=obj._vehicle.max_suspension_travel_cm;m_ipc.post_msg(m_ipc.OUT_APPEND_CAR,body_id,susp_compress,susp_stiffness,susp_damping,wheel_friction,max_suspension_travel_cm)}else if(is_vehicle_hull(obj)){obj._vehicle.type=VT_HULL;var floating_factor=obj._vehicle.floating_factor;var water_lin_damp=obj._vehicle.water_lin_damp;var water_rot_damp=obj._vehicle.water_rot_damp;m_ipc.post_msg(m_ipc.OUT_APPEND_BOAT,body_id,floating_factor,
water_lin_damp,water_rot_damp)}if(obj._vehicle.props){var props=obj._vehicle.props;switch(obj._vehicle.type){case VT_CHASSIS:add_vehicle_prop(props[1],obj,body_id,true);add_vehicle_prop(props[0],obj,body_id,true);add_vehicle_prop(props[3],obj,body_id,false);add_vehicle_prop(props[2],obj,body_id,false);break;case VT_HULL:for(var i=0;i<props.length;i++)add_vehicle_prop(props[i],obj,body_id,false);break}}obj._physics.id=obj["b4w_vehicle_settings"]["name"]}function add_vehicle_prop(obj_prop,obj_chassis_hull,
chassis_body_id,is_front){var prop_trans=obj_prop._render.trans;var chassis_hull_matrix=obj_chassis_hull._render.world_matrix;var chassis_hull_matrix_inv=new Float32Array(16);m_mat4.invert(chassis_hull_matrix,chassis_hull_matrix_inv);var conn_point=new Float32Array(3);m_vec3.transformMat4(prop_trans,chassis_hull_matrix_inv,conn_point);switch(obj_chassis_hull._vehicle.type){case VT_CHASSIS:var v_set=obj_chassis_hull["b4w_vehicle_settings"];var suspension_rest_length=v_set["suspension_rest_length"];
var roll_influence=v_set["roll_influence"];var bb=obj_prop._render.bb_local;var radius=(bb.max_y-bb.min_y)/2;m_ipc.post_msg(m_ipc.OUT_ADD_CAR_WHEEL,chassis_body_id,conn_point,suspension_rest_length,roll_influence,radius,is_front);break;case VT_HULL:m_ipc.post_msg(m_ipc.OUT_ADD_BOAT_BOB,chassis_body_id,conn_point,obj_prop.synchronize_pos);break}}function init_character(obj){var render=obj._render;var phy=obj._physics;var height=render.bb_local.max_y-render.bb_local.min_y;var character_id=phy.body_id;
var char_settings=obj["b4w_character_settings"];var walk_speed=char_settings["walk_speed"];var run_speed=char_settings["run_speed"];var step_height=char_settings["step_height"];var jump_strength=char_settings["jump_strength"];var waterline=char_settings["waterline"];var rot_angle=m_util.dir_ground_proj_angle(obj);m_ipc.post_msg(m_ipc.OUT_APPEND_CHARACTER,character_id,rot_angle,height,walk_speed,run_speed,step_height,jump_strength,waterline);phy.is_character=true}function init_floater(obj){var floating_factor=
obj._floater.floating_factor;var water_lin_damp=obj._floater.water_lin_damp;var water_rot_damp=obj._floater.water_rot_damp;var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_APPEND_FLOATER,body_id,floating_factor,water_lin_damp,water_rot_damp);if(obj._floater.bobs){var bob_objs=obj._floater.bobs;for(var i=0;i<bob_objs.length;i++){var obj_bob=bob_objs[i];var bob_trans=obj_bob._render.trans;var wm=obj._render.world_matrix;var wm_inv=new Float32Array(16);m_mat4.invert(wm,wm_inv);var conn_point=
new Float32Array(3);m_vec3.transformMat4(bob_trans,wm_inv,conn_point);m_ipc.post_msg(m_ipc.OUT_ADD_FLOATER_BOB,body_id,conn_point,obj_bob.bob_synchronize_pos)}}obj._physics.is_floater=true}exports.enable_simulation=function(obj){var phy=obj._physics;if(!phy)throw"No object physics";if(phy.simulated)return;var body_id=phy.body_id;phy.simulated=true;m_ipc.post_msg(m_ipc.OUT_ENABLE_SIMULATION,body_id)};exports.disable_simulation=function(obj){var phy=obj._physics;if(!phy)throw"No object physics";if(!phy.simulated)return;
var body_id=phy.body_id;phy.simulated=false;m_ipc.post_msg(m_ipc.OUT_DISABLE_SIMULATION,body_id)};exports.has_physics=has_physics;function has_physics(obj){if(obj._physics)return true;else return false}exports.has_dynamic_physics=function(obj){var phy=obj._physics;if(phy&&(phy.simulated&&((phy.type=="RIGID_BODY"||phy.type=="DYNAMIC")&&(phy.mass>0&&phy.is_ghost==false))))return true;else return false};exports.has_simulated_physics=function(obj){var phy=obj._physics;if(phy&&phy.simulated)return true;
else return false};exports.set_gravity=set_gravity;function set_gravity(obj,gravity){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_SET_GRAVITY,body_id,gravity)}function process_rigid_body_joints(obj){if(has_constraint(obj))return;for(var i=0;i<obj["constraints"].length;i++){var cons=obj["constraints"][i];var targ=cons["target"];var pivot_type=cons["pivot_type"];if(!(cons["type"]=="RIGID_BODY_JOINT"&&targ._physics))continue;var trans=get_rbj_trans(cons);var quat=get_rbj_quat(cons);var local=
m_mat4.fromRotationTranslation(quat,trans,new Float32Array(16));var world_a=m_mat4.multiply(obj._render.world_matrix,local,new Float32Array(16));var world_b_inv=m_mat4.invert(targ._render.world_matrix,new Float32Array(16));var local_b=m_mat4.multiply(world_b_inv,world_a,world_b_inv);var local_b_tra=m_util.matrix_to_trans(local_b);var local_b_qua=m_util.matrix_to_quat(local_b);var limits=prepare_limits(cons);apply_constraint(pivot_type,obj,trans,quat,targ,local_b_tra,local_b_qua,limits,null,null)}}
exports.has_constraint=has_constraint;function has_constraint(obj){if(obj._physics&&obj._physics.cons_id)return true;else return false}function get_rbj_trans(cons){var trans=new Float32Array([cons["pivot_x"],cons["pivot_y"],cons["pivot_z"]]);return trans}function get_rbj_quat(cons){var euler=new Float32Array([cons["axis_x"],cons["axis_y"],cons["axis_z"]]);var quat=m_util.euler_to_quat(euler,new Float32Array(4));return quat}function prepare_limits(cons){var limits={};limits["use_limit_x"]=cons["use_limit_x"];
limits["use_limit_y"]=cons["use_limit_y"];limits["use_limit_z"]=cons["use_limit_z"];limits["use_angular_limit_x"]=cons["use_angular_limit_x"];limits["use_angular_limit_y"]=cons["use_angular_limit_y"];limits["use_angular_limit_z"]=cons["use_angular_limit_z"];limits["limit_max_x"]=cons["limit_max_x"];limits["limit_min_x"]=cons["limit_min_x"];limits["limit_max_y"]=cons["limit_max_y"];limits["limit_min_y"]=cons["limit_min_y"];limits["limit_max_z"]=cons["limit_max_z"];limits["limit_min_z"]=cons["limit_min_z"];
limits["limit_angle_max_x"]=cons["limit_angle_max_x"];limits["limit_angle_min_x"]=cons["limit_angle_min_x"];limits["limit_angle_max_y"]=cons["limit_angle_max_y"];limits["limit_angle_min_y"]=cons["limit_angle_min_y"];limits["limit_angle_max_z"]=cons["limit_angle_max_z"];limits["limit_angle_min_z"]=cons["limit_angle_min_z"];return limits}exports.apply_constraint=apply_constraint;function apply_constraint(pivot_type,obj_a,trans_a,quat_a,obj_b,trans_b,quat_b,limits,stiffness,damping){var cons_id=get_unique_constraint_id();
var body_a=obj_a._physics.body_id;var body_b=obj_b._physics.body_id;m_ipc.post_msg(m_ipc.OUT_APPEND_CONSTRAINT,cons_id,pivot_type,limits,body_a,trans_a,quat_a,body_b,trans_b,quat_b,stiffness,damping);var phy=obj_a._physics;phy.cons_id=cons_id}function get_unique_constraint_id(){_unique_counter.constraint++;return _unique_counter.constraint.toString(16)}exports.clear_constraint=function(obj_a){var phy=obj_a._physics;var cons_id=phy.cons_id;m_ipc.post_msg(m_ipc.OUT_REMOVE_CONSTRAINT,cons_id);phy.cons_id=
null};exports.pull_to_constraint_pivot=function(obj_a,trans_a,quat_a,obj_b,trans_b,quat_b){var tsr_a=m_tsr.create_sep(trans_a,1,quat_a,_tsr8_tmp);var tsr_b=m_tsr.create_sep(trans_b,1,quat_b,_tsr8_tmp2);m_tsr.invert(tsr_a,tsr_a);m_tsr.multiply(tsr_b,tsr_a,tsr_a);m_trans.get_tsr(obj_b,tsr_b);m_tsr.multiply(tsr_b,tsr_a,tsr_a);m_trans.set_tsr(obj_a,tsr_a);m_trans.update_transform(obj_a);exports.set_transform(obj_a,obj_a._render.trans,obj_a._render.quat)};exports.set_transform=function(obj,trans,quat){var phy=
obj._physics;m_tsr.set_sep(obj._render.trans,1,obj._render.quat,phy.curr_tsr);var msg_cache=m_ipc.get_msg_cache(m_ipc.OUT_SET_TRANSFORM);msg_cache["msg_id"]=m_ipc.OUT_SET_TRANSFORM;msg_cache["body_id"]=obj._physics.body_id;msg_cache["trans"]=trans;msg_cache["quat"]=quat;m_ipc.post_msg(m_ipc.OUT_SET_TRANSFORM,msg_cache)};exports.sync_transform=sync_transform;function sync_transform(obj){if(allows_transform(obj)&&transform_changed(obj)){m_vec3.copy(obj._render.trans,obj._physics.cached_trans);var phy=
obj._physics;var msg_cache=m_ipc.get_msg_cache(m_ipc.OUT_SET_TRANSFORM);msg_cache["msg_id"]=m_ipc.OUT_SET_TRANSFORM;msg_cache["body_id"]=obj._physics.body_id;msg_cache["trans"]=obj._render.trans;if(phy.type==="DYNAMIC"){msg_cache["quat"]=_vec4_tmp;m_quat.identity(_vec4_tmp)}else msg_cache["quat"]=obj._render.quat;m_ipc.post_msg(m_ipc.OUT_SET_TRANSFORM,msg_cache)}var descends=obj._descends;for(var i=0;i<descends.length;i++)sync_transform(descends[i])}function allows_transform(obj){var phy=obj._physics;
if(!phy)return false;else if(phy.mass===0)return true;else if(phy.is_ghost===true)return true;else if(phy.simulated===false)return true;else if(phy.type!=="RIGID_BODY"&&phy.type!=="DYNAMIC")return true;else return false}function transform_changed(obj){return obj._render.trans[0]!=obj._physics.cached_trans[0]||(obj._render.trans[1]!=obj._physics.cached_trans[1]||obj._render.trans[2]!=obj._physics.cached_trans[2])}exports.apply_velocity=function(obj,vx_local,vy_local,vz_local,allow_vertical,disable_up){var v_world=
_vec3_tmp;vector_to_world(obj,vx_local,vy_local,vz_local,allow_vertical,disable_up,v_world);var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_ACTIVATE,body_id);var vx0=0;var vy0=0;var vz0=0;var vx0a=Math.abs(vx0);var vy0a=Math.abs(vy0);var vz0a=Math.abs(vz0);var vxa=Math.abs(v_world[0]);var vya=Math.abs(v_world[1]);var vza=Math.abs(v_world[2]);v_world[0]=vxa?v_world[0]/vxa*Math.max(vxa,vx0a):vx0;v_world[1]=vya?v_world[1]/vya*Math.max(vya,vy0a):vy0;v_world[2]=vza?v_world[2]/vza*Math.max(vza,
vz0a):vz0;m_ipc.post_msg(m_ipc.OUT_SET_LINEAR_VELOCITY,body_id,v_world[0],v_world[1],v_world[2])};exports.apply_velocity_world=function(obj,vx,vy,vz){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_ACTIVATE,body_id);m_ipc.post_msg(m_ipc.OUT_SET_LINEAR_VELOCITY,body_id,vx,vy,vz)};function vector_to_world(obj,vx_local,vy_local,vz_local,allow_vertical,disable_up,dest){var v=dest||new Float32Array(3);var quat=obj._render.quat;if(allow_vertical){v[0]=vx_local;v[1]=vy_local;v[2]=vz_local;var v_world=
m_vec3.transformQuat(v,quat,v)}else if(obj["type"]=="CAMERA"){v[0]=vx_local;v[1]=vy_local;v[2]=0;var v_world=m_vec3.transformQuat(v,quat,v);v_world[1]=-vz_local}else if(obj["type"]=="MESH"){v[0]=vx_local;v[1]=0;v[2]=vz_local;var v_world=m_vec3.transformQuat(v,quat,v);v_world[1]=vy_local}else throw"Wrong object type";if(disable_up&&v_world[1]>0)v_world[1]=0;return v_world}exports.apply_force=apply_force;function apply_force(obj,fx_local,fy_local,fz_local,allow_vertical,disable_up){var f_world=_vec3_tmp;
vector_to_world(obj,fx_local,fy_local,fz_local,allow_vertical,disable_up,f_world);var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_ACTIVATE,body_id);m_ipc.post_msg(m_ipc.OUT_APPLY_CENTRAL_FORCE,body_id,f_world[0],f_world[1],f_world[2])}exports.apply_torque=apply_torque;function apply_torque(obj,tx_local,ty_local,tz_local){var t_world=_vec3_tmp;vector_to_world(obj,tx_local,ty_local,tz_local,true,false,t_world);var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_ACTIVATE,body_id);m_ipc.post_msg(m_ipc.OUT_APPLY_TORQUE,
body_id,t_world[0],t_world[1],t_world[2])}exports.set_character_move_dir=function(obj,forw,side){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_ACTIVATE,body_id);m_ipc.post_msg(m_ipc.OUT_SET_CHARACTER_MOVE_DIR,body_id,forw,side)};exports.set_character_move_type=function(obj,type){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_SET_CHARACTER_MOVE_TYPE,body_id,type)};exports.set_character_walk_velocity=function(obj,velocity){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_SET_CHARACTER_WALK_VELOCITY,
body_id,velocity)};exports.set_character_run_velocity=function(obj,velocity){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_SET_CHARACTER_RUN_VELOCITY,body_id,velocity)};exports.set_character_fly_velocity=function(obj,velocity){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_SET_CHARACTER_FLY_VELOCITY,body_id,velocity)};exports.character_jump=function(obj){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_CHARACTER_JUMP,body_id)};exports.character_rotation_inc=function(obj,
h_angle,v_angle){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_CHARACTER_ROTATION_INCREMENT,body_id,h_angle,v_angle)};exports.set_character_rotation=function(obj,angle_h,angle_v){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_SET_CHARACTER_ROTATION,body_id,angle_h,angle_v)};exports.set_character_rotation_h=function(obj,angle){var body_id=obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_SET_CHARACTER_HOR_ROTATION,body_id,angle)};exports.set_character_rotation_v=function(obj,angle){var body_id=
obj._physics.body_id;m_ipc.post_msg(m_ipc.OUT_SET_CHARACTER_VERT_ROTATION,body_id,angle)};exports.check_underwater=function(){return false};exports.check_on_surface=function(){return false};exports.check_collision=function(){m_print.error("check_collision() deprecated");return false};exports.check_collision_any=function(){m_print.error("check_collision_any() deprecated");return false};exports.check_ray_hit=function(){m_print.error("check_ray_hit() deprecated");return false};exports.update_object_coords=
function(){m_print.error("update_object_coords() deprecated");return};exports.append_collision_test=function(obj,collision_id,callback,need_collision_pt){var phy=obj._physics;var body_id=phy.body_id;var collision_id=collision_id||"ANY";for(var i=0;i<phy.collision_tests.length;i++){var test=phy.collision_tests[i];if(test.collision_id==collision_id&&test.callback==callback)return}var pairs=extract_collision_pairs(obj,collision_id);var test={collision_id:collision_id,callback:callback,pairs:pairs,pair_results:new Uint8Array(pairs.length),
need_collision_pt:need_collision_pt||false};phy.collision_tests.push(test);m_ipc.post_msg(m_ipc.OUT_ACTIVATE,body_id);m_ipc.post_msg(m_ipc.OUT_APPEND_COLLISION_TEST,pairs,need_collision_pt)};function extract_collision_pairs(obj,collision_id){var pairs=[];var body_id_a=obj._physics.body_id;var body_id_b_arr=[];collision_id_to_body_ids(collision_id,get_active_scene(),body_id_b_arr,null);for(var i=0;i<body_id_b_arr.length;i++){var body_id_b=body_id_b_arr[i];if(body_id_a<body_id_b)pairs.push([body_id_a,
body_id_b]);else if(body_id_a>body_id_b)pairs.push([body_id_b,body_id_a])}return pairs}function gen_collision_body_ids(callbacks,bpy_scene,dest_arr,dest_obj){if("ANY"in callbacks){for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=bpy_scene._physics.bundles[i];var body_id=bundle.physics.body_id;dest_arr.push(body_id);dest_obj[body_id]=0}return}for(var collision_id in callbacks)for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=bpy_scene._physics.bundles[i];if(bundle.physics.id==
collision_id){var body_id=bundle.physics.body_id;if(dest_arr.indexOf(body_id)==-1)dest_arr.push(body_id);dest_obj[body_id]=0}}}exports.remove_collision_test=function(obj,collision_id,callback){var phy=obj._physics;var body_id=phy.body_id;var collision_id=collision_id||"ANY";for(var i=0;i<phy.collision_tests.length;i++){var test=phy.collision_tests[i];if(test.collision_id==collision_id&&test.callback==callback){phy.collision_tests.splice(i,1);i--;remove_unused_collision_pairs(get_active_scene(),test.pairs)}}};
function remove_unused_collision_pairs(scene,pairs){var bundles=scene._physics.bundles;var unused_pairs=pairs;for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;for(var j=0;j<phy.collision_tests.length;j++){var test=phy.collision_tests[j];for(var k=0;k<test.pairs.length;k++){var pair=test.pairs[k];for(var l=0;l<unused_pairs.length;l++){var unused_pair=unused_pairs[l];if(pair[0]===unused_pair[0]&&pair[1]===unused_pair[1]){unused_pairs.splice(l,1);l--}}}}}if(unused_pairs.length)m_ipc.post_msg(m_ipc.OUT_REMOVE_COLLISION_TEST,
unused_pairs)}exports.apply_collision_impulse_test=function(obj,callback){var phy=obj._physics;if(!phy){m_print.error("Object "+obj["name"]+" has no physics");return}m_ipc.post_msg(m_ipc.OUT_APPLY_COLLISION_IMPULSE_TEST,phy.body_id);phy.col_imp_test_cb=callback};exports.clear_collision_impulse_test=function(obj){var phy=obj._physics;if(!phy){m_print.error("Object "+obj["name"]+" has no physics");return}m_ipc.post_msg(m_ipc.OUT_CLEAR_COLLISION_IMPULSE_TEST,phy.body_id);phy.col_imp_test_cb=null};exports.append_ray_test=
function(obj,collision_id,from,to,local_coords,callback){var phy=obj._physics;if(!phy){m_print.error("Object "+obj["name"]+" has no physics");return}var body_id=phy.body_id;var collision_id=collision_id||"ANY";var test={from:new Float32Array(from),to:new Float32Array(to),local:local_coords,callback:callback,collision_id:collision_id,results:{}};collision_id_to_body_ids(collision_id,_active_scene_phy,null,test.results);delete test.results[body_id];for(var res in test.results)test.results[res]=1;phy.ray_tests.push(test);
order_ray_tests(body_id,phy.ray_tests)};function collision_id_to_body_ids(collision_id,bpy_scene,dest_arr,dest_obj){if(!dest_arr&&!dest_obj)throw"At least one destination required";for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=bpy_scene._physics.bundles[i];if(collision_id=="ANY"||bundle.physics.id==collision_id){var body_id=bundle.physics.body_id;if(dest_arr&&dest_arr.indexOf(body_id)==-1)dest_arr.push(body_id);if(dest_obj)dest_obj[body_id]=0}}}function order_ray_tests(body_id_a,
ray_tests){m_ipc.post_msg(m_ipc.OUT_ACTIVATE,body_id_a);if(!ray_tests.length){m_ipc.post_msg(m_ipc.OUT_RAY_TEST,body_id_a,null,null,false,null);return}var body_id_baskets={};for(var i=0;i<ray_tests.length;i++){var test=ray_tests[i];var id=m_util.array_stringify(test.from)+m_util.array_stringify(test.to)+String(test.local);body_id_baskets[id]=body_id_baskets[id]||{from:test.from,to:test.to,local:test.local,body_ids:[]};var body_ids=body_id_baskets[id].body_ids;for(var body_id in test.results)if(body_ids.indexOf(body_id)==
-1)body_ids.push(body_id)}for(var id in body_id_baskets){var from=body_id_baskets[id].from;var to=body_id_baskets[id].to;var local=body_id_baskets[id].local;var body_ids=body_id_baskets[id].body_ids;m_ipc.post_msg(m_ipc.OUT_RAY_TEST,body_id_a,from,to,local,body_ids)}}exports.remove_ray_test=function(obj,collision_id,from,to,local_coords){var phy=obj._physics;if(!phy){m_print.error("Object "+obj["name"]+" has no physics");return}var body_id=phy.body_id;var collision_id=collision_id||"ANY";for(var i=
0;i<phy.ray_tests.length;i++){var test=phy.ray_tests[i];if(m_util.cmp_arr_float(test.from,from,RAY_CMP_PRECISION)&&(m_util.cmp_arr_float(test.to,to,RAY_CMP_PRECISION)&&test.local==local_coords)){phy.ray_tests.splice(i,1);i--}}order_ray_tests(body_id,phy.ray_tests)};exports.vehicle_throttle=function(obj,engine_force){var vehicle=obj._vehicle;vehicle.engine_force=engine_force;update_vehicle_controls(obj,vehicle)};function update_vehicle_controls(obj,vehicle){if(!vehicle.steering_wheel)return;var body_id=
obj._physics.body_id;var engine_force=vehicle.engine_force*vehicle.force_max;var brake_force=vehicle.brake_force*vehicle.brake_max;var steering=-vehicle.steering*vehicle.steering_max*2*Math.PI/vehicle.steering_ratio;if(vehicle.inverse_control)steering*=-1;switch(vehicle.type){case VT_CHASSIS:m_ipc.post_msg(m_ipc.OUT_ACTIVATE,body_id);m_ipc.post_msg(m_ipc.OUT_UPDATE_CAR_CONTROLS,body_id,engine_force,brake_force,steering);break;case VT_HULL:m_ipc.post_msg(m_ipc.OUT_ACTIVATE,body_id);m_ipc.post_msg(m_ipc.OUT_UPDATE_BOAT_CONTROLS,
body_id,engine_force,brake_force,steering);break}}exports.vehicle_steer=function(obj,steering_value){var vehicle=obj._vehicle;vehicle.steering=steering_value;update_vehicle_controls(obj,vehicle)};exports.vehicle_brake=function(obj,brake_force){var vehicle=obj._vehicle;vehicle.brake_force=brake_force;update_vehicle_controls(obj,vehicle)};function update_steering_wheel_coords(obj_chassis){var vehicle=obj_chassis._vehicle;var stw_obj=vehicle.steering_wheel;if(!stw_obj)return;var stw_matrix=obj_chassis._vehicle.steering_wheel_matrix;
var stw_axis=obj_chassis._vehicle.steering_wheel_axis;var stw_matrix_world=_mat4_tmp;var chassis_trans=obj_chassis._render.trans;var chassis_quat=obj_chassis._render.quat;m_util.transform_mat4(stw_matrix,1,chassis_quat,chassis_trans,stw_matrix_world);m_util.matrix_to_trans(stw_matrix_world,stw_obj._render.trans);m_util.matrix_to_quat(stw_matrix_world,stw_obj._render.quat);var stw_axis_world=_vec4_tmp;m_util.transform_vec4(stw_axis,1,chassis_quat,chassis_trans,stw_axis_world);var rotation=_quat4_tmp;
m_quat.setAxisAngle(stw_axis_world,-vehicle.steering*vehicle.steering_max*2*Math.PI,rotation);m_quat.multiply(rotation,stw_obj._render.quat,stw_obj._render.quat);m_trans.update_transform(stw_obj)}function update_speedometer(obj_chassis){var vehicle=obj_chassis._vehicle;var sp_obj=vehicle.speedometer;if(!sp_obj)return;var sp_matrix=obj_chassis._vehicle.speedometer_matrix;var sp_axis=obj_chassis._vehicle.speedometer_axis;var sp_matrix_world=_mat4_tmp;var chassis_trans=obj_chassis._render.trans;var chassis_quat=
obj_chassis._render.quat;m_util.transform_mat4(sp_matrix,1,chassis_quat,chassis_trans,sp_matrix_world);m_util.matrix_to_trans(sp_matrix_world,sp_obj._render.trans);m_util.matrix_to_quat(sp_matrix_world,sp_obj._render.quat);var sp_axis_world=_vec4_tmp;m_util.transform_vec4(sp_axis,1,chassis_quat,chassis_trans,sp_axis_world);var rotation=_quat4_tmp;var angle=Math.abs(vehicle.speed)*vehicle.speed_ratio;if(angle>vehicle.max_speed_angle)angle=vehicle.max_speed_angle;m_quat.setAxisAngle(sp_axis_world,-angle,
rotation);m_quat.multiply(rotation,sp_obj._render.quat,sp_obj._render.quat);m_trans.update_transform(sp_obj)}function update_tachometer(obj_chassis){var vehicle=obj_chassis._vehicle;var tach_obj=vehicle.tachometer;if(!tach_obj)return;var tach_matrix=obj_chassis._vehicle.tachometer_matrix;var tach_axis=obj_chassis._vehicle.tachometer_axis;var tach_matrix_world=_mat4_tmp;var chassis_trans=obj_chassis._render.trans;var chassis_quat=obj_chassis._render.quat;m_util.transform_mat4(tach_matrix,1,chassis_quat,
chassis_trans,tach_matrix_world);m_util.matrix_to_trans(tach_matrix_world,tach_obj._render.trans);m_util.matrix_to_quat(tach_matrix_world,tach_obj._render.quat);var tach_axis_world=_vec4_tmp;m_util.transform_vec4(tach_axis,1,chassis_quat,chassis_trans,tach_axis_world);var rotation=_quat4_tmp;m_quat.setAxisAngle(tach_axis_world,-Math.abs(vehicle.engine_force)*vehicle.delta_tach_angle,rotation);m_quat.multiply(rotation,tach_obj._render.quat,tach_obj._render.quat);m_trans.update_transform(tach_obj)}
exports.is_vehicle_chassis=is_vehicle_chassis;function is_vehicle_chassis(obj){if(obj["b4w_vehicle"]&&obj["b4w_vehicle_settings"]["part"]=="CHASSIS")return true;else return false}exports.is_vehicle_hull=is_vehicle_hull;function is_vehicle_hull(obj){if(obj["b4w_vehicle"]&&obj["b4w_vehicle_settings"]["part"]=="HULL")return true;else return false}exports.is_car_wheel=function(obj){if(!obj["b4w_vehicle"])return false;var part=obj["b4w_vehicle_settings"]["part"];if(part=="WHEEL_FRONT_LEFT"||(part=="WHEEL_FRONT_RIGHT"||
(part=="WHEEL_BACK_LEFT"||part=="WHEEL_BACK_RIGHT")))return true;else return false};exports.is_boat_bob=function(obj){if(!obj["b4w_vehicle"])return false;var part=obj["b4w_vehicle_settings"]["part"];if(part=="BOB")return true;else return false};exports.is_floater_bob=function(obj){if(!obj["b4w_floating"])return false;var part=obj["b4w_floating_settings"]["part"];if(part=="BOB")return true;else return false};exports.is_vehicle_steering_wheel=function(obj){if(obj["b4w_vehicle"]&&obj["b4w_vehicle_settings"]["part"]==
"STEERING_WHEEL")return true;else return false};exports.is_vehicle_speedometer=function(obj){if(obj["b4w_vehicle"]&&obj["b4w_vehicle_settings"]["part"]=="SPEEDOMETER")return true;else return false};exports.is_vehicle_tachometer=function(obj){if(obj["b4w_vehicle"]&&obj["b4w_vehicle_settings"]["part"]=="TACHOMETER")return true;else return false};exports.get_vehicle_speed=function(obj){var vehicle=obj._vehicle;return vehicle.speed};exports.wheel_index=function(vehicle_part){switch(vehicle_part){case "WHEEL_FRONT_LEFT":return 0;
case "WHEEL_FRONT_RIGHT":return 1;case "WHEEL_BACK_LEFT":return 2;case "WHEEL_BACK_RIGHT":return 3}};exports.is_character=is_character;function is_character(obj){if(obj["b4w_character"])return true;else return false}exports.is_floater_main=is_floater_main;function is_floater_main(obj){if(obj["b4w_floating"]&&obj["b4w_floating_settings"]["part"]=="MAIN_BODY")return true;else return false}exports.get_fps=function(){return _phy_fps};exports.debug_worker=function(){m_ipc.post_msg(m_ipc.OUT_DEBUG)}};b4w.module["__data"]=function(exports,require){var m_anim=require("__animation");var m_batch=require("__batch");var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cfg=require("__config");var m_cons=require("__constraints");var m_ctl=require("__controls");var m_curve=require("__curve");var m_dds=require("__dds");var m_debug=require("__debug");var m_ext=require("__extensions");var m_lights=require("__lights");var m_loader=require("__loader");var m_assets=require("__assets");var m_md5=
require("__md5");var m_particles=require("__particles");var m_prerender=require("__prerender");var m_phy=require("__physics");var m_print=require("__print");var m_reformer=require("__reformer");var m_render=require("__renderer");var m_scenes=require("__scenes");var m_nla=require("__nla");var m_sfx=require("__sfx");var m_shaders=require("__shaders");var m_tex=require("__textures");var m_tsr=require("__tsr");var m_trans=require("__transform");var m_nodemat=require("__nodemat");var m_util=require("__util");
var m_vec3=require("vec3");var m_vec4=require("vec4");var m_mat4=require("mat4");var cfg_def=m_cfg.defaults;var cfg_ldr=m_cfg.assets;var cfg_phy=m_cfg.physics;var DEBUG_DISABLE_BATCHING=false;var DEBUG_BPYDATA=false;var DEBUG_LOD_DIST_NOT_SET=false;var _quat4_tmp=new Float32Array(4);var _bpy_data={};var _scheduler=null;var _all_objects_cache=null;var _color_id_counter=0;var _debug_resources_root="";var ADD_TYPES=["LAMP","EMPTY","CAMERA","SPEAKER","MESH","ARMATURE"];var ADD_PHY_TYPES=["MESH","CAMERA",
"EMPTY"];var ADD_SFX_TYPES=["SPEAKER"];exports.is_loaded=function(){var scheduler=get_scheduler();return m_loader.is_loaded(scheduler)};function get_scheduler(){return _scheduler}exports.update=function(){var bpy_data=get_bpy_data();var scheduler=get_scheduler();m_loader.update_scheduler(scheduler,bpy_data)};function free_load_data(bpy_data,scheduler){cleanup_meshes(get_all_objects(bpy_data));set_bpy_data({})}function print_image_info(image_data,image_path,show_path_warning){var w,h;if(image_data instanceof
ArrayBuffer){var dds_wh=m_dds.get_width_height(image_data);w=dds_wh.width;h=dds_wh.height}else{w=image_data.width;h=image_data.height}var color;if(w>2048||h>2048)color="a00";else if(w>1024||h>1024)color="aa0";else color="0a0";m_print.log("%cLOAD IMAGE "+w+"x"+h,"color: #"+color,image_path);if(image_path.indexOf(_debug_resources_root)==-1&&show_path_warning)m_print.warn("B4W Warning: image",image_path,"is not from app root")}function load_main(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){var main_path=
scheduler.filepath;if(!main_path)throw"Nothing requested";var asset_cb=function(loaded_bpy_data,uri,type,path){if(!loaded_bpy_data)return;m_print.log("%cLOAD METADATA","color: #616",path);check_version(loaded_bpy_data);for(var prop in loaded_bpy_data)bpy_data[prop]=loaded_bpy_data[prop];scheduler.binary_name=bpy_data["binaries"][0]["binfile"];if(!scheduler.binary_name){m_loader.skip_stage_by_name(scheduler,"load_binaries");m_loader.skip_stage_by_name(scheduler,"prepare_bindata")}show_export_warnings(bpy_data);
cb_finish(scheduler,stage)};var progress_cb=function(rate){cb_set_rate(scheduler,stage,rate)};m_assets.enqueue([[main_path,m_assets.AT_JSON,main_path]],asset_cb,null,progress_cb)}function show_export_warnings(bpy_data){if(bpy_data["b4w_export_warnings"])for(var i=0;i<bpy_data["b4w_export_warnings"].length;i++)m_print.error("EXPORT WARNING:",bpy_data["b4w_export_warnings"][i])}function load_binaries(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){var binary_path=dirname(scheduler.filepath)+
scheduler.binary_name;if(!binary_path)throw"Binary data is missing";var binary_cb=function(bin_data,uri,type,path){if(!bin_data)return;m_print.log("%cLOAD BINARY","color: #616",path);bpy_data["bin_data"]=bin_data;cb_finish(scheduler,stage)};var progress_cb=function(rate){cb_set_rate(scheduler,stage,rate)};m_assets.enqueue([[binary_path,m_assets.AT_ARRAYBUFFER,binary_path]],binary_cb,null,progress_cb)}function check_version(loaded_bpy_data){var ver_str=loaded_bpy_data["b4w_format_version"];if(Number(ver_str)<
cfg_def.min_format_version)throw"Incompatible file version: "+ver_str+". Required: "+cfg_def.min_format_version;}function prepare_bindata(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){var bin_data=bpy_data["bin_data"];var bin_offsets=bpy_data["binaries"][0];var objects=bpy_data["objects"];var meshes=bpy_data["meshes"];var is_le=m_util.check_endians();prepare_bindata_submeshes(bin_data,bin_offsets,meshes,is_le);prepare_bindata_psystems(bin_data,bin_offsets,objects,is_le);cb_finish(scheduler,
stage)}function prepare_bindata_submeshes(bin_data,bin_offsets,meshes,is_le){var int_props=["indices"];var float_props=["position","normal","tangent","texcoord","texcoord2","color","group"];for(var i=0;i<meshes.length;i++){var submeshes=meshes[i]["submeshes"];for(var j=0;j<submeshes.length;j++)for(var prop_name in submeshes[j])if(int_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*4+bin_offsets["int"];var length=submeshes[j][prop_name][1];submeshes[j][prop_name]=extract_bindata_uint(bin_data,
offset,length,is_le)}else if(float_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*4+bin_offsets["float"];var length=submeshes[j][prop_name][1];submeshes[j][prop_name]=extract_bindata_float(bin_data,offset,length,is_le)}}}function prepare_bindata_psystems(bin_data,bin_offsets,objects,is_le){for(var i=0;i<objects.length;i++){var psystems=objects[i]["particle_systems"];for(var j=0;j<psystems.length;j++){var psys=psystems[j];var offset=psys["transforms"][0]*4+bin_offsets["float"];
var length=psys["transforms"][1];psys["transforms"]=extract_bindata_float(bin_data,offset,length,is_le)}}}function extract_bindata_float(bin_data,offset,length,is_le){if(is_le)var arr=new Float32Array(bin_data,offset,length);else{var arr=new Float32Array(length);var dataview=new DataView(bin_data);for(var i=0;i<length;i++)arr=dataview.getFloat32(offset+i*4,true)}return arr}function extract_bindata_uint(bin_data,offset,length,is_le){if(is_le)var arr=new Uint32Array(bin_data,offset,length);else{var arr=
new Uint32Array(length);var dataview=new DataView(bin_data);for(var i=0;i<length;i++)arr=dataview.getUint32(offset+i*4,true)}return arr}function report_empty_submeshes(bpy_data){var already_reported={};var objects=bpy_data["objects"];for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj["type"]!=="MESH")continue;if(obj["particle_systems"].length)continue;var mesh=obj["data"];var mesh_name=mesh["name"];var submeshes=mesh["submeshes"];var materials=mesh["materials"];for(var j=0;j<submeshes.length;j++)if(submeshes[j]["base_length"]===
0&&!already_reported[mesh_name]){m_print.warn('B4W Warning: material "'+materials[j]["name"]+'" is not assigned to any faces (object "'+obj["name"]+'")');already_reported[mesh_name]=true}}}function prepare_root_datablocks(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){make_links(bpy_data);m_reformer.check_bpy_data(bpy_data);var textures=bpy_data["textures"];var global_af=get_global_anisotropic_filtering(bpy_data);for(var i=0;i<textures.length;i++)m_tex.create_texture_bpy(textures[i],global_af,
bpy_data["scenes"]);create_special_materials(bpy_data);var def_mat=m_util.keysearch("name","DEFAULT",bpy_data["materials"]);assign_default_material(def_mat,bpy_data["meshes"]);report_empty_submeshes(bpy_data);prepare_actions(bpy_data["actions"]);prepare_hair_particles(bpy_data);prepare_lod_constraints(bpy_data);var objects=get_all_objects(bpy_data);for(var i=0;i<objects.length;i++){var obj=objects[i];update_object(obj)}calc_max_bones(objects);prepare_lod_objects(objects);prepare_vehicles(objects);
prepare_floaters(objects);cb_finish(scheduler,stage)}function prepare_root_scenes(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];check_scene(scene);var scene_objects=m_scenes.combine_scene_objects(scene,"MESH");for(var j=0;j<scene_objects.length;j++){var obj=scene_objects[j];var mesh=m_reformer.apply_mesh_modifiers(obj);if(mesh){bpy_data["meshes"].push(mesh);obj["data"]=mesh}}remove_orphan_meshes(get_all_objects(bpy_data),
bpy_data["meshes"]);m_scenes.append_scene(scene);if(cfg_phy.enabled&&scene["b4w_enable_physics"])m_phy.attach_scene_physics(scene);if(scene["b4w_enable_audio"])m_sfx.attach_scene_sfx(scene);var meta_objects=m_batch.generate_main_batches(m_scenes.get_graph(scene),scene["b4w_batch_grid_size"],scene_objects,bpy_data);m_scenes.add_meta_objects(scene,meta_objects);m_scenes.generate_auxiliary_batches(m_scenes.get_graph(scene))}setup_dds_loading(bpy_data);if(DEBUG_BPYDATA)m_print.log("%cDEBUG BPYDATA:",
"color: #a0a",bpy_data);cb_finish(scheduler,stage)}function setup_dds_loading(bpy_data){var materials=bpy_data["materials"];if(!cfg_ldr.dds_available||!cfg_def.use_dds){unset_images_dds(bpy_data["images"]);return}for(var i=0;i<materials.length;i++){var material=materials[i];var texture_slots=material["texture_slots"];for(var j=0;j<texture_slots.length;j++){var texture_slot=texture_slots[j];var texture=texture_slot["texture"];if(texture["type"]!="IMAGE"&&texture["type"]!="ENVIRONMENT_MAP")continue;
var image=texture["image"];if(image._is_dds);else if(image["filepath"].indexOf(".dds")>-1)image._is_dds=true;else{image._is_dds=!texture["b4w_disable_compression"]&&(!texture_slot["use_map_normal"]&&(texture["type"]!="ENVIRONMENT_MAP"&&!texture["b4w_shore_dist_map"]));if(image._is_dds)image["filepath"]+=".dds"}}var node_tree=material["node_tree"];if(node_tree){var nodes=node_tree["nodes"];for(var j=0;j<nodes.length;j++){var node=nodes[j];if(node["type"]=="TEXTURE"){var tex=node["texture"];if(!tex){m_print.warn("B4W Warning: material ",
material["name"]," has empty textures");continue}var image=tex["image"];if(image._is_dds);else{image._is_dds=tex._render.allow_node_dds&&!tex["b4w_disable_compression"];if(image._is_dds)image["filepath"]+=".dds"}}}}}}function unset_images_dds(images){for(var i=0;i<images.length;i++){var image=images[i];var use_dds=Boolean(image["source"]=="FILE"&&image["filepath"].indexOf(".dds")>-1);image._is_dds=use_dds}}function get_global_anisotropic_filtering(bpy_data){return bpy_data["scenes"][0]["b4w_anisotropic_filtering"]}
function duplicate_objects(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){var groups=bpy_data["groups"];var objects=bpy_data["objects"];var grp_ids_old={};var obj_ids_old={};var grp_ids={};var obj_ids={};for(var i=0;i<groups.length;i++){var group=groups[i];grp_ids_old[group["uuid"]]=group;grp_ids[group["uuid"]]=group}for(var i=0;i<objects.length;i++){var obj=objects[i];obj_ids_old[obj["uuid"]]=obj;obj_ids[obj["uuid"]]=obj}duplicate_objects_iter(objects,null,obj_ids,grp_ids);for(var id in grp_ids)if(!(id in
grp_ids_old))groups.push(grp_ids[id]);for(var id in obj_ids)if(!(id in obj_ids_old))objects.push(obj_ids[id]);cb_finish(scheduler,stage)}function duplicate_objects_iter(obj_links,origin_name_prefix,obj_ids,grp_ids){var proxy_source_ids=[];for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var obj=obj_ids[obj_link["uuid"]];var proxy_link=obj["proxy"];if(proxy_link){if(origin_name_prefix&&proxy_source_ids.indexOf(proxy_link["uuid"])==-1)proxy_source_ids.push(proxy_link["uuid"]);var proxy=
obj_ids[proxy_link["uuid"]];var consts=proxy["constraints"];for(var j=0;j<consts.length;j++){var new_cons=m_util.clone_object_json(consts[j]);new_cons.name=new_cons.name+"_CLONE";obj["constraints"].push(new_cons)}if(!("b4w_proxy_inherit_anim"in obj)||obj["b4w_proxy_inherit_anim"]){var anim_data=obj["animation_data"];if(anim_data)proxy["animation_data"]=m_util.clone_object_json(obj["animation_data"]);proxy["b4w_use_default_animation"]=obj["b4w_use_default_animation"];proxy["b4w_auto_skel_anim"]=obj["b4w_auto_skel_anim"];
proxy["b4w_cyclic_animation"]=obj["b4w_cyclic_animation"]}}}for(var i=0;i<proxy_source_ids.length;i++){var proxy_src_id=proxy_source_ids[i];var obj_index=m_util.get_index_for_key_value(obj_links,"uuid",proxy_src_id);if(obj_index>-1)obj_links.splice(obj_index,1)}var obj_id_overrides={};for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var obj=obj_ids[obj_link["uuid"]];if(origin_name_prefix){var obj_new=m_util.clone_object_json(obj);obj_new["name"]=origin_name_prefix+"*"+obj["name"];obj_new["origin_name"]=
obj["name"];assign_obj_id(obj_new);obj_ids[obj_new["uuid"]]=obj_new;obj_id_overrides[obj_link["uuid"]]=obj_new["uuid"];obj_link["uuid"]=obj_new["uuid"]}var obj=obj_ids[obj_link["uuid"]];if(obj["dupli_group"]){var grp_link=obj["dupli_group"];var grp=grp_ids[grp_link["uuid"]];var grp_new=m_util.clone_object_json(grp);grp_new["name"]=m_util.unique_name(grp["name"]+"_CLONE");assign_grp_id(grp_new);grp_ids[grp_new["uuid"]]=grp_new;grp_link["uuid"]=grp_new["uuid"];var dg_obj_links=grp_new["objects"];duplicate_objects_iter(dg_obj_links,
obj["name"],obj_ids,grp_ids)}}if(origin_name_prefix)for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var obj=obj_ids[obj_link["uuid"]];if(obj["parent"]&&obj["parent"]["uuid"]in obj_id_overrides)obj["parent"]["uuid"]=obj_id_overrides[obj["parent"]["uuid"]];var consts=obj["constraints"];for(var j=0;j<consts.length;j++){var cons=consts[j];if(cons["target"]["uuid"]in obj_id_overrides)cons["target"]["uuid"]=obj_id_overrides[cons["target"]["uuid"]]}var mods=obj["modifiers"];for(var j=0;j<mods.length;j++){var mod=
mods[j];if(mod["object"]&&mod["object"]["uuid"]in obj_id_overrides)mod["object"]["uuid"]=obj_id_overrides[mod["object"]["uuid"]]}}}function assign_obj_id(obj){obj["uuid"]=m_md5.hexdigest("Object"+obj["name"])}function assign_grp_id(grp){grp["uuid"]=m_md5.hexdigest("Group"+grp["name"])}function make_links(bpy_data){var cameras=bpy_data["cameras"];var groups=bpy_data["groups"];var materials=bpy_data["materials"];var meshes=bpy_data["meshes"];var objects=bpy_data["objects"];var particles=bpy_data["particles"];
var scenes=bpy_data["scenes"];var speakers=bpy_data["speakers"];var textures=bpy_data["textures"];var storage=gen_datablocks_storage(bpy_data);for(var i=0;i<scenes.length;i++){var scene=scenes[i];var scene_objects=scene["objects"];for(var j=0;j<scene_objects.length;j++)make_link_uuid(scene_objects,j,storage);if(scene["camera"])make_link_uuid(scene,"camera",storage);if(scene["world"])make_link_uuid(scene,"world",storage)}for(var i=0;i<groups.length;i++){var group=groups[i];var group_objects=group["objects"];
for(var j=0;j<group_objects.length;j++)make_link_uuid(group_objects,j,storage)}for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj["dupli_group"])make_link_uuid(obj,"dupli_group",storage);if(obj["parent"])make_link_uuid(obj,"parent",storage);if(obj["animation_data"]){var adata=obj["animation_data"];if(adata["action"])make_link_uuid(adata,"action",storage);if(adata["nla_tracks"])for(var j=0;j<adata["nla_tracks"].length;j++){var track=adata["nla_tracks"][j];for(var k=0;k<track["strips"].length;k++)if(track["strips"][k]["action"])make_link_uuid(track["strips"][k],
"action",storage)}}switch(obj["type"]){case "MESH":if(!obj["data"])throw"mesh not found for object "+obj["name"];make_link_uuid(obj,"data",storage);var modifiers=obj["modifiers"];for(var j=0;j<modifiers.length;j++){var modifier=modifiers[j];if(modifier["type"]=="ARMATURE")make_link_uuid(modifier,"object",storage);else if(modifier["type"]=="CURVE")make_link_uuid(modifier,"object",storage)}var psystems=obj["particle_systems"];if(psystems)for(var j=0;j<psystems.length;j++){var psys=psystems[j];make_link_uuid(psys,
"settings",storage)}break;case "ARMATURE":make_link_uuid(obj,"data",storage);var pose=obj["pose"];var pose_bones=pose["bones"];var armature=obj["data"];var armature_bones=armature["bones"];for(var j=0;j<pose_bones.length;j++){var pose_bone=pose_bones[j];var bone_index=pose_bone["bone"];var armature_bone=armature_bones[bone_index];pose_bone["bone"]=armature_bone;var parent_recursive=pose_bone["parent_recursive"];for(var k=0;k<parent_recursive.length;k++){var parent_index=parent_recursive[k];parent_recursive[k]=
pose_bones[parent_index]}}break;case "LAMP":make_link_uuid(obj,"data",storage);break;case "CAMERA":make_link_uuid(obj,"data",storage);break;case "SPEAKER":make_link_uuid(obj,"data",storage);break;case "EMPTY":break;case "CURVE":make_link_uuid(obj,"data",storage);break;default:break}var constraints=obj["constraints"];if(constraints)for(var j=0;j<constraints.length;j++){var cons=constraints[j];if(cons["target"])make_link_uuid(cons,"target",storage)}}for(var i=0;i<meshes.length;i++){var mesh=meshes[i];
var mesh_materials=mesh["materials"];for(var j=0;j<mesh_materials.length;j++)make_link_uuid(mesh_materials,j,storage)}for(var i=0;i<materials.length;i++){var material=materials[i];var texture_slots=material["texture_slots"];for(var j=0;j<texture_slots.length;j++)make_link_uuid(texture_slots[j],"texture",storage);var node_tree=material["node_tree"];if(!node_tree)continue;var nodes=node_tree["nodes"];for(var j=0;j<nodes.length;j++){var node=nodes[j];if((node["type"]=="MATERIAL"||node["type"]=="MATERIAL_EXT")&&
node["material"])make_link_uuid(node,"material",storage);if(node["type"]=="TEXTURE"&&node["texture"])make_link_uuid(node,"texture",storage)}var links=node_tree["links"];for(var j=0;j<links.length;j++){var link=links[j];make_link_name(link,"from_node",nodes);make_link_name(link,"to_node",nodes);make_link_ident(link,"from_socket",link["from_node"]["outputs"]);make_link_ident(link,"to_socket",link["to_node"]["inputs"])}}for(var i=0;i<textures.length;i++){var texture=textures[i];var tex_type=texture["type"];
if(tex_type=="IMAGE"||tex_type=="ENVIRONMENT_MAP")make_link_uuid(texture,"image",storage)}for(var i=0;i<cameras.length;i++){var camera=cameras[i];if(camera["dof_object"])make_link_uuid(camera,"dof_object",storage)}for(var i=0;i<speakers.length;i++){var speaker=speakers[i];if(speaker["sound"])make_link_uuid(speaker,"sound",storage);if(speaker["animation_data"]&&speaker["animation_data"]["action"])make_link_uuid(speaker["animation_data"],"action",storage)}for(var i=0;i<particles.length;i++){var part=
particles[i];var texture_slots=part["texture_slots"];for(var j=0;j<texture_slots.length;j++)make_link_uuid(texture_slots[j],"texture",storage);if(part["dupli_group"])make_link_uuid(part,"dupli_group",storage);if(part["dupli_object"])make_link_uuid(part,"dupli_object",storage)}}function gen_datablocks_storage(bpy_data){var DB_NAMES=["actions","armatures","cameras","curves","groups","images","lamps","materials","meshes","objects","particles","scenes","sounds","speakers","textures","worlds"];var storage=
{};for(var i=0;i<DB_NAMES.length;i++){var db_arr=bpy_data[DB_NAMES[i]];for(var j=0;j<db_arr.length;j++){var db=db_arr[j];storage[db["uuid"]]=db}}return storage}function make_link_uuid(storage,prop,uuid_storage){var entity_new=uuid_storage[storage[prop]["uuid"]];if(!entity_new)m_print.error("Dangling link found:",prop,storage);storage[prop]=entity_new}function make_link_name(storage,property,search_here){var entity_old=storage[property];var entity_new=m_util.keysearch("name",entity_old["name"],search_here);
storage[property]=entity_new}function make_link_ident(storage,property,search_here){var entity_old=storage[property];var entity_new=m_util.keysearch("identifier",entity_old["identifier"],search_here);storage[property]=entity_new}function copy_link(from,to){for(var prop in from)if(!(prop in to))to[prop]=from[prop]}function load_textures(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){if(cfg_def.do_not_load_resources)return;var dir_path=dirname(scheduler.filepath);var images=bpy_data["images"];
var img_by_uri={};var image_assets=[];for(var i=0;i<images.length;i++){var image=images[i];var uuid=image["uuid"];if(image["source"]==="FILE"){var tex_users=find_image_users(image,bpy_data["textures"]);if(!tex_users.length){m_print.warn("B4W Warning: image ",image["name"]," has no users");continue}if(tex_users[0]["b4w_shore_dist_map"])continue;var image_path=normpath(dir_path+image["filepath"]);if(image._is_dds)var asset_type=m_assets.AT_ARRAYBUFFER;else var asset_type=m_assets.AT_IMAGE_ELEMENT;if(cfg_ldr.min50_available&&
cfg_def.use_min50){var head_ext=m_assets.split_extension(image_path);if(head_ext[1]=="dds"){var head_ext_wo_dds=m_assets.split_extension(head_ext[0]);image_path=head_ext_wo_dds[0]+".min50."+head_ext_wo_dds[1]+".dds"}else image_path=head_ext[0]+".min50."+head_ext[1]}image_assets.push([uuid,asset_type,image_path,image["name"]]);img_by_uri[uuid]=image}}if(image_assets.length){cb_param.image_counter=0;var asset_cb=function(image_data,uri,type,path){if(!image_data)return;var show_path_warning=true;print_image_info(image_data,
path,show_path_warning);var image=img_by_uri[uri];var tex_users=find_image_users(image,bpy_data["textures"]);for(var i=0;i<tex_users.length;i++){var tex_user=tex_users[i];var filepath=tex_user["image"]["filepath"];m_tex.update_texture(tex_user._render,image_data,image._is_dds,filepath)}var rate=++cb_param.image_counter/image_assets.length;cb_set_rate(scheduler,stage,rate)};var pack_cb=function(){m_print.log("%cLOADED ALL IMAGES","color: #0a0");cb_finish(scheduler,stage)};m_assets.enqueue(image_assets,
asset_cb,pack_cb)}else cb_finish(scheduler,stage)}function find_image_users(image,textures){var tex_image_users=[];for(var i=0;i<textures.length;i++){var tex=textures[i];if(tex["image"]===image)tex_image_users.push(tex)}return tex_image_users}function load_speakers(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){if(cfg_def.do_not_load_resources)return;var objects=get_all_objects(bpy_data);var dir_path=dirname(scheduler.filepath);var sound_assets=[];var spks_by_uuid={};for(var i=0;i<objects.length;i++){var obj=
objects[i];if(is_loaded_spk(obj)){var sound=obj["data"]["sound"];var uuid=sound["uuid"];if(m_sfx.get_spk_behavior(obj)=="BACKGROUND_MUSIC")uuid=m_util.gen_uuid();if(!(uuid in spks_by_uuid)){spks_by_uuid[uuid]=[];var sound_path=normpath(dir_path+sound["filepath"]);switch(m_sfx.source_type(obj)){case m_sfx.AST_ARRAY_BUFFER:var asset_type=m_assets.AT_AUDIOBUFFER;break;case m_sfx.AST_HTML_ELEMENT:var asset_type=m_assets.AT_AUDIO_ELEMENT;break}var head_ext=m_assets.split_extension(sound_path);var ext=
m_sfx.detect_media_container(head_ext[1]);if(ext!=head_ext[1])sound_path=head_ext[0]+".lossconv."+ext;else sound_path=head_ext[0]+"."+ext;sound_assets.push([uuid,asset_type,sound_path])}spks_by_uuid[uuid].push(obj)}}if(sound_assets.length){var asset_cb=function(sound_data,uuid,type,path){if(!sound_data)return;m_print.log("%cLOAD SOUND","color: #0aa",path);if(path.indexOf(_debug_resources_root)==-1)m_print.warn("B4W Warning: sound",path,"is not from app root");var spk_objs=spks_by_uuid[uuid];for(var i=
0;i<spk_objs.length;i++)m_sfx.update_spkobj(spk_objs[i],sound_data);var rate=++cb_param.sound_counter/sound_assets.length;cb_set_rate(scheduler,stage,rate)};var pack_cb=function(){m_print.log("%cLOADED ALL SOUNDS","color: #0aa");speakers_play(m_scenes.get_active());cb_finish(scheduler,stage)};m_assets.enqueue(sound_assets,asset_cb,pack_cb)}else cb_finish(scheduler,stage)}function is_loaded_spk(obj){if(m_sfx.is_speaker(obj)&&m_sfx.source_type(obj)!=m_sfx.AST_NONE)return true;else return false}function find_sound_users(sound,
objects){var spk_sound_users=[];for(var i=0;i<objects.length;i++){var obj=objects[i];if(is_loaded_spk(obj)&&obj["data"]["sound"]===sound)spk_sound_users.push(obj)}return spk_sound_users}function speakers_play(scene){var spk_objs=m_scenes.get_appended_objs(scene,"SPEAKER");for(var i=0;i<spk_objs.length;i++){var sobj=spk_objs[i];if(!m_sfx.is_speaker(sobj))continue;if(m_sfx.is_cyclic(sobj))m_sfx.play_def(sobj)}}function check_scene(bpy_scene){if(!bpy_scene["camera"])throw"Scene check failed: No camera";
var lamp_objs=m_scenes.combine_scene_objects(bpy_scene,"LAMP");if(!lamp_objs.length)throw"Scene check failed: No lamp";}function create_special_materials(bpy_data){var materials=bpy_data["materials"];var default_material=m_reformer.create_material("DEFAULT");materials.push(default_material)}function assign_default_material(material,meshes){for(var i=0;i<meshes.length;i++){var mesh=meshes[i];if(mesh["materials"].length==0)mesh["materials"].push(material)}}function prepare_actions(actions){for(var i=
0;i<actions.length;i++){var action=actions[i];m_anim.append_action(action)}}function prepare_lod_constraints(bpy_data){var scenes=bpy_data["scenes"];for(var i=0;i<scenes.length;i++){var scene=scenes[i];var added_objs=[];var removed_objs=[];var scene_objs=scenes[i]["objects"];for(var j=0;j<scene_objs.length;j++){var obj=scene_objs[j];prepare_obj_lod_constraints(scene_objs,obj,added_objs,removed_objs);var dupli_group=obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];for(var k=
0;k<dg_objects.length;k++){var dg_obj=dg_objects[k];prepare_obj_lod_constraints(dg_objects,dg_obj,added_objs,removed_objs)}}}for(var j=0;j<removed_objs.length;j++)remove_object(removed_objs[j],[scene]);for(var j=0;j<added_objs.length;j++)m_util.append_unique(added_objs[j][0],added_objs[j][1])}update_all_objects(bpy_data)}function prepare_obj_lod_constraints(container,obj,added_objs,removed_objs){var lods_num=get_lods_num(obj);var num=0;var constraints=obj["constraints"];for(var i=0;num<lods_num;i++){var cons=
constraints[i];if(!(cons["type"]=="LOCKED_TRACK"&&cons["target"]))continue;var lod_obj=cons["target"];var lod_obj_new=m_util.clone_object_nr(lod_obj);lod_obj_new["name"]=obj["name"]+"_LOD_"+String(num+1);added_objs.push([container,lod_obj_new]);removed_objs.push(lod_obj);cons["target"]=lod_obj_new;num++}}function prepare_hair_particles(bpy_data){var scenes=bpy_data["scenes"];for(var i=0;i<scenes.length;i++){var scene=scenes[i];var objects=m_scenes.combine_scene_objects(scene,"ALL");var removed_objs=
[];for(var j=0;j<objects.length;j++){var obj=objects[j];var psystems=obj["particle_systems"];for(var k=0;k<psystems.length;k++){var psys=psystems[k];var pset=psys["settings"];if(pset["type"]!="HAIR")continue;if(pset["render_type"]=="OBJECT")update_object(pset["dupli_object"]);else if(pset["render_type"]=="GROUP"){var dg=pset["dupli_group"];var empty_objs=m_scenes.combine_scene_objects(scene,"EMPTY");for(var n=0;n<empty_objs.length;n++)if(empty_objs[n]["dupli_group"]==dg)removed_objs.push(empty_objs[n]);
for(var n=0;n<dg["objects"].length;n++)update_object(dg["objects"][n])}else m_print.warn("B4W Warning: render type",pset["render_type"],"not supported for particle systems ("+pset["name"]+")")}}for(var j=0;j<removed_objs.length;j++)remove_object(removed_objs[j],[scene])}update_all_objects(bpy_data)}function calc_max_bones(objects){var upper_max_bones=-1;for(var i=0;i<objects.length;i++){var obj=objects[i];var render=obj._render;if(!(m_util.is_mesh(obj)&&render.is_skinning))continue;var max_bones=
render.max_bones;if(max_bones>upper_max_bones)upper_max_bones=max_bones}for(var i=0;i<objects.length;i++){var obj=objects[i];var render=obj._render;if(!(m_util.is_mesh(obj)&&render.is_skinning))continue;render.max_bones=upper_max_bones}}function prepare_lod_objects(objects){for(var i=0;i<objects.length;i++){var obj=objects[i];if(!m_util.is_mesh(obj))continue;var lods_num=get_lods_num(obj);if(!lods_num)continue;obj._render.last_lod=false;var prev_lod_dist_max=obj._render.lod_dist_max;var last_lod_cons_index=
0;for(var j=0;j<lods_num;j++){var lod_obj=get_lod_by_index(obj,j);lod_obj._render.lod_dist_min=prev_lod_dist_max;obj._render.last_lod=false;prev_lod_dist_max=lod_obj._render.lod_dist_max;last_lod_cons_index=j}get_lod_by_index(obj,last_lod_cons_index)._render.last_lod=true}}function get_lods_num(bpy_obj){return bpy_obj["b4w_lods_num"]}function get_lod_by_index(bpy_obj,index){var constraints=bpy_obj["constraints"];var num=0;for(var i=0;i<constraints.length;i++){var cons=constraints[i];if(cons["type"]==
"LOCKED_TRACK"){if(index===num)return cons["target"];num++}}return null}function prepare_vehicles(objects){for(var i=0;i<objects.length;i++){var obj_i=objects[i];if(!obj_i["b4w_vehicle"])continue;var vh_set_i=obj_i["b4w_vehicle_settings"];if(vh_set_i["part"]=="CHASSIS"){obj_i._vehicle={};obj_i._vehicle.force_max=vh_set_i["force_max"];obj_i._vehicle.brake_max=vh_set_i["brake_max"];obj_i._vehicle.suspension_compression=vh_set_i["suspension_compression"];obj_i._vehicle.suspension_stiffness=vh_set_i["suspension_stiffness"];
obj_i._vehicle.suspension_damping=vh_set_i["suspension_damping"];obj_i._vehicle.wheel_friction=vh_set_i["wheel_friction"];obj_i._vehicle.roll_influence=vh_set_i["roll_influence"];obj_i._vehicle.max_suspension_travel_cm=vh_set_i["max_suspension_travel_cm"];obj_i._vehicle.engine_force=0;obj_i._vehicle.brake_force=1;obj_i._vehicle.steering=0;obj_i._vehicle.speed=0;obj_i._vehicle.props=[];obj_i._vehicle.prop_offsets=[];obj_i._vehicle.steering_wheel=null;if(obj_i._dg_parent)var car_objects=obj_i._dg_parent["dupli_group"]["objects"];
else var car_objects=objects;for(var j=0;j<car_objects.length;j++){var obj_j=car_objects[j];if(!obj_j["b4w_vehicle"])continue;var vh_set_j=obj_j["b4w_vehicle_settings"];if(m_phy.is_car_wheel(obj_j)&&vh_set_i["name"]==vh_set_j["name"]){var w_index=m_phy.wheel_index(obj_j["b4w_vehicle_settings"]["part"]);obj_i._vehicle.props[w_index]=obj_j;obj_i._vehicle.prop_offsets[w_index]=new Float32Array(8)}else if(m_phy.is_vehicle_steering_wheel(obj_j)&&vh_set_i["name"]==vh_set_j["name"]){obj_i._vehicle.steering_wheel=
obj_j;obj_i._vehicle.steering_max=vh_set_j["steering_max"];obj_i._vehicle.steering_ratio=vh_set_j["steering_ratio"];obj_i._vehicle.inverse_control=vh_set_j["inverse_control"];var wm_inv=m_mat4.invert(obj_i._render.world_matrix,new Float32Array(16));var steering_wheel_matrix=m_mat4.multiply(wm_inv,obj_j._render.world_matrix,wm_inv);obj_i._vehicle.steering_wheel_matrix=steering_wheel_matrix;var steering_wheel_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(steering_wheel_axis,steering_wheel_matrix,
steering_wheel_axis);obj_i._vehicle.steering_wheel_axis=steering_wheel_axis}else if(m_phy.is_vehicle_speedometer(obj_j)&&vh_set_i["name"]==vh_set_j["name"]){obj_i._vehicle.speedometer=obj_j;obj_i._vehicle.speed_ratio=vh_set_j["speed_ratio"];obj_i._vehicle.max_speed_angle=vh_set_j["max_speed_angle"];var wm_inv=m_mat4.invert(obj_i._render.world_matrix,new Float32Array(16));var speedometer_matrix=m_mat4.multiply(wm_inv,obj_j._render.world_matrix,wm_inv);obj_i._vehicle.speedometer_matrix=speedometer_matrix;
var speedometer_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(speedometer_axis,speedometer_matrix,speedometer_axis);obj_i._vehicle.speedometer_axis=speedometer_axis}else if(m_phy.is_vehicle_tachometer(obj_j)&&vh_set_i["name"]==vh_set_j["name"]){obj_i._vehicle.tachometer=obj_j;obj_i._vehicle.delta_tach_angle=vh_set_j["delta_tach_angle"];var wm_inv=m_mat4.invert(obj_i._render.world_matrix,new Float32Array(16));var tachometer_matrix=m_mat4.multiply(wm_inv,obj_j._render.world_matrix,wm_inv);obj_i._vehicle.tachometer_matrix=
tachometer_matrix;var tachometer_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(tachometer_axis,tachometer_matrix,tachometer_axis);obj_i._vehicle.tachometer_axis=tachometer_axis}}if(obj_i._vehicle.props.length!=4)throw"Not enough wheels for chassis "+obj_i["name"];}else if(vh_set_i["part"]=="HULL"){obj_i._vehicle={};obj_i._vehicle.props=[];obj_i._vehicle.prop_offsets=[];obj_i._vehicle.force_max=vh_set_i["force_max"];obj_i._vehicle.brake_max=vh_set_i["brake_max"];obj_i._vehicle.floating_factor=
vh_set_i["floating_factor"];obj_i._vehicle.water_lin_damp=vh_set_i["water_lin_damp"];obj_i._vehicle.water_rot_damp=vh_set_i["water_rot_damp"];obj_i._vehicle.engine_force=0;obj_i._vehicle.brake_force=1;obj_i._vehicle.steering=0;obj_i._vehicle.speed=0;obj_i._vehicle.steering_wheel=null;if(obj_i._dg_parent)var boat_objects=obj_i._dg_parent["dupli_group"]["objects"];else var boat_objects=objects;for(var j=0;j<boat_objects.length;j++){var obj_j=boat_objects[j];if(!obj_j["b4w_vehicle"])continue;var vh_set_j=
obj_j["b4w_vehicle_settings"];if(m_phy.is_boat_bob(obj_j)&&vh_set_i["name"]==vh_set_j["name"]){obj_i._vehicle.props.push(obj_j);obj_i._vehicle.prop_offsets.push(new Float32Array(8))}else if(m_phy.is_vehicle_steering_wheel(obj_j)&&vh_set_i["name"]==vh_set_j["name"]){obj_i._vehicle.steering_wheel=obj_j;obj_i._vehicle.steering_max=vh_set_j["steering_max"];obj_i._vehicle.steering_ratio=vh_set_j["steering_ratio"];obj_i._vehicle.inverse_control=vh_set_j["inverse_control"];var wm_inv=m_mat4.invert(obj_i._render.world_matrix,
new Float32Array(16));var steering_wheel_matrix=m_mat4.multiply(wm_inv,obj_j._render.world_matrix,wm_inv);obj_i._vehicle.steering_wheel_matrix=steering_wheel_matrix;var steering_wheel_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(steering_wheel_axis,steering_wheel_matrix,steering_wheel_axis);obj_i._vehicle.steering_wheel_axis=steering_wheel_axis}else if(m_phy.is_vehicle_speedometer(obj_j)&&vh_set_i["name"]==vh_set_j["name"]){obj_i._vehicle.speedometer=obj_j;obj_i._vehicle.speed_ratio=vh_set_j["speed_ratio"];
obj_i._vehicle.max_speed_angle=vh_set_j["max_speed_angle"];var wm_inv=m_mat4.invert(obj_i._render.world_matrix,new Float32Array(16));var speedometer_matrix=m_mat4.multiply(wm_inv,obj_j._render.world_matrix,wm_inv);obj_i._vehicle.speedometer_matrix=speedometer_matrix;var speedometer_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(speedometer_axis,speedometer_matrix,speedometer_axis);obj_i._vehicle.speedometer_axis=speedometer_axis}else if(m_phy.is_vehicle_tachometer(obj_j)&&vh_set_i["name"]==
vh_set_j["name"]){obj_i._vehicle.tachometer=obj_j;obj_i._vehicle.delta_tach_angle=vh_set_j["delta_tach_angle"];var wm_inv=m_mat4.invert(obj_i._render.world_matrix,new Float32Array(16));var tachometer_matrix=m_mat4.multiply(wm_inv,obj_j._render.world_matrix,wm_inv);obj_i._vehicle.tachometer_matrix=tachometer_matrix;var tachometer_axis=new Float32Array([1,0,0,0]);m_vec4.transformMat4(tachometer_axis,tachometer_matrix,tachometer_axis);obj_i._vehicle.tachometer_axis=tachometer_axis}}}}}function prepare_floaters(objects){for(var i=
0;i<objects.length;i++){var obj_i=objects[i];if(!obj_i["b4w_floating"])continue;var fl_set_i=obj_i["b4w_floating_settings"];if(fl_set_i["part"]=="MAIN_BODY"){obj_i._floater={};obj_i._floater.floating_factor=fl_set_i["floating_factor"];obj_i._floater.water_lin_damp=fl_set_i["water_lin_damp"];obj_i._floater.water_rot_damp=fl_set_i["water_rot_damp"];obj_i._floater.bobs=[];if(obj_i._dg_parent)var bob_objects=obj_i._dg_parent["dupli_group"]["objects"];else var bob_objects=objects;for(var j=0;j<bob_objects.length;j++){var obj_j=
bob_objects[j];if(!obj_j["b4w_floating"])continue;var fl_set_j=obj_j["b4w_floating_settings"];if(m_phy.is_floater_bob(obj_j)&&fl_set_i["name"]==fl_set_j["name"]){obj_i._floater.bobs.push(obj_j);obj_j.bob_synchronize_pos=obj_j["b4w_floating_settings"]["synchronize_position"]}}}}}function remove_object(remobj,scenes){for(var i=0;i<scenes.length;i++){var scene_objs=scenes[i]["objects"];for(var j=0;j<scene_objs.length;j++){var obj=scene_objs[j];var dupli_group=obj["dupli_group"];if(dupli_group){var dg_objects=
dupli_group["objects"];obj_index=dg_objects.indexOf(remobj);if(obj_index>-1)dg_objects.splice(obj_index,1)}}var obj_index=scene_objs.indexOf(remobj);if(obj_index>-1)scene_objs.splice(obj_index,1)}}function remove_orphan_meshes(root_objects,meshes){var orphans=meshes.slice(0);for(var i=0;i<root_objects.length;i++){var obj=root_objects[i];if(obj["type"]!="MESH")continue;var mesh=obj["data"];var index=orphans.indexOf(mesh);if(index>-1)orphans.splice(index,1)}for(var i=0;i<orphans.length;i++){var orphan=
orphans[i];meshes.splice(meshes.indexOf(orphan),1)}}function update_object(obj){obj._render=m_util.create_render(obj["type"]==="MESH"?get_mesh_obj_render_type(obj):obj["type"]);obj._constraint=null;obj._descends=[];var render=obj._render;var pos=obj["location"];var scale=obj["scale"][0];var rot=_quat4_tmp;quat_bpy_b4w(obj["rotation_quaternion"],rot);m_trans.set_translation(obj,pos);m_trans.set_rotation(obj,rot);m_trans.set_scale(obj,scale);switch(obj["type"]){case "ARMATURE":var pose_bones=obj["pose"]["bones"];
for(var i=0;i<pose_bones.length;i++){var pose_bone=pose_bones[i];var arm_bone=pose_bone["bone"];var mat_loc=new Float32Array(arm_bone["matrix_local"]);var mat_loc_inv=new Float32Array(16);m_mat4.invert(mat_loc,mat_loc_inv);var mat_bas=new Float32Array(pose_bone["matrix_basis"]);var tail=new Float32Array(3);m_vec3.subtract(arm_bone["tail_local"],arm_bone["head_local"],tail);m_util.vecdir_multiply_matrix(tail,mat_loc_inv,tail);pose_bone._tail=tail;pose_bone._chain=[pose_bone].concat(pose_bone["parent_recursive"]);
pose_bone._tsr_local=m_tsr.from_mat4(mat_loc,m_tsr.create());pose_bone._tsr_basis=m_tsr.from_mat4(mat_bas,m_tsr.create());pose_bone._tsr_channel_cache=m_tsr.create();pose_bone._tsr_channel_cache_valid=false}var bone_pointers=m_anim.calc_armature_bone_pointers(obj);render.bone_pointers=bone_pointers;var pose_data=m_anim.calc_pose_data(obj,bone_pointers);render.quats_before=pose_data.quats;render.quats_after=pose_data.quats;render.trans_before=pose_data.trans;render.trans_after=pose_data.trans;render.frame_factor=
0;break;case "MESH":render.selectable=cfg_def.all_objs_selectable||obj["b4w_selectable"];render.origin_selectable=obj["b4w_selectable"];render.glow_anim_settings={glow_duration:obj["b4w_glow_settings"]["glow_duration"],glow_period:obj["b4w_glow_settings"]["glow_period"],glow_relapses:obj["b4w_glow_settings"]["glow_relapses"]};if(render.selectable){obj._color_id=gen_color_id(_color_id_counter);_color_id_counter++}prepare_skinning_info(obj);prepare_vertex_anim(obj);var armobj=m_anim.get_first_armature_object(obj);
if(armobj){var bone_pointers=obj._render.bone_pointers;var pose_data=m_anim.calc_pose_data(armobj,bone_pointers);render.quats_before=pose_data.quats;render.quats_after=pose_data.quats;render.trans_before=pose_data.trans;render.trans_after=pose_data.trans;render.frame_factor=0}obj._batches=[];render.shadow_cast=obj["b4w_shadow_cast"];render.shadow_receive=obj["b4w_shadow_receive"];render.shadow_cast_only=obj["b4w_shadow_cast_only"]&&render.shadow_cast;render.reflexible=obj["b4w_reflexible"];render.reflexible_only=
obj["b4w_reflexible_only"]&&render.reflexible;render.reflective=obj["b4w_reflective"];render.caustics=obj["b4w_caustics"];render.wind_bending=obj["b4w_wind_bending"];render.wind_bending_angle=obj["b4w_wind_bending_angle"];var amp=m_batch.wb_angle_to_amp(obj["b4w_wind_bending_angle"],m_batch.bb_bpy_to_b4w(obj["data"]["b4w_bounding_box"]),obj["scale"][0]);render.wind_bending_amp=amp;render.wind_bending_freq=obj["b4w_wind_bending_freq"];render.detail_bending_freq=obj["b4w_detail_bending_freq"];render.detail_bending_amp=
obj["b4w_detail_bending_amp"];render.branch_bending_amp=obj["b4w_branch_bending_amp"];render.hide=false;render.main_bend_col=obj["b4w_main_bend_stiffness_col"];var bnd_st=obj["b4w_detail_bend_colors"];render.detail_bend_col={};render.detail_bend_col.leaves_stiffness=bnd_st["leaves_stiffness_col"];render.detail_bend_col.leaves_phase=bnd_st["leaves_phase_col"];render.detail_bend_col.overall_stiffness=bnd_st["overall_stiffness_col"];render.dynamic_grass=false;render.do_not_cull=obj["b4w_do_not_cull"];
render.disable_fogging=obj["b4w_disable_fogging"];render.dynamic_geometry=obj["b4w_dynamic_geometry"];var first_mat=first_mesh_material(obj);render.friction=first_mat["physics"]["friction"];render.elasticity=first_mat["physics"]["elasticity"];render.lod_dist_min=0;render.lod_dist_max=obj["b4w_lod_distance"];if(DEBUG_LOD_DIST_NOT_SET&&obj["b4w_lod_distance"]===1E4)m_print.warn('B4W Warning: object "'+obj["name"]+'" has default LOD distance');render.last_lod=true;break;case "CAMERA":m_cam.camera_object_to_camera(obj);
m_cam.assign_boundings(obj);break;case "LAMP":m_lights.lamp_to_light(obj);break;case "CURVE":var spline=m_curve.create_spline(obj);if(spline)obj._spline=spline;break;case "SPEAKER":break;case "EMPTY":var bb=m_bounds.zero_bounding_box();render.bb_local=bb;var bs=m_bounds.zero_bounding_sphere();render.bs_local=bs;break;default:break}if(obj["parent"]&&(obj["parent_type"]=="OBJECT"&&obj["parent"]["type"]!="ARMATURE")){var trans=render.trans;var quat=render.quat;var scale=render.scale;m_cons.append_stiff_obj(obj,
obj["parent"],trans,quat,scale)}else if(obj["parent"]&&(obj["parent_type"]=="BONE"&&obj["parent"]["type"]=="ARMATURE")){var trans=render.trans;var quat=render.quat;m_cons.append_stiff_bone(obj,obj["parent"],obj["parent_bone"],trans,quat)}else if(obj._dg_parent&&obj._dg_parent["b4w_group_relative"]){var offset=m_tsr.create_sep(render.trans,render.scale,render.quat);m_cons.append_child_of(obj,obj._dg_parent,offset)}else if(obj._dg_parent&&!obj._dg_parent["b4w_group_relative"]){m_trans.update_transform(obj);
var wm=render.world_matrix;m_mat4.multiply(obj._dg_parent._render.world_matrix,wm,wm);var trans=m_util.matrix_to_trans(wm);var scale=m_util.matrix_to_scale(wm);var quat=m_util.matrix_to_quat(wm);m_trans.set_translation(obj,trans);m_trans.set_rotation(obj,quat);m_trans.set_scale(obj,scale)}if(obj["field"]){render.force_strength=obj["field"]["strength"];m_particles.update_force(obj)}var dupli_group=obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];for(var i=0;i<dg_objects.length;i++){var dg_obj=
dg_objects[i];dg_obj._dg_parent=obj}}render.use_collision_compound=obj["game"]["use_collision_compound"];render.physics_type=obj["game"]["physics_type"];m_trans.update_transform(obj)}function quat_bpy_b4w(quat,dest){var w=quat[0];var x=quat[1];var y=quat[2];var z=quat[3];dest[0]=x;dest[1]=y;dest[2]=z;dest[3]=w;return dest}function get_mesh_obj_render_type(bpy_obj){var is_animated=m_anim.is_animatable(bpy_obj);var has_do_not_batch=bpy_obj["b4w_do_not_batch"];var dynamic_geom=bpy_obj["b4w_dynamic_geometry"];
var has_anim_particles=m_particles.has_anim_particles(bpy_obj);var is_collision=bpy_obj["b4w_collision"];var is_vehicle_part=bpy_obj["b4w_vehicle"];var is_floater_part=bpy_obj["b4w_floating"];var dyn_grass_emitter=m_particles.has_dynamic_grass_particles(bpy_obj);if(DEBUG_DISABLE_BATCHING||(is_animated||(has_do_not_batch||(dynamic_geom||(has_anim_particles||(is_collision||(is_vehicle_part||(is_floater_part||(has_skydome_mat(bpy_obj)||(has_lens_flares_mat(bpy_obj)||dyn_grass_emitter))))))))))return"DYNAMIC";
else return"STATIC"}function has_skydome_mat(obj){var mesh=obj["data"];for(var i=0;i<mesh["materials"].length;i++)if(mesh["materials"][i]["b4w_skydome"])return true;return false}function has_lens_flares_mat(obj){var mesh=obj["data"];for(var i=0;i<mesh["materials"].length;i++)if(mesh["materials"][i]["name"]==="LENS_FLARES")return true;return false}function gen_color_id(counter){var counter=counter+1;if(counter>51*51*51)m_print.error("Color ID pool depleted");var r=Math.floor(counter/(51*51));counter%=
51*51;var g=Math.floor(counter/51);counter%=51;var b=counter;var color_id=[r/51,g/51,b/51];return color_id}function prepare_skinning_info(obj){if(obj["type"]!="MESH")throw"Wrong object type: "+obj["name"];var render=obj._render;var armobj=m_anim.get_first_armature_object(obj);if(!armobj){render.is_skinning=false;return}var mesh=obj["data"];if(mesh["vertex_groups"].length){render.is_skinning=true;var vertex_groups=mesh["vertex_groups"]}else{render.is_skinning=false;return}var bones=armobj["data"]["bones"];
var pose_bones=armobj["pose"]["bones"];var deform_bone_index=0;var bone_pointers={};for(var i=0;i<bones.length;i++){var bone=bones[i];var bone_name=bone["name"];var vgroup=m_util.keysearch("name",bone_name,vertex_groups);if(!vgroup)continue;var pose_bone_index=m_util.get_index_for_key_value(pose_bones,"name",bone_name);bone_pointers[bone_name]={bone_index:i,deform_bone_index:deform_bone_index++,pose_bone_index:pose_bone_index,vgroup_index:vgroup["index"]}}var num_bones=deform_bone_index;var max_bones=
cfg_def.max_bones;if(num_bones>2*max_bones)m_util.panic('B4W Error: too many bones for "'+obj["name"]);else if(num_bones>max_bones){m_print.warn('B4W Warning: too many bones for "'+obj["name"]+" / "+armobj["name"]+'": '+num_bones+" bones (max "+max_bones+"). Blending between frames will be disabled");render.frames_blending=false}else render.frames_blending=true;render.bone_pointers=bone_pointers;render.max_bones=num_bones}function prepare_vertex_anim(obj){if(obj["type"]!="MESH")throw"Wrong object type: "+
obj["name"];var render=obj._render;if(obj["data"]["b4w_vertex_anim"].length)render.vertex_anim=true;else render.vertex_anim=false}function first_mesh_material(obj){if(obj["type"]!=="MESH")throw"Wrong object";return obj["data"]["materials"][0]}function add_physics_objects(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];for(var j=0;j<ADD_PHY_TYPES.length;j++){var type=ADD_PHY_TYPES[j];var sobjs=m_scenes.get_scene_objs(scene,
type);for(var k=0;k<sobjs.length;k++){var obj=sobjs[k];if(cfg_phy.enabled&&scene["b4w_enable_physics"])m_phy.append_object(obj,scene)}}}cb_finish(scheduler,stage)}function load_shoremap(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){var img_by_uri={};var image_assets=[];var bpy_scenes=bpy_data["scenes"];for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_scenes[i];if(scene._render.water_params){var image=scene._render.water_params.shoremap_image;if(image&&image["source"]==="FILE"){var uuid=
image["uuid"];var dir_path=dirname(scheduler.filepath);var image_path=normpath(dir_path+image["filepath"]);if(image._is_dds)var asset_type=m_assets.AT_ARRAYBUFFER;else var asset_type=m_assets.AT_IMAGE_ELEMENT;image_assets.push([uuid,asset_type,image_path,image["name"]]);img_by_uri[uuid]=image}}}if(image_assets.length){var asset_cb=function(html_image,uri,type,path){if(!html_image)return;var show_path_warning=true;print_image_info(html_image,path,show_path_warning);var image=img_by_uri[uri];var tex_users=
find_image_users(image,bpy_data["textures"]);for(var i=0;i<tex_users.length;i++){var tex_user=tex_users[i];var filepath=tex_user["image"]["filepath"];m_tex.update_texture(tex_user._render,html_image,image._is_dds,filepath)}for(var i=0;i<bpy_scenes.length;i++){var scene=bpy_scenes[i];var shr_image=scene._render.water_params.shoremap_image;if(shr_image===image)update_scene_shore_distance(html_image,image,scene)}};var pack_cb=function(){cb_finish(scheduler,stage)};m_assets.enqueue(image_assets,asset_cb,
pack_cb)}else cb_finish(scheduler,stage)}function update_scene_shore_distance(html_image,shoremap,scene){var tmpcanvas=document.createElement("canvas");var width=shoremap.size[0];var height=shoremap.size[1];tmpcanvas.width=width;tmpcanvas.height=height;var ctx=tmpcanvas.getContext("2d");ctx.drawImage(html_image,0,0);var image_data=ctx.getImageData(0,0,width,height);var dist_color=image_data.data;var bit_shift=new Float32Array(4);bit_shift[0]=1/(255*255*255);bit_shift[1]=1/(255*255);bit_shift[2]=1/
255;bit_shift[3]=1;var arr_size=width*height;var shore_distances=new Float32Array(arr_size);for(var j=0;j<arr_size;j++)shore_distances[j]=bit_shift[1]*dist_color[4*j+2]+bit_shift[2]*dist_color[4*j+3];scene._render.shore_distances=shore_distances}function load_smaa_textures(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){if(!cfg_def.antialiasing||!cfg_def.smaa){cb_finish(scheduler,stage);return}var scene=bpy_data["scenes"][0];var subs_smaa_arr=[];var smaa_passes_names=["SMAA_EDGE_DETECTION",
"SMAA_BLENDING_WEIGHT_CALCULATION","SMAA_NEIGHBORHOOD_BLENDING","SMAA_RESOLVE"];for(var i=0;i<smaa_passes_names.length;i++){var smaa_sub=m_scenes.get_subs(scene,smaa_passes_names[i]);if(smaa_sub)subs_smaa_arr.push(smaa_sub)}if(!subs_smaa_arr.length){cb_finish(scheduler,stage);return}var smaa_images=[];var dir_path=dirname(scheduler.filepath);var asset_type=m_assets.AT_IMAGE_ELEMENT;var search_texture_path=m_cfg.paths.smaa_search_texture_path;smaa_images.push(["SEARCH_TEXTURE",asset_type,search_texture_path,
"smaa_search_texture"]);var area_texture_path=m_cfg.paths.smaa_area_texture_path;smaa_images.push(["AREA_TEXTURE",asset_type,area_texture_path,"smaa_area_texture"]);for(var i=0;i<subs_smaa_arr.length;i++){var subs_smaa=subs_smaa_arr[i];if(subs_smaa.type=="SMAA_BLENDING_WEIGHT_CALCULATION"){var slinks_internal=subs_smaa.slinks_internal;for(var j=0;j<slinks_internal.length;j++){var slink=slinks_internal[j];if(slink.to=="u_search_tex")var search_texture=slink.texture;else if(slink.to=="u_area_tex")var area_texture=
slink.texture}break}}if(smaa_images.length){var asset_cb=function(image_data,uri,type,path){if(!image_data)return;var show_path_warning=false;print_image_info(image_data,path,show_path_warning);if(uri=="SEARCH_TEXTURE")var texture=search_texture;else var texture=area_texture;texture.source="IMAGE";texture.auxilary_texture=true;var is_dds=path.indexOf(".dds")!=-1?1:0;m_tex.update_texture(texture,image_data,is_dds,path);m_tex.set_filters(texture,m_tex.TF_LINEAR,m_tex.TF_LINEAR)};var pack_cb=function(){cb_finish(scheduler,
stage)};m_assets.enqueue(smaa_images,asset_cb,pack_cb)}else cb_finish(scheduler,stage)}function prepare_objects_adding(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];if(scene["b4w_load_empty"])continue;for(var j=0;j<ADD_TYPES.length;j++){var type=ADD_TYPES[j];var sobjs=m_scenes.get_scene_objs(scene,type);for(var k=0;k<sobjs.length;k++){var obj=sobjs[k];if(!(m_util.is_armature(obj)&&obj["proxy"]))cb_param.added_objects.push({scene:scene,
obj:obj,type:"obj"})}}for(var j=0;j<ADD_SFX_TYPES.length;j++){var type=ADD_SFX_TYPES[j];var sobjs=m_scenes.get_scene_objs(scene,type);for(var k=0;k<sobjs.length;k++){var obj=sobjs[k];if(scene["b4w_enable_audio"])cb_param.added_objects.push({scene:scene,obj:obj,type:"sfx_obj"})}}}}function add_objects(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){var obj_data=cb_param.added_objects;var obj_counter=cb_param.obj_counter;if(!obj_data)var rate=1;else{var type=obj_data[obj_counter].type;var obj=
obj_data[obj_counter].obj;var scene=obj_data[obj_counter].scene;switch(type){case "obj":m_scenes.append_object(scene,obj);break;case "sfx_obj":m_sfx.append_object(obj,scene);break}var rate=++cb_param.obj_counter/obj_data.length}cb_set_rate(scheduler,stage,rate)}function end_objects_adding(bpy_data,scheduler,stage,cb_param,cb_finish,cb_set_rate){for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];m_scenes.prepare_rendering(scene);if(scene["b4w_use_nla"])m_nla.update_scene_nla(scene,
scene["b4w_nla_cyclic"])}var scene0=bpy_data["scenes"][0];m_scenes.set_active(scene0);var objects=get_all_objects(bpy_data);update_objects_dynamics(objects);cb_finish(scheduler,stage)}function update_objects_dynamics(objects){var anim_arms=[];for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj._render&&(obj._render.type=="DYNAMIC"||obj._render.type=="CAMERA"))m_trans.update_transform(obj);if(obj["b4w_use_default_animation"]&&m_anim.is_animatable(obj)){m_anim.apply_def(obj);if(obj["b4w_cyclic_animation"])m_anim.cyclic(obj,
true);if(m_util.is_armature(obj))anim_arms.push(obj);m_anim.play(obj)}}if(!anim_arms.length)return;for(var i=0;i<objects.length;i++){var obj=objects[i];if(m_util.is_mesh(obj)&&(!obj["b4w_use_default_animation"]&&m_anim.is_animatable(obj)))for(var j=0;j<anim_arms.length;j++){var armobj=anim_arms[j];if(m_anim.get_first_armature_object(obj)==armobj){m_anim.apply_def(obj);m_anim.cyclic(obj,m_anim.is_cyclic(armobj));m_anim.play(obj)}}}}function cleanup_meshes(objects){for(var i=0;i<objects.length;i++){var obj=
objects[i];if(obj["type"]!="MESH")continue;var mesh=obj["data"];delete mesh["submeshes"]}}function dirname(path){var dirname=path.split("/").slice(0,-1).join("/");if(dirname)dirname+="/";return dirname}function normpath(path){var sep="/";var empty="";var dot=".";var dotdot="..";if(path==empty)return dot;var initial_slashes=path.indexOf(sep)==0|0;if(initial_slashes&&(path.indexOf(sep+sep)==0&&path.indexOf(sep+sep+sep)!=0))initial_slashes=2;var comps=path.split(sep);var new_comps=[];for(var i=0;i<comps.length;i++){var comp=
comps[i];if(comp==empty||comp==dot)continue;if(comp!=dotdot||(!initial_slashes&&!new_comps.length||new_comps.length&&new_comps[new_comps.length-1]==dotdot))new_comps.push(comp);else if(new_comps.length)new_comps.pop()}comps=new_comps;path=comps.join(sep);for(var i=0;i<initial_slashes;i++)path=sep+path;return path||dot}exports.load=function(path,loaded_cb,stageload_cb,wait_complete_loading){var stages={"load_main":{priority:m_loader.ASYNC_PRIORITY,background_loading:false,inputs:[],is_resource:false,
relative_size:500,cb_before:load_main},"duplicate_objects":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["load_main"],is_resource:false,relative_size:50,cb_before:duplicate_objects},"load_binaries":{priority:m_loader.ASYNC_PRIORITY,background_loading:false,inputs:["load_main"],is_resource:false,relative_size:500,cb_before:load_binaries},"prepare_bindata":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["duplicate_objects","load_binaries"],is_resource:false,relative_size:0,
cb_before:prepare_bindata},"prepare_root_datablocks":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["duplicate_objects","prepare_bindata"],is_resource:false,relative_size:150,cb_before:prepare_root_datablocks},"prepare_root_scenes":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["prepare_root_datablocks"],is_resource:false,relative_size:350,cb_before:prepare_root_scenes},"load_smaa_textures":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["prepare_root_scenes"],
is_resource:false,relative_size:10,cb_before:load_smaa_textures},"load_shoremap":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["prepare_root_scenes"],is_resource:false,relative_size:10,cb_before:load_shoremap},"load_textures":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["prepare_root_scenes"],is_resource:true,relative_size:500,cb_before:load_textures,cb_param:{image_counter:0}},"add_physics_objects":{priority:m_loader.SYNC_PRIORITY,background_loading:false,
inputs:["load_shoremap"],is_resource:false,relative_size:20,cb_before:add_physics_objects},"add_objects":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["add_physics_objects"],is_resource:false,relative_size:800,cb_before:prepare_objects_adding,cb_loop:add_objects,cb_after:end_objects_adding,cb_param:{added_objects:[],obj_counter:0}},"load_speakers":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["add_objects"],is_resource:true,relative_size:30,cb_before:load_speakers,
cb_param:{sound_counter:0}}};_scheduler=m_loader.create_scheduler(stages,path,loaded_cb,stageload_cb,free_load_data,wait_complete_loading,cfg_def.do_not_load_resources)};exports.unload=function(){m_print.log("%cUNLOAD","color: #00a");var scheduler=get_scheduler();if(!scheduler||!scheduler.filepath)return;m_anim.cleanup();m_sfx.cleanup();m_nla.cleanup();m_scenes.cleanup();m_lights.cleanup();m_phy.cleanup();m_util.cleanup();m_render.cleanup();m_nodemat.cleanup();m_shaders.cleanup();m_ctl.cleanup();
m_ext.cleanup();m_assets.cleanup();m_particles.cleanup();_all_objects_cache=null;_scheduler=null;_color_id_counter=0};exports.set_debug_resources_root=function(debug_resources_root){_debug_resources_root=debug_resources_root};function get_all_objects(bpy_data){if(!_all_objects_cache)update_all_objects(bpy_data);return _all_objects_cache}function update_all_objects(bpy_data){var scenes=bpy_data["scenes"];var object_levels=[];for(var i=0;i<scenes.length;i++){var scene_objs=scenes[i]["objects"];update_all_objects_iter(scene_objs,
0,object_levels)}_all_objects_cache=[];for(var i=0;i<object_levels.length;i++){var grp_level=object_levels[i];for(var j=0;j<grp_level.length;j++){var par_level=grp_level[j];for(var k=0;k<par_level.length;k++)_all_objects_cache.push(par_level[k])}}}function update_all_objects_iter(objects,grp_num,object_levels){object_levels[grp_num]=object_levels[grp_num]||[];var group_level=object_levels[grp_num];for(var i=0;i<objects.length;i++){var obj=objects[i];var pnum=parent_num(obj);group_level[pnum]=group_level[pnum]||
[];if(group_level[pnum].indexOf(obj)==-1)group_level[pnum].push(obj);var dupli_group=obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];update_all_objects_iter(dg_objects,grp_num+1,object_levels)}}}function parent_num(obj){var par=obj["parent"];if(par)return 1+parent_num(par);else return 0}function set_bpy_data(bpy_data){_bpy_data=bpy_data}function get_bpy_data(){return _bpy_data}};b4w.module["__batch"]=function(exports,require){var boundings=require("__boundings");var config=require("__config");var m_print=require("__print");var extensions=require("__extensions");var geometry=require("__geometry");var m_graph=require("__graph");var nodemat=require("__nodemat");var particles=require("__particles");var primitives=require("__primitives");var scenegraph=require("__scenegraph");var shaders=require("__shaders");var m_textures=require("__textures");var m_tsr=require("__tsr");var util=
require("__util");var m_vec3=require("vec3");var m_vec4=require("vec4");var m_quat=require("quat");var cfg_def=config.defaults;var cfg_scs=config.scenes;var DEBUG_SAVE_SUBMESHES=false;var DEBUG_KEEP_BUFS_DATA_ARRAYS=false;var BATCH_TYPES_DEBUG_SPHERE=["MAIN","NODES","SHADELESS"];var STREE_CELL_COUNT=20;function init_batch(type){var batch={type:type,textures:[],texture_names:[],common_attributes:[],uv_maps_usage:{},material_names:[],shaders_info:null,node_elements:null,num_vertices:0,num_triangles:0,
color_mask:true,depth_mask:true,use_backface_culling:false,draw_mode:geometry.DM_DEFAULT,blend:false,diffuse_color:new Float32Array([0,0,0,1]),zsort_type:geometry.ZSORT_DISABLED};batch.vertex_colors_usage={};return batch}exports.generate_main_batches=function(graph,grid_size,scene_objects,bpy_data){var dynamic_objects=[];var static_objects=[];for(var i=0;i<scene_objects.length;i++){var obj=scene_objects[i];switch(obj._render.type){case "DYNAMIC":dynamic_objects.push(obj);break;case "STATIC":static_objects.push(obj);
break}}var dyn_metabatches=make_dynamic_metabatches(dynamic_objects,graph);var stat_metabatches=make_static_metabatches(static_objects,graph,grid_size);for(var i=0;i<dyn_metabatches.length;i++)update_batch_geometry(dyn_metabatches[i].batch,dyn_metabatches[i].submesh);for(var i=0;i<stat_metabatches.length;i++)update_batch_geometry(stat_metabatches[i].batch,stat_metabatches[i].submesh);var meta_objects=[];for(var i=0;i<stat_metabatches.length;i++){var batch=stat_metabatches[i].batch;if(batch.type!==
"COLOR_ID"){var meta_obj=util.init_object(util.unique_name("%meta"),"MESH");meta_obj._render=stat_metabatches[i].render;meta_obj._batches=[batch];meta_objects.push(meta_obj)}}objects_attach_batches(stat_metabatches,["COLOR_ID"]);objects_attach_batches(dyn_metabatches);if(cfg_def.wireframe_debug){for(var i=0;i<dyn_metabatches.length;i++){var obj=dyn_metabatches[i].rel_objects[0];var render=dyn_metabatches[i].render;if(BATCH_TYPES_DEBUG_SPHERE.indexOf(dyn_metabatches[i].batch.type)>-1){var ds_batch=
create_bounding_ellipsoid_batch(render.be_local,render,obj.name,true);ds_batch.debug_sphere_dynamic=true;update_batch_render(ds_batch,render);obj._batches.push(ds_batch)}}for(var i=0;i<meta_objects.length;i++){var obj=meta_objects[i];var render=obj._render;if(BATCH_TYPES_DEBUG_SPHERE.indexOf(obj._batches[0].type)>-1){var ds_batch=create_bounding_ellipsoid_batch(render.bs_local,render,obj.name,false);ds_batch.debug_sphere_dynamic=false;update_batch_render(ds_batch,render);obj._batches.push(ds_batch)}}}return meta_objects};
function make_dynamic_metabatches(dyn_objects,graph){var metabatches=[];for(var i=0;i<dyn_objects.length;i++){var obj=dyn_objects[i];var render=obj._render;var bb_local=bb_bpy_to_b4w(obj["data"]["b4w_bounding_box"]);render.bb_local=bb_local;var cyl_radius=obj["data"]["b4w_bounding_cylinder_radius"];set_local_cylinder_capsule(render,cyl_radius,cyl_radius,bb_local);var bb_world=boundings.bounding_box_transform(bb_local,render.world_matrix);render.bb_world=bb_world;var bs_local={radius:obj["data"]["b4w_bounding_sphere_radius"],
center:obj["data"]["b4w_bounding_sphere_center"]};render.bs_local=bs_local;var bs_world=boundings.bounding_sphere_transform(bs_local,render.world_matrix);render.bs_world=bs_world;var be_axes=obj["data"]["b4w_bounding_ellipsoid_axes"];var be_local={axis_x:new Float32Array([be_axes[0],0,0]),axis_y:new Float32Array([0,be_axes[1],0]),axis_z:new Float32Array([0,0,be_axes[2]]),center:obj["data"]["b4w_bounding_ellipsoid_center"]};render.be_local=be_local;var be_world=boundings.bounding_ellipsoid_transform(be_local,
render.tsr);render.be_world=be_world;var obj_metabatches=make_object_metabatches(obj,render,graph);obj_metabatches=merge_metabatches(obj_metabatches);metabatches.push.apply(metabatches,obj_metabatches)}return metabatches}function make_static_metabatches(static_objects,graph,grid_size){var metabatches=[];var clusters=create_object_clusters(static_objects,grid_size);for(var i=0;i<clusters.length;i++){var render=clusters[i].render;var objs=clusters[i].objects;for(var j=0;j<objs.length;j++){var obj=objs[j];
var obj_metabatches=make_object_metabatches(obj,render,graph);var tsr=tsr_from_render(obj._render)||tsr_from_render(render);var params={};if(render.wind_bending){params["au_center_pos"]=[tsr[0],tsr[1],tsr[2]];params["au_wind_bending_amp"]=[obj._render.wind_bending_amp];params["au_wind_bending_freq"]=[obj["b4w_wind_bending_freq"]];params["au_detail_bending_amp"]=[obj["b4w_detail_bending_amp"]];params["au_detail_bending_freq"]=[obj["b4w_detail_bending_freq"]];params["au_branch_bending_amp"]=[obj["b4w_branch_bending_amp"]]}for(var k=
0;k<obj_metabatches.length;k++){var metabatch_render=obj_metabatches[k].render;var submesh=obj_metabatches[k].submesh;if(!metabatch_render.is_hair_particles){submesh=geometry.submesh_apply_transform(submesh,tsr);submesh=geometry.submesh_apply_params(submesh,params)}else if(metabatch_render.hair_billboard)submesh=geometry.submesh_apply_particle_transform(submesh,tsr);else submesh=geometry.submesh_apply_transform(submesh,tsr)}metabatches.push.apply(metabatches,obj_metabatches)}for(var j=0;j<objs.length;j++){var obj=
objs[j];obj._dyn_render=obj._render;obj._render=render}}return merge_metabatches(metabatches)}function make_object_metabatches(obj,render,graph){var metabatches=[];if(obj["b4w_do_not_render"])return metabatches;var batch_types=get_batch_types(graph,render);var render_id=calc_render_id(render);var mesh=obj["data"];var materials=mesh["materials"];for(var i=0;i<batch_types.length;i++){var type=batch_types[i];for(var j=0;j<materials.length;j++){if(geometry.has_empty_submesh(mesh,j))continue;var batch=
init_batch(type);var material=materials[j];if(!update_batch_material(batch,material,true))continue;batch.draw_mode=mesh.draw_mode||geometry.DM_DEFAULT;if(type==="COLOR_ID")batch.color_id=new Float32Array(obj._color_id);update_batch_render(batch,render);update_batch_particle_systems(batch,obj["particle_systems"]);if(render.type=="DYNAMIC")batch.odd_id_prop=obj["uuid"];update_batch_id(batch,render_id);var submesh=geometry.extract_submesh(mesh,j,batch.common_attributes,batch.bone_pointers,batch.vertex_colors_usage,
batch.uv_maps_usage);if(material["name"]=="LENS_FLARES")submesh=particles.prepare_lens_flares(submesh);if(batch.material_names.indexOf(material["name"])==-1)batch.material_names.push(material["name"]);metabatches.push({batch:batch,submesh:submesh,render:render,rel_objects:[obj]})}}var psystems=obj["particle_systems"];if(psystems.length>0&&metabatches.length){var not_render_emitter=true;for(var i=0;i<psystems.length;i++){var psys=psystems[i];if(psys["settings"]["use_render_emitter"]){not_render_emitter=
false;break}}var em_batch=metabatches[0].batch;var em_submesh=metabatches[0].submesh;var particles_metabatches=make_particles_metabatches(obj,render,graph,render_id,em_batch,em_submesh);if(not_render_emitter)metabatches=particles_metabatches;else metabatches.push.apply(metabatches,particles_metabatches)}return metabatches}function make_particles_metabatches(obj,render,graph,render_id,em_batch,em_submesh){var metabatches=[];var psystems=obj["particle_systems"];var mesh=obj["data"];var materials=mesh["materials"];
for(var i=0;i<psystems.length;i++){var psys=psystems[i];var pset=psys["settings"];if(pset["type"]=="EMITTER"){if(render.type=="DYNAMIC"){var batch=init_batch("MAIN");var pmaterial=generate_particles_emitter_material(mesh,psys);update_batch_material(batch,pmaterial,true);var mat_index=psys["settings"]["material"]-1;pmaterial["texture_slots"]=materials[mat_index]["texture_slots"];update_batch_particles_emitter(batch,psys);update_batch_render(batch,render);batch.dynamic_geometry=true;batch.odd_id_prop=
pset["uuid"];update_batch_id(batch,render_id);batch.particle_system=psys;var submesh=particles.generate_emitter_particles_submesh(batch,mesh,psys,pmaterial,obj._render.world_matrix);if(batch.material_names.indexOf(pmaterial["name"])==-1)batch.material_names.push(pmaterial["name"]);metabatches.push({batch:batch,submesh:submesh,render:render,rel_objects:[obj]})}}else if(pset["type"]=="HAIR"){var seed=util.init_rand_r_seed(psys["seed"]);if(pset["b4w_dynamic_grass"])render.do_not_cull=true;if(psys["transforms"].length)var ptrans=
psys["transforms"];else{var points=geometry.geometry_random_points(em_submesh,pset["count"],false,seed);var ptrans=new Float32Array(points.length*4);for(var j=0;j<points.length;j++){var scale=0.75+0.5*util.rand_r(seed);ptrans[j*4]=points[j][0];ptrans[j*4+1]=points[j][1];ptrans[j*4+2]=points[j][2];ptrans[j*4+3]=scale}}var use_grass_map=scenegraph.find_subs(graph,"GRASS_MAP")?true:false;if(pset["render_type"]=="OBJECT"){var particles_batch_types=[get_batch_types(graph,pset["dupli_object"]._render)];
var hair_metabatches=make_hair_particles_metabatches(obj,render,em_batch,em_submesh,[pset["dupli_object"]],particles_batch_types,[ptrans],pset,psys,use_grass_map,seed,false);metabatches.push.apply(metabatches,hair_metabatches)}else if(pset["render_type"]=="GROUP"){var dg_objs=pset["dupli_group"]["objects"];var reset_seed=false;var particles_batch_types=[];for(var j=0;j<dg_objs.length;j++){var btypes=get_batch_types(graph,pset["dupli_group"]["objects"][j]._render);particles_batch_types.push(btypes)}if(pset["use_whole_group"]){var ptrans_dist=
distribute_ptrans_group(ptrans,dg_objs);reset_seed=true}else if(pset["use_group_count"])var ptrans_dist=distribute_ptrans_by_dupli_weights(ptrans,dg_objs,pset["dupli_weights"],seed);else var ptrans_dist=distribute_ptrans_equally(ptrans,dg_objs,seed);var hair_metabatches=make_hair_particles_metabatches(obj,render,em_batch,em_submesh,dg_objs,particles_batch_types,ptrans_dist,pset,psys,use_grass_map,seed,reset_seed);metabatches.push.apply(metabatches,hair_metabatches)}if(pset["b4w_wind_bend_inheritance"]==
"INSTANCE")obj._render.wind_bending_amp=0}else throw"Unknown particle settings type";}return metabatches}function merge_metabatches(metabatches){var merged_metabatches=[];var unique_data={};for(var i=0;i<metabatches.length;i++){var batch=metabatches[i].batch;if(!unique_data[batch.id])unique_data[batch.id]={batch:batch,render:metabatches[i].render,rel_objects:[],submeshes:[]};var arr=unique_data[batch.id].rel_objects;arr.push.apply(arr,metabatches[i].rel_objects);if(metabatches[i].submesh&&metabatches[i].submesh.base_length)unique_data[batch.id].submeshes.push(metabatches[i].submesh)}for(var id in unique_data){var submeshes=
unique_data[id].submeshes;if(submeshes.length==0)var submesh=util.create_empty_submesh(util.unique_name("%empty"));else if(submeshes.length==1)var submesh=submeshes[0];else{var short_submeshes=[];for(var i=0;i<submeshes.length;i++)if(!geometry.is_long_submesh(submeshes[i]))short_submeshes.push(i);if(short_submeshes.length<submeshes.length)for(var i=0;i<short_submeshes.length;i++)geometry.submesh_drop_indices(submeshes[short_submeshes[i]]);var submesh=geometry.submesh_list_join(submeshes)}var metabatch=
{batch:unique_data[id].batch,render:unique_data[id].render,submesh:submesh,rel_objects:unique_data[id].rel_objects};merged_metabatches.push(metabatch)}return merged_metabatches}function objects_attach_batches(metabatches,batch_types){for(var i=0;i<metabatches.length;i++){var batch=metabatches[i].batch;if(!batch_types||batch_types.indexOf(batch.type)>-1){var unique_obj_names=[];for(var j=0;j<metabatches[i].rel_objects.length;j++){var obj=metabatches[i].rel_objects[j];if(unique_obj_names.indexOf(obj.name)==
-1){append_batch(obj,batch);unique_obj_names.push(obj.name)}}}}}function append_batch(obj,new_batch){for(var i=0;i<obj._batches.length;i++){var batch=obj._batches[i];if(batch==new_batch)throw"Batch already exist in object";}obj._batches.push(new_batch)}function set_local_cylinder_capsule(render,cyl_radius,cap_radius,bb_local){render.bcyl_local=boundings.create_bounding_cylinder(cyl_radius,bb_local);render.bcap_local=boundings.create_bounding_capsule(cap_radius,bb_local);render.bcon_local=boundings.create_bounding_cone(cyl_radius,
bb_local)}exports.wb_angle_to_amp=wb_angle_to_amp;function wb_angle_to_amp(angle,bbox,scale){if(bbox)var height=scale*(bbox.max_y-bbox.min_y);else{var height=1;throw"No bounding box for mesh";}if(height==0)return 0;var delta=height*Math.tan(angle/180*Math.PI);var amp=Math.sqrt(2*Math.sqrt(4*delta+1)+2)/2-1;return 0.5*amp/height}exports.bb_bpy_to_b4w=bb_bpy_to_b4w;function bb_bpy_to_b4w(bpy_bb){var max_x=bpy_bb["max_x"];var max_y=bpy_bb["max_y"];var max_z=bpy_bb["max_z"];var min_x=bpy_bb["min_x"];
var min_y=bpy_bb["min_y"];var min_z=bpy_bb["min_z"];var bb={max_x:max_x,min_x:min_x,max_y:max_y,min_y:min_y,max_z:max_z,min_z:min_z};return bb}function exclude_batch_types(batch_types,unwanted_types){for(var i=0;i<unwanted_types.length;i++){var index=batch_types.indexOf(unwanted_types[i]);if(index!==-1)batch_types.splice(index,1)}return batch_types}function get_batch_types(graph,render){var batch_types=["SHADELESS","MAIN","NODES"];if(render.selectable&&(scenegraph.find_subs(graph,"COLOR_PICKING")||
scenegraph.find_subs(graph,"GLOW_MASK")))batch_types.push("COLOR_ID");if(scenegraph.find_subs(graph,"WIREFRAME"))batch_types.push("WIREFRAME");batch_types.push("PHYSICS");if(scenegraph.find_subs(graph,"DEPTH")||scenegraph.find_subs(graph,"SHADOW_CAST"))batch_types.push("DEPTH");if(scenegraph.find_subs(graph,"GRASS_MAP"))batch_types.push("GRASS_MAP");if(render.shadow_cast_only||render.reflexible_only){var unwanted_types=null;if(render.shadow_cast_only)unwanted_types=["SHADELESS","MAIN","NODES","COLOR_ID",
"PHYSICS","WIREFRAME"];if(render.reflexible_only){var types=["COLOR_ID","PHYSICS","DEPTH","WIREFRAME"];if(unwanted_types!==null)unwanted_types=util.array_intersect(unwanted_types,types);else unwanted_types=types}batch_types=exclude_batch_types(batch_types,unwanted_types)}return batch_types}exports.update_batch_material=update_batch_material;function update_batch_material(batch,material,update_tex_color){var ret;switch(batch.type){case "SHADELESS":ret=update_batch_material_shadeless(batch,material,
update_tex_color);break;case "MAIN":ret=update_batch_material_main(batch,material,update_tex_color);break;case "NODES":ret=update_batch_material_nodes(batch,material);break;case "DEPTH":ret=update_batch_material_depth(batch,material);break;case "PHYSICS":ret=update_batch_material_physics(batch,material);break;case "COLOR_ID":ret=update_batch_material_color_id(batch,material);break;case "GRASS_MAP":ret=update_batch_material_grass_map(batch,material);break;case "WIREFRAME":ret=update_batch_material_wireframe(batch,
material);break;default:throw"Wrong batch type: "+batch.type;}return ret}function update_batch_material_shadeless(batch,material,update_tex_color){if(material["b4w_collision"])return false;if(!material["use_shadeless"])return false;if(material["use_nodes"])return false;apply_shader(batch,"shadeless.glslv","shadeless.glslf");var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?
1:0);set_batch_c_attr(batch,"a_position");var texture_slots=material["texture_slots"];var colormap0=find_valid_textures("use_map_color_diffuse",true,texture_slots)[0];var colormap1=find_valid_textures("use_map_color_diffuse",true,texture_slots)[1];var stencil0=find_valid_textures("use_rgb_to_intensity",true,texture_slots)[0]&&find_valid_textures("use_stencil",true,texture_slots)[0];var diffuse_color=new Float32Array([material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],
material["alpha"]]);batch.diffuse_color=diffuse_color;if(colormap0){set_batch_directive(batch,"TEXTURE_COLOR",1);switch(colormap0["blend_type"]){case "MIX":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY");break}set_batch_c_attr(batch,"a_texcoord");if(colormap0["texture"]._render.source=="IMAGE"&&update_tex_color)var tex_col=[diffuse_color[0],diffuse_color[1],diffuse_color[2],
1];else if(colormap0["texture"]._render.source=="ENVIRONMENT_MAP"&&update_tex_color)var tex_col=[0.8,0.8,0.8,1];else var tex_col=null;var tex=get_batch_texture(colormap0,tex_col);append_texture(batch,tex,"u_colormap0");batch.diffuse_color_factor=colormap0["diffuse_color_factor"];batch.colormap0_uv_velocity=new Float32Array(colormap0["texture"]["b4w_uv_velocity_trans"]);batch.texture_scale=new Float32Array(colormap0["scale"])}if(colormap0&&(colormap1&&stencil0)){set_batch_directive(batch,"TEXTURE_STENCIL_ALPHA_MASK",
1);var tex_col=update_tex_color?[0.8,0.8,0.8,1]:null;var tex=get_batch_texture(colormap1,tex_col);append_texture(batch,tex,"u_colormap1");var tex_col=update_tex_color?[0.5,0.5,0.5,1]:null;var tex=get_batch_texture(stencil0,tex_col);append_texture(batch,tex,"u_stencil0")}if(material["use_vertex_color_paint"]){set_batch_directive(batch,"VERTEX_COLOR",1);set_batch_c_attr(batch,"a_color")}else set_batch_directive(batch,"VERTEX_COLOR",0);batch.offset_z=material["offset_z"];update_batch_game_settings(batch,
material);return true}function update_batch_material_main(batch,material,update_tex_color){if(material["b4w_collision"])return false;if(material["use_shadeless"])return false;if(material["use_nodes"])return false;batch.colormap0_uv_velocity=new Float32Array([0,0]);batch.normalmap_uv_velocities=new Array(4);for(var i=0;i<4;i++)batch.normalmap_uv_velocities[i]=new Float32Array([0,0]);update_batch_game_settings(batch,material);batch.offset_z=material["offset_z"];batch.texture_scale=new Float32Array([1,
1,1]);var texture_slots=material["texture_slots"];var diffuse_color=new Float32Array([material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"]]);switch(material["name"]){case "LENS_FLARES":apply_shader(batch,"special_lens_flares.glslv","special_lens_flares.glslf");set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_texcoord");var tex_col=update_tex_color?[1,1,1,0]:null;var tex=get_batch_texture(texture_slots[0],tex_col);append_texture(batch,
tex);break;case "PARTICLES":if(texture_slots.length==0)apply_shader(batch,"particles_color.glslv","particles_color.glslf");else{apply_shader(batch,"particles_texture.glslv","particles_texture.glslf");var tex=get_batch_texture(texture_slots[0]);if(tex)append_texture(batch,tex)}break;default:apply_shader(batch,"main.glslv","main.glslf");var colormap0=find_valid_textures("use_map_color_diffuse",true,texture_slots)[0];var specmap0=find_valid_textures("use_map_color_spec",true,texture_slots)[0];var normalmap0=
find_valid_textures("use_map_normal",true,texture_slots)[0];var mirrormap0=find_valid_textures("use_map_mirror",true,texture_slots)[0];var colormap1=find_valid_textures("use_map_color_diffuse",true,texture_slots)[1];var stencil0=find_valid_textures("use_rgb_to_intensity",true,texture_slots)[0]&&find_valid_textures("use_stencil",true,texture_slots)[0];if(colormap0){switch(colormap0["blend_type"]){case "MIX":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":set_batch_directive(batch,
"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY");break}if(colormap0["texture"]._render.source=="IMAGE"&&update_tex_color)var tex_col=[diffuse_color[0],diffuse_color[1],diffuse_color[2],1];else if(colormap0["texture"]._render.source=="ENVIRONMENT_MAP"&&update_tex_color)var tex_col=[0.8,0.8,0.8,1];else var tex_col=null;var tex=get_batch_texture(colormap0,tex_col);append_texture(batch,tex,"u_colormap0");batch.diffuse_color_factor=colormap0["diffuse_color_factor"];batch.colormap0_uv_velocity=new Float32Array(colormap0["texture"]["b4w_uv_velocity_trans"]);
batch.texture_scale=new Float32Array(colormap0["scale"])}var alpha_as_spec=colormap0&&colormap0==specmap0;if(specmap0){if(!alpha_as_spec){var tex_col=update_tex_color?[0.5,0.5,0.5,1]:null;var tex=get_batch_texture(specmap0,tex_col);append_texture(batch,tex,"u_specmap")}batch.specular_color_factor=specmap0["specular_color_factor"]}if(normalmap0){var tex_col=update_tex_color?[0.5,0.5,1,1]:null;var tex=get_batch_texture(normalmap0,tex_col);append_texture(batch,tex,"u_normalmap0");batch.normal_factor=
normalmap0["normal_factor"];batch.normalmap_uv_velocities[0].set(normalmap0["texture"]["b4w_uv_velocity_trans"])}if(mirrormap0){var tex_col=update_tex_color?[0,0,0.5,1]:null;var tex=get_batch_texture(mirrormap0,tex_col);append_texture(batch,tex,"u_mirrormap");batch.mirror_factor=mirrormap0["mirror_factor"]}else batch.mirror_factor=0;var TEXTURE_STENCIL_ALPHA_MASK=colormap0&&(colormap1&&stencil0)?1:0;if(TEXTURE_STENCIL_ALPHA_MASK){var tex_col=update_tex_color?[0.8,0.8,0.8,1]:null;var tex=get_batch_texture(colormap1,
tex_col);append_texture(batch,tex,"u_colormap1");var tex_col=update_tex_color?[0.5,0.5,0.5,1]:null;var tex=get_batch_texture(stencil0,tex_col);append_texture(batch,tex,"u_stencil0")}var some_tex=colormap0||(specmap0||normalmap0);if(some_tex)batch.texture_scale.set(some_tex["scale"]);set_batch_directive(batch,"TEXTURE_COLOR",colormap0==undefined?0:1);set_batch_directive(batch,"TEXTURE_SPEC",specmap0==undefined?0:1);set_batch_directive(batch,"TEXTURE_NORM",normalmap0==undefined?0:1);set_batch_directive(batch,
"TEXTURE_MIRROR",mirrormap0==undefined?0:1);set_batch_directive(batch,"ALPHA_AS_SPEC",alpha_as_spec?1:0);set_batch_directive(batch,"TEXTURE_STENCIL_ALPHA_MASK",TEXTURE_STENCIL_ALPHA_MASK);set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_normal");if(normalmap0){set_batch_c_attr(batch,"a_normal");set_batch_c_attr(batch,"a_tangent");var nm0tex=normalmap0["texture"];if(nm0tex["b4w_use_map_parallax"]&&cfg_def.parallax){var steps=shaders.glsl_value(nm0tex["b4w_parallax_steps"]);set_batch_directive(batch,
"PARALLAX",1);set_batch_directive(batch,"PARALLAX_STEPS",steps);batch.parallax_scale=nm0tex["b4w_parallax_scale"]}}if(colormap0||(specmap0||normalmap0))set_batch_c_attr(batch,"a_texcoord");if(material["b4w_water"]){var rslt=init_water_material(material,batch);batch.shaders_info=rslt.shaders_info;batch.common_attributes=rslt.common_attributes}if(material["b4w_skydome"]){apply_shader(batch,"special_skydome.glslv","special_skydome.glslf");if(material["b4w_procedural_skydome"])batch.procedural_sky=true;
else{var tex_col=update_tex_color?[0.07,0.13,0.58,1]:null;var tex=get_batch_texture(texture_slots[0],tex_col);append_texture(batch,tex,"u_sky");batch.procedural_sky=false}set_batch_c_attr(batch,"a_position");batch.offset_z=99999}if(material["type"]==="HALO"){var mat_halo=material["halo"];apply_shader(batch,"halo.glslv","halo.glslf");set_batch_directive(batch,"NUM_RINGS",mat_halo["ring_count"]);set_batch_directive(batch,"NUM_LINES",mat_halo["line_count"]);set_batch_directive(batch,"NUM_STARS",mat_halo["star_tip_count"]);
set_batch_directive(batch,"SKY_STARS",material["b4w_halo_sky_stars"]?1:0);batch.common_attributes=["a_position"];batch.halo_size=mat_halo["size"];batch.halo_hardness=mat_halo["hardness"]/20;batch.halo_rings_color=mat_halo["b4w_halo_rings_color"];batch.halo_lines_color=mat_halo["b4w_halo_lines_color"];batch.halo_stars_blend=1/material["b4w_halo_stars_blend_height"];batch.halo_stars_height=material["b4w_halo_stars_min_height"];batch.halo=true}else batch.halo=false;if(colormap0&&colormap0["texture_coords"]==
"NORMAL"||TEXTURE_STENCIL_ALPHA_MASK&&colormap1["texture_coords"]=="NORMAL")set_batch_directive(batch,"TEXTURE_COORDS","TEXTURE_COORDS_NORMAL");else if(colormap0&&colormap0["texture_coords"]=="UV")set_batch_directive(batch,"TEXTURE_COORDS","TEXTURE_COORDS_UV");else set_batch_directive(batch,"TEXTURE_COORDS",0);break}batch.diffuse_color=diffuse_color;var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",
alpha_blend==="CLIP"?1:0);set_batch_directive(batch,"DOUBLE_SIDED_LIGHTING",material["b4w_double_sided_lighting"]?1:0);if(material["use_vertex_color_paint"]){set_batch_directive(batch,"VERTEX_COLOR",1);set_batch_c_attr(batch,"a_color")}else set_batch_directive(batch,"VERTEX_COLOR",0);batch.ambient=material["ambient"];batch.diffuse_intensity=material["diffuse_intensity"];batch.emit=material["emit"];batch.specular_color=new Float32Array(material["specular_color"]);var spec_param;switch(material["specular_shader"]){case "PHONG":case "COOKTORR":set_batch_directive(batch,
"SPECULAR_SHADER","SPECULAR_PHONG");spec_param=material["specular_hardness"];break;case "WARDISO":set_batch_directive(batch,"SPECULAR_SHADER","SPECULAR_WARDISO");spec_param=material["specular_slope"];break;default:m_print.error("B4W Error: unsupported specular shader: "+material["specular_shader"]+' (material "'+material["name"]+'")');spec_param=material["specular_hardness"];break}batch.specular_params=new Float32Array([material["specular_intensity"],spec_param]);switch(material["diffuse_shader"]){case "LAMBERT":set_batch_directive(batch,
"DIFFUSE_SHADER","DIFFUSE_LAMBERT");batch.diffuse_params=[0,0];break;case "OREN_NAYAR":set_batch_directive(batch,"DIFFUSE_SHADER","DIFFUSE_OREN_NAYAR");batch.diffuse_params=[material["roughness"],0];break;case "FRESNEL":set_batch_directive(batch,"DIFFUSE_SHADER","DIFFUSE_FRESNEL");batch.diffuse_params=[material["diffuse_fresnel"],material["diffuse_fresnel_factor"]];break;default:m_print.error("B4W Error: unsupported diffuse shader: "+material["diffuse_shader"]+' (material "'+material["name"]+'")');
batch.diffuse_params=[0,0];break}if(material["b4w_wettable"])set_batch_directive(batch,"WETTABLE",1);else set_batch_directive(batch,"WETTABLE",0);update_batch_fresnel_params(batch,material);return true}function update_batch_game_settings(batch,material){var gs=material["game_settings"];switch(gs["alpha_blend"]){case "ALPHA_SORT":batch.blend=true;batch.zsort_type=geometry.ZSORT_BACK_TO_FRONT;batch.depth_mask=true;break;case "ALPHA":batch.blend=true;batch.zsort_type=geometry.ZSORT_DISABLED;batch.depth_mask=
true;break;case "CLIP":batch.blend=false;batch.zsort_type=geometry.ZSORT_DISABLED;batch.depth_mask=true;break;case "ADD":batch.blend=true;batch.zsort_type=geometry.ZSORT_DISABLED;batch.depth_mask=false;break;case "OPAQUE":batch.blend=false;batch.zsort_type=geometry.ZSORT_DISABLED;batch.depth_mask=true;break;default:throw new Error("Unknown alpha blend mode: "+alpha_blend);}batch.use_backface_culling=gs["use_backface_culling"]}function get_batch_texture(texture_slot,color){var bpy_texture=texture_slot["texture"];
var render=bpy_texture._render;var image=bpy_texture["image"];if(render&&(color&&image))m_textures.update_texture(render,color,image._is_dds,image["filepath"]);return render}function find_valid_textures(key,value,array){var results=[];var len=array.length;for(var i=0;i<len;i++){var obj=array[i];if(obj[key]==value&&(obj["texture"]&&obj["texture"]._render))results.push(obj)}return results}function init_water_material(material,batch){batch.water=true;batch.water_shore_smoothing=material["b4w_water_shore_smoothing"];
batch.water_dynamic=material["b4w_water_dynamic"];var texture_slots=material["texture_slots"];apply_shader(batch,"special_water.glslv","special_water.glslf");set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_texcoord");set_batch_c_attr(batch,"a_normal");set_batch_c_attr(batch,"a_tangent");var normalmaps=find_valid_textures("use_map_normal",true,texture_slots);var mirrormap0=find_valid_textures("use_map_mirror",true,texture_slots)[0];var alphamap0=find_valid_textures("use_map_alpha",true,
texture_slots)[0];if(normalmaps.length){var tex_nm=get_batch_texture(normalmaps[0]);append_texture(batch,tex_nm,"u_normalmap0")}set_batch_directive(batch,"NUM_NORMALMAPS",normalmaps.length);batch.normalmap_scales=new Array(normalmaps.length);for(var i=0;i<normalmaps.length;i++){batch.normalmap_uv_velocities[i].set(normalmaps[i]["texture"]["b4w_uv_velocity_trans"]);batch.normalmap_scales[i]=new Float32Array(2);batch.normalmap_scales[i].set([normalmaps[i]["scale"][0],normalmaps[i]["scale"][1]])}if(mirrormap0){set_batch_directive(batch,
"TEXTURE_MIRROR",1);var tex_mm0=get_batch_texture(mirrormap0);append_texture(batch,tex_mm0,"u_mirrormap");batch.mirror_factor=mirrormap0["mirror_factor"]}else{set_batch_directive(batch,"TEXTURE_MIRROR",0);batch.mirror_factor=0}if(alphamap0){set_batch_directive(batch,"ALPHA_MAP",1);var tex_am0=get_batch_texture(alphamap0);append_texture(batch,tex_am0,"u_alphamap")}else set_batch_directive(batch,"ALPHA_MAP",0);var foam=null;for(var i=0;i<texture_slots.length;i++){var texture=texture_slots[i];if(texture["texture"]["b4w_water_foam"]===
true){foam=texture;break}}if(foam&&cfg_def.foam){set_batch_directive(batch,"FOAM",1);var tex_foam=get_batch_texture(foam);append_texture(batch,tex_foam,"u_foam");batch.foam_factor=material["b4w_foam_factor"];batch.foam_uv_freq=foam["texture"]["b4w_foam_uv_freq"];batch.foam_mag=foam["texture"]["b4w_foam_uv_magnitude"];batch.foam_scale=new Float32Array([foam["scale"][0],foam["scale"][1]])}else set_batch_directive(batch,"FOAM",0);for(var i=0;i<texture_slots.length;i++){var texture=texture_slots[i];if(texture["texture"]["b4w_shore_dist_map"]===
true){var shore_dist_map=texture;break}}if(shore_dist_map){var tex_shr0=get_batch_texture(shore_dist_map);append_texture(batch,tex_shr0,"u_shore_dist_map");set_batch_directive(batch,"SHORE_PARAMS",1);var sh_bounds=texture["texture"]["b4w_shore_boundings"];set_batch_directive(batch,"MAX_SHORE_DIST",shaders.glsl_value(texture["texture"]["b4w_max_shore_dist"]));set_batch_directive(batch,"SHORE_MAP_SIZE_X",shaders.glsl_value(sh_bounds[0]-sh_bounds[1]));set_batch_directive(batch,"SHORE_MAP_SIZE_Z",shaders.glsl_value(sh_bounds[2]-
sh_bounds[3]));set_batch_directive(batch,"SHORE_MAP_CENTER_X",shaders.glsl_value((sh_bounds[0]+sh_bounds[1])/2));set_batch_directive(batch,"SHORE_MAP_CENTER_Z",shaders.glsl_value((sh_bounds[2]+sh_bounds[3])/2))}else set_batch_directive(batch,"SHORE_PARAMS",0);if(material["b4w_generated_mesh"]&&cfg_def.deferred_rendering){set_batch_directive(batch,"GENERATED_MESH",1);batch.water_generated_mesh=true;batch.water_num_cascads=material["b4w_water_num_cascads"];batch.water_subdivs=material["b4w_water_subdivs"];
batch.water_detailed_dist=material["b4w_water_detailed_dist"]}else{set_batch_directive(batch,"GENERATED_MESH",0);batch.water_generated_mesh=false}if(material["b4w_water_dynamic"]){var dst_noise_scale0=shaders.glsl_value(material["b4w_water_dst_noise_scale0"]);var dst_noise_scale1=shaders.glsl_value(material["b4w_water_dst_noise_scale1"]);var dst_noise_freq0=shaders.glsl_value(material["b4w_water_dst_noise_freq0"]);var dst_noise_freq1=shaders.glsl_value(material["b4w_water_dst_noise_freq1"]);var dir_min_shore_fac=
shaders.glsl_value(material["b4w_water_dir_min_shore_fac"]);var dir_freq=shaders.glsl_value(material["b4w_water_dir_freq"]);var dir_noise_scale=shaders.glsl_value(material["b4w_water_dir_noise_scale"]);var dir_noise_freq=shaders.glsl_value(material["b4w_water_dir_noise_freq"]);var dir_min_noise_fac=shaders.glsl_value(material["b4w_water_dir_min_noise_fac"]);var dst_min_fac=shaders.glsl_value(material["b4w_water_dst_min_fac"]);var waves_hor_fac=shaders.glsl_value(material["b4w_water_waves_hor_fac"]);
set_batch_directive(batch,"DST_NOISE_SCALE_0",dst_noise_scale0);set_batch_directive(batch,"DST_NOISE_SCALE_1",dst_noise_scale1);set_batch_directive(batch,"DST_NOISE_FREQ_0",dst_noise_freq0);set_batch_directive(batch,"DST_NOISE_FREQ_1",dst_noise_freq1);set_batch_directive(batch,"DIR_MIN_SHR_FAC",dir_min_shore_fac);set_batch_directive(batch,"DIR_FREQ",dir_freq);set_batch_directive(batch,"DIR_NOISE_SCALE",dir_noise_scale);set_batch_directive(batch,"DIR_NOISE_FREQ",dir_noise_freq);set_batch_directive(batch,
"DIR_MIN_NOISE_FAC",dir_min_noise_fac);set_batch_directive(batch,"DST_MIN_FAC",dst_min_fac);set_batch_directive(batch,"WAVES_HOR_FAC",waves_hor_fac)}var spec_param;switch(material["specular_shader"]){case "PHONG":case "COOKTORR":set_batch_directive(batch,"SPECULAR_SHADER","SPECULAR_PHONG");spec_param=material["specular_hardness"];break;case "WARDISO":set_batch_directive(batch,"SPECULAR_SHADER","SPECULAR_WARDISO");spec_param=material["specular_slope"];break}batch.specular_params=new Float32Array([material["specular_intensity"],
spec_param]);switch(material["diffuse_shader"]){case "LAMBERT":set_batch_directive(batch,"DIFFUSE_SHADER","DIFFUSE_LAMBERT");batch.diffuse_params=[0,0];break;case "OREN_NAYAR":set_batch_directive(batch,"DIFFUSE_SHADER","DIFFUSE_OREN_NAYAR");batch.diffuse_params=[material["roughness"],0];break;case "FRESNEL":set_batch_directive(batch,"DIFFUSE_SHADER","DIFFUSE_FRESNEL");batch.diffuse_params=[material["diffuse_fresnel"],material["diffuse_fresnel_factor"]];break}batch.shallow_water_col=material["b4w_shallow_water_col"];
batch.shore_water_col=material["b4w_shore_water_col"];batch.shallow_water_col_fac=material["b4w_shallow_water_col_fac"];batch.shore_water_col_fac=material["b4w_shore_water_col_fac"];set_batch_directive(batch,"ABSORB",shaders.glsl_value(material["b4w_water_absorb_factor"]));set_batch_directive(batch,"SSS_STRENGTH",shaders.glsl_value(material["b4w_water_sss_strength"]));set_batch_directive(batch,"SSS_WIDTH",shaders.glsl_value(material["b4w_water_sss_width"]));return{shaders_info:batch.shaders_info,
common_attributes:batch.common_attributes}}function update_batch_fresnel_params(batch,material){batch.fresnel_params=new Float32Array(4);var rt=material["raytrace_transparency"];batch.fresnel_params[0]=rt["fresnel"];batch.fresnel_params[1]=1-rt["fresnel_factor"]/5;var rm=material["raytrace_mirror"];batch.reflect_factor=rm["reflect_factor"];batch.fresnel_params[2]=rm["fresnel"];batch.fresnel_params[3]=1-rm["fresnel_factor"]/5}function update_batch_material_nodes(batch,material){if(!material["use_nodes"])return false;
var node_tree=material["node_tree"];var nmat_graph=nodemat.compose_nmat_graph(node_tree,material["uuid"]);if(!nmat_graph){m_print.error("Failed to create node graph for material "+material["name"]+", disable nodes");update_batch_material_debug(batch,material);return true}apply_shader(batch,"nodes.glslv","nodes.glslf");var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:
0);set_batch_directive(batch,"DOUBLE_SIDED_LIGHTING",material["b4w_double_sided_lighting"]?1:0);set_batch_c_attr(batch,"a_position");update_batch_game_settings(batch,material);batch.offset_z=material["offset_z"];batch.diffuse_color=new Float32Array([material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"]]);batch.emit=material["emit"];batch.ambient=material["ambient"];update_batch_fresnel_params(batch,material);if(material["b4w_wettable"])set_batch_directive(batch,
"WETTABLE",1);else set_batch_directive(batch,"WETTABLE",0);batch.node_elements=nodemat.compose_node_elements(nmat_graph);m_graph.traverse(nmat_graph,function(node,attr){switch(attr.type){case "GEOMETRY_UV":var name=attr.data.name;var uv_layer=attr.data.value;if(uv_layer)batch.uv_maps_usage[uv_layer]=name;else m_print.error("Missing UV layer in node ",attr.name,"for material ",material["name"]);break;case "GEOMETRY_VC":case "GEOMETRY_VC1":case "GEOMETRY_VC2":case "GEOMETRY_VC3":var name=attr.data.name;
var vc_layer=attr.data.value;if(vc_layer){batch.vertex_colors_usage[name]={generate_buffer:true,src:[{name:vc_layer}]};var mask=0;if(attr.type=="GEOMETRY_VC")mask=7;else for(var i=0;i<attr.outputs.length;i++){var index="RGB".indexOf(attr.outputs[i].identifier);if(index>-1)mask|=1<<2-index}batch.vertex_colors_usage[name].src[0].mask=mask}else m_print.error("Missing vertex color layer in node ",attr.name,"for material ",material["name"]);break;case "GEOMETRY_NO":set_batch_c_attr(batch,"a_normal");break;
case "MATERIAL":case "MATERIAL_EXT":var mat=attr.data.value;set_batch_directive(batch,"SHADED",1);set_batch_c_attr(batch,"a_normal");set_batch_directive(batch,"DIFFUSE_SHADER","DIFFUSE_"+mat["diffuse_shader"]);set_batch_directive(batch,"SPECULAR_SHADER","SPECULAR_"+mat["specular_shader"]);break;case "TEXTURE_COLOR":case "TEXTURE_COLOR2":case "TEXTURE_COLOR3":case "TEXTURE_ENVIRONMENT":case "PARALLAX":var name=attr.data.name;var tex=attr.data.value;if(tex){if(tex._render.allow_node_dds!==false)if(attr.type!=
"TEXTURE_ENVIRONMENT")tex._render.allow_node_dds=true;else tex._render.allow_node_dds=false;append_texture(batch,tex._render,name)}else m_print.error("Missing texture in node ",attr.name,"for material ",material["name"]);break;case "TEXTURE_NORMAL":case "TEXTURE_NORMAL2":case "TEXTURE_NORMAL3":set_batch_directive(batch,"CALC_TBN_SPACE",1);set_batch_c_attr(batch,"a_normal");set_batch_c_attr(batch,"a_tangent");var name=attr.data.name;var tex=attr.data.value;if(tex){tex._render.allow_node_dds=false;
append_texture(batch,tex._render,name)}else m_print.error("Missing texture in node ",attr.name,"for material ",material["name"]);break}});return true}function update_batch_material_debug(batch,material){apply_shader(batch,"shadeless.glslv","shadeless.glslf");var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:0);set_batch_c_attr(batch,"a_position");batch.diffuse_color=new Float32Array([1,
0,1,1]);set_batch_directive(batch,"VERTEX_COLOR",0);batch.offset_z=material["offset_z"];update_batch_game_settings(batch,material);return true}function update_batch_material_depth(batch,material){if(material["name"]==="LENS_FLARES"||(material["name"]==="PARTICLES"||(material["b4w_water"]||(material["b4w_skydome"]||(material["b4w_collision"]||material["type"]==="HALO")))))return false;update_batch_game_settings(batch,material);if(batch.blend)return false;apply_shader(batch,"depth.glslv","depth.glslf");
set_batch_c_attr(batch,"a_position");var alpha_blend=material["game_settings"]["alpha_blend"];var alpha=alpha_blend==="OPAQUE"?0:1;set_batch_directive(batch,"ALPHA",alpha);batch.texture_scale=new Float32Array([1,1,1]);var texture_slots=material["texture_slots"];var colormap0=find_valid_textures("use_map_color_diffuse",true,texture_slots)[0];var alpha_clip=alpha_blend==="CLIP"?1:0;if(colormap0&&alpha_clip){batch.texture_scale.set(colormap0["scale"]);set_batch_directive(batch,"TEXTURE_COLOR",1);set_batch_c_attr(batch,
"a_texcoord");batch.colormap0_uv_velocity=new Float32Array([0,0]);if(colormap0["texture"]._render.source=="IMAGE"||colormap0["texture"]._render.source=="ENVIRONMENT_MAP"){var tex=get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0");batch.colormap0_uv_velocity.set(colormap0["texture"]["b4w_uv_velocity_trans"])}if(colormap0["texture"]._render.source=="NONE"){var tex=get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0");batch.colormap0_uv_velocity.set(colormap0["texture"]["b4w_uv_velocity_trans"])}}else set_batch_directive(batch,
"TEXTURE_COLOR",0);return true}function update_batch_material_physics(batch,material){if(material["b4w_collision"]){batch.use_ghost=material["b4w_use_ghost"];batch.collision_id=material["b4w_collision_id"];batch.collision_group=material["b4w_collision_group"];batch.collision_mask=material["b4w_collision_mask"];batch.friction=material["physics"]["friction"];batch.elasticity=material["physics"]["elasticity"];return true}else if(material["b4w_water"]){batch.water=true;batch.water_dynamics=material["b4w_water_dynamic"];
batch.dst_noise_scale0=material["b4w_water_dst_noise_scale0"];batch.dst_noise_scale1=material["b4w_water_dst_noise_scale1"];batch.dst_noise_freq0=material["b4w_water_dst_noise_freq0"];batch.dst_noise_freq1=material["b4w_water_dst_noise_freq1"];batch.dir_min_shore_fac=material["b4w_water_dir_min_shore_fac"];batch.dir_freq=material["b4w_water_dir_freq"];batch.dir_noise_scale=material["b4w_water_dir_noise_scale"];batch.dir_noise_freq=material["b4w_water_dir_noise_freq"];batch.dir_min_noise_fac=material["b4w_water_dir_min_noise_fac"];
batch.dst_min_fac=material["b4w_water_dst_min_fac"];batch.waves_hor_fac=material["b4w_water_waves_hor_fac"];return true}else return false}function update_batch_material_color_id(batch,material){if(material["name"]==="LENS_FLARES"||(material["name"]==="PARTICLES"||(material["b4w_skydome"]||(material["b4w_collision"]||material["type"]==="HALO"))))return false;update_batch_game_settings(batch,material);batch.blend=false;apply_shader(batch,"color_id.glslv","color_id.glslf");set_batch_c_attr(batch,"a_position");
var alpha_blend=material["game_settings"]["alpha_blend"];var alpha=alpha_blend==="OPAQUE"?0:1;set_batch_directive(batch,"ALPHA",alpha);batch.texture_scale=new Float32Array([1,1,1]);var texture_slots=material["texture_slots"];var colormap0=find_valid_textures("use_map_color_diffuse",true,texture_slots)[0];var alpha_clip=alpha_blend==="CLIP"?1:0;if(colormap0&&alpha_clip){batch.texture_scale.set(colormap0["scale"]);set_batch_directive(batch,"TEXTURE_COLOR",1);set_batch_c_attr(batch,"a_texcoord");batch.colormap0_uv_velocity=
new Float32Array([0,0]);if(colormap0["texture"]._render.source=="IMAGE"||colormap0["texture"]._render.source=="ENVIRONMENT_MAP"){var tex=get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0");batch.colormap0_uv_velocity.set(colormap0["texture"]["b4w_uv_velocity_trans"])}if(colormap0["texture"]._render.source=="NONE"){var tex=get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0");batch.colormap0_uv_velocity.set(colormap0["texture"]["b4w_uv_velocity_trans"])}}else set_batch_directive(batch,
"TEXTURE_COLOR",0);return true}function update_batch_material_wireframe(batch,material){if(material["name"]==="LENS_FLARES"||(material["name"]==="PARTICLES"||(material["b4w_water"]||(material["b4w_skydome"]||(material["b4w_collision"]||material["type"]==="HALO")))))return false;apply_shader(batch,"wireframe.glslv","wireframe.glslf");set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_normal");set_batch_c_attr(batch,"a_polyindex");batch.depth_mask=true;batch.wireframe_mode=0;batch.wireframe_edge_color=
[0,0,0];return true}function update_batch_material_grass_map(batch,material){if(!material["b4w_terrain"])return false;update_batch_game_settings(batch,material);batch.blend=false;batch.zsort_type=geometry.ZSORT_DISABLED;batch.depth_mask=true;apply_shader(batch,"grass_map.glslv","grass_map.glslf");set_batch_c_attr(batch,"a_position");if(material["b4w_dynamic_grass_size"])var vc_usage_gr_size=material["b4w_dynamic_grass_size"];else var vc_usage_gr_size=null;if(material["b4w_dynamic_grass_color"])var vc_usage_gr_color=
material["b4w_dynamic_grass_color"];else var vc_usage_gr_color=null;batch.vertex_colors_usage["a_grass_size"]={generate_buffer:true,src:[]};if(vc_usage_gr_size){batch.vertex_colors_usage["a_grass_size"].src.push({name:vc_usage_gr_size,mask:4});set_batch_directive(batch,"DYNAMIC_GRASS_SIZE",1)}else set_batch_directive(batch,"DYNAMIC_GRASS_SIZE",0);batch.vertex_colors_usage["a_grass_color"]={generate_buffer:true,src:[]};if(vc_usage_gr_color){batch.vertex_colors_usage["a_grass_color"].src.push({name:vc_usage_gr_color,
mask:7});set_batch_directive(batch,"DYNAMIC_GRASS_COLOR",1)}else set_batch_directive(batch,"DYNAMIC_GRASS_COLOR",0);return true}function update_batch_render(batch,render){if(batch.type==="PHYSICS")return;if(render.type=="DYNAMIC"){if(render.is_hair_particles)set_batch_directive(batch,"AU_QUALIFIER","attribute");else set_batch_directive(batch,"AU_QUALIFIER","uniform");set_batch_directive(batch,"STATIC_BATCH",0)}else{set_batch_directive(batch,"AU_QUALIFIER","attribute");set_batch_directive(batch,"STATIC_BATCH",
1)}if(batch.type=="WIREFRAME"){if(extensions.get_standard_derivatives())set_batch_directive(batch,"WIREFRAME_QUALITY",1);else set_batch_directive(batch,"WIREFRAME_QUALITY",0);if(batch.debug_sphere){set_batch_directive(batch,"DEBUG_SPHERE",1);if(batch.debug_sphere_dynamic)set_batch_directive(batch,"DEBUG_SPHERE_DYNAMIC",1);else set_batch_directive(batch,"DEBUG_SPHERE_DYNAMIC",0)}else set_batch_directive(batch,"DEBUG_SPHERE",0);set_batch_directive(batch,"ALPHA",1)}if(render.wind_bending){if(render.main_bend_col!==
""){batch.vertex_colors_usage["a_bending_col_main"]={generate_buffer:true,src:[{name:render.main_bend_col,mask:4}]};set_batch_c_attr(batch,"a_bending_col_main");if(render.detail_bend_col.leaves_stiffness!==""&&(render.detail_bend_col.leaves_phase!==""&&render.detail_bend_col.overall_stiffness!=="")){batch.vertex_colors_usage["a_bending_col_detail"]={generate_buffer:true,src:[{name:render.detail_bend_col.leaves_stiffness,mask:4},{name:render.detail_bend_col.leaves_phase,mask:2},{name:render.detail_bend_col.overall_stiffness,
mask:1}]};set_batch_c_attr(batch,"a_bending_col_detail");set_batch_c_attr(batch,"a_normal");set_batch_directive(batch,"DETAIL_BEND",1)}else set_batch_directive(batch,"DETAIL_BEND",0);set_batch_directive(batch,"MAIN_BEND_COL",1)}else set_batch_directive(batch,"MAIN_BEND_COL",0);set_batch_directive(batch,"WIND_BEND",1)}else set_batch_directive(batch,"WIND_BEND",0);if(render.bend_center_only)set_batch_directive(batch,"BEND_CENTER_ONLY",1);else set_batch_directive(batch,"BEND_CENTER_ONLY",0);if(render.hair_billboard)set_batch_directive(batch,
"HAIR_BILLBOARD",1);else set_batch_directive(batch,"HAIR_BILLBOARD",0);if(render.hair_billboard_spherical===false)set_batch_directive(batch,"HAIR_BILLBOARD_SPHERICAL",0);else set_batch_directive(batch,"HAIR_BILLBOARD_SPHERICAL",1);switch(render.hair_billboard_type){case "RANDOM":set_batch_directive(batch,"HAIR_BILLBOARD_RANDOM",1);set_batch_directive(batch,"HAIR_BILLBOARD_JITTERED",0);break;case "JITTERED":set_batch_directive(batch,"HAIR_BILLBOARD_RANDOM",0);set_batch_directive(batch,"HAIR_BILLBOARD_JITTERED",
1);break;default:set_batch_directive(batch,"HAIR_BILLBOARD_RANDOM",0);set_batch_directive(batch,"HAIR_BILLBOARD_JITTERED",0);break}if(render.dynamic_grass)set_batch_directive(batch,"DYNAMIC_GRASS",1);else set_batch_directive(batch,"DYNAMIC_GRASS",0);batch.dynamic_grass=render.dynamic_grass;batch.dynamic_geometry=render.dynamic_geometry;batch.shadow_cast=render.shadow_cast;batch.shadow_cast_only=render.shadow_cast_only;batch.shadow_receive=render.shadow_receive;batch.reflexible=render.reflexible;batch.reflexible_only=
render.reflexible_only;batch.reflective=render.reflective;if(render.is_skinning){set_batch_c_attr(batch,"a_influence");set_batch_directive(batch,"SKINNED",1);if(render.frames_blending)set_batch_directive(batch,"FRAMES_BLENDING",1);else set_batch_directive(batch,"FRAMES_BLENDING",0);set_batch_directive(batch,"MAX_BONES",render.max_bones)}else{set_batch_directive(batch,"SKINNED",0);set_batch_directive(batch,"FRAMES_BLENDING",0)}if(render.vertex_anim)set_batch_directive(batch,"VERTEX_ANIM",1);else set_batch_directive(batch,
"VERTEX_ANIM",0);if(render.is_skinning&&render.vertex_anim)throw"Skinning and vertex animation are mutually exlusive";if(render.disable_fogging)set_batch_directive(batch,"DISABLE_FOG",1);else set_batch_directive(batch,"DISABLE_FOG",0);if(render.bone_pointers)batch.bone_pointers=render.bone_pointers}function update_batch_particle_systems(batch,psystems){for(var i=0;i<psystems.length;i++){var emitter_col_name=psystems[i]["settings"]["b4w_vcol_from_name"];var particle_col_name=psystems[i]["settings"]["b4w_vcol_to_name"];
if(emitter_col_name!==""&&particle_col_name!=="")batch.vertex_colors_usage[emitter_col_name]={generate_buffer:false,src:[{name:emitter_col_name,mask:7}]}}}exports.assign_shadow_receive_dirs=function(batch,csm_borders){set_batch_directive(batch,"CSM_SECTION0",0);set_batch_directive(batch,"CSM_SECTION1",0);set_batch_directive(batch,"CSM_SECTION2",0);set_batch_directive(batch,"CSM_SECTION3",0);for(var i=0;i<csm_borders.length;i++){set_batch_directive(batch,"CSM_SECTION"+String(i),1);set_batch_directive(batch,
"CSM_SECTION_DIST"+String(i),csm_borders[i])}var name="PCF_TEXEL_SIZE";var value=1/cfg_scs.shadow_tex_size;set_batch_directive(batch,name,value)};function set_batch_c_attr(batch,name){var cattrs=batch.common_attributes;if(cattrs.indexOf(name)==-1)cattrs.push(name)}exports.set_batch_directive=set_batch_directive;function set_batch_directive(batch,name,value){shaders.set_directive(batch.shaders_info,name,value)}exports.get_batch_directive=get_batch_directive;function get_batch_directive(batch,name){return shaders.get_directive(batch.shaders_info,
name)}function prepare_vertex_anim_locations(obj){var render=obj._render;if(!render.vertex_anim)return null;if(obj["data"]["b4w_vertex_anim"].length)var va=obj["data"]["b4w_vertex_anim"];else var va=[];var anim_locs=[];for(var i=0;i<va.length;i++){var frames=va[i]["frames"];var flen=frames.length;var av_int_start=Math.max(0,flen-va[i]["averaging_interval"]);for(var j=0;j<flen;j++){var frame=frames[j];if(va[i]["averaging"]&&(va[i]["averaging_interval"]>1&&j>=av_int_start)){var a=(j-av_int_start)/(flen-
1-av_int_start);a*=a;for(var k=0;k<frame.length;k++)frame[k]=(1-a)*frame[k]+a*frames[frames.length-j-1][k]}anim_locs.push(frame)}}return anim_locs}function update_batch_geometry(batch,submesh){if(batch.type=="PHYSICS"){batch.submesh=submesh;return}var zsort_type=batch.zsort_type;var draw_mode=batch.draw_mode;if(batch.halo)var submesh=geometry.extract_halo_submesh(submesh);if(batch.water_generated_mesh){var num_cascads=batch.water_num_cascads;var subdivs=batch.water_subdivs;var detailed_dist=batch.water_detailed_dist;
var submesh=primitives.generate_multigrid(num_cascads,subdivs,detailed_dist)}var bufs_data=geometry.submesh_to_bufs_data(submesh,zsort_type,draw_mode,batch.vertex_colors_usage);if(!(DEBUG_KEEP_BUFS_DATA_ARRAYS||(batch.dynamic_geometry||bufs_data.info_for_z_sort_updates))){delete bufs_data.ibo_array;delete bufs_data.vbo_array}batch.bufs_data=bufs_data;var frames=submesh.va_frames.length;batch.num_vertices=submesh.base_length*frames;if(is_triangle_batch(batch))if(geometry.is_indexed(submesh))batch.num_triangles=
submesh.indices.length/3*frames;else batch.num_triangles=submesh.base_length/3*frames;else batch.num_triangles=0;if(DEBUG_SAVE_SUBMESHES)batch.submesh=submesh}function is_triangle_batch(batch){switch(batch.draw_mode){case geometry.DM_DEFAULT:case geometry.DM_TRIANGLES:case geometry.DM_DYNAMIC_TRIANGLES:return true;default:return false}}function generate_particles_emitter_material(mesh,psystem){var mat_index=psystem["settings"]["material"]-1;var material=mesh["materials"][mat_index];var pmaterial=
{"name":"PARTICLES"};if(material["type"]==="HALO"){pmaterial["halo"]=material["halo"];pmaterial["texture_slots"]=[]}else pmaterial["texture_slots"]=material["texture_slots"];pmaterial["offset_z"]=material["offset_z"];pmaterial["diffuse_color"]=material["diffuse_color"];pmaterial["diffuse_shader"]=material["diffuse_shader"];pmaterial["specular_color"]=material["specular_color"];pmaterial["specular_shader"]=material["specular_shader"];pmaterial["diffuse_intensity"]=material["diffuse_intensity"];pmaterial["alpha"]=
material["alpha"];pmaterial["game_settings"]=material["game_settings"];pmaterial["raytrace_transparency"]=material["raytrace_transparency"];pmaterial["raytrace_mirror"]=material["raytrace_mirror"];return pmaterial}function update_batch_particles_emitter(batch,psystem){switch(psystem["settings"]["b4w_billboard_align"]){case "VIEW":set_batch_directive(batch,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_VIEW");break;case "XY":set_batch_directive(batch,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_XY");break;case "YZ":set_batch_directive(batch,
"BILLBOARD_ALIGN","BILLBOARD_ALIGN_YZ");break;case "ZX":set_batch_directive(batch,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_ZX");break;default:throw"Wrong billboard align value";break}}function make_hair_particles_metabatches(em_obj,render,em_batch,em_submesh,objs,batch_types_arr,objs_ptrans,pset,psys,use_grass_map,seed,reset_seed){var metabatches=[];var dyn_grass=pset["b4w_dynamic_grass"];if(!use_grass_map&&dyn_grass)return metabatches;var inst_inherit_bend=pset["b4w_wind_bend_inheritance"]=="INSTANCE";
var inst_inherit_shadow=pset["b4w_shadow_inheritance"]=="INSTANCE";var inst_inherit_reflection=pset["b4w_reflection_inheritance"]=="INSTANCE";var objs_hair_render=[];var objs_tsr_array=[];for(var i=0;i<objs.length;i++){var obj=objs[i];var hair_render=util.clone_object_nr(render);hair_render.hair_billboard=pset["b4w_hair_billboard"];hair_render.hair_billboard_type=pset["b4w_hair_billboard_type"];hair_render.dynamic_grass=dyn_grass;hair_render.hair_billboard_spherical=pset["b4w_hair_billboard_geometry"]==
"SPHERICAL";hair_render.is_hair_particles=true;if(inst_inherit_bend){hair_render.wind_bending=obj._render.wind_bending;hair_render.wind_bending_angle=obj._render.wind_bending_angle;hair_render.wind_bending_freq=obj._render.wind_bending_freq;hair_render.detail_bending_freq=obj._render.detail_bending_freq;hair_render.main_bend_col=obj._render.main_bend_col;hair_render.detail_bending_amp=obj._render.detail_bending_amp;hair_render.branch_bending_amp=obj._render.branch_bending_amp;hair_render.wind_bending_amp=
obj._render.wind_bending_amp;hair_render.detail_bend_col=obj._render.detail_bend_col;hair_render.bend_center_only=false}else{hair_render.wind_bending=em_obj._render.wind_bending;hair_render.wind_bending_angle=em_obj._render.wind_bending_angle;hair_render.wind_bending_freq=em_obj._render.wind_bending_freq;hair_render.detail_bending_freq=em_obj._render.detail_bending_freq;hair_render.main_bend_col=em_obj._render.main_bend_col;hair_render.detail_bending_amp=em_obj._render.detail_bending_amp;hair_render.branch_bending_amp=
em_obj._render.branch_bending_amp;hair_render.wind_bending_amp=em_obj._render.wind_bending_amp;hair_render.detail_bend_col=em_obj._render.detail_bend_col;hair_render.bend_center_only=true}if(inst_inherit_shadow){hair_render.shadow_cast=obj._render.shadow_cast;hair_render.shadow_cast_only=obj._render.shadow_cast_only;hair_render.shadow_receive=obj._render.shadow_receive}else{hair_render.shadow_cast=em_obj._render.shadow_cast;hair_render.shadow_cast_only=em_obj._render.shadow_cast_only;hair_render.shadow_receive=
em_obj._render.shadow_receive}if(inst_inherit_reflection){hair_render.reflexible=obj._render.reflexible;hair_render.reflexible_only=obj._render.reflexible_only;hair_render.reflective=obj._render.reflective}else{hair_render.reflexible=em_obj._render.reflexible;hair_render.reflexible_only=em_obj._render.reflexible_only;hair_render.reflective=em_obj._render.reflective}objs_hair_render.push(hair_render);var ptrans=objs_ptrans[i];if(!ptrans)ptrans=new Float32Array;if(reset_seed)util.init_rand_r_seed(psys["seed"],
seed);var trans=new Float32Array(3);var quat=new Float32Array([0,0,0,1]);var tsr_array=[];for(var j=0;j<ptrans.length;j+=4){trans[0]=ptrans[j];trans[1]=ptrans[j+1];trans[2]=ptrans[j+2];var scale=ptrans[j+3];if(pset["b4w_initial_rand_rotation"]){switch(pset["b4w_rotation_type"]){case "XYZ":var axis=new Float32Array([util.rand_r(seed),util.rand_r(seed),util.rand_r(seed)]);m_vec3.normalize(axis,axis);break;case "Z":var axis=new Float32Array([0,1,0]);break;default:throw"Unsupported random rotation type: "+
pset["b4w_rotation_type"];break}var strength=pset["b4w_rand_rotation_strength"];m_quat.setAxisAngle(axis,strength*(2*Math.PI*util.rand_r(seed)-Math.PI),quat)}var tsr=m_tsr.create_sep(trans,scale,quat);tsr_array.push(tsr)}objs_tsr_array.push(tsr_array)}var spatial_tree={};for(var i=0;i<objs.length;i++){var btypes=batch_types_arr[i];var hair_render=objs_hair_render[i];var hair_render_id=calc_render_id(hair_render);var tsr_array=objs_tsr_array[i];var obj=objs[i];if(!tsr_array.length)continue;var mesh=
objs[i]["data"];var materials=mesh["materials"];for(var j=0;j<materials.length;j++){if(geometry.has_empty_submesh(mesh,j))continue;for(var k=0;k<btypes.length;k++){var type=btypes[k];if(type==="COLOR_ID")continue;var batch=init_batch(type);var material=materials[j];if(!update_batch_material(batch,material,true))continue;batch.draw_mode=mesh.draw_mode||geometry.DM_DEFAULT;update_batch_render(batch,hair_render);batch.odd_id_prop=pset["uuid"];update_batch_id(batch,hair_render_id);if(pset["b4w_hair_billboard_type"]==
"JITTERED"){batch.jitter_amp=pset["b4w_hair_billboard_jitter_amp"];batch.jitter_freq=pset["b4w_hair_billboard_jitter_freq"]}batch.grass_scale_threshold=pset["b4w_dynamic_grass_scale_threshold"];if(!inst_inherit_bend){delete batch.vertex_colors_usage["a_bending_col_main"];delete batch.vertex_colors_usage["a_bending_col_detail"]}var src_submesh=geometry.extract_submesh(mesh,j,batch.common_attributes,null,batch.vertex_colors_usage,batch.uv_maps_usage);var params=[];if(hair_render.wind_bending||(hair_render.dynamic_grass||
hair_render.hair_billboard)){params["au_wind_bending_amp"]=[hair_render.wind_bending_amp];params["au_wind_bending_freq"]=[hair_render.wind_bending_freq];params["au_detail_bending_freq"]=[hair_render.detail_bending_freq];params["au_detail_bending_amp"]=[hair_render.detail_bending_amp];params["au_branch_bending_amp"]=[hair_render.branch_bending_amp]}var submesh=geometry.make_clone_submesh(src_submesh,params,tsr_array);submesh=fill_submesh_center_pos(submesh,tsr_array);if(hair_render.bend_center_only)submesh=
fill_submesh_emitter_center(submesh,em_obj._render.world_matrix);var particle_inherited_attrs=get_particle_inherited_attrs(pset["b4w_vcol_from_name"],pset["b4w_vcol_to_name"],batch,em_batch,!inst_inherit_bend,mesh);submesh=make_particle_inherited_vcols(submesh,tsr_array,em_obj._render.bb_local,em_submesh,particle_inherited_attrs,batch.vertex_colors_usage,spatial_tree);if(batch.material_names.indexOf(material["name"])==-1)batch.material_names.push(material["name"]);metabatches.push({batch:batch,submesh:submesh,
render:hair_render,rel_objects:[em_obj]})}}}return metabatches}function make_spatial_tree(spatial_tree,obj_bb_local,positions){spatial_tree.cell_size=new Float32Array(3);spatial_tree.base_point=new Float32Array(3);spatial_tree.verts_indices=new Uint32Array(positions.length/3);spatial_tree.octs_indices=new Uint32Array(positions.length/3);spatial_tree.cell_size[0]=(obj_bb_local.max_x-obj_bb_local.min_x)/STREE_CELL_COUNT;spatial_tree.cell_size[1]=(obj_bb_local.max_y-obj_bb_local.min_y)/STREE_CELL_COUNT;
spatial_tree.cell_size[2]=(obj_bb_local.max_z-obj_bb_local.min_z)/STREE_CELL_COUNT;spatial_tree.base_point[0]=obj_bb_local.min_x;spatial_tree.base_point[1]=obj_bb_local.min_y;spatial_tree.base_point[2]=obj_bb_local.min_z;for(var i=0;i<positions.length/3;i++){var x=positions[i*3];var y=positions[i*3+1];var z=positions[i*3+2];var num_x=util.trunc((x-spatial_tree.base_point[0])/spatial_tree.cell_size[0]);var num_y=util.trunc((y-spatial_tree.base_point[1])/spatial_tree.cell_size[1]);var num_z=util.trunc((z-
spatial_tree.base_point[2])/spatial_tree.cell_size[2]);num_x=util.clamp(num_x,0,STREE_CELL_COUNT-1);num_y=util.clamp(num_y,0,STREE_CELL_COUNT-1);num_z=util.clamp(num_z,0,STREE_CELL_COUNT-1);spatial_tree.verts_indices[i]=i;spatial_tree.octs_indices[i]=num_z*Math.pow(STREE_CELL_COUNT,2)+num_y*STREE_CELL_COUNT+num_x}geometry.sort_two_arrays(spatial_tree.octs_indices,spatial_tree.verts_indices,1);spatial_tree.verts_offsets=new Uint32Array(Math.pow(STREE_CELL_COUNT,3));for(var i=0;i<spatial_tree.octs_indices.length;i++){var index=
spatial_tree.octs_indices[i];spatial_tree.verts_offsets[index]++}delete spatial_tree.octs_indices;for(var i=1;i<spatial_tree.verts_offsets.length;i++)spatial_tree.verts_offsets[i]+=spatial_tree.verts_offsets[i-1];return spatial_tree}function get_particle_inherited_attrs(vc_name_from,vc_name_to,batch,em_batch,bend_inheritance,particle_mesh){var inherited_attrs=[];if(vc_name_from!==""&&vc_name_to!==""){var col_usage_data=get_vcol_usage_data_by_name(vc_name_to,batch.vertex_colors_usage);if(col_usage_data.length>
0)for(var i=0;i<col_usage_data.length;i+=3)inherited_attrs.push({emitter_attr:vc_name_from,emitter_mask:7,particle_attr:col_usage_data[i],particle_mask:col_usage_data[i+1],dst_channel_offset:col_usage_data[i+2]});else if(geometry.has_attr(batch.common_attributes,"a_color"))if(vc_name_to==particle_mesh["active_vcol_name"])inherited_attrs.push({emitter_attr:vc_name_from,emitter_mask:7,particle_attr:"a_color",particle_mask:7,dst_channel_offset:0})}if(bend_inheritance){if("a_bending_col_main"in em_batch.vertex_colors_usage)inherited_attrs.push({emitter_attr:"a_bending_col_main",
emitter_mask:4,particle_attr:"a_bending_col_main",particle_mask:4,dst_channel_offset:0});if("a_bending_col_detail"in em_batch.vertex_colors_usage)inherited_attrs.push({emitter_attr:"a_bending_col_detail",emitter_mask:7,particle_attr:"a_bending_col_detail",particle_mask:7,dst_channel_offset:0})}return inherited_attrs}function get_vcol_usage_data_by_name(color_name,vc_usage){var data=[];for(var attr_name in vc_usage){var src_colors=vc_usage[attr_name].src;var dst_channel_offset=0;for(var i=0;i<src_colors.length;i++){var mask=
src_colors[i].mask;if(color_name==src_colors[i].name)data.push(attr_name,mask,dst_channel_offset);dst_channel_offset+=util.rgb_mask_get_channels_count(mask)}}return data}function fill_submesh_center_pos(submesh,transforms){submesh.va_common["au_center_pos"]=new Float32Array(submesh.base_length*3);var t_count=transforms.length;var base_length=submesh.base_length/t_count;for(var i=0;i<t_count;i++){var transform=transforms[i];var v_offset=base_length*3*i;for(var j=0;j<base_length;j++){submesh.va_common["au_center_pos"][v_offset+
j*3]=transform[0];submesh.va_common["au_center_pos"][v_offset+j*3+1]=transform[1];submesh.va_common["au_center_pos"][v_offset+j*3+2]=transform[2]}}return submesh}function fill_submesh_emitter_center(submesh,em_world_matrix){submesh.va_common["a_emitter_center"]=new Float32Array(submesh.base_length*3);var origin=m_vec4.fromValues(0,0,0,1);m_vec4.transformMat4(origin,em_world_matrix,origin);for(var i=0;i<submesh.base_length;i++){submesh.va_common["a_emitter_center"][i*3]=origin[0];submesh.va_common["a_emitter_center"][i*
3+1]=origin[1];submesh.va_common["a_emitter_center"][i*3+2]=origin[2]}return submesh}function make_particle_inherited_vcols(submesh,transforms,em_bb_local,em_submesh,inherited_attrs,vc_usage,spatial_tree){var calc_nearest=false;for(var i=0;i<inherited_attrs.length;i++){var em_attr=inherited_attrs[i].emitter_attr;var cols=em_submesh.va_common[em_attr];if(cols&&cols.length>0){calc_nearest=true;break}}if(calc_nearest){var nearest_points=calc_emitter_nearest_points(em_bb_local,em_submesh.va_frames[0]["a_position"],
transforms,spatial_tree);var particle_verts_count=submesh.base_length/transforms.length;for(var i=0;i<inherited_attrs.length;i++){var p_attr=inherited_attrs[i].particle_attr;var p_mask=inherited_attrs[i].particle_mask;var em_attr=inherited_attrs[i].emitter_attr;var em_mask=inherited_attrs[i].emitter_mask;var cols=em_submesh.va_common[em_attr];switch(p_attr){case "a_bending_col_main":var p_attr_channels_total=1;break;case "a_bending_col_detail":var p_attr_channels_total=3;break;case "a_color":var p_attr_channels_total=
3;break;default:var p_attr_channels_total=0;for(var j=0;j<vc_usage[p_attr].src.length;j++)p_attr_channels_total+=util.rgb_mask_get_channels_count(vc_usage[p_attr].src[j].mask);break}if(cols&&cols.length>0){var emitter_comp_count=util.rgb_mask_get_channels_count(em_mask);var particle_comp_count=util.rgb_mask_get_channels_count(p_mask);var mask_from=em_mask&p_mask;var channel_presence_from=util.rgb_mask_get_channels_presence(mask_from);if(mask_from!=p_mask)m_print.error("Wrong color extraction from "+
em_attr+" to "+p_attr+".");if(p_attr=="a_bending_col_main"||p_attr=="a_bending_col_detail")submesh.va_common[p_attr]=new Float32Array(submesh.base_length*particle_comp_count);for(var j=0;j<transforms.length;j++){var nearest_index=nearest_points[j];var em_vert_offset=nearest_index*emitter_comp_count;var p_offset=j*particle_verts_count*p_attr_channels_total;if(nearest_index!=-1)for(var k=0;k<particle_verts_count;k++){var p_vert_offset=k*p_attr_channels_total;for(var l=0;l<channel_presence_from.length;l++)if(channel_presence_from[l]){var em_channel_offset=
util.rgb_mask_get_channel_presence_index(em_mask,l);var p_channel_offset=inherited_attrs[i].dst_channel_offset+util.rgb_mask_get_channel_presence_index(p_mask,l);submesh.va_common[p_attr][p_offset+p_vert_offset+p_channel_offset]=cols[em_vert_offset+em_channel_offset]}}}}else submesh.va_common[p_attr]=new Float32Array(0)}}return submesh}function calc_emitter_nearest_points(em_bb_local,em_positions,transforms,spatial_tree){var particle_cen=new Float32Array(3);var em_vert=new Float32Array(3);var nearest_points=
new Uint32Array(transforms.length);if(!("verts_indices"in spatial_tree))make_spatial_tree(spatial_tree,em_bb_local,em_positions);for(var i=0;i<transforms.length;i++){particle_cen[0]=transforms[i][0];particle_cen[1]=transforms[i][1];particle_cen[2]=transforms[i][2];var min_dist=1E10;var min_index=-1;var num_x=util.trunc((particle_cen[0]-spatial_tree.base_point[0])/spatial_tree.cell_size[0]);var num_y=util.trunc((particle_cen[1]-spatial_tree.base_point[1])/spatial_tree.cell_size[1]);var num_z=util.trunc((particle_cen[2]-
spatial_tree.base_point[2])/spatial_tree.cell_size[2]);num_x=util.clamp(num_x,0,STREE_CELL_COUNT-1);num_y=util.clamp(num_y,0,STREE_CELL_COUNT-1);num_z=util.clamp(num_z,0,STREE_CELL_COUNT-1);var oct_index=num_z*Math.pow(STREE_CELL_COUNT,2)+num_y*STREE_CELL_COUNT+num_x;var from_index=oct_index==0?0:spatial_tree.verts_offsets[oct_index-1];var to_index=spatial_tree.verts_offsets[oct_index];for(var j=from_index;j<to_index;j++){var index=spatial_tree.verts_indices[j];em_vert[0]=em_positions[index*3];em_vert[1]=
em_positions[index*3+1];em_vert[2]=em_positions[index*3+2];m_vec3.sub(em_vert,particle_cen,em_vert);var sq_len=m_vec3.sqrLen(em_vert);if(sq_len<=min_dist){min_dist=sq_len;min_index=index}}if(min_index==-1)for(var j=0;j<em_positions.length/3;j++){em_vert[0]=em_positions[j*3];em_vert[1]=em_positions[j*3+1];em_vert[2]=em_positions[j*3+2];m_vec3.sub(em_vert,particle_cen,em_vert);var sq_len=m_vec3.sqrLen(em_vert);if(sq_len<=min_dist){min_dist=sq_len;min_index=j}}nearest_points[i]=min_index}return nearest_points}
function distribute_ptrans_equally(ptrans,dupli_objects,seed){var objs_count=dupli_objects.length;var ptrans_dist={};for(var i=0;i<ptrans.length;i+=4){var index=Math.floor(objs_count*util.rand_r(seed));var robj_name=dupli_objects[index]["name"];ptrans_dist[index]=ptrans_dist[index]||[];ptrans_dist[index].push(ptrans[i],ptrans[i+1],ptrans[i+2],ptrans[i+3])}for(var index in ptrans_dist)ptrans_dist[index]=new Float32Array(ptrans_dist[index]);return ptrans_dist}function distribute_ptrans_group(ptrans,
dupli_objects){var ptrans_dist={};for(var i=0;i<ptrans.length;i+=4)for(var j=0;j<dupli_objects.length;j++){var obj_name=dupli_objects[j]["name"];var obj_trans=m_vec3.create();m_vec3.scale(dupli_objects[j]._render.trans,dupli_objects[j]._render.scale,obj_trans);var res_trans=m_vec3.clone([ptrans[i],ptrans[i+1],ptrans[i+2]]);m_vec3.add(res_trans,obj_trans,res_trans);if(!ptrans_dist[j])ptrans_dist[j]=new Float32Array(ptrans.length);ptrans_dist[j][i]=res_trans[0];ptrans_dist[j][i+1]=res_trans[1];ptrans_dist[j][i+
2]=res_trans[2];ptrans_dist[j][i+3]=ptrans[i+3]}return ptrans_dist}function distribute_ptrans_by_dupli_weights(ptrans,dupli_objects,dupli_weights,seed){var ptrans_dist={};function rand_obj_index_by_weights(dupli_weights){var weight_sum_array=[0];for(var i=0;i<dupli_weights.length;i++){var weight=dupli_weights[i];weight_sum_array[i+1]=weight_sum_array[i]+weight["count"]}var last=weight_sum_array[weight_sum_array.length-1];var weight_sum_rand=last*util.rand_r(seed);var weight_index=0;for(var i=0;i<
weight_sum_array.length;i++)if(weight_sum_rand>=weight_sum_array[i]&&weight_sum_rand<weight_sum_array[i+1]){weight_index=i;break}return weight_index}var dupli_weights_sorted=[];for(var i=0;i<dupli_objects.length;i++){var dg_obj=dupli_objects[i];var name=dg_obj["origin_name"]||dg_obj["name"];for(var j=0;j<dupli_weights.length;j++){var weight=dupli_weights[j];if(name==weight["name"].split(": ")[0])dupli_weights_sorted.push(weight)}}if(dupli_weights.length!=dupli_weights_sorted.length)m_print.error("B4W Error: dupli weights match failed");
for(var i=0;i<ptrans.length;i+=4){var index=rand_obj_index_by_weights(dupli_weights_sorted);ptrans_dist[index]=ptrans_dist[index]||[];ptrans_dist[index].push(ptrans[i],ptrans[i+1],ptrans[i+2],ptrans[i+3])}for(var index in ptrans_dist)ptrans_dist[index]=new Float32Array(ptrans_dist[index]);return ptrans_dist}function prepare_line_batches(obj){var batch=exports.create_line_batch();obj._batches.push(batch);obj._line={}}function create_object_clusters(batch_objects,grid_size){var clusters=[];var cluster_ids=
{};for(var i=0;i<batch_objects.length;i++){var bobj=batch_objects[i];var bobj_render=bobj._render;var render_props={};render_props.shadow_cast=bobj_render.shadow_cast;render_props.shadow_cast_only=bobj_render.shadow_cast_only;render_props.shadow_receive=bobj_render.shadow_receive;render_props.selectable=bobj_render.selectable;render_props.origin_selectable=bobj_render.origin_selectable;render_props.glow_anim_settings=bobj_render.glow_anim_settings;render_props.reflexible=bobj_render.reflexible;render_props.reflexible_only=
bobj_render.reflexible_only;render_props.reflective=bobj_render.reflective;render_props.caustics=bobj_render.caustics;render_props.wind_bending=bobj_render.wind_bending;render_props.main_bend_col=bobj_render.main_bend_col;render_props.detail_bend_col=bobj_render.detail_bend_col;render_props.hair_billboard=bobj_render.hair_billboard;render_props.hair_billboard_type=bobj_render.hair_billboard_type;render_props.dynamic_grass=bobj_render.dynamic_grass;render_props.do_not_cull=bobj_render.do_not_cull;
render_props.disable_fogging=bobj_render.disable_fogging;render_props.dynamic_geometry=bobj_render.dynamic_geometry;render_props.grid_id=calc_grid_id(grid_size,bobj_render.trans);render_props.lod_dist_max=bobj_render.lod_dist_max;render_props.lod_dist_min=bobj_render.lod_dist_min;var id=JSON.stringify(render_props);cluster_ids[id]=cluster_ids[id]||[];cluster_ids[id].push(bobj)}for(var key in cluster_ids){var render_props=JSON.parse(key);var objects=cluster_ids[key];var render=util.create_render("STATIC");
for(var prop in render_props)render[prop]=render_props[prop];render.wind_bending_amp=0;render.wind_bending_freq=0;render.detail_bending_freq=0;render.detail_bending_amp=0;render.branch_bending_amp=0;render.hide=false;for(var i=0;i<objects.length;i++){var obj=objects[i];var bb_local=bb_bpy_to_b4w(obj["data"]["b4w_bounding_box"]);var bb_world=boundings.bounding_box_transform(bb_local,obj._render.world_matrix);var bs_local={radius:obj["data"]["b4w_bounding_sphere_radius"],center:obj["data"]["b4w_bounding_sphere_center"]};
var bs_world=boundings.bounding_sphere_transform(bs_local,obj._render.world_matrix);var be_axes=obj["data"]["b4w_bounding_ellipsoid_axes"];var be_local={axis_x:new Float32Array([be_axes[0],0,0]),axis_y:new Float32Array([0,be_axes[1],0]),axis_z:new Float32Array([0,0,be_axes[2]]),center:obj["data"]["b4w_bounding_ellipsoid_center"]};var be_world=boundings.bounding_ellipsoid_transform(be_local,render.tsr);obj._render.bb_local=bb_local;obj._render.bb_world=bb_world;obj._render.bs_local=bs_local;obj._render.bs_world=
bs_world;obj._render.be_local=be_local;obj._render.be_world=be_world;if(i==0){render.bb_world=util.clone_object_r(bb_world);render.bs_world=util.clone_object_r(bs_world);render.be_local=util.clone_object_r(be_local);render.be_world=util.clone_object_r(be_world)}else{boundings.expand_bounding_box(render.bb_world,bb_world);boundings.expand_bounding_sphere(render.bs_world,bs_world)}}render.bb_local=util.clone_object_r(render.bb_world);render.bs_local=util.clone_object_r(render.bs_world);var cluster=
{render:render,objects:objects};clusters.push(cluster)}return clusters}function calc_grid_id(grid_size,position){if(grid_size==0)return[0,0];var base_point=[0,0,0];var id_x=Math.floor(position[0]/grid_size);var id_z=Math.floor(position[2]/grid_size);return[id_x,id_z]}function tsr_from_render(render){return m_tsr.create_sep(render.trans,render.scale,render.quat)}function update_batch_id(batch,render_id){delete batch.id;var batch_cp={};for(var prop in batch)if(batch[prop]&&typeof batch[prop]=="object")if(util.is_arr_buf_view(batch[prop]))batch_cp[prop]=
batch[prop];else if(batch[prop]instanceof Array&&(batch[prop][0]&&typeof batch[prop][0]=="object"))batch_cp[prop]=["NA"];else if(batch[prop]instanceof Array)batch_cp[prop]=batch[prop];else batch_cp[prop]={"N":"A"};else batch_cp[prop]=batch[prop];batch_cp.shaders_info=batch.shaders_info;batch_cp.node_elements=batch.node_elements;batch_cp.vertex_colors_usage=batch.vertex_colors_usage;batch_cp.uv_maps_usage=batch.uv_maps_usage;batch_cp.textures=[];for(var i=0;i<batch.textures.length;i++){var texture=
batch.textures[i];batch_cp.textures.push(m_textures.calc_texture_id(texture))}batch.id=JSON.stringify(batch_cp)+render_id}function calc_render_id(render){return JSON.stringify(render)}function create_bounding_ellipsoid_batch(bv,render,obj_name,ellipsoid){var batch=init_batch("WIREFRAME");apply_shader(batch,"wireframe.glslv","wireframe.glslf");batch.wireframe_mode=0;batch.debug_sphere=true;batch.depth_mask=true;batch.odd_id_prop=obj_name;if(ellipsoid){var submesh=primitives.generate_uv_sphere(16,8,
1,bv.center,false,false);var scale=[bv.axis_x[0],bv.axis_y[1],bv.axis_z[2]];geometry.scale_submesh_xyz(submesh,scale,bv.center)}else var submesh=primitives.generate_uv_sphere(16,8,bv.radius,bv.center,false,false);geometry.submesh_drop_indices(submesh,1,true);submesh.va_common["a_polyindex"]=geometry.extract_polyindices(submesh);update_batch_geometry(batch,submesh);update_batch_id(batch,calc_render_id(render));return batch}function apply_shader(batch,vert,frag){batch.shaders_info={vert:vert,frag:frag,
directives:[]};shaders.set_default_directives(batch.shaders_info)}exports.append_texture=append_texture;function append_texture(batch,texture,name){if(batch.textures.length==1&&batch.texture_names.length==0)batch.texture_names.push("default0");name=name||"default"+String(batch.textures.length);if(batch.texture_names.indexOf(name)==-1){batch.textures.push(texture);batch.texture_names.push(name)}}exports.replace_texture=function(batch,texture,name){var index=batch.texture_names.indexOf(name);if(index>
-1)batch.textures[index]=texture};exports.create_shadeless_batch=function(submesh,color,alpha){var batch=init_batch("SHADELESS");apply_shader(batch,"shadeless.glslv","shadeless.glslf");update_shader(batch);if(alpha===0||alpha){batch.blend=true;batch.diffuse_color=new Float32Array([color[0],color[1],color[2],alpha]);batch.depth_mask=false}else{batch.blend=false;batch.diffuse_color=new Float32Array([color[0],color[1],color[2],1]);batch.depth_mask=true}batch.zsort_type=geometry.ZSORT_DISABLED;batch.depth_mask=
true;batch.draw_mode=geometry.DM_TRIANGLES;update_batch_geometry(batch,submesh);return batch};exports.update_shader=update_shader;function update_shader(batch){if(!batch.shaders_info)throw"No shaders info for batch "+batch.name;batch.shader=shaders.get_compiled_shader(batch.shaders_info,batch.node_elements)}exports.check_batch_perm_uniform=function(batch,uniform_name){var uni_setters=batch.shader.permanent_uniform_setters;if(!uni_setters)return false;if(uni_setters[uniform_name])return true;return false};
exports.fork_depth_batch=function(batch_src,shadow_source,shadow_destination){var batch=init_batch("DEPTH");batch.blend=false;apply_shader(batch,"depth.glslv","depth.glslf");var shaders_info=batch.shaders_info;shaders.inherit_directives(shaders_info,batch_src.shaders_info);shaders.set_directive(shaders_info,"SHADOW_SRC",shadow_source);shaders.set_directive(shaders_info,"SHADOW_DST",shadow_destination);batch.use_backface_culling=batch_src.use_backface_culling;batch.texture_scale=batch_src.texture_scale;
batch.dynamic_grass=batch_src.dynamic_grass;batch.bufs_data=batch_src.bufs_data;batch.id=batch_src.id;if(batch_src.textures.length){batch.textures[0]=batch_src.textures[0];batch.texture_names[0]=batch_src.texture_names[0]}batch.colormap0_uv_velocity=batch_src.colormap0_uv_velocity;batch.common_attributes=batch_src.common_attributes;batch.jitter_amp=batch_src.jitter_amp;batch.jitter_freq=batch_src.jitter_freq;batch.grass_scale_threshold=batch_src.grass_scale_threshold;batch.num_triangles=batch_src.num_triangles;
batch.num_vertices=batch_src.num_vertices;batch.odd_id_prop=batch_src.odd_id_prop;for(var i=0;i<batch_src.material_names.length;i++)batch.material_names.push(batch_src.material_names[i]);batch.particle_system=batch_src.particle_system;if(!batch_src.childs)batch_src.childs=[];batch_src.childs.push(batch);return batch};exports.create_depth_pack_batch=function(tex){var batch=init_batch("DEPTH_PACK");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/depth_pack.glslf");update_shader(batch);
batch.use_backface_culling=true;batch.blend=false;batch.depth_mask=false;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_hud_batch=function(){var batch=init_batch("HUD");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/postprocessing.glslf");update_shader(batch);batch.use_backface_culling=true;batch.blend=true;batch.zsort_type=geometry.ZSORT_DISABLED;batch.depth_mask=false;batch.texel_size=new Float32Array([0,0]);
batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_postprocessing_batch=function(post_effect){var batch=init_batch("POSTPROCESSING");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/postprocessing.glslf");switch(post_effect){case "NONE":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_NONE");batch.texel_mask=new Float32Array([1,1]);break;case "GRAYSCALE":set_batch_directive(batch,
"POST_EFFECT","POST_EFFECT_GRAYSCALE");batch.texel_mask=new Float32Array([1,1]);break;case "X_BLUR":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_X_BLUR");batch.texel_mask=new Float32Array([1,0]);break;case "Y_BLUR":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_Y_BLUR");batch.texel_mask=new Float32Array([0,1]);break;case "X_EXTEND":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_X_EXTEND");batch.texel_mask=new Float32Array([1,0]);break;case "Y_EXTEND":set_batch_directive(batch,
"POST_EFFECT","POST_EFFECT_Y_EXTEND");batch.texel_mask=new Float32Array([0,1]);break;default:throw"Wrong postprocessing effect: "+post_effect;break}update_shader(batch);batch.texel_size=new Float32Array([0,0]);batch.texel_size_multipler=1;batch.use_backface_culling=true;batch.blend=false;batch.depth_mask=false;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_edge_batch=function(texture){var batch=init_batch("EDGE");apply_shader(batch,"postprocessing/postprocessing.glslv",
"postprocessing/edge.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_ssao_batch=function(ssao_samples){var batch=init_batch("SSAO");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/ssao.glslf");set_batch_directive(batch,
"SSAO_QUALITY","SSAO_QUALITY_"+ssao_samples);update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_dof_batch=function(){var batch=init_batch("DOF");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/dof.glslf");set_batch_directive(batch,
"DEPTH_RGBA",1);update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_glow_batch=function(){var batch=init_batch("GLOW");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/glow.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=
true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_god_rays_batch=function(tex_input,pack,water,steps){var batch=init_batch("GOD_RAYS");apply_shader(batch,"postprocessing/god_rays.glslv","postprocessing/god_rays.glslf");set_batch_directive(batch,"DEPTH_RGBA",pack);set_batch_directive(batch,"WATER_EFFECTS",water);set_batch_directive(batch,
"STEPS_PER_PASS",shaders.glsl_value(steps,1));update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_god_rays_combine_batch=function(tex_main,tex_god_rays){var batch=init_batch("GOD_RAYS_COM");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/god_rays_combine.glslf");
update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_sky_batch=function(){var batch=init_batch("SKY");apply_shader(batch,"procedural_skydome.glslv","procedural_skydome.glslf");set_batch_directive(batch,"NUM_LIGHTS",1);set_batch_directive(batch,"WATER_EFFECTS",
1);update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_cube();update_batch_geometry(batch,submesh);return batch};exports.create_blur_depth_batch=function(orient){var batch=init_batch("BLUR_DEPTH");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/blur_depth.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=
true;batch.texel_size=new Float32Array([0,0]);var texel_mask=orient==="X"?[1,0]:[0,1];batch.texel_mask=new Float32Array(texel_mask);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_antialiasing_batch=function(){var batch=init_batch("ANTIALIASING");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/antialiasing.glslf");set_batch_directive(batch,"AA_METHOD","AA_METHOD_FXAA_QUALITY");update_shader(batch);
batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1/cfg_def.resolution_factor;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_smaa_batch=function(type){var batch=init_batch("SMAA");apply_shader(batch,"postprocessing/smaa.glslv","postprocessing/smaa.glslf");set_batch_directive(batch,"AA_METHOD","AA_METHOD_SMAA_HIGH");set_batch_directive(batch,
"SMAA_PASS",type);set_batch_directive(batch,"SMAA_REPROJECTION",1);set_batch_directive(batch,"SMAA_PREDICATION",0);update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1/cfg_def.resolution_factor;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_lanczos_batch=function(type){var batch=init_batch("LANCZOS");apply_shader(batch,
"postprocessing/postprocessing.glslv","postprocessing/lanczos.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_size_multipler=1/cfg_def.resolution_factor;if(type=="LANCZOS_X")batch.texel_mask=new Float32Array([1,0]);else if(type=="LANCZOS_Y")batch.texel_mask=new Float32Array([0,1]);var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_compositing_batch=function(){var batch=
init_batch("COMPOSITING");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/compositing.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_motion_blur_batch=function(decay_threshold){var batch=init_batch("MOTION_BLUR");apply_shader(batch,
"postprocessing/postprocessing.glslv","postprocessing/motion_blur.glslf");set_batch_directive(batch,"BLUR_DECAY_THRESHOLD",shaders.glsl_value(decay_threshold));update_shader(batch);batch.use_backface_culling=true;batch.blend=false;batch.depth_mask=false;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_anaglyph_batch=function(post_effect){var batch=init_batch("ANAGLYPH");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/anaglyph.glslf");
update_shader(batch);batch.use_backface_culling=true;batch.blend=false;batch.depth_mask=false;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_line_batch=function(){var batch=init_batch("MAIN","LINE");apply_shader(batch,"line.glslv","line.glslf");set_batch_directive(batch,"NUM_POINTS",2);update_shader(batch);batch.use_backface_culling=false;batch.blend=false;batch.depth_mask=false;batch.diffuse_color=new Float32Array([0,1,0,1]);batch.draw_mode=
geometry.DM_LINES;batch.line_points=new Float32Array([0,0,0,1,1,1]);var submesh=primitives.generate_lines(1);update_batch_geometry(batch,submesh);return batch};exports.create_luminance_batch=function(){var batch=init_batch("LUMINANCE");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/luminance.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=
1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_average_luminance_batch=function(){var batch=init_batch("LUMINANCE");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/luminance_av.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();
update_batch_geometry(batch,submesh);return batch};exports.create_luminance_trunced_batch=function(){var batch=init_batch("LUMINANCE_X_BLUR");apply_shader(batch,"postprocessing/luminance_trunced.glslv","postprocessing/luminance_trunced.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,
submesh);return batch};exports.create_bloom_blur_batch=function(post_effect){var batch=init_batch("POSTPROCESSING");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/bloom_blur.glslf");switch(post_effect){case "X_BLUR":batch.texel_mask=new Float32Array([1,0]);break;case "Y_BLUR":batch.texel_mask=new Float32Array([0,1]);break;default:throw"Wrong postprocessing effect for bloom blur: "+post_effect;break}update_shader(batch);batch.texel_size=new Float32Array([0,0]);batch.texel_size_multipler=
1;batch.use_backface_culling=true;batch.blend=false;batch.depth_mask=false;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_bloom_combine_batch=function(){var batch=init_batch("BLOOM");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/bloom_combine.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=
1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,submesh);return batch};exports.create_velocity_batch=function(){var batch=init_batch("VELOCITY");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/velocity.glslf");update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;batch.texel_size=new Float32Array([0,0]);batch.texel_mask=new Float32Array([1,1]);batch.texel_size_multipler=1;var submesh=primitives.generate_billboard();update_batch_geometry(batch,
submesh);return batch};exports.set_texel_size=function(batch,size_x,size_y){var mult=batch.texel_size_multipler;batch.texel_size[0]=size_x*batch.texel_mask[0]*mult;batch.texel_size[1]=size_y*batch.texel_mask[1]*mult};exports.set_texel_size_mult=function(batch,mult){batch.texel_size_multipler=mult};exports.find_batch_material=function(obj,mat_name,type){var batches=obj._batches;var apt_batch=null;for(var j=0;j<batches.length;j++){var batch=batches[j];if(batch.material_names.indexOf(mat_name)>-1)if(type&&
batch.type==type||!type)if(batch.childs)return batch;else apt_batch=apt_batch===null?batch:apt_batch}return apt_batch};exports.clear_batch=function(batch){var textures=batch.textures;for(var i=0;i<textures.length;i++){var tex=textures[i];m_textures.delete_texture(tex.w_texture)}geometry.cleanup_bufs_data(batch.bufs_data)}};b4w.module["__nodemat"]=function(exports,require){var m_print=require("__print");var m_graph=require("__graph");var m_shaders=require("__shaders");var m_util=require("__util");var m_vec3=require("vec3");var m_mat3=require("mat3");var m_mat4=require("mat4");var _shader_ident_counters={};var _composed_node_graphs={};exports.compose_nmat_graph=function(node_tree,graph_id){if(graph_id in _composed_node_graphs)return _composed_node_graphs[graph_id];var graph=m_graph.create();var bpy_nodes=node_tree["nodes"];
for(var i=0;i<bpy_nodes.length;i++){var bpy_node=bpy_nodes[i];if(!append_nmat_node(graph,bpy_node,0)){_composed_node_graphs[graph_id]=null;return null}}var links=node_tree["links"];for(var i=0;i<links.length;i++){var link=links[i];var node_ids1=nmat_node_ids(link["from_node"],graph);var node_ids2=nmat_node_ids(link["to_node"],graph);for(var j=0;j<node_ids1.length;j++)for(var k=0;k<node_ids2.length;k++){var node_id1=node_ids1[j];var node_id2=node_ids2[k];var node_attr1=m_graph.get_node_attr(graph,
node_id1);var node_attr2=m_graph.get_node_attr(graph,node_id2);if(!append_nmat_edge(graph,node_id1,node_id2,node_attr1,node_attr2,link)){_composed_node_graphs[graph_id]=null;return null}}}complete_edges(graph);var output_id=find_output_id(node_tree,graph);if(output_id==-1){_composed_node_graphs[graph_id]=null;return null}nmat_cleanup_graph(graph);var graph_out=m_graph.subgraph_node_conn(graph,output_id,m_graph.BACKWARD_DIR);clean_sockets_linked_property(graph_out);merge_nodes(graph_out);optimize_geometry_vcol(graph_out);
if(!check_normalmaps_usage(graph_out)){m_print.error("Material has normalmap node but no material node");_composed_node_graphs[graph_id]=null;return null}_composed_node_graphs[graph_id]=graph_out;return graph_out};function check_normalmaps_usage(graph){var has_normalmap_node=false;var has_material_node=false;m_graph.traverse(graph,function(id,node){if(node.type=="MATERIAL"||node.type=="MATERIAL_EXT")has_material_node=true;if(node.type=="TEXTURE_NORMAL")has_normalmap_node=true});if(has_normalmap_node&&
!has_material_node)return false;return true}function clean_sockets_linked_property(graph){m_graph.traverse(graph,function(id,node){var inputs=node.inputs;var outputs=node.outputs;for(var i=0;i<inputs.length;i++)fix_socket_property(graph,inputs[i],id,i,1);for(var i=0;i<outputs.length;i++)fix_socket_property(graph,outputs[i],id,i,0)})}function fix_socket_property(graph,connection,id,num,check_in_edge){if(connection.is_linked){var clear_linked=true;m_graph.traverse_edges(graph,function(in_edge,out_edge,
sockets){if(!check_in_edge&&(in_edge==id&&sockets[0]==num)||check_in_edge&&(out_edge==id&&sockets[1]==num))clear_linked=false});if(clear_linked)connection.is_linked=false}}function complete_edges(graph){var appended_edges=[];m_graph.traverse(graph,function(id,attr){switch(attr.type){case "TRANSLUCENCY":m_graph.traverse_edges(graph,function(edge_from,edge_to,edge_attr){if(edge_from==id){var from_socket_index=edge_attr[0];if(attr.outputs[from_socket_index].name=="Translucency")appended_edges.push(edge_from,
edge_to,[edge_attr[0]+1,edge_attr[1]+1])}});break}});for(var i=0;i<appended_edges.length;i+=3)m_graph.append_edge(graph,appended_edges[i],appended_edges[i+1],appended_edges[i+2])}function nmat_node_ids(bpy_node,graph){var node_ids=[];m_graph.traverse(graph,function(id,attr){if(attr.name==bpy_node["name"])node_ids.push(id)});if(node_ids.length)return node_ids;else throw"Node not found";}function nmat_cleanup_graph(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type=="REPLACE")id_attr.push(id,
attr);if(attr.type=="PARALLAX")id_attr.push(id,attr);if(attr.type=="REROUTE")id_attr.push(id,attr)});for(var i=0;i<id_attr.length;i+=2){var id=id_attr[i];var attr=id_attr[i+1];if(attr.type=="REPLACE"){var input_id0=m_graph.get_in_edge(graph,id,0);var input_id1=m_graph.get_in_edge(graph,id,1);var in_edge0=m_graph.get_edge_attr(graph,input_id0,id,0);var in_edge1=m_graph.get_edge_attr(graph,input_id1,id,0);m_graph.remove_edge(graph,input_id0,id,-1);m_graph.remove_edge(graph,input_id1,id,-1);if(in_edge0[1]==
1){var input_id=input_id0;var from_index=in_edge0[0]}else{var input_id=input_id1;var from_index=in_edge1[0]}var removed_edges=[];for(var j=0;j<m_graph.out_edge_count(graph,id);j++){var output_id=m_graph.get_out_edge(graph,id,j);var to_index=m_graph.get_edge_attr(graph,id,output_id,0)[1];m_graph.append_edge(graph,input_id,output_id,[from_index,to_index]);removed_edges.push(id,output_id)}for(var j=0;j<removed_edges.length;j+=2)m_graph.remove_edge(graph,removed_edges[j],removed_edges[j+1],-1)}else if(attr.type==
"PARALLAX"){var input_id1=m_graph.get_in_edge(graph,id,1);if(input_id1!=-1){var input_input_id=m_graph.get_in_edge(graph,input_id1,0);m_graph.remove_edge(graph,input_id1,id,-1);if(input_input_id!=-1)m_graph.remove_edge(graph,input_input_id,input_id1,-1);var input1_attr=m_graph.get_node_attr(graph,input_id1);attr.data=input1_attr.data;attr.params[0]=input1_attr.params[0];m_graph.remove_node(graph,input_id1)}attr.inputs.splice(1,1)}else if(attr.type=="REROUTE"){var input_id=m_graph.get_in_edge(graph,
id,0);var out_edge_count=m_graph.out_edge_count(graph,id);var removed_edges=[];var output_ids=[];var edges_quantity=[];for(var j=0;j<out_edge_count;j++){var output_id=m_graph.get_out_edge(graph,id,j);var id_place=output_ids.indexOf(output_id);if(id_place!=-1)edges_quantity[id_place]+=1;else{output_ids.push(output_id);edges_quantity.push(1);removed_edges.push(id,output_id)}}if(input_id!=-1){var from_index=m_graph.get_edge_attr(graph,input_id,id,0)[0];for(var j=0;j<output_ids.length;j++)for(var k=0;k<
edges_quantity[j];k++){var to_index=m_graph.get_edge_attr(graph,id,output_ids[j],k)[1];m_graph.append_edge(graph,input_id,output_ids[j],[from_index,to_index])}}for(var j=0;j<removed_edges.length;j+=2)m_graph.remove_edge(graph,removed_edges[j],removed_edges[j+1],-1)}}}function merge_nodes(graph){merge_geometry(graph);merge_textures(graph)}function merge_geometry(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type=="GEOMETRY_VC"||(attr.type=="GEOMETRY_UV"||(attr.type=="GEOMETRY_NO"||
(attr.type=="GEOMETRY_FB"||(attr.type=="GEOMETRY_VW"||attr.type=="GEOMETRY_GL")))))id_attr.push(id,attr)});var unique_nodes=[];for(var i=0;i<id_attr.length;i+=2){var id_current=id_attr[i];var attr_current=id_attr[i+1];var is_unique=true;for(var j=0;j<unique_nodes.length;j++){var unode=unique_nodes[j];if(can_merge_nodes(attr_current,unode.attr)){var removed_edges=[];var out_num=m_graph.out_edge_count(graph,id_current);for(k=0;k<out_num;k++){var out_id=m_graph.get_out_edge(graph,id_current,k);var edge_attr=
m_graph.get_edge_attr(graph,id_current,out_id,0);removed_edges.push(id_current,out_id,edge_attr);m_graph.append_edge(graph,unode.id,out_id,edge_attr)}for(var k=0;k<removed_edges.length;k+=3)m_graph.remove_edge(graph,removed_edges[k],removed_edges[k+1],0);m_graph.remove_node(graph,id_current);is_unique=false;break}}if(is_unique){var unode={id:id_current,attr:attr_current};unique_nodes.push(unode)}}}function merge_textures(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type==
"TEXTURE_COLOR"||attr.type=="TEXTURE_NORMAL")id_attr.push(id,attr)});var unique_nodes=[];for(var i=0;i<id_attr.length;i+=2){var id_current=id_attr[i];var attr_current=id_attr[i+1];var is_unique=true;for(var j=0;j<unique_nodes.length;j++){var unode=unique_nodes[j];if(unode.merged_nodes.length>=2)continue;if(can_merge_nodes(attr_current,unode.attr)){var removed_edges_in=[];var in_num=m_graph.in_edge_count(graph,id_current);var edges_in_counter={};for(k=0;k<in_num;k++){var in_id=m_graph.get_in_edge(graph,
id_current,k);if(!(in_id in edges_in_counter))edges_in_counter[in_id]=0;var edge_attr=m_graph.get_edge_attr(graph,in_id,id_current,edges_in_counter[in_id]++);removed_edges_in.push(in_id,id_current,edge_attr)}var removed_edges_out=[];var out_num=m_graph.out_edge_count(graph,id_current);var edges_out_counter={};for(k=0;k<out_num;k++){var out_id=m_graph.get_out_edge(graph,id_current,k);if(!(out_id in edges_out_counter))edges_out_counter[out_id]=0;var edge_attr=m_graph.get_edge_attr(graph,id_current,
out_id,edges_out_counter[out_id]++);removed_edges_out.push(id_current,out_id,edge_attr)}var removed_edges=removed_edges_in.concat(removed_edges_out);for(var k=0;k<removed_edges.length;k+=3)m_graph.remove_edge(graph,removed_edges[k],removed_edges[k+1],0);m_graph.remove_node(graph,id_current);var mnode={attr:attr_current,edges_in:removed_edges_in,edges_out:removed_edges_out};unode.merged_nodes.push(mnode);is_unique=false;break}}if(is_unique){var unode={id:id_current,attr:attr_current,merged_nodes:[]};
unique_nodes.push(unode)}}for(var i=0;i<unique_nodes.length;i++){var unode=unique_nodes[i];var mnodes_count=unode.merged_nodes.length;var in_num=unode.attr.inputs.length;var out_num=unode.attr.outputs.length;for(var j=0;j<mnodes_count;j++){var merged_data=unode.merged_nodes[j];var mnode=merged_data.attr;var edges_in=merged_data.edges_in;var edges_out=merged_data.edges_out;unode.attr.inputs=unode.attr.inputs.concat(mnode.inputs);unode.attr.outputs=unode.attr.outputs.concat(mnode.outputs);for(var k=
0;k<unode.attr.inputs.length;k++)unode.attr.inputs[k].identifier+=m_util.trunc(k/in_num)+1;for(var k=0;k<unode.attr.outputs.length;k++)unode.attr.outputs[k].identifier+=m_util.trunc(k/out_num)+1;for(var k=0;k<edges_in.length;k+=3){var in_id=edges_in[k];var edge_attr=edges_in[k+2];edge_attr[1]+=(j+1)*in_num;m_graph.append_edge(graph,in_id,unode.id,edge_attr)}for(var k=0;k<edges_out.length;k+=3){var out_id=edges_out[k+1];var edge_attr=edges_out[k+2];edge_attr[0]+=(j+1)*out_num;m_graph.append_edge(graph,
unode.id,out_id,edge_attr)}}switch(mnodes_count){case 1:unode.attr.type+="2";break;case 2:unode.attr.type+="3";break}m_graph.remove_node(graph,unode.id);m_graph.append_node(graph,unode.id,unode.attr)}}function can_merge_nodes(attr1,attr2){if(attr1.type!==attr2.type)return false;switch(attr1.type){case "GEOMETRY_VC":case "GEOMETRY_UV":return attr1.data.value==attr2.data.value;case "GEOMETRY_NO":case "GEOMETRY_FB":case "GEOMETRY_VW":case "GEOMETRY_GL":return true;case "TEXTURE_COLOR":case "TEXTURE_NORMAL":return attr1.data.value==
attr2.data.value;default:return false}}function optimize_geometry_vcol(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type=="GEOMETRY_VC")id_attr.push(id,attr)});for(var i=0;i<id_attr.length;i+=2){var geom_id=id_attr[i];var geom_attr=id_attr[i+1];var need_optimize=false;var removed_edges=[];var removed_seprgb_nodes=[];var channels_usage=[[],[],[]];var geometry_out_num=m_graph.out_edge_count(graph,geom_id);for(var j=0;j<geometry_out_num;j++){var out_id=m_graph.get_out_edge(graph,
geom_id,j);var out_node=m_graph.get_node_attr(graph,out_id);if(out_node.type!="SEPRGB"){need_optimize=false;break}removed_edges.push(geom_id,out_id);var edges_out_num={};var seprgb_out_num=m_graph.out_edge_count(graph,out_id);for(var k=0;k<seprgb_out_num;k++){var seprgb_out_id=m_graph.get_out_edge(graph,out_id,k);if(!(seprgb_out_id in edges_out_num))edges_out_num[seprgb_out_id]=0;var edge_attr=m_graph.get_edge_attr(graph,out_id,seprgb_out_id,edges_out_num[seprgb_out_id]++);removed_edges.push(out_id,
seprgb_out_id);channels_usage[edge_attr[0]].push(geom_id,seprgb_out_id,edge_attr)}removed_seprgb_nodes.push(out_id);need_optimize=true}if(need_optimize){var channels_count=0;var mask=0;for(var j=0;j<channels_usage.length;j++)if(channels_usage[j].length){channels_count++;mask|=1<<2-j}if(channels_count){geom_attr.type+=channels_count;geom_attr.outputs=[];for(var j=0;j<channels_usage.length;j++)if(channels_usage[j].length){geom_attr.outputs.push({default_value:0,identifier:"RGB"[j],is_linked:true,name:"RGB"[j]});
for(var k=0;k<channels_usage[j].length;k+=3)channels_usage[j][k+2][0]=m_util.rgb_mask_get_channel_presence_index(mask,j)}for(var j=0;j<removed_edges.length;j+=2)m_graph.remove_edge(graph,removed_edges[j],removed_edges[j+1],0);for(var j=0;j<removed_seprgb_nodes.length;j++)m_graph.remove_node(graph,removed_seprgb_nodes[j]);for(var j=0;j<channels_usage.length;j++)for(var k=0;k<channels_usage[j].length;k+=3)m_graph.append_edge(graph,channels_usage[j][k],channels_usage[j][k+1],channels_usage[j][k+2])}}}}
function find_output_id(node_tree,graph){var bpy_nodes=node_tree["nodes"];var last_output_node=null;for(var i=0;i<bpy_nodes.length;i++){var bpy_node=bpy_nodes[i];if(bpy_node["type"]=="OUTPUT")last_output_node=bpy_node}if(!last_output_node){m_print.error("No output in node material");return-1}return nmat_node_ids(last_output_node,graph)[0]}function append_nmat_node(graph,bpy_node,geometry_output_num){var name=bpy_node["name"];var type=bpy_node["type"];var vparams=[];var inputs=[];var outputs=[];var params=
[];var data=null;switch(type){case "CAMERA":inputs=[];outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "COMBRGB":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "GEOMETRY":if(!check_geometry_node_outputs(bpy_node))return true;type=geometry_node_type(bpy_node,geometry_output_num);if(!type){m_print.error("Geometry output is not supported");return false}switch(type){case "GEOMETRY_UV":var uv_name=shader_ident("param_GEOMETRY_UV_a");var uv_tra_name=shader_ident("param_GEOMETRY_UV_v");
vparams.push(node_param(uv_name));vparams.push(node_param(uv_tra_name));outputs.push(node_output_by_ident(bpy_node,"UV"));params.push(node_param(uv_tra_name));data={name:uv_name,value:bpy_node["uv_layer"]};break;case "GEOMETRY_VC":var vc_name=shader_ident("param_GEOMETRY_VC_a");var vc_tra_name=shader_ident("param_GEOMETRY_VC_v");vparams.push(node_param(vc_name));vparams.push(node_param(vc_tra_name));outputs.push(node_output_by_ident(bpy_node,"Vertex Color"));params.push(node_param(vc_tra_name));data=
{name:vc_name,value:bpy_node["color_layer"]};break;case "GEOMETRY_NO":outputs.push(node_output_by_ident(bpy_node,"Normal"));break;case "GEOMETRY_FB":outputs.push(node_output_by_ident(bpy_node,"Front/Back"));break;case "GEOMETRY_VW":outputs.push(node_output_by_ident(bpy_node,"View"));break;case "GEOMETRY_GL":outputs.push(node_output_by_ident(bpy_node,"Global"));break}break;case "GROUP":var node_name=bpy_node["node_tree_name"].replace(/\.[0-9]{3,}$/g,"");switch(node_name){case "LINEAR_TO_SRGB":type=
"LINEAR_TO_SRGB";break;case "NORMAL_VIEW":type="NORMAL_VIEW";break;case "REPLACE":type="REPLACE";break;case "SRGB_TO_LINEAR":type="SRGB_TO_LINEAR";break;case "REFLECT":type="REFLECT";break;case "PARALLAX":type="PARALLAX";var tex_name=shader_ident("temp_texture");params.push(node_param(tex_name));break;case "CLAMP":type="CLAMP";break;case "TRANSLUCENCY":type="TRANSLUCENCY";break;case "TIME":type="TIME";break;default:m_print.error("Wrong group node: "+bpy_node["node_tree_name"]);return false}inputs=
node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);if(node_name=="TRANSLUCENCY"){var out=default_node_inout("TranslucencyParams","TranslucencyParams",[0,0,0,0]);out.is_linked=outputs[0].is_linked;outputs.push(out)}break;case "NORMAL":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);var output_norm=node_output_by_ident(bpy_node,"Normal");params.push(node_param(shader_ident("param_NORMAL_Normal"),output_norm.default_value,3));break;case "MAPPING":inputs.push(node_input_by_ident(bpy_node,
"Vector"));outputs.push(node_output_by_ident(bpy_node,"Vector"));if(m_vec3.length(bpy_node["translation"])==0&&(m_vec3.length(bpy_node["rotation"])==0&&(!bpy_node["use_max"]&&!bpy_node["use_min"]))){type="MAPPING_LIGHT";params.push(node_param(shader_ident("param_MAPPING_LIGHT_scale"),bpy_node["scale"],3))}else{type="MAPPING_HEAVY";var rot=bpy_node["rotation"];var rot_matrix=m_mat3.create();var cosX=Math.cos(rot[0]);var cosY=Math.cos(rot[1]);var cosZ=Math.cos(rot[2]);var sinX=Math.sin(rot[0]);var sinY=
Math.sin(rot[1]);var sinZ=Math.sin(rot[2]);var cosXcosZ=cosX*cosZ;var cosXsinZ=cosX*sinZ;var sinXcosZ=sinX*cosZ;var sinXsinZ=sinX*sinZ;rot_matrix[0]=cosY*cosZ;rot_matrix[1]=cosY*sinZ;rot_matrix[2]=-sinY;rot_matrix[3]=sinY*sinXcosZ-cosXsinZ;rot_matrix[4]=sinY*sinXsinZ+cosXcosZ;rot_matrix[5]=cosY*sinX;rot_matrix[6]=sinY*cosXcosZ+sinXsinZ;rot_matrix[7]=sinY*cosXsinZ-sinXcosZ;rot_matrix[8]=cosY*cosX;var scale=bpy_node["scale"];var scale_matrix=new Float32Array([scale[0],0,0,0,scale[1],0,0,0,scale[2]]);
var trs_matrix=m_mat3.create();m_mat3.multiply(rot_matrix,scale_matrix,trs_matrix);var trans=bpy_node["translation"];trs_matrix=m_util.mat3_to_mat4(trs_matrix,m_mat4.create());trs_matrix[12]=trans[0];trs_matrix[13]=trans[1];trs_matrix[14]=trans[2];params.push(node_param(shader_ident("param_MAPPING_HEAVY_trs_matrix"),trs_matrix,16));params.push(node_param(shader_ident("param_MAPPING_HEAVY_use_min"),~~bpy_node["use_min"],1));params.push(node_param(shader_ident("param_MAPPING_HEAVY_use_max"),~~bpy_node["use_max"],
1));params.push(node_param(shader_ident("param_MAPPING_LIGHT_min_clip"),bpy_node["min"],3));params.push(node_param(shader_ident("param_MAPPING_LIGHT_max_clip"),bpy_node["max"],3))}break;case "MATERIAL":case "MATERIAL_EXT":var mat=bpy_node["material"];if(!mat){m_print.error("Emtpy material slot in node: "+bpy_node["name"]);return false}var input=node_input_by_ident(bpy_node,"Color");input.default_value.splice(3);inputs.push(input);var input=node_input_by_ident(bpy_node,"Alpha");if(input)inputs.push(input);
else inputs.push(default_node_inout("Alpha","Alpha",1));var input=node_input_by_ident(bpy_node,"Spec");input.default_value.splice(3);inputs.push(input);var input_norm=node_input_by_ident(bpy_node,"Normal");input_norm.default_value.splice(3);inputs.push(input_norm);outputs.push(node_output_by_ident(bpy_node,"Color"));outputs.push(node_output_by_ident(bpy_node,"Alpha"));outputs.push(node_output_by_ident(bpy_node,"Normal"));if(type=="MATERIAL_EXT"){var input=node_input_by_ident(bpy_node,"Emit");if(input)inputs.push(input);
else inputs.push(default_node_inout("Emit","Emit",0));var input=node_input_by_ident(bpy_node,"Translucency");input.default_value=0;input.name="Translucency";input.identifier="Translucency";if(input)inputs.push(input);else inputs.push(default_node_inout(input.name,input.identifier,input.default_value));var input=node_input_by_ident(bpy_node,"Translucency");input.default_value=[0,0,0,0];input.name="TranslucencyParams";input.identifier="TranslucencyParams";if(input)inputs.push(input);else inputs.push(default_node_inout(input.name,
input.identifier,input.default_value));outputs.push(node_output_by_ident(bpy_node,"Diffuse"));outputs.push(node_output_by_ident(bpy_node,"Spec"))}var spec_param;switch(mat["specular_shader"]){case "COOKTORR":case "PHONG":spec_param=mat["specular_hardness"];break;case "WARDISO":spec_param=mat["specular_slope"];break}var diffuse_param;var diffuse_param2;switch(mat["diffuse_shader"]){case "LAMBERT":diffuse_param=0;diffuse_param2=0;break;case "OREN_NAYAR":diffuse_param=mat["roughness"];diffuse_param2=
0;break;case "FRESNEL":diffuse_param=mat["diffuse_fresnel"];diffuse_param2=mat["diffuse_fresnel_factor"];break}params.push(node_param(shader_ident("param_MATERIAL_diffuse"),[bpy_node["use_diffuse"]?1:0,diffuse_param,diffuse_param2],3));params.push(node_param(shader_ident("param_MATERIAL_spec"),[bpy_node["use_specular"]?1:0,mat["specular_intensity"],spec_param],3));params.push(node_param(shader_ident("param_MATERIAL_norm"),input_norm.is_linked?1:0,1));data={name:bpy_node["name"],value:mat};break;case "MATH":switch(bpy_node["operation"]){case "ADD":type=
"MATH_ADD";break;case "SUBTRACT":type="MATH_SUBTRACT";break;case "MULTIPLY":type="MATH_MULTIPLY";break;case "DIVIDE":type="MATH_DIVIDE";break;case "SINE":type="MATH_SINE";break;case "COSINE":type="MATH_COSINE";break;case "TANGENT":type="MATH_TANGENT";break;case "ARCSINE":type="MATH_ARCSINE";break;case "ARCCOSINE":type="MATH_ARCCOSINE";break;case "ARCTANGENT":type="MATH_ARCTANGENT";break;case "POWER":type="MATH_POWER";break;case "LOGARITHM":type="MATH_LOGARITHM";break;case "MINIMUM":type="MATH_MINIMUM";
break;case "MAXIMUM":type="MATH_MAXIMUM";break;case "ROUND":type="MATH_ROUND";break;case "LESS_THAN":type="MATH_LESS_THAN";break;case "GREATER_THAN":type="MATH_GREATER_THAN";break;case "MODULO":type="MATH_MODULO";break;default:m_print.error("Unsupported MATH operation: "+bpy_node["operation"]);return false}inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "MIX_RGB":switch(bpy_node["blend_type"]){case "MIX":type="MIX_RGB_MIX";break;case "ADD":type="MIX_RGB_ADD";
break;case "MULTIPLY":type="MIX_RGB_MULTIPLY";break;case "SUBTRACT":type="MIX_RGB_SUBTRACT";break;case "SCREEN":type="MIX_RGB_SCREEN";break;case "DIVIDE":type="MIX_RGB_DIVIDE";break;case "DIFFERENCE":type="MIX_RGB_DIFFERENCE";break;case "DARKEN":type="MIX_RGB_DARKEN";break;case "LIGHTEN":type="MIX_RGB_LIGHTEN";break;case "OVERLAY":type="MIX_RGB_OVERLAY";break;case "DODGE":type="MIX_RGB_DODGE";break;case "BURN":type="MIX_RGB_BURN";break;case "HUE":type="MIX_RGB_HUE";break;case "SATURATION":type="MIX_RGB_SATURATION";
break;case "VALUE":type="MIX_RGB_VALUE";break;case "COLOR":type="MIX_RGB_COLOR";break;case "SOFT_LIGHT":type="MIX_RGB_SOFT_LIGHT";break;case "LINEAR_LIGHT":type="MIX_RGB_LINEAR_LIGHT";break;default:m_print.error("Unsupported MIX_RGB blend type: "+bpy_node["blend_type"]);return false}inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "OUTPUT":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=[];break;case "RGB":var output=node_output_by_ident(bpy_node,"Color");
outputs.push(output);params.push(node_param(shader_ident("param_RGB_Color"),output.default_value,3));break;case "SEPRGB":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "TEXTURE":if(!bpy_node["texture"]){m_print.error("No texture attached to node: "+bpy_node["name"]);return false}type=texture_node_type(bpy_node);inputs.push(node_input_by_ident(bpy_node,"Vector"));if(type=="TEXTURE_COLOR"||type=="TEXTURE_ENVIRONMENT"){outputs.push(node_output_by_ident(bpy_node,
"Color"));outputs.push(node_output_by_ident(bpy_node,"Value"))}if(type=="TEXTURE_NORMAL"){outputs.push(node_output_by_ident(bpy_node,"Normal"));outputs.push(node_output_by_ident(bpy_node,"Value"))}var tex_name=shader_ident("param_TEXTURE_texture");params.push(node_param(tex_name));data={name:tex_name,value:bpy_node["texture"]};break;case "VALUE":var output=node_output_by_ident(bpy_node,"Value");outputs.push(output);params.push(node_param(shader_ident("param_VALUE_Value"),output.default_value,1));
break;case "VECT_MATH":switch(bpy_node["operation"]){case "ADD":type="VECT_MATH_ADD";break;case "SUBTRACT":type="VECT_MATH_SUBTRACT";break;case "AVERAGE":type="VECT_MATH_AVERAGE";break;case "DOT_PRODUCT":type="VECT_MATH_DOT_PRODUCT";break;case "CROSS_PRODUCT":type="VECT_MATH_CROSS_PRODUCT";break;case "NORMALIZE":type="VECT_MATH_NORMALIZE";break;default:m_print.error("Unsupported VECT_MATH operation: "+bpy_node["operation"]);return false}inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);
break;default:inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break}var attr={name:name,type:type,vparams:vparams,inputs:inputs,outputs:outputs,params:params,data:data};m_graph.append_node(graph,m_graph.gen_node_id(graph),attr);if(bpy_node["type"]=="GEOMETRY"&&geometry_check_next(bpy_node,geometry_output_num))if(!append_nmat_node(graph,bpy_node,++geometry_output_num))return false;return true}function reset_shader_ident_counters(){_shader_ident_counters={}}function shader_ident(name_base){if(!_shader_ident_counters[name_base])_shader_ident_counters[name_base]=
0;var name=name_base+_shader_ident_counters[name_base];name=name.replace(/ /g,"_").replace(/\//g,"_");_shader_ident_counters[name_base]++;return name}function check_geometry_node_outputs(bpy_node){var outputs=bpy_node["outputs"];for(var i=0;i<outputs.length;i++){var output=outputs[i];if(output["is_linked"])return true}return false}function geometry_node_type(bpy_node,output_num){var outputs=bpy_node["outputs"];var out_counter=0;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;
if(out_counter++<output_num)continue;switch(output["identifier"]){case "UV":return"GEOMETRY_UV";case "Vertex Color":return"GEOMETRY_VC";case "Normal":return"GEOMETRY_NO";case "Front/Back":return"GEOMETRY_FB";case "View":return"GEOMETRY_VW";case "Global":return"GEOMETRY_GL";default:return null}}}function geometry_check_next(bpy_node,output_num){var outputs=bpy_node["outputs"];var out_counter=0;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;if(out_counter++>
output_num)return true}return false}function texture_node_type(bpy_node){var outputs=bpy_node["outputs"];var node_value=false;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;var ident=output["identifier"];switch(ident){case "Color":if(bpy_node["texture"]["type"]=="ENVIRONMENT_MAP")return"TEXTURE_ENVIRONMENT";else return"TEXTURE_COLOR";case "Normal":return"TEXTURE_NORMAL";case "Value":node_value=true;break;default:throw"Unknown texture output";}}if(node_value)if(bpy_node["texture"]["type"]==
"ENVIRONMENT_MAP")return"TEXTURE_ENVIRONMENT";else return"TEXTURE_COLOR"}function node_input_by_ident(bpy_node,ident){var inputs=bpy_node["inputs"];for(var i=0;i<inputs.length;i++){var input=inputs[i];if(input["identifier"]==ident)return node_inout_bpy_to_b4w(input)}return null}function node_output_by_ident(bpy_node,ident){var outputs=bpy_node["outputs"];for(var i=0;i<outputs.length;i++){var output=outputs[i];if(output["identifier"]==ident)return node_inout_bpy_to_b4w(output)}return null}function node_inout_bpy_to_b4w(bpy_node_inout){return{name:bpy_node_inout["name"],
identifier:bpy_node_inout["identifier"],is_linked:bpy_node_inout["is_linked"],default_value:bpy_to_b4w_value(bpy_node_inout["default_value"])}}function default_node_inout(name,identifier,default_value){return{name:name,identifier:identifier,is_linked:false,default_value:default_value}}function bpy_to_b4w_value(value){if(m_util.is_vector(value))return value.slice(0);return value}function node_inputs_bpy_to_b4w(bpy_node){var inputs=[];for(var i=0;i<bpy_node["inputs"].length;i++){var input=node_inout_bpy_to_b4w(bpy_node["inputs"][i]);
if(input.default_value.length)input.default_value.splice(3);inputs.push(input)}return inputs}function node_outputs_bpy_to_b4w(bpy_node){var outputs=[];for(var i=0;i<bpy_node["outputs"].length;i++){var output=node_inout_bpy_to_b4w(bpy_node["outputs"][i]);outputs.push(output)}return outputs}function node_param(name,value,dim){if(value===null||value===undefined)var pval=null;else var pval=m_shaders.glsl_value(value,dim);var param={name:name,value:pval};return param}function append_nmat_edge(graph,id1,
id2,attr1,attr2,bpy_link){var attr=[];var ident1=bpy_link["from_socket"]["identifier"];var ident2=bpy_link["to_socket"]["identifier"];var outputs1=attr1.outputs;for(var i=0;i<outputs1.length;i++){var out1=outputs1[i];if(out1.identifier==ident1){attr.push(i);break}}var inputs2=attr2.inputs;for(var i=0;i<inputs2.length;i++){var in2=inputs2[i];if(in2.identifier==ident2){attr.push(i);break}}if(attr.length==2)m_graph.append_edge(graph,id1,id2,attr);return true}exports.compose_node_elements=function(graph){var node_elements=
[];var node_elem_map={};reset_shader_ident_counters();var sgraph=m_graph.topsort(graph);m_graph.traverse(sgraph,function(id,attr){var elem=init_node_elem(attr);node_elements.push(elem);node_elem_map[id]=elem});m_graph.traverse_edges(sgraph,function(id1,id2,attr){var node1=m_graph.get_node_attr(sgraph,id1);var node2=m_graph.get_node_attr(sgraph,id2);var out1=node1.outputs[attr[0]];var in2=node2.inputs[attr[1]];var elem1_outputs=node_elem_map[id1].outputs;var elem2_inputs=node_elem_map[id2].inputs;
var name=elem1_outputs[attr[0]]||shader_ident("out_"+node1.type+"_"+out1.identifier);elem1_outputs[attr[0]]=name;elem2_inputs[attr[1]]=name});return node_elements};function init_node_elem(mat_node){var finputs=[];var finput_values=[];var foutputs=[];var fparams=[];var fparam_values=[];var vparams=[];for(var i=0;i<mat_node.inputs.length;i++){var input=mat_node.inputs[i];if(input.is_linked){finputs.push(null);finput_values.push(null)}else{finputs.push(shader_ident("in_"+mat_node.type+"_"+input.identifier));
finput_values.push(m_shaders.glsl_value(input.default_value,0))}}for(var i=0;i<mat_node.outputs.length;i++){var output=mat_node.outputs[i];if(output.is_linked)foutputs.push(null);else foutputs.push(shader_ident("out_"+mat_node.type+"_"+output.identifier))}for(var i=0;i<mat_node.params.length;i++){var param=mat_node.params[i];fparams.push(param.name);fparam_values.push(param.value)}for(var i=0;i<mat_node.vparams.length;i++){var vparam=mat_node.vparams[i];vparams.push(vparam.name)}var elem={id:mat_node.type,
inputs:finputs,input_values:finput_values,outputs:foutputs,params:fparams,param_values:fparam_values,vparams:vparams};return elem}exports.cleanup=cleanup;function cleanup(){for(var graph_id in _composed_node_graphs){var graph=_composed_node_graphs[graph_id];delete _composed_node_graphs[graph_id]}}};b4w.module["__animation"]=function(exports,require){var m_config=require("__config");var m_dbg=require("__debug");var m_particles=require("__particles");var m_phy=require("__physics");var m_print=require("__print");var m_scs=require("__scenes");var m_sfx=require("__sfx");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_mat4=require("mat4");var m_quat=require("quat");var cfg_ani=m_config.animation;var OBJ_ANIM_TYPE_ARMATURE=10;var OBJ_ANIM_TYPE_SKELETAL=
20;var OBJ_ANIM_TYPE_OBJECT=30;var OBJ_ANIM_TYPE_VERTEX=40;var OBJ_ANIM_TYPE_SOUND=50;var OBJ_ANIM_TYPE_STATIC=60;exports.OBJ_ANIM_TYPE_ARMATURE=OBJ_ANIM_TYPE_ARMATURE;exports.OBJ_ANIM_TYPE_SKELETAL=OBJ_ANIM_TYPE_SKELETAL;exports.OBJ_ANIM_TYPE_OBJECT=OBJ_ANIM_TYPE_OBJECT;exports.OBJ_ANIM_TYPE_VERTEX=OBJ_ANIM_TYPE_VERTEX;exports.OBJ_ANIM_TYPE_SOUND=OBJ_ANIM_TYPE_SOUND;exports.OBJ_ANIM_TYPE_STATIC=OBJ_ANIM_TYPE_STATIC;var KF_INTERP_BEZIER=0;var KF_INTERP_LINEAR=1;var KF_INTERP_CONSTANT=2;var AB_CYCLIC=
10;var AB_FINISH_RESET=20;var AB_FINISH_STOP=30;exports.AB_CYCLIC=AB_CYCLIC;exports.AB_FINISH_RESET=AB_FINISH_RESET;exports.AB_FINISH_STOP=AB_FINISH_STOP;var _frame_info_tmp=new Array(3);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _quat4_tmp2=new Float32Array(4);var _tsr8_tmp=new Float32Array(8);var _mat4_tmp=new Float32Array(16);var _anim_objs_cache=[];var _actions=[];exports.frame_to_sec=function(frame){return frame/cfg_ani.framerate};
exports.update=function(elapsed){for(var i=0;i<_anim_objs_cache.length;i++){var obj=_anim_objs_cache[i];animate(obj,elapsed)}};exports.get_all_actions=function(){return _actions};function apply_vertex_anim(obj,va){obj._anim.type=OBJ_ANIM_TYPE_VERTEX;var start=va["frame_start"];var length=va["frame_end"]-start+1;obj._anim.start=start;obj._anim.current_frame_float=start;obj._anim.length=length;obj._anim.va_name=va["name"];var va_frame_offset=0;for(var i=0;i<obj["data"]["b4w_vertex_anim"].length;i++){var va_i=
obj["data"]["b4w_vertex_anim"][i];if(va_i==va)break;else va_frame_offset+=va_i["frame_end"]-va_i["frame_start"]+1}obj._anim.va_frame_offset=va_frame_offset}function init_anim(obj){obj._anim={};obj._anim.play=false;obj._anim.behavior=AB_FINISH_RESET;obj._anim.current_frame_float=0;obj._anim.start=0;obj._anim.length=0;obj._anim.trans_smooth_period=0;obj._anim.quat_smooth_period=0;obj._action_anim_cache=obj._action_anim_cache||[]}function update_anim_cache(obj){if(_anim_objs_cache.indexOf(obj)==-1)_anim_objs_cache.push(obj)}
exports.get_current_action=function(obj){if(obj._anim)return obj._anim.action;else return null};exports.get_anim_names=function(obj){var anim_names=[];if(has_vertex_anim(obj))for(var i=0;i<obj["data"]["b4w_vertex_anim"].length;i++)anim_names.push(obj["data"]["b4w_vertex_anim"][i]["name"]);else for(var i=0;i<_actions.length;i++)anim_names.push(_actions[i]["name"]);return anim_names};exports.get_current_va_name=function(obj){if(obj._anim)return obj._anim.va_name;else return null};exports.get_anim_type=
function(obj){return obj._anim.type};exports.apply_def=apply_def;function apply_def(obj){var action=get_default_action(obj);if(action){do_before_apply(obj);apply_action(obj,action);do_after_apply(obj)}else if(has_vertex_anim(obj)){do_before_apply(obj);apply_vertex_anim(obj,obj["data"]["b4w_vertex_anim"][0]);do_after_apply(obj)}else{do_before_apply(obj);obj._anim.type=OBJ_ANIM_TYPE_STATIC;var frame_range=m_scs.get_scene_timeline(m_scs.get_active());obj._anim.start=frame_range[0];obj._anim.current_frame_float=
frame_range[0];obj._anim.length=frame_range[1]-frame_range[0]+1;do_after_apply(obj)}}function get_default_action(obj){var armobj=get_first_armature_object(obj);if(armobj){var anim_data=armobj["animation_data"];if(anim_data&&anim_data["action"])return anim_data["action"]}var anim_data=obj["animation_data"];if(anim_data&&anim_data["action"])return anim_data["action"];if(m_sfx.is_speaker(obj)&&(obj["data"]["animation_data"]&&obj["data"]["animation_data"]["action"]))return obj["data"]["animation_data"]["action"];
return null}function has_vertex_anim(obj){if(m_util.is_mesh(obj)&&obj._render.vertex_anim)return true;else return false}exports.get_first_armature_object=get_first_armature_object;function get_first_armature_object(obj){var modifiers=obj["modifiers"];for(var i=0;i<modifiers.length;i++){var modifier=modifiers[i];if(modifier["type"]=="ARMATURE")return modifier["object"]}return null}exports.play=play;function play(obj,finish_callback,offset){if(obj._anim){if(obj._anim.play)stop(obj);if(offset)obj._anim.current_frame_float+=
cfg_ani.framerate*offset;obj._anim.play=true;if(finish_callback)obj._anim.finish_callback=finish_callback;else obj._anim.finish_callback=null}}exports.stop=stop;function stop(obj){if(obj._anim){obj._anim.play=false;delete obj._anim.finish_callback}}exports.is_play=function(obj){if(obj._anim)return obj._anim.play};exports.set_current_frame_float=function(obj,cff){if(obj._anim)obj._anim.current_frame_float=cff};exports.get_current_frame_float=function(obj){if(obj._anim&&obj._anim.current_frame_float)return obj._anim.current_frame_float;
else return 0};exports.cyclic=cyclic;function cyclic(obj,cyclic){if(obj._anim)obj._anim.behavior=cyclic?AB_CYCLIC:AB_FINISH_RESET}exports.is_cyclic=function(obj){if(obj._anim)return obj._anim.behavior==AB_CYCLIC?true:false};exports.set_behavior=function(obj,behavior){if(obj._anim)obj._anim.behavior=behavior};exports.get_behavior=function(obj){if(obj._anim)return obj._anim.behavior};exports.apply_smoothing=function(obj,trans_period,quat_period){if(obj._anim){obj._anim.trans_smooth_period=trans_period||
0;obj._anim.quat_smooth_period=quat_period||0}};exports.update_object_animation=function(obj,elapsed){if(!elapsed)var elapsed=0;animate(obj,elapsed)};exports.is_animatable=function(bpy_obj){if(bpy_obj["type"]=="ARMATURE")return true;var armobj=get_first_armature_object(bpy_obj);if(armobj)return true;var anim_data=bpy_obj["animation_data"];if(anim_data&&anim_data["action"])return true;if(bpy_obj["type"]=="SPEAKER"&&(bpy_obj["data"]["animation_data"]&&bpy_obj["data"]["animation_data"]["action"]))return true;
if(m_particles.has_particles(bpy_obj)&&m_particles.has_anim_particles(bpy_obj))return true;if(bpy_obj["type"]=="MESH"&&bpy_obj["data"]["b4w_vertex_anim"].length)return true;return false};exports.is_animated=function(obj){if(obj._anim)return true;else return false};function apply_action(obj,action){if(!action["fcurves"].length)throw new Error('No fcurves in action "'+action["name"]+'"');var frame_range=action["frame_range"];var act_render=action._render;obj._anim.action=action["name"];obj._anim.action_frame_range=
frame_range;obj._anim.action_step=act_render.pierce_step;obj._anim.action_bflags=act_render.bflags;obj._anim.start=frame_range[0];obj._anim.current_frame_float=frame_range[0];obj._anim.length=frame_range[1]-frame_range[0];var num_pierced=act_render.num_pierced;var armobj=get_first_armature_object(obj);if(m_util.is_armature(obj)){obj._anim.type=OBJ_ANIM_TYPE_ARMATURE;var pose_data_frames=get_cached_pose_data(obj,action);if(!pose_data_frames){var bone_pointers=calc_armature_bone_pointers(obj);var pose_data_frames=
calc_pose_data_frames(obj,action,bone_pointers);cache_pose_data(obj,action,pose_data_frames)}obj._anim.trans=pose_data_frames.trans;obj._anim.quats=pose_data_frames.quats}else if(armobj){obj._anim.type=OBJ_ANIM_TYPE_SKELETAL;var pose_data_frames=get_cached_pose_data(obj,action);if(!pose_data_frames){var bone_pointers=obj._render.bone_pointers;var pose_data_frames=calc_pose_data_frames(armobj,action,bone_pointers);cache_pose_data(obj,action,pose_data_frames)}obj._anim.trans=pose_data_frames.trans;
obj._anim.quats=pose_data_frames.quats}else if(m_sfx.is_speaker(obj)&&(act_render.params["volume"]||act_render.params["pitch"])){obj._anim.volume=act_render.params["volume"]||null;obj._anim.pitch=act_render.params["pitch"]||null;obj._anim.type=OBJ_ANIM_TYPE_SOUND}else{var tsr=act_render.params["tsr"];if(tsr){obj._anim.trans=[];obj._anim.quats=[];for(var i=0;i<num_pierced;i++){obj._anim.trans.push(tsr.subarray(i*8,i*8+4));obj._anim.quats.push(tsr.subarray(i*8+4,i*8+8))}obj._anim.type=OBJ_ANIM_TYPE_OBJECT}else{m_print.warn('B4W Warning: Incompatible action "'+
action["name"]+'" has been applied to object "'+obj["name"]+'"');obj._anim.type=OBJ_ANIM_TYPE_STATIC}}}function get_cached_pose_data(obj,action){var cache=obj._action_anim_cache;for(var i=0;i<cache.length;i+=2)if(action==cache[i])return cache[i+1];return null}function cache_pose_data(obj,action,pose_data){var cache=obj._action_anim_cache;cache.push(action,pose_data)}function find_armature_constraint(constraints,type){for(var i=0;i<constraints.length;i++){var cons=constraints[i];if(cons["type"]==type){var target=
cons["target"];if(target&&target["type"]=="ARMATURE")return cons}}return false}exports.calc_armature_bone_pointers=calc_armature_bone_pointers;function calc_armature_bone_pointers(armobj){var bones=armobj["data"]["bones"];var pose_bones=armobj["pose"]["bones"];var bone_pointers={};for(var i=0;i<bones.length;i++){var bone=bones[i];var bone_name=bone["name"];bone_pointers[bone_name]={bone_index:i,deform_bone_index:i,pose_bone_index:m_util.get_index_for_key_value(pose_bones,"name",bone_name),vgroup_index:-1}}return bone_pointers}
function calc_bone_pointer(bone_name,armobj){var bones=armobj["data"]["bones"];var pose_bones=armobj["pose"]["bones"];var bone=m_util.keysearch("name",bone_name,bones);var bone_index=m_util.get_index_for_key_value(bones,"name",bone_name);if(bone_index>-1){var bone_pointer={bone_index:bone_index,deform_bone_index:0,pose_bone_index:m_util.get_index_for_key_value(pose_bones,"name",bone_name),vgroup_index:-1};return bone_pointer}else return null}function animate(obj,elapsed){if(!obj._anim)return;if(!(obj._anim.play||
elapsed==0))return;var render=obj._render;var cff=obj._anim.current_frame_float;var start=obj._anim.start;var length=obj._anim.length;var finish_callback;cff+=elapsed*cfg_ani.framerate;if(cff>=start+length){finish_callback=obj._anim.finish_callback;switch(obj._anim.behavior){case AB_CYCLIC:cff=(cff-start)%length+start;break;case AB_FINISH_RESET:cff=start;stop(obj);break;case AB_FINISH_STOP:cff=start+length-1E-6;stop(obj);break}}obj._anim.current_frame_float=cff;obj._render.time=(cff-start)/cfg_ani.framerate;
var anim_type=obj._anim.type;switch(anim_type){case OBJ_ANIM_TYPE_ARMATURE:case OBJ_ANIM_TYPE_SKELETAL:var finfo=action_anim_finfo(obj._anim,cff,_frame_info_tmp);var frame=finfo[0];var frame_next=finfo[1];var frame_factor=finfo[2];var trans=obj._anim.trans;var quats=obj._anim.quats;render.quats_before=quats[frame];render.quats_after=quats[frame_next];render.trans_before=trans[frame];render.trans_after=trans[frame_next];render.frame_factor=frame_factor;if(anim_type===OBJ_ANIM_TYPE_ARMATURE)m_trans.update_transform(obj);
break;case OBJ_ANIM_TYPE_OBJECT:var finfo=action_anim_finfo(obj._anim,cff,_frame_info_tmp);var trans=get_anim_translation(obj,0,finfo,_vec3_tmp);var quat=get_anim_rotation(obj,0,finfo,_quat4_tmp);var scale=get_anim_scale(obj,0,finfo);if(obj._anim.trans_smooth_period){var trans_old=_vec3_tmp2;m_trans.get_translation(obj,trans_old);m_util.smooth_v(trans,trans_old,elapsed,obj._anim.trans_smooth_period,trans)}if(obj._anim.quat_smooth_period){var quat_old=_quat4_tmp2;m_trans.get_rotation(obj,quat_old);
m_util.smooth_q(quat,quat_old,elapsed,obj._anim.quat_smooth_period,quat)}m_trans.set_translation(obj,trans);m_trans.set_rotation(obj,quat);m_trans.set_scale(obj,scale);m_trans.update_transform(obj);m_phy.sync_transform(obj);break;case OBJ_ANIM_TYPE_VERTEX:vertex_anim_finfo(obj._anim,cff,_frame_info_tmp);var finfo=_frame_info_tmp;render.va_frame=finfo[0];render.va_frame_factor=finfo[2];break;case OBJ_ANIM_TYPE_SOUND:var finfo=action_anim_finfo(obj._anim,cff,_frame_info_tmp);var fc=finfo[0];var fn=
finfo[1];var ff=finfo[2];if(obj._anim.volume){var volume=(1-ff)*obj._anim.volume[fc]+ff*obj._anim.volume[fn];m_sfx.set_volume(obj,volume)}if(obj._anim.pitch){var pitch=(1-ff)*obj._anim.pitch[fc]+ff*obj._anim.pitch[fn];m_sfx.playrate(obj,pitch)}break;case OBJ_ANIM_TYPE_STATIC:break;default:throw"Unknown animation type:"+anim_type;break}if(finish_callback)finish_callback(obj)}function action_anim_finfo(obj_anim,cff,dest){if(!dest)var dest=new Array(3);var action_start=obj_anim.action_frame_range[0];
var action_end=obj_anim.action_frame_range[1];var range=action_end-action_start;var index_float=cff-action_start;if(index_float<0)index_float=0;if(index_float>=range)index_float=range;var step=obj_anim.action_step;index_float/=step;var frame=Math.floor(index_float);var frame_next=frame+1;var frame_factor;if(obj_anim.action_bflags[frame])frame_factor=index_float-frame;else frame_factor=0;dest[0]=frame;dest[1]=frame_next;dest[2]=frame_factor;return dest}function vertex_anim_finfo(obj_anim,cff,dest){if(!dest)var dest=
new Array(3);var index_float=cff-obj_anim.start;if(index_float<0)index_float=0;if(index_float>=obj_anim.length)index_float=obj_anim.length;var frame=Math.floor(index_float);var frame_next=frame+1;var frame_factor=index_float-frame;if(obj_anim.behavior!=AB_CYCLIC&&frame_next==obj_anim.length){frame=frame-1;frame_next=frame;frame_factor=1}var va_frame_offset=obj_anim.va_frame_offset;dest[0]=frame+va_frame_offset;dest[1]=frame_next+va_frame_offset;dest[2]=frame_factor;return dest}function calc_pose_data_frames(armobj,
action,bone_pointers){var pose_bones=armobj["pose"]["bones"];var trans_frames=[];var quats_frames=[];var num_pierced=action._render.num_pierced;for(var i=0;i<num_pierced;i++){for(var j=0;j<pose_bones.length;j++){var pose_bone=pose_bones[j];var tsr_basis=m_tsr.create();var bone_tsr=action._render.bones[pose_bone["name"]];if(bone_tsr)m_tsr.copy(bone_tsr.subarray(i*8,i*8+8),tsr_basis);pose_bone._tsr_basis=tsr_basis;pose_bone._tsr_channel_cache_valid=false}var pose_data=calc_pose_data(armobj,bone_pointers);
trans_frames.push(pose_data.trans);quats_frames.push(pose_data.quats)}var q=new Float32Array(4);var qn=new Float32Array(4);for(var i=0;i<quats_frames.length-1;i++){var qframe=quats_frames[i];var qframe_next=quats_frames[i+1];for(var j=0;j<qframe.length;j+=4){var qx=qframe[j];var qy=qframe[j+1];var qz=qframe[j+2];var qw=qframe[j+3];var qnx=qframe_next[j];var qny=qframe_next[j+1];var qnz=qframe_next[j+2];var qnw=qframe_next[j+3];var quat_dot=qx*qnx+qy*qny+qz*qnz+qw*qnw;if(quat_dot<0){qframe_next[j]*=
-1;qframe_next[j+1]*=-1;qframe_next[j+2]*=-1;qframe_next[j+3]*=-1}}}return{trans:trans_frames,quats:quats_frames}}exports.calc_pose_data=calc_pose_data;function calc_pose_data(armobj,bone_pointers){var trans=[];var quats=[];var pose_bones=armobj["pose"]["bones"];var t=new Float32Array(4);var q=new Float32Array(4);for(var bone_name in bone_pointers){var bone_pointer=bone_pointers[bone_name];var pose_bone_index=bone_pointer.pose_bone_index;var deform_bone_index=bone_pointer.deform_bone_index;var pose_bone=
pose_bones[pose_bone_index];calc_pose_bone(pose_bone,t,q);for(var i=0;i<4;i++){var comp_index=4*deform_bone_index+i;trans[comp_index]=t[i];quats[comp_index]=q[i]}}trans=new Float32Array(trans);quats=new Float32Array(quats);return{trans:trans,quats:quats}}function calc_pose_bone(pose_bone,dest_trans_scale,dest_quat){var chain=pose_bone._chain;var pose_bone_root=chain[chain.length-1];var tsr_channel_parent=pose_bone_root._tsr_channel_cache;if(!pose_bone_root._tsr_channel_cache_valid)m_tsr.identity(tsr_channel_parent);
for(var i=chain.length-1;i>=0;i--){var pose_bone=chain[i];var tsr_channel=pose_bone._tsr_channel_cache;if(pose_bone._tsr_channel_cache_valid){tsr_channel_parent=tsr_channel;continue}var tsr_local=pose_bone._tsr_local;var tsr_basis=pose_bone._tsr_basis;m_tsr.invert(tsr_local,_tsr8_tmp);m_tsr.multiply(tsr_basis,_tsr8_tmp,_tsr8_tmp);m_tsr.multiply(tsr_local,_tsr8_tmp,_tsr8_tmp);m_tsr.multiply(tsr_channel_parent,_tsr8_tmp,tsr_channel);tsr_channel_parent=tsr_channel;pose_bone._tsr_channel_cache_valid=
true}var tsr=pose_bone._tsr_channel_cache;dest_trans_scale[0]=tsr[0];dest_trans_scale[1]=tsr[1];dest_trans_scale[2]=tsr[2];dest_trans_scale[3]=tsr[3];dest_quat[0]=tsr[4];dest_quat[1]=tsr[5];dest_quat[2]=tsr[6];dest_quat[3]=tsr[7];m_quat.normalize(dest_quat,dest_quat)}exports.append_action=function(action){action._render={};var act_render=action._render;var frame_range=action["frame_range"];var start=frame_range[0];var end=frame_range[1];var step=1;act_render.pierce_step=step;var init_storage=function(pierced_points,
default_value){if(typeof default_value=="object"&&default_value.length){var len=default_value.length;var storage=new Float32Array(pierced_points*len);for(var i=0;i<pierced_points;i++)for(var j=0;j<len;j++)storage[i*len+j]=default_value[j]}else if(typeof default_value=="number"){var storage=new Float32Array(pierced_points);for(var i=0;i<pierced_points;i++)storage[i]=default_value}else throw"Wrong storage default value";return storage};var BONE_EXP=new RegExp(/pose.bones\[\".+\"\]/g);var TSR8_DEF=new Float32Array([0,
0,0,0,0,0,0,1]);var get_storage=function(params,bones,data_path,pierced_points){if(data_path.search(BONE_EXP)>-1){var storage_obj=bones;var name=data_path.split('"')[1];var def_val=TSR8_DEF}else{var storage_obj=params;if(data_path.indexOf("location")>-1){var name="tsr";var def_val=TSR8_DEF}else if(data_path.indexOf("rotation_quaternion")>-1){var name="tsr";var def_val=TSR8_DEF}else if(data_path.indexOf("scale")>-1){var name="tsr";var def_val=TSR8_DEF}else{var name=data_path;var def_val=0}}if(!storage_obj[name])storage_obj[name]=
init_storage(pierced_points,def_val);return storage_obj[name]};var storage_offset=function(data_path,array_index){if(data_path.indexOf("location")>-1){var base_offset=0;var channel_offset=array_index}else if(data_path.indexOf("rotation_quaternion")>-1){var base_offset=4;var channel_offset=array_index==0?3:array_index-1}else if(data_path.indexOf("scale")>-1){var base_offset=3;var channel_offset=0}else{var base_offset=0;var channel_offset=0}return base_offset+channel_offset};var fcurves=action["fcurves"];
for(var i=0;i<fcurves.length;i++){var fcurve=fcurves[i];var keyframe_points=fcurve[2];fcurve._pierced_points=approximate_curve(keyframe_points,start,end,step)}var num_pierced=fcurves.length?fcurves[0]._pierced_points.length/2:0;act_render.num_pierced=num_pierced;var params={};var bones={};var bflags=new Float32Array(num_pierced);for(var i=0;i<fcurves.length;i++){var fcurve=fcurves[i];var data_path=fcurve[0];var array_index=fcurve[1];var pp=fcurve._pierced_points;var storage=get_storage(params,bones,
data_path,num_pierced);var stride=storage.length/num_pierced;var offset=storage_offset(data_path,array_index);for(var j=0;j<num_pierced;j++){var pp_bflag=pp[2*j];if(pp_bflag)bflags[j]=1;var pp_value=pp[2*j+1];if(offset==3)storage[j*stride+offset]+=pp_value;else storage[j*stride+offset]=pp_value}}var prepare_tsr_arr=function(tsr_arr,num_pierced){for(var i=0;i<num_pierced;i++){var scale=tsr_arr[i*8+3];if(scale==0)tsr_arr[i*8+3]=1;else tsr_arr[i*8+3]=scale/3;var quat=tsr_arr.subarray(i*8+4,i*8+8);m_quat.normalize(quat,
quat)}};for(var p in params)if(p=="tsr")prepare_tsr_arr(params[p],num_pierced);for(var b in bones)prepare_tsr_arr(bones[b],num_pierced);act_render.params=params;act_render.bones=bones;act_render.bflags=bflags;_actions.push(action)};function get_transform_from_group(channels,pierced_index,action_name){var tran=[0,0,0];var quat=[1,0,0,0];var scal=[1,1,1];var storage;var bflag=0;for(var i=0;i<channels.length;i++){var fcurve=channels[i];var data_path=fcurve[0];var array_index=fcurve[1];var pp=fcurve._pierced_points;
var pp_bflag=pp[2*pierced_index];if(pp_bflag)bflag=1;var pp_value=pp[2*pierced_index+1];if(data_path.indexOf("location")>-1)storage=tran;else if(data_path.indexOf("rotation_quaternion")>-1)storage=quat;else if(data_path.indexOf("scale")>-1)storage=scal;else{m_print.error("B4W warning: unsupported fcurve data path: "+data_path+" (Action: "+action_name+")");break}storage[array_index]=pp_value}scal=(scal[0]+scal[1]+scal[2])/3;tran=[tran[0],tran[1],tran[2],scal];quat=[quat[1],quat[2],quat[3],quat[0]];
m_quat.normalize(quat,quat);return{tran:tran,quat:quat,bflag:bflag}}function approximate_curve(keyframe_points,start,end,step){var result=[];for(var i=0;i<keyframe_points.length;i++){var kf_point=keyframe_points[i];var interp=kf_point[0];var kf_blend=interp===KF_INTERP_CONSTANT?0:1;var kf_x=kf_point[1];var kf_y=kf_point[2];if(i==0&&start<kf_x)for(var j=0;j<kf_x-start;j+=step)result.push(0,kf_y);result.push(kf_blend,kf_y);var kf_point_next=keyframe_points[i+1];if(kf_point_next){var v1=[kf_x,kf_y];
var v2=[kf_point[5],kf_point[6]];var v3=[kf_point_next[3],kf_point_next[4]];var v4=[kf_point_next[1],kf_point_next[2]];var kf_x_next=v4[0];switch(interp){case KF_INTERP_BEZIER:correct_bezpart(v1,v2,v3,v4);for(var j=kf_x+step;j<kf_x_next;j+=step)result.push(kf_blend,bezier(j,v1,v2,v3,v4));break;case KF_INTERP_LINEAR:var linear_params=calc_linear_params(v1,v4);for(var j=kf_x+step;j<kf_x_next;j+=step)result.push(kf_blend,linear(j,linear_params));break;case KF_INTERP_CONSTANT:for(var j=kf_x+step;j<kf_x_next;j+=
step)result.push(kf_blend,kf_y);break;default:throw"Unknown keyframe intepolation mode: "+interp;}}if(i==keyframe_points.length-1&&kf_x<end)for(var j=0;j<end-kf_x;j+=step)result.push(0,kf_y)}return result}function calc_linear_params(v1,v4){var x1=v1[0],y1=v1[1],x2=v4[0],y2=v4[1];var k=(y2-y1)/(x2-x1);var b=y1-k*x1;return{k:k,b:b}}function linear(x,linear_params){return linear_params.k*x+linear_params.b}function correct_bezpart(v1,v2,v3,v4){var h1=[];var h2=[];var len1,len2,len,fac;h1[0]=v1[0]-v2[0];
h1[1]=v1[1]-v2[1];h2[0]=v4[0]-v3[0];h2[1]=v4[1]-v3[1];len=v4[0]-v1[0];len1=Math.abs(h1[0]);len2=Math.abs(h2[0]);if(len1+len2==0)return;if(len1+len2>len){fac=len/(len1+len2);v2[0]=v1[0]-fac*h1[0];v2[1]=v1[1]-fac*h1[1];v3[0]=v4[0]-fac*h2[0];v3[1]=v4[1]-fac*h2[1]}}function bezier(x,v1,v2,v3,v4){var t=bezier_find_root(0,1,x,v1[0],v2[0],v3[0],v4[0]);var y=bezier_parametric(t,v1[1],v2[1],v3[1],v4[1]);return y}function bezier_find_root(t0_so_far,t1_so_far,x_needed,x0,x1,x2,x3){var t=t0_so_far+(t1_so_far-
t0_so_far)/2;var x=bezier_parametric(t,x0,x1,x2,x3);var dx=x-x_needed;var precision=0.02;if(Math.abs(dx)<precision)return t;if(dx>0)return bezier_find_root(t0_so_far,t,x_needed,x0,x1,x2,x3);else return bezier_find_root(t,t1_so_far,x_needed,x0,x1,x2,x3)}function bezier_parametric(t,p0,p1,p2,p3){var t1=1-t;return p0*t1*t1*t1+3*p1*t1*t1*t+3*p2*t1*t*t+p3*t*t*t}exports.first_animated=function(objs){for(var i=0;i<objs.length;i++)if(objs[i]._anim)return objs[i];return false};function get_anim_translation(obj,
index,frame_info,dest){if(!dest)var dest=new Float32Array(4);var frame=frame_info[0];var frame_next=frame_info[1];var frame_factor=frame_info[2];var trans=obj._anim.trans;var x=trans[frame][4*index];var y=trans[frame][4*index+1];var z=trans[frame][4*index+2];var xn=trans[frame_next][4*index];var yn=trans[frame_next][4*index+1];var zn=trans[frame_next][4*index+2];dest[0]=(1-frame_factor)*x+frame_factor*xn;dest[1]=(1-frame_factor)*y+frame_factor*yn;dest[2]=(1-frame_factor)*z+frame_factor*zn;return dest}
function get_anim_rotation(obj,index,frame_info,dest){if(!dest)var dest=new Float32Array(4);var frame=frame_info[0];var frame_next=frame_info[1];var frame_factor=frame_info[2];var quats=obj._anim.quats;m_quat.slerp(quats[frame].subarray(4*index,4*index+4),quats[frame_next].subarray(4*index,4*index+4),frame_factor,dest);return dest}function get_anim_scale(obj,index,frame_info){var frame=frame_info[0];var frame_next=frame_info[1];var frame_factor=frame_info[2];var trans=obj._anim.trans;var s=trans[frame][4*
index+3];var sn=trans[frame_next][4*index+3];var scale=(1-frame_factor)*s+frame_factor*sn;return scale}function do_before_apply(obj){init_anim(obj);update_anim_cache(obj)}function do_after_apply(obj){m_trans.update_transform(obj);m_phy.sync_transform(obj);if(m_particles.has_particles(obj))m_particles.update_emitter_animation(obj)}exports.apply=function(obj,name){if(m_util.is_mesh(obj)){var vertex_anim=m_util.keysearch("name",name,obj["data"]["b4w_vertex_anim"]);if(vertex_anim){do_before_apply(obj);
apply_vertex_anim(obj,vertex_anim);do_after_apply(obj);return}}var action=m_util.keysearch("name",name,_actions);if(action){do_before_apply(obj);apply_action(obj,action);do_after_apply(obj);return}m_print.error("Unsupported object or animation name: ",name)};exports.remove=function(obj){obj._anim=null;var ind=_anim_objs_cache.indexOf(obj);if(ind)_anim_objs_cache.splice(ind,1);else m_print.error("Object ",obj.name," doesn't have animation")};exports.cleanup=function(){_anim_objs_cache.length=0;_actions.length=
0}};b4w.module["__transform"]=function(exports,require){var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cons=require("__constraints");var m_lights=require("__lights");var m_particles=require("__particles");var m_scs=require("__scenes");var m_sfx=require("__sfx");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("vec3");var m_quat=require("quat");var m_mat4=require("mat4");var _vec3_tmp=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _elapsed=
0;exports.update=function(elapsed){_elapsed=elapsed};exports.set_translation=function(obj,trans){if(m_cons.get_type(obj)==m_cons.CONS_TYPE_CHILD_OF){var offset=m_cons.get_child_of_offset(obj);m_tsr.set_trans(trans,offset)}else{var render=obj._render;render.trans[0]=trans[0];render.trans[1]=trans[1];render.trans[2]=trans[2]}};exports.get_translation=function(obj,dest){if(m_cons.get_type(obj)==m_cons.CONS_TYPE_CHILD_OF){var offset=m_cons.get_child_of_offset(obj);m_vec3.copy(m_tsr.get_trans_view(offset),
dest)}else m_vec3.copy(obj._render.trans,dest)};exports.set_rotation=function(obj,quat){if(m_cons.get_type(obj)==m_cons.CONS_TYPE_CHILD_OF){var offset=m_cons.get_child_of_offset(obj);m_tsr.set_quat(quat,offset)}else{var render=obj._render;render.quat[0]=quat[0];render.quat[1]=quat[1];render.quat[2]=quat[2];render.quat[3]=quat[3]}};exports.get_rotation=function(obj,dest){if(m_cons.get_type(obj)==m_cons.CONS_TYPE_CHILD_OF){var offset=m_cons.get_child_of_offset(obj);m_quat.copy(m_tsr.get_quat_view(offset),
dest)}else m_quat.copy(obj._render.quat,dest)};exports.set_rotation_euler=function(obj,euler){if(m_cons.get_type(obj)==m_cons.CONS_TYPE_CHILD_OF){var quat=m_util.euler_to_quat(euler,_quat4_tmp);var offset=m_cons.get_child_of_offset(obj);m_tsr.set_quat(quat,offset)}else m_util.euler_to_quat(euler,obj._render.quat)};exports.set_scale=function(obj,scale){if(m_cons.get_type(obj)==m_cons.CONS_TYPE_CHILD_OF){var offset=m_cons.get_child_of_offset(obj);m_tsr.set_scale(scale,offset)}else obj._render.scale=
scale};exports.get_scale=function(obj){if(m_cons.get_type(obj)==m_cons.CONS_TYPE_CHILD_OF){var offset=m_cons.get_child_of_offset(obj);return m_tsr.get_scale(offset)}else return obj._render.scale};exports.get_tsr=function(obj,dest){if(m_cons.get_type(obj)==m_cons.CONS_TYPE_CHILD_OF){var offset=m_cons.get_child_of_offset(obj);m_tsr.copy(offset,dest)}else{var render=obj._render;m_tsr.set_sep(render.trans,render.scale,render.quat,dest)}};exports.set_tsr=function(obj,tsr){if(m_cons.get_type(obj)==m_cons.CONS_TYPE_CHILD_OF){var offset=
m_cons.get_child_of_offset(obj);m_tsr.copy(tsr,offset)}else{var render=obj._render;render.trans[0]=tsr[0];render.trans[1]=tsr[1];render.trans[2]=tsr[2];render.scale=tsr[3];render.quat[0]=tsr[4];render.quat[1]=tsr[5];render.quat[2]=tsr[6];render.quat[3]=tsr[7]}};exports.get_object_size=function(obj){if(obj._render.type=="STATIC")var render=obj._dyn_render;else var render=obj._render;var bpy_bb=obj["data"]["b4w_bounding_box"];var x_size=render.scale*(bpy_bb["max_x"]-bpy_bb["min_x"]);var y_size=render.scale*
(bpy_bb["max_y"]-bpy_bb["min_y"]);var z_size=render.scale*(bpy_bb["max_z"]-bpy_bb["min_z"]);var size=0.5*Math.sqrt(x_size*x_size+y_size*y_size+z_size*z_size);return size};exports.get_object_center=function(obj,calc_bs_center,dest){if(!dest)var dest=new Float32Array(3);if(calc_bs_center){var render=obj._render;m_vec3.copy(render.bs_world.center,dest)}else{if(obj._render.type=="STATIC")var render=obj._dyn_render;else var render=obj._render;var bpy_bb=obj["data"]["b4w_bounding_box"];dest[0]=(bpy_bb["max_x"]+
bpy_bb["min_x"])/2;dest[1]=(bpy_bb["max_y"]+bpy_bb["min_y"])/2;dest[2]=(bpy_bb["max_z"]+bpy_bb["min_z"])/2;m_vec3.transformMat4(dest,render.world_matrix,dest)}return dest};exports.move_local=function(obj,dx,dy,dz){var trans_local=_vec3_tmp;var render=obj._render;var inv_world_matrix=render.inv_world_matrix;var world_matrix=render.world_matrix;m_vec3.transformMat4(render.trans,inv_world_matrix,trans_local);trans_local[0]+=dx;trans_local[1]+=dy;trans_local[2]+=dz;m_vec3.transformMat4(trans_local,world_matrix,
render.trans)};exports.update_transform=update_transform;function update_transform(obj){var render=obj._render;m_cons.update_constraint(obj,_elapsed);if(obj["type"]=="CAMERA")m_cam.clamp_vertical_limits(obj);var trans=render.trans;var scale=render.scale;var quat=render.quat;m_tsr.set_sep(trans,scale,quat,render.tsr);var wm=render.world_matrix;m_mat4.identity(wm);m_mat4.fromQuat(quat,wm);m_util.scale_mat4(wm,scale,wm);wm[12]=trans[0];wm[13]=trans[1];wm[14]=trans[2];m_mat4.invert(wm,render.inv_world_matrix);
if(obj._anim&&(!obj._anim.trans&&m_particles.has_particles(obj)))m_particles.update_emitter_transform(obj);if(render.bb_local&&render.bb_world){m_bounds.bounding_box_transform(render.bb_local,wm,render.bb_world);m_bounds.bounding_sphere_transform(render.bs_local,wm,render.bs_world);m_bounds.bounding_ellipsoid_transform(render.be_local,render.tsr,render.be_world);if(render.shadow_cast)m_scs.schedule_shadow_update(m_scs.get_active())}switch(obj["type"]){case "SPEAKER":m_sfx.speaker_update_transform(obj,
_elapsed);break;case "CAMERA":m_cam.update_camera_transform(obj);if(m_scs.check_active())m_sfx.listener_update_transform(m_scs.get_active(),trans,quat,_elapsed);break;case "LAMP":m_lights.update_light_transform(obj);if(m_scs.check_active())m_scs.update_lamp_scene(obj,m_scs.get_active());break;case "EMPTY":if(obj["field"])m_particles.update_force(obj);break}if(obj["type"]=="LAMP"||obj["type"]=="CAMERA")if(m_scs.check_active()){var active_scene=m_scs.get_active();m_scs.schedule_shadow_update(active_scene);
m_scs.schedule_grass_map_update(active_scene)}var descends=obj._descends;for(var i=0;i<descends.length;i++)update_transform(descends[i])}exports.distance=function(obj1,obj2){return m_vec3.dist(obj1._render.trans,obj2._render.trans)};exports.obj_point_distance=function(obj,point){return m_vec3.dist(obj._render.trans,point)}};b4w.module["__tsr"]=function(exports,require){var m_util=require("__util");var m_vec3=require("vec3");var m_quat=require("quat");var m_mat4=require("mat4");var _vec3_tmp=new Float32Array(3);var _quat_tmp=new Float32Array(4);var _mat4_tmp=new Float32Array(16);exports.create=function(){var tsr=new Float32Array(8);tsr[3]=1;tsr[7]=1;return tsr};exports.copy=function(tsr,tsr2){tsr2.set(tsr)};exports.identity=function(tsr){tsr[0]=0;tsr[1]=0;tsr[2]=0;tsr[3]=1;tsr[4]=0;tsr[5]=0;tsr[6]=0;tsr[7]=1;return tsr};
exports.create_sep=function(trans,scale,quat,dest){if(!dest)var dest=new Float32Array(8);set_sep(trans,scale,quat,dest);return dest};exports.set_sep=set_sep;function set_sep(trans,scale,quat,dest){dest[0]=trans[0];dest[1]=trans[1];dest[2]=trans[2];dest[3]=scale;dest[4]=quat[0];dest[5]=quat[1];dest[6]=quat[2];dest[7]=quat[3]}exports.set_trans=function(trans,dest){dest[0]=trans[0];dest[1]=trans[1];dest[2]=trans[2]};exports.set_scale=function(scale,dest){dest[3]=scale};exports.set_transcale=function(transcale,
dest){dest[0]=transcale[0];dest[1]=transcale[1];dest[2]=transcale[2];dest[3]=transcale[3]};exports.set_quat=function(quat,dest){dest[4]=quat[0];dest[5]=quat[1];dest[6]=quat[2];dest[7]=quat[3]};exports.get_trans_view=function(tsr){return tsr.subarray(0,3)};exports.get_scale=function(tsr){return tsr[3]};exports.get_quat_view=function(tsr){return tsr.subarray(4)};exports.invert=function(tsr,dest){var sc_inv=1/tsr[3];if(!sc_inv)return null;var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];_quat_tmp[0]=tsr[4];
_quat_tmp[1]=tsr[5];_quat_tmp[2]=tsr[6];_quat_tmp[3]=tsr[7];m_quat.invert(_quat_tmp,_quat_tmp);var qx_inv=_quat_tmp[0];var qy_inv=_quat_tmp[1];var qz_inv=_quat_tmp[2];var qw_inv=_quat_tmp[3];var x=tx*sc_inv;var y=ty*sc_inv;var z=tz*sc_inv;var ix=qw_inv*x+qy_inv*z-qz_inv*y;var iy=qw_inv*y+qz_inv*x-qx_inv*z;var iz=qw_inv*z+qx_inv*y-qy_inv*x;var iw=-qx_inv*x-qy_inv*y-qz_inv*z;dest[0]=-(ix*qw_inv+iw*-qx_inv+iy*-qz_inv-iz*-qy_inv);dest[1]=-(iy*qw_inv+iw*-qy_inv+iz*-qx_inv-ix*-qz_inv);dest[2]=-(iz*qw_inv+
iw*-qz_inv+ix*-qy_inv-iy*-qx_inv);dest[3]=sc_inv;dest[4]=qx_inv;dest[5]=qy_inv;dest[6]=qz_inv;dest[7]=qw_inv;return dest};function to_mat4(tsr,dest){if(!dest)var dest=new Float32Array(16);var trans=tsr.subarray(0,3);var scale=tsr[3];var quat=tsr.subarray(4);var mat=m_mat4.fromRotationTranslation(quat,trans,dest);for(var i=0;i<12;i++)dest[i]*=scale;return dest}exports.from_mat4=function(mat,dest){var trans=m_util.matrix_to_trans(mat,_vec3_tmp);var scale=m_util.matrix_to_scale(mat);var quat=m_util.matrix_to_quat(mat,
_quat_tmp);set_sep(trans,scale,quat,dest);return dest};exports.multiply=function(tsr,tsr2,dest){transform_vec3(tsr,tsr2,dest);dest[3]=tsr[3]*tsr2[3];var ax=tsr[4],ay=tsr[5],az=tsr[6],aw=tsr[7],bx=tsr2[4],by=tsr2[5],bz=tsr2[6],bw=tsr2[7];dest[4]=ax*bw+aw*bx+ay*bz-az*by;dest[5]=ay*bw+aw*by+az*bx-ax*bz;dest[6]=az*bw+aw*bz+ax*by-ay*bx;dest[7]=aw*bw-ax*bx-ay*by-az*bz;return dest};function transform_mat4(matrix,tsr,dest){var trans=tsr.subarray(0,3);var scale=tsr[3];var quat=tsr.subarray(4);var m=m_mat4.fromRotationTranslation(quat,
trans,_mat4_tmp);for(var i=0;i<12;i++)dest[i]*=scale;m_mat4.multiply(m,matrix,dest);return dest}exports.transform_vec3=transform_vec3;function transform_vec3(tsr,vec,dest){var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var x=vec[0]*scale;var y=vec[1]*scale;var z=vec[2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;dest[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;dest[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;
dest[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;dest[0]+=tx;dest[1]+=ty;dest[2]+=tz;return dest}exports.transform_vectors=function(vectors,tsr,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];for(var i=0;i<len;i+=3){var x=vectors[i]*scale;var y=vectors[i+1]*scale;var z=vectors[i+2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*
x-qy*y-qz*z;new_vectors[dest_offset+i]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vectors[dest_offset+i+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vectors[dest_offset+i+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;new_vectors[dest_offset+i]+=tx;new_vectors[dest_offset+i+1]+=ty;new_vectors[dest_offset+i+2]+=tz}return new_vectors};exports.transform_dir_vectors=function(vectors,tsr,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];
for(var i=0;i<len;i+=3){var x=vectors[i]*scale;var y=vectors[i+1]*scale;var z=vectors[i+2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vectors[dest_offset+i]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vectors[dest_offset+i+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vectors[dest_offset+i+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx}return new_vectors};exports.transform_dir_vec3=function(vec,tsr,new_vec){var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var x=
vec[0]*scale;var y=vec[1]*scale;var z=vec[2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vec[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vec[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vec[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return new_vec};exports.transform_tangents=function(vectors,tsr,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];for(var i=0;i<len;i+=4){var x=
vectors[i]*scale;var y=vectors[i+1]*scale;var z=vectors[i+2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vectors[dest_offset+i]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vectors[dest_offset+i+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vectors[dest_offset+i+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;new_vectors[dest_offset+i+3]=vectors[i+3]}return new_vectors};exports.translate=function(tsr,vec,dest){var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var x=
vec[0]*scale;var y=vec[1]*scale;var z=vec[2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;dest[0]=tsr[0]+ix*qw+iw*-qx+iy*-qz-iz*-qy;dest[1]=tsr[1]+iy*qw+iw*-qy+iz*-qx-ix*-qz;dest[2]=tsr[2]+iz*qw+iw*-qz+ix*-qy-iy*-qx;dest[3]=tsr[3];dest[4]=tsr[4];dest[5]=tsr[5];dest[6]=tsr[6];dest[7]=tsr[7];return dest};exports.interpolate=function(tsr,tsr2,factor,dest){if(!dest)var dest=new Float32Array(8);var trans=tsr.subarray(0,3);var trans2=tsr2.subarray(0,3);
var trans_dst=dest.subarray(0,3);m_vec3.lerp(trans,trans2,factor,trans_dst);var scale=tsr[3];var scale2=tsr2[3];dest[3]=scale+factor*(scale2-scale);var quat=tsr.subarray(4);var quat2=tsr2.subarray(4);var quat_dst=dest.subarray(4);m_quat.slerp(quat,quat2,factor,quat_dst);return dest};exports.extrapolate=function(tsr,tsr2,factor,dest){if(!dest)var dest=new Float32Array(8);var trans=tsr.subarray(0,3);var trans2=tsr2.subarray(0,3);var trans_dst=dest.subarray(0,3);trans_dst[0]=trans2[0]*(factor+1)-trans[0]*
factor;trans_dst[1]=trans2[1]*(factor+1)-trans[1]*factor;trans_dst[2]=trans2[2]*(factor+1)-trans[2]*factor;var scale=tsr[3];var scale2=tsr2[3];dest[3]=scale2*(factor+1)-scale*factor;var quat=tsr.subarray(4);var quat2=tsr2.subarray(4);var quat_dst=dest.subarray(4);quat_dst[0]=quat2[0]*(factor+1)-quat[0]*factor;quat_dst[1]=quat2[1]*(factor+1)-quat[1]*factor;quat_dst[2]=quat2[2]*(factor+1)-quat[2]*factor;quat_dst[3]=quat2[3]*(factor+1)-quat[3]*factor;m_quat.normalize(quat_dst,quat_dst);return dest};
exports.integrate=function(tsr,time,linvel,angvel,dest){var trans=tsr.subarray(0,3);var trans_dst=dest.subarray(0,3);trans_dst[0]=trans[0]+time*linvel[0];trans_dst[1]=trans[1]+time*linvel[1];trans_dst[2]=trans[2]+time*linvel[2];dest[3]=tsr[3];var quat=tsr.subarray(4);var quat_dst=dest.subarray(4);quat_deriv_angvel(quat,angvel,quat_dst);quat_dst[0]=quat[0]+quat_dst[0]*time;quat_dst[1]=quat[1]+quat_dst[1]*time;quat_dst[2]=quat[2]+quat_dst[2]*time;quat_dst[3]=quat[3]+quat_dst[3]*time;m_quat.normalize(quat_dst,
quat_dst)};function quat_deriv_angvel(quat,angvel,dest){var wx=angvel[0];var wy=angvel[1];var wz=angvel[2];var qx=quat[0];var qy=quat[1];var qz=quat[2];var qw=quat[3];dest[0]=0.5*(wx*qw+wy*qz-wz*qy);dest[1]=0.5*(wy*qw+wz*qx-wx*qz);dest[2]=0.5*(wz*qw+wx*qy-wy*qx);dest[3]=0.5*(-wx*qx-wy*qy-wz*qz)}};b4w.module["__util"]=function(exports,require){var m_print=require("__print");var m_vec3=require("vec3");var m_vec4=require("vec4");var m_quat=require("quat");var m_mat3=require("mat3");var m_mat4=require("mat4");var _unique_counter=0;var _unique_name_counters={};var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _vec4_tmp2=new Float32Array(4);var _mat3_tmp=new Float32Array(9);var _mat4_tmp=new Float32Array(16);var VEC3_IDENT=new Float32Array([0,
0,0]);var QUAT4_IDENT=new Float32Array([0,0,0,1]);var TSR8_IDENT=new Float32Array([0,0,0,1,0,0,0,1]);var AXIS_X=new Float32Array([1,0,0]);var AXIS_Y=new Float32Array([0,1,0]);var AXIS_Z=new Float32Array([0,0,1]);var AXIS_MX=new Float32Array([-1,0,0]);var AXIS_MY=new Float32Array([0,-1,0]);var AXIS_MZ=new Float32Array([0,0,-1]);var DEFAULT_SEED=5E4;var RAND_A=48271;var RAND_M=2147483647;var RAND_R=RAND_M%RAND_A;var RAND_Q=Math.floor(RAND_M/RAND_A);exports.VEC3_IDENT=VEC3_IDENT;exports.QUAT4_IDENT=
QUAT4_IDENT;exports.TSR8_IDENT=TSR8_IDENT;exports.AXIS_X=AXIS_X;exports.AXIS_Y=AXIS_Y;exports.AXIS_Z=AXIS_Z;exports.AXIS_MX=AXIS_MX;exports.AXIS_MY=AXIS_MY;exports.AXIS_MZ=AXIS_MZ;exports.keyfind=keyfind;function keyfind(key,value,array){var results=[];var len=array.length;for(var i=0;i<len;i++){var obj=array[i];if(obj[key]==value)results.push(obj)}return results}exports.float32_concat=function(first,second){var firstLength=first.length;var result=new Float32Array(firstLength+second.length);result.set(first);
result.set(second,firstLength);return result};exports.uint32_concat=function(first,second){var firstLength=first.length;var result=new Uint32Array(firstLength+second.length);result.set(first);result.set(second,firstLength);return result};exports.check_endians=function(){var value=255;var x=new Uint16Array([value]);var dataview=new DataView(x.buffer);return dataview.getUint16(0,true)==value};exports.array_intersect=function(arr1,arr2){var r=[],o={},l=arr2.length,i,v;for(i=0;i<l;i++)o[arr2[i]]=true;
l=arr1.length;for(i=0;i<l;i++){v=arr1[i];if(v in o)r.push(v)}return r};exports.sign=function(value){return value>0?1:value<0?-1:0};exports.keycheck=function(key,value,array){var len=array.length;for(var i=0;i<len;i++){var obj=array[i];if(obj[key]==value)return true}return false};exports.keysearch=function(key,value,array){for(var i=0;i<array.length;i++){var obj=array[i];if(obj[key]===value)return obj}return null};exports.key2search=function(key1,value1,key2,value2,array){for(var i=0;i<array.length;i++){var obj=
array[i];if(obj[key1]==value1&&obj[key2]==value2)return obj}return null};exports.get_index_for_key_value=function(array,key,value){for(var i=0;i<array.length;i++)if(array[i][key]==value)return i;return-1};exports.append_unique=function(array,value){for(var i=0;i<array.length;i++)if(array[i]==value)return;array.push(value)};exports.check_uniqueness=function(array){for(var i=0;i<array.length-1;i++){var elem_i=array[i];for(var j=i+1;j<array.length;j++){var elem_j=array[j];if(elem_i==elem_j)return false}}return true};
exports.objs_by_type=function(objs_array,type){var objs_type=[];for(var i=0;i<objs_array.length;i++){var obj=objs_array[i];if(obj["type"]==type)objs_type.push(obj)}return objs_type};exports.objs_by_name=function(objs_array,name){var objs_name=keyfind("name",name,objs_array);var len=objs_name.length;if(len>1)m_print.error("obj_by_name(): name resolution ambiguity");return objs_name};exports.objs_by_name_r=function(objs_array,name){var objs_name=keyfind("name",name,objs_array);var len=objs_name.length;
if(len>1)m_print.error("obj_by_name(): name resolution ambiguity");if(len<=0)return[];var objs_name_dg=[];for(var i=0;i<len;i++){var obj=objs_name[i];if(obj["type"]=="EMPTY"&&obj["dupli_group"]){var dg_objects=obj["dupli_group"]["objects"];for(var j=0;j<dg_objects.length;j++)objs_name_dg.push(dg_objects[j])}}objs_name=objs_name.concat(objs_name_dg);return objs_name};exports.trans_matrix=function(x,y,z,dest){if(!dest)var dest=new Float32Array(16);m_mat4.identity(dest);dest[12]=x;dest[13]=y;dest[14]=
z;return dest};var _next=1;exports.rand=function(){_next=(_next*69069+5)%Math.pow(2,32);return Math.round(_next/65536)%32768/32767};exports.srand=function(seed){_next=seed};exports.rand_r=function(seedp){var high=Math.floor(seedp[0]/RAND_Q);var low=seedp[0]%RAND_Q;var test=RAND_A*low-RAND_R*high;if(test>0)seedp[0]=test;else seedp[0]=test+RAND_M;return(seedp[0]-1)/(RAND_M-1)};exports.init_rand_r_seed=function(seed_number,dest){if(!dest)dest=[];dest[0]=DEFAULT_SEED+Math.floor(seed_number);return dest};
exports.euler_to_quat=function(euler,quat){if(!quat)quat=new Float32Array(4);var c1=Math.cos(euler[1]/2);var c2=Math.cos(euler[2]/2);var c3=Math.cos(euler[0]/2);var s1=Math.sin(euler[1]/2);var s2=Math.sin(euler[2]/2);var s3=Math.sin(euler[0]/2);quat[0]=s1*s2*c3+c1*c2*s3;quat[1]=s1*c2*c3+c1*s2*s3;quat[2]=c1*s2*c3-s1*c2*s3;quat[3]=c1*c2*c3-s1*s2*s3;return quat};exports.quat_to_euler=function(quat){var euler=[];var qx=quat[0];var qy=quat[1];var qz=quat[2];var qw=quat[3];var qw2=qw*qw;var qx2=qx*qx;var qy2=
qy*qy;var qz2=qz*qz;var test=qx*qy+qz*qw;if(test>0.499999){euler[0]=0;euler[1]=2*Math.atan2(qx,qw);euler[2]=Math.PI/2}else if(test<-0.499999){euler[0]=0;euler[1]=-2*Math.atan2(qx,qw);euler[2]=-Math.PI/2}else{euler[0]=Math.atan2(2*qx*qw-2*qy*qz,1-2*qx2-2*qz2);euler[1]=Math.atan2(2*qy*qw-2*qx*qz,1-2*qy2-2*qz2);euler[2]=Math.asin(2*qx*qy+2*qz*qw)}return euler};exports.quat_to_dir=function(quat,ident,dest){if(!dest)var dest=new Float32Array(3);m_vec3.transformQuat(ident,quat,dest);return dest};exports.dir_to_quat=
function(dir,ident,dest){if(!dest)var dest=new Float32Array(4);var dir=m_vec3.normalize(dir,_vec3_tmp);var dot=m_vec3.dot(ident,dir);var A=m_vec3.cross(ident,dir,_vec3_tmp2);var teta=Math.acos(dot);dest[0]=A[0]*Math.sin(teta/2);dest[1]=A[1]*Math.sin(teta/2);dest[2]=A[2]*Math.sin(teta/2);dest[3]=Math.cos(teta/2);return dest};exports.trans_quat_to_plane=function(trans,quat,ident,dest){if(!dest)var dest=new Float32Array(4);m_vec3.transformQuat(ident,quat,dest);dest[3]=-m_vec3.dot(trans,dest);return dest};
exports.dir_ground_proj_angle=function(obj){var render=obj._render;var quat=render.quat;var proj=_vec3_tmp;var defdir=_vec3_tmp2;switch(obj.type){case "CAMERA":proj[0]=0;proj[1]=-1;proj[2]=0;m_vec3.transformQuat(proj,quat,proj);defdir[0]=0;defdir[1]=0;defdir[2]=-1;break;case "MESH":proj[0]=0;proj[1]=0;proj[2]=1;m_vec3.transformQuat(proj,quat,proj);defdir[0]=0;defdir[1]=0;defdir[2]=1;break;case "EMPTY":proj[0]=0;proj[1]=1;proj[2]=0;m_vec3.transformQuat(proj,quat,proj);defdir[0]=0;defdir[1]=1;defdir[2]=
0;break}proj[1]=0;m_vec3.normalize(proj,proj);var cos=m_vec3.dot(proj,defdir);var sign=-proj[0]*defdir[2]>0?-1:1;var angle=Math.acos(cos)*sign;return angle};exports.blend_arrays=blend_arrays;function blend_arrays(a1,a2,f){if(f==0)return a1;var a=[];for(var i=0;i<a1.length;i++)a[i]=(1-f)*a1[i]+f*a2[i];return a}exports.unique_id=unique_id;function unique_id(){_unique_counter++;return _unique_counter.toString(16)}exports.unique_name=function(name_base){if(!_unique_name_counters[name_base])_unique_name_counters[name_base]=
0;var name=name_base+_unique_name_counters[name_base];_unique_name_counters[name_base]++;return name};exports.create_empty_va_frame=function(){var va_frame={"a_position":new Float32Array(0),"a_tangent":new Float32Array(0),"a_normal":new Float32Array(0)};return va_frame};exports.create_empty_submesh=function(name){var va_common={"a_influence":new Float32Array(0),"a_color":new Float32Array(0),"a_texcoord":new Float32Array(0)};return{name:name,base_length:0,indices:null,va_frames:[],va_common:va_common}};
exports.create_render=function(type){var render={};render.type=type;switch(type){case "DYNAMIC":case "STATIC":case "CAMERA":case "EMPTY":case "LAMP":case "ARMATURE":case "SPEAKER":case "CURVE":case "FONT":render.trans=new Float32Array([0,0,0]);render.scale=1;render.quat=new Float32Array([0,0,0,1]);render.tsr=new Float32Array([0,0,0,1,0,0,0,1]);var world_matrix=new Float32Array(16);m_mat4.identity(world_matrix);render.world_matrix=world_matrix;var inv_world_matrix=new Float32Array(16);m_mat4.identity(inv_world_matrix);
render.inv_world_matrix=inv_world_matrix;render.lod_dist_max=1E4;render.lod_dist_min=0;render.va_frame=0;break;case "NONE":render.va_frame=0;break}return render};exports.init_object=function(name,type){var obj={"name":name,"type":type,"modifiers":[],"particle_systems":[]};return obj};exports.clone_object_json=function(obj){return JSON.parse(JSON.stringify(obj))};exports.clone_object=function(obj,bpy_data){var links=[];for(var datablock in bpy_data){var block_objs=bpy_data[datablock];if(block_objs)for(var j=
0;j<block_objs.length;j++)links.push(block_objs[j])}var new_obj=clone_iteration(obj,links);return new_obj};function clone_iteration(obj,links){var new_obj=obj instanceof Array?[]:{};for(var i in obj)if(obj[i]&&(typeof obj[i]=="object"&&(links.indexOf(obj[i])==-1&&!(obj[i]instanceof Float32Array))))new_obj[i]=clone_iteration(obj[i],links);else new_obj[i]=obj[i];return new_obj}exports.clone_object_r=function(obj){var new_obj=obj instanceof Array?[]:{};for(var i in obj)if(obj[i]&&typeof obj[i]=="object")if(obj[i]instanceof
Float32Array)new_obj[i]=new Float32Array(obj[i]);else if(obj[i]instanceof Uint32Array)new_obj[i]=new Uint32Array(obj[i]);else if(obj[i]instanceof Uint16Array)new_obj[i]=new Uint16Array(obj[i]);else new_obj[i]=exports.clone_object_r(obj[i]);else new_obj[i]=obj[i];return new_obj};exports.clone_object_nr=function(obj){var new_obj=obj instanceof Array?[]:{};for(var i in obj)if(obj[i]&&typeof obj[i]=="object")if(obj[i]instanceof Float32Array)new_obj[i]=new Float32Array(obj[i]);else if(obj[i]instanceof
Uint32Array)new_obj[i]=new Uint32Array(obj[i]);else if(obj[i]instanceof Uint16Array)new_obj[i]=new Uint16Array(obj[i]);else if(obj[i]instanceof Array)new_obj[i]=obj[i].slice(0);else new_obj[i]=obj[i];else new_obj[i]=obj[i];return new_obj};exports.is_mesh=function(obj){if(obj["type"]==="MESH")return true;else return false};exports.is_dynamic_mesh=function(obj){if(obj["type"]==="MESH"&&(obj._render&&obj._render.type==="DYNAMIC"))return true;else return false};exports.is_armature=function(obj){if(obj["type"]===
"ARMATURE")return true;else return false};exports.matrix_to_quat=matrix_to_quat;function matrix_to_quat(matrix,dest){if(!dest)var dest=new Float32Array(4);m_mat3.fromMat4(matrix,_mat3_tmp);var m0=_mat3_tmp[0];var m3=_mat3_tmp[3];var m6=_mat3_tmp[6];var m1=_mat3_tmp[1];var m4=_mat3_tmp[4];var m7=_mat3_tmp[7];var m2=_mat3_tmp[2];var m5=_mat3_tmp[5];var m8=_mat3_tmp[8];var l0=Math.sqrt(m0*m0+m3*m3+m6*m6)||1;var l1=Math.sqrt(m1*m1+m4*m4+m7*m7)||1;var l2=Math.sqrt(m2*m2+m5*m5+m8*m8)||1;_mat3_tmp[0]/=l0;
_mat3_tmp[3]/=l0;_mat3_tmp[6]/=l0;_mat3_tmp[1]/=l1;_mat3_tmp[4]/=l1;_mat3_tmp[7]/=l1;_mat3_tmp[2]/=l2;_mat3_tmp[5]/=l2;_mat3_tmp[8]/=l2;m_quat.fromMat3(_mat3_tmp,dest);return dest}exports.matrix_to_trans=function(matrix,dest){if(!dest)var dest=new Float32Array(3);dest[0]=matrix[12];dest[1]=matrix[13];dest[2]=matrix[14];return dest};exports.matrix_to_scale=function(matrix){_vec4_tmp[0]=0.577350269189626;_vec4_tmp[1]=0.577350269189626;_vec4_tmp[2]=0.577350269189626;_vec4_tmp[3]=0;m_vec4.transformMat4(_vec4_tmp,
matrix,_vec4_tmp);return m_vec4.length(_vec4_tmp)};exports.extract_frustum_planes=function(m,planes){var left=planes.left;var right=planes.right;var top=planes.top;var bottom=planes.bottom;var near=planes.near;var far=planes.far;left[0]=m[3]+m[0];left[1]=m[7]+m[4];left[2]=m[11]+m[8];left[3]=m[15]+m[12];right[0]=m[3]-m[0];right[1]=m[7]-m[4];right[2]=m[11]-m[8];right[3]=m[15]-m[12];top[0]=m[3]-m[1];top[1]=m[7]-m[5];top[2]=m[11]-m[9];top[3]=m[15]-m[13];bottom[0]=m[3]+m[1];bottom[1]=m[7]+m[5];bottom[2]=
m[11]+m[9];bottom[3]=m[15]+m[13];near[0]=m[3]+m[2];near[1]=m[7]+m[6];near[2]=m[11]+m[10];near[3]=m[15]+m[14];far[0]=m[3]-m[2];far[1]=m[7]-m[6];far[2]=m[11]-m[10];far[3]=m[15]-m[14];normalize_plane(left);normalize_plane(right);normalize_plane(top);normalize_plane(bottom);normalize_plane(near);normalize_plane(far);return planes};function normalize_plane(plane){var a=plane[0],b=plane[1],c=plane[2],d=plane[3];var len=Math.sqrt(a*a+b*b+c*c);len=1/len;plane[0]=a*len;plane[1]=b*len;plane[2]=c*len;plane[3]=
d*len}exports.sphere_is_out_of_frustum=function(pt,planes,radius){if(radius<-point_plane_dist(pt,planes.left)||(radius<-point_plane_dist(pt,planes.right)||(radius<-point_plane_dist(pt,planes.top)||(radius<-point_plane_dist(pt,planes.bottom)||(radius<-point_plane_dist(pt,planes.near)||radius<-point_plane_dist(pt,planes.far))))))return true;else return false};exports.ellipsoid_is_out_of_frustum=function(pt,planes,axis_x,axis_y,axis_z){dot_nx=m_vec3.dot(axis_x,planes.far);dot_ny=m_vec3.dot(axis_y,planes.far);
dot_nz=m_vec3.dot(axis_z,planes.far);var r_far=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_far<-point_plane_dist(pt,planes.near)||r_far<-point_plane_dist(pt,planes.far))return true;var dot_nx=m_vec3.dot(axis_x,planes.left);var dot_ny=m_vec3.dot(axis_y,planes.left);var dot_nz=m_vec3.dot(axis_z,planes.left);var r_left=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_left<-point_plane_dist(pt,planes.left))return true;dot_nx=m_vec3.dot(axis_x,planes.right);dot_ny=m_vec3.dot(axis_y,
planes.right);dot_nz=m_vec3.dot(axis_z,planes.right);var r_right=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_right<-point_plane_dist(pt,planes.right))return true;dot_nx=m_vec3.dot(axis_x,planes.top);dot_ny=m_vec3.dot(axis_y,planes.top);dot_nz=m_vec3.dot(axis_z,planes.top);var r_top=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_top<-point_plane_dist(pt,planes.top))return true;dot_nx=m_vec3.dot(axis_x,planes.bottom);dot_ny=m_vec3.dot(axis_y,planes.bottom);dot_nz=m_vec3.dot(axis_z,
planes.bottom);var r_bott=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_bott<-point_plane_dist(pt,planes.bottom))return true;return false};function point_plane_dist(pt,plane){return plane[0]*pt[0]+plane[1]*pt[1]+plane[2]*pt[2]+plane[3]}exports.positions_multiply_matrix=function(positions,matrix,new_positions,dest_offset){if(!dest_offset)var dest_offset=0;var len=positions.length;for(var i=0;i<len;i+=3){var x=positions[i];var y=positions[i+1];var z=positions[i+2];new_positions[dest_offset+
i]=matrix[0]*x+matrix[4]*y+matrix[8]*z+matrix[12];new_positions[dest_offset+i+1]=matrix[1]*x+matrix[5]*y+matrix[9]*z+matrix[13];new_positions[dest_offset+i+2]=matrix[2]*x+matrix[6]*y+matrix[10]*z+matrix[14]}return new_positions};exports.vectors_multiply_matrix=function(vectors,matrix,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;for(var i=0;i<len;i+=3){var x=vectors[i];var y=vectors[i+1];var z=vectors[i+2];new_vectors[dest_offset+i]=matrix[0]*x+matrix[4]*y+matrix[8]*
z;new_vectors[dest_offset+i+1]=matrix[1]*x+matrix[5]*y+matrix[9]*z;new_vectors[dest_offset+i+2]=matrix[2]*x+matrix[6]*y+matrix[10]*z}return new_vectors};exports.tangents_multiply_matrix=function(vectors,matrix,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;for(var i=0;i<len;i+=4){var x=vectors[i];var y=vectors[i+1];var z=vectors[i+2];new_vectors[dest_offset+i]=matrix[0]*x+matrix[4]*y+matrix[8]*z;new_vectors[dest_offset+i+1]=matrix[1]*x+matrix[5]*y+matrix[9]*z;new_vectors[dest_offset+
i+2]=matrix[2]*x+matrix[6]*y+matrix[10]*z;new_vectors[dest_offset+i+3]=vectors[i+3]}return new_vectors};exports.vecdir_multiply_matrix=function(vec,matrix,dest){if(!dest)var dest=new Float32Array(3);var v4=_vec4_tmp;v4[0]=vec[0];v4[1]=vec[1];v4[2]=vec[2];v4[3]=0;m_vec4.transformMat4(v4,matrix,v4);dest[0]=v4[0];dest[1]=v4[1];dest[2]=v4[2]};exports.flatten=function(array,dest){var len=array.length;if(!len)throw"flatten(): Wrong or empty array";var len0=array[0].length;if(!len0)throw"flatten(): Wrong or empty subarray";
if(!dest)var dest=new Float32Array(len*len0);for(var i=0;i<len;i++)for(var j=0;j<len0;j++)dest[i*len0+j]=array[i][j];return dest};exports.vectorize=function(array,dest){if(!dest)var dest=[];for(var i=0;i<array.length;i+=3){var v3=new Float32Array([array[i],array[i+1],array[i+2]]);dest[i/3]=v3}return dest};exports.binary_search_max=function(arr,max,start,end){if(end<start)return start;var mid=start+Math.floor((end-start)/2);if(arr[mid]>max)return exports.binary_search_max(arr,max,start,mid-1);else if(arr[mid]<
max)return exports.binary_search_max(arr,max,mid+1,end);else return mid};exports.cmp_arr=function(arr_1,arr_2){for(var i=0;i<arr_1.length;i++)if(arr_1[i]!=arr_2[i])return false;return true};exports.cmp_arr_float=function(arr_1,arr_2,precision){for(var i=0;i<arr_1.length;i++)if(Math.abs(arr_1[i]-arr_2[i])>precision)return false;return true};exports.scale_mat4=function(matrix,scale,dest){if(!dest)var dest=new Float32Array(16);for(var i=0;i<12;i++)dest[i]=matrix[i]*scale;dest[12]=matrix[12];dest[13]=
matrix[13];dest[14]=matrix[14];dest[15]=matrix[15];return dest};exports.transform_mat4=function(matrix,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(16);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);m_mat4.multiply(m,matrix,dest);return dest};exports.transform_vec3=function(vec,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(3);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);m_vec3.transformMat4(vec,m,dest);return dest};exports.transform_vec4=function(vec,
scale,quat,trans,dest){if(!dest)var dest=new Float32Array(4);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);m_vec4.transformMat4(vec,m,dest);return dest};exports.inverse_transform_vec3=function(vec,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(3);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);m_mat4.invert(m,m);m_vec3.transformMat4(vec,m,dest);return dest};exports.transcale_quat_to_matrix=function(trans,quat,dest){if(!dest)var dest=new Float32Array(16);m_mat4.fromRotationTranslation(quat,
trans,dest);var scale=trans[3];for(var i=0;i<12;i++)dest[i]*=scale;return dest};exports.matrix_to_transcale_quat=function(matrix,dest_transcale,dest_quat){exports.matrix_to_trans(matrix,dest_transcale);dest_transcale[3]=exports.matrix_to_scale(matrix);exports.matrix_to_quat(matrix,dest_quat)};exports.array_stringify=function(array){var out=[];for(var i=0;i<array.length;i++)out.push(array[i]);return JSON.stringify(out)};exports.rotate_point_pivot=function(point,pivot,quat,dest){if(!dest)var dest=new Float32Array(3);
var point_rel=_vec3_tmp;m_vec3.subtract(pivot,point,point_rel);m_vec3.transformQuat(point_rel,quat,point_rel);m_vec3.subtract(pivot,point_rel,dest)};exports.generate_cubemap_matrices=function(){var eye_pos=new Float32Array([0,0,0]);var x_pos=new Float32Array(16);var x_neg=new Float32Array(16);var y_pos=new Float32Array(16);var y_neg=new Float32Array(16);var z_pos=new Float32Array(16);var z_neg=new Float32Array(16);m_mat4.lookAt(eye_pos,[-1,0,0],[0,-1,0],x_pos);m_mat4.scale(x_pos,[-1,1,1],x_pos);m_mat4.scale(x_pos,
[-1,1,-1],x_neg);m_mat4.lookAt(eye_pos,[0,0,-1],[0,-1,0],y_pos);m_mat4.scale(y_pos,[-1,1,1],y_pos);m_mat4.scale(y_pos,[-1,1,-1],y_neg);m_mat4.lookAt(eye_pos,[0,-1,0],[0,0,-1],z_neg);m_mat4.scale(z_neg,[1,1,-1],z_neg);m_mat4.scale(z_neg,[-1,-1,-1],z_pos);return[z_pos,z_neg,x_pos,x_neg,y_pos,y_neg]};exports.hash_code=function(str){var hash=0;for(var i=0;i<str.length;i++){var symbol=str.charCodeAt(i);hash=(hash<<5)-hash+symbol;hash=hash&hash}return hash};exports.mat4_translate=function(mat,vec,dest){var x=
vec[0],y=vec[1],z=vec[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(!dest||mat===dest){mat[12]=mat[0]*x+mat[4]*y+mat[8]*z+mat[12];mat[13]=mat[1]*x+mat[5]*y+mat[9]*z+mat[13];mat[14]=mat[2]*x+mat[6]*y+mat[10]*z+mat[14];mat[15]=mat[3]*x+mat[7]*y+mat[11]*z+mat[15];return mat}a00=mat[0];a01=mat[1];a02=mat[2];a03=mat[3];a10=mat[4];a11=mat[5];a12=mat[6];a13=mat[7];a20=mat[8];a21=mat[9];a22=mat[10];a23=mat[11];dest[0]=a00;dest[1]=a01;dest[2]=a02;dest[3]=a03;dest[4]=a10;dest[5]=a11;dest[6]=a12;dest[7]=
a13;dest[8]=a20;dest[9]=a21;dest[10]=a22;dest[11]=a23;dest[12]=a00*x+a10*y+a20*z+mat[12];dest[13]=a01*x+a11*y+a21*z+mat[13];dest[14]=a02*x+a12*y+a22*z+mat[14];dest[15]=a03*x+a13*y+a23*z+mat[15];return dest};exports.mat3_to_mat4=function(mat,dest){dest[15]=1;dest[14]=0;dest[13]=0;dest[12]=0;dest[11]=0;dest[10]=mat[8];dest[9]=mat[7];dest[8]=mat[6];dest[7]=0;dest[6]=mat[5];dest[5]=mat[4];dest[4]=mat[3];dest[3]=0;dest[2]=mat[2];dest[1]=mat[1];dest[0]=mat[0];return dest};exports.quat_to_angle_axis=function(src,
dest){if(!dest)dest=src;var sqrlen=src[0]*src[0]+src[1]*src[1]+src[2]*src[2];if(sqrlen>0){dest[3]=2*Math.acos(src[3]);var invlen=1/Math.sqrt(sqrlen);dest[0]=src[0]*invlen;dest[1]=src[1]*invlen;dest[2]=src[2]*invlen}else{dest[3]=0;dest[0]=1;dest[1]=0;dest[2]=0}return dest};function permute3(x){x=(34*x+1)*x;return x%289}function fract(x){return x-Math.floor(x)}exports.trunc=function(x){return isNaN(x)||typeof x=="undefined"?NaN:x|0};exports.rad=function(x){return x*Math.PI/180};exports.deg=function(x){return x*
180/Math.PI};exports.snoise=function(p){var C_x=0.211324865405187;var C_y=0.366025403784439;var C_z=-0.577350269189626;var C_w=0.024390243902439;var v_dot_Cyy=p[0]*C_y+p[1]*C_y;var i_x=Math.floor(p[0]+v_dot_Cyy);var i_y=Math.floor(p[1]+v_dot_Cyy);var i_dot_Cxx=i_x*C_x+i_y*C_x;var x0_x=p[0]-i_x+i_dot_Cxx;var x0_y=p[1]-i_y+i_dot_Cxx;var i1_x=x0_x>x0_y?1:0;var i1_y=1-i1_x;var x12_x=x0_x+C_x-i1_x;var x12_y=x0_y+C_x-i1_y;var x12_z=x0_x+C_z;var x12_w=x0_y+C_z;i_x%=289;i_y%=289;var p_x=permute3(permute3(i_y)+
i_x);var p_y=permute3(permute3(i_y+i1_y)+i_x+i1_x);var p_z=permute3(permute3(i_y+1)+i_x+1);var m_x=Math.max(0.5-(x0_x*x0_x+x0_y*x0_y),0);var m_y=Math.max(0.5-(x12_x*x12_x+x12_y*x12_y),0);var m_z=Math.max(0.5-(x12_z*x12_z+x12_w*x12_w),0);m_x*=m_x*m_x*m_x;m_y*=m_y*m_y*m_y;m_z*=m_z*m_z*m_z;var x_x=2*fract(p_x*C_w)-1;var x_y=2*fract(p_y*C_w)-1;var x_z=2*fract(p_z*C_w)-1;var h_x=Math.abs(x_x)-0.5;var h_y=Math.abs(x_y)-0.5;var h_z=Math.abs(x_z)-0.5;var ox_x=Math.floor(x_x+0.5);var ox_y=Math.floor(x_y+0.5);
var ox_z=Math.floor(x_z+0.5);var a0_x=x_x-ox_x;var a0_y=x_y-ox_y;var a0_z=x_z-ox_z;m_x*=1.79284291400159-0.85373472095314*(a0_x*a0_x+h_x*h_x);m_y*=1.79284291400159-0.85373472095314*(a0_y*a0_y+h_y*h_y);m_z*=1.79284291400159-0.85373472095314*(a0_z*a0_z+h_z*h_z);var g_x=a0_x*x0_x+h_x*x0_y;var g_y=a0_y*x12_x+h_y*x12_y;var g_z=a0_z*x12_z+h_z*x12_w;var m_dot_g=m_x*g_x+m_y*g_y+m_z*g_z;return 130*m_dot_g};function permute(x){return mod289((34*x+5)*x)}function mod289(x){return x-Math.floor(x/289)*289}function mod7(x){return x-
Math.floor(x/7)*7}exports.cellular2x2=function(P){var K=1/7;var K2=K/2;var JITTER=0.7;var Pi_x=mod289(Math.floor(P[0]));var Pi_y=mod289(Math.floor(P[1]));var Pf_x=fract(P[0]);var Pf_y=fract(P[1]);var Pfx_x=Pf_x-0.5;var Pfx_y=Pf_x-1.5;var Pfx_z=Pfx_x;var Pfx_w=Pfx_y;var Pfy_x=Pf_y-0.5;var Pfy_y=Pfy_x;var Pfy_z=Pf_y-1.5;var Pfy_w=Pfy_z;var p_x=permute(Pi_x);var p_y=permute(Pi_x+1);var p_z=p_x;var p_w=p_y;p_x=permute(p_x+Pi_y);p_y=permute(p_y+Pi_y);p_z=permute(p_z+Pi_y+1);p_w=permute(p_w+Pi_y+1);var ox_x=
mod7(p_x)*K+K2;var ox_y=mod7(p_y)*K+K2;var ox_z=mod7(p_z)*K+K2;var ox_w=mod7(p_w)*K+K2;var oy_x=mod7(Math.floor(p_x*K))*K+K2;var oy_y=mod7(Math.floor(p_y*K))*K+K2;var oy_z=mod7(Math.floor(p_z*K))*K+K2;var oy_w=mod7(Math.floor(p_w*K))*K+K2;var dx_x=Pfx_x+JITTER*ox_x;var dx_y=Pfx_y+JITTER*ox_y;var dx_z=Pfx_z+JITTER*ox_z;var dx_w=Pfx_w+JITTER*ox_w;var dy_x=Pfy_x+JITTER*oy_x;var dy_y=Pfy_y+JITTER*oy_y;var dy_z=Pfy_z+JITTER*oy_z;var dy_w=Pfy_w+JITTER*oy_w;var d_x=dx_x*dx_x+dy_x*dy_x;var d_y=dx_y*dx_y+
dy_y*dy_y;var d_z=dx_z*dx_z+dy_z*dy_z;var d_w=dx_w*dx_w+dy_w*dy_w;var d=Math.min(d_x,d_y,d_z,d_w);return d};exports.quat_project=function(quat,quat_ident_dir,plane,plane_ident_dir,dest){if(!dest)var dest=new Float32Array(4);var to=m_vec3.transformQuat(quat_ident_dir,quat,_vec3_tmp);var a=plane[0];var b=plane[1];var c=plane[2];var proj=_mat3_tmp;proj[0]=b*b+c*c;proj[1]=-b*a;proj[2]=-c*a;proj[3]=-a*b;proj[4]=a*a+c*c;proj[5]=-c*b;proj[6]=-a*c;proj[7]=-b*c;proj[8]=a*a+b*b;m_vec3.transformMat3(to,proj,
to);m_vec3.normalize(to,to);m_quat.rotationTo(plane_ident_dir,to,dest);return dest};exports.cam_quat_to_mesh_quat=function(cam_quat,dest){if(!dest)var dest=new Float32Array(4);var quat_offset=_vec4_tmp;var quat_offset_x=_vec4_tmp2;quat_offset=m_quat.setAxisAngle([0,1,0],Math.PI,m_quat.create());quat_offset_x=m_quat.setAxisAngle([1,0,0],Math.PI/2,m_quat.create());m_quat.multiply(quat_offset,quat_offset_x,quat_offset);m_quat.multiply(cam_quat,quat_offset,dest);return dest};exports.cleanup=function(){_unique_counter=
0;_unique_name_counters={}};exports.clamp=function(value,min,max){return Math.min(Math.max(value,min),max)};exports.smooth=function(curr,last,delta,period){var e=Math.exp(-delta/period);return(1-e)*curr+e*last};exports.smooth_v=function(curr,last,delta,period,dest){if(!dest)dest=new Float32Array(curr.length);var e=Math.exp(-delta/period);for(var i=0;i<dest.length;i++)dest[i]=(1-e)*curr[i]+e*last[i];return dest};exports.smooth_q=function(curr,last,delta,period,dest){if(!dest)dest=new Float32Array(curr.length);
var e=Math.exp(-delta/period);m_quat.slerp(curr,last,e,dest);return dest};exports.is_arr_buf_view=function(o){if(typeof o==="object"&&(o.buffer&&o.buffer instanceof ArrayBuffer))return true;else return false};exports.is_vector=function(o,dimension){if(o instanceof Array||o.buffer&&o.buffer instanceof ArrayBuffer)if(dimension&&dimension==o.length)return true;else if(dimension)return false;else return true;return false};exports.correct_cam_quat_up=function(quat,up_only){var rmat=m_mat3.fromQuat(quat,
_mat3_tmp);var y_world=_vec3_tmp2;y_world[0]=0;y_world[1]=1;y_world[2]=0;var y_cam_world=_vec3_tmp;y_cam_world[0]=rmat[3];y_cam_world[1]=rmat[4];y_cam_world[2]=rmat[5];var x_cam_world_new=m_vec3.cross(y_world,y_cam_world,y_cam_world);m_vec3.normalize(x_cam_world_new,x_cam_world_new);var z_cam_world_y=rmat[7];if(!up_only&&z_cam_world_y>0){x_cam_world_new[0]*=-1;x_cam_world_new[1]*=-1;x_cam_world_new[2]*=-1}var x_cam_world=_vec3_tmp2;x_cam_world[0]=rmat[0];x_cam_world[1]=rmat[1];x_cam_world[2]=rmat[2];
m_vec3.normalize(x_cam_world,x_cam_world);var correct_quat=_vec4_tmp2;m_quat.rotationTo(x_cam_world,x_cam_world_new,correct_quat);m_quat.multiply(correct_quat,quat,quat)};exports.get_array_smooth_value=function(array,row_width,x,y){var px=x*row_width-0.5;var py=y*row_width-0.5;var fract_px=px-Math.floor(px);var fract_py=py-Math.floor(py);px=Math.floor(px);py=Math.floor(py);var up_lim=row_width-1;var val_00=array[py*row_width+px];var val_10=array[py*row_width+Math.min(px+1,up_lim)];var val_01=array[Math.min(py+
1,up_lim)*row_width+px];var val_11=array[Math.min(py+1,up_lim)*row_width+Math.min(px+1,up_lim)];var val_0010=val_00*(1-fract_px)+val_10*fract_px;var val_0111=val_01*(1-fract_px)+val_11*fract_px;var smooth_value=val_0010*(1-fract_py)+val_0111*fract_py;return smooth_value};exports.rgb_mask_get_channels_count=function(mask){var count=0;for(var i=0;i<3;i++)if((mask&1<<i)>0)count++;return count};exports.rgb_mask_get_channels_presence=rgb_mask_get_channels_presence;function rgb_mask_get_channels_presence(mask){var presence=
[0,0,0];for(var i=0;i<3;i++)if((mask&1<<i)>0)presence[2-i]=1;return presence}exports.rgb_mask_get_channel_presence_index=function(mask,channel){var index=0;if(channel==1||channel==2)if((mask&1<<2)>0)index++;if(channel==2)if((mask&1<<1)>0)index++;return index};exports.gen_uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})};exports.get_dict_length=function(dict){var count=0;for(prop in dict)if(dict.hasOwnProperty(prop))count++;
return count};exports.random_from_array=function(array){if(!array.length)return null;var pos=Math.floor(Math.random()*array.length);return array[pos]};exports.xz_direction=function(a,b,dest){if(!dest)dest=new Float32Array(3);dest[0]=a[0]-b[0];dest[1]=0;dest[2]=a[2]-b[2];m_vec3.normalize(dest,dest)};exports.transformQuatFast=function(a,q,out){var ax=a[0],ay=a[1],az=a[2];var qx=q[0],qy=q[1],qz=q[2],qw=q[3];var uvx=qy*az-qz*ay,uvy=qz*ax-qx*az,uvz=qx*ay-qy*ax;var uuvx=qy*uvz-qz*uvy,uuvy=qz*uvx-qx*uvz,
uuvz=qx*uvy-qy*uvx;uvx*=qw*2;uvy*=qw*2;uvz*=qw*2;uuvx*=2;uuvy*=2;uuvz*=2;out[0]=ax+uvx+uuvx;out[1]=ay+uvy+uuvy;out[2]=az+uvz+uuvz;return out};exports.panic=function(s){if(s)m_print.error(s);throw"panic: see above for possible error messages";}};b4w.module["__sfx"]=function(exports,require){var m_cfg=require("__config");var m_dbg=require("__debug");var m_print=require("__print");var m_util=require("__util");var m_vec3=require("vec3");var cfg_ani=m_cfg.animation;var cfg_sfx=m_cfg.sfx;var SPEED_WARM_STEPS=10;var SPEED_SMOOTH_PERIOD=0.3;var SPKSTATE_UNDEFINED=10;var SPKSTATE_PLAY=20;var SPKSTATE_STOP=30;var SPKSTATE_PAUSE=40;var SCHED_PARAM_LOOPS=5;var SCHED_PARAM_ANTICIPATE_TIME=3;exports.AST_NONE=10;exports.AST_ARRAY_BUFFER=20;exports.AST_HTML_ELEMENT=
30;var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _supported_media=[];var _wa=null;var _active_scene=null;var _speaker_objects=[];var _listener_last_eye=new Float32Array(3);var _listener_speed_avg=new Float32Array(3);var _listener_speed_warm=SPEED_WARM_STEPS;var _seed_tmp=[1];var _playlist=null;exports.init=function(){var audio=document.createElement("audio");if(audio.canPlayType){if(audio.canPlayType("audio/ogg")!="")_supported_media.push("ogg");
if(audio.canPlayType("audio/mpeg")!="")_supported_media.push("mp3");if(audio.canPlayType("audio/mp4")!="")_supported_media.push("mp4")}_wa=cfg_sfx.webaudio?create_wa_context():null;if(_wa)m_print.log("%cINIT WEBAUDIO: "+_wa.sampleRate+"Hz","color: #00a")};exports.attach_scene_sfx=function(scene){var scene_sfx={};scene._sfx=scene_sfx;if(_wa){var gnode=_wa.createGain();var fade_gnode=_wa.createGain();scene_sfx.gain_node=gnode;scene_sfx.fade_gain_node=fade_gnode;gnode.connect(fade_gnode);fade_gnode.connect(_wa.destination);
if(scene["b4w_enable_dynamic_compressor"]){var compressor=_wa.createDynamicsCompressor();var dcs=scene["b4w_dynamic_compressor_settings"];compressor.threshold.value=dcs["threshold"];compressor.knee.value=dcs["knee"];compressor.ratio.value=dcs["ratio"];compressor.attack.value=dcs["attack"];compressor.release.value=dcs["release"];compressor.connect(gnode);scene_sfx.compressor_node=compressor;scene_sfx.proc_chain_in=compressor}else{scene_sfx.compressor_node=null;scene_sfx.proc_chain_in=gnode}var listener=
_wa.listener;listener.dopplerFactor=scene["audio_doppler_factor"];listener.speedOfSound=scene["audio_doppler_speed"];scene_sfx.muted=false;scene_sfx.volume=1;scene_sfx.duck_time=0}};function create_wa_context(){var AudioContext=window["AudioContext"]||window["webkitAudioContext"];if(AudioContext){var ctx=new AudioContext;if(ctx.createGain)return ctx;else{m_print.warn("B4W warning: deprecated WebAudio implementation");return null}}else{m_print.warn("B4W warning: WebAudio is not supported");return null}}
exports.set_active_scene=function(scene){_active_scene=scene};exports.detect_media_container=function(hint){if(!hint)var hint="ogg";var audio=new Audio;if(_supported_media.indexOf(hint)>-1)return hint;else if(hint=="ogg"&&_supported_media.indexOf("mp4")>-1)return"mp4";else if(hint=="mp3"&&_supported_media.indexOf("ogg")>-1)return"ogg";else if(hint=="mp4"&&_supported_media.indexOf("ogg")>-1)return"ogg";else return""};exports.append_object=function(obj,scene){if(obj["type"]!="SPEAKER")throw"Wrong speaker object";
var speaker=obj["data"];obj._sfx={};switch(speaker["b4w_behavior"]){case "POSITIONAL":case "BACKGROUND_SOUND":obj._sfx.behavior=_wa?speaker["b4w_behavior"]:"NONE";break;case "BACKGROUND_MUSIC":obj._sfx.behavior=_wa?check_media_element_node()?"BACKGROUND_MUSIC":"BACKGROUND_SOUND":"NONE";break;default:throw"Wrong speaker behavior";break}if(!speaker["sound"])obj._sfx.behavior="NONE";obj._sfx.disable_doppler=speaker["b4w_disable_doppler"];obj._sfx.muted=speaker["muted"];obj._sfx.volume=speaker["volume"];
obj._sfx.pitch=speaker["pitch"];obj._sfx.attenuation=speaker["attenuation"];obj._sfx.dist_ref=speaker["distance_reference"];obj._sfx.dist_max=speaker["distance_max"]||1E4;obj._sfx.cone_angle_inner=speaker["cone_angle_inner"];obj._sfx.cone_angle_outer=speaker["cone_angle_outer"];obj._sfx.cone_volume_outer=speaker["cone_volume_outer"];obj._sfx.cyclic=speaker["b4w_cyclic_play"];obj._sfx.loop=speaker["b4w_loop"];obj._sfx.delay=speaker["b4w_delay"];obj._sfx.delay_random=speaker["b4w_delay_random"];obj._sfx.volume_random=
speaker["b4w_volume_random"];obj._sfx.pitch_random=speaker["b4w_pitch_random"];obj._sfx.fade_in=speaker["b4w_fade_in"];obj._sfx.fade_out=speaker["b4w_fade_out"];obj._sfx.start_time=0;obj._sfx.pause_time=0;obj._sfx.buf_offset=0;obj._sfx.duration=0;obj._sfx.vp_rand_end_time=0;obj._sfx.base_seed=1;obj._sfx.src=null;obj._sfx.state=SPKSTATE_UNDEFINED;obj._sfx.last_position=new Float32Array(obj._render.trans);obj._sfx.speed_avg=new Float32Array(obj._render.trans);obj._sfx.bgm_stop_timeout=null;obj._sfx.duck_time=
0;_speaker_objects.push(obj)};function check_media_element_node(){if(window["MediaElementAudioSourceNode"])return true;else{m_print.warn("B4W warning: MediaElementAudioSourceNode not found");return false}}exports.source_type=function(obj){if(obj["type"]!="SPEAKER")throw"Wrong object type";switch(obj._sfx.behavior){case "POSITIONAL":return exports.AST_ARRAY_BUFFER;case "BACKGROUND_SOUND":return exports.AST_ARRAY_BUFFER;case "BACKGROUND_MUSIC":return exports.AST_HTML_ELEMENT;case "NONE":return exports.AST_NONE;
default:throw"Wrong speaker behavior";}};exports.update_spkobj=function(obj,sound_data){if(obj["type"]!="SPEAKER")throw"Wrong object type";var sfx=obj._sfx;switch(sfx.behavior){case "POSITIONAL":case "BACKGROUND_SOUND":case "BACKGROUND_MUSIC":sfx.src=sound_data;break;case "NONE":break;default:throw"Wrong speaker behavior";}};exports.decode_audio_data=function(arr_buf,decode_cb,fail_cb){if(_wa)_wa.decodeAudioData(arr_buf,decode_cb,fail_cb);else fail_cb()};exports.speaker_remove=function(obj){stop(obj);
delete obj._sfx;_speaker_objects.splice(_speaker_objects.indexOf(obj),1)};exports.cleanup=function(){for(var i=0;i<_speaker_objects.length;i++){var obj=_speaker_objects[i];var sfx=obj._sfx;if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;if(audio_el)audio_el.pause()}else if(sfx.source_node)sfx.source_node.disconnect()}_active_scene=null;_speaker_objects.splice(0);_listener_last_eye[0]=0;_listener_last_eye[0]=0;_listener_last_eye[0]=0;_listener_speed_avg[0]=0;_listener_speed_avg[1]=0;_listener_speed_avg[2]=
0;_listener_speed_warm=SPEED_WARM_STEPS;_playlist=null};exports.update=function(timeline,elapsed){if(!_wa||_speaker_objects.length==0)return;for(var i=0;i<_speaker_objects.length;i++){var obj=_speaker_objects[i];var sfx=obj._sfx;var curr_time=_wa.currentTime;if(!sfx.loop&&(sfx.cyclic&&(sfx.state==SPKSTATE_PLAY&&(sfx.duration&&(_wa&&sfx.start_time+sfx.duration<curr_time)))))play_def(obj);if(sfx.state==SPKSTATE_PLAY&&sfx.vp_rand_end_time-curr_time<SCHED_PARAM_ANTICIPATE_TIME)schedule_volume_pitch_random(sfx)}if(_playlist&&
(_playlist.active==-1||timeline>_playlist.active_start_time+_playlist.durations[_playlist.active]))playlist_switch_next(_playlist,timeline)};function playlist_switch_next(playlist,timeline){if(playlist.active>-1)stop(playlist.speakers[playlist.active]);if(playlist.active==-1&&playlist.random)var next=Math.round(Math.random()*(playlist.speakers.length-1));else if(playlist.random){var advance=1+Math.round(Math.random()*(playlist.speakers.length-2));var next=(playlist.active+advance)%playlist.speakers.length}else var next=
(playlist.active+1)%playlist.speakers.length;play_def(playlist.speakers[next]);playlist.active=next;playlist.active_start_time=timeline}exports.play=play;function play(obj,when,duration){var sfx=obj._sfx;if(sfx.behavior=="NONE")return;if(!duration)var duration=0;var sound=obj["data"]["sound"];var loop=sfx.loop;var playrate=sfx.pitch;if(!(sfx.src&&(loop||duration>=0)))return;sfx.base_seed=Math.floor(5E4*Math.random());var start_time=_wa.currentTime+when;sfx.start_time=start_time;sfx.state=SPKSTATE_PLAY;
update_proc_chain(obj);if(sfx.behavior=="POSITIONAL"||sfx.behavior=="BACKGROUND_SOUND"){var source=_wa.createBufferSource();source.buffer=sfx.src;source.playbackRate.value=playrate;if(loop){if(sfx.source_node)sfx.source_node.disconnect();source.loop=true;source.start(start_time);sfx.duration=0}else{var buf_dur=source.buffer?source.buffer.duration:0;if(duration>buf_dur){var to=start_time+duration+sfx.fade_out;source.loop=true;source.start(start_time);source.stop(to);sfx.duration=duration}else{source.loop=
false;source.start(start_time);sfx.duration=buf_dur}}source.connect(sfx.proc_chain_in);sfx.source_node=source;reset_volume_pitch_random(sfx);schedule_volume_pitch_random(sfx)}else if(sfx.behavior=="BACKGROUND_MUSIC"){window.clearTimeout(sfx.bgm_stop_timeout);fire_audio_element(obj);sfx.duration=1E6}schedule_fades(sfx,start_time)}function update_proc_chain(obj){var sfx=obj._sfx;if(sfx.proc_chain_in)return;var pos=obj._render.trans;var quat=obj._render.quat;if(cfg_sfx.mix_mode){var filter_node=_wa.createBiquadFilter();
filter_node.type="peaking"}else var filter_node=null;var fade_gnode=_wa.createGain();switch(sfx.behavior){case "POSITIONAL":var ap=_wa.createPanner();ap.panningModel=ap.EQUALPOWER;ap.distanceModel=ap.INVERSE_DISTANCE;ap.setPosition(pos[0],pos[1],pos[2]);var orient=_vec3_tmp;m_util.quat_to_dir(quat,m_util.AXIS_MY,orient);ap.setOrientation(orient[0],orient[1],orient[2]);ap.refDistance=sfx.dist_ref;ap.maxDistance=sfx.dist_max;ap.rolloffFactor=sfx.attenuation;ap.coneInnerAngle=sfx.cone_angle_inner;ap.coneOuterAngle=
sfx.cone_angle_outer;ap.coneOuterGain=sfx.cone_volume_outer;var gnode=_wa.createGain();gnode.gain.value=calc_gain(sfx);if(filter_node){ap.connect(filter_node);filter_node.connect(gnode)}else ap.connect(gnode);gnode.connect(fade_gnode);sfx.proc_chain_in=ap;if(sfx.volume_random){var rand_gnode=_wa.createGain();fade_gnode.connect(rand_gnode);rand_gnode.connect(get_scene_dst_node(_active_scene))}else{var rand_gnode=null;fade_gnode.connect(get_scene_dst_node(_active_scene))}break;case "BACKGROUND_SOUND":var ap=
null;var gnode=_wa.createGain();gnode.gain.value=calc_gain(sfx);if(filter_node){sfx.proc_chain_in=filter_node;filter_node.connect(gnode)}else sfx.proc_chain_in=gnode;gnode.connect(fade_gnode);if(sfx.volume_random){var rand_gnode=_wa.createGain();fade_gnode.connect(rand_gnode);rand_gnode.connect(get_scene_dst_node(_active_scene))}else{var rand_gnode=null;fade_gnode.connect(get_scene_dst_node(_active_scene))}break;case "BACKGROUND_MUSIC":var ap=null;var rand_gnode=null;var gnode=_wa.createGain();gnode.gain.value=
calc_gain(sfx);if(filter_node){sfx.proc_chain_in=filter_node;filter_node.connect(gnode)}else sfx.proc_chain_in=gnode;gnode.connect(fade_gnode);fade_gnode.connect(get_scene_dst_node(_active_scene));break}sfx.panner_node=ap;sfx.filter_node=filter_node;sfx.gain_node=gnode;sfx.fade_gain_node=fade_gnode;sfx.rand_gain_node=rand_gnode}exports.play_def=play_def;function play_def(obj){var sfx=obj._sfx;var duration=sfx.duration;var delay=sfx.delay+sfx.delay_random*Math.random();play(obj,delay,duration)}function get_scene_dst_node(scene){if(_wa)return scene._sfx.proc_chain_in;
else return null}function get_gain_node(scene){if(_wa)return scene._sfx.gain_node;else return null}function get_fade_node(scene){if(_wa)return scene._sfx.fade_gain_node;else return null}function reset_volume_pitch_random(sfx){if(sfx.volume_random)sfx.rand_gain_node.gain.cancelScheduledValues(sfx.start_time);if(sfx.pitch_random)sfx.source_node.playbackRate.cancelScheduledValues(sfx.start_time);sfx.vp_rand_end_time=sfx.start_time}function schedule_volume_pitch_random(sfx){if(!(sfx.volume_random||sfx.pitch_random))return;
var rand_gnode=sfx.rand_gain_node;var source=sfx.source_node;var buf_dur=source.buffer?source.buffer.duration:0;if(!buf_dur)return;var time=sfx.start_time;_seed_tmp[0]=sfx.base_seed;for(var cnt=0;cnt<SCHED_PARAM_LOOPS;){var playrate=sfx.pitch+sfx.pitch_random*m_util.rand_r(_seed_tmp);if(time>=sfx.vp_rand_end_time){if(sfx.volume_random){var gain=1-m_util.clamp(sfx.volume_random,0,1)*Math.random();rand_gnode.gain.setValueAtTime(gain,time)}if(sfx.pitch_random)source.playbackRate.setValueAtTime(playrate,
time);cnt++}time+=buf_dur/playrate}sfx.vp_rand_end_time=time-0.001}function schedule_fades(sfx,from_time){if(!(sfx.fade_in||sfx.fade_out))return;var fade_gnode=sfx.fade_gain_node;fade_gnode.gain.cancelScheduledValues(from_time);if(sfx.fade_in){fade_gnode.gain.setValueAtTime(0,from_time);fade_gnode.gain.linearRampToValueAtTime(1,from_time+sfx.fade_in)}else fade_gnode.gain.setValueAtTime(1,from_time);if(sfx.fade_out&&!sfx.loop){var source=sfx.source_node;fade_gnode.gain.setValueAtTime(1,from_time+sfx.duration);
fade_gnode.gain.linearRampToValueAtTime(0,from_time+sfx.duration+sfx.fade_out)}}function fire_audio_element(obj){var sfx=obj._sfx;var audio=sfx.src;if(audio){audio.volume=1;audio.loop=sfx.cyclic;sfx.source_node=sfx.source_node||_wa.createMediaElementSource(audio);sfx.source_node.connect(sfx.proc_chain_in);if(sfx.state==SPKSTATE_PLAY)audio.play()}}exports.stop=stop;function stop(sobj){if(sobj["type"]!="SPEAKER")throw"Wrong object type";var sfx=sobj._sfx;if(sfx.state!=SPKSTATE_PLAY&&sfx.state!=SPKSTATE_PAUSE)return;
var fade_gnode=sfx.fade_gain_node;var current_time=_wa.currentTime;if(sfx.fade_out){fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(0,current_time+sfx.fade_out)}if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;if(audio_el){var stop_cb=function(){if(audio_el.currentTime)audio_el.currentTime=0;audio_el.pause()};sfx.bgm_stop_timeout=window.setTimeout(stop_cb,sfx.fade_out*1E3)}}else{var source=sfx.source_node;if(sfx.duration<source.buffer.duration)if(sfx.fade_out&&
sfx.state==SPKSTATE_PLAY)source.stop(current_time+sfx.fade_out);else{if(sfx.state==SPKSTATE_PLAY){source.stop(0);source.disconnect()}}else source.disconnect();sfx.start_time=0;sfx.pause_time=0;sfx.buf_offset=0}sfx.state=SPKSTATE_STOP}exports.is_play=is_play;function is_play(obj){return obj._sfx.state==SPKSTATE_PLAY}function speaker_pause(obj){var sfx=obj._sfx;if(sfx.state!=SPKSTATE_PLAY)return;if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;if(audio_el)audio_el.pause()}else{var source=sfx.source_node;
var playrate=source.playbackRate.value;var current_time=_wa.currentTime;sfx.pause_time=current_time;var buf_dur=source.buffer.duration;if(current_time>sfx.start_time)sfx.buf_offset=calc_buf_offset(sfx,current_time);else sfx.buf_offset=0;sfx.source_node.stop(0);sfx.source_node.disconnect();reset_volume_pitch_random(sfx)}sfx.state=SPKSTATE_PAUSE}function calc_buf_offset(sfx,current_time){_seed_tmp[0]=sfx.base_seed;var buf_dur=sfx.source_node.buffer.duration;var time=sfx.start_time;var playrate;while(time<
current_time){playrate=sfx.pitch+sfx.pitch_random*m_util.rand_r(_seed_tmp);time+=buf_dur/playrate}return(buf_dur/playrate-(time-current_time))*playrate}function speaker_resume(obj){var sfx=obj._sfx;if(sfx.state!=SPKSTATE_PAUSE)return;if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;audio_el.play()}else{update_source_node(obj);var current_time=_wa.currentTime;sfx.start_time+=current_time-sfx.pause_time;sfx.vp_rand_end_time=current_time;var source=sfx.source_node;var playrate=source.playbackRate.value;
var buf_dur=source.buffer.duration;source.start(sfx.start_time,sfx.buf_offset);schedule_volume_pitch_random(sfx);schedule_fades(sfx,sfx.start_time)}sfx.state=SPKSTATE_PLAY}function update_source_node(obj){var sfx=obj._sfx;var source=_wa.createBufferSource();source.loop=sfx.source_node.loop;source.buffer=sfx.source_node.buffer;source.playbackRate.value=sfx.source_node.playbackRate.value;if(sfx.panner_node)source.connect(sfx.panner_node);else source.connect(sfx.gain_node);sfx.source_node=source}exports.playrate=
function(obj,playrate){var sfx=obj._sfx;sfx.pitch=playrate;if(spk_is_active(obj)&&(sfx.behavior=="POSITIONAL"||sfx.behavior=="BACKGROUND_SOUND")){sfx.source_node.playbackRate.value=playrate;reset_volume_pitch_random(sfx);schedule_volume_pitch_random(sfx)}};exports.get_playrate=function(obj){return obj._sfx.pitch};exports.cyclic=function(obj,cyclic){obj._sfx.cyclic=Boolean(cyclic)};exports.is_cyclic=is_cyclic;function is_cyclic(obj){return obj._sfx.cyclic}exports.listener_update_transform=function(scene,
trans,quat,elapsed){if(!_wa)return;var front=_vec3_tmp;front[0]=0;front[1]=-1;front[2]=0;m_vec3.transformQuat(front,quat,front);var up=_vec3_tmp2;up[0]=0;up[1]=0;up[2]=-1;m_vec3.transformQuat(up,quat,up);var listener=_wa.listener;listener.setPosition(trans[0],trans[1],trans[2]);listener.setOrientation(front[0],front[1],front[2],up[0],up[1],up[2]);if(elapsed){var speed=_vec3_tmp3;speed[0]=(trans[0]-_listener_last_eye[0])/elapsed;speed[1]=(trans[1]-_listener_last_eye[1])/elapsed;speed[2]=(trans[2]-
_listener_last_eye[2])/elapsed;m_util.smooth_v(speed,_listener_speed_avg,elapsed,SPEED_SMOOTH_PERIOD,speed);if(!_listener_speed_warm)listener.setVelocity(speed[0],speed[1],speed[2]);else _listener_speed_warm--;_listener_speed_avg[0]=speed[0];_listener_speed_avg[1]=speed[1];_listener_speed_avg[2]=speed[2];_listener_last_eye[0]=trans[0];_listener_last_eye[1]=trans[1];_listener_last_eye[2]=trans[2]}};exports.listener_reset_speed=function(){if(!_wa)return;var listener=_wa.listener;listener.setVelocity(0,
0,0);_listener_speed_avg[0]=0;_listener_speed_avg[1]=0;_listener_speed_avg[2]=0};exports.speaker_update_transform=function(obj,elapsed){var sfx=obj._sfx;if(!(spk_is_active(obj)&&sfx.behavior=="POSITIONAL"))return;var pos=obj._render.trans;var panner=sfx.panner_node;panner.setPosition(pos[0],pos[1],pos[2]);var orient=_vec3_tmp;m_util.quat_to_dir(obj._render.quat,m_util.AXIS_MY,orient);panner.setOrientation(orient[0],orient[1],orient[2]);if(!sfx.disable_doppler&&elapsed){var lpos=sfx.last_position;
var speed=_vec3_tmp2;speed[0]=(pos[0]-lpos[0])/elapsed;speed[1]=(pos[1]-lpos[1])/elapsed;speed[2]=(pos[2]-lpos[2])/elapsed;m_util.smooth_v(speed,sfx.speed_avg,elapsed,SPEED_SMOOTH_PERIOD,speed);panner.setVelocity(speed[0],speed[1],speed[2]);sfx.speed_avg[0]=speed[0];sfx.speed_avg[1]=speed[1];sfx.speed_avg[2]=speed[2];lpos[0]=pos[0];lpos[1]=pos[1];lpos[2]=pos[2]}};exports.speaker_reset_speed=function(obj){var sfx=obj._sfx;if(!(spk_is_active(obj)&&sfx.behavior=="POSITIONAL"))return;var panner=sfx.panner_node;
panner.setVelocity(0,0,0);sfx.speed_avg[0]=0;sfx.speed_avg[1]=0;sfx.speed_avg[2]=0;var pos=obj._render.trans;var lpos=sfx.last_position;lpos[0]=pos[0];lpos[1]=pos[1];lpos[2]=pos[2]};exports.is_speaker=is_speaker;function is_speaker(obj){if(obj._sfx)return true;else return false}exports.get_spk_behavior=function(obj){return obj._sfx.behavior};function spk_is_active(obj){if(obj._sfx&&(obj._sfx.state==SPKSTATE_PLAY||(obj._sfx.state==SPKSTATE_PAUSE||obj._sfx.state==SPKSTATE_STOP)))return true;else return false}
function calc_distance_gain(pos,pos_lis,dist_ref,dist_max,atten){var x=pos[0];var y=pos[1];var z=pos[2];var x0=pos_lis[0];var y0=pos_lis[1];var z0=pos_lis[2];var gain;var dist=Math.sqrt(Math.pow(x-x0,2)+Math.pow(y-y0,2)+Math.pow(z-z0,2));if(dist<dist_ref)gain=1;else if(dist>dist_max)gain=0;else var gain=dist_ref/(dist_ref+atten*(dist-dist_ref));return gain}function calc_gain(sfx){var volume=sfx.muted?0:sfx.volume;return volume}exports.set_master_volume=function(volume){var scene_sfx=_active_scene._sfx;
if(scene_sfx){scene_sfx.volume=volume;if(_wa)scene_sfx.gain_node.gain.value=calc_gain(scene_sfx)}};exports.get_master_volume=function(){var scene_sfx=_active_scene._sfx;if(scene_sfx)return scene_sfx.volume;else return 0};exports.set_volume=function(obj,volume){var sfx=obj._sfx;sfx.volume=volume;if(spk_is_active(obj))sfx.gain_node.gain.value=calc_gain(sfx)};exports.get_volume=function(obj){return obj._sfx.volume};exports.mute=function(obj,muted){obj._sfx.muted=Boolean(muted);if(spk_is_active(obj))obj._sfx.gain_node.gain.value=
calc_gain(obj._sfx)};exports.is_muted=function(obj){return obj._sfx.muted};exports.mute_master=function(muted){var scene_sfx=_active_scene._sfx;if(scene_sfx){scene_sfx.muted=Boolean(muted);if(_wa)scene_sfx.gain_node.gain.value=calc_gain(scene_sfx)}};exports.is_master_muted=function(){var scene_sfx=_active_scene._sfx;if(scene_sfx)return scene_sfx.muted;else return false};exports.get_speaker_objects=function(){return _speaker_objects};exports.pause=function(){for(var i=0;i<_speaker_objects.length;i++)speaker_pause(_speaker_objects[i])};
exports.resume=function(){for(var i=0;i<_speaker_objects.length;i++)speaker_resume(_speaker_objects[i])};exports.set_compressor_params=function(scene,params){if(!(scene._sfx&&scene._sfx.compressor_node))return;var compressor=scene._sfx.compressor_node;compressor.threshold.value=params["threshold"];compressor.knee.value=params["knee"];compressor.ratio.value=params["ratio"];compressor.attack.value=params["attack"];compressor.release.value=params["release"]};exports.get_compressor_params=function(scene){if(!(scene._sfx&&
scene._sfx.compressor_node))return null;var compressor=scene._sfx.compressor_node;var params={"threshold":compressor.threshold.value,"knee":compressor.knee.value,"ratio":compressor.ratio.value,"attack":compressor.attack.value,"release":compressor.release.value};return params};exports.duck=function(obj,value,time){if(!spk_is_active(obj))return;var sfx=obj._sfx;var fade_gnode=sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(value,
current_time+time);sfx.duck_time=time};exports.unduck=function(obj){if(!spk_is_active(obj))return;var sfx=obj._sfx;var fade_gnode=sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(1,current_time+sfx.duck_time);sfx.duck_time=0};exports.duck_master=function(value,time){if(!_wa)return;var scene_sfx=_active_scene._sfx;var fade_gnode=scene_sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,
current_time);fade_gnode.gain.linearRampToValueAtTime(value,current_time+time);scene_sfx.duck_time=time};exports.unduck_master=function(){if(!_wa)return;var scene_sfx=_active_scene._sfx;var fade_gnode=scene_sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(1,current_time+scene_sfx.duck_time);scene_sfx.duck_time=0};exports.apply_playlist=function(objs,delay,random){_playlist={active:-1,active_start_time:0,
random:random,speakers:[],durations:[]};for(var i=0;i<objs.length;i++){var obj=objs[i];var sfx=obj._sfx;stop(obj);_playlist.speakers.push(obj);var duration=spk_duration(obj);_playlist.durations.push(duration+delay)}};function spk_duration(obj){var sfx=obj._sfx;if(sfx.behavior=="POSITIONAL"||sfx.behavior=="BACKGROUND_SOUND"){var source=sfx.source_node;if(source&&source.buffer)return source.buffer.duration;else return 0}else{var audio=sfx.src;if(audio)return audio.duration;else return 0}}exports.clear_playlist=
function(){if(_playlist){var spks=_playlist.speakers;for(var i=0;i<spks.length;i++)stop(spks[i])}_playlist=null};exports.get_positional_params=function(obj){var sfx=obj._sfx;if(!sfx||sfx.behavior!="POSITIONAL")return null;var pos_params={"dist_ref":sfx.dist_ref,"dist_max":sfx.dist_max,"attenuation":sfx.attenuation};return pos_params};exports.set_positional_params=function(obj,params){var sfx=obj._sfx;if(!sfx||sfx.behavior!="POSITIONAL")return;sfx.dist_ref=params["dist_ref"];sfx.dist_max=params["dist_max"];
sfx.attenuation=params["attenuation"];var ap=sfx.panner_node;if(ap){ap.refDistance=sfx.dist_ref;ap.maxDistance=sfx.dist_max;ap.rolloffFactor=sfx.attenuation}};exports.set_filter_params=function(obj,params){var sfx=obj._sfx;if(!sfx||!sfx.filter_node)return;sfx.filter_node.frequency.value=params["freq"];sfx.filter_node.Q.value=params["Q"];sfx.filter_node.gain.value=params["gain"]};exports.get_filter_params=function(obj){var sfx=obj._sfx;if(!sfx||!sfx.filter_node)return null;var params={"freq":sfx.filter_node.frequency.value,
"Q":sfx.filter_node.Q.value,"gain":sfx.filter_node.gain.value};return params};exports.get_filter_freq_response=function(obj,freq_arr,mag_arr,phase_arr){var sfx=obj._sfx;if(!sfx||!sfx.filter_node)return null;sfx.filter_node.getFrequencyResponse(freq_arr,mag_arr,phase_arr)}};b4w.module["vec3"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var vec3=exports;vec3.create=function(){var out=new GLMAT_ARRAY_TYPE(3);out[0]=0;out[1]=0;out[2]=0;return out};vec3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(3);out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.fromValues=function(x,y,z){var out=new GLMAT_ARRAY_TYPE(3);out[0]=x;out[1]=y;out[2]=z;return out};vec3.copy=function(a,
out){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.set=function(x,y,z,out){out[0]=x;out[1]=y;out[2]=z;return out};vec3.add=function(a,b,out){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out};vec3.subtract=function(a,b,out){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out};vec3.sub=vec3.subtract;vec3.multiply=function(a,b,out){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out};vec3.mul=vec3.multiply;vec3.divide=function(a,b,out){out[0]=a[0]/b[0];out[1]=
a[1]/b[1];out[2]=a[2]/b[2];return out};vec3.div=vec3.divide;vec3.min=function(a,b,out){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);return out};vec3.max=function(a,b,out){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);return out};vec3.scale=function(a,b,out){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;return out};vec3.scaleAndAdd=function(a,b,scale,out){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;return out};
vec3.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.dist=vec3.distance;vec3.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return x*x+y*y+z*z};vec3.sqrDist=vec3.squaredDistance;vec3.length=function(a){var x=a[0],y=a[1],z=a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.len=vec3.length;vec3.squaredLength=function(a){var x=a[0],y=a[1],z=a[2];return x*x+y*y+z*z};vec3.sqrLen=vec3.squaredLength;vec3.negate=function(a,out){out[0]=-a[0];
out[1]=-a[1];out[2]=-a[2];return out};vec3.inverse=function(a,out){out[0]=1/a[0];out[1]=1/a[1];out[2]=1/a[2];return out};vec3.normalize=function(a,out){var x=a[0],y=a[1],z=a[2];var len=x*x+y*y+z*z;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len}return out};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.cross=function(a,b,out){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out};vec3.lerp=
function(a,b,t,out){var ax=a[0],ay=a[1],az=a[2];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);return out};vec3.random=function(scale,out){scale=scale||1;var r=GLMAT_RANDOM()*2*Math.PI;var z=GLMAT_RANDOM()*2-1;var zScale=Math.sqrt(1-z*z)*scale;out[0]=Math.cos(r)*zScale;out[1]=Math.sin(r)*zScale;out[2]=z*scale;return out};vec3.transformMat4=function(a,m,out){var x=a[0],y=a[1],z=a[2];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12];out[1]=m[1]*x+m[5]*y+m[9]*z+m[13];out[2]=m[2]*x+m[6]*y+m[10]*z+
m[14];return out};vec3.transformMat3=function(a,m,out){var x=a[0],y=a[1],z=a[2];out[0]=x*m[0]+y*m[3]+z*m[6];out[1]=x*m[1]+y*m[4]+z*m[7];out[2]=x*m[2]+y*m[5]+z*m[8];return out};vec3.transformQuat=function(a,q,out){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec3.rotateX=function(a,b,c,out){var p=[],r=
[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0];r[1]=p[1]*Math.cos(c)-p[2]*Math.sin(c);r[2]=p[1]*Math.sin(c)+p[2]*Math.cos(c);out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.rotateY=function(a,b,c,out){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[2]*Math.sin(c)+p[0]*Math.cos(c);r[1]=p[1];r[2]=p[2]*Math.cos(c)-p[0]*Math.sin(c);out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.rotateZ=function(a,b,c,out){var p=[],r=[];p[0]=a[0]-b[0];
p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0]*Math.cos(c)-p[1]*Math.sin(c);r[1]=p[0]*Math.sin(c)+p[1]*Math.cos(c);r[2]=p[2];out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.forEach=function(){var vec=vec3.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride)stride=3;if(!offset)offset=0;if(count)l=Math.min(count*stride+offset,a.length);else l=a.length;for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];fn(vec,arg,vec);a[i]=vec[0];a[i+1]=vec[1];a[i+
2]=vec[2]}return a}}();vec3.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};if(typeof exports!=="undefined")exports.vec3=vec3};
b4w.module["vec4"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var vec4=exports;vec4.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=0;return out};vec4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.fromValues=function(x,y,z,w){var out=new GLMAT_ARRAY_TYPE(4);out[0]=x;out[1]=y;out[2]=z;out[3]=
w;return out};vec4.copy=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.set=function(x,y,z,w,out){out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.add=function(a,b,out){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out};vec4.subtract=function(a,b,out){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out};vec4.sub=vec4.subtract;vec4.multiply=function(a,b,out){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];
out[3]=a[3]*b[3];return out};vec4.mul=vec4.multiply;vec4.divide=function(a,b,out){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];out[3]=a[3]/b[3];return out};vec4.div=vec4.divide;vec4.min=function(a,b,out){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);out[3]=Math.min(a[3],b[3]);return out};vec4.max=function(a,b,out){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);out[3]=Math.max(a[3],b[3]);return out};vec4.scale=function(a,b,
out){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out};vec4.scaleAndAdd=function(a,b,scale,out){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;return out};vec4.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.dist=vec4.distance;vec4.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return x*x+y*y+z*z+w*w};vec4.sqrDist=vec4.squaredDistance;
vec4.length=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.len=vec4.length;vec4.squaredLength=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return x*x+y*y+z*z+w*w};vec4.sqrLen=vec4.squaredLength;vec4.negate=function(a,out){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=-a[3];return out};vec4.inverse=function(a,out){out[0]=1/a[0];out[1]=1/a[1];out[2]=1/a[2];out[3]=1/a[3];return out};vec4.normalize=function(a,out){var x=a[0],y=a[1],z=a[2],w=a[3];var len=x*x+y*y+z*z+
w*w;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len;out[3]=a[3]*len}return out};vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};vec4.lerp=function(a,b,t,out){var ax=a[0],ay=a[1],az=a[2],aw=a[3];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);out[3]=aw+t*(b[3]-aw);return out};vec4.random=function(scale,out){scale=scale||1;out[0]=GLMAT_RANDOM();out[1]=GLMAT_RANDOM();out[2]=GLMAT_RANDOM();out[3]=GLMAT_RANDOM();vec4.normalize(out,
out);vec4.scale(out,scale,out);return out};vec4.transformMat4=function(a,m,out){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out};vec4.transformQuat=function(a,q,out){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*
-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec4.forEach=function(){var vec=vec4.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride)stride=4;if(!offset)offset=0;if(count)l=Math.min(count*stride+offset,a.length);else l=a.length;for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];vec[3]=a[i+3];fn(vec,arg,vec);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2];a[i+3]=vec[3]}return a}}();vec4.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!==
"undefined")exports.vec4=vec4};
b4w.module["quat"]=function(exports,require){var vec3=require("vec3");var vec4=require("vec4");var mat3=require("mat3");var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var quat=exports;quat.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.rotationTo=function(){var tmpvec3=vec3.create();var xUnitVec3=vec3.fromValues(1,0,0);var yUnitVec3=vec3.fromValues(0,1,0);return function(a,
b,out){var dot=vec3.dot(a,b);if(dot<-0.9999999){vec3.cross(xUnitVec3,a,tmpvec3);if(vec3.length(tmpvec3)<1E-6)vec3.cross(yUnitVec3,a,tmpvec3);vec3.normalize(tmpvec3,tmpvec3);quat.setAxisAngle(tmpvec3,Math.PI,out);return out}else if(dot>0.9999999){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out}else{vec3.cross(a,b,tmpvec3);out[0]=tmpvec3[0];out[1]=tmpvec3[1];out[2]=tmpvec3[2];out[3]=1+dot;return quat.normalize(out,out)}}}();quat.setAxes=function(){var matr=mat3.create();return function(view,right,up,
out){matr[0]=right[0];matr[3]=right[1];matr[6]=right[2];matr[1]=up[0];matr[4]=up[1];matr[7]=up[2];matr[2]=-view[0];matr[5]=-view[1];matr[8]=-view[2];return quat.normalize(quat.fromMat3(matr,out),out)}}();quat.clone=vec4.clone;quat.fromValues=vec4.fromValues;quat.copy=vec4.copy;quat.set=vec4.set;quat.identity=function(out){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.setAxisAngle=function(axis,rad,out){rad=rad*0.5;var s=Math.sin(rad);out[0]=s*axis[0];out[1]=s*axis[1];out[2]=s*axis[2];out[3]=
Math.cos(rad);return out};quat.add=vec4.add;quat.multiply=function(a,b,out){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];out[0]=ax*bw+aw*bx+ay*bz-az*by;out[1]=ay*bw+aw*by+az*bx-ax*bz;out[2]=az*bw+aw*bz+ax*by-ay*bx;out[3]=aw*bw-ax*bx-ay*by-az*bz;return out};quat.mul=quat.multiply;quat.scale=vec4.scale;quat.rotateX=function(a,rad,out){rad*=0.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+aw*bx;out[1]=ay*bw+az*bx;out[2]=az*bw-ay*bx;out[3]=
aw*bw-ax*bx;return out};quat.rotateY=function(a,rad,out){rad*=0.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],by=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw-az*by;out[1]=ay*bw+aw*by;out[2]=az*bw+ax*by;out[3]=aw*bw-ay*by;return out};quat.rotateZ=function(a,rad,out){rad*=0.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bz=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+ay*bz;out[1]=ay*bw-ax*bz;out[2]=az*bw+aw*bz;out[3]=aw*bw-az*bz;return out};quat.calculateW=function(a,out){var x=a[0],y=a[1],z=a[2];out[0]=x;out[1]=y;out[2]=
z;out[3]=-Math.sqrt(Math.abs(1-x*x-y*y-z*z));return out};quat.dot=vec4.dot;quat.lerp=vec4.lerp;quat.slerp=function(a,b,t,out){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];var omega,cosom,sinom,scale0,scale1;cosom=ax*bx+ay*by+az*bz+aw*bw;if(cosom<0){cosom=-cosom;bx=-bx;by=-by;bz=-bz;bw=-bw}if(1-cosom>1E-6){omega=Math.acos(cosom);sinom=Math.sin(omega);scale0=Math.sin((1-t)*omega)/sinom;scale1=Math.sin(t*omega)/sinom}else{scale0=1-t;scale1=t}out[0]=scale0*ax+scale1*bx;out[1]=scale0*
ay+scale1*by;out[2]=scale0*az+scale1*bz;out[3]=scale0*aw+scale1*bw;return out};quat.invert=function(a,out){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],dot=a0*a0+a1*a1+a2*a2+a3*a3,invDot=dot?1/dot:0;out[0]=-a0*invDot;out[1]=-a1*invDot;out[2]=-a2*invDot;out[3]=a3*invDot;return out};quat.conjugate=function(a,out){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=a[3];return out};quat.length=vec4.length;quat.len=quat.length;quat.squaredLength=vec4.squaredLength;quat.sqrLen=quat.squaredLength;quat.normalize=vec4.normalize;
quat.fromMat3=function(m,out){var fTrace=m[0]+m[4]+m[8];var fRoot;if(fTrace>0){fRoot=Math.sqrt(fTrace+1);out[3]=0.5*fRoot;fRoot=0.5/fRoot;out[0]=(m[5]-m[7])*fRoot;out[1]=(m[6]-m[2])*fRoot;out[2]=(m[1]-m[3])*fRoot}else{var i=0;if(m[4]>m[0])i=1;if(m[8]>m[i*3+i])i=2;var j=(i+1)%3;var k=(i+2)%3;fRoot=Math.sqrt(m[i*3+i]-m[j*3+j]-m[k*3+k]+1);out[i]=0.5*fRoot;fRoot=0.5/fRoot;out[3]=(m[j*3+k]-m[k*3+j])*fRoot;out[j]=(m[j*3+i]+m[i*3+j])*fRoot;out[k]=(m[k*3+i]+m[i*3+k])*fRoot}return out};quat.str=function(a){return"quat("+
a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined")exports.quat=quat};
b4w.module["mat3"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var mat3=exports;mat3.create=function(){var out=new GLMAT_ARRAY_TYPE(9);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromMat4=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[4];out[4]=a[5];out[5]=a[6];out[6]=a[8];out[7]=a[9];out[8]=a[10];return out};mat3.clone=function(a){var out=
new GLMAT_ARRAY_TYPE(9);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.copy=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.transpose=function(a,out){if(out===a){var a01=a[1],a02=a[2],a12=a[5];out[1]=a[3];out[2]=
a[6];out[3]=a01;out[5]=a[7];out[6]=a02;out[7]=a12}else{out[0]=a[0];out[1]=a[3];out[2]=a[6];out[3]=a[1];out[4]=a[4];out[5]=a[7];out[6]=a[2];out[7]=a[5];out[8]=a[8]}return out};mat3.invert=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;if(!det)return null;det=1/det;out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=
(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out};mat3.adjoint=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];out[0]=a11*a22-a12*a21;out[1]=a02*a21-a01*a22;out[2]=a01*a12-a02*a11;out[3]=a12*a20-a10*a22;out[4]=a00*a22-a02*a20;out[5]=a02*a10-a00*a12;out[6]=a10*a21-a11*a20;out[7]=a01*a20-a00*a21;out[8]=a00*a11-a01*a10;return out};mat3.determinant=function(a){var a00=
a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)};mat3.multiply=function(a,b,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*
a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out};mat3.mul=mat3.multiply;mat3.translate=function(a,v,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],x=v[0],y=v[1];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a10;out[4]=a11;out[5]=a12;out[6]=x*a00+y*a10+a20;out[7]=x*a01+y*a11+a21;out[8]=x*a02+y*a12+a22;return out};mat3.rotate=function(a,rad,out){var a00=a[0],a01=a[1],a02=a[2],
a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],s=Math.sin(rad),c=Math.cos(rad);out[0]=c*a00+s*a10;out[1]=c*a01+s*a11;out[2]=c*a02+s*a12;out[3]=c*a10-s*a00;out[4]=c*a11-s*a01;out[5]=c*a12-s*a02;out[6]=a20;out[7]=a21;out[8]=a22;return out};mat3.scale=function(a,v,out){var x=v[0],y=v[1];out[0]=x*a[0];out[1]=x*a[1];out[2]=x*a[2];out[3]=y*a[3];out[4]=y*a[4];out[5]=y*a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.fromMat2d=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=0;out[3]=a[2];out[4]=
a[3];out[5]=0;out[6]=a[4];out[7]=a[5];out[8]=1;return out};mat3.fromQuat=function(q,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[3]=yx-wz;out[6]=zx+wy;out[1]=yx+wz;out[4]=1-xx-zz;out[7]=zy-wx;out[2]=zx-wy;out[5]=zy+wx;out[8]=1-xx-yy;return out};mat3.normalFromMat4=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=
a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det)return null;det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a12*b08-a10*b11-a13*b07)*det;out[2]=(a10*b10-a11*b08+a13*b06)*det;out[3]=(a02*b10-a01*b11-a03*b09)*
det;out[4]=(a00*b11-a02*b08+a03*b07)*det;out[5]=(a01*b08-a00*b10-a03*b06)*det;out[6]=(a31*b05-a32*b04+a33*b03)*det;out[7]=(a32*b02-a30*b05-a33*b01)*det;out[8]=(a30*b04-a31*b02+a33*b00)*det;return out};mat3.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};mat3.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+
Math.pow(a[8],2))};if(typeof exports!=="undefined")exports.mat3=mat3};
b4w.module["mat4"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var mat4=exports;mat4.create=function(){var out=new GLMAT_ARRAY_TYPE(16);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(16);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=
a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.copy=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=
0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.transpose=function(a,out){if(out===a){var a01=a[1],a02=a[2],a03=a[3],a12=a[6],a13=a[7],a23=a[11];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a01;out[6]=a[9];out[7]=a[13];out[8]=a02;out[9]=a12;out[11]=a[14];out[12]=a03;out[13]=a13;out[14]=a23}else{out[0]=a[0];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a[1];out[5]=a[5];out[6]=a[9];out[7]=a[13];out[8]=a[2];out[9]=a[6];out[10]=a[10];out[11]=a[14];
out[12]=a[3];out[13]=a[7];out[14]=a[11];out[15]=a[15]}return out};mat4.invert=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*
b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det)return null;det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*
b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out};mat4.adjoint=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];out[0]=a11*(a22*a33-a23*a32)-a21*(a12*a33-a13*a32)+a31*(a12*a23-a13*a22);out[1]=-(a01*(a22*a33-a23*a32)-a21*(a02*a33-a03*a32)+a31*(a02*a23-a03*a22));
out[2]=a01*(a12*a33-a13*a32)-a11*(a02*a33-a03*a32)+a31*(a02*a13-a03*a12);out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12));out[4]=-(a10*(a22*a33-a23*a32)-a20*(a12*a33-a13*a32)+a30*(a12*a23-a13*a22));out[5]=a00*(a22*a33-a23*a32)-a20*(a02*a33-a03*a32)+a30*(a02*a23-a03*a22);out[6]=-(a00*(a12*a33-a13*a32)-a10*(a02*a33-a03*a32)+a30*(a02*a13-a03*a12));out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12);out[8]=a10*(a21*a33-a23*a31)-a20*(a11*a33-a13*a31)+a30*
(a11*a23-a13*a21);out[9]=-(a00*(a21*a33-a23*a31)-a20*(a01*a33-a03*a31)+a30*(a01*a23-a03*a21));out[10]=a00*(a11*a33-a13*a31)-a10*(a01*a33-a03*a31)+a30*(a01*a13-a03*a11);out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11));out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21));out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21);out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11));out[15]=a00*(a11*a22-a12*a21)-
a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11);return out};mat4.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32;return b00*b11-b01*b10+
b02*b09+b03*b08-b04*b07+b05*b06};mat4.multiply=function(a,b,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=
b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out};mat4.mul=mat4.multiply;mat4.translate=function(a,v,out){var x=v[0],y=v[1],
z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*
x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15]}return out};mat4.scale=function(a,v,out){var x=v[0],y=v[1],z=v[2];out[0]=a[0]*x;out[1]=a[1]*x;out[2]=a[2]*x;out[3]=a[3]*x;out[4]=a[4]*y;out[5]=a[5]*y;out[6]=a[6]*y;out[7]=a[7]*y;out[8]=a[8]*z;out[9]=a[9]*z;out[10]=a[10]*z;out[11]=a[11]*z;out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.rotate=function(a,rad,axis,out){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t,a00,a01,
a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b00,b01,b02,b10,b11,b12,b20,b21,b22;if(Math.abs(len)<GLMAT_EPSILON)return null;len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b22=z*z*t+c;out[0]=a00*b00+a10*b01+a20*b02;out[1]=a01*b00+a11*b01+a21*b02;out[2]=a02*b00+a12*b01+
a22*b02;out[3]=a03*b00+a13*b01+a23*b02;out[4]=a00*b10+a10*b11+a20*b12;out[5]=a01*b10+a11*b11+a21*b12;out[6]=a02*b10+a12*b11+a22*b12;out[7]=a03*b10+a13*b11+a23*b12;out[8]=a00*b20+a10*b21+a20*b22;out[9]=a01*b20+a11*b21+a21*b22;out[10]=a02*b20+a12*b21+a22*b22;out[11]=a03*b20+a13*b21+a23*b22;if(a!==out){out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}return out};mat4.rotateX=function(a,rad,out){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],
a23=a[11];if(a!==out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[4]=a10*c+a20*s;out[5]=a11*c+a21*s;out[6]=a12*c+a22*s;out[7]=a13*c+a23*s;out[8]=a20*c-a10*s;out[9]=a21*c-a11*s;out[10]=a22*c-a12*s;out[11]=a23*c-a13*s;return out};mat4.rotateY=function(a,rad,out){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[12]=
a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c-a20*s;out[1]=a01*c-a21*s;out[2]=a02*c-a22*s;out[3]=a03*c-a23*s;out[8]=a00*s+a20*c;out[9]=a01*s+a21*c;out[10]=a02*s+a22*c;out[11]=a03*s+a23*c;return out};mat4.rotateZ=function(a,rad,out){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];if(a!==out){out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c+a10*s;out[1]=
a01*c+a11*s;out[2]=a02*c+a12*s;out[3]=a03*c+a13*s;out[4]=a10*c-a00*s;out[5]=a11*c-a01*s;out[6]=a12*c-a02*s;out[7]=a13*c-a03*s;return out};mat4.fromRotationTranslation=function(q,v,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=
v[2];out[15]=1;return out};mat4.fromQuat=function(q,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[1]=yx+wz;out[2]=zx-wy;out[3]=0;out[4]=yx-wz;out[5]=1-xx-zz;out[6]=zy+wx;out[7]=0;out[8]=zx+wy;out[9]=zy-wx;out[10]=1-xx-yy;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.frustum=function(left,right,bottom,top,near,far,out){var rl=1/(right-left),tb=1/(top-bottom),nf=1/(near-far);out[0]=
near*2*rl;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=near*2*tb;out[6]=0;out[7]=0;out[8]=(right+left)*rl;out[9]=(top+bottom)*tb;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near*2*nf;out[15]=0;return out};mat4.perspective=function(fovy,aspect,near,far,out){var f=1/Math.tan(fovy/2),nf=1/(near-far);out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=2*far*near*nf;out[15]=0;return out};
mat4.ortho=function(left,right,bottom,top,near,far,out){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=2*nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=(far+near)*nf;out[15]=1;return out};mat4.lookAt=function(eye,center,up,out){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],
centerz=center[2];if(Math.abs(eyex-centerx)<GLMAT_EPSILON&&(Math.abs(eyey-centery)<GLMAT_EPSILON&&Math.abs(eyez-centerz)<GLMAT_EPSILON))return mat4.identity(out);z0=eyex-centerx;z1=eyey-centery;z2=eyez-centerz;len=1/Math.sqrt(z0*z0+z1*z1+z2*z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.sqrt(x0*x0+x1*x1+x2*x2);if(!len){x0=0;x1=0;x2=0}else{len=1/len;x0*=len;x1*=len;x2*=len}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.sqrt(y0*y0+y1*y1+y2*y2);if(!len){y0=
0;y1=0;y2=0}else{len=1/len;y0*=len;y1*=len;y2*=len}out[0]=x0;out[1]=y0;out[2]=z0;out[3]=0;out[4]=x1;out[5]=y1;out[6]=z1;out[7]=0;out[8]=x2;out[9]=y2;out[10]=z2;out[11]=0;out[12]=-(x0*eyex+x1*eyey+x2*eyez);out[13]=-(y0*eyex+y1*eyey+y2*eyez);out[14]=-(z0*eyex+z1*eyey+z2*eyez);out[15]=1;return out};mat4.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};mat4.frob=
function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2)+Math.pow(a[9],2)+Math.pow(a[10],2)+Math.pow(a[11],2)+Math.pow(a[12],2)+Math.pow(a[13],2)+Math.pow(a[14],2)+Math.pow(a[15],2))};if(typeof exports!=="undefined")exports.mat4=mat4};b4w.module["__gpp_eval"]=function(exports,require){exports.parser=function(){function peg$subclass(child,parent){function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor}function SyntaxError(message,expected,found,offset,line,column){this.message=message;this.expected=expected;this.found=found;this.offset=offset;this.line=line;this.column=column;this.name="SyntaxError"}peg$subclass(SyntaxError,Error);function parse(input){var options=arguments.length>1?arguments[1]:
{},peg$FAILED={},peg$startRuleFunctions={start:peg$parsestart},peg$startRuleFunction=peg$parsestart,peg$c0=peg$FAILED,peg$c1=null,peg$c2=function(expression){return expression},peg$c3=[],peg$c4=",",peg$c5={type:"literal",value:",",description:'","'},peg$c6=function(head,tail){if(tail.length==0)return head;else return tail[tail.length-1]},peg$c7="?",peg$c8={type:"literal",value:"?",description:'"?"'},peg$c9=":",peg$c10={type:"literal",value:":",description:'":"'},peg$c11=function(condition,trueExpression,
falseExpression){if(condition)return trueExpression;else return falseExpression},peg$c12=function(head,tail){var result=head;for(var i=0;i<tail.length;i++)result=result||tail[i][3];return result},peg$c13=function(head,tail){var result=head;for(var i=0;i<tail.length;i++)result=result&&tail[i][3];return result},peg$c14=function(head,tail){var result=head;for(var i=0;i<tail.length;i++)result|=tail[i][3];return result},peg$c15=function(head,tail){var result=head;for(var i=0;i<tail.length;i++)result^=
tail[i][3];return result},peg$c16=function(head,tail){var result=head;for(var i=0;i<tail.length;i++)result&=tail[i][3];return result},peg$c17=function(head,tail){var result=head;for(var i=0;i<tail.length;i++)switch(tail[i][1]){case "==":result=result==tail[i][3];break;case "!=":result=result!=tail[i][3];break}return result},peg$c18=function(head,tail){var result=head;for(var i=0;i<tail.length;i++)switch(tail[i][1]){case "<=":result=result<=tail[i][3];break;case ">=":result=result>=tail[i][3];break;
case "<":result=result<tail[i][3];break;case ">":result=result>tail[i][3];break}return result},peg$c19=function(head,tail){var result=head;for(var i=0;i<tail.length;i++)switch(tail[i][1]){case "<<":result=result<<tail[i][3];break;case ">>":result=result>>tail[i][3];break}return result},peg$c20=function(head,tail){var result=head;for(var i=0;i<tail.length;i++)switch(tail[i][1]){case "+":result+=tail[i][3];break;case "-":result-=tail[i][3];break}return result},peg$c21=function(head,tail){var result=
head;for(var i=0;i<tail.length;i++)switch(tail[i][1]){case "*":result*=tail[i][3];break;case "/":result=Math.floor(result/tail[i][3]);break;case "%":result%=tail[i][3];break}return result},peg$c22="defined",peg$c23={type:"literal",value:"defined",description:'"defined"'},peg$c24=function(expression){return expression},peg$c25=function(operator,expression){switch(operator){case "++":return++expression;case "--":return--expression;case "+":return+expression;case "-":return-expression;case "~":return~expression;
case "!":return!expression}},peg$c26=function(expression,operator){switch(operator){case "++":return++expression;case "--":return--expression}},peg$c27=function(){return 0},peg$c28="(",peg$c29={type:"literal",value:"(",description:'"("'},peg$c30=")",peg$c31={type:"literal",value:")",description:'")"'},peg$c32=void 0,peg$c33=function(){return 1},peg$c34={type:"other",description:"number"},peg$c35=function(literal){return literal},peg$c36=function(parts){return parseInt(parts)},peg$c37="0",peg$c38=
{type:"literal",value:"0",description:'"0"'},peg$c39=/^[0-9]/,peg$c40={type:"class",value:"[0-9]",description:"[0-9]"},peg$c41=/^[1-9]/,peg$c42={type:"class",value:"[1-9]",description:"[1-9]"},peg$c43=/^[eE]/,peg$c44={type:"class",value:"[eE]",description:"[eE]"},peg$c45=/^[\-+]/,peg$c46={type:"class",value:"[\\-+]",description:"[\\-+]"},peg$c47=/^[xX]/,peg$c48={type:"class",value:"[xX]",description:"[xX]"},peg$c49=function(digits){return parseInt("0x"+digits)},peg$c50=/^[0-9a-fA-F]/,peg$c51={type:"class",
value:"[0-9a-fA-F]",description:"[0-9a-fA-F]"},peg$c52={type:"other",description:"identifier"},peg$c53=function(name){return name},peg$c54=function(start,parts){return start+parts.join("")},peg$c55="$",peg$c56={type:"literal",value:"$",description:'"$"'},peg$c57="_",peg$c58={type:"literal",value:"_",description:'"_"'},peg$c59=/^[a-zA-Z]/,peg$c60={type:"class",value:"[a-zA-Z]",description:"[a-zA-Z]"},peg$c61="++",peg$c62={type:"literal",value:"++",description:'"++"'},peg$c63="--",peg$c64={type:"literal",
value:"--",description:'"--"'},peg$c65="+",peg$c66={type:"literal",value:"+",description:'"+"'},peg$c67="-",peg$c68={type:"literal",value:"-",description:'"-"'},peg$c69="~",peg$c70={type:"literal",value:"~",description:'"~"'},peg$c71="!",peg$c72={type:"literal",value:"!",description:'"!"'},peg$c73="*",peg$c74={type:"literal",value:"*",description:'"*"'},peg$c75="/",peg$c76={type:"literal",value:"/",description:'"/"'},peg$c77="%",peg$c78={type:"literal",value:"%",description:'"%"'},peg$c79="=",peg$c80=
{type:"literal",value:"=",description:'"="'},peg$c81=function(operator){return operator},peg$c82=function(){return"+"},peg$c83=function(){return"-"},peg$c84="<<",peg$c85={type:"literal",value:"<<",description:'"<<"'},peg$c86=">>",peg$c87={type:"literal",value:">>",description:'">>"'},peg$c88="<=",peg$c89={type:"literal",value:"<=",description:'"<="'},peg$c90=">=",peg$c91={type:"literal",value:">=",description:'">="'},peg$c92="<",peg$c93={type:"literal",value:"<",description:'"<"'},peg$c94=">",peg$c95=
{type:"literal",value:">",description:'">"'},peg$c96="==",peg$c97={type:"literal",value:"==",description:'"=="'},peg$c98="!=",peg$c99={type:"literal",value:"!=",description:'"!="'},peg$c100="&",peg$c101={type:"literal",value:"&",description:'"&"'},peg$c102=function(){return"&"},peg$c103="^",peg$c104={type:"literal",value:"^",description:'"^"'},peg$c105=function(){return"^"},peg$c106="|",peg$c107={type:"literal",value:"|",description:'"|"'},peg$c108=function(){return"|"},peg$c109="&&",peg$c110={type:"literal",
value:"&&",description:'"&&"'},peg$c111=function(){return"&&"},peg$c112="||",peg$c113={type:"literal",value:"||",description:'"||"'},peg$c114=function(){return"||"},peg$c115={type:"other",description:"whitespace"},peg$c116=/^[\t\x0B\f ]/,peg$c117={type:"class",value:"[\\t\\x0B\\f ]",description:"[\\t\\x0B\\f ]"},peg$c118={type:"other",description:"end of line"},peg$c119="\n",peg$c120={type:"literal",value:"\n",description:'"\\n"'},peg$c121="\r\n",peg$c122={type:"literal",value:"\r\n",description:'"\\r\\n"'},
peg$c123="\r",peg$c124={type:"literal",value:"\r",description:'"\\r"'},peg$c125={type:"any",description:"any character"},peg$currPos=0,peg$reportedPos=0,peg$cachedPos=0,peg$cachedPosDetails={line:1,column:1,seenCR:false},peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0,peg$result;if("startRule"in options){if(!(options.startRule in peg$startRuleFunctions))throw new Error("Can't start parsing from rule \""+options.startRule+'".');peg$startRuleFunction=peg$startRuleFunctions[options.startRule]}function text(){return input.substring(peg$reportedPos,
peg$currPos)}function offset(){return peg$reportedPos}function line(){return peg$computePosDetails(peg$reportedPos).line}function column(){return peg$computePosDetails(peg$reportedPos).column}function expected(description){throw peg$buildException(null,[{type:"other",description:description}],peg$reportedPos);}function error(message){throw peg$buildException(message,null,peg$reportedPos);}function peg$computePosDetails(pos){function advance(details,startPos,endPos){var p,ch;for(p=startPos;p<endPos;p++){ch=
input.charAt(p);if(ch==="\n"){if(!details.seenCR)details.line++;details.column=1;details.seenCR=false}else if(ch==="\r"||(ch==="\u2028"||ch==="\u2029")){details.line++;details.column=1;details.seenCR=true}else{details.column++;details.seenCR=false}}}if(peg$cachedPos!==pos){if(peg$cachedPos>pos){peg$cachedPos=0;peg$cachedPosDetails={line:1,column:1,seenCR:false}}advance(peg$cachedPosDetails,peg$cachedPos,pos);peg$cachedPos=pos}return peg$cachedPosDetails}function peg$fail(expected){if(peg$currPos<
peg$maxFailPos)return;if(peg$currPos>peg$maxFailPos){peg$maxFailPos=peg$currPos;peg$maxFailExpected=[]}peg$maxFailExpected.push(expected)}function peg$buildException(message,expected,pos){function cleanupExpected(expected){var i=1;expected.sort(function(a,b){if(a.description<b.description)return-1;else if(a.description>b.description)return 1;else return 0});while(i<expected.length)if(expected[i-1]===expected[i])expected.splice(i,1);else i++}function buildMessage(expected,found){function stringEscape(s){function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase()}
return s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(ch){return"\\x"+hex(ch)}).replace(/[\u0180-\u0FFF]/g,function(ch){return"\\u0"+hex(ch)}).replace(/[\u1080-\uFFFF]/g,function(ch){return"\\u"+hex(ch)})}var expectedDescs=new Array(expected.length),expectedDesc,foundDesc,i;for(i=0;i<
expected.length;i++)expectedDescs[i]=expected[i].description;expectedDesc=expected.length>1?expectedDescs.slice(0,-1).join(", ")+" or "+expectedDescs[expected.length-1]:expectedDescs[0];foundDesc=found?'"'+stringEscape(found)+'"':"end of input";return"Expected "+expectedDesc+" but "+foundDesc+" found."}var posDetails=peg$computePosDetails(pos),found=pos<input.length?input.charAt(pos):null;if(expected!==null)cleanupExpected(expected);return new SyntaxError(message!==null?message:buildMessage(expected,
found),expected,found,pos,posDetails.line,posDetails.column)}function peg$parsestart(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$parse_();if(s1!==peg$FAILED){s2=peg$parsePPExpression();if(s2!==peg$FAILED){s3=peg$parse_();if(s3!==peg$FAILED){s4=peg$parseLineTerminatorSequence();if(s4===peg$FAILED)s4=peg$c1;if(s4!==peg$FAILED){peg$reportedPos=s0;s1=peg$c2(s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parsePPExpression(){var s0,
s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseConditionalExpression();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===44){s5=peg$c4;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c5)}if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseConditionalExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=
s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===44){s5=peg$c4;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c5)}if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseConditionalExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=
s0;s1=peg$c6(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseConditionalExpression(){var s0,s1,s2,s3,s4,s5,s6,s7,s8,s9;s0=peg$currPos;s1=peg$parseLogicalORExpression();if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===63){s3=peg$c7;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c8)}if(s3!==peg$FAILED){s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parsePPExpression();if(s5!==peg$FAILED){s6=
peg$parse_();if(s6!==peg$FAILED){if(input.charCodeAt(peg$currPos)===58){s7=peg$c9;peg$currPos++}else{s7=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c10)}if(s7!==peg$FAILED){s8=peg$parse_();if(s8!==peg$FAILED){s9=peg$parsePPExpression();if(s9!==peg$FAILED){peg$reportedPos=s0;s1=peg$c11(s1,s5,s9);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=
s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}if(s0===peg$FAILED)s0=peg$parseLogicalORExpression();return s0}function peg$parseLogicalORExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseLogicalANDExpression();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseLogicalOROperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseLogicalANDExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=
s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseLogicalOROperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseLogicalANDExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=
s0;s1=peg$c12(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseLogicalANDExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseBitwiseORExpression();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseLogicalANDOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseBitwiseORExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=
s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseLogicalANDOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseBitwiseORExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c13(s1,
s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseBitwiseORExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseBitwiseXORExpression();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseBitwiseOROperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseBitwiseXORExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=
s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseBitwiseOROperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseBitwiseXORExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c14(s1,s2);s0=s1}else{peg$currPos=s0;
s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseBitwiseXORExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseBitwiseANDExpression();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseBitwiseXOROperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseBitwiseANDExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=
s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseBitwiseXOROperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseBitwiseANDExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c15(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=
s0;s0=peg$c0}return s0}function peg$parseBitwiseANDExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseEqualityExpression();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseBitwiseANDOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseEqualityExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}while(s3!==
peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseBitwiseANDOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseEqualityExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c16(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseEqualityExpression(){var s0,
s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseRelationalExpression();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseEqualityOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseRelationalExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();
if(s4!==peg$FAILED){s5=peg$parseEqualityOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseRelationalExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c17(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseRelationalExpression(){var s0,s1,s2,s3,s4,
s5,s6,s7;s0=peg$currPos;s1=peg$parseShiftExpression();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseRelationalOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseShiftExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=
peg$parseRelationalOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseShiftExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c18(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseShiftExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseAdditiveExpression();
if(s1!==peg$FAILED){s2=[];s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseShiftOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseAdditiveExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseShiftOperator();if(s5!==peg$FAILED){s6=peg$parse_();
if(s6!==peg$FAILED){s7=peg$parseAdditiveExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c19(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseAdditiveExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseMultiplicativeExpression();if(s1!==peg$FAILED){s2=[];
s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseAdditiveOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseMultiplicativeExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseAdditiveOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==
peg$FAILED){s7=peg$parseMultiplicativeExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c20(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseMultiplicativeExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;s1=peg$parseUnaryExpression();if(s1!==peg$FAILED){s2=[];s3=peg$currPos;
s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseMultiplicativeOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=peg$parseUnaryExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}while(s3!==peg$FAILED){s2.push(s3);s3=peg$currPos;s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseMultiplicativeOperator();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){s7=
peg$parseUnaryExpression();if(s7!==peg$FAILED){s4=[s4,s5,s6,s7];s3=s4}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}else{peg$currPos=s3;s3=peg$c0}}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c21(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseUnaryExpression(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,7)===peg$c22){s1=peg$c22;peg$currPos+=7}else{s1=peg$FAILED;if(peg$silentFails===
0)peg$fail(peg$c23)}if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parseDefinedExpression();if(s3!==peg$FAILED){peg$reportedPos=s0;s1=peg$c24(s3);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}if(s0===peg$FAILED){s0=peg$parsePostfixExpression();if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseUnaryOperator();if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parseUnaryExpression();if(s3!==peg$FAILED){peg$reportedPos=s0;s1=
peg$c25(s1,s3);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}}return s0}function peg$parsePostfixExpression(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parsePrimaryExpression();if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parsePostfixOperator();if(s3!==peg$FAILED){peg$reportedPos=s0;s1=peg$c26(s1,s3);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}if(s0===peg$FAILED)s0=peg$parsePrimaryExpression();
return s0}function peg$parsePrimaryExpression(){var s0,s1,s2,s3,s4,s5;s0=peg$parseNumericLiteral();if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseIdentifier();if(s1!==peg$FAILED){peg$reportedPos=s0;s1=peg$c27()}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===40){s1=peg$c28;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c29)}if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parsePPExpression();if(s3!==peg$FAILED){s4=peg$parse_();if(s4!==
peg$FAILED){if(input.charCodeAt(peg$currPos)===41){s5=peg$c30;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c31)}if(s5!==peg$FAILED){peg$reportedPos=s0;s1=peg$c2(s3);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}}return s0}function peg$parseDefinedExpression(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;s1=peg$parseIdentifier();if(s1!==peg$FAILED){peg$reportedPos=s0;s1=
peg$c27()}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=[];s2=peg$currPos;s3=peg$currPos;peg$silentFails++;if(input.charCodeAt(peg$currPos)===40){s4=peg$c28;peg$currPos++}else{s4=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c29)}if(s4===peg$FAILED)if(input.charCodeAt(peg$currPos)===41){s4=peg$c30;peg$currPos++}else{s4=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c31)}peg$silentFails--;if(s4===peg$FAILED)s3=peg$c32;else{peg$currPos=s3;s3=peg$c0}if(s3!==peg$FAILED){s4=peg$parseSourceCharacter();if(s4!==
peg$FAILED){s3=[s3,s4];s2=s3}else{peg$currPos=s2;s2=peg$c0}}else{peg$currPos=s2;s2=peg$c0}if(s2!==peg$FAILED)while(s2!==peg$FAILED){s1.push(s2);s2=peg$currPos;s3=peg$currPos;peg$silentFails++;if(input.charCodeAt(peg$currPos)===40){s4=peg$c28;peg$currPos++}else{s4=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c29)}if(s4===peg$FAILED)if(input.charCodeAt(peg$currPos)===41){s4=peg$c30;peg$currPos++}else{s4=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c31)}peg$silentFails--;if(s4===peg$FAILED)s3=peg$c32;
else{peg$currPos=s3;s3=peg$c0}if(s3!==peg$FAILED){s4=peg$parseSourceCharacter();if(s4!==peg$FAILED){s3=[s3,s4];s2=s3}else{peg$currPos=s2;s2=peg$c0}}else{peg$currPos=s2;s2=peg$c0}}else s1=peg$c0;if(s1!==peg$FAILED){peg$reportedPos=s0;s1=peg$c33()}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===40){s1=peg$c28;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c29)}if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parseDefinedExpression();if(s3!==
peg$FAILED){s4=peg$parse_();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===41){s5=peg$c30;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c31)}if(s5!==peg$FAILED){peg$reportedPos=s0;s1=peg$c2(s3);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}}return s0}function peg$parseNumericLiteral(){var s0,s1;peg$silentFails++;s0=peg$currPos;s1=peg$parseHexIntegerLiteral();
if(s1===peg$FAILED)s1=peg$parseIntegerLiteral();if(s1!==peg$FAILED){peg$reportedPos=s0;s1=peg$c35(s1)}s0=s1;peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c34)}return s0}function peg$parseIntegerLiteral(){var s0,s1,s2;s0=peg$currPos;s1=peg$currPos;s2=peg$parseDecimalIntegerLiteral();if(s2!==peg$FAILED)s2=input.substring(s1,peg$currPos);s1=s2;if(s1!==peg$FAILED){peg$reportedPos=s0;s1=peg$c36(s1)}s0=s1;return s0}function peg$parseDecimalIntegerLiteral(){var s0,
s1,s2;if(input.charCodeAt(peg$currPos)===48){s0=peg$c37;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c38)}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseNonZeroDigit();if(s1!==peg$FAILED){s2=peg$parseDecimalDigits();if(s2===peg$FAILED)s2=peg$c1;if(s2!==peg$FAILED){s1=[s1,s2];s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}return s0}function peg$parseDecimalDigits(){var s0,s1;s0=[];s1=peg$parseDecimalDigit();if(s1!==peg$FAILED)while(s1!==peg$FAILED){s0.push(s1);
s1=peg$parseDecimalDigit()}else s0=peg$c0;return s0}function peg$parseDecimalDigit(){var s0;if(peg$c39.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c40)}return s0}function peg$parseNonZeroDigit(){var s0;if(peg$c41.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c42)}return s0}function peg$parseExponentIndicator(){var s0;if(peg$c43.test(input.charAt(peg$currPos))){s0=
input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c44)}return s0}function peg$parseSignedInteger(){var s0,s1,s2;s0=peg$currPos;if(peg$c45.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c46)}if(s1===peg$FAILED)s1=peg$c1;if(s1!==peg$FAILED){s2=peg$parseDecimalDigits();if(s2!==peg$FAILED){s1=[s1,s2];s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}
function peg$parseHexIntegerLiteral(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===48){s1=peg$c37;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c38)}if(s1!==peg$FAILED){if(peg$c47.test(input.charAt(peg$currPos))){s2=input.charAt(peg$currPos);peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c48)}if(s2!==peg$FAILED){s3=peg$currPos;s4=[];s5=peg$parseHexDigit();if(s5!==peg$FAILED)while(s5!==peg$FAILED){s4.push(s5);s5=peg$parseHexDigit()}else s4=
peg$c0;if(s4!==peg$FAILED)s4=input.substring(s3,peg$currPos);s3=s4;if(s3!==peg$FAILED){peg$reportedPos=s0;s1=peg$c49(s3);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseHexDigit(){var s0;if(peg$c50.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c51)}return s0}function peg$parseIdentifier(){var s0,s1,s2;peg$silentFails++;s0=peg$currPos;s1=
peg$currPos;peg$silentFails++;s2=peg$parseReservedWord();peg$silentFails--;if(s2===peg$FAILED)s1=peg$c32;else{peg$currPos=s1;s1=peg$c0}if(s1!==peg$FAILED){s2=peg$parseIdentifierName();if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c53(s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c52)}return s0}function peg$parseReservedWord(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,7)===
peg$c22){s1=peg$c22;peg$currPos+=7}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c23)}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;s3=peg$parseIdentifierPart();peg$silentFails--;if(s3===peg$FAILED)s2=peg$c32;else{peg$currPos=s2;s2=peg$c0}if(s2!==peg$FAILED){s1=[s1,s2];s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseIdentifierName(){var s0,s1,s2,s3;peg$silentFails++;s0=peg$currPos;s1=peg$parseIdentifierStart();if(s1!==peg$FAILED){s2=[];
s3=peg$parseIdentifierPart();while(s3!==peg$FAILED){s2.push(s3);s3=peg$parseIdentifierPart()}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c54(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c52)}return s0}function peg$parseIdentifierStart(){var s0;s0=peg$parseLetter();if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===36){s0=peg$c55;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===
0)peg$fail(peg$c56)}if(s0===peg$FAILED)if(input.charCodeAt(peg$currPos)===95){s0=peg$c57;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c58)}}return s0}function peg$parseIdentifierPart(){var s0;s0=peg$parseIdentifierStart();if(s0===peg$FAILED)s0=peg$parseDecimalDigit();return s0}function peg$parseLetter(){var s0;if(peg$c59.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c60)}return s0}function peg$parsePostfixOperator(){var s0;
if(input.substr(peg$currPos,2)===peg$c61){s0=peg$c61;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c62)}if(s0===peg$FAILED)if(input.substr(peg$currPos,2)===peg$c63){s0=peg$c63;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c64)}return s0}function peg$parseUnaryOperator(){var s0;if(input.substr(peg$currPos,2)===peg$c61){s0=peg$c61;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c62)}if(s0===peg$FAILED){if(input.substr(peg$currPos,
2)===peg$c63){s0=peg$c63;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c64)}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===43){s0=peg$c65;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c66)}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===45){s0=peg$c67;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c68)}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===126){s0=peg$c69;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===
0)peg$fail(peg$c70)}if(s0===peg$FAILED)if(input.charCodeAt(peg$currPos)===33){s0=peg$c71;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c72)}}}}}return s0}function peg$parseMultiplicativeOperator(){var s0,s1,s2,s3;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===42){s1=peg$c73;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c74)}if(s1===peg$FAILED){if(input.charCodeAt(peg$currPos)===47){s1=peg$c75;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c76)}if(s1===
peg$FAILED)if(input.charCodeAt(peg$currPos)===37){s1=peg$c77;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c78)}}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;if(input.charCodeAt(peg$currPos)===61){s3=peg$c79;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c80)}peg$silentFails--;if(s3===peg$FAILED)s2=peg$c32;else{peg$currPos=s2;s2=peg$c0}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c81(s1);s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;
s0=peg$c0}return s0}function peg$parseAdditiveOperator(){var s0,s1,s2,s3;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===43){s1=peg$c65;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c66)}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;if(input.charCodeAt(peg$currPos)===43){s3=peg$c65;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c66)}if(s3===peg$FAILED)if(input.charCodeAt(peg$currPos)===61){s3=peg$c79;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===
0)peg$fail(peg$c80)}peg$silentFails--;if(s3===peg$FAILED)s2=peg$c32;else{peg$currPos=s2;s2=peg$c0}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c82();s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===45){s1=peg$c67;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c68)}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;if(input.charCodeAt(peg$currPos)===45){s3=peg$c67;peg$currPos++}else{s3=
peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c68)}if(s3===peg$FAILED)if(input.charCodeAt(peg$currPos)===61){s3=peg$c79;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c80)}peg$silentFails--;if(s3===peg$FAILED)s2=peg$c32;else{peg$currPos=s2;s2=peg$c0}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c83();s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}}return s0}function peg$parseShiftOperator(){var s0;if(input.substr(peg$currPos,2)===peg$c84){s0=peg$c84;peg$currPos+=
2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c85)}if(s0===peg$FAILED)if(input.substr(peg$currPos,2)===peg$c86){s0=peg$c86;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c87)}return s0}function peg$parseRelationalOperator(){var s0;if(input.substr(peg$currPos,2)===peg$c88){s0=peg$c88;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c89)}if(s0===peg$FAILED){if(input.substr(peg$currPos,2)===peg$c90){s0=peg$c90;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===
0)peg$fail(peg$c91)}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===60){s0=peg$c92;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c93)}if(s0===peg$FAILED)if(input.charCodeAt(peg$currPos)===62){s0=peg$c94;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c95)}}}return s0}function peg$parseEqualityOperator(){var s0;if(input.substr(peg$currPos,2)===peg$c96){s0=peg$c96;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c97)}if(s0===peg$FAILED)if(input.substr(peg$currPos,
2)===peg$c98){s0=peg$c98;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c99)}return s0}function peg$parseBitwiseANDOperator(){var s0,s1,s2,s3;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===38){s1=peg$c100;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c101)}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;if(input.charCodeAt(peg$currPos)===38){s3=peg$c100;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c101)}peg$silentFails--;
if(s3===peg$FAILED)s2=peg$c32;else{peg$currPos=s2;s2=peg$c0}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c102();s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseBitwiseXOROperator(){var s0,s1,s2,s3;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===94){s1=peg$c103;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c104)}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;if(input.charCodeAt(peg$currPos)===94){s3=peg$c103;peg$currPos++}else{s3=
peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c104)}peg$silentFails--;if(s3===peg$FAILED)s2=peg$c32;else{peg$currPos=s2;s2=peg$c0}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c105();s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseBitwiseOROperator(){var s0,s1,s2,s3;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===124){s1=peg$c106;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c107)}if(s1!==peg$FAILED){s2=peg$currPos;peg$silentFails++;
if(input.charCodeAt(peg$currPos)===124){s3=peg$c106;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c107)}peg$silentFails--;if(s3===peg$FAILED)s2=peg$c32;else{peg$currPos=s2;s2=peg$c0}if(s2!==peg$FAILED){peg$reportedPos=s0;s1=peg$c108();s0=s1}else{peg$currPos=s0;s0=peg$c0}}else{peg$currPos=s0;s0=peg$c0}return s0}function peg$parseLogicalANDOperator(){var s0,s1;s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c109){s1=peg$c109;peg$currPos+=2}else{s1=peg$FAILED;if(peg$silentFails===
0)peg$fail(peg$c110)}if(s1!==peg$FAILED){peg$reportedPos=s0;s1=peg$c111()}s0=s1;return s0}function peg$parseLogicalOROperator(){var s0,s1;s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c112){s1=peg$c112;peg$currPos+=2}else{s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c113)}if(s1!==peg$FAILED){peg$reportedPos=s0;s1=peg$c114()}s0=s1;return s0}function peg$parse_(){var s0,s1;s0=[];s1=peg$parseWhiteSpace();while(s1!==peg$FAILED){s0.push(s1);s1=peg$parseWhiteSpace()}return s0}function peg$parseWhiteSpace(){var s0,
s1;peg$silentFails++;if(peg$c116.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c117)}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c115)}return s0}function peg$parseLineTerminatorSequence(){var s0,s1;peg$silentFails++;if(input.charCodeAt(peg$currPos)===10){s0=peg$c119;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c120)}if(s0===peg$FAILED){if(input.substr(peg$currPos,
2)===peg$c121){s0=peg$c121;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c122)}if(s0===peg$FAILED)if(input.charCodeAt(peg$currPos)===13){s0=peg$c123;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c124)}}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0)peg$fail(peg$c118)}return s0}function peg$parseSourceCharacter(){var s0;if(input.length>peg$currPos){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===
0)peg$fail(peg$c125)}return s0}peg$result=peg$startRuleFunction();if(peg$result!==peg$FAILED&&peg$currPos===input.length)return peg$result;else{if(peg$result!==peg$FAILED&&peg$currPos<input.length)peg$fail({type:"end",description:"end of input"});throw peg$buildException(null,peg$maxFailExpected,peg$maxFailPos);}}return{SyntaxError:SyntaxError,parse:parse}}()};b4w.module["__md5"]=function(exports,require){function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=ff(a,b,c,d,k[4],7,-176418897);d=ff(d,a,b,c,k[5],12,1200080426);c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);a=ff(a,b,c,d,k[8],7,1770035416);d=ff(d,a,b,c,k[9],12,-1958414417);c=ff(c,d,a,b,k[10],17,-42063);b=ff(b,c,d,a,k[11],22,-1990404162);a=ff(a,
b,c,d,k[12],7,1804603682);d=ff(d,a,b,c,k[13],12,-40341101);c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);a=gg(a,b,c,d,k[1],5,-165796510);d=gg(d,a,b,c,k[6],9,-1069501632);c=gg(c,d,a,b,k[11],14,643717713);b=gg(b,c,d,a,k[0],20,-373897302);a=gg(a,b,c,d,k[5],5,-701558691);d=gg(d,a,b,c,k[10],9,38016083);c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);a=gg(a,b,c,d,k[9],5,568446438);d=gg(d,a,b,c,k[14],9,-1019803690);c=gg(c,d,a,b,k[3],14,-187363961);b=gg(b,c,d,a,k[8],
20,1163531501);a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);c=gg(c,d,a,b,k[7],14,1735328473);b=gg(b,c,d,a,k[12],20,-1926607734);a=hh(a,b,c,d,k[5],4,-378558);d=hh(d,a,b,c,k[8],11,-2022574463);c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);a=hh(a,b,c,d,k[1],4,-1530992060);d=hh(d,a,b,c,k[4],11,1272893353);c=hh(c,d,a,b,k[7],16,-155497632);b=hh(b,c,d,a,k[10],23,-1094730640);a=hh(a,b,c,d,k[13],4,681279174);d=hh(d,a,b,c,k[0],11,-358537222);c=hh(c,d,a,b,k[3],16,-722521979);
b=hh(b,c,d,a,k[6],23,76029189);a=hh(a,b,c,d,k[9],4,-640364487);d=hh(d,a,b,c,k[12],11,-421815835);c=hh(c,d,a,b,k[15],16,530742520);b=hh(b,c,d,a,k[2],23,-995338651);a=ii(a,b,c,d,k[0],6,-198630844);d=ii(d,a,b,c,k[7],10,1126891415);c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);a=ii(a,b,c,d,k[12],6,1700485571);d=ii(d,a,b,c,k[3],10,-1894986606);c=ii(c,d,a,b,k[10],15,-1051523);b=ii(b,c,d,a,k[1],21,-2054922799);a=ii(a,b,c,d,k[8],6,1873313359);d=ii(d,a,b,c,k[15],10,-30611744);c=ii(c,d,
a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);a=ii(a,b,c,d,k[4],6,-145523070);d=ii(d,a,b,c,k[11],10,-1120210379);c=ii(c,d,a,b,k[2],15,718787259);b=ii(b,c,d,a,k[9],21,-343485551);x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^
c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;for(i=64;i<=s.length;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i++)tail[i]=0}tail[14]=n*8;md5cycle(state,tail);return state}function md5blk(s){var md5blks=
[],i;for(i=0;i<64;i+=4)md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks}var hex_chr="0123456789abcdef".split("");function rhex(n){var s="",j=0;for(;j<4;j++)s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function add32(a,b){return a+b&4294967295}exports.hexdigest=function(msg){return hex(md51(msg))}};b4w.module["animation"]=function(exports,require){var m_anim=require("__animation");var m_cons=require("__constraints");var m_phy=require("__physics");var m_util=require("__util");exports["AB_CYCLIC"]=m_anim.AB_CYCLIC;exports["AB_FINISH_RESET"]=m_anim.AB_FINISH_RESET;exports["AB_FINISH_STOP"]=m_anim.AB_FINISH_STOP;var _vec4_tmp=new Float32Array(4);exports["is_animated"]=function(obj){return m_anim.is_animated(obj)};exports["get_actions"]=function(){var anames=[];var actions=m_anim.get_all_actions();
for(var i=0;i<actions.length;i++)anames.push(actions[i]["name"]);return anames};exports["get_current_action"]=function(obj){return m_anim.get_current_action(obj)};exports["get_anim_names"]=function(obj){if(!m_anim.is_animatable(obj))return[];return m_anim.get_anim_names(obj)};exports["get_current_anim_name"]=function(obj){if(!m_anim.is_animated(obj))return null;switch(m_anim.get_anim_type(obj)){case m_anim.OBJ_ANIM_TYPE_ARMATURE:case m_anim.OBJ_ANIM_TYPE_SKELETAL:case m_anim.OBJ_ANIM_TYPE_OBJECT:case m_anim.OBJ_ANIM_TYPE_SOUND:return m_anim.get_current_action(obj);
case m_anim.OBJ_ANIM_TYPE_VERTEX:return m_anim.get_current_va_name(obj);case m_anim.OBJ_ANIM_TYPE_STATIC:default:return null}};exports["apply"]=function(obj,name){m_anim.apply(obj,name)};exports["remove"]=function(obj){m_anim.remove(obj)};exports["apply_def"]=function(obj){m_anim.apply_def(obj)};exports["play"]=function(obj,finish_callback,offset){m_anim.play(obj,finish_callback,offset);m_anim.update_object_animation(obj)};exports["stop"]=function(obj){m_anim.stop(obj)};exports["is_play"]=function(obj){return m_anim.is_play(obj)};
exports["set_current_frame_float"]=function(obj,cff){m_anim.set_current_frame_float(obj,cff)};exports["get_current_frame_float"]=function(obj){return m_anim.get_current_frame_float(obj)};exports["set_frame"]=function(obj,frame){m_anim.set_current_frame_float(obj,frame);m_anim.update_object_animation(obj,0)};exports["get_frame"]=function(obj){return m_anim.get_current_frame_float(obj)};exports["get_frame_range"]=function(obj){if(obj._anim)return[obj._anim.start,obj._anim.start+obj._anim.length];else return null};
exports["get_anim_start_frame"]=function(obj){if(obj._anim)return obj._anim.start;else return-1};exports["get_anim_length"]=function(obj){if(obj._anim)return obj._anim.length;else return-1};exports["cyclic"]=function(obj,cyclic_flag){m_anim.cyclic(obj,cyclic_flag)};exports["is_cyclic"]=function(obj){return m_anim.is_cyclic(obj)};exports["set_behavior"]=function(obj,behavior){m_anim.set_behavior(obj,behavior)};exports["get_behavior"]=function(obj){return m_anim.get_behavior(obj)};exports["apply_smoothing"]=
function(obj,trans_period,quat_period){m_anim.apply_smoothing(obj,trans_period,quat_period)};exports["update_object_animation"]=function(obj,elapsed){m_anim.update_object_animation(obj,elapsed)};exports["frame_to_sec"]=function(frame){return m_anim.frame_to_sec(frame)};exports["detect_collisions"]=function(obj,use){if(use)m_phy.enable_simulation(obj);else m_phy.disable_simulation(obj)};exports["is_detect_collisions_used"]=function(obj){return m_phy.has_simulated_physics(obj)};exports["get_bone_translation"]=
function(armobj,bone_name,dest){if(!m_util.is_armature(armobj))return null;if(!dest)var dest=new Float32Array(3);var trans_scale=_vec4_tmp;m_cons.get_bone_pose(armobj,bone_name,false,trans_scale,null);dest[0]=trans_scale[0];dest[1]=trans_scale[1];dest[2]=trans_scale[2];return dest};exports["get_first_armature_object"]=function(obj){if(m_util.is_mesh(obj))return m_anim.get_first_armature_object(obj);else return null};exports["update_object_transform"]=function(obj){throw"Deprecated method execution";
};exports["set_translation"]=function(obj,x,y,z){throw"Deprecated method execution";};exports["set_translation_v"]=function(obj,trans){throw"Deprecated method execution";};exports["set_translation_rel"]=function(obj,x,y,z,obj_parent){throw"Deprecated method execution";};exports["get_translation"]=function(obj,dest){throw"Deprecated method execution";};exports["set_rotation_quat"]=function(obj,x,y,z,w){throw"Deprecated method execution";};exports["set_rotation_quat_v"]=function(obj,quat){throw"Deprecated method execution";
};exports["get_rotation_quat"]=function(obj,dest){throw"Deprecated method execution";};exports["set_rotation_euler"]=function(obj,x,y,z){throw"Deprecated method execution";};exports["set_rotation_euler_v"]=function(obj,euler){throw"Deprecated method execution";};exports["set_scale"]=function(obj,scale){throw"Deprecated method execution";};exports["empty_reset_transform"]=function(obj){throw"Deprecated method execution";}};b4w.module["assets"]=function(exports,require){var m_assets=require("__assets");exports["AT_ARRAYBUFFER"]=m_assets.AT_ARRAYBUFFER;exports["AT_JSON"]=m_assets.AT_JSON;exports["AT_TEXT"]=m_assets.AT_TEXT;exports["AT_AUDIOBUFFER"]=m_assets.AT_AUDIOBUFFER;exports["AT_IMAGE_ELEMENT"]=m_assets.AT_IMAGE_ELEMENT;exports["AT_AUDIO_ELEMENT"]=m_assets.AT_AUDIO_ELEMENT;exports["enqueue"]=function(asset_pack,asset_cb,pack_cb){m_assets.enqueue(asset_pack,asset_cb,pack_cb)}};b4w.module["camera"]=function(exports,require){var camera=require("__camera");var config=require("__config");var m_print=require("__print");var constraints=require("__constraints");var transform=require("__transform");var util=require("__util");var m_vec3=require("vec3");var m_vec4=require("vec4");var m_quat=require("quat");var m_mat4=require("mat4");var cfg_ctl=config.controls;var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _vec4_tmp=new Float32Array(4);
exports["MS_STATIC"]=camera.MS_STATIC;exports["MS_ANIMATION"]=camera.MS_ANIMATION;exports["MS_CONTROLS"]=camera.MS_TARGET_CONTROLS;exports["MS_TARGET_CONTROLS"]=camera.MS_TARGET_CONTROLS;exports["MS_EYE_CONTROLS"]=camera.MS_EYE_CONTROLS;exports["is_camera"]=function(obj){return camera.is_camera(obj)};exports["set_move_style"]=function(){return};exports["get_move_style"]=function(camobj){if(!camera.is_camera(camobj)){m_print.error("Wrong object");return null}return camera.get_move_style(camobj)};exports["change_eye_target_dist"]=
function(){m_print.error("change_eye_target_dist() deprecated")};exports["change_trans_speed"]=function(camobj,factor){var render=camobj._render;var trans_speed=render.trans_speed[0];trans_speed*=1+factor*cfg_ctl.cam_zoom_base_speed;render.trans_speed=[trans_speed,trans_speed,trans_speed]};exports["get_trans_speed"]=function(camobj){if(!camera.is_camera(camobj)){m_print.error("Wrong object");return 0}return camobj._render.trans_speed[0]};exports["set_look_at"]=function(camobj,eye,target,up,elapsed){var render=
camobj._render;camera.eye_target_up_to_trans_quat(eye,target,up,render.trans,render.quat);transform.update_transform(camobj)};exports["get_eye"]=function(camobj){return camobj._render.trans};exports["set_pivot"]=set_pivot;function set_pivot(camobj,coords){if(!camera.is_target_camera(camobj)){m_print.error("set_pivot(): Wrong object or camera move style");return}camera.set_point_constraint(camobj,coords)}exports["get_pivot"]=function(camobj,dest){if(!camera.is_target_camera(camobj)){m_print.error("set_pivot(): Wrong object or camera move style");
return}if(!dest)var dest=new Float32Array(3);var render=camobj._render;m_vec3.copy(render.pivot,dest);return dest};exports["rotate_pivot"]=function(camobj,angle_h_delta,angle_v_delta){if(!camera.is_target_camera(camobj)){m_print.error("rotate_pivot(): wrong object");return}var render=camobj._render;var axis=_vec3_tmp;var rot=_quat4_tmp;axis[0]=0;axis[1]=1;axis[2]=0;m_quat.setAxisAngle(axis,angle_h_delta,rot);util.rotate_point_pivot(render.trans,render.pivot,rot,render.trans);axis[0]=1;axis[1]=0;axis[2]=
0;m_vec3.transformQuat(axis,render.quat,axis);m_quat.setAxisAngle(axis,angle_v_delta,rot);util.rotate_point_pivot(render.trans,render.pivot,rot,render.trans);transform.update_transform(camobj)};exports["apply_vertical_limits"]=function(camobj,down_angle,up_angle){var render=camobj._render;render.vertical_limits={down:down_angle,up:up_angle}};exports["clear_vertical_limits"]=function(camobj){var render=camobj._render;render.vertical_limits=null};exports["set_eye_params"]=function(camobj,h_angle,v_angle){var render=
camobj._render;m_quat.identity(render.quat);camera.rotate_v_local(camobj,Math.PI/2);camera.rotate_h(camobj,h_angle);camera.rotate_v_local(camobj,-v_angle);transform.update_transform(camobj)};exports["is_look_up"]=function(camobj){var quat=camobj._render.quat;var dir=_vec3_tmp;util.quat_to_dir(quat,util.AXIS_MY,dir);if(dir[1]>=0)return true;else return false};exports["rotate"]=function(camobj,angle_h_delta,angle_v_delta){camera.rotate_h(camobj,angle_h_delta);camera.rotate_v_local(camobj,-angle_v_delta);
transform.update_transform(camobj)};exports["get_angles"]=function(camobj,dest){if(!dest)var dest=new Float32Array(2);camera.get_angles(camobj,dest);return dest};exports["set_stereo_distance"]=function(camobj,conv_dist){var cameras=camobj._render.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==camera.TYPE_STEREO_LEFT||cam.type==camera.TYPE_STEREO_RIGHT)camera.set_stereo_params(cam,conv_dist,cam.stereo_eye_dist)}};exports["get_stereo_distance"]=function(camobj,conv_dist){var cameras=
camobj._render.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==camera.TYPE_STEREO_LEFT||cam.type==camera.TYPE_STEREO_RIGHT)return cam.stereo_conv_dist}return 0};exports["is_underwater"]=function(camobj){var render=camobj._render;return render.underwater};exports["translate_view"]=function(camobj,x,y,angle){var cameras=camobj._render.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(!cam.reflection_plane)camera.set_projection(cam,cam.aspect);var vec3_tmp=_vec3_tmp;
vec3_tmp[0]=-x;vec3_tmp[1]=-y;vec3_tmp[2]=0;m_mat4.translate(cam.proj_matrix,vec3_tmp,cam.proj_matrix);m_mat4.rotateZ(cam.proj_matrix,angle,cam.proj_matrix);m_mat4.multiply(cam.proj_matrix,cam.view_matrix,cam.view_proj_matrix);camera.calc_view_proj_inverse(cam);camera.calc_sky_vp_inverse(cam)}};exports["correct_up"]=function(camobj,y_axis){if(!y_axis)y_axis=util.AXIS_Y;constraints.correct_up(camobj,y_axis)};exports["zoom_object"]=function(camobj,obj){if(!camera.is_target_camera(camobj)){m_print.error("zoom_object(): wrong object");
return}var calc_bs_center=false;var center=_vec3_tmp;transform.get_object_center(obj,calc_bs_center,center);set_pivot(camobj,center);transform.update_transform(camobj);var radius=transform.get_object_size(obj);var ang_radius=camera.get_angular_diameter(camobj)/2;var dist_need=radius/Math.sin(ang_radius);var dist_current=transform.obj_point_distance(camobj,center);transform.move_local(camobj,0,dist_need-dist_current,0);transform.update_transform(camobj)};exports["calc_ray"]=function(camobj,xpix,ypix,
dest){if(!dest)var dest=new Float32Array(3);var cam=camobj._render.cameras[0];switch(cam.type){case camera.TYPE_PERSP:case camera.TYPE_PERSP_ASPECT:case camera.TYPE_STEREO_LEFT:case camera.TYPE_STEREO_RIGHT:var top_1m=Math.tan(cam.fov*Math.PI/360);var right_1m=top_1m*cam.aspect;var dir=_vec4_tmp;dir[0]=(2*xpix/cam.width-1)*right_1m;dir[1]=-1;dir[2]=(2*ypix/cam.height-1)*top_1m;dir[3]=0;var wm=camobj._render.world_matrix;m_vec4.transformMat4(dir,wm,dir);dest[0]=dir[0];dest[1]=dir[1];dest[2]=dir[2];
m_vec3.normalize(dest,dest);return dest;default:m_print.error("Non-compatible camera");return dest}}};b4w.module["config"]=function(exports,require){var config=require("__config");exports["P_ULTRA"]=config.P_ULTRA;exports["P_HIGH"]=config.P_HIGH;exports["P_LOW"]=config.P_LOW;exports["set"]=config.set;exports["get"]=config.get;exports["reset"]=config.reset};b4w.module["controls"]=function(exports,require){var m_print=require("__print");var controls=require("__controls");exports["CT_CONTINUOUS"]=controls.CT_CONTINUOUS;exports["CT_TRIGGER"]=controls.CT_TRIGGER;exports["CT_SHOT"]=controls.CT_SHOT;exports["CT_LEVEL"]=controls.CT_LEVEL;exports["KEY_SHIFT"]=16;exports["KEY_SPACE"]=32;exports["KEY_LEFT"]=37;exports["KEY_UP"]=38;exports["KEY_RIGHT"]=39;exports["KEY_DOWN"]=40;exports["KEY_NUM0"]=96;exports["KEY_NUM1"]=97;exports["KEY_NUM2"]=98;exports["KEY_NUM3"]=
99;exports["KEY_NUM4"]=100;exports["KEY_NUM5"]=101;exports["KEY_NUM6"]=102;exports["KEY_NUM7"]=103;exports["KEY_NUM8"]=104;exports["KEY_NUM9"]=105;exports["KEY_A"]=65;exports["KEY_B"]=66;exports["KEY_C"]=67;exports["KEY_D"]=68;exports["KEY_E"]=69;exports["KEY_F"]=70;exports["KEY_G"]=71;exports["KEY_H"]=72;exports["KEY_I"]=73;exports["KEY_J"]=74;exports["KEY_K"]=75;exports["KEY_L"]=76;exports["KEY_M"]=77;exports["KEY_N"]=78;exports["KEY_O"]=79;exports["KEY_P"]=80;exports["KEY_Q"]=81;exports["KEY_R"]=
82;exports["KEY_S"]=83;exports["KEY_T"]=84;exports["KEY_U"]=85;exports["KEY_V"]=86;exports["KEY_W"]=87;exports["KEY_X"]=88;exports["KEY_Y"]=89;exports["KEY_Z"]=90;exports["KEY_1"]=49;exports["KEY_2"]=50;exports["KEY_3"]=51;exports["KEY_4"]=52;exports["KEY_5"]=53;exports["KEY_6"]=54;exports["KEY_7"]=55;exports["KEY_8"]=56;exports["KEY_9"]=57;exports["KEY_DEC_POINT"]=110;exports["KEY_SEMI_COLON"]=186;exports["KEY_EQUAL_SIGN"]=187;exports["KEY_COMMA"]=188;exports["KEY_DASH"]=189;exports["KEY_PERIOD"]=
190;exports["KEY_FORWARD_SLASH"]=191;exports["KEY_GRAVE_ACCENT"]=192;exports["KEY_LEFT_SQ_BRACKET"]=219;exports["KEY_BACK_SLASH"]=220;exports["KEY_RIGHT_SQ_BRACKET"]=221;exports["KEY_SINGLE_QUOTE"]=222;exports["H_ROT"]=0;exports["V_ROT"]=0;exports["H_TRA"]=0;exports["V_TRA"]=0;exports["F_TRA"]=0;exports["JUMP"]=0;exports["X_TRA"]=0;exports["Y_TRA"]=0;exports["Z_TRA"]=0;exports["set"]=function(){m_print.error("set() deprecated, use new sensor-based API")};exports["get"]=function(){m_print.error("get() deprecated, use new sensor-based API");
return null};exports["get_type"]=function(){m_print.error("get_type() deprecated, use new sensor-based API");return null};exports["release"]=function(){m_print.error("release() deprecated, use new sensor-based API")};exports["create_custom_sensor"]=controls.create_custom_sensor;exports["create_keyboard_sensor"]=controls.create_keyboard_sensor;exports["create_collision_sensor"]=controls.create_collision_sensor;exports["create_collision_impulse_sensor"]=controls.create_collision_impulse_sensor;exports["create_ray_sensor"]=
controls.create_ray_sensor;exports["create_mouse_click_sensor"]=controls.create_mouse_click_sensor;exports["create_mouse_wheel_sensor"]=controls.create_mouse_wheel_sensor;exports["create_mouse_move_sensor"]=controls.create_mouse_move_sensor;exports["create_touch_move_sensor"]=controls.create_touch_move_sensor;exports["create_touch_zoom_sensor"]=controls.create_touch_zoom_sensor;exports["create_motion_sensor"]=controls.create_motion_sensor;exports["create_vertical_velocity_sensor"]=controls.create_vertical_velocity_sensor;
exports["create_timer_sensor"]=controls.create_timer_sensor;exports["reset_timer_sensor"]=controls.reset_timer_sensor;exports["create_elapsed_sensor"]=controls.create_elapsed_sensor;exports["create_timeline_sensor"]=controls.create_timeline_sensor;exports["set_custom_sensor"]=function(sensor,value){controls.sensor_set_value(sensor,value)};exports["get_custom_sensor"]=function(sensor,value){return sensor.value};exports["get_sensor_value"]=function(obj,manifold_id,num){var manifolds=obj._sensor_manifolds;
if(!manifolds||!manifolds[manifold_id]){m_print.error("get_sensor_value(): wrong object");return null}var sensor=manifolds[manifold_id].sensors[num];if(!sensor){m_print.error("get_sensor_value(): sensor not found");return null}return sensor.value};exports["get_sensor_payload"]=function(obj,manifold_id,num){var manifolds=obj._sensor_manifolds;if(!manifolds||!manifolds[manifold_id]){m_print.error("get_sensor_payload(): wrong object");return null}var sensor=manifolds[manifold_id].sensors[num];if(!sensor){m_print.error("get_sensor_payload(): sensor not found");
return null}return sensor.payload};exports["sensor_make_positive"]=function(sensor){throw"Deprecated method execution";};exports["sensor_make_negative"]=function(sensor){throw"Deprecated method execution";};exports["create_sensor_lock"]=function(sensor,lock_sensors,lock_logic_fun){sensor.lock_sensors=lock_sensors.slice(0);sensor.lock_sensor_values=new Array(lock_sensors.length);sensor.lock_logic_fun=lock_logic_fun||controls.default_AND_logic_fun};exports["remove_sensor_lock"]=function(sensor){sensor.lock_sensors=
null;sensor.lock_sensor_values=null;sensor.lock_logic_fun=null};exports["create_sensor_manifold"]=controls.create_sensor_manifold;exports["create_kb_sensor_manifold"]=function(obj,id,type,key,callback,callback_param){var kb_sensor=controls.create_keyboard_sensor(key);controls.create_sensor_manifold(obj,id,type,[kb_sensor],null,callback,callback_param)};exports["check_sensor_manifolds"]=function(obj){return controls.check_sensor_manifold(obj,null)};exports["check_sensor_manifold"]=controls.check_sensor_manifold;
exports["remove_sensor_manifolds"]=function(obj){controls.remove_sensor_manifold(obj,null)};exports["remove_sensor_manifold"]=controls.remove_sensor_manifold;exports["reset"]=controls.reset;exports["keydown_cb"]=controls.keydown_cb;exports["keyup_cb"]=controls.keyup_cb;exports["mouse_down_cb"]=controls.mouse_down_cb;exports["mouse_up_cb"]=controls.mouse_up_cb;exports["mouse_wheel_cb"]=controls.mouse_wheel_cb;exports["mouse_move_cb"]=controls.mouse_move_cb;exports["touch_start_cb"]=controls.touch_start_cb;
exports["touch_move_cb"]=controls.touch_move_cb};b4w.module["constraints"]=function(exports,require){var constraints=require("__constraints");var m_phy=require("__physics");var m_trans=require("__transform");exports["append_stiff"]=function(obj,target,offset,rotation_offset){if(target instanceof Array&&target.length==2)constraints.append_stiff_bone(obj,target[0],target[1],offset,rotation_offset);else constraints.append_stiff_obj(obj,target,offset,rotation_offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports["append_semi_stiff"]=
function(obj,target,offset,rotation_offset){constraints.append_semi_stiff_obj(obj,target,offset,rotation_offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports["append_semi_stiff_cam"]=function(obj,target,offset,rotation_offset,clamp_left,clamp_right,clamp_up,clamp_down){constraints.append_semi_stiff_cam_obj(obj,target,offset,rotation_offset,clamp_left,clamp_right,clamp_up,clamp_down);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports["append_semi_soft_cam"]=function(obj,
target,offset){constraints.append_semi_soft_cam_obj(obj,target,offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports["append_stiff_trans"]=function(obj,target,offset){constraints.append_stiff_trans_obj(obj,target,offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports["append_copy_trans"]=function(obj,target,offset){constraints.append_copy_trans_obj(obj,target,offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports["append_stiff_trans_rot"]=function(obj,
target,offset,rotation_offset){constraints.append_stiff_trans_rot_obj(obj,target,offset,rotation_offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports["append_track"]=function(obj,target){if(target.length==3)constraints.append_track_point(obj,target);else constraints.append_track_obj(obj,target);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports["append_follow"]=function(obj,target,offset_min,offset_max){if(target.length==3)constraints.append_follow_point(obj,target,
offset_min,offset_max);else constraints.append_follow_obj(obj,target,offset_min,offset_max);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports["remove"]=function(obj){if(obj._constraint)constraints.remove(obj)}};b4w.module["data"]=function(exports,require){var m_print=require("__print");var data=require("__data");exports["load"]=data.load;exports["load_and_add_new"]=data.load;exports["unload"]=function(){data.unload()};exports["cleanup"]=exports["unload"];exports["get_bpy_world"]=function(world_name){m_print.error("get_bpy_world() deprecated");return null};exports["set_debug_resources_root"]=data.set_debug_resources_root;exports["is_loaded"]=data.is_loaded};b4w.module["debug"]=function(exports,require){var m_batch=require("__batch");var m_print=require("__print");var controls=require("__controls");var debug=require("__debug");var physics=require("__physics");var scenegraph=require("__scenegraph");var m_scenes=require("__scenes");var sfx=require("__sfx");var m_textures=require("__textures");var m_util=require("__util");var m_vec3=require("vec3");exports["physics_worker"]=function(){physics.debug_worker()};exports["physics_id"]=function(id){m_print.log("O",
physics.find_obj_by_body_id(id));var bundles=physics.get_active_scene()._physics.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];var phy=bundle.physics;if(phy.body_id==id)m_print.log("B",bundle)}};exports["visible_objects"]=function(){var scene=m_scenes.get_active();var objs=scene._appended_objects["MESH"];var subs_main=m_scenes.get_subs(scene,"MAIN_OPAQUE");var bundles=subs_main.bundles;for(var i=0;i<objs.length;i++){var obj=objs[i];var render=obj._render;if(render.type!="DYNAMIC")continue;
for(var j=0;j<bundles.length;j++){var bundle=bundles[j];if(bundle.do_render&&bundle.obj_render==render){m_print.log(obj["name"],obj);break}}}};exports["object_info"]=function(name){var scene=m_scenes.get_active();var objs=scene._appended_objects["MESH"];for(var i=0;i<objs.length;i++){var obj=objs[i];if(obj["name"]!=name)continue;m_print.log("Object",obj);var subscenes=m_scenes.get_all_subscenes(scene);for(var j=0;j<subscenes.length;j++){var subs=subscenes[j];var bundles=subs.bundles;var print_bundles=
[];for(var k=0;k<bundles.length;k++)if(bundles[k].obj_render==obj._render)print_bundles.push(bundles[k]);m_print.log("Subscene "+subs.type,print_bundles)}}};exports["objects_stat"]=function(){var scene=m_scenes.get_active();console.log("Armatures: "+m_scenes.get_scene_objs(scene,"ARMATURE").length);console.log("Cameras: "+m_scenes.get_scene_objs(scene,"CAMERA").length);console.log("Curves: "+m_scenes.get_scene_objs(scene,"CURVE").length);console.log("Empties: "+m_scenes.get_scene_objs(scene,"EMPTY").length);
console.log("Lamps: "+m_scenes.get_scene_objs(scene,"LAMP").length);console.log("Meshes: "+m_scenes.get_scene_objs(scene,"MESH").length);console.log("Speakers: "+m_scenes.get_scene_objs(scene,"SPEAKER").length)};exports["num_vertices"]=function(){var num=0;var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND")];for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(!subs)continue;var bundles=subs.bundles;for(var j=
0;j<bundles.length;j++){var batch=bundles[j].batch;if(batch)num+=batch.num_vertices}}return num};exports["num_triangles"]=function(){var num=0;var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND")];for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(!subs)continue;var bundles=subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;if(batch)num+=batch.num_triangles}}return num};exports["num_draw_calls"]=
function(){var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND")];var number=main_subscenes[0].bundles.length+main_subscenes[1].bundles.length;return number};exports["geometry_stats"]=function(){var scene=m_scenes.get_active();var subscenes=m_scenes.get_all_subscenes(scene);var unique_batches={};for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(subs.type=="SINK"||subs.type=="WIREFRAME")continue;var bundles=subs.bundles;
for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;var render=bundles[j].obj_render;if(batch)if(subs.type!="COLOR_PICKING"&&subs.type!="GLOW_MASK"||render.origin_selectable)unique_batches[batch.id]=batch}}var vbo_number=0;var vbo_memory=0;var ibo_number=0;var ibo_memory=0;for(var id in unique_batches){var batch=unique_batches[id];var bufs_data=batch.bufs_data;if(bufs_data.debug_ibo_bytes){ibo_number++;ibo_memory+=bufs_data.debug_ibo_bytes/(1024*1024)}vbo_number++;vbo_memory+=bufs_data.debug_vbo_bytes/
(1024*1024)}return{"vbo_number":vbo_number,"vbo_memory":vbo_memory,"ibo_number":ibo_number,"ibo_memory":ibo_memory}};exports["num_textures"]=function(){var tex_list=[];var memory=0;var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND")];for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(!subs)continue;var bundles=subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;if(batch){var batch_texs=
batch.textures;for(var k=0;k<batch_texs.length;k++){var batch_tex=batch_texs[k];if(batch_tex.source==="IMAGE"||batch_tex.source==="ENVIRONMENT_MAP"){var tex=batch_tex.w_texture;if(tex_list.indexOf(tex)===-1){tex_list.push(tex);var mem=batch_tex.width*batch_tex.height*4/(1024*1024)/batch_tex.compress_ratio;mem*=1.3333;memory+=mem}}}}}}return{"number":tex_list.length,"memory":memory}};exports["num_render_targets"]=function(){var list=[];var memory=0;var scene=m_scenes.get_active();var subscenes=m_scenes.get_all_subscenes(scene);
for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(subs.type=="SINK")continue;var cam=subs.camera;var c_at=cam.color_attachment;var d_at=cam.depth_attachment;var subs_textures=[cam.color_attachment,cam.depth_attachment];subs_textures.push.apply(subs_textures,subs.textures_internal);for(var j=0;j<subs_textures.length;j++){var tex=subs_textures[j];if(m_textures.is_texture(tex)&&list.indexOf(tex)==-1){list.push(tex);memory+=cam.width*cam.height*m_textures.get_texture_channel_size(tex)}}}return{"number":list.length,
"memory":memory/1024/1024}};exports["make_camera_frustum_shot"]=function(){var active_scene=m_scenes.get_active();var subs_main=m_scenes.get_subs(active_scene,"MAIN_OPAQUE");if(!subs_main)return;m_scenes.make_frustum_shot(subs_main.camera,subs_main,[1,1,0])};exports["make_light_frustum_shot"]=function(){var active_scene=m_scenes.get_active();var subs_main=m_scenes.get_subs(active_scene,"MAIN_OPAQUE");var subscenes_shadow=m_scenes.subs_array(active_scene,["SHADOW_CAST"]);if(!subs_main)return;for(var i=
0;i<subscenes_shadow.length;i++){var subs_shadow=subscenes_shadow[i];var color;switch(i){case 0:color=[1,0,0];break;case 1:color=[0,1,0];break;case 2:color=[0,0,1];break;default:color=[1,0,1]}m_scenes.make_frustum_shot(subs_shadow.camera,subs_main,color)}};exports["scenegraph_to_dot"]=function(){var scene=m_scenes.get_active();var graph=m_scenes.get_graph(scene);m_print.log(scenegraph.debug_convert_to_dot(graph))};exports["controls_info"]=controls.debug;exports["object_distance"]=function(obj,obj2){var dist=
m_vec3.dist(obj._render.trans,obj2._render.trans);return dist};exports["msg"]=debug.msg;exports["fbmsg"]=debug.fbmsg;exports["print_telemetry"]=debug.print_telemetry;exports["plot_telemetry"]=debug.plot_telemetry;exports["fbres"]=function(fun,timeout){if(!timeout)timeout=16;var cb=function(){debug.fbmsg("FBRES",fun());setTimeout(cb,timeout)};cb()};exports["check_constants"]=function(){var VEC3_IDENT=new Float32Array(3);var QUAT4_IDENT=new Float32Array([0,0,0,1]);var AXIS_X=new Float32Array([1,0,0]);
var AXIS_Y=new Float32Array([0,1,0]);var AXIS_Z=new Float32Array([0,0,1]);var AXIS_MX=new Float32Array([-1,0,0]);var AXIS_MY=new Float32Array([0,-1,0]);var AXIS_MZ=new Float32Array([0,0,-1]);if(!m_util.cmp_arr(VEC3_IDENT,m_util.VEC3_IDENT))throw"Wrong VEC3_IDENT";if(!m_util.cmp_arr(QUAT4_IDENT,m_util.QUAT4_IDENT))throw"Wrong QUAT4_IDENT";if(!m_util.cmp_arr(AXIS_X,m_util.AXIS_X))throw"Wrong AXIS_X";if(!m_util.cmp_arr(AXIS_Y,m_util.AXIS_Y))throw"Wrong AXIS_Y";if(!m_util.cmp_arr(AXIS_Z,m_util.AXIS_Z))throw"Wrong AXIS_Z";
if(!m_util.cmp_arr(AXIS_MX,m_util.AXIS_MX))throw"Wrong AXIS_MX";if(!m_util.cmp_arr(AXIS_MY,m_util.AXIS_MY))throw"Wrong AXIS_MY";if(!m_util.cmp_arr(AXIS_MZ,m_util.AXIS_MZ))throw"Wrong AXIS_MZ";};exports["mute_music"]=function(){var spks=sfx.get_speaker_objects();for(var i=0;i<spks.length;i++){var spk=spks[i];if(sfx.get_spk_behavior(spk)=="BACKGROUND_MUSIC")sfx.mute(spk,true)}};exports["check_finite"]=function(o){debug.check_finite(o)};exports["set_debug_params"]=function(params){var active_scene=m_scenes.get_active();
var subs_wireframe=m_scenes.get_subs(active_scene,"WIREFRAME");if(subs_wireframe){if("wireframe_mode"in params)m_scenes.set_wireframe_mode(subs_wireframe,params["wireframe_mode"]);if("wireframe_edge_color"in params)m_scenes.set_wireframe_edge_color(subs_wireframe,params["wireframe_edge_color"])}else throw"Wireframe subscene not found.";};exports["get_error_quantity"]=function(){return m_print.get_error_count()};exports["get_warning_quantity"]=function(){return m_print.get_warning_count()};exports["clear_errors_warnings"]=
function(){return m_print.clear_errors_warnings()}};b4w.module["geometry"]=function(exports,require){var m_batch=require("__batch");var m_geom=require("__geometry");var m_print=require("__print");exports["extract_vertex_array"]=function(obj,mat_name,attrib_name){if(!has_dyn_geom(obj)){m_print.error("Wrong object:",obj["name"]);return null}var batch=m_batch.find_batch_material(obj,mat_name,"MAIN")||(m_batch.find_batch_material(obj,mat_name,"NODES")||m_batch.find_batch_material(obj,mat_name,"SHADELESS"));if(batch){var bufs_data=batch.bufs_data;if(bufs_data&&
(bufs_data.pointers&&bufs_data.pointers[attrib_name]))return m_geom.extract_array(bufs_data,attrib_name);else{m_print.error("Attribute not found:"+attrib_name);return null}}else{m_print.error("Wrong material:",mat_name);return null}};function has_dyn_geom(obj){if(obj&&(obj._render&&obj._render.dynamic_geometry))return true;else return false}exports["extract_index_array"]=function(obj,mat_name){if(!has_dyn_geom(obj)){m_print.error("Wrong object:",obj["name"]);return null}var batch=m_batch.find_batch_material(obj,
mat_name,"MAIN")||(m_batch.find_batch_material(obj,mat_name,"NODES")||m_batch.find_batch_material(obj,mat_name,"SHADELESS"));if(batch){var bufs_data=batch.bufs_data;if(bufs_data&&bufs_data.pointers)return bufs_data.ibo_array;else{m_print.error("Buffer data not found");return null}}else{m_print.error("Wrong material:",mat_name);return null}};exports["update_vertex_array"]=function(obj,mat_name,attrib_name,array){var types=["MAIN","NODES","SHADELESS","DEPTH","COLOR_ID"];if(!has_dyn_geom(obj)){m_print.error("Wrong object:",
obj["name"]);return}for(var i=0;i<types.length;i++){var type=types[i];var batch=m_batch.find_batch_material(obj,mat_name,type);if(batch){var bufs_data=batch.bufs_data;if(bufs_data&&(bufs_data.pointers&&bufs_data.pointers[attrib_name])){m_geom.update_bufs_data_array(bufs_data,attrib_name,0,array);if(batch.childs)for(var j=0;j<batch.childs.length;j++){var child_batch=batch.childs[j];var child_bufs_data=child_batch.bufs_data;if(child_bufs_data&&(child_bufs_data.pointers&&child_bufs_data.pointers[attrib_name]))m_geom.update_bufs_data_array(child_bufs_data,
attrib_name,0,array)}}}}}};b4w.module["hud"]=function(exports,require){var m_print=require("__print");var hud=require("__hud");exports["plot_array"]=hud.plot_array;exports["draw_mixer_strip"]=hud.draw_mixer_strip};b4w.module["lights"]=function(exports,require){var m_print=require("__print");var lights=require("__lights");var scenes=require("__scenes");var transform=require("__transform");var util=require("__util");var m_vec3=require("vec3");var _sun_pos=new Float32Array(3);var _date={};var _julian_date=0;var _max_sun_angle=60;exports["get_lamps"]=function(lamps_type){var scene=scenes.get_active();var lamps=scenes.get_scene_objs(scene,"LAMP");if(!lamps_type)return lamps;var rslt=[];for(var i=0;i<lamps.length;i++){var lamp=
lamps[i];if(lamp._light.type===lamps_type)rslt.push(lamp)}return rslt};exports["get_sun_params"]=get_sun_params;function get_sun_params(){var scene=scenes.get_active();var lamps=scenes.get_scene_objs(scene,"LAMP");var sun=null;for(var i=0;i<lamps.length;i++){var lamp=lamps[i];var light=lamp._light;if(light.type=="SUN"){sun=lamp;break}}if(sun){var cur_dir=sun._light.direction;var angle_hor=Math.atan2(cur_dir[2],cur_dir[0])*180/Math.PI+90;if(angle_hor>180)angle_hor-=360;var angle_vert=Math.atan2(cur_dir[1],
Math.sqrt(cur_dir[0]*cur_dir[0]+cur_dir[2]*cur_dir[2]))*180/Math.PI;var sun_params={};sun_params["hor_position"]=angle_hor;sun_params["vert_position"]=angle_vert;return sun_params}else return null}exports["set_sun_params"]=set_sun_params;function set_sun_params(sun_params){var scene=scenes.get_active();var lamps=scenes.get_scene_objs(scene,"LAMP");for(var i=0;i<lamps.length;i++){var lamp=lamps[i];var light=lamp._light;if(light.type=="SUN"){var sun=lamp;break}}if(!sun){m_print.error("There is no sun on the scene");
return null}if("hor_position"in sun_params&&"vert_position"in sun_params){var angle_hor=(180-sun_params["hor_position"])/180*Math.PI;var angle_vert=(90-sun_params["vert_position"])/180*Math.PI;var sun_render=sun._render;transform.set_rotation_euler(sun,[angle_vert,angle_hor,0]);var dir=new Float32Array(3);util.quat_to_dir(sun_render.quat,util.AXIS_Y,dir);var dist_to_center=m_vec3.length(sun_render.trans);m_vec3.copy(dir,_sun_pos);m_vec3.scale(_sun_pos,dist_to_center,_sun_pos);transform.set_translation(sun,
_sun_pos);transform.update_transform(sun);var sun_light=sun._light;if(sun_light.dynamic_intensity){var def_sun_energy=sun["data"]["energy"];var def_env_color=scene["world"]["light_settings"]["environment_energy"];var energy=Math.cos(Math.abs(angle_vert));var sun_energy=Math.max(Math.min(3*energy,1),0)*def_sun_energy;var env_energy=Math.max(energy,0.1)*def_env_color;lights.set_light_energy(sun_light,sun_energy);scenes.set_environment_colors(scene,env_energy,null,null)}scenes.update_lamp_scene(sun,
scene)}}exports["set_day_time"]=set_day_time;function set_day_time(time){var scene=scenes.get_active();var lamps=scenes.get_scene_objs(scene,"LAMP");for(var i=0;i<lamps.length;i++){var lamp=lamps[i];var light=lamp._light;if(light.type=="SUN"){var sun=lamp;break}}if(!sun){m_print.error("There is no sun on the scene");return null}update_sun_position(time)}exports["set_date"]=function(date){_date.y=date.getDate();_date.m=date.getMonth();_date.d=date.getFullYear();if(!_date.y){m_print.error("There is no year 0 in the Julian system!");
return}if(_date.y==1582&&(date.m==10&&(date.d>4&&date.d<15))){m_print.error("The dates 5 through 14 October, 1582, do not exist in the Gregorian system!");return}_julian_date=calendar_to_julian(_date)};exports["set_max_sun_angle"]=function(angle){_max_sun_angle=Math.min(Math.max(angle,0),90)};exports["get_light_params"]=function(light_name){var scene=scenes.get_active();if(!scene){m_print.error("No active scene");return false}var lamps=scenes.get_scene_objs(scene,"LAMP");for(var i=0;i<lamps.length;i++){var lamp=
lamps[i];if(lamp["name"]===light_name){var light=lamp._light;break}}if(!light){m_print.error('B4W Warning: light "'+light_name+'" not found');return false}var rslt={"light_color":light.color,"light_energy":light.energy};return rslt};exports["set_light_params"]=function(light_name,light_params){var scene=scenes.get_active();if(!scene){m_print.error("No active scene");return false}var lamps=scenes.get_scene_objs(scene,"LAMP");for(var i=0;i<lamps.length;i++){var lamp=lamps[i];if(lamp["name"]===light_name){var light=
lamp._light;break}}if(!light){m_print.error('B4W Warning: light "'+light_name+'" not found');return false}if("light_energy"in light_params){lights.set_light_energy(light,light_params["light_energy"]);scenes.update_lamp_scene(lamp,scene)}if("light_color"in light_params){lights.set_light_color(light,light_params["light_color"]);scenes.update_lamp_scene(lamp,scene)}};exports["get_lights_names"]=function(){var scene=scenes.get_active();if(!scene){m_print.error("No active scene");return false}var rslt=
[];var lamps=scenes.get_scene_objs(scene,"LAMP");for(var i=0;i<lamps.length;i++){var lamp=lamps[i];rslt.push(lamp._light.name)}return rslt};function update_sun_position(time){var day=_date.d;var month=_date.m;var year=_date.y;var angle_hor=time<12?time*15:(time-24)*15;var angle_vert=-Math.cos(time/12*Math.PI)*_max_sun_angle;var sun_params={};sun_params["hor_position"]=angle_hor;sun_params["vert_position"]=angle_vert;set_sun_params(sun_params)}function get_sun_coordinates(jul_date,days){var n=jul_date-
2451545;var l=280.46+0.9856474*n;l=l%360;var g=357.528+0.9856003*n;g=g%360;g*=Math.PI/180;var e_longitude=l+1.915*Math.sin(g)+0.02*Math.sin(2*g);var r=1.00014-0.01671*Math.cos(g)-1.4E-4*Math.cos(2*g);var oblique=23.439-4E-7*n;return oblique}function calendar_to_julian(date){var y=date.y;var m=date.m;var d=date.d;var jy,ja,jm;if(m>2){jy=y;jm=m+1}else{jy=y-1;jm=m+13}var intgr=Math.floor(Math.floor(365.25*jy)+Math.floor(30.6001*jm)+d+1720995);var gregcal=15+31*(10+12*1582);if(d+31*(m+12*y)>=gregcal){ja=
Math.floor(0.01*jy);intgr+=2-ja+Math.floor(0.25*ja)}var jd0=intgr*1E5;var jd=Math.floor(jd0);if(jd0-jd>0.5)++jd;return jd/1E5}};b4w.module["material"]=function(exports,require){var m_batch=require("__batch");var m_cfg=require("__config");var m_print=require("__print");var m_shaders=require("__shaders");var m_util=require("__util");var cfg_def=m_cfg.defaults;var BATCH_INHERITED_TEXTURES=["u_colormap0","u_colormap1","u_stencil0","u_specmap","u_normalmap0","u_mirrormap"];exports["max_bones"]=function(){m_print.error("max_bones() deprecated, return default value");return cfg_def.max_bones};exports["set_max_bones"]=function(num){m_print.error("set_max_bones() deprecated")};
exports["set_batch_param"]=function(){m_print.error("set_batch_param() deprecated")};exports["inherit_material"]=function(obj_from,mat_from_name,obj_to,mat_to_name){if(!m_util.is_dynamic_mesh(obj_to)||!m_util.is_dynamic_mesh(obj_from)){m_print.error("Wrong or batched object(s)");return}var types=["MAIN","DEPTH","COLOR_ID"];var batches_found=false;for(var i=0;i<types.length;i++){var type=types[i];var batch_from=m_batch.find_batch_material(obj_from,mat_from_name,type);var batch_to=m_batch.find_batch_material(obj_to,
mat_to_name,type);if(batch_from&&batch_to){batches_found=true;if(type=="MAIN"){batch_to.diffuse_color[0]=batch_from.diffuse_color[0];batch_to.diffuse_color[1]=batch_from.diffuse_color[1];batch_to.diffuse_color[2]=batch_from.diffuse_color[2];batch_to.diffuse_color[3]=batch_from.diffuse_color[3];batch_to.diffuse_intensity=batch_from.diffuse_intensity;batch_to.specular_color[0]=batch_from.specular_color[0];batch_to.specular_color[1]=batch_from.specular_color[1];batch_to.specular_color[2]=batch_from.specular_color[2];
batch_to.specular_params[0]=batch_from.specular_params[0];batch_to.specular_params[1]=batch_from.specular_params[1];batch_to.emit=batch_from.emit;batch_to.ambient=batch_from.ambient;batch_to.ambient=batch_from.ambient;if(!isNaN(batch_to.diffuse_color_factor)&&!isNaN(batch_from.diffuse_color_factor))batch_to.diffuse_color_factor=batch_from.diffuse_color_factor}for(var j=0;j<batch_to.texture_names.length;j++){var to_name=batch_to.texture_names[j];if(BATCH_INHERITED_TEXTURES.indexOf(to_name)!==-1){var from_index=
batch_from.texture_names.indexOf(to_name);if(from_index!==-1){batch_to.textures[j]=batch_from.textures[from_index];if(batch_to.childs)for(var j=0;j<batch_to.childs.length;j++){var child_batch=batch_to.childs[j];var child_index=child_batch.texture_names.indexOf(to_name);if(child_index!==-1)child_batch.textures[child_index]=batch_from.textures[from_index]}}}}}}if(!batches_found)m_print.error("Wrong objects for inheriting material!")};function check_batch_material(obj,mat_name){var batches=obj._batches;
for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.material_names.indexOf(mat_name)>-1)if(batch.type=="MAIN"||batch.type=="SHADELESS")return true}return false}exports["get_materials_names"]=function(obj){var mat_names=new Array;var mesh=obj["data"];var materials=mesh["materials"];for(var i=0;i<materials.length;i++)mat_names.push(materials[i]["name"]);return mat_names};exports["set_diffuse_color"]=function(obj,mat_name,color){if(!check_diffuse_color(obj,mat_name))m_print.error('Property "diffuse_color" is missing!');
var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.diffuse_color[0]=color[0];batch.diffuse_color[1]=color[1];batch.diffuse_color[2]=color[2];batch.diffuse_color[3]=color[3]};exports["get_diffuse_color"]=function(obj,mat_name){if(!check_diffuse_color(obj,mat_name))m_print.error('Property "diffuse_color" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");var color=new Array(4);color[0]=batch.diffuse_color[0];color[1]=batch.diffuse_color[1];color[2]=batch.diffuse_color[2];
color[3]=batch.diffuse_color[3];return color};exports["check_diffuse_color"]=check_diffuse_color;function check_diffuse_color(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&batch.diffuse_color)}exports["set_diffuse_intensity"]=function(obj,mat_name,intensity){if(!check_diffuse_intensity(obj,mat_name))m_print.error('Property "diffuse_intensity" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.diffuse_intensity=intensity};
exports["get_diffuse_intensity"]=function(obj,mat_name){if(!check_diffuse_intensity(obj,mat_name))m_print.error('Property "diffuse_intensity" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return batch.diffuse_intensity};exports["check_diffuse_intensity"]=check_diffuse_intensity;function check_diffuse_intensity(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&batch.diffuse_intensity)}exports["set_specular_color"]=function(obj,
mat_name,color){if(!check_specular_color(obj,mat_name))m_print.error('Property "specular_color" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.specular_color[0]=color[0];batch.specular_color[1]=color[1];batch.specular_color[2]=color[2]};exports["get_specular_color"]=function(obj,mat_name){if(!check_specular_color(obj,mat_name))m_print.error('Property "specular_color" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");var color=new Array(3);color[0]=
batch.specular_color[0];color[1]=batch.specular_color[1];color[2]=batch.specular_color[2];return color};exports["check_specular_color"]=check_specular_color;function check_specular_color(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&batch.specular_color)}exports["set_specular_intensity"]=function(obj,mat_name,intensity){if(!check_specular_intensity(obj,mat_name))m_print.error('Property "specular_intensity" is missing!');var batch=m_batch.find_batch_material(obj,
mat_name,"MAIN");batch.specular_params[0]=intensity};exports["get_specular_intensity"]=function(obj,mat_name){if(!check_specular_intensity(obj,mat_name))m_print.error('Property "specular_intensity" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return batch.specular_params[0]};exports["check_specular_intensity"]=check_specular_intensity;function check_specular_intensity(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&(batch.specular_params&&
batch.specular_params[0]))}exports["set_specular_hardness"]=function(obj,mat_name,hardness){if(!check_specular_hardness(obj,mat_name))m_print.error('Property "specular_hardness" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.specular_params[1]=hardness};exports["get_specular_hardness"]=function(obj,mat_name){if(!check_specular_hardness(obj,mat_name))m_print.error('Property "specular_hardness" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");
return batch.specular_params[1]};exports["check_specular_hardness"]=check_specular_hardness;function check_specular_hardness(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&(batch.specular_params&&batch.specular_params[1]))}exports["set_emit_factor"]=function(obj,mat_name,emit_factor){if(!check_emit_factor(obj,mat_name))m_print.error('Property "emit" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.emit=emit_factor};exports["get_emit_factor"]=
function(obj,mat_name){if(!check_emit_factor(obj,mat_name))m_print.error('Property "emit" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return batch.emit};exports["check_emit_factor"]=check_emit_factor;function check_emit_factor(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&batch.emit)}exports["set_ambient_factor"]=function(obj,mat_name,ambient_factor){if(!check_ambient_factor(obj,mat_name))m_print.error('Property "ambient" is missing!');
var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.ambient=ambient_factor};exports["get_ambient_factor"]=function(obj,mat_name){if(!check_ambient_factor(obj,mat_name))m_print.error('Property "ambient" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return batch.ambient};exports["check_ambient_factor"]=check_ambient_factor;function check_ambient_factor(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&batch.ambient)}
exports["set_diffuse_color_factor"]=function(obj,mat_name,diffuse_color_factor){if(!check_diffuse_color_factor(obj,mat_name))m_print.error('Property "diffuse_color_factor" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.diffuse_color_factor=diffuse_color_factor};exports["get_diffuse_color_factor"]=function(obj,mat_name){if(!check_diffuse_color_factor(obj,mat_name))m_print.error('Property "diffuse_color_factor" is missing!');var batch=m_batch.find_batch_material(obj,
mat_name,"MAIN");return batch.diffuse_color_factor};exports["check_diffuse_color_factor"]=check_diffuse_color_factor;function check_diffuse_color_factor(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&batch.diffuse_color_factor)}exports["get_material_extended_params"]=function(obj,mat_name){if(!obj||!mat_name){m_print.error("B4W Error: missing arguments in get_material_params");return null}if(!check_batch_material(obj,mat_name))return null;var batch=
m_batch.find_batch_material(obj,mat_name,"MAIN");if(!batch)return null;var mat_params={};if(batch.type=="MAIN"){mat_params["reflect_factor"]=batch.reflect_factor;mat_params["fresnel"]=batch.fresnel_params[2];mat_params["fresnel_factor"]=5*(1-batch.fresnel_params[3]);mat_params["parallax_scale"]=batch.parallax_scale;mat_params["parallax_steps"]=m_batch.get_batch_directive(batch,"PARALLAX_STEPS")[1]}return mat_params};exports["get_water_material_params"]=function(obj,water_mat_name){if(!obj||!water_mat_name){m_print.error("B4W Error: missing arguments in get_water_material_params");
return null}if(!check_batch_material(obj,water_mat_name))return null;var batch=m_batch.find_batch_material(obj,water_mat_name,"MAIN");if(!batch||!batch.water)return null;if(!batch){m_print.warn("B4W Warning: material not found");return null}var water_mat_params={};if(batch.type=="MAIN"){if(cfg_def.shore_distance){var shlwc=water_mat_params["shallow_water_col"]=new Array(3);shlwc[0]=batch.shallow_water_col[0];shlwc[1]=batch.shallow_water_col[1];shlwc[2]=batch.shallow_water_col[2];var shrwc=water_mat_params["shore_water_col"]=
new Array(3);shrwc[0]=batch.shore_water_col[0];shrwc[1]=batch.shore_water_col[1];shrwc[2]=batch.shore_water_col[2];water_mat_params["shallow_water_col_fac"]=batch.shallow_water_col_fac;water_mat_params["shore_water_col_fac"]=batch.shore_water_col_fac}water_mat_params["foam_factor"]=batch.foam_factor;water_mat_params["absorb_factor"]=m_batch.get_batch_directive(batch,"ABSORB")[1];water_mat_params["sss_strength"]=m_batch.get_batch_directive(batch,"SSS_STRENGTH")[1];water_mat_params["sss_width"]=m_batch.get_batch_directive(batch,
"SSS_WIDTH")[1];water_mat_params["dst_noise_scale0"]=m_batch.get_batch_directive(batch,"DST_NOISE_SCALE_0")[1];water_mat_params["dst_noise_scale1"]=m_batch.get_batch_directive(batch,"DST_NOISE_SCALE_1")[1];water_mat_params["dst_noise_freq0"]=m_batch.get_batch_directive(batch,"DST_NOISE_FREQ_0")[1];water_mat_params["dst_noise_freq1"]=m_batch.get_batch_directive(batch,"DST_NOISE_FREQ_1")[1];water_mat_params["dir_min_shore_fac"]=m_batch.get_batch_directive(batch,"DIR_MIN_SHR_FAC")[1];water_mat_params["dir_freq"]=
m_batch.get_batch_directive(batch,"DIR_FREQ")[1];water_mat_params["dir_noise_scale"]=m_batch.get_batch_directive(batch,"DIR_NOISE_SCALE")[1];water_mat_params["dir_noise_freq"]=m_batch.get_batch_directive(batch,"DIR_NOISE_FREQ")[1];water_mat_params["dir_min_noise_fac"]=m_batch.get_batch_directive(batch,"DIR_MIN_NOISE_FAC")[1];water_mat_params["dst_min_fac"]=m_batch.get_batch_directive(batch,"DST_MIN_FAC")[1];water_mat_params["waves_hor_fac"]=m_batch.get_batch_directive(batch,"WAVES_HOR_FAC")[1]}return water_mat_params};
exports["set_material_extended_params"]=function(obj,mat_name,mat_params){if(!obj||(!mat_name||!mat_params)){m_print.error("B4W Error: missing arguments in set_material_params");return}if(!check_batch_material(obj,mat_name)){m_print.warn("B4W Warning: setting material params is not possible");return null}var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(!batch){m_print.warn("B4W Warning: material not found");return}if(batch.type=="MAIN"){if("material_reflectivity"in mat_params&&obj._render.reflective){var refl=
mat_params["material_reflectivity"];batch.reflect_factor=refl}if("material_fresnel"in mat_params){var fresnel=mat_params["material_fresnel"];batch.fresnel_params[2]=fresnel}if("material_fresnel_factor"in mat_params){var fresnel_factor=1-mat_params["material_fresnel_factor"]/5;batch.fresnel_params[3]=fresnel_factor}if("material_parallax_scale"in mat_params){var parallax_scale=mat_params["material_parallax_scale"];batch.parallax_scale=parallax_scale}if("material_parallax_steps"in mat_params){var parallax_steps=
m_shaders.glsl_value(parseFloat(mat_params["material_parallax_steps"]));m_batch.set_batch_directive(batch,"PARALLAX_STEPS",parallax_steps);m_batch.update_shader(batch,true)}}};exports["set_water_material_params"]=function(obj,water_mat_name,water_mat_params){if(!obj||(!water_mat_name||!water_mat_params)){m_print.error("B4W Error: missing arguments in set_water_material_params");return null}if(!check_batch_material(obj,water_mat_name)){m_print.warn("B4W Warning: setting water material params is not possible");
return null}var batch=m_batch.find_batch_material(obj,water_mat_name,"MAIN");if(!batch){m_print.warn("B4W Warning: material not found");return null}if(batch.type=="MAIN"){if(cfg_def.shore_distance){if("shallow_water_col"in water_mat_params){var swc=water_mat_params["shallow_water_col"];batch.shallow_water_col[0]=swc[0];batch.shallow_water_col[1]=swc[1];batch.shallow_water_col[2]=swc[2]}if("shallow_water_col_fac"in water_mat_params)batch.shallow_water_col_fac=water_mat_params["shallow_water_col_fac"];
if("shore_water_col"in water_mat_params){var swc=water_mat_params["shore_water_col"];batch.shore_water_col[0]=swc[0];batch.shore_water_col[1]=swc[1];batch.shore_water_col[2]=swc[2]}if("shore_water_col_fac"in water_mat_params)batch.shore_water_col_fac=water_mat_params["shore_water_col_fac"]}if(cfg_def.shore_smoothing&&batch.water_shore_smoothing){if("shore_smoothing"in water_mat_params)if(water_mat_params["shore_smoothing"])m_batch.set_batch_directive(batch,"SHORE_SMOOTHING",1);else m_batch.set_batch_directive(batch,
"SHORE_SMOOTHING",0);if("absorb_factor"in water_mat_params){var absorb_factor=m_shaders.glsl_value(parseFloat(water_mat_params["absorb_factor"]));m_batch.set_batch_directive(batch,"ABSORB",absorb_factor)}}if("foam_factor"in water_mat_params&&cfg_def.foam)batch.foam_factor=water_mat_params["foam_factor"];if(cfg_def.water_dynamic&&batch.water_dynamic){if("water_dynamic"in water_mat_params)if(water_mat_params["water_dynamic"])m_batch.set_batch_directive(batch,"DYNAMIC",1);else m_batch.set_batch_directive(batch,
"DYNAMIC",0);if("waves_height"in water_mat_params){var waves_height=m_shaders.glsl_value(parseFloat(water_mat_params["waves_height"]));m_batch.set_batch_directive(batch,"WAVES_HEIGHT",waves_height)}if("waves_length"in water_mat_params){var waves_length=m_shaders.glsl_value(parseFloat(water_mat_params["waves_length"]));m_batch.set_batch_directive(batch,"WAVES_LENGTH",waves_length)}if("sss_strength"in water_mat_params){var waves_length=m_shaders.glsl_value(parseFloat(water_mat_params["sss_strength"]));
m_batch.set_batch_directive(batch,"SSS_STRENGTH",waves_length)}if("sss_width"in water_mat_params){var waves_length=m_shaders.glsl_value(parseFloat(water_mat_params["sss_width"]));m_batch.set_batch_directive(batch,"SSS_WIDTH",waves_length)}if("dst_noise_scale0"in water_mat_params){var dst_noise_scale0=m_shaders.glsl_value(parseFloat(water_mat_params["dst_noise_scale0"]));m_batch.set_batch_directive(batch,"DST_NOISE_SCALE_0",dst_noise_scale0)}if("dst_noise_scale1"in water_mat_params){var dst_noise_scale1=
m_shaders.glsl_value(parseFloat(water_mat_params["dst_noise_scale1"]));m_batch.set_batch_directive(batch,"DST_NOISE_SCALE_1",dst_noise_scale1)}if("dst_noise_freq0"in water_mat_params){var dst_noise_freq0=m_shaders.glsl_value(parseFloat(water_mat_params["dst_noise_freq0"]));m_batch.set_batch_directive(batch,"DST_NOISE_FREQ_0",dst_noise_freq0)}if("dst_noise_freq1"in water_mat_params){var dst_noise_freq1=m_shaders.glsl_value(parseFloat(water_mat_params["dst_noise_freq1"]));m_batch.set_batch_directive(batch,
"DST_NOISE_FREQ_1",dst_noise_freq1)}if("dir_min_shore_fac"in water_mat_params){var dir_min_shore_fac=m_shaders.glsl_value(parseFloat(water_mat_params["dir_min_shore_fac"]));m_batch.set_batch_directive(batch,"DIR_MIN_SHR_FAC",dir_min_shore_fac)}if("dir_freq"in water_mat_params){var dir_freq=m_shaders.glsl_value(parseFloat(water_mat_params["dir_freq"]));m_batch.set_batch_directive(batch,"DIR_FREQ",dir_freq)}if("dir_noise_scale"in water_mat_params){var dir_noise_scale=m_shaders.glsl_value(parseFloat(water_mat_params["dir_noise_scale"]));
m_batch.set_batch_directive(batch,"DIR_NOISE_SCALE",dir_noise_scale)}if("dir_noise_freq"in water_mat_params){var dir_noise_freq=m_shaders.glsl_value(parseFloat(water_mat_params["dir_noise_freq"]));m_batch.set_batch_directive(batch,"DIR_NOISE_FREQ",dir_noise_freq)}if("dir_min_noise_fac"in water_mat_params){var dir_min_noise_fac=m_shaders.glsl_value(parseFloat(water_mat_params["dir_min_noise_fac"]));m_batch.set_batch_directive(batch,"DIR_MIN_NOISE_FAC",dir_min_noise_fac)}if("dst_min_fac"in water_mat_params){var dst_min_fac=
m_shaders.glsl_value(parseFloat(water_mat_params["dst_min_fac"]));m_batch.set_batch_directive(batch,"DST_MIN_FAC",dst_min_fac)}if("waves_hor_fac"in water_mat_params){var waves_hor_fac=m_shaders.glsl_value(parseFloat(water_mat_params["waves_hor_fac"]));m_batch.set_batch_directive(batch,"WAVES_HOR_FAC",waves_hor_fac)}}m_batch.update_shader(batch,true)}return true}};b4w.module["physics"]=function(exports,require){var m_print=require("__print");var physics=require("__physics");var util=require("__util");exports["CM_WALK"]=0;exports["CM_RUN"]=1;exports["CM_CLIMB"]=2;exports["CM_FLY"]=3;exports["enable_simulation"]=function(obj){physics.enable_simulation(obj)};exports["disable_simulation"]=function(obj){physics.disable_simulation(obj)};exports["has_simulated_physics"]=function(obj){return physics.has_simulated_physics(obj)};exports["set_gravity"]=function(obj,gravity){if(!obj._physics){m_print.error("No physics for object "+
obj["name"]);return}physics.set_gravity(obj,gravity)};exports["set_damping"]=function(obj,damping,rotation_damping){if(!obj._physics){m_print.error("No physics for object "+obj["name"]);return}var body_id=obj._physics.body_id;physics.post_msg("set_damping",body_id,damping,rotation_damping)};exports["reset_damping"]=function(obj){if(!obj._physics){m_print.error("No physics for object "+obj["name"]);return}var game=obj["game"];var damping=game["damping"];var rdamping=game["rotation_damping"];var body_id=
obj._physics.body_id;physics.post_msg("set_damping",body_id,damping,rdamping)};exports["set_transform"]=function(obj,trans,quat){physics.set_transform.apply(this,arguments)};exports["sync_transform"]=function(obj){physics.sync_transform(obj)};exports["apply_velocity"]=function(obj){physics.apply_velocity.apply(this,arguments)};exports["apply_velocity_world"]=function(obj){physics.apply_velocity_world.apply(this,arguments)};exports["apply_force"]=function(obj,fx_local,fy_local,fz_local,allow_vertical,
disable_up){allow_vertical=allow_vertical||false;disable_up=disable_up||false;physics.apply_force.apply(this,arguments)};exports["apply_torque"]=function(obj,tx_local,ty_local,tz_local){physics.apply_torque.apply(this,arguments)};exports["vehicle_throttle"]=function(obj,engine_force){if(!physics.is_vehicle_chassis(obj)&&!physics.is_vehicle_hull(obj))m_print.error("Wrong object");physics.vehicle_throttle(obj,util.clamp(engine_force,-1,1))};exports["vehicle_throttle_inc"]=function(obj,engine_force_inc,
dir){if(!physics.is_vehicle_chassis(obj)&&!physics.is_vehicle_hull(obj))m_print.error("Wrong object");engine_force_inc=util.clamp(engine_force_inc,0,1);var vehicle=obj._vehicle;var force=vehicle.engine_force;if(dir==-1||dir==1){force+=dir*engine_force_inc;force=Math.max(-1,Math.min(force,1))}else if(dir==0&&force>=0){force-=engine_force_inc;force=Math.max(0,force)}else if(dir==0&&force<0){force+=engine_force_inc;force=Math.min(0,force)}else m_print.error("Wrong steering direction");physics.vehicle_throttle(obj,
util.clamp(force,-1,1))};exports["vehicle_steer"]=function(obj,steering_value){if(!physics.is_vehicle_chassis(obj)&&!physics.is_vehicle_hull(obj))m_print.error("Wrong object");physics.vehicle_steer(obj,util.clamp(steering_value,-1,1))};exports["vehicle_steer_inc"]=function(obj,steering_value_inc,dir){if(!physics.is_vehicle_chassis(obj)&&!physics.is_vehicle_hull(obj))m_print.error("Wrong object");steering_value_inc=util.clamp(steering_value_inc,0,1);var vehicle=obj._vehicle;var steering=vehicle.steering;
if(dir==-1||dir==1){steering+=dir*steering_value_inc;steering=Math.max(-1,Math.min(steering,1))}else if(dir==0&&steering>=0){steering-=steering_value_inc;steering=Math.max(0,steering)}else if(dir==0&&steering<0){steering+=steering_value_inc;steering=Math.min(0,steering)}else m_print.error("Wrong steering direction");physics.vehicle_steer(obj,util.clamp(steering,-1,1))};exports["vehicle_brake"]=function(obj,brake_force){if(!physics.is_vehicle_chassis(obj)&&!physics.is_vehicle_hull(obj))m_print.error("Wrong object");
physics.vehicle_brake(obj,util.clamp(brake_force,0,1))};exports["vehicle_brake_inc"]=function(obj,brake_force_inc){if(!physics.is_vehicle_chassis(obj)&&!physics.is_vehicle_hull(obj))m_print.error("Wrong object");brake_force_inc=util.clamp(brake_force_inc,-1,1);var vehicle=obj._vehicle;var brake_force=vehicle.brake_force;brake_force+=brake_force*brake_force_inc;physics.vehicle_brake(obj,util.clamp(brake_force,0,1))};exports["is_vehicle_chassis"]=function(obj){return physics.is_vehicle_chassis(obj)};
exports["is_vehicle_hull"]=function(obj){return physics.is_vehicle_hull(obj)};exports["get_vehicle_name"]=function(obj){if(physics.is_vehicle_chassis(obj)||physics.is_vehicle_hull(obj))return obj["b4w_vehicle_settings"]["name"];else{m_print.error("Wrong object");return null}};exports["get_vehicle_throttle"]=function(obj){if(physics.is_vehicle_chassis(obj)||physics.is_vehicle_hull(obj))return obj._vehicle.engine_force;else m_print.error("Wrong object")};exports["get_vehicle_steering"]=function(obj){if(physics.is_vehicle_chassis(obj)||
physics.is_vehicle_hull(obj))return obj._vehicle.steering;else m_print.error("Wrong object")};exports["get_vehicle_brake"]=function(obj){if(physics.is_vehicle_chassis(obj)||physics.is_vehicle_hull(obj))return obj._vehicle.brake_force;else m_print.error("Wrong object")};exports["get_vehicle_speed"]=function(obj){if(physics.is_vehicle_chassis(obj)||physics.is_vehicle_hull(obj))return physics.get_vehicle_speed(obj);else m_print.error("Wrong object")};exports["is_character"]=function(obj){return physics.is_character(obj)};
exports["set_character_move_dir"]=function(obj,forw,side){physics.set_character_move_dir(obj,forw,side)};exports["set_character_move_type"]=function(obj,type){physics.set_character_move_type(obj,type)};exports["set_character_dist_to_water"]=function(obj,dist){m_print.warn("Function set_character_dist_to_water() is deprecated")};exports["set_character_walk_velocity"]=function(obj,velocity){physics.set_character_walk_velocity(obj,velocity)};exports["set_character_run_velocity"]=function(obj,velocity){physics.set_character_run_velocity(obj,
velocity)};exports["set_character_fly_velocity"]=function(obj,velocity){physics.set_character_fly_velocity(obj,velocity)};exports["character_jump"]=function(obj){physics.character_jump(obj)};exports["character_rotation_inc"]=function(obj,h_angle,v_angle){physics.character_rotation_inc(obj,h_angle,v_angle)};exports["set_character_rotation_quat"]=function(obj,quat){physics.set_character_rotation_quat(obj,quat)};exports["set_character_rotation"]=function(obj,angle_h,angle_v){physics.set_character_rotation(obj,
angle_h,angle_v)};exports["set_character_rotation_v"]=function(obj,angle){physics.set_character_rotation_v(obj,angle)};exports["set_character_rotation_h"]=function(obj,angle){physics.set_character_rotation_h(obj,angle)};exports["append_collision_test"]=function(obj,collision_id,callback){physics.append_collision_test(obj,collision_id,callback)};exports["remove_collision_test"]=function(obj,collision_id){physics.remove_collision_test(obj,collision_id)};exports["apply_collision_impulse_test"]=function(obj,
callback){physics.apply_collision_impulse_test(obj,callback)};exports["clear_collision_impulse_test"]=function(obj){physics.clear_collision_impulse_test(obj)};exports["append_ray_test"]=function(obj,collision_id,from,to,local_coords,callback){physics.append_ray_test(obj,collision_id,from,to,local_coords,callback)};exports["remove_ray_test"]=function(obj,collision_id,from,to,local_coords){physics.remove_ray_test(obj,collision_id,from,to,local_coords)};exports["apply_constraint"]=function(pivot_type,
obj_a,trans_a,quat_a,obj_b,trans_b,quat_b,limits,stiffness,damping){if(!physics.has_physics(obj_a)||!physics.has_physics(obj_b)){m_print.error("Wrong objects");return}physics.apply_constraint(pivot_type,obj_a,trans_a,quat_a,obj_b,trans_b,quat_b,limits,stiffness,damping)};exports["clear_constraint"]=function(obj_a){if(!physics.has_physics(obj_a)||!physics.has_constraint(obj_a)){m_print.error("Wrong object");return}physics.clear_constraint(obj_a)};exports["pull_to_constraint_pivot"]=function(obj_a,
trans_a,quat_a,obj_b,trans_b,quat_b){physics.pull_to_constraint_pivot(obj_a,trans_a,quat_a,obj_b,trans_b,quat_b)}};b4w.module["scenes"]=function(exports,require){var m_batch=require("__batch");var config=require("__config");var m_print=require("__print");var physics=require("__physics");var renderer=require("__renderer");var m_scenes=require("__scenes");var util=require("__util");var m_cam=require("__camera");var cfg_def=config.defaults;var LIGHT_SUBSCENE_TYPES=["MAIN_OPAQUE","MAIN_BLEND","MAIN_REFLECT","GOD_RAYS","SKY"];exports["set_active"]=function(scene_name){var scenes=m_scenes.get_all_scenes();m_scenes.set_active(util.keysearch("name",
scene_name,scenes))};exports["get_active"]=function(){if(!m_scenes.check_active())return"";else return m_scenes.get_active()["name"]};exports["get_scenes"]=function(){var scenes=m_scenes.get_all_scenes();var scene_names=[];for(var i=0;i<scenes.length;i++)scene_names.push(scenes[i]["name"]);return scene_names};exports["get_screen_scenes"]=function(){m_print.log("get_screen_scenes() deprecated");return""};exports["get_active_camera"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");
return false}else return m_scenes.get_active()["camera"]};exports["get_object_by_name"]=function(name){if(!m_scenes.check_active()){m_print.error("No active scene");return null}var sobjs=m_scenes.get_scene_objs(m_scenes.get_active());var sobjs_name=util.keyfind("name",name,sobjs);if(sobjs_name.length==0){m_print.warn("get_object_by_name("+name+"): not found");return null}else if(sobjs_name.length==1)return sobjs_name[0];else{m_print.error("get_object_by_name("+name+"): name ambiguity");return null}};
exports["get_object_by_empty_name"]=function(empty_name,origin_name){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var sobjs=m_scenes.get_scene_objs(m_scenes.get_active());for(var i=0;i<sobjs.length;i++){var obj=sobjs[i];if(obj["dupli_group"]&&obj["name"]==empty_name){var dupli_group=obj["dupli_group"];var dg_objects=dupli_group["objects"];for(var j=0;j<dg_objects.length;j++){var dg_obj=dg_objects[j];if(dg_obj["origin_name"]==origin_name)return dg_obj}}}m_print.warn("get_object_by_empty_name("+
empty_name+", "+origin_name+"): not found");return null};exports["pick_object"]=function(x,y){if(!m_scenes.check_active()){m_print.error("No active scene");return""}var active_scene=m_scenes.get_active();var subs_color_pick=m_scenes.get_subs(active_scene,"COLOR_PICKING");if(subs_color_pick){renderer.draw(subs_color_pick,subs_color_pick.bundles);var cam=subs_color_pick.camera;var y=cam.height-y;var color=renderer.read_pixels(cam.framebuffer,x,y);var sobjs=active_scene._appended_objects["MESH"];for(var i=
0;i<sobjs.length;i++){var color_id=sobjs[i]._color_id;if(color_id)if(Math.abs(255*color_id[0]-color[0])<5&&(Math.abs(255*color_id[1]-color[1])<5&&Math.abs(255*color_id[2]-color[2])<5))return sobjs[i]["name"]}}else m_print.error("Color picking is not available");return""};exports["set_glow_intensity"]=function(obj,value){for(var i=0;i<obj._batches.length;i++){var batch=obj._batches[i];if(batch.type=="COLOR_ID")batch.glow_intensity=value}};exports["apply_glow_anim"]=function(obj,tau,T,N){if(obj._render&&
obj._render.selectable)m_scenes.apply_glow_anim(obj,tau,T,N)};exports["apply_glow_anim_def"]=function(obj){if(obj._render&&obj._render.selectable){var ga=obj._render.glow_anim_settings;m_scenes.apply_glow_anim(obj,ga.glow_duration,ga.glow_period,ga.glow_relapses)}};exports["clear_glow_anim"]=function(obj){if(obj._render&&obj._render.selectable)m_scenes.clear_glow_anim(obj)};exports["set_glow_color"]=function(color){var scene=m_scenes.get_active();var subs=m_scenes.get_subs(scene,"GLOW");if(subs){subs.glow_color=
color;subs.need_perm_uniforms_update=true}};exports["set_light_pos"]=function(){m_print.error("set_light_pos() deprecated, use lights module instead")};exports["set_light_direction"]=function(){m_print.error("set_light_direction() deprecated, use lights module instead")};exports["set_dir_light_color"]=function(index,val){m_print.error("set_dir_light_color() deprecated, use lights module instead")};exports["get_lights_names"]=function(){m_print.error("set_dir_light_color() deprecated, use lights module instead")};
exports["get_shadow_params"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var shadow_cast=m_scenes.get_subs(active_scene,"SHADOW_CAST");if(!shadow_cast)return null;var shadow_params={};var subs=m_scenes.get_subs(active_scene,"BLUR_DEPTH");if(subs){shadow_params["blur_depth_size_mult"]=subs.blur_depth_size_mult;shadow_params["blur_depth_edge_size"]=subs.blur_depth_edge_size;shadow_params["blur_depth_diff_threshold"]=subs.blur_depth_diff_threshold*
1E3}var subs=m_scenes.get_subs(active_scene,"DEPTH");if(subs)shadow_params["shadow_visibility_falloff"]=subs.shadow_visibility_falloff;var shs=active_scene._render.shadow_params;shadow_params["csm_near"]=shs.csm_near;shadow_params["csm_far"]=shs.csm_far;shadow_params["csm_num"]=shs.csm_num;shadow_params["csm_lambda"]=shs.csm_lambda;shadow_params["csm_borders"]=m_scenes.get_csm_borders(active_scene);return shadow_params};exports["set_shadow_params"]=function(shadow_params){if(!m_scenes.check_active()){m_print.error("No active scene");
return false}var active_scene=m_scenes.get_active();var subscenes=m_scenes.subs_array(active_scene,LIGHT_SUBSCENE_TYPES);var subs=m_scenes.get_subs(active_scene,"DEPTH");if(subs)if("shadow_visibility_falloff"in shadow_params)subs.shadow_visibility_falloff=shadow_params["shadow_visibility_falloff"];var subscenes=m_scenes.subs_array(active_scene,["BLUR_DEPTH"]);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if("blur_depth_size_mult"in shadow_params){subs.blur_depth_size_mult=shadow_params["blur_depth_size_mult"];
var bundles=subs.bundles;var batch=bundles[0].batch;if(batch&&batch.texel_size){m_batch.set_texel_size_mult(batch,shadow_params["blur_depth_size_mult"]);m_scenes.set_texel_size(subs,1/subs.camera.width,1/subs.camera.width)}}if("blur_depth_edge_size"in shadow_params)subs.blur_depth_edge_size=shadow_params["blur_depth_edge_size"];if("blur_depth_diff_threshold"in shadow_params)subs.blur_depth_diff_threshold=shadow_params["blur_depth_diff_threshold"]/1E3;subs.need_perm_uniforms_update=true}var shs=active_scene._render.shadow_params;
if("csm_near"in shadow_params)shs.csm_near=shadow_params["csm_near"];if("csm_far"in shadow_params)shs.csm_far=shadow_params["csm_far"];if("csm_lambda"in shadow_params)shs.csm_lambda=shadow_params["csm_lambda"];var subs=m_scenes.get_subs(active_scene,"DEPTH");if(subs){var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];if(!bundle.obj_render.shadow_receive)continue;var batch=bundle.batch;m_batch.assign_shadow_receive_dirs(batch,m_scenes.get_csm_borders(active_scene));m_batch.update_shader(batch)}subs.need_perm_uniforms_update=
true}m_scenes.schedule_shadow_update(active_scene)};exports["get_environment_colors"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_environment_colors(active_scene)};exports["set_environment_colors"]=function(opt_environment_energy,opt_horizon_color,opt_zenith_color){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.set_environment_colors(active_scene,
parseFloat(opt_environment_energy),opt_horizon_color,opt_zenith_color)};exports["get_fog_color_density"]=function(dest){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_fog_color_density(active_scene,dest)};exports["set_fog_color_density"]=function(val){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.set_fog_color_density(active_scene,val)};
exports["get_ssao_params"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_ssao_params(active_scene)};exports["set_ssao_params"]=function(ssao_params){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.set_ssao_params(active_scene,ssao_params)};exports["get_color_correction_params"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");
return null}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"COMPOSITING");if(!subs)return null;var compos_params={};compos_params["brightness"]=subs.brightness;compos_params["contrast"]=subs.contrast;compos_params["exposure"]=subs.exposure;compos_params["saturation"]=subs.saturation;return compos_params};exports["set_color_correction_params"]=function(compos_params){if(!m_scenes.check_active()){m_print.error("No active scene");return null}var active_scene=m_scenes.get_active();
var subs=m_scenes.get_subs(active_scene,"COMPOSITING");if(!subs)return null;if("brightness"in compos_params)subs.brightness=compos_params["brightness"];if("contrast"in compos_params)subs.contrast=compos_params["contrast"];if("exposure"in compos_params)subs.exposure=compos_params["exposure"];if("saturation"in compos_params)subs.saturation=compos_params["saturation"];subs.need_perm_uniforms_update=true};exports["get_sky_params"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");
return false}var active_scene=m_scenes.get_active();return m_scenes.get_sky_params(active_scene)};exports["set_sky_params"]=function(sky_params){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.set_sky_params(active_scene,sky_params)};exports["get_dof_params"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"DOF");
if(subs)return m_scenes.get_dof_params(active_scene);else return null};exports["set_dof_params"]=function(dof_params){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.set_dof_params(active_scene,dof_params)};exports["get_god_rays_params"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"GOD_RAYS");if(subs)return m_scenes.get_god_rays_params(active_scene);
else return null};exports["set_god_rays_params"]=function(god_rays_params){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.set_god_rays_params(active_scene,god_rays_params)};exports["get_bloom_params"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"BLOOM");if(subs)return m_scenes.get_bloom_params(active_scene);
else return null};exports["set_bloom_params"]=function(bloom_params){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.set_bloom_params(active_scene,bloom_params)};exports["get_wind_params"]=function(){return m_scenes.get_wind_params()};exports["set_wind_params"]=function(wind_params){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.set_wind_params(active_scene,
wind_params)};exports["get_water_surface_level"]=m_scenes.get_water_surface_level;exports["set_water_params"]=function(water_params){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.set_water_params(active_scene,water_params)};exports["get_water_mat_params"]=function(water_params){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.get_water_mat_params(active_scene,
water_params)};exports["update_scene_materials_params"]=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();m_scenes.update_scene_permanent_uniforms(active_scene)};exports["append_object"]=function(obj){throw'Method "append_object" is deprecated';};exports["add_object"]=function(obj){throw'Method "add_object" is deprecated';};exports["remove_object"]=function(obj){throw'Method "remove_object" is deprecated';};exports["hide_object"]=
function(obj){var scene=m_scenes.get_active();m_scenes.hide_object(scene,obj)};exports["show_object"]=function(obj){var scene=m_scenes.get_active();m_scenes.show_object(scene,obj)};exports["is_visible"]=function(obj){return obj._render.is_visible};exports["check_object"]=function(obj){if(!m_scenes.check_active()){m_print.error("No active scene");return false}return m_scenes.check_object(obj,m_scenes.get_active())};exports["remove_all"]=function(){throw"unimplemented";};exports["check_collision"]=
function(){return false};exports["check_ray_hit"]=function(){return false};exports["get_appended_objs"]=function(type){var scene=m_scenes.get_active();return m_scenes.get_appended_objs(scene,type)};exports["get_object_name"]=function(obj){if(!obj){m_print.error("Wrong object name");return""}return obj["name"]};exports["get_object_type"]=function(obj){if(!(obj&&obj["type"])){m_print.error("Wrong object ID");return"UNDEFINED"}return obj["type"]};exports["get_object_children"]=function(obj){return obj._descends.slice(0)};
exports["get_first_character"]=function(){var sobjs=m_scenes.get_scene_objs(m_scenes.get_active(),"MESH");for(var i=0;i<sobjs.length;i++){var obj=sobjs[i];if(physics.is_character(obj))return obj}return null};exports["get_shore_dist"]=function(trans,v_dist_mult){if(!v_dist_mult&&v_dist_mult!==0)v_dist_mult=1;return m_scenes.get_shore_dist(trans,v_dist_mult)};exports["get_cam_water_depth"]=function(){return m_scenes.get_cam_water_depth()}};b4w.module["sfx"]=function(exports,require){var m_scenes=require("__scenes");var sfx=require("__sfx");exports["play"]=function(obj,when,duration){sfx.play(obj,when,duration)};exports["play_def"]=function(obj){sfx.play_def(obj)};exports["is_play"]=function(obj){return sfx.is_play(obj)};exports["speaker_play"]=function(obj,cyclic,duration,playrate){sfx.cyclic(obj,cyclic);if(playrate)sfx.playrate(obj,playrate);sfx.play(obj,0,duration)};exports["speaker_stop"]=function(obj){sfx.stop(obj)};exports["stop"]=
function(obj){sfx.stop(obj)};exports["speaker_playback_rate"]=function(obj,playrate){sfx.playrate(obj,playrate)};exports["playrate"]=function(obj,playrate){sfx.playrate(obj,playrate)};exports["cyclic"]=function(obj,cyclic){sfx.cyclic(obj,cyclic)};exports["is_cyclic"]=function(obj){return sfx.is_cyclic(obj)};exports["listener_reset_speed"]=function(){sfx.listener_reset_speed()};exports["speaker_reset_speed"]=function(obj){sfx.speaker_reset_speed(obj)};exports["get_volume"]=function(obj){if(obj&&typeof obj===
"object")return sfx.get_volume(obj);else return sfx.get_master_volume()};exports["set_volume"]=function(obj,volume){if(obj&&typeof obj==="object")sfx.set_volume(obj,volume);else sfx.set_master_volume(volume)};exports["mute"]=function(obj,muted){if(obj&&typeof obj==="object")sfx.mute(obj,muted);else sfx.mute_master(muted)};exports["is_muted"]=function(obj){if(obj&&typeof obj==="object")return sfx.is_muted(obj);else return sfx.is_master_muted()};exports["get_speaker_objects"]=function(){return sfx.get_speaker_objects().slice(0)};
exports["get_speakers"]=function(){return exports["get_speaker_objects"]()};exports["set_compressor_params"]=function(params){sfx.set_compressor_params(m_scenes.get_active(),params)};exports["get_compressor_params"]=function(){return sfx.get_compressor_params(m_scenes.get_active())};exports["duck"]=function(obj,value,time){if(obj&&typeof obj==="object")sfx.duck(obj,value,time);else sfx.duck_master(value,time)};exports["unduck"]=function(obj){if(obj&&typeof obj==="object")sfx.unduck(obj);else sfx.unduck_master()};
exports["apply_playlist"]=sfx.apply_playlist;exports["clear_playlist"]=sfx.clear_playlist;exports["set_positional_params"]=sfx.set_positional_params;exports["get_positional_params"]=sfx.get_positional_params;exports["set_filter_params"]=sfx.set_filter_params;exports["get_filter_params"]=sfx.get_filter_params;exports["get_filter_freq_response"]=sfx.get_filter_freq_response};b4w.module["shaders"]=function(exports,require){var config=require("__config");var m_print=require("__print");var extensions=require("__extensions");var m_scenes=require("__scenes");var shaders=require("__shaders");var util=require("__util");var SHADERS=[{vert:"depth.glslv",frag:"depth.glslf",directives:{bool:["SKINNED","FRAMES_BLENDING","WIND_BEND","DETAIL_BEND","VERTEX_ANIM","TEXTURE_COLOR","VERTEX_COLOR","DEPTH_RGBA","ALPHA","CSM_SECTION1","CSM_SECTION2","CSM_SECTION3","PCF_SHADOWS","VSM_SHADOWS"],
number:[["MAX_BONES",[100]],["CSM_SECTION_DIST0",[2.0001]],["CSM_SECTION_DIST1",[4.0001]],["CSM_SECTION_DIST2",[7.0001]],["CSM_SECTION_DIST3",[9.0001]],["PCF_TEXEL_SIZE",[1/1024]]],enumerated:[["SHADOW_SOURCE",["SHADOW_SOURCE_NONE","SHADOW_SOURCE_MAP","SHADOW_SOURCE_MASK"]]]}},{vert:"shadeless.glslv",frag:"shadeless.glslf",directives:{bool:["SKINNED","FRAMES_BLENDING","WIND_BEND","DETAIL_BEND","VERTEX_ANIM","VERTEX_COLOR","TEXTURE_STENCIL_ALPHA_MASK","REFLECTION","TEXTURE_COLOR","WATER_EFFECTS","ALPHA",
"ALPHA_CLIP","DISABLE_FOG"],number:[["MAX_BONES",[100]]],enumerated:[["TEXTURE_BLEND_TYPE",["TEXTURE_BLEND_TYPE_MIX","TEXTURE_BLEND_TYPE_MULTIPLY"]]]}},{vert:"color_id.glslv",frag:"color_id.glslf",directives:{bool:["SKINNED","FRAMES_BLENDING","WIND_BEND","DETAIL_BEND","VERTEX_ANIM","TEXTURE_COLOR","ALPHA_CLIP"],number:[["MAX_BONES",[100]]],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/anaglyph.glslf",directives:{bool:[],number:[],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",
frag:"postprocessing/antialiasing.glslf",directives:{bool:[],number:[],enumerated:[["AA_METHOD",["AA_METHOD_PASS","AA_METHOD_LIGHT","AA_METHOD_QUALITY"]]]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/blur_depth.glslf",directives:{bool:[],number:[],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/compositing.glslf",directives:{bool:[],number:[],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/depth_pack.glslf",directives:{bool:["DEPTH_RGBA"],
number:[],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/dof.glslf",directives:{bool:["DEPTH_RGBA"],number:[],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/edge.glslf",directives:{bool:["DEPTH_RGBA"],number:[],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/bloom_combine.glslf",directives:{bool:[],number:[],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/luminance.glslf",
directives:{bool:[],number:[],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/luminance_av.glslf",directives:{bool:[],number:[],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/luminance_trunced.glslf",directives:{bool:[],number:[],enumerated:[]}},{vert:"postprocessing/god_rays.glslv",frag:"postprocessing/god_rays.glslf",directives:{bool:["DEPTH_RGBA","WATER_EFFECTS"],number:[["NUM_LIGHTS",[1,10,100]]],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",
frag:"postprocessing/god_rays_combine.glslf",directives:{bool:[],number:[],enumerated:[]}},{vert:"special_skydome.glslv",frag:"procedural_skydome.glslf",directives:{number:[["NUM_LIGHTS",[1,10,100]]],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/motion_blur.glslf",directives:{bool:[],number:[["MAX_STEPS",[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,100]]],enumerated:[]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/postprocessing.glslf",directives:{bool:[],
number:[],enumerated:[["POST_EFFECT",["POST_EFFECT_NONE","POST_EFFECT_GRAYSCALE","POST_EFFECT_X_BLUR","POST_EFFECT_Y_BLUR"]]]}},{vert:"postprocessing/postprocessing.glslv",frag:"postprocessing/ssao.glslf",directives:{bool:["SSAO_WHITE"],number:[],enumerated:[]}}];function analyze_shaders(vshader,fshader){var ext_ds=extensions.get_debug_shaders();if(!ext_ds){m_print.error("B4W Error: WEBGL_debug_shaders not found"+" (run Chrome with --enable-privileged-webgl-extensions)");return}var vsrc=ext_ds.getTranslatedShaderSource(vshader);
var fsrc=ext_ds.getTranslatedShaderSource(fshader);var vout=post_sync("/nvidia_vert",vsrc);var vstats=parse_shader_assembly(vout);var fout=post_sync("/nvidia_frag",fsrc);var fstats=parse_shader_assembly(fout);return{vsrc:vsrc,vout:vout,vstats:vstats,fsrc:fsrc,fout:fout,fstats:fstats}}function parse_shader_assembly(data){var stats={};if(!data)return stats;var lines=data.split("\n");for(var i=0;i<lines.length;i++){var line=lines[i];if(line.search(new RegExp(/^[A-Z.]+ /))==-1)continue;var op=line.split(" ")[0];
if(!(op in stats))stats[op]=0;stats[op]++}var alu_ops=0;var tex_ops=0;for(var op in stats)switch(op){case "KIL":case "TEX":case "TXB":case "TXP":case "KIL.F":case "TEX.F":case "TXB.F":case "TXD.F":case "TXL.F":case "TXQ.F":case "TXP.F":tex_ops+=stats[op];break;default:alu_ops+=stats[op];break}stats["ALU_OPS"]=alu_ops;stats["TEX_OPS"]=tex_ops;return stats}function post_sync(path,data){var req=new XMLHttpRequest;req.open("POST",path,false);req.send(data);if(req.status==200)return req.responseText;else throw"Error POST XHR: "+
req.status;}exports["determine_max_bones"]=function(){return{"max_bones":determine_max_bones(1),"max_bones_no_blending":determine_max_bones(0)}};function determine_max_bones(frames_blending){var MAX=999;for(var i=1;i<=MAX;i++){var shaders_info={vert:"main.glslv",frag:"main.glslf",directives:[["MAX_BONES",i],["SKINNED",1],["FRAMES_BLENDING",frames_blending],["WIND_BEND",0],["DETAIL_BEND",0],["DYNAMIC_GRASS",0],["VERTEX_ANIM",0],["TEXTURE_COLOR",1],["TEXTURE_SPEC",1],["TEXTURE_NORM",1],["TEXTURE_MIRROR",
1],["VERTEX_COLOR",1],["WATER_EFFECTS",1],["REFLECTIVE",0],["REFLECTION_PASS",0],["SHADOW_SRC_NONE",10],["SHADOW_SRC_RGBA",20],["SHADOW_SRC_RGBA_PCF",30],["SHADOW_SRC_DEPTH",40],["SHADOW_SRC_VSM",50],["SHADOW_SRC_MASK",60],["SHADOW_SRC","SHADOW_SRC_DEPTH"],["CSM_SECTION1",1],["CSM_SECTION2",1],["CSM_SECTION3",0],["CSM_SECTION_DIST0",2.0001],["CSM_SECTION_DIST1",4.0001],["CSM_SECTION_DIST2",7.0001],["CSM_SECTION_DIST3",9.0001],["NUM_LIGHTS",4],["DOUBLE_SIDED_LIGHTING",1],["NUM_CAUSTS",3],["TEXTURE_COORDS_UV",
10],["TEXTURE_COORDS_NORMAL",20],["TEXTURE_COORDS","TEXTURE_COORDS_NORMAL"],["DISABLE_FOG",0],["ALPHA_AS_SPEC",0],["TEXTURE_STENCIL_ALPHA_MASK",0],["PARALLAX",0],["PARALLAX_STEPS",0],["TEXTURE_BLEND_TYPE_MIX",10],["TEXTURE_BLEND_TYPE_MULTIPLY",20],["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX"],["ALPHA",1],["ALPHA_CLIP",0],["SSAO_ONLY",0]]};try{shaders.get_compiled_shader(shaders_info,null)}catch(e){m_print.log("vertex uniforms limit exceeded, max bones =",i-1);return i-1}m_print.log("shaders successfully compiled and linked")}return MAX}
exports["report_repeatful_compilation"]=function(){var debug_hash_codes=shaders.debug_get_compilation_stats();var total=0;for(var i in debug_hash_codes){var info=debug_hash_codes[i];var count=info.count;if(count>1)m_print.log(count-1,info.shader_filename,info.hc);total+=count-1}m_print.log("TOTAL OVERHEAD:",total);return"OK"};exports["analyze"]=function(opt_shader_id_part){var compiled_shaders=shaders.get_compiled_shaders();var count=0;for(var shader_id in compiled_shaders){if(opt_shader_id_part&&
shader_id.indexOf(opt_shader_id_part)===-1)continue;count++}var msg="of "+count+" analyzing...";var rslts={};for(var shader_id in compiled_shaders){if(opt_shader_id_part&&shader_id.indexOf(opt_shader_id_part)===-1)continue;var cshader=compiled_shaders[shader_id];var stat=analyze_shaders(cshader.vshader,cshader.fshader);var shaders_info=cshader.shaders_info;var title=shaders_info.vert+" + "+shaders_info.frag;stat.cshader=cshader;stat.shaders_info=shaders_info;var stats=rslts[title]=rslts[title]||[];
stats.push(stat);m_print.log(msg)}for(var title in rslts){m_print.group("%c"+title,"color: #800");var stats=rslts[title];print_shader_stats_nvidia(stats);m_print.groupEnd()}};function find_material_names_by_comp_shader(cshader){var scenes=m_scenes.get_all_scenes();for(var i=0;i<scenes.length;i++){var objects=m_scenes.get_scene_objs(scenes[i],"MESH");for(var j=0;j<objects.length;j++){var obj=objects[j];if(!obj._batches)continue;for(var k=0;k<obj._batches.length;k++){var batch=obj._batches[k];if(batch.shader==
cshader&&batch.material_names.length)return batch.material_names}}}return null}function print_shader_stats_amd(stats){stats.sort(function(a,b){return b.fstats.cycles_avg-a.fstats.cycles_avg});for(var j=0;j<stats.length;j++){var stat=stats[j];var fstats=stat.fstats;var vstats=stat.vstats;var mat_names=find_material_names_by_comp_shader(stat.cshader);mat_names=mat_names?"\t\t("+mat_names.join(", ")+")":"\t\t(NA)";m_print.groupCollapsed("FRAG --\x3e","AVG",fstats.cycles_avg,"ALU",fstats.instr_alu,"TEX",
fstats.instr_tex,"INTERP",fstats.instr_interp,"CF",fstats.instr_ctrlflw,"ALU_TEX",fstats.alu_tex_an,"BTLNCK",'"'+fstats.bottleneck_an+'"',"\t\tVERT --\x3e","AVG",vstats.cycles_avg,"ALU",vstats.instr_alu,"TEX",vstats.instr_tex,"CF",vstats.instr_ctrlflw,"EXP",vstats.instr_export,"ALU_TEX",vstats.alu_tex_an,"BTLNCK",'"'+vstats.bottleneck_an+'"',mat_names);m_print.groupCollapsed("directives");var dirs=stat.shaders_info.directives;for(var i=0;i<dirs.length;i++){var dir=dirs[i];m_print.log(dir[0],dir[1])}m_print.groupEnd();
m_print.groupCollapsed("vert src");m_print.log(stat.vsrc);m_print.groupEnd();m_print.groupCollapsed("vert stats");m_print.log(stat.vout);m_print.groupEnd();m_print.groupCollapsed("frag src");m_print.log(stat.fsrc);m_print.groupEnd();m_print.groupCollapsed("frag stats");m_print.log(stat.fout);m_print.groupEnd();m_print.groupEnd()}}function print_shader_stats_nvidia(stats){stats.sort(function(a,b){return b.fstats["ALU_OPS"]-a.fstats["ALU_OPS"]});for(var j=0;j<stats.length;j++){var stat=stats[j];var fstats=
stat.fstats;var vstats=stat.vstats;var mat_names=find_material_names_by_comp_shader(stat.cshader);mat_names=mat_names?"\t\t("+mat_names.join(", ")+")":"\t\t(NA)";m_print.groupCollapsed("FRAG --\x3e","ALU",fstats["ALU_OPS"],"TEX",fstats["TEX_OPS"],"\t\tVERT --\x3e","ALU",vstats["ALU_OPS"],"TEX",vstats["TEX_OPS"],mat_names);m_print.groupCollapsed("directives");var dirs=stat.shaders_info.directives;for(var i=0;i<dirs.length;i++){var dir=dirs[i];m_print.log(dir[0],dir[1])}m_print.groupEnd();m_print.groupCollapsed("vert src");
m_print.log(stat.vsrc);m_print.groupEnd();m_print.groupCollapsed("vert stats");for(var op in vstats)if(op!="ALU_OPS"&&op!="TEX_OPS")m_print.log(op,vstats[op]);m_print.groupEnd();m_print.groupCollapsed("frag src");m_print.log(stat.fsrc);m_print.groupEnd();m_print.groupCollapsed("frag stats");for(var op in fstats)if(op!="ALU_OPS"&&op!="TEX_OPS")m_print.log(op,fstats[op]);m_print.groupEnd();m_print.groupEnd()}}exports["compile_all"]=function(arg_from,arg_to){var queue=[];for(var i=0;i<SHADERS.length;i++){var vert=
SHADERS[i].vert,frag=SHADERS[i].frag;var dir_combos=generate_directives_combos(SHADERS[i].directives);var len=dir_combos.length;var msg="of "+len+" "+vert+" + "+frag;var from=arg_from||0;var to=arg_to||len;if(to>len)to=len;for(var j=from;j<to;j++){var shaders_info={vert:vert,frag:frag,directives:dir_combos[j]};queue.push({shaders_info:shaders_info,msg:msg})}}var MAX_TASKS=100;var INTERVAL=50;function compile_shaders(){cleanup();var tasks=MAX_TASKS;while(queue.length&&tasks--){var item=queue.shift();
m_print.log(item.msg);shaders.get_compiled_shader(item.shaders_info,null)}setTimeout(compile_shaders,INTERVAL)}setTimeout(compile_shaders,0)};function generate_directives_combos(DIRECTIVES){var directives=[];for(var i=0;i<DIRECTIVES.bool.length;i++)directives.push({name:DIRECTIVES.bool[i],values:[0,1]});for(var i=0;i<DIRECTIVES.number.length;i++){var name=DIRECTIVES.number[i][0];var values=DIRECTIVES.number[i][1];directives.push({name:name,values:values})}for(var i=0;i<DIRECTIVES.enumerated.length;i++){var name=
DIRECTIVES.enumerated[i][0];var enumerators=DIRECTIVES.enumerated[i][1];for(var j=0;j<enumerators.length;j++)directives.push({name:enumerators[j],values:[10+j*10]});directives.push({name:name,values:enumerators})}var clone_array=function(src){var dest=new Array(src.length);for(var i=0;i<src.length;i++)dest[i]=src[i];return dest};var num_digits=directives.length;var increment=function(combo){for(var i=num_digits-1;i>=0;i--){var max_value=directives[i].values.length-1;if(combo[i]+1>max_value){combo[i]=
0;continue}else{combo[i]++;return}}};var combos=[];var last_combo;var num_combos=1;for(var i=0;i<directives.length;i++)num_combos*=directives[i].values.length;for(var i=0;i<num_combos;i++){if(!last_combo){var zeroes=new Array(num_digits);for(var j=0;j<num_digits;j++)zeroes[j]=0;combos.push(zeroes);last_combo=zeroes;continue}var combo=clone_array(last_combo);increment(combo);combos.push(combo);last_combo=combo}var dir_combos=[];for(var i=0;i<combos.length;i++){var combo=combos[i];var dir_combo=[];
for(var j=0;j<combo.length;j++){var dir=directives[j];var value=dir.values[combo[j]];dir_combo.push([dir.name,value])}dir_combos.push(dir_combo)}return dir_combos}};b4w.module["transform"]=function(exports,require){var m_print=require("__print");var physics=require("__physics");var transform=require("__transform");var util=require("__util");var _vec3_tmp=new Float32Array(3);var _quat4_tmp=new Float32Array(4);exports["set_translation"]=function(obj,x,y,z){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;transform.set_translation(obj,_vec3_tmp);transform.update_transform(obj);physics.sync_transform(obj)};exports["set_translation_v"]=function(obj,trans){transform.set_translation(obj,
trans);transform.update_transform(obj);physics.sync_transform(obj)};exports["set_translation_rel"]=function(obj,x,y,z,obj_parent){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;var trans=obj_parent._render.trans;var quat=obj_parent._render.quat;util.transform_vec3(_vec3_tmp,1,quat,trans,_vec3_tmp);transform.set_translation(obj,_vec3_tmp);transform.update_transform(obj);physics.sync_transform(obj)};exports["get_translation"]=function(obj,dest){if(!dest)var dest=new Float32Array(3);transform.get_translation(obj,
dest);return dest};exports["set_rotation"]=function(obj,x,y,z,w){_quat4_tmp[0]=x;_quat4_tmp[1]=y;_quat4_tmp[2]=z;_quat4_tmp[3]=w;transform.set_rotation(obj,_quat4_tmp);transform.update_transform(obj);physics.sync_transform(obj)};exports["set_rotation_quat"]=exports["set_rotation"];exports["set_rotation_v"]=function(obj,quat){transform.set_rotation(obj,quat);transform.update_transform(obj);physics.sync_transform(obj)};exports["set_rotation_quat_v"]=exports["set_rotation_v"];exports["get_rotation"]=
function(obj,opt_dest){if(!opt_dest)var opt_dest=new Float32Array(4);transform.get_rotation(obj,opt_dest);return opt_dest};exports["get_rotation_quat"]=exports["get_rotation"];exports["set_rotation_euler"]=function(obj,x,y,z){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;transform.set_rotation_euler(obj,_vec3_tmp);transform.update_transform(obj);physics.sync_transform(obj)};exports["set_rotation_euler_v"]=function(obj,euler){transform.set_rotation_euler(obj,euler);transform.update_transform(obj);physics.sync_transform(obj)};
exports["set_scale"]=function(obj,scale){transform.set_scale(obj,scale);transform.update_transform(obj)};exports["get_scale"]=function(obj){return transform.get_scale(obj)};exports["empty_reset_transform"]=function(obj){if(obj["type"]!="EMPTY"){m_print.error("Wrong object: "+obj["name"]);return false}transform.set_translation(obj,[0,0,0]);transform.set_rotation(obj,[0,0,0,1]);transform.set_scale(obj,1);transform.update_transform(obj);physics.sync_transform(obj)};exports["get_object_size"]=function(obj){if(!util.is_mesh(obj)){m_print.error("Wrong object: "+
obj["name"]);return 0}return transform.get_object_size(obj)};exports["get_object_center"]=function(obj,calc_bs_center,dest){if(!util.is_mesh(obj)){m_print.error("Wrong object: "+obj["name"]);return null}return transform.get_object_center(obj,calc_bs_center,dest)};exports["move_local"]=function(obj,dx,dy,dz){transform.move_local(obj,dx,dy,dz);transform.update_transform(obj);physics.sync_transform(obj)}};b4w.module["util"]=function(exports,require){var m_print=require("__print");var util=require("__util");var m_vec3=require("vec3");var m_mat4=require("mat4");exports["AXIS_X"]=new Float32Array([1,0,0]);exports["AXIS_Y"]=new Float32Array([0,1,0]);exports["AXIS_Z"]=new Float32Array([0,0,1]);exports["AXIS_MX"]=new Float32Array([-1,0,0]);exports["AXIS_MY"]=new Float32Array([0,-1,0]);exports["AXIS_MZ"]=new Float32Array([0,0,-1]);exports["keyfind"]=util.keyfind;exports["keysearch"]=util.keysearch;exports["matrix_to_quat"]=
function(matrix){return util.matrix_to_quat(matrix)};exports["euler_to_quat"]=function(euler){return util.euler_to_quat(euler)};exports["quat_to_euler"]=function(quat){return util.quat_to_euler(quat)};exports["sign"]=util.sign;exports["clamp"]=util.clamp;exports["quat_to_dir"]=util.quat_to_dir;exports["ground_project_quat"]=function(quat,dest){return util.quat_project(quat,util.AXIS_MY,util.AXIS_Y,util.AXIS_MZ,dest)};exports["cam_quat_to_mesh_quat"]=function(cam_quat,dest){return util.cam_quat_to_mesh_quat(cam_quat,
dest)};exports["quat_project"]=function(quat,quat_ident_dir,plane,plane_ident_dir,dest){if(m_vec3.dot(plane,plane_ident_dir)!=0){m_print.error("Wrong in-plane direction");return null}return util.quat_project(quat,quat_ident_dir,plane,plane_ident_dir,dest)};exports["hash_code"]=util.hash_code;exports["smooth"]=util.smooth;exports["smooth_v"]=util.smooth_v;exports["is_vector"]=util.is_vector;exports["correct_cam_quat_up"]=util.correct_cam_quat_up;exports["quat_to_angle_axis"]=util.quat_to_angle_axis;
exports["random_from_array"]=util.random_from_array;exports["xz_direction"]=util.xz_direction};if(typeof module=="object"&&module.exports)GLOBAL.b4w={module:{}};b4w.module["version"]=function(exports,require){var version=require("__version");exports["version"]=version.version;exports["type"]=version.type;exports["date"]=version.date};if(typeof module=="object"&&module.exports)b4w.module["version"](exports);b4w.module["main"]=function(exports,require){var animation=require("__animation");var compat=require("__compat");var config=require("__config");var m_print=require("__print");var controls=require("__controls");var data=require("__data");var debug=require("__debug");var extensions=require("__extensions");var geometry=require("__geometry");var hud=require("__hud");var nla=require("__nla");var assets=require("__assets");var physics=require("__physics");var renderer=require("__renderer");var scenes=require("__scenes");
var sfx=require("__sfx");var shaders=require("__shaders");var textures=require("__textures");var transform=require("__transform");var util=require("__util");var version=require("__version");var cfg_ctx=config.context;var cfg_def=config.defaults;var _elem_canvas_webgl=null;var _elem_canvas_hud=null;var _global_timeline=0;var _last_abs_time=0;var _pause_time=0;var _resume_time=0;var _fps_callback=function(){};var _fps_counter=function(){};var _render_callback=function(){};var _canvas_data_url_callback=
null;var CONTEXT_NAMES=["webgl","experimental-webgl"];var _gl=null;var _requestAnimFrame=function(){return window["requestAnimationFrame"]||(window["webkitRequestAnimationFrame"]||(window["mozRequestAnimationFrame"]||(window["oRequestAnimationFrame"]||(window["msRequestAnimationFrame"]||function(callback){return window.setTimeout(callback,1E3/cfg_def.max_fps)}))))}();exports["init"]=function(elem_canvas_webgl,elem_canvas_hud){m_print.set_verbose(cfg_def.console_verbose);var ver_str=version.version()+
" "+version.type()+" ("+version.date()+")";m_print.log("%cINIT B4W ENGINE","color: #00a",ver_str);if(!window["WebGLRenderingContext"])return null;if(!window["performance"]){m_print.log("Apply performance workaround");window["performance"]={}}if(!window["performance"]["now"]){m_print.log("Apply performance.now() workaround");window["performance"]["now"]=function(){return(new Date).getTime()}}_elem_canvas_webgl=elem_canvas_webgl;var gl=get_context(elem_canvas_webgl);if(!gl)return null;_gl=gl;init_context(_elem_canvas_webgl,
gl);compat.set_hardware_defaults(gl);config.apply_quality();m_print.log("%cSET PRECISION:","color: #00a",cfg_def.precision);if(elem_canvas_hud){hud.init(elem_canvas_hud);_elem_canvas_hud=elem_canvas_hud}else{config.defaults.show_hud_debug_info=false;config.sfx.mix_mode=false}physics.init_engine();return gl};function get_context(canvas){var ctx=null;for(var i=0;i<CONTEXT_NAMES.length;i++){var name=CONTEXT_NAMES[i];try{ctx=canvas.getContext(name,cfg_ctx)}catch(e){}if(ctx)break}return ctx}function init_context(canvas,
gl){canvas.addEventListener("webglcontextlost",function(event){event.preventDefault();m_print.error("B4W Error: WebGL context lost");pause()},false);extensions.setup_context(gl);var rinfo=extensions.get_renderer_info();if(rinfo)m_print.log("%cRENDERER INFO:","color: #00a",gl.getParameter(rinfo.UNMASKED_VENDOR_WEBGL)+", "+gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL));renderer.setup_context(gl);geometry.setup_context(gl);textures.setup_context(gl);shaders.setup_context(gl);debug.setup_context(gl);
scenes.setup_dim(canvas.width,canvas.height);sfx.init();_global_timeline=0;_fps_counter=init_fps_counter();loop()}exports["set_check_gl_errors"]=function(val){debug.set_check_gl_errors(val)};exports["resize"]=function(width,height){_elem_canvas_webgl.style.width=width+"px";_elem_canvas_webgl.style.height=height+"px";if(_elem_canvas_hud){_elem_canvas_hud.style.width=width+"px";_elem_canvas_hud.style.height=height+"px"}_elem_canvas_webgl.width=width;_elem_canvas_webgl.height=height;if(_elem_canvas_hud){_elem_canvas_hud.width=
width;_elem_canvas_hud.height=height}hud.update_dim();scenes.setup_dim(width,height);renderer.clear();frame(_global_timeline,0)};exports["set_fps_callback"]=function(fps_cb){_fps_callback=fps_cb};exports["clear_fps_callback"]=function(){_fps_callback=function(){}};exports["set_on_before_render_callback"]=function(callback){set_render_callback(callback)};exports["set_render_callback"]=function(callback){set_render_callback(callback)};function set_render_callback(callback){_render_callback=callback}
exports["clear_on_before_render_callback"]=function(){clear_render_callback()};exports["clear_render_callback"]=function(){clear_render_callback()};function clear_render_callback(){_render_callback=function(){}}exports["global_timeline"]=function(){return _global_timeline};exports["set_texture_quality"]=function(level){m_print.error("set_texture_quality() deprecated")};exports["set_shaders_dir"]=function(shdir){m_print.error("set_shaders_dir() deprecated")};exports["redraw"]=function(){frame(_global_timeline,
0)};exports["pause"]=pause;function pause(){if(is_paused())return;_pause_time=performance.now()/1E3;sfx.pause();physics.pause()}exports["resume"]=function(){if(!is_paused())return;_resume_time=performance.now()/1E3;sfx.resume();physics.resume()};exports["is_paused"]=is_paused;function is_paused(){return _resume_time<_pause_time}function loop(){_requestAnimFrame(loop);var abstime=performance.now()/1E3;if(!_last_abs_time)_last_abs_time=abstime;var delta=abstime-_last_abs_time;if(delta<1/cfg_def.max_fps)return;
if(renderer.is_locked())return;if(!is_paused()){if(_resume_time>_last_abs_time)delta-=_resume_time-Math.max(_pause_time,_last_abs_time);_global_timeline+=delta;debug.update();assets.update();data.update();frame(_global_timeline,delta);_fps_counter(delta)}_last_abs_time=abstime}function frame(timeline,delta){if(!data.is_loaded())return;hud.reset();transform.update(delta);nla.update(timeline,delta);sfx.update(timeline,delta);animation.update(delta);if(!data.is_loaded())return;physics.update(timeline,
delta);if(!data.is_loaded())return;_render_callback(delta,timeline);if(!data.is_loaded())return;controls.update(timeline,delta);if(!data.is_loaded())return;scenes.update(timeline,delta)}function init_fps_counter(){var fps_avg=60;var phy_fps_avg=0;var fps_frame_counter=0;var interval=cfg_def.fps_measurement_interval;var interval_cb=cfg_def.fps_callback_interval;var fps_counter=function(delta){fps_avg=util.smooth(1/delta,fps_avg,delta,interval);phy_fps_avg=util.smooth(physics.get_fps(),phy_fps_avg,
delta,interval);fps_frame_counter=(fps_frame_counter+1)%interval_cb;if(fps_frame_counter==0)_fps_callback(Math.round(fps_avg),Math.round(phy_fps_avg))};return fps_counter}exports["reset"]=function(){data.unload();_elem_canvas_webgl=null;_elem_canvas_hud=null;_global_timeline=0;_last_abs_time=0;_pause_time=0;_resume_time=0;_fps_callback=function(){};_fps_counter=function(){};_render_callback=function(){};_gl=null};exports["canvas_data_url"]=function(callback){_canvas_data_url_callback=callback}};
b4w["animation"]=b4w.require("animation");b4w["assets"]=b4w.require("assets");b4w["camera"]=b4w.require("camera");b4w["config"]=b4w.require("config");b4w["controls"]=b4w.require("controls");b4w["constraints"]=b4w.require("constraints");b4w["data"]=b4w.require("data");b4w["debug"]=b4w.require("debug");b4w["geometry"]=b4w.require("geometry");b4w["lights"]=b4w.require("lights");b4w["main"]=b4w.require("main");b4w["material"]=b4w.require("material");b4w["physics"]=b4w.require("physics");
b4w["scenes"]=b4w.require("scenes");b4w["shaders"]=b4w.require("shaders");b4w["sfx"]=b4w.require("sfx");b4w["transform"]=b4w.require("transform");b4w["util"]=b4w.require("util");b4w["version"]=b4w.require("version");b4w["vec3"]=b4w.require("vec3");b4w["vec4"]=b4w.require("vec4");b4w["quat"]=b4w.require("quat");b4w["mat3"]=b4w.require("mat3");b4w["mat4"]=b4w.require("mat4");for(var prop in b4w["main"])b4w[prop]=b4w["main"][prop];
