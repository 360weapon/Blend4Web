.. _textures:

.. index:: текстуры

********
Текстуры
********

.. index:: текстуры; типы

Типы текстур
============

Опция выбора типа текстуры ``Type`` расположена во вкладке ``Textures``. Движком поддерживаются текстуры следующих типов: 

#. ``Image or Movie``, изображение или фильм
    - диффузная (diffuse map)
    - карта бликов (specular map), может также содержаться в альфа-канале диффузной текстуры
    - карта нормалей (normal map)
    - карта высот (height map), может содержатся только в альфа-канале карты нормалей, используется для реализации рельефной поверхности (parallax mapping)
    - карта прозрачности (alpha map) - применяется отдельно только для рендеринга воды в режиме совместимости, в обычном материале может содержаться в альфа-канале диффузной текстуры
    - карта смешивания (stencil map)
#. ``Environment Map``, карта окружения
    - карта зеркального отражения (mirror map)
    - :ref:`текстура неба (skydome) <skydome_texture>`
#. ``None``, пустая
    - применена на кубе в стартовой сцене Blender'a, в движке генерируется серая текстура. Также используется для :ref:`рендеринга сцены в текстуру <render_to_texture>`.
#. ``Blend``, градиент
    - используется в :ref:`системах частиц <particles_textures>`
#. ``Voronoi``, процедурная текстура с разбиением Вороного
    - используется для рендеринга воды с целью настройки каустики


.. index:: текстуры; настройки

Общие настройки
===============

*Размер*
    Размер растров для текстур-изображений (длина и ширина изображения в пикселах) должен быть числом 2\ :sup:`N`, т.е. 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096 пикселов. Использование текстур других размеров (т.н. NPOT) поддерживается, но не рекомендуется. Для корректной работы компрессии текстур размер должен составлять не менее 4 пикселов. Как правило, используются изображения квадратной формы (например, 512 x 512 px), однако могут использоваться и прямоугольные (например, 4 x 128 px). Использование изображений размером более 2048 пикселов не рекомендуется.

*Image Mapping > Extension*
    Режим интерпретации текстурных координат (в WebGL - Wrap Mode). Доступен для текстур типа ``Image or Movie``. В случае значения ``Repeat`` движок устанавливает для текстуры режим ``REPEAT``. При этом целочисленная часть текстурных координат игнорируется, используется только дробная часть. Во всех остальных случаях (например, ``Extend``) движок устанавливает ``CLAMP_TO_EDGE``. При этом происходит ограничение текстурных координат отрезком [0, 1]. Значение по умолчанию ``Repeat``.

.. index:: material capture, matcap

*Mapping > Coordinates*
    Тип текстурных координат. Поддерживаются ``UV`` (использовать развертку), ``Normal`` (использовать направление на камеру, только для диффузных текстур, применяется для создания материалов в стиле **material capture**, **matcap**). Значение по умолчанию ``Generated`` (!).

*Mapping > Offset*
    Не поддерживается.
    
*Mapping > Size*
    Масштабирование развертки по соответствующим осям. Значения по умолчанию 1.0.

*Blend4Web > Do not export*
    Не экспортировать текстуру. По умолчанию отключено.

*Blend4Web > Anisotropic Filtering*
    Фактор анизотропной фильтрации для индивидуальной текстуры. Имеет приоритет перед аналогичной настройкой для сцены. Значение по умолчанию ``DEFAULT`` (т.е. использовать настройки сцены).

*Blend4Web > UV translation velocity*
    Скорость анимации текстурных координат по соответствующим осям. Значения по умолчанию 0.0.

*Blend4Web > Water Foam*
    Текстура пены. Используется материалом для рендеринга воды.


.. index:: текстуры; диффузная, diffuse map

Диффузная текстура (diffuse map)
================================

Диффузная текстура применяется для указания распределения цвета рассеянного света (модель Ламберта).

Активация
---------

Выставить опцию ``Diffuse > Color`` на панели ``Textures > Influence``.

Дополнительные настройки
------------------------
  
*Influence > Diffuse > Color*
    Степень влияния текстуры на диффузный цвет. Значение по умолчанию 1.0.

*Influence > Blend*
    Тип взаимодействия с цветом материала (``Material > Diffuse > Color``), или с вертексным цветом, если включена опция ``Vertex Color Paint``. Поддерживаются ``Mix`` (смешивается с цветом), ``Multiply`` (умножается на цвет). Значение по умолчанию ``Mix``.
    

.. index:: текстуры; карта бликов, specular map

Карта бликов (specular map)
===========================

Карта бликов применяется для указания распределения цвета отраженного света (модель Фонга).

Активация
---------

Выставить опцию ``Specular > Color`` на панели ``Textures > Influence`` (опция ``Specular > Intensity`` не поддерживается).

Дополнительные настройки
------------------------
  
*Influence > Specular > Color*
    Степень влияния текстуры на цвет отраженного света. Значение по умолчанию 1.0.

*Influence > Blend*
    Тип взаимодействия с цветом отраженного света материала (``Material > Specular > Color``). Поддерживается только ``Mix`` (смешивается с цветом). Значение по умолчанию ``Mix``.

Карта бликов может быть упакована в альфа-канал диффузной текстуры в целях оптимизации. В этом случае для текстуры необходимо одновременно выставить опции ``Diffuse > Color`` и ``Specular > Color``. Цветовой диапазон ограничен оттенками серого цвета. 


.. index:: текстуры; карта нормалей, normal map

Карта нормалей (normal map)
===========================

Карта нормалей применяется для указания распределения нормалей (перпендикуляров) к поверхности с целью увеличения уровня детализации ее рельефа. Информация о нормалях должна храниться в текстурном пространстве координат. Карты нормалей в объектном пространстве не поддерживаются.

Активация
---------

Выставить опцию ``Geometry > Normal`` на панели ``Textures > Influence``.

Дополнительные настройки
------------------------
  
*Influence > Geometry > Normal*
    Степень участия карты в расчетах нормалей. Значение по умолчанию 1.0.


.. index:: текстуры; карта высот, height map, parallax mapping

Карта высот (height map). Parallax mapping
==========================================

Карта высот содержит информацию о распределении относительных высот рельефа. Более высокий уровень поверхности обозначается более светлым цветом. Карта высот в сочетании с картой нормалей требуются в качестве входящих данных для реализации рельефной поверхности (parallax mapping). Карта высот должна содержатся в альфа-канале карты нормалей.

Активация
---------

Для карты нормалей дополнительно к опции ``Geometry > Normal`` на панели ``Textures > Influence`` выставить опцию ``Parallax`` на панели ``Textures > Blend4Web``.

Дополнительные настройки
------------------------
  
*Blend4Web > Parallax Scale*
    Фактор влияния эффекта рельефной поверхности. Значение по умолчанию 0.03.

*Blend4Web > Parallax Steps*
    Количество итераций в расчетах рельефной поверхности. Большее значение приводит к лучшему качеству и к большим затратам вычислительных ресурсов. Значение по умолчанию 10.

*Blend4Web > Parallax LOD distance*
    Расстояние на котором виден эффект параллакса.

.. image:: src_images/textures/parallax.jpg
   :align: center
   :width: 100%

|


.. index:: текстуры; карта прозрачности, alpha map

.. _texture_alpha_map:

Карта прозрачности (alpha map)
==============================

Отдельная карта прозрачности применяется только для воды в режиме совместимости. В обычном материале может содержаться в альфа-канале диффузной текстуры.

Активация
---------

Для диффузной текстуры дополнительно к опции ``Diffuse > Color`` на панели ``Textures > Influence`` выставить опцию ``Diffuse > Alpha``. Для отдельной карты прозрачности выставить опцию ``Diffuse > Alpha``.

Дополнительные настройки
------------------------

*Influence > Diffuse > Alpha*
    Не поддерживается.

*Influence > Blend*
    Не поддерживается.

.. image:: src_images/textures/alpha_map_water.jpg
   :align: center
   :width: 100%

|


.. index:: текстуры; карта смешивания, stencil map

Карта смешивания (stencil map)
==============================

Специальная текстура (цветная или оттенков серого), содержащая информацию о распределении других текстур по поверхности. 

Активация
---------

1. В случае нодовых материалов карта смешивания должна использоваться соответствующим образом в нодовой структуре. 
2. В случае обычных материалов карта смешивания должна располагаться в текстурном слоте между двумя смешиваемыми диффузными текстурами. Для текстуры смешивания необходимо одновременно выставить опции ``RGB to Intensity`` и ``Stencil`` на панели ``Textures > Influence``. 

Дополнительные настройки
------------------------

В случае обычных материалов для одной из смешиваемых диффузных текстур поддерживается тип текстурных координат ``Normal`` ("matcap"). 

Ограничения
-----------

В случае обычных материалов движком интерпретируется только красный канал текстуры смешивания. Карта бликов или карта нормалей при их наличии смешиванию не подвергаются. Настройка масштабирования ``Mapping > Size`` извлекается из первой текстуры и применяется ко всем остальным текстурам.

Пример
------

Материал яблока имеет текстуры: карту нормалей, диффузную текстуру с картой бликов в альфа-канале, карту смешивания, диффузную карту "matcap", карту зеркального отражения.

.. image:: src_images/textures/stencil_apple.jpg
   :align: center
   :width: 100%

|

.. image:: src_images/textures/stencil_apple_separate_textures.jpg
   :align: center
   :width: 100%

|


.. index:: текстуры; карта окружения, environment map

Карта окружения (environment map)
=================================

Применяется в качестве карты зеркального отражения (mirror map) и в качестве статической текстуры неба (skydome).

В движке представлена кубической текстурой. Растры для карт окружения должны содержать 6 спроецированных изображений окружающей среды, упакованных в 2 ряда по 3 (формат, используемый в Blender'e). Размер растров для каждого из изображений должен подчиняться правилу 2\ :sup:`N` (512, 1024 и т.п.).

Во избежание проявления швов рекомендуется использовать формат без потери качества (PNG).

.. image:: src_images/textures/environment_map.png
   :align: center
   :width: 100%


Создание карты окружения
------------------------

Blender позволяет запекать сцену в карту окружения. Для этого:

#. Создать сцену для запекания.
#. Добавить пустой объект в предполагаемом центре обзора (``Add > Empty``).
#. Перейти во вкладку ``World``, затем перейти во вкладку ``Textures``, создать новую текстуру, выбрать тип ``Environment Map``.
#. На панели ``Environment Map`` выбрать источник ``Static``, выбрать созданный пустой объект в поле ``Viewport Object``, установить разрешение 2\ :sup:`N` (512, 1024 и т.п.).
#. Выполнить рендеринг сцены ``F12`` (требуется наличие камеры).
#. Сохранить карту окружения в файл.

.. image:: src_images/textures/environment_map_baking_scene.jpg
   :align: center
   :width: 100%

|

.. image:: src_images/textures/environment_map_baking_ui.png
   :align: center
   :width: 100%

.. index:: текстуры; карта зеркального отражения, mirror map

.. _mirror_map:

Карта зеркального отражения (mirror map)
========================================

Применяется для визуализации отражающей способности поверхности. Представляет собой карту окружения.

Активация
---------

Выбрать тип текстуры (``Type``) ``Environment Map``. Выставить опцию ``Shading > Mirror`` на панели ``Textures > Influence``.

Дополнительные настройки
------------------------

*Influence > Shading > Mirror*
    Степень влияния карты зеркального отражения. Значение по умолчанию 1.0.


.. seealso:: :ref:`Статическое отражение <reflection_static>`.


.. index:: текстуры; небо, skydome

.. _skydome_texture:

Текстура неба (skydome)
=======================

Применяется для визуализации бесконечно удаленного окружения (например, небесного свода). Представляет собой карту окружения.

Также может применяться для имитации рассеянного окружения на объектах.

Активация
---------

Создать текстуру мира (world texture) с типом "Environment Map". Выбрать опцию ``Blend4Web > Sky texture usage > SKYDOME``.

.. note::

    Для имитации рассеянного окружения на объектах можно воспользоваться опцией ``Blend4Web > Sky texture usage > ENVIRONMENT_LIGHTING``. Чтобы данное свойство отразилось на объектах необходимо включить соответствующую опцию в настройках мира: ``Environment Lighting > Sky Texture``.

    Для создания обоих эффектов от одной текстуры необходимо выставить опцию ``Blend4Web > Sky texture usage > BOTH``.


.. image:: src_images/textures/skydome.png
   :align: center
   :width: 100%

|

.. _render_to_texture:

.. index:: текстуры; рендеринг в, render-to-texture, RTT

Рендеринг в текстуру (render-to-texture, RTT)
=============================================

Изображение 3D сцены может быть использовано в качестве текстуры на объекте другой ("главной") сцены. 

Активация
---------

#. Создать дополнительную сцену-источник, переименовать для удобства, создать ``World``, добавить нужные объекты, настроить вид из камеры.
#. В главной сцене для текстуры целевого объекта выставить тип ``None``, в поле ``Blend4Web > Source scene`` указать название сцены-источника. В меню ``Mapping > Coordinates`` выбрать ``UV``.  Убедиться, что меш объекта имеет развертку. 

.. image:: src_images/textures/render_to_texture.jpg
   :align: center
   :width: 100%


Ограничения
-----------

В настоящее время имеется баг, вынуждающий иметь в обеих сценах один общий источник света.


