.. _working_process_stages:

***************
Рабочий процесс
***************

Создание любого продукта является творческим процессом, в котором могут
участвовать множество людей, с различными навыками и опытом. Однако вне
зависимости от его сложности и конечного результата, всегда можно выделить
стадию производства, на которой создаётся основной объём ресурсов (ассетов) и
исходного кода.

При использовании Blend4Web, производственный процесс можно представить
следующим образом:

#. Подготовка трёхмерной сцены в программе Blender.
#. Экспорт ресурсов в формате, пригодном для использования движком.
#. Запуск, настройка и отладка сцены в программе-просмоторщике.
#. Создание целевого приложения.

Подготовка сцен
===============

Помимо обычных операций по моделированию, текстурированию, анимации и т.д.
должна быть осуществлена подготовка сцены для работы в движке.

Общие рекомендации:

#. Blend-файлы должны находиться в директории ``external/blender/имя_проекта``.
#. Файлы текстур должны быть внешними и находиться в директории ``external/deploy/assets/имя_проекта``.
#. Вспомогательные файлы, не предназначенные для загрузки в движок (например, референсы), должны находиться в директории ``external/blender/имя_проекта``.
#. Файл, из которого будет осуществляться экспорт, должен содержать только необходимые в разрабатываемом приложении модели.
#. Объект, меш, материал, текстура, арматура должны иметь отличающие названия (на англ. языке). Они не должны называться "Cube.001", "Material", "Armature".
#. Допускается добавление по ссылке (linking) компонентов из других файлов (библиотек).

.. index:: экспорт

Экспорт сцен
============

Для загрузки сцен, созданных с помощью пакета Blender, в движок, необходимо перевести их в формат, пригодный для чтения браузером. На данный момент используются текстовые файлы с расширением :file:`.json`, в которые сохраняются экспортируемые структуры данных в формате JSON (JavaScript Object Notation). 

Экспорт производится выбором в меню ``File > Export`` опции ``Blend4Web (.json)``. Быстрый доступ - поиск по ``b4w export`` (горячая клавиша ``ПРОБЕЛ``). 

Экспортные файлы должны находиться в директории ``external/deploy/assets/имя_проекта``.

Необходимо использовать относительные пути для изображений (как правило, это происходит по умолчанию). В случаях, когда это не так, необходимо выполнить команду ``File > External Data > Make All Paths Relative`` (т.е. сделать все пути относительными). Использование абсолютных путей вместо относительных может приводить к ошибкам при попытках загрузки ``.blend`` и ``.json`` файлов на других компьютерах.

В момент экспорта происходит проверка сцены на предмет использования не поддерживаемых движком возможностей Blender'a. В таких случаях генерируется сообщение об ошибке:

.. image:: src_images/blender_ui/error_message.jpg
   :alt: Сообщение об ошибке при экспорте
   :align: center
   :width: 100%

|

Перечень возможных ошибок экспорта перечислен в :ref:`соответствующем разделе <export_errors>`. 

Опции экспорта
--------------

*Autosave main file*
    Автосохранение файла, из которого осуществляется экспорт. **Включено по умолчанию**. Осуществляется непосредственно после экспорта с целью поддержки соответствия между текущим содержимым blend-файла и экспортного файла. Кроме того, для удобства в blend-файле сохраняется относительный путь к экспортному файлу.

*Filepath*
    Путь для экспортного файла. Используется в режиме экспорта из командой строки. В оконном режиме не используется.


.. index:: просмотрщик; добавление сцен

Отображение сцен в просмоторщике
================================

Для того, чтобы сцена появилась в списке сцен просмотрщика, нужно добавить запись в текстовой файл ``external/deploy/assets/assets.js``.

Для добавления новой сцены нужно знать категорию, в которой она должна отображаться. Категория обычно соответствует названию проекта и имени директории, где хранятся соответствующие файлы. 


Пример
------

Ниже приведена примерная часть файла ``assets.js``, в которой находятся два проекта "Capri" и "Fridge" с соответствующими сценами в каждом проекте::

    {
        name: "Capri",
        items: [
            {
                name: "Baken",
                load_file : "capri/props/baken/baken.json"
            },
            {
                name: "Terrain",
                load_file : "capri/landscape/terrain/terrain.json"
            }
        ]
    },
    {
        name: "Fridge",
        items: [
            {
                name: "Apple",
                load_file : "fridge/fruits/apple/apple.json"
            },
            {
                name: "Mango",
                load_file : "fridge/fruits/mango/mango.json"
            }
        ]
    }

Добавление можно осуществить копированием и вставкой описания похожей сцены в нужной категории и последующим редактированием ее названия и пути к экспортному файлу.

В случае успешного добавления сцена должна появиться в списке сцен просмотрщика в нужной категории.

.. image:: src_images/engine_screens/viewer_apple_scene.jpg
   :alt: Отображение сцены в просмотрщике.
   :align: center
   :width: 100%

Создание приложения
===================

На этой стадии создаётся общий вид приложения и пишется исходный код. Документация для разработчиков приложений приведена в :ref:`соответствующем разделе <developers>`. 
